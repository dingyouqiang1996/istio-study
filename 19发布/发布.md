# 金丝雀发布/灰度发布

## 什么是金丝雀发布

灰度发布也叫金丝雀部署 ，是指通过控制流量的比例，实现新老版本的逐步更替。
比如对于服务A 有 version1 version2 两个版本 ， 当前两个版本同时部署，但是version1比例90% ，version2比例10% ，看运行效果，如果效果好逐步调整 流量占比 80～20 ，70～30 ·····10～90 ，0，100 ，最终version1版本下线。
灰度发布的特点
1.新老板共存
2.可以实时根据反馈 动态调整占比
3.理论上不存在服务完全宕机的情况。
适合于服务的平滑升级与动态更新。
4、当前针对k8s的环境部署平台， 我们可以使用servicemesh 服务网格完成 各种部署场景，满足我们的业务需求。

## 过程

1. 线上原版本为v1。
2. 部署新版本v2，线上同时存在两个版本（蓝和绿版本）。
3. 切换10%路由到v2。
4. 验证通过后，把更多的流量（比如20%），切换到v2。
5. 逐步增加分发给v2的流量，直到把100%的流量都分发给v2。
6. 如果验证失败，切换100%路由回v1（回滚）
7. 待新版本服务稳定运行后，删除老版本服务。

![flagger-canary-steps](images\flagger-canary-steps.png)



## 案例

### 手工实现



### **Flagger** 

#### 什么是flagger



文档https://docs.flagger.app/

#### flagger功能

![1630227083(1)](images\1630227083(1).jpg)



![1630227187(1)](images\1630227187(1).jpg)

#### 部署策略

![1630227405(1)](images\1630227405(1).jpg)



#### 部署flagger

```
kubectl apply -f flagger-crd.yaml

helm repo add flagger https://flagger.app

helm upgrade -i flagger-test flagger/flagger \
--namespace=istio-system \
--set crd.create=false \
--set meshProvider=istio \
--set metricsServer=http://prometheus:9090

[root@master01 release]# kubectl get pod -n istio-system  
NAME                                    READY   STATUS    RESTARTS   AGE
flagger-5574cbff7c-7485p                1/1     Running   0          45s
istio-egressgateway-6bddfd6fd9-s47d7    1/1     Running   2          26h
istio-ingressgateway-7cdccb7b58-nc2gf   1/1     Running   2          26h
istiod-7fbdd57c4f-8dcm7                 1/1     Running   2          26h


addons/prometheus.yaml
kubectl apply -f prometheus.yaml -n istio-system

addons/grafana.yaml
kubectl apply -f grafana.yaml -n istio-system

[root@master01 addons]# kubectl get pod -n istio-system  -w
NAME                                    READY   STATUS    RESTARTS   AGE
flagger-5574cbff7c-7485p                1/1     Running   0          5m47s
grafana-784c89f4cf-p6vww                1/1     Running   0          92s
istio-egressgateway-6bddfd6fd9-s47d7    1/1     Running   2          26h
istio-ingressgateway-7cdccb7b58-nc2gf   1/1     Running   2          26h
istiod-7fbdd57c4f-8dcm7                 1/1     Running   2          26h
prometheus-7bfddb8dbf-bt498             2/2     Running   0          4m13s
```

#### 升级流程

Gated canary promotion stages:

- scan for canary deployments
- check primary and canary deployment status
  - halt advancement if a rolling update is underway
  - halt advancement if pods are unhealthy
- call confirm-rollout webhooks and check results
  - halt advancement if any hook returns a non HTTP 2xx result
- call pre-rollout webhooks and check results
  - halt advancement if any hook returns a non HTTP 2xx result
  - increment the failed checks counter
- increase canary traffic weight percentage from 0% to 2% (step weight)
- call rollout webhooks and check results
- check canary HTTP request success rate and latency
  - halt advancement if any metric is under the specified threshold
  - increment the failed checks counter
- check if the number of failed checks reached the threshold
  - route all traffic to primary
  - scale to zero the canary deployment and mark it as failed
  - call post-rollout webhooks
  - post the analysis result to Slack
  - wait for the canary deployment to be updated and start over
- increase canary traffic weight by 2% (step weight) till it reaches 50% (max weight) 
  - halt advancement if any webhook call fails
  - halt advancement while canary request success rate is under the threshold
  - halt advancement while canary request duration P99 is over the threshold
  - halt advancement while any custom metric check fails
  - halt advancement if the primary or canary deployment becomes unhealthy 
  - halt advancement while canary deployment is being scaled up/down by HPA
- call confirm-promotion webhooks and check results
  - halt advancement if any hook returns a non HTTP 2xx result
- promote canary to primary
  - copy ConfigMaps and Secrets from canary to primary
  - copy canary deployment spec template over primary
- wait for primary rolling update to finish
  - halt advancement if pods are unhealthy
- route all traffic to primary
- scale to zero the canary deployment
- mark rollout as finished
- call post-rollout webhooks
- send notification with the canary analysis result
- wait for the canary deployment to be updated and start over

#### crd详解

```
[root@master01 addons]# kubectl get crd |grep flagger
alertproviders.flagger.app                           2021-08-29T09:01:58Z
canaries.flagger.app                                 2021-08-29T09:01:56Z
metrictemplates.flagger.app                          2021-08-29T09:01:58Z
```

##### canary

###### stepWeight

release/canary/flagger/canary-reviews-stepWeight.yaml

kubectl apply -f canary-reviews-stepWeight.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  service:
    port: 9080
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 5
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
```

![flagger-canary-hpa](images\flagger-canary-hpa.png)

```
# applied 
canary.flagger.app/bookinfo

# generated 
deployment.apps/reviews-v1-primary
service/reviews-v1-canary
service/reviews-v1-primary
destinationrule.networking.istio.io/reviews-v1-canary
destinationrule.networking.istio.io/reviews-v1-primary
virtualservice.networking.istio.io/reviews-v1
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2

kubectl describe canary bookinfo -n istio

  Type     Reason  Age                From     Message
  ----     ------  ----               ----     -------
  Warning  Synced  35m                flagger  reviews-v1-primary.istio not ready: waiting for rollout to finish: observed deployment generation less than desired generation
  Normal   Synced  34m (x2 over 35m)  flagger  all the metrics providers are available!
  Normal   Synced  34m                flagger  Initialization done! bookinfo.istio
  Normal   Synced  30m                flagger  New revision detected! Scaling up reviews-v1.istio
  Normal   Synced  29m                flagger  Starting canary analysis for reviews-v1.istio
  Normal   Synced  29m                flagger  Advance bookinfo.istio canary weight 5
  Warning  Synced  28m                flagger  Halt advancement no values found for istio metric request-success-rate probably reviews-v1.istio is not receiving traffic: running query failed: no values found
  Normal   Synced  27m                flagger  Advance bookinfo.istio canary weight 10
  Normal   Synced  26m                flagger  Advance bookinfo.istio canary weight 15
  Normal   Synced  25m                flagger  Advance bookinfo.istio canary weight 20
  Normal   Synced  24m                flagger  Advance bookinfo.istio canary weight 25
  Normal   Synced  16m (x8 over 23m)  flagger  (combined from similar events): Promotion completed! Scaling down reviews-v1.istio

```

清理：

kubectl delete -f canary-reviews-stepWeight.yaml -n istio



触发条件

A canary deployment is triggered by changes in any of the following objects:

- Deployment PodSpec (container image, command, ports, env, resources, etc)
- ConfigMaps mounted as volumes or mapped to environment variables
- Secrets mounted as volumes or mapped to environment variables



######  mirroring 

release/canary/flagger/canary-reviews-mirroring .yaml

kubectl apply -f canary-reviews-mirroring.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  service:
    port: 9080
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    iterations: 10
    mirror: true
    mirrorWeight: 100
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
```

![flagger-canary-traffic-mirroring](images\flagger-canary-traffic-mirroring.png)

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v3:1.16.2

kubectl describe canary bookinfo -n istio

Type     Reason  Age                From     Message
  ----     ------  ----               ----     -------
  Warning  Synced  39m                flagger  reviews-v1-primary.istio not ready: waiting for rollout to finish: observed deployment generation less than desired generation
  Normal   Synced  38m (x2 over 39m)  flagger  all the metrics providers are available!
  Normal   Synced  38m                flagger  Initialization done! bookinfo.istio
  Normal   Synced  34m                flagger  New revision detected! Scaling up reviews-v1.istio
  Normal   Synced  33m                flagger  Starting canary analysis for reviews-v1.istio
  Normal   Synced  33m                flagger  Advance bookinfo.istio canary iteration 1/10
  Warning  Synced  32m                flagger  Halt bookinfo.istio advancement request duration 4.842s > 500ms
  Normal   Synced  31m                flagger  Advance bookinfo.istio canary iteration 2/10
  Normal   Synced  30m                flagger  Advance bookinfo.istio canary iteration 3/10
  Normal   Synced  29m                flagger  Advance bookinfo.istio canary iteration 4/10
  Normal   Synced  28m                flagger  Advance bookinfo.istio canary iteration 5/10
  Normal   Synced  19m (x9 over 27m)  flagger  (combined from similar events): Promotion completed! Scaling down reviews-v1.istio
```

清理：

kubectl delete canary bookinfo -n istio



######  skipAnalysis 

release/canary/flagger/canary-reviews-skipAnalysis.yaml

kubectl apply -f canary-reviews-skipAnalysis.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  service:
    port: 9080
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  skipAnalysis: true
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 5
  
```

清理：

kubectl delete canary bookinfo -n istio



######  stepWeights

release/canary/flagger/canary-reviews-non-linear.yaml

kubectl apply -f canary-reviews-non-linear.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  service:
    port: 9080
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeights: [30, 45, 90]
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2

 kubectl describe canary bookinfo -n istio

  Type     Reason  Age                 From     Message
  ----     ------  ----                ----     -------
  Warning  Synced  88m                 flagger  reviews-v1-primary.istio not ready: waiting for rollout to finish: observed deployment generation less than desired generation
  Normal   Synced  87m (x2 over 88m)   flagger  all the metrics providers are available!
  Normal   Synced  87m                 flagger  Initialization done! bookinfo.istio
  Normal   Synced  83m                 flagger  Advance bookinfo.istio canary weight 1
  Warning  Synced  73m (x10 over 82m)  flagger  Halt advancement no values found for istio metric request-success-rate probably reviews-v1.istio is not receiving traffic: running query failed: no values found
  Warning  Synced  72m                 flagger  Canary failed! Scaling down bookinfo.istio
  Warning  Synced  72m                 flagger  Rolling back bookinfo.istio failed checks threshold reached 10
  Normal   Synced  67m (x2 over 84m)   flagger  New revision detected! Scaling up reviews-v1.istio
  Normal   Synced  66m (x2 over 83m)   flagger  Starting canary analysis for reviews-v1.istio
  Normal   Synced  66m                 flagger  Advance bookinfo.istio canary weight 30
  Normal   Synced  65m                 flagger  Advance bookinfo.istio canary weight 45
  Normal   Synced  64m                 flagger  Advance bookinfo.istio canary weight 90
  Normal   Synced  63m                 flagger  Copying reviews-v1.istio template spec to reviews-v1-primary.istio
  Normal   Synced  62m                 flagger  Routing all traffic to primary
  Normal   Synced  61m                 flagger  Promotion completed! Scaling down reviews-v1.istio
```

清理：

kubectl delete canary bookinfo -n istio



###### metricsServer

release/canary/flagger/canary-reviews-metricsServer.yaml

kubectl apply -f canary-reviews-metricsServer.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  metricsServer: "http://prometheus:9090"
  service:
    port: 9080
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2

kubectl describe canary bookinfo -n istio
  Type     Reason  Age                From     Message
  ----     ------  ----               ----     -------
  Warning  Synced  11m                flagger  reviews-v1-primary.istio not ready: waiting for rollout to finish: observed deployment generation less than desired generation
  Normal   Synced  10m (x2 over 11m)  flagger  all the metrics providers are available!
  Normal   Synced  10m                flagger  Initialization done! bookinfo.istio
  Normal   Synced  7m35s              flagger  New revision detected! Scaling up reviews-v1.istio
  Normal   Synced  6m35s              flagger  Starting canary analysis for reviews-v1.istio
  Normal   Synced  6m34s              flagger  Advance bookinfo.istio canary weight 20
  Normal   Synced  5m35s              flagger  Advance bookinfo.istio canary weight 40
  Normal   Synced  4m35s              flagger  Advance bookinfo.istio canary weight 60
  Normal   Synced  3m35s              flagger  Copying reviews-v1.istio template spec to reviews-v1-primary.istio
  Normal   Synced  2m35s              flagger  Routing all traffic to primary
  Normal   Synced  95s                flagger  (combined from similar events): Promotion completed! Scaling down reviews-v1.istio
```

清理：

kubectl delete canary bookinfo -n istio





###### provider

release/canary/flagger/canary-reviews-provider.yaml

kubectl apply -f canary-reviews-provider.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio

  Type     Reason  Age                  From     Message
  ----     ------  ----                 ----     -------
  Warning  Synced  10m                  flagger  reviews-v1-primary.istio not ready: waiting for rollout to finish: observed deployment generation less than desired generation
  Warning  Synced  9m13s (x2 over 10m)  flagger  Error checking metric providers: prometheus not avaiable: running query failed: request failed: Get "prometheus:///api/v1/query?query=vector%281%29": unsupported protocol scheme "prometheus"
  Normal   Synced  9m10s                flagger  Initialization done! bookinfo.istio
  Normal   Synced  8m13s                flagger  New revision detected! Scaling up reviews-v1.istio
  Normal   Synced  7m13s                flagger  Starting canary analysis for reviews-v1.istio
  Normal   Synced  7m12s                flagger  Advance bookinfo.istio canary weight 20
  Normal   Synced  6m13s                flagger  Advance bookinfo.istio canary weight 40
  Normal   Synced  5m13s                flagger  Advance bookinfo.istio canary weight 60
  Normal   Synced  4m13s                flagger  Copying reviews-v1.istio template spec to reviews-v1-primary.istio
  Normal   Synced  3m13s                flagger  Routing all traffic to primary
  Normal   Synced  2m13s                flagger  Promotion completed! Scaling down reviews-v1.istio
```

清理：

kubectl delete canary bookinfo -n istio





###### autoscalerRef

release/canary/flagger/reviews-deploy-with-resources.yaml 

kubectl apply -f reviews-deploy-with-resources.yaml  -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: reviews
  labels:
    app: reviews
    service: reviews
spec:
  ports:
  - port: 9080
    name: http
  selector:
    app: reviews
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: bookinfo-reviews
  labels:
    account: reviews
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.2
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: reviews-v2
  labels:
    app: reviews
    version: v2
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v2
  template:
    metadata:
      labels:
        app: reviews
        version: v2
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v2:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.2
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: reviews-v3
  labels:
    app: reviews
    version: v3
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v3
  template:
    metadata:
      labels:
        app: reviews
        version: v3
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v3:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.2
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
```

release/canary/flagger/reviews-hpa.yaml 

kubectl  apply -f reviews-hpa.yaml  -n istio

```
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: review-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  minReplicas: 1
  maxReplicas: 2
  targetCPUUtilizationPercentage: 180
```

release/canary/flagger/canary-reviews-autoscalerRef.yaml

kubectl apply -f canary-reviews-autoscalerRef.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  autoscalerRef:
    apiVersion: autoscaling/v1
    kind: HorizontalPodAutoscaler
    name: review-hpa
  service:
    port: 9080
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2

 kubectl describe canary bookinfo -n istio

  Type     Reason  Age                From     Message
  ----     ------  ----               ----     -------
  Warning  Synced  14m                flagger  reviews-v1-primary.istio not ready: waiting for rollout to finish: observed deployment generation less than desired generation
  Normal   Synced  13m (x2 over 14m)  flagger  all the metrics providers are available!
  Normal   Synced  13m                flagger  Initialization done! bookinfo.istio
  Normal   Synced  8m3s               flagger  New revision detected! Scaling up reviews-v1.istio
  Normal   Synced  7m3s               flagger  Starting canary analysis for reviews-v1.istio
  Normal   Synced  7m3s               flagger  Advance bookinfo.istio canary weight 20
  Warning  Synced  6m3s               flagger  Halt advancement no values found for istio metric request-success-rate probably reviews-v1.istio is not receiving traffic: running query failed: no values found
  Normal   Synced  5m3s               flagger  Advance bookinfo.istio canary weight 40
  Warning  Synced  4m3s               flagger  Halt bookinfo.istio advancement request duration 795ms > 500ms
  Normal   Synced  3m3s               flagger  Advance bookinfo.istio canary weight 60
  Normal   Synced  2m3s               flagger  Copying reviews-v1.istio template spec to reviews-v1-primary.istio
  Normal   Synced  63s                flagger  Routing all traffic to primary
  Normal   Synced  3s                 flagger  (combined from similar events): Promotion completed! Scaling down reviews-v1.istio


```

清理：

kubectl delete canary bookinfo -n istio

kubectl delete hpa review-hpa -n istio







###### service

1name

release/canary/flagger/canary-reviews-service-name.yaml

kubectl apply -f canary-reviews-service-name.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio

```

清理：

kubectl delete canary bookinfo -n istio



2portDiscovery

自动发现port

release/canary/flagger/canary-reviews-service-portDiscovery.yaml

kubectl apply -f canary-reviews-service-portDiscovery.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    portDiscovery: true
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio

```

清理：

kubectl delete canary bookinfo -n istio



3portName

release/canary/flagger/canary-reviews-service-portName.yaml

kubectl apply -f canary-reviews-service-portName.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    portName: http-reviews-x
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


kubectl get svc -n istio reviews -o yaml
spec:
  clusterIP: 10.68.4.21
  clusterIPs:
  - 10.68.4.21
  ports:
  - name: http-reviews-x
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
  sessionAffinity: None
  type: ClusterIP
```

清理：

kubectl delete canary bookinfo -n istio



4apex

不知道干什么用的

release/canary/flagger/canary-reviews-service-apex.yaml

kubectl apply -f canary-reviews-service-apex.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    apex:
      annotations:
        test: "test"
      labels:
        test: "test"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


```

清理：

kubectl delete canary bookinfo -n istio



5canary，primary

release/canary/flagger/canary-reviews-service-canary-primary.yaml

kubectl apply -f canary-reviews-service-canary-primary.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    canary:
      annotations:
        test: "test"
      labels:
        test: "test"
    primary:
      annotations:
        test: "test"
      labels:
        test: "test"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


kubectl get svc -n istio reviews-canary -o yaml
apiVersion: v1
kind: Service
metadata:
  annotations:
    test: test
  creationTimestamp: "2021-08-30T06:41:17Z"
  labels:
    app: reviews-canary
    test: test
    
kubectl get svc -n istio reviews-primary -o yaml
apiVersion: v1
kind: Service
metadata:
  annotations:
    test: test
  creationTimestamp: "2021-08-30T06:41:18Z"
  labels:
    app: reviews-primary
    test: test

```

清理：

kubectl delete canary bookinfo -n istio



6targetPort

release/canary/flagger/canary-reviews-service-targetPort.yaml

kubectl apply -f canary-reviews-service-targetPort.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    targetPort: 9999
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


kubectl get svc -n istio reviews-primary -o yaml
spec:
  clusterIP: 10.68.6.41
  clusterIPs:
  - 10.68.6.41
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9999
  selector:
    app: reviews-primary
  sessionAffinity: None
  type: ClusterIP

```

清理：

kubectl delete canary bookinfo -n istio



7timeout

release/canary/flagger/canary-reviews-service-timeout.yaml

kubectl apply -f canary-reviews-service-timeout.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    timeout: 1s
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


kubectl get vs -n istio reviews -o yaml
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0
    timeout: 1s

```

清理：

kubectl delete canary bookinfo -n istio



8delegation

待验证

release/canary/flagger/canary-reviews-service-delegation.yaml

kubectl apply -f canary-reviews-service-delegation.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    delegation: true
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio



```

清理：

kubectl delete canary bookinfo -n istio





9headers

[1]request

release/canary/flagger/canary-reviews-service-headers-request.yaml

kubectl apply -f canary-reviews-service-headers-request.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    headers:
      request:
        add:
          test: test
        remove:
        - test2
        set: 
          test3: test
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - headers:
      request:
        add:
          test: test
        remove:
        - test2
        set:
          test3: test
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0
```

清理：

kubectl delete canary bookinfo -n istio





[2]response

release/canary/flagger/canary-reviews-service-headers-response.yaml

kubectl apply -f canary-reviews-service-headers-response.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    headers:
      response:
        add:
          test: test
        remove:
        - test2
        set: 
          test3: test
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


kubectl get vs -n istio reviews -o yaml
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - headers:
      response:
        add:
          test: test
        remove:
        - test2
        set:
          test3: test
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio



10match

和istio差不多

[1]authority

exact

```
release/canary/flagger/canary-reviews-service-match-authority-exact.yaml

kubectl apply -f canary-reviews-service-match-authority-exact.yaml -n istio

​```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - authority:
        exact: "bookinfo.demo:31110"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
​```

​```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


kubectl get vs -n istio reviews -o yaml


​```

清理：

kubectl delete canary bookinfo -n istio
```

prefix

release/canary/flagger/canary-reviews-service-match-authority-prefix.yaml

kubectl apply -f canary-reviews-service-match-authority-prefix.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - authority:
        prefix: "bookinfo"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - authority:
        prefix: bookinfo
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio





regex

release/canary/flagger/canary-reviews-service-match-authority-regex.yaml

kubectl apply -f canary-reviews-service-match-authority-regex.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - authority:
        regex: "bookinfo.de.*"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - authority:
        regex: bookinfo.de.*
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0
 

```

清理：

kubectl delete canary bookinfo -n istio



[2]gateways

release/canary/flagger/canary-reviews-service-match-gateways.yaml

kubectl apply -f canary-reviews-service-match-gateways.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - gateways:
      - bookinfo-gateway-02
    gateways:
    - istio/bookinfo-gateway
    - istio/bookinfo-gateway-02
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 spec:
  gateways:
  - istio/bookinfo-gateway
  - istio/bookinfo-gateway-02
  hosts:
  - '*'
  http:
  - match:
    - gateways:
      - bookinfo-gateway-02
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0
 

```

清理：

kubectl delete canary bookinfo -n istio





[3]headers

cookie

release/canary/flagger/canary-reviews-service-match-headers-cookie.yaml

kubectl apply -f canary-reviews-service-match-headers-cookie.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - headers:
        cookie:
          regex: "^(.*?;)?(session=.*)(;.*)?$"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - headers:
        cookie:
          regex: ^(.*?;)?(session=.*)(;.*)?$
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio



exact

release/canary/flagger/canary-reviews-service-match-headers-exact.yaml

kubectl apply -f canary-reviews-service-match-headers-exact.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - headers:
        end-user:
          exact: mark
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - headers:
        end-user:
          exact: mark
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0
 

```

清理：

kubectl delete canary bookinfo -n istio



prefix

release/canary/flagger/canary-reviews-service-match-headers-prefix.yaml

kubectl apply -f canary-reviews-service-match-headers-prefix.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - headers:
        end-user:
          prefix: ma
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - headers:
        end-user:
          prefix: ma
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio



regex

release/canary/flagger/canary-reviews-service-match-headers-regex.yaml

kubectl apply -f canary-reviews-service-match-headers-regex.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - headers:
        end-user:
          regex: "m.*k"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - headers:
        end-user:
          regex: m.*k
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio



user-agent

release/canary/flagger/canary-reviews-service-match-headers-user-agent.yaml

kubectl apply -f canary-reviews-service-match-headers-user-agent.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - headers:
        user-agent:
          regex: ".*Chrome.*"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - headers:
        user-agent:
          regex: .*Chrome.*
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio





[4]ignoreUriCase

release/canary/flagger/canary-reviews-service-match-ignoreUriCase.yaml

kubectl apply -f canary-reviews-service-match-ignoreUriCase.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - uri:
        exact: "/pRODUCTPAGE"
      ignoreUriCase: true
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - ignoreUriCase: true
      uri:
        exact: /pRODUCTPAGE
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio





[5]method

exact

release/canary/flagger/canary-reviews-service-match-method-exact.yaml

kubectl apply -f canary-reviews-service-match-method-exact.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - method:
        exact: "GET"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - method:
        exact: GET
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio





prefix

release/canary/flagger/canary-reviews-service-match-method-prefix.yaml

kubectl apply -f canary-reviews-service-match-method-prefix.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - method:
        prefix: "G"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - method:
        prefix: G
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0
 

```

清理：

kubectl delete canary bookinfo -n istio





regex

release/canary/flagger/canary-reviews-service-match-method-regex.yaml

kubectl apply -f canary-reviews-service-match-method-regex.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - method:
        regex: "G.*T"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - method:
        regex: G.*T
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0
```

清理：

kubectl delete canary bookinfo -n istio





[6]name

release/canary/flagger/canary-reviews-service-match-name.yaml

kubectl apply -f canary-reviews-service-match-name.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - uri:
        exact: /productpage
      name: book
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - name: book
      uri:
        exact: /productpage
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0
 

```

清理：

kubectl delete canary bookinfo -n istio





[7]port

release/canary/flagger/canary-reviews-service-match-port.yaml

kubectl apply -f canary-reviews-service-match-port.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - port: 80
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - port: 80
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: r

```

清理：

kubectl delete canary bookinfo -n istio





[8]queryParams

exact

release/canary/flagger/canary-reviews-service-match-queryParams-exact.yaml

kubectl apply -f canary-reviews-service-match-queryParams-exact.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - queryParams:
        test:
          exact: test
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - queryParams:
        test:
          exact: test
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio





prefix

release/canary/flagger/canary-reviews-service-match-queryParams-prefix.yaml

kubectl apply -f canary-reviews-service-match-queryParams-prefix.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - queryParams:
        test:
          prefix: mark
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - queryParams:
        test:
          prefix: mark
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio





regex

release/canary/flagger/canary-reviews-service-match-queryParams-regex.yaml

kubectl apply -f canary-reviews-service-match-queryParams-regex.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - queryParams:
        test:
          regex: "\\d+$"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - queryParams:
        test:
          regex: \d+$
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio







[9]scheme

exact

release/canary/flagger/canary-reviews-service-match-scheme-exact.yaml

kubectl apply -f canary-reviews-service-match-scheme-exact.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - scheme:
        exact: "http"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - scheme:
        exact: http
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0
```

清理：

kubectl delete canary bookinfo -n istio





prefix

release/canary/flagger/canary-reviews-service-match-scheme-prefix.yaml

kubectl apply -f canary-reviews-service-match-scheme-prefix.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - scheme:
        prefix: "http"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - scheme:
        prefix: http
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio





regex

release/canary/flagger/canary-reviews-service-match-scheme-regex.yaml

kubectl apply -f canary-reviews-service-match-scheme-regex.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - scheme:
        regex: ".*"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
   gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - scheme:
        regex: .*
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio





[10]sourceLabels

release/canary/flagger/canary-reviews-service-match-sourceLabels.yaml

kubectl apply -f canary-reviews-service-match-sourceLabels.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - sourceLabels:
        app: productpage
        version: v1
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - sourceLabels:
        app: productpage
        version: v1
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio





[11]sourceNamespace

release/canary/flagger/canary-reviews-service-match-sourceNamespace.yaml

kubectl apply -f canary-reviews-service-match-sourceNamespace.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - sourceNamespace: istio-system
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - sourceNamespace: istio-system
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio





[12]uri

exact

release/canary/flagger/canary-reviews-service-match-uri-exact.yaml

kubectl apply -f canary-reviews-service-match-uri-exact.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - uri:
        exact: /productpage
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - uri:
        exact: /productpage
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0
 

```

清理：

kubectl delete canary bookinfo -n istio



prefix

release/canary/flagger/canary-reviews-service-match-uri-prefix.yaml

kubectl apply -f canary-reviews-service-match-uri-prefix.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - uri:
        prefix: /product
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - uri:
        prefix: /product
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio





regex

release/canary/flagger/canary-reviews-service-match-uri-regex.yaml

kubectl apply -f canary-reviews-service-match-uri-regex.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - uri:
        regex: "/p.*e"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - uri:
        regex: /p.*e
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio





[13]withoutHeaders

exact

release/canary/flagger/canary-reviews-service-match-withoutHeaders-exact.yaml

kubectl apply -f canary-reviews-service-match-withoutHeaders-exact.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - withoutHeaders:
        end-user:
          exact: mark
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - withoutHeaders:
        end-user:
          exact: mark
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio





prefix

release/canary/flagger/canary-reviews-service-match-withoutHeaders-prefix.yaml

kubectl apply -f canary-reviews-service-match-withoutHeaders-prefix.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - withoutHeaders:
        end-user:
          prefix: ma
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - withoutHeaders:
        end-user:
          prefix: ma
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio





regex

release/canary/flagger/canary-reviews-service-match-withoutHeaders-regex.yaml

kubectl apply -f canary-reviews-service-match-withoutHeaders-regex.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - withoutHeaders:
        end-user:
          regex: "m.*k"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - withoutHeaders:
        end-user:
          regex: m.*k
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0
```

清理：

kubectl delete canary bookinfo -n istio



11corsPolicy

[1]allowCredentials

release/canary/flagger/canary-reviews-service-corsPolicy-allowCredentials.yaml

kubectl apply -f canary-reviews-service-corsPolicy-allowCredentials.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    corsPolicy:
      allowCredentials: true
      allowOrigins:
      - exact: "http://mytest.com:8081"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - corsPolicy:
      allowCredentials: true
      allowOrigins:
      - exact: http://mytest.com:8081
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio



[2]allowOrigins

exact

上面已有

prefix

release/canary/flagger/canary-reviews-service-corsPolicy-allowOrigins-prefix.yaml

kubectl apply -f canary-reviews-service-corsPolicy-allowOrigins-prefix.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    corsPolicy:
      allowOrigins:
      - prefix: "http://mytest"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - corsPolicy:
      allowOrigins:
      - prefix: http://mytest
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio





regex

release/canary/flagger/canary-reviews-service-corsPolicy-allowOrigins-regex.yaml

kubectl apply -f canary-reviews-service-corsPolicy-allowOrigins-regex.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    corsPolicy:
      allowOrigins:
      - regex: ".*"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - corsPolicy:
      allowOrigins:
      - regex: .*
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio



exposeHeaders

release/canary/flagger/canary-reviews-service-corsPolicy-exposeHeaders.yaml

kubectl apply -f canary-reviews-service-corsPolicy-exposeHeaders.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    corsPolicy:
      allowOrigins:
      - exact: "http://mytest.com:8081"
      exposeHeaders: 
      - test
      - test2
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - corsPolicy:
      allowOrigins:
      - exact: http://mytest.com:8081
      exposeHeaders:
      - test
      - test2
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0
```

清理：

kubectl delete canary bookinfo -n istio





allowHeaders

release/canary/flagger/canary-reviews-service-corsPolicy-allowHeaders.yaml

kubectl apply -f canary-reviews-service-corsPolicy-allowHeaders.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    corsPolicy:
      allowOrigins:
      - exact: "http://mytest.com:8081"
      allowMethods:
      - GET
      - OPTIONS
      allowHeaders:
      - content-type
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - corsPolicy:
      allowHeaders:
      - content-type
      allowMethods:
      - GET
      - OPTIONS
      allowOrigins:
      - exact: http://mytest.com:8081
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio





allowMethods

release/canary/flagger/canary-reviews-service-corsPolicy-allowMethods.yaml

kubectl apply -f canary-reviews-service-corsPolicy-allowMethods.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    corsPolicy:
      allowOrigins:
      - exact: "http://mytest.com:8081"
      allowMethods:
      - DELETE
      - OPTIONS
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - corsPolicy:
      allowMethods:
      - DELETE
      - OPTIONS
      allowOrigins:
      - exact: http://mytest.com:8081
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio





maxAge

release/canary/flagger/canary-reviews-service-corsPolicy-maxAge.yaml

kubectl apply -f canary-reviews-service-corsPolicy-maxAge.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    corsPolicy:
      allowOrigins:
      - exact: "http://mytest.com:8081"
      allowMethods:
      - GET
      - OPTIONS
      maxAge: "10s"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - corsPolicy:
      allowMethods:
      - GET
      - OPTIONS
      allowOrigins:
      - exact: http://mytest.com:8081
      maxAge: 10s
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio







12retries

retryOn

release/canary/flagger/canary-reviews-service-retries-retryOn.yaml

kubectl apply -f canary-reviews-service-retries-retryOn.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    retries:
      attempts: 5
      perTryTimeout: 3s
      retryOn: 5xx,connect-failure
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 

spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - retries:
      attempts: 5
      perTryTimeout: 3s
      retryOn: 5xx,connect-failure
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0
```

清理：

kubectl delete canary bookinfo -n istio





retryRemoteLocalities

这个istio有，flagger没有



13rewrite

uri

release/canary/flagger/canary-reviews-service-rewrite-uri.yaml

kubectl apply -f canary-reviews-service-rewrite-uri.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - uri:
        regex: "/m.*k"
    rewrite:
      uri: "/productpage"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 

spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - uri:
        regex: /m.*k
    rewrite:
      uri: /productpage
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0
```

清理：

kubectl delete canary bookinfo -n istio





authority

istio有但是flagger没有



14trafficPolicy

和DestinationRule相关

[1]connectionPool

tcp

istio有flagger没有



1http

release/canary/flagger/trafficPolicy/canary-reviews-trafficPolicy-connectionPool-http.yaml

kubectl apply -f canary-reviews-trafficPolicy-connectionPool-http.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    trafficPolicy:
      connectionPool:
        http:
          http2MaxRequests: 10
          maxRequestsPerConnection: 1
          http1MaxPendingRequests: 1
          maxRetries: 1
          idleTimeout: 10s
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


kubectl get dr -n istio reviews-primary -o yaml
 
spec:
  host: reviews-canary
  trafficPolicy:
    connectionPool:
      http:
        http1MaxPendingRequests: 1
        http2MaxRequests: 10
        idleTimeout: 10s
        maxRequestsPerConnection: 1
        maxRetries: 1

kubectl get dr -n istio reviews-canary -o yaml
spec:
  host: reviews-primary
  trafficPolicy:
    connectionPool:
      http:
        http1MaxPendingRequests: 1
        http2MaxRequests: 10
        idleTimeout: 10s
        maxRequestsPerConnection: 1
        maxRetries: 1

```

清理：

kubectl delete canary bookinfo -n istio



h2UpgradePolicy

DEFAULT

release/canary/flagger/trafficPolicy/canary-reviews-trafficPolicy-connectionPool-http-h2UpgradePolicy-DEFAULT.yaml

kubectl apply -f canary-reviews-trafficPolicy-connectionPool-http-h2UpgradePolicy-DEFAULT.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    trafficPolicy:
      connectionPool:
        http:
          h2UpgradePolicy: DEFAULT
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


kubectl get dr -n istio reviews-primary -o yaml
 
spec:
  host: reviews-primary
  trafficPolicy:
    connectionPool:
      http:
        h2UpgradePolicy: DEFAULT

kubectl get dr -n istio reviews-canary -o yaml

spec:
  host: reviews-canary
  trafficPolicy:
    connectionPool:
      http:
        h2UpgradePolicy: DEFAULT
```

清理：

kubectl delete canary bookinfo -n istio





DO_NOT_UPGRADE

release/canary/flagger/trafficPolicy/canary-reviews-trafficPolicy-connectionPool-http-h2UpgradePolicy-DO_NOT_UPGRADE.yaml

kubectl apply -f canary-reviews-trafficPolicy-connectionPool-http-h2UpgradePolicy-DO_NOT_UPGRADE.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    trafficPolicy:
      connectionPool:
        http:
          h2UpgradePolicy: DO_NOT_UPGRADE
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


kubectl get dr -n istio reviews-primary -o yaml
 
spec:
  host: reviews-primary
  trafficPolicy:
    connectionPool:
      http:
        h2UpgradePolicy: DO_NOT_UPGRADE

kubectl get dr -n istio reviews-canary -o yaml
spec:
  host: reviews-canary
  trafficPolicy:
    connectionPool:
      http:
        h2UpgradePolicy: DO_NOT_UPGRADE

```

清理：

kubectl delete canary bookinfo -n istio









UPGRADE

release/canary/flagger/trafficPolicy/canary-reviews-trafficPolicy-connectionPool-http-h2UpgradePolicy-UPGRADE.yaml

kubectl apply -f canary-reviews-trafficPolicy-connectionPool-http-h2UpgradePolicy-UPGRADE.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    trafficPolicy:
      connectionPool:
        http:
          h2UpgradePolicy: UPGRADE
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


kubectl get dr -n istio reviews-primary -o yaml
 
spec:
  host: reviews-primary
  trafficPolicy:
    connectionPool:
      http:
        h2UpgradePolicy: UPGRADE

kubectl get dr -n istio reviews-canary -o yaml

spec:
  host: reviews-canary
  trafficPolicy:
    connectionPool:
      http:
        h2UpgradePolicy: UPGRADE
```

清理：

kubectl delete canary bookinfo -n istio



useClientProtocol

istio有，flagger没有



2loadBalancer

consistentHash

httpCookie

release/canary/flagger/trafficPolicy/loadBalancer/consistentHash/canary-reviews-trafficPolicy-loadBalancer-consistentHash-httpCookie.yaml

kubectl apply -f canary-reviews-trafficPolicy-loadBalancer-consistentHash-httpCookie.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    trafficPolicy:
      loadBalancer:
        consistentHash:
          httpCookie:
            name: user
            ttl: 0s
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


kubectl get dr -n istio reviews-primary -o yaml
 spec:
  host: reviews-primary
  trafficPolicy:
    loadBalancer:
      consistentHash:
        httpCookie:
          name: user
          ttl: 0s

kubectl get dr -n istio reviews-canary -o yaml
spec:
  host: reviews-canary
  trafficPolicy:
    loadBalancer:
      consistentHash:
        httpCookie:
          name: user
          ttl: 0s
```

清理：

kubectl delete canary bookinfo -n istio





httpHeaderName

release/canary/flagger/trafficPolicy/loadBalancer/consistentHash/canary-reviews-trafficPolicy-loadBalancer-consistentHash-httpHeaderName.yaml

kubectl apply -f canary-reviews-trafficPolicy-loadBalancer-consistentHash-httpHeaderName.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    trafficPolicy:
      loadBalancer:
        consistentHash:
          httpHeaderName: test
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


kubectl get dr -n istio reviews-primary -o yaml
 

kubectl get dr -n istio reviews-canary -o yaml

```

清理：

kubectl delete canary bookinfo -n istio





httpQueryParameterName

release/canary/flagger/trafficPolicy/loadBalancer/consistentHash/canary-reviews-trafficPolicy-loadBalancer-consistentHash-httpQueryParameterName.yaml

kubectl apply -f canary-reviews-trafficPolicy-loadBalancer-consistentHash-httpQueryParameterName.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    trafficPolicy:
      loadBalancer:
        consistentHash:
          httpQueryParameterName: test
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


kubectl get dr -n istio reviews-primary -o yaml
 spec:
  host: reviews-primary
  trafficPolicy:
    loadBalancer:
      consistentHash:
        httpHeaderName: test

kubectl get dr -n istio reviews-canary -o yaml
spec:
  host: reviews-canary
  trafficPolicy:
    loadBalancer:
      consistentHash:
        httpHeaderName: test
```

清理：

kubectl delete canary bookinfo -n istio





minimumRingSize

release/canary/flagger/trafficPolicy/loadBalancer/consistentHash/canary-reviews-trafficPolicy-loadBalancer-consistentHash-minimumRingSize.yaml

kubectl apply -f canary-reviews-trafficPolicy-loadBalancer-consistentHash-minimumRingSize.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    trafficPolicy:
      loadBalancer:
        consistentHash:
          minimumRingSize: 1
          httpQueryParameterName: test
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


kubectl get dr -n istio reviews-primary -o yaml
这里丢掉了httpQueryParameterName: test ，可能是bug
 spec:
  host: reviews-primary
  trafficPolicy:
    loadBalancer:
      consistentHash:
        minimumRingSize: 1

kubectl get dr -n istio reviews-canary -o yaml
这里丢掉了httpQueryParameterName: test ，可能是bug
spec:
  host: reviews-canary
  trafficPolicy:
    loadBalancer:
      consistentHash:
        minimumRingSize: 1
```

清理：

kubectl delete canary bookinfo -n istio





useSourceIp

release/canary/flagger/trafficPolicy/loadBalancer/consistentHash/canary-reviews-trafficPolicy-loadBalancer-consistentHash-useSourceIp.yaml

kubectl apply -f canary-reviews-trafficPolicy-loadBalancer-consistentHash-useSourceIp.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    trafficPolicy:
      loadBalancer:
        consistentHash:
          useSourceIp: true
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


kubectl get dr -n istio reviews-primary -o yaml
 spec:
  host: reviews-primary
  trafficPolicy:
    loadBalancer:
      consistentHash:
        useSourceIp: true

kubectl get dr -n istio reviews-canary -o yaml
spec:
  host: reviews-canary
  trafficPolicy:
    loadBalancer:
      consistentHash:
        useSourceIp: true
```

清理：

kubectl delete canary bookinfo -n istio





localityLbSetting

distribute

release/canary/flagger/trafficPolicy/loadBalancer/localityLbSetting/canary-reviews-trafficPolicy-loadBalancer-localityLbSetting-distribute.yaml

kubectl apply -f canary-reviews-trafficPolicy-loadBalancer-localityLbSetting-distribute.yaml -n istio

必须加上simple，istio里不需要加

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN
        localityLbSetting:
          enabled: true
          distribute:
          - from: "us-central2/z2/*"
            to:
              "us-central3/z3/*": 100
              #"us-central2/z2/*": 100
              #"us-central1/z1/*": 100
      outlierDetection:
        consecutive5xxErrors: 1
        interval: 5m
        baseEjectionTime: 15m
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


kubectl get dr -n istio reviews-primary -o yaml
没有生成localityLbSetting信息，可能是bug
 spec:
  host: reviews-primary
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
    outlierDetection:
      baseEjectionTime: 15m
      consecutive5xxErrors: 1
      interval: 5m

kubectl get dr -n istio reviews-canary -o yaml
没有生成localityLbSetting信息，可能是bug
spec:
  host: reviews-canary
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
    outlierDetection:
      baseEjectionTime: 15m
      consecutive5xxErrors: 1
      interval: 5m

```

清理：

kubectl delete canary bookinfo -n istio





failover

release/canary/flagger/trafficPolicy/loadBalancer/localityLbSetting/canary-reviews-trafficPolicy-loadBalancer-localityLbSetting-failover.yaml

kubectl apply -f canary-reviews-trafficPolicy-loadBalancer-localityLbSetting-failover.yaml -n istio

必须加上simple，istio里不需要加

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN
        localityLbSetting:
          enabled: true
          failover:
          - from: us-central1
            to: us-central2
          - from: us-central2
            to: us-central1
      outlierDetection:
        consecutive5xxErrors: 1
        interval: 5m
        baseEjectionTime: 15m
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio

kubectl get dr -n istio reviews-primary -o yaml
没有生成localityLbSetting信息，可能是bug
 spec:
  host: reviews-primary
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
    outlierDetection:
      baseEjectionTime: 15m
      consecutive5xxErrors: 1
      interval: 5m

kubectl get dr -n istio reviews-canary -o yaml
没有生成localityLbSetting信息，可能是bug
spec:
  host: reviews-canary
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
    outlierDetection:
      baseEjectionTime: 15m
      consecutive5xxErrors: 1
      interval: 5m

```

清理：

kubectl delete canary bookinfo -n istio



simple

leastconn

release/canary/flagger/trafficPolicy/loadBalancer/simple/canary-reviews-trafficPolicy-loadBalancer-simple-leastconn.yaml

kubectl apply -f canary-reviews-trafficPolicy-loadBalancer-simple-leastconn.yaml -n istio



```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio

kubectl get dr -n istio reviews-primary -o yaml
spec:
  host: reviews-primary
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN

kubectl get dr -n istio reviews-canary -o yaml
spec:
  host: reviews-canary
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN

```

清理：

kubectl delete canary bookinfo -n istio





random

release/canary/flagger/trafficPolicy/loadBalancer/simple/canary-reviews-trafficPolicy-loadBalancer-simple-random.yaml

kubectl apply -f canary-reviews-trafficPolicy-loadBalancer-simple-random.yaml -n istio



```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    trafficPolicy:
      loadBalancer:
        simple: RANDOM
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio

kubectl get dr -n istio reviews-primary -o yaml
spec:
  host: reviews-primary
  trafficPolicy:
    loadBalancer:
      simple: RANDOM

kubectl get dr -n istio reviews-canary -o yaml
spec:
  host: reviews-canary
  trafficPolicy:
    loadBalancer:
      simple: RANDOM

```

清理：

kubectl delete canary bookinfo -n istio





roundrobin

release/canary/flagger/trafficPolicy/loadBalancer/simple/canary-reviews-trafficPolicy-loadBalancer-simple-roundrobin.yaml

kubectl apply -f canary-reviews-trafficPolicy-loadBalancer-simple-roundrobin.yaml -n istio



```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio

kubectl get dr -n istio reviews-primary -o yaml
spec:
  host: reviews-primary
  trafficPolicy:
    loadBalancer:
      simple: ROUND_ROBIN

kubectl get dr -n istio reviews-canary -o yaml
spec:
  host: reviews-canary
  trafficPolicy:
    loadBalancer:
      simple: ROUND_ROBIN

```

清理：

kubectl delete canary bookinfo -n istio





passthrough

release/canary/flagger/trafficPolicy/loadBalancer/simple/canary-reviews-trafficPolicy-loadBalancer-simple-passthrough.yaml

kubectl apply -f canary-reviews-trafficPolicy-loadBalancer-simple-passthrough.yaml -n istio



```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    trafficPolicy:
      loadBalancer:
        simple: PASSTHROUGH
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio

kubectl get dr -n istio reviews-primary -o yaml
spec:
  host: reviews-primary
  trafficPolicy:
    loadBalancer:
      simple: PASSTHROUGH

kubectl get dr -n istio reviews-canary -o yaml

spec:
  host: reviews-canary
  trafficPolicy:
    loadBalancer:
      simple: PASSTHROUGH
```

清理：

kubectl delete canary bookinfo -n istio



[2]outlierDetection

release/canary/flagger/trafficPolicy/outlierDetection/canary-reviews-trafficPolicy-outlierDetection.yaml

kubectl apply -f canary-reviews-trafficPolicy-outlierDetection.yaml -n istio



```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    trafficPolicy:
      connectionPool:
        http:
          http2MaxRequests: 50
          maxRequestsPerConnection: 5
      outlierDetection:
        consecutiveErrors: 5
        interval: 10s
        baseEjectionTime: 30s
        maxEjectionPercent: 100
        minHealthPercent: 0
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio

kubectl get dr -n istio reviews-primary -o yaml
spec:
  host: reviews-primary
  trafficPolicy:
    connectionPool:
      http:
        http2MaxRequests: 50
        maxRequestsPerConnection: 5
    outlierDetection:
      baseEjectionTime: 30s
      consecutiveErrors: 5
      interval: 10s
      maxEjectionPercent: 100

kubectl get dr -n istio reviews-canary -o yaml

spec:
  host: reviews-canary
  trafficPolicy:
    connectionPool:
      http:
        http2MaxRequests: 50
        maxRequestsPerConnection: 5
    outlierDetection:
      baseEjectionTime: 30s
      consecutiveErrors: 5
      interval: 10s
      maxEjectionPercent: 100
```

清理：

kubectl delete canary bookinfo -n istio





[3]tls

release/canary/flagger/trafficPolicy/tls/canary-reviews-trafficPolicy-tls.yaml

kubectl apply -f canary-reviews-trafficPolicy-tls.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    trafficPolicy:
      tls:
        mode: MUTUAL
        caCertificates: /etc/my-cert/ca.crt
        clientCertificate: /etc/my-cert/tls.crt
        privateKey: /etc/my-cert/tls.key
        sni: reviews.istio.svc.cluster.local
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio

kubectl get dr -n istio reviews-primary -o yaml
spec:
  host: reviews-primary
  trafficPolicy:
    tls:
      caCertificates: /etc/my-cert/ca.crt
      clientCertificate: /etc/my-cert/tls.crt
      mode: MUTUAL
      privateKey: /etc/my-cert/tls.key
      sni: reviews.istio.svc.cluster.local

kubectl get dr -n istio reviews-canary -o yaml
spec:
  host: reviews-canary
  trafficPolicy:
    tls:
      caCertificates: /etc/my-cert/ca.crt
      clientCertificate: /etc/my-cert/tls.crt
      mode: MUTUAL
      privateKey: /etc/my-cert/tls.key
      sni: reviews.istio.svc.cluster.local
```

清理：

kubectl delete canary bookinfo -n istio



mode

DISABLE

release/canary/flagger/trafficPolicy/tls/canary-reviews-trafficPolicy-tls-mode-DISABLE.yaml

kubectl apply -f canary-reviews-trafficPolicy-tls-mode-DISABLE.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    trafficPolicy:
      tls:
        mode: DISABLE
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio

kubectl get dr -n istio reviews-primary -o yaml
spec:
  host: reviews-primary
  trafficPolicy:
    tls:
      mode: DISABLE

kubectl get dr -n istio reviews-canary -o yaml
spec:
  host: reviews-canary
  trafficPolicy:
    tls:
      mode: DISABLE
```

清理：

kubectl delete canary bookinfo -n istio





ISTIO_MUTUAL

release/canary/flagger/trafficPolicy/tls/canary-reviews-trafficPolicy-tls-mode-ISTIO_MUTUAL.yaml

kubectl apply -f canary-reviews-trafficPolicy-tls-mode-ISTIO_MUTUAL.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    trafficPolicy:
      tls:
        mode: ISTIO_MUTUAL
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio

kubectl get dr -n istio reviews-primary -o yaml
spec:
  host: reviews-primary
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL

kubectl get dr -n istio reviews-canary -o yaml
spec:
  host: reviews-canary
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL
```

清理：

kubectl delete canary bookinfo -n istio



credentialName

**<u>istio目前不支持</u>**



subjectAltNames

release/canary/flagger/trafficPolicy/tls/canary-reviews-trafficPolicy-tls-subjectAltNames.yaml

kubectl apply -f canary-reviews-trafficPolicy-tls-subjectAltNames.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    trafficPolicy:
      tls:
        mode: SIMPLE
        caCertificates: /etc/my-cert/ca.crt
        sni: productpage.istio.svc.cluster.local
        subjectAltNames: 
        - spiffe://cluster.local/ns/istio/sa/bookinfo-productpage
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio

kubectl get dr -n istio reviews-primary -o yaml
spec:
  host: reviews-primary
  trafficPolicy:
    tls:
      caCertificates: /etc/my-cert/ca.crt
      mode: SIMPLE
      sni: productpage.istio.svc.cluster.local
      subjectAltNames:
      - spiffe://cluster.local/ns/istio/sa/bookinfo-productpage

kubectl get dr -n istio reviews-canary -o yaml
spec:
  host: reviews-canary
  trafficPolicy:
    tls:
      caCertificates: /etc/my-cert/ca.crt
      mode: SIMPLE
      sni: productpage.istio.svc.cluster.local
      subjectAltNames:
      - spiffe://cluster.local/ns/istio/sa/bookinfo-productpage
```

清理：

kubectl delete canary bookinfo -n istio



###### analysis

[1]stepWeightPromotion

release/canary/flagger/canary-reviews-stepWeightPromotion.yaml

kubectl apply -f canary-reviews-stepWeightPromotion.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  service:
    port: 9080
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    stepWeightPromotion: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
```





```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2

kubectl describe canary bookinfo -n istio

   Type     Reason  Age                  From     Message
  ----     ------  ----                 ----     -------
  Warning  Synced  11m                  flagger  reviews-v1-primary.istio not ready: waiting for rollout to finish: observed deployment generation less than desired generation
  Normal   Synced  10m (x2 over 11m)    flagger  all the metrics providers are available!
  Normal   Synced  10m                  flagger  Initialization done! bookinfo.istio
  Normal   Synced  9m14s                flagger  New revision detected! Scaling up reviews-v1.istio
  Normal   Synced  8m14s                flagger  Starting canary analysis for reviews-v1.istio
  Normal   Synced  8m14s                flagger  Advance bookinfo.istio canary weight 20
  Normal   Synced  7m14s                flagger  Advance bookinfo.istio canary weight 40
  Warning  Synced  6m14s                flagger  Halt bookinfo.istio advancement request duration 4.315s > 500ms
  Normal   Synced  5m14s                flagger  Advance bookinfo.istio canary weight 60
  Normal   Synced  4m14s                flagger  Copying reviews-v1.istio template spec to reviews-v1-primary.istio
  Normal   Synced  3m14s                flagger  Advance bookinfo.istio primary weight 60
  Normal   Synced  14s (x3 over 2m14s)  flagger  (combined from similar events): Promotion completed! Scaling down reviews-v1.istio

```

清理：

kubectl delete canary bookinfo -n istio



[2]metrics

 Builtin metrics 

略



 Custom metrics 

release/canary/flagger/canary-reviews-metrics-Custom.yaml

kubectl apply -f canary-reviews-metrics-Custom.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  service:
    port: 9080
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: "my metric"
        thresholdRange:
          min: 0
          max: 10
        interval: 1m
        query: |
          100 - sum(
               rate(
                    istio_requests_total{
                      reporter="destination",
                      destination_workload_namespace="{{ namespace }}",
                      destination_workload="{{ target }}",
                      response_code!="404"
                    }[{{ interval }}]
                )
            )
            /
            sum(
                rate(
                    istio_requests_total{
                      reporter="destination",
                      destination_workload_namespace="{{ namespace }}",
                      destination_workload="{{ target }}"
                    }[{{ interval }}]
                )
            ) * 100
        

```





```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2

kubectl describe canary bookinfo -n istio


报错
 missing unit character in duration
```

清理：

kubectl delete canary bookinfo -n istio



threshold

release/canary/flagger/canary-reviews-metrics-Custom-threshold.yaml

kubectl apply -f canary-reviews-metrics-Custom-threshold.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  service:
    port: 9080
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: "my metric"
        threshold: 10
        interval: 1m
        query: |
          100 - sum(
               rate(
                    istio_requests_total{
                      reporter="destination",
                      destination_workload_namespace="{{ namespace }}",
                      destination_workload="{{ target }}",
                      response_code!="404"
                    }[{{ interval }}]
                )
            )
            /
            sum(
                rate(
                    istio_requests_total{
                      reporter="destination",
                      destination_workload_namespace="{{ namespace }}",
                      destination_workload="{{ target }}"
                    }[{{ interval }}]
                )
            ) * 100
        

```





```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2

kubectl describe canary bookinfo -n istio


报错
 missing unit character in duration
```

清理：

kubectl delete canary bookinfo -n istio



[3]webhooks

There are several types of hooks:

- **confirm-rollout** hooks are executed before scaling up the canary deployment and can be used for manual approval. The rollout is paused until the hook returns a successful HTTP status code.
- **pre-rollout** hooks are executed before routing traffic to canary. The canary advancement is paused if a pre-rollout hook fails and if the number of failures reach the threshold the canary will be rollback.
- **rollout** hooks are executed during the analysis on each iteration before the metric checks. If a rollout hook call fails the canary advancement is paused and eventfully rolled back.
- **confirm-traffic-increase** hooks are executed right before the weight on the canary is increased. The canary advancement is paused until this hook returns HTTP 200.
- **confirm-promotion** hooks are executed before the promotion step. The canary promotion is paused until the hooks return HTTP 200. While the promotion is paused, Flagger will continue to run the metrics checks and rollout hooks.
- **post-rollout** hooks are executed after the canary has been promoted or rolled back. If a post rollout hook fails the error is logged.
- **rollback** hooks are executed while a canary deployment is in either Progressing or Waiting status. This provides the ability to rollback during analysis or while waiting for a confirmation. If a rollback hook returns a successful HTTP status code, Flagger will stop the analysis and mark the canary release as failed.
- **event** hooks are executed every time Flagger emits a Kubernetes event. When configured, every action that Flagger takes during a canary deployment will be sent as JSON via an HTTP POST request.



安装loadtester

```
[root@master01 flagger]# tree loadtester/
loadtester/
├── Chart.yaml
├── README.md
├── templates
│   ├── appmesh.yaml
│   ├── deployment.yaml
│   ├── _helpers.tpl
│   ├── istio-gw.yaml
│   ├── istio-vs.yaml
│   ├── NOTES.txt
│   ├── pdb.yaml
│   ├── rbac.yaml
│   ├── service.yaml
│   └── virtual-node.yaml
└── values.yaml


helm upgrade -i flagger loadtester --namespace=istio-system --set cmd.timeout=1h
```



release/canary/flagger/canary-reviews-webhooks.yaml

kubectl apply -f canary-reviews-webhooks.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  service:
    port: 9080
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
    webhooks:
      - name: "start gate"
        type: confirm-rollout
        url: http://flagger-loadtester.istio-system/gate/approve
#      - name: "helm test"
#        type: pre-rollout
#        url: http://flagger-loadtester.istio-system/
#        timeout: 3m
#        metadata:
#          type: "helmv3"
#          cmd: "test reviews -n istio"
      - name: "load test"
        type: rollout
        url: http://flagger-loadtester.istio-system/
        timeout: 15s
        metadata:
          cmd: "hey -z 1m -q 5 -c 2 http://reviews.istio:9080/reviews/0/"
      - name: "traffic increase gate"
        type: confirm-traffic-increase
        url: http://flagger-loadtester.istio-system/gate/approve
      - name: "promotion gate"
        type: confirm-promotion
        url: http://flagger-loadtester.istio-system/gate/approve
#      - name: "notify"
#        type: post-rollout
#        url: http://telegram.bot:8080/
#        timeout: 5s
#        metadata:
#          some: "message"
      - name: "rollback gate"
        type: rollback
        url: http://flagger-loadtester.istio-system/rollback/check
#      - name: "send to Slack"
#        type: event
#        url: http://event-recevier.notifications/slack
#        metadata:
#          environment: "test"
#          cluster: "flagger-test"
        

```





```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2

kubectl describe canary bookinfo -n istio

 Type     Reason  Age                    From     Message
  ----     ------  ----                   ----     -------
  Normal   Synced  11m (x2 over 156m)     flagger  New revision detected! Scaling up reviews-v1.istio
  Normal   Synced  10m (x2 over 155m)     flagger  Starting canary analysis for reviews-v1.istio
  Normal   Synced  10m (x2 over 155m)     flagger  Advance bookinfo.istio canary weight 20
  Warning  Synced  8m35s (x2 over 9m35s)  flagger  Halt advancement no values found for istio metric request-success-rate probably reviews-v1.istio is not receiving traffic: running query failed: no values found
  Normal   Synced  7m35s                  flagger  Advance bookinfo.istio canary weight 40
  Normal   Synced  6m35s                  flagger  Advance bookinfo.istio canary weight 60
  Normal   Synced  5m35s (x6 over 10m)    flagger  Rollback hook rollback gate not signaling a rollback
  Normal   Synced  5m35s (x4 over 10m)    flagger  Confirm-traffic-increase check traffic increase gate passed
  Normal   Synced  5m35s                  flagger  Confirm-promotion check promotion gate passed
  Normal   Synced  5m35s                  flagger  Copying reviews-v1.istio template spec to reviews-v1-primary.istio
  Normal   Synced  3m35s (x2 over 4m35s)  flagger  (combined from similar events): Promotion completed! Scaling down reviews-v1.istio

```

清理：

kubectl delete canary bookinfo -n istio



rollout

release/canary/flagger/reviews-deploy-with-resources.yaml 

kubectl apply -f reviews-deploy-with-resources.yaml  -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: reviews
  labels:
    app: reviews
    service: reviews
spec:
  ports:
  - port: 9080
    name: http
  selector:
    app: reviews
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: bookinfo-reviews
  labels:
    account: reviews
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: reviews-v2
  labels:
    app: reviews
    version: v2
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v2
  template:
    metadata:
      labels:
        app: reviews
        version: v2
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v2:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: reviews-v3
  labels:
    app: reviews
    version: v3
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v3
  template:
    metadata:
      labels:
        app: reviews
        version: v3
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v3:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
```

release/canary/flagger/reviews-hpa.yaml 

kubectl  apply -f reviews-hpa.yaml  -n istio

```
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: review-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  minReplicas: 1
  maxReplicas: 2
  targetCPUUtilizationPercentage: 50
```

release/canary/flagger/canary-reviews-webhook-rollout.yaml

kubectl apply -f canary-reviews-webhook-rollout.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  autoscalerRef:
    apiVersion: autoscaling/v1
    kind: HorizontalPodAutoscaler
    name: review-hpa
  service:
    port: 9080
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
    webhooks:
      - name: "start gate"
        type: confirm-rollout
        url: http://flagger-loadtester.istio-system/gate/approve
#      - name: "helm test"
#        type: pre-rollout
#        url: http://flagger-loadtester.istio-system/
#        timeout: 3m
#        metadata:
#          type: "helmv3"
#          cmd: "test reviews -n istio"
      - name: "load test"
        type: rollout
        url: http://flagger-loadtester.istio-system/
        timeout: 15s
        metadata:
          cmd: "hey -z 1m -q 5 -c 2 http://reviews.istio:9080/reviews/0/"
      - name: "traffic increase gate"
        type: confirm-traffic-increase
        url: http://flagger-loadtester.istio-system/gate/approve
      - name: "promotion gate"
        type: confirm-promotion
        url: http://flagger-loadtester.istio-system/gate/approve
      - name: "notify"
        type: post-rollout
        url: https://hooks.slack.com/services/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
        timeout: 5s
        metadata:
          some: "message"
      - name: "rollback gate"
        type: rollback
        url: http://flagger-loadtester.istio-system/rollback/check
      - name: "send to Slack"
        type: event
        url: https://hooks.slack.com/services/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
        metadata:
          environment: "test"
          cluster: "flagger-test" 
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2



启用压测
go-stress-testing -c 10 -n 1000000 -u http://bookinfo.com:31773/reviews/0

 kubectl describe canary bookinfo -n istio
 没有rollout called

  Type     Reason  Age                    From     Message
  ----     ------  ----                   ----     -------
  Normal   Synced  8m33s                  flagger  Confirm-rollout check start gate passed
  Normal   Synced  7m33s                  flagger  New revision detected! Restarting analysis for reviews-v1.istio
  Normal   Synced  6m33s                  flagger  Starting canary analysis for reviews-v1.istio
  Normal   Synced  6m32s                  flagger  Advance bookinfo.istio canary weight 20
  Warning  Synced  5m33s                  flagger  Halt bookinfo.istio advancement request duration 606ms > 500ms
  Normal   Synced  4m32s                  flagger  Advance bookinfo.istio canary weight 40
  Normal   Synced  3m32s                  flagger  Advance bookinfo.istio canary weight 60
  Normal   Synced  2m33s (x4 over 6m32s)  flagger  Confirm-traffic-increase check traffic increase gate passed
  Normal   Synced  2m33s (x5 over 6m33s)  flagger  Rollback hook rollback gate not signaling a rollback
  Normal   Synced  2m32s                  flagger  Confirm-promotion check promotion gate passed
  Normal   Synced  33s (x3 over 2m32s)    flagger  (combined from similar events): Promotion completed! Scaling down reviews-v1.istio
[root@node01 ~]# 
```

清理：

kubectl delete canary bookinfo -n istio

kubectl delete hpa review-hpa -n istio





一致性测试

cd release/canary/flagger/helm/reviews-v1

helm install reviews-v1 -n istio .

赋予权限

kubectl create clusterrolebinding flagger-loadtest-admin --serviceaccount=istio-system:default  --clusterrole=cluster-admin



release/canary/flagger/reviews-hpa.yaml 

kubectl  apply -f reviews-hpa.yaml  -n istio

```
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: review-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  minReplicas: 1
  maxReplicas: 2
  targetCPUUtilizationPercentage: 50
```

release/canary/flagger/canary-reviews-webhook-uniformity.yaml

kubectl apply -f canary-reviews-webhook-uniformity.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  autoscalerRef:
    apiVersion: autoscaling/v1
    kind: HorizontalPodAutoscaler
    name: review-hpa
  service:
    port: 9080
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
    webhooks:
      - name: "start gate"
        type: confirm-rollout
        url: http://flagger-loadtester.istio-system/gate/approve
      - name: "helm test"
        type: pre-rollout
        url: http://flagger-loadtester.istio-system/
        timeout: 3m
        metadata:
          type: "helmv3"
          cmd: "test reviews-v1 -n istio"
      - name: "load test"
        type: rollout
        url: http://flagger-loadtester.istio-system/
        timeout: 15s
        metadata:
          cmd: "hey -z 1m -q 5 -c 2 http://reviews.istio:9080/reviews/0/"
      - name: "notify"
        type: post-rollout
        url: https://hooks.slack.com/services/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
        timeout: 5s
        metadata:
          some: "message" 
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2



启用压测
go-stress-testing -c 10 -n 1000000 -u http://bookinfo.com:32545/reviews/0

 kubectl describe canary bookinfo -n istio
 rollout没有执行
  Normal   Synced  11m (x4 over 133m)    flagger  New revision detected! Scaling up reviews-v1.istio
  Normal   Synced  10m (x5 over 157m)    flagger  New revision detected! Restarting analysis for reviews-v1.istio
  Normal   Synced  9m9s (x36 over 156m)  flagger  Starting canary analysis for reviews-v1.istio
  Normal   Synced  8m57s (x3 over 156m)  flagger  Advance bookinfo.istio canary weight 20
  Normal   Synced  8m57s                 flagger  Pre-rollout check helm test passed
  Warning  Synced  8m9s                  flagger  Halt bookinfo.istio advancement request duration 1.955s > 500ms
  Warning  Synced  7m9s                  flagger  Halt bookinfo.istio advancement success rate 71.22% < 99%
  Normal   Synced  2m9s                  flagger  Routing all traffic to primary、
  
  kubectl logs -f -n istio-system flagger-test-7ccc74b6ff-xd94q 
  
  {"level":"info","ts":"2021-09-06T03:16:37.425Z","caller":"controller/events.go:33","msg":"New revision detected! Restarting analysis for reviews-v1.istio","canary":"bookinfo.istio"}
{"level":"info","ts":"2021-09-06T03:17:37.457Z","caller":"controller/events.go:33","msg":"Starting canary analysis for reviews-v1.istio","canary":"bookinfo.istio"}
{"level":"info","ts":"2021-09-06T03:17:49.846Z","caller":"controller/events.go:33","msg":"Pre-rollout check helm test passed","canary":"bookinfo.istio"}
{"level":"info","ts":"2021-09-06T03:17:49.909Z","caller":"controller/events.go:33","msg":"Advance bookinfo.istio canary weight 20","canary":"bookinfo.istio"}
{"level":"info","ts":"2021-09-06T03:18:37.500Z","caller":"controller/events.go:45","msg":"Halt bookinfo.istio advancement request duration 1.955s > 500ms","canary":"bookinfo.istio"}
{"level":"info","ts":"2021-09-06T03:19:37.532Z","caller":"controller/events.go:45","msg":"Halt bookinfo.istio advancement success rate 71.22% < 99%","canary":"bookinfo.istio"}
{"level":"info","ts":"2021-09-06T03:20:37.433Z","caller":"controller/events.go:45","msg":"Halt bookinfo.istio advancement request duration 1.625s > 500ms","canary":"bookinfo.istio"}
{"level":"info","ts":"2021-09-06T03:21:37.446Z","caller":"controller/events.go:33","msg":"Advance bookinfo.istio canary weight 40","canary":"bookinfo.istio"}
{"level":"info","ts":"2021-09-06T03:22:37.441Z","caller":"controller/events.go:33","msg":"Advance bookinfo.istio canary weight 60","canary":"bookinfo.istio"}
{"level":"info","ts":"2021-09-06T03:23:37.481Z","caller":"controller/events.go:33","msg":"Copying reviews-v1.istio template spec to reviews-v1-primary.istio","canary":"bookinfo.istio"}
{"level":"info","ts":"2021-09-06T03:24:37.427Z","caller":"controller/events.go:33","msg":"Routing all traffic to primary","canary":"bookinfo.istio"}
{"level":"info","ts":"2021-09-06T03:25:37.949Z","caller":"controller/events.go:45","msg":"Post-rollout hook notify failed no_text","canary":"bookinfo.istio"}
{"level":"info","ts":"2021-09-06T03:25:37.949Z","caller":"controller/events.go:33","msg":"Promotion completed! Scaling down reviews-v1.istio","canary":"bookinfo.istio"}
```

清理：

kubectl delete canary bookinfo -n istio

kubectl delete hpa review-hpa -n istio

helm uninstall reviews-v1 -n istio



向钉钉发送消息

release/canary/flagger/reviews-deploy-with-resources.yaml 

kubectl apply -f reviews-deploy-with-resources.yaml  -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: reviews
  labels:
    app: reviews
    service: reviews
spec:
  ports:
  - port: 9080
    name: http
  selector:
    app: reviews
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: bookinfo-reviews
  labels:
    account: reviews
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: reviews-v2
  labels:
    app: reviews
    version: v2
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v2
  template:
    metadata:
      labels:
        app: reviews
        version: v2
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v2:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: reviews-v3
  labels:
    app: reviews
    version: v3
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v3
  template:
    metadata:
      labels:
        app: reviews
        version: v3
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v3:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
```

release/canary/flagger/reviews-hpa.yaml 

kubectl  apply -f reviews-hpa.yaml  -n istio

```
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: review-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  minReplicas: 1
  maxReplicas: 2
  targetCPUUtilizationPercentage: 50
```

release/canary/flagger/canary-reviews-webhook-rollout.yaml

kubectl apply -f canary-reviews-webhook-rollout.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  autoscalerRef:
    apiVersion: autoscaling/v1
    kind: HorizontalPodAutoscaler
    name: review-hpa
  service:
    port: 9080
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
    webhooks:
      - name: "start gate"
        type: confirm-rollout
        url: http://flagger-loadtester.istio-system/gate/approve
      - name: "load test"
        type: rollout
        url: http://flagger-loadtester.istio-system/
        timeout: 15s
        metadata:
          cmd: "hey -z 1m -q 5 -c 2 http://reviews.istio:9080/reviews/0/"
      - name: "traffic increase gate"
        type: confirm-traffic-increase
        url: http://flagger-loadtester.istio-system/gate/approve
      - name: "promotion gate"
        type: confirm-promotion
        url: http://flagger-loadtester.istio-system/gate/approve
      - name: "notify"
        type: post-rollout
        url: 钉钉url
        timeout: 5s
        metadata:
          some: "message"
      - name: "rollback gate"
        type: rollback
        url: http://flagger-loadtester.istio-system/rollback/check
      - name: "send to Slack"
        type: event
        url: 钉钉url
        metadata:
          environment: "test"
          cluster: "flagger-test" 
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2



启用压测
go-stress-testing -c 10 -n 1000000 -u http://bookinfo.com:31773/reviews/0

 kubectl describe canary bookinfo -n istio

```





##### alertproviders

###### slack

release/canary/flagger/canary-reviews-alertproviders-slack.yaml

kubectl apply -f canary-reviews-alertproviders-slack.yaml -n istio-system

type: "slack", "msteams", "discord", "rocket", "gchat"

```
apiVersion: flagger.app/v1beta1
kind: AlertProvider
metadata:
  name: on-call
spec:
  type: slack
  channel: test
  username: test
  address: https://hooks.slack.com/services/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
```



release/canary/flagger/canary-reviews-alertproviders-slack-canray.yaml

kubectl apply -f canary-reviews-alertproviders-slack-canray.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  service:
    port: 9080
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    alerts:
    - name: alert-slack
      providerRef:
        name: on-call
        namespace: istio-system
      severity: info # error warn
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2

kubectl describe canary bookinfo -n istio

```

清理：

kubectl delete canary bookinfo -n istio



![1630885085(1)](images\1630885085(1).jpg)



######  Prometheus Alert Manager 

```
- alert: canary_rollback
    expr: flagger_canary_status > 1
    for: 1m
    labels:
      severity: warning
    annotations:
      summary: "Canary failed"
      description: "Workload {{ $labels.name }} namespace {{ $labels.namespace }}"
```



##### metrictemplates

###### prometheus

release/canary/flagger/canary-reviews-metrictemplates-prometheus.yaml

kubectl apply -f canary-reviews-metrictemplates-prometheus.yaml -n istio-system

```
apiVersion: flagger.app/v1beta1
kind: MetricTemplate
metadata:
  name: not-found-percentage
  namespace: istio-system
spec:
  provider:
    type: prometheus
    address: http://prometheus.istio-system:9090
  query: |
    100 - sum(
        rate(
            istio_requests_total{
              reporter="destination",
              destination_workload_namespace="{{ namespace }}",
              destination_workload="{{ target }}",
              response_code!="404"
            }[{{ interval }}]
        )
    )
    /
    sum(
        rate(
            istio_requests_total{
              reporter="destination",
              destination_workload_namespace="{{ namespace }}",
              destination_workload="{{ target }}"
            }[{{ interval }}]
        )
    ) * 100
```

release/canary/flagger/canary-reviews-metrictemplates-prometheus-canary.yaml

kubectl apply -f canary-reviews-metrictemplates-prometheus-canary.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  service:
    port: 9080
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
    - templateRef:
        namespace: istio-system
        name: not-found-percentage
      name: not-found-percentage
      thresholdRange:
        max: 10
      interval: 1m
        
```





```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2

kubectl describe canary bookinfo -n istio


  Type     Reason  Age                 From     Message
  ----     ------  ----                ----     -------
  Warning  Synced  11h                 flagger  Rolling back bookinfo.istio failed checks threshold reached 10
  Warning  Synced  11h                 flagger  Canary failed! Scaling down bookinfo.istio
  Normal   Synced  11h (x2 over 11h)   flagger  New revision detected! Scaling up reviews-v1.istio
  Normal   Synced  11h (x2 over 11h)   flagger  Starting canary analysis for reviews-v1.istio
  Normal   Synced  11h (x2 over 11h)   flagger  Advance bookinfo.istio canary weight 20
  Warning  Synced  11h (x18 over 11h)  flagger  Halt advancement no values found for istio metric request-duration probably reviews-v1.istio is not receiving traffic
  Warning  Synced  46m                 flagger  reviews-v1-primary.istio not ready: waiting for rollout to finish: 0 of 1 updated replicas are available
  Warning  Synced  44m (x2 over 45m)   flagger  Halt advancement no values found for istio metric request-duration probably reviews-v1.istio is not receiving traffic
  Warning  Synced  43m                 flagger  Rolling back bookinfo.istio failed checks threshold reached 10
  Warning  Synced  43m                 flagger  Canary failed! Scaling down bookinfo.istio
  Normal   Synced  7m33s               flagger  New revision detected! Scaling up reviews-v1.istio
  Normal   Synced  6m33s               flagger  Starting canary analysis for reviews-v1.istio
  Normal   Synced  6m33s               flagger  Advance bookinfo.istio canary weight 20
  Warning  Synced  5m33s               flagger  Halt bookinfo.istio advancement request duration 49ms > 10ms
  Normal   Synced  4m33s               flagger  Advance bookinfo.istio canary weight 40
  Normal   Synced  3m33s               flagger  Advance bookinfo.istio canary weight 60
  Normal   Synced  2m33s               flagger  Copying reviews-v1.istio template spec to reviews-v1-primary.istio
  Normal   Synced  93s                 flagger  Routing all traffic to primary
  Normal   Synced  33s                 flagger  Promotion completed! Scaling down reviews-v1.istio

```

清理：

kubectl delete canary bookinfo -n istio





### argo-rollout

#### 什么是argo-rollout

Argo-Rollout是一个Kubernetes Controller和对应一系列的CRD，提供更强大的Deployment能力。包括灰度发布、蓝绿部署、更新测试(experimentation)、渐进式交付(progressive delivery)等特性。

支持特性如下：

- 蓝绿色更新策略
- 金丝雀更新策略
- 细粒度，加权流量转移
- 自动回rollback和promotion
- 手动判断
- 可定制的指标查询和业务KPI分析
- 入口控制器集成：NGINX，ALB
- 服务网格集成：Istio，Linkerd，SMI
- Metric provider集成：Prometheus，Wavefront，Kayenta，Web，Kubernetes Jobs

Argo原理和Deployment差不多，只是加强rollout的策略和流量控制。当spec.template发送变化时，Argo-Rollout就会根据spec.strategy进行rollout，通常会产生一个新的ReplicaSet，逐步scale down之前的ReplicaSet的pod数量。



#### 安装

```
kubectl create namespace argo-rollouts
kubectl apply -f argo-rollout-install.yaml -n argo-rollouts

安装argo-rollouts的kubectl plugin
curl -LO https://github.com/argoproj/argo-rollouts/releases/latest/download/kubectl-argo-rollouts-linux-amd64
chmod +x ./kubectl-argo-rollouts-linux-amd64
mv ./kubectl-argo-rollouts-linux-amd64 /usr/local/bin/kubectl-argo-rollouts
```

#### 过程

![argo-canary-deployments](images\argo-canary-deployments.png)



#### 架构

![argo-rollout-architecture](images\argo-rollout-architecture.png)



#### UI Dashboard

The Argo Rollouts Kubectl plugin can serve a local UI Dashboard to visualize your Rollouts.

To start it, run `kubectl argo rollouts dashboard` in the namespace that contains your Rollouts. Then visit `localhost:3100` to view the user interface.

![rollouts-list](images\rollouts-list.png)



#### crd详解

```
[root@node01 ~]# kubectl get crd | grep argo
analysisruns.argoproj.io                   2021-09-06T03:37:06Z
analysistemplates.argoproj.io              2021-09-06T03:37:07Z
clusteranalysistemplates.argoproj.io       2021-09-06T03:37:07Z
experiments.argoproj.io                    2021-09-06T03:37:08Z
rollouts.argoproj.io                       2021-09-06T03:37:09Z
```

![1630907337(1)](images\1630907337(1).jpg)



##### rollouts

###### normal

release/canary/argo/rollout-canary-steps.yaml

kubectl apply -f rollout-canary-steps.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      steps:
      - setWeight: 20
      - pause: {}
      - setWeight: 40
      - pause: {duration: 10}
      - setWeight: 60
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
```

```
 kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio
kubectl argo rollouts get rollout reviews-v1 --watch -n istio


kubectl argo rollouts promote  reviews-v1 -n istio


```



清理：

kubectl delete rollout reviews-v1 -n istio





###### workloadRef

release/canary/argo/rollout-canary-workloadRef.yaml

kubectl apply -f rollout-canary-workloadRef.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  workloadRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  strategy:
    canary:
      steps:
      - setWeight: 20
      - pause: {}
      - setWeight: 40
      - pause: {duration: 10}
      - setWeight: 60
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
```

release/canary/argo/review-v1-deploy.yaml

kubectl apply -f review-v1-deploy.yaml -n istio

```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
```



```
 kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio
kubectl argo rollouts get rollout reviews-v1 --watch -n istio


kubectl argo rollouts promote  reviews-v1 -n istio
```

清理：

kubectl delete rollout reviews-v1 -n istio



###### rollingupdate

release/canary/argo/rollout-canary-rollingupdate.yaml

kubectl apply -f rollout-canary-rollingupdate.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    # For a normal rolling update, simply specify the canary strategy without steps defined.
    # The maxSurge and maxUnavailable fields can be specified. If omitted, defaults to 25% and 0
    # respectively.
    canary:
      maxSurge: 1
      maxUnavailable: 1
```

```
 kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio
kubectl argo rollouts get rollout reviews-v1 --watch -n istio


kubectl argo rollouts promote  reviews-v1 -n istio


```



清理：

kubectl delete rollout reviews-v1 -n istio



###### minReadySeconds

最小就绪时间



###### paused

是否暂停

rollout-reviews-paused.yaml

kubectl apply -f rollout-reviews-paused.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  paused: true
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      steps:
      - setWeight: 20
      - pause: {}
      - setWeight: 40
      - pause: {duration: 10}
      - setWeight: 60
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
```

```
 kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio
 
kubectl argo rollouts get rollout reviews-v1 --watch -n istio

Name:            reviews-v1
Namespace:       istio
Status:          ॥ Paused
Message:         manually paused
Strategy:        Canary
  Step:          8/8
  SetWeight:     100
  ActualWeight:  100
Replicas:
  Desired:       1
  Current:       0
  Updated:       0
  Ready:         0
  Available:     0

NAME          KIND     STATUS    AGE  INFO
⟳ reviews-v1  Rollout  ॥ Paused  25s 


kubectl argo rollouts promote  reviews-v1 -n istio
```

清理：

kubectl delete rollout reviews-v1 -n istio



###### progressDeadlineSeconds

升级最大处理时间

rollout-reviews-progressDeadlineSeconds.yaml

kubectl apply -f rollout-reviews-progressDeadlineSeconds.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 5
  progressDeadlineSeconds: 1
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      maxSurge: 1
      maxUnavailable: 1
```

```
 kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl argo rollouts get rollout reviews-v1 --watch -n istio

Name:            reviews-v1
Namespace:       istio
Status:          ✔ Healthy
Strategy:        Canary
  Step:          
  SetWeight:     100
  ActualWeight:  100
Images:          docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (stable)
Replicas:
  Desired:       5
  Current:       5
  Updated:       5
  Ready:         5
  Available:     5

NAME                                    KIND        STATUS        AGE    INFO
⟳ reviews-v1                            Rollout     ✔ Healthy     3m14s  
├──# revision:2                                                          
│  └──⧉ reviews-v1-6b87995785           ReplicaSet  ✔ Healthy     106s   stable
│     ├──□ reviews-v1-6b87995785-lt4qk  Pod         ✔ Running     106s   ready:2/2
│     ├──□ reviews-v1-6b87995785-pzk48  Pod         ✔ Running     106s   ready:2/2
│     ├──□ reviews-v1-6b87995785-vnbvq  Pod         ✔ Running     102s   ready:2/2
│     ├──□ reviews-v1-6b87995785-888gv  Pod         ✔ Running     101s   ready:2/2
│     └──□ reviews-v1-6b87995785-vmw7h  Pod         ✔ Running     94s    ready:2/2
└──# revision:1                                                          
   └──⧉ reviews-v1-7f9bff4bbb           ReplicaSet  • ScaledDown  3m14s  



kubectl argo rollouts promote  reviews-v1 -n istio
```

清理：

kubectl delete rollout reviews-v1 -n istio



###### replicas

副本数量,略



###### restartAt

重新开始时间

 Users can schedule a restart on their Rollout by setting the `.spec.restartAt` field to a time in the future. The controller only starts the restart after the current time is after the restartAt time. 

 For various reasons, applications often need to be restarted, e.g. for hygiene purposes or to force startup logic to occur again such as reloading of a modified Secret. In these scenarios, it is undesirable to go through an entire blue-green or canary update process. Argo Rollouts supports the ability to restart all of its Pods by performing a rolling recreate of all the Pods in a Rollout while skipping the regular BlueGreen or Canary update strategy. 

rollout-reviews-restartAt.yaml

kubectl apply -f rollout-reviews-restartAt.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 5
  restartAt: "2021-09-11T16:16:20Z"
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      steps:
      - setWeight: 20
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
```

```

 kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl argo rollouts get rollout reviews-v1 --watch -n istio
Name:            reviews-v1
Namespace:       istio
Status:          ◌ Progressing
Message:         rollout is restarting
Strategy:        Canary
  Step:          
  SetWeight:     100
  ActualWeight:  100
Images:          docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (stable)
Replicas:
  Desired:       5
  Current:       5
  Updated:       5
  Ready:         5
  Available:     5

NAME                                    KIND        STATUS         AGE   INFO
⟳ reviews-v1                            Rollout     ◌ Progressing  2m8s  
├──# revision:2                                                          
│  └──⧉ reviews-v1-6b87995785           ReplicaSet  ✔ Healthy      2m    stable
│     ├──□ reviews-v1-6b87995785-6xrwz  Pod         ✔ Running      118s  ready:2/2
│     ├──□ reviews-v1-6b87995785-fxd8c  Pod         ✔ Running      118s  ready:2/2
│     ├──□ reviews-v1-6b87995785-rsn86  Pod         ✔ Running      113s  ready:2/2
│     ├──□ reviews-v1-6b87995785-kdlh9  Pod         ✔ Running      108s  ready:2/2
│     └──□ reviews-v1-6b87995785-cfr84  Pod         ✔ Running      104s  ready:2/2
└──# revision:1                                                          
   └──⧉ reviews-v1-7f9bff4bbb           ReplicaSet  • ScaledDown   2m8s 
```



###### revisionHistoryLimit

历史版本数量

rollout-reviews-revisionHistoryLimit.yaml

kubectl apply -f rollout-reviews-revisionHistoryLimit.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  revisionHistoryLimit: 5
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      maxSurge: 1
      maxUnavailable: 1
```



###### strategy

[1]canary

canaryService，stableService

release/canary/argo/rollout-reviews-canaryService-stableService.yaml

kubectl apply -f rollout-reviews-canaryService-stableService.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      canaryService: reviews-v1-canary
      stableService: reviews-v1-stable
      steps:
      - setWeight: 20
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
```

release/canary/argo/argo-svc-reviews-canary.yaml

kubectl apply -f argo-svc-reviews-canary.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: reviews-v1-canary
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
```

release/canary/argo/argo-svc-reviews-stable.yaml

kubectl apply -f argo-svc-reviews-stable.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: reviews-v1-stable
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
```



```
kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio
kubectl argo rollouts get rollout reviews-v1 --watch -n istio

Name:            reviews-v1
Namespace:       istio
Status:          ✔ Healthy
Strategy:        Canary
  Step:          4/4
  SetWeight:     100
  ActualWeight:  100
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 (stable)
Replicas:
  Desired:       1
  Current:       1
  Updated:       1
  Ready:         1
  Available:     1

NAME                                    KIND        STATUS         AGE   INFO
⟳ reviews-v1                            Rollout     ✔ Healthy      2m9s  
├──# revision:3                                                          
│  └──⧉ reviews-v1-7f9bff4bbb           ReplicaSet  ✔ Healthy      2m9s  stable
│     └──□ reviews-v1-7f9bff4bbb-827rh  Pod         ✔ Running      32s   ready:2/2
└──# revision:2                                                          
   └──⧉ reviews-v1-6b87995785           ReplicaSet  • ScaledDown   71s   
      └──□ reviews-v1-6b87995785-k56kr  Pod         ◌ Terminating  71s   ready:0/2
```



canaryMetadata，stableMetadata

release/canary/argo/rollout-reviews-canaryMetadata-stableMetadata.yaml

kubectl apply -f rollout-reviews-canaryMetadata-stableMetadata.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      canaryService: reviews-v1-canary
      stableService: reviews-v1-stable
      canaryMetadata:
        annotations:
          testcanary: testcanary
        labels:
          testcanary: testcanary
      stableMetadata:
        annotations:
          teststable: teststable
        labels:
          teststable: teststable  
      steps:
      - setWeight: 20
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
```

release/canary/argo/argo-svc-reviews-canary.yaml

kubectl apply -f argo-svc-reviews-canary.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: reviews-v1-canary
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
```

release/canary/argo/argo-svc-reviews-stable.yaml

kubectl apply -f argo-svc-reviews-stable.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: reviews-v1-stable
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
```

```
[root@node01 argo]# kubectl get pod -n istio reviews-v1-7f9bff4bbb-pr67p -o yaml
apiVersion: v1
kind: Pod
metadata:
  annotations:
    kubectl.kubernetes.io/default-container: reviews
    kubectl.kubernetes.io/default-logs-container: reviews
    prometheus.io/path: /stats/prometheus
    prometheus.io/port: "15020"
    prometheus.io/scrape: "true"
    sidecar.istio.io/status: '{"initContainers":["istio-init"],"containers":["istio-proxy"],"volumes":["istio-envoy","istio-data","istio-podinfo","istio-token","istiod-ca-cert"],"imagePullSecrets":null,"revision":"default"}'
    teststable: teststable
  creationTimestamp: "2021-09-11T09:29:25Z"
  generateName: reviews-v1-7f9bff4bbb-
  labels:
    app: reviews
    rollouts-pod-template-hash: 7f9bff4bbb
    security.istio.io/tlsMode: istio
    service.istio.io/canonical-name: reviews
    service.istio.io/canonical-revision: v1
    teststable: teststable
    version: v1
```



 antiAffinity 

preferredDuringSchedulingIgnoredDuringExecution

 does not force a new version's pods to be on a separate node than the previous versions. The scheduler attempts to place the new version's pods on separate node(s). If that's not possible, the new version's pods will still be scheduled. The `Weight` is used to create a priority order for preferred anti-affinity rules. 

release/canary/argo/rollout-canary-istio-preferredDuringSchedulingIgnoredDuringExecution.yaml

kubectl apply -f rollout-canary-istio-preferredDuringSchedulingIgnoredDuringExecution.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      argo: argo
  template:
    metadata:
      labels:
        app: reviews
        argo: argo
        canary: canary
        stable: stable
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      antiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          weight: 1
      trafficRouting:
        istio:
          virtualService:
            name: reviews-vs
            routes:
            - http-primary
          destinationRule:
            name: reviews
            canarySubsetName: v2
            stableSubsetName: v1
      steps:
      - setWeight: 20
      - pause: {}
      - setWeight: 80
      - pause: {duration: 10}

```



release/canary/argo/argo-vs-reviews-subset.yaml

kubectl apply -f argo-vs-reviews-subset.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-vs
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - "*"
  http:
  - name: http-primary
    route:
    - destination:
        host: reviews
        subset: v1
      weight: 100
    - destination:
        host: reviews
        subset: v2
      weight: 0
```

release/canary/argo/dr-reviews.yaml

kubectl apply -f dr-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews.istio.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
  subsets:
  - name: v1
    labels:
      stable: stable
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
  - name: v2
    labels:
      canary: canary
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN

```





requiredDuringSchedulingIgnoredDuringExecution

 requires a new version's pods to be on a separate node than the previous versions. If this is not possible, the the new version's pods will not be scheduled. 

release/canary/argo/rollout-canary-istio-requiredDuringSchedulingIgnoredDuringExecution.yaml

kubectl apply -f rollout-canary-istio-requiredDuringSchedulingIgnoredDuringExecution.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      argo: argo
  template:
    metadata:
      labels:
        app: reviews
        argo: argo
        canary: canary
        stable: stable
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      antiAffinity:
        requiredDuringSchedulingIgnoredDuringExecution: {}
      trafficRouting:
        istio:
          virtualService:
            name: reviews-vs
            routes:
            - http-primary
          destinationRule:
            name: reviews
            canarySubsetName: v2
            stableSubsetName: v1
      steps:
      - setWeight: 20
      - pause: {}
      - setWeight: 80
      - pause: {duration: 10}

```



release/canary/argo/argo-vs-reviews-subset.yaml

kubectl apply -f argo-vs-reviews-subset.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-vs
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - "*"
  http:
  - name: http-primary
    route:
    - destination:
        host: reviews
        subset: v1
      weight: 100
    - destination:
        host: reviews
        subset: v2
      weight: 0
```

release/canary/argo/dr-reviews.yaml

kubectl apply -f dr-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews.istio.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
  subsets:
  - name: v1
    labels:
      stable: stable
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
  - name: v2
    labels:
      canary: canary
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN

```







scaleDownDelaySeconds,scaleDownDelayRevisionLimit





trafficRouting

istio

virtualService

release/canary/argo/rollout-canary-istio.yaml

kubectl apply -f rollout-canary-istio.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      canaryService: reviews-v1-canary
      stableService: reviews-v1-stable
      trafficRouting:
        istio:
          virtualService:
            name: reviews-vs
            routes:
            - http-primary
      steps:
      - setWeight: 20
      - pause: {}
      - setWeight: 40
      - pause: {duration: 10}
      - setWeight: 60
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
```

release/canary/argo/argo-vs-reviews.yaml

kubectl apply -f argo-vs-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-vs
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - "*"
  http:
  - name: http-primary
    route:
    - destination:
        host: reviews-v1-stable
      weight: 100
    - destination:
        host: reviews-v1-canary
      weight: 0
```

release/canary/argo/argo-svc-reviews-canary.yaml

kubectl apply -f argo-svc-reviews-canary.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: reviews-v1-canary
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
```

release/canary/argo/argo-svc-reviews-stable.yaml

kubectl apply -f argo-svc-reviews-stable.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: reviews-v1-stable
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
```



```
 kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio
kubectl argo rollouts get rollout reviews-v1 --watch -n istio


Name:            reviews-v1
Namespace:       istio
Status:          ✔ Healthy
Strategy:        Canary
  Step:          8/8
  SetWeight:     100
  ActualWeight:  100
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 (stable)
Replicas:
  Desired:       1
  Current:       1
  Updated:       1
  Ready:         1
  Available:     1

NAME                                   KIND        STATUS        AGE    INFO
⟳ reviews-v1                           Rollout     ✔ Healthy     49m    
├──# revision:3                                                         
│  └──⧉ reviews-v1-54b55d79d           ReplicaSet  ✔ Healthy     49m    stable
│     └──□ reviews-v1-54b55d79d-tjgr4  Pod         ✔ Running     3m17s  ready:2/2
└──# revision:2                                                         
   └──⧉ reviews-v1-9db5f6df9           ReplicaSet  • ScaledDown  44m 
   
   

kubectl argo rollouts promote  reviews-v1 -n istio

```

清理：

kubectl delete svc reviews-v1-stable -n istio

kubectl delete svc reviews-v1-canary -n istio

kubectl delete vs reviews-vs -n istio

kubectl delete rollout reviews-v1 -n istio





destinationRule

release/canary/argo/rollout-canary-istio-destinationRule.yaml

kubectl apply -f rollout-canary-istio-destinationRule.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      argo: argo
  template:
    metadata:
      labels:
        app: reviews
        argo: argo
        canary: canary
        stable: stable
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      trafficRouting:
        istio:
          virtualService:
            name: reviews-vs
            routes:
            - http-primary
          destinationRule:
            name: reviews
            canarySubsetName: v2
            stableSubsetName: v1
      steps:
      - setWeight: 20
      - pause: {}
      - setWeight: 80
      - pause: {duration: 10}

```



release/canary/argo/argo-vs-reviews-subset.yaml

kubectl apply -f argo-vs-reviews-subset.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-vs
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - "*"
  http:
  - name: http-primary
    route:
    - destination:
        host: reviews
        subset: v1
      weight: 100
    - destination:
        host: reviews
        subset: v2
      weight: 0
```

release/canary/argo/dr-reviews.yaml

kubectl apply -f dr-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews.istio.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
  subsets:
  - name: v1
    labels:
      stable: stable
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
  - name: v2
    labels:
      canary: canary
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN
~
```



steps

setCanaryScale

release/canary/argo/rollout-reviews-steps-setCanaryScale.yaml

kubectl apply -f rollout-reviews-steps-setCanaryScale.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      trafficRouting:
        istio:
          virtualService:
            name: reviews-vs
            routes:
            - http-primary
          destinationRule:
            name: reviews
            canarySubsetName: v2
            stableSubsetName: v1
      steps:
      - setWeight: 20
      - setCanaryScale:
          matchTrafficWeight: true
          replicas: 3
          weight: 20
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
```



release/canary/argo/argo-vs-reviews-subset.yaml

kubectl apply -f argo-vs-reviews-subset.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-vs
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - "*"
  http:
  - name: http-primary
    route:
    - destination:
        host: reviews
        subset: v1
      weight: 100
    - destination:
        host: reviews
        subset: v2
      weight: 0
```

release/canary/argo/dr-reviews.yaml

kubectl apply -f dr-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews.istio.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
  subsets:
  - name: v1
    labels:
      version: v1
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
  - name: v2
    labels:
      version: v2
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN
```



###### AnalysisTemplate

analysis steps

release/canary/argo/argo-AnalysisTemplate-reviews.yaml

kubectl apply -f argo-AnalysisTemplate-reviews.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: success-rate
spec:
  args:
  - name: service-name
  metrics:
  - name: success-rate
    interval: 60s
    count: 5
    successCondition: result[0] >= 0.50
    failureLimit: 3
    provider:
      prometheus:
        address: http://prometheus.istio-system:9090
        query: |
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}",response_code!~"5.*"}[5m]
          )) / 
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}"}[5m]
          ))
```

release/canary/argo/rollout-canary-reviewsAnalysisTemplate.yaml

kubectl apply -f rollout-canary-reviewsAnalysisTemplate.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      trafficRouting:
        istio:
          virtualService:
            name: reviews-vs
            routes:
            - http-primary
          destinationRule:
            name: reviews
            canarySubsetName: v2
            stableSubsetName: v1
      steps:
      - setWeight: 20
      - pause: {}
      - analysis:
          templates:
          - templateName: success-rate
            clusterScope: false
          args:
          - name: service-name
            value: reviews.istio.svc.cluster.local
      - setWeight: 40
      - pause: {duration: 10}
      - setWeight: 60
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
      
```

release/canary/argo/argo-vs-reviews.yaml

kubectl apply -f argo-vs-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-vs
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - "*"
  http:
  - name: http-primary
    route:
    - destination:
        host: reviews
      weight: 100
    - destination:
        host: reviews
      weight: 0
```

release/canary/argo/dr-reviews.yaml

kubectl apply -f dr-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews.istio.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
  subsets:
  - name: v1
    labels:
      version: v1
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
  - name: v2
    labels:
      version: v2
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN
```





```
go-stress-testing -c 10 -n 1000000 -u http://192.168.229.134:30684/reviews/0

kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio
kubectl argo rollouts get rollout reviews-v1 --watch -n istio

Name:            reviews-v1
Namespace:       istio
Status:          ॥ Paused
Message:         CanaryPauseStep
Strategy:        Canary
  Step:          6/9
  SetWeight:     60
  ActualWeight:  60
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 (stable)
                 docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (canary)
Replicas:
  Desired:       1
  Current:       2
  Updated:       1
  Ready:         2
  Available:     2

NAME                                    KIND         STATUS        AGE    INFO
⟳ reviews-v1                            Rollout      ॥ Paused      121m   
├──# revision:16                                                          
│  ├──⧉ reviews-v1-6b87995785           ReplicaSet   ✔ Healthy     120m   canary
│  │  └──□ reviews-v1-6b87995785-8t7xp  Pod          ✔ Running     4m33s  ready:2/2
│  └──α reviews-v1-6b87995785-16-2      AnalysisRun  ✔ Successful  4m16s  ✔ 5
├──# revision:15                                                          
│  └──⧉ reviews-v1-7f9bff4bbb           ReplicaSet   ✔ Healthy     121m   stable
│     └──□ reviews-v1-7f9bff4bbb-j46nz  Pod          ✔ Running     29m    ready:2/2
├──# revision:14                                                          
│  └──α reviews-v1-6b87995785-14-2      AnalysisRun  ✖ Failed      13m    ✖ 4
└──# revision:12                                                          
   └──α reviews-v1-6b87995785-12-2      AnalysisRun  ⚠ Error       16m    ⚠ 5
   
   

kubectl argo rollouts promote  reviews-v1 -n istio

```



清理：

kubectl delete vs reviews-vs -n istio

kubectl delete rollout reviews-v1 -n istio

kubectl delete AnalysisTemplate success-rate -n istio



analysis-outside

release/canary/argo/argo-AnalysisTemplate-reviews.yaml

kubectl apply -f argo-AnalysisTemplate-reviews.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: success-rate
spec:
  args:
  - name: service-name
  metrics:
  - name: success-rate
    interval: 60s
    count: 5
    successCondition: result[0] >= 0.50
    failureLimit: 3
    provider:
      prometheus:
        address: http://prometheus.istio-system:9090
        query: |
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}",response_code!~"5.*"}[5m]
          )) / 
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}"}[5m]
          ))
```

release/canary/argo/rollout-canary-reviews-analysis-outside.yaml

kubectl apply -f rollout-canary-reviews-analysis-outside.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      trafficRouting:
        istio:
          virtualService:
            name: reviews-vs
            routes:
            - http-primary
          destinationRule:
            name: reviews
            canarySubsetName: v2
            stableSubsetName: v1
      analysis:
        templates:
        - templateName: success-rate
          clusterScope: false
        args:
        - name: service-name
          value: reviews.istio.svc.cluster.local
      steps:
      - setWeight: 20
      - pause: {}
      - setWeight: 40
      - pause: {duration: 10}
      - setWeight: 60
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
      
```

release/canary/argo/argo-vs-reviews.yaml

kubectl apply -f argo-vs-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-vs
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - "*"
  http:
  - name: http-primary
    route:
    - destination:
        host: reviews-v1-stable
      weight: 100
    - destination:
        host: reviews-v1-canary
      weight: 0
```

release/canary/argo/dr-reviews.yaml

kubectl apply -f dr-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews.istio.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
  subsets:
  - name: v1
    labels:
      version: v1
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
  - name: v2
    labels:
      version: v2
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN
```





```
 kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio
kubectl argo rollouts get rollout reviews-v1 --watch -n istio

Name:            reviews-v1
Namespace:       istio
Status:          ✔ Healthy
Strategy:        Canary
  Step:          8/8
  SetWeight:     100
  ActualWeight:  100
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 (stable)
Replicas:
  Desired:       1
  Current:       2
  Updated:       1
  Ready:         2
  Available:     2

NAME                                    KIND         STATUS         AGE   INFO
⟳ reviews-v1                            Rollout      ✔ Healthy      127m  
├──# revision:17                                                          
│  ├──⧉ reviews-v1-7f9bff4bbb           ReplicaSet   ✔ Healthy      127m  stable
│  │  └──□ reviews-v1-7f9bff4bbb-ws2c7  Pod          ✔ Running      81s   ready:2/2
│  └──α reviews-v1-7f9bff4bbb-17        AnalysisRun  ✔ Successful   81s   ✖ 1
├──# revision:16                                                          
│  ├──⧉ reviews-v1-6b87995785           ReplicaSet   • ScaledDown   127m  
│  │  └──□ reviews-v1-6b87995785-8t7xp  Pod          ◌ Terminating  11m   ready:2/2
│  └──α reviews-v1-6b87995785-16-2      AnalysisRun  ✔ Successful   10m   ✔ 5
├──# revision:14                                                          
│  └──α reviews-v1-6b87995785-14-2      AnalysisRun  ✖ Failed       19m   ✖ 4
└──# revision:12                                                          
   └──α reviews-v1-6b87995785-12-2      AnalysisRun  ⚠ Error        22m   ⚠ 5

   
   

kubectl argo rollouts promote  reviews-v1 -n istio

```



清理：

kubectl delete vs reviews-vs -n istio

kubectl delete rollout reviews-v1 -n istio

kubectl delete AnalysisTemplate success-rate -n istio



startingStep

release/canary/argo/argo-AnalysisTemplate-reviews.yaml

kubectl apply -f argo-AnalysisTemplate-reviews.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: success-rate
spec:
  args:
  - name: service-name
  metrics:
  - name: success-rate
    interval: 60s
    count: 5
    successCondition: result[0] >= 0.50
    failureLimit: 3
    provider:
      prometheus:
        address: http://prometheus.istio-system:9090
        query: |
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}",response_code!~"5.*"}[5m]
          )) / 
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}"}[5m]
          ))
```

release/canary/argo/rollout-canary-reviews-analysis-outside-startingStep.yaml

kubectl apply -f rollout-canary-reviews-analysis-outside-startingStep.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
  template:
    metadata:
      labels:
        app: reviews
        version: v1
        version: v2
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      trafficRouting:
        istio:
          virtualService:
            name: reviews-vs
            routes:
            - http-primary
          destinationRule:
            name: reviews
            canarySubsetName: v2
            stableSubsetName: v1
      analysis:
        startingStep: 5
        templates:
        - templateName: success-rate
          clusterScope: false
        args:
        - name: service-name
          value: reviews.istio.svc.cluster.local
      steps:
      - setWeight: 20
      - pause: {}
      - setWeight: 40
      - pause: {duration: 10}
      - setWeight: 60
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
      
```

release/canary/argo/argo-vs-reviews.yaml

kubectl apply -f argo-vs-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-vs
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - "*"
  http:
  - name: http-primary
    route:
    - destination:
        host: reviews-v1-stable
      weight: 100
    - destination:
        host: reviews-v1-canary
      weight: 0
```

release/canary/argo/dr-reviews.yaml

kubectl apply -f dr-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews.istio.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
  subsets:
  - name: v1
    labels:
      version: v1
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
  - name: v2
    labels:
      version: v2
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN
```





```
 kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio
kubectl argo rollouts get rollout reviews-v1 --watch -n istio

Name:            reviews-v1
Namespace:       istio
Status:          ॥ Paused
Message:         CanaryPauseStep
Strategy:        Canary
  Step:          5/8
  SetWeight:     60
  ActualWeight:  60
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 (canary, stable)
Replicas:
  Desired:       1
  Current:       2
  Updated:       1
  Ready:         2
  Available:     2

NAME                                    KIND         STATUS        AGE    INFO
⟳ reviews-v1                            Rollout      ॥ Paused      132m   
├──# revision:18                                                          
│  ├──⧉ reviews-v1-5665fcbd47           ReplicaSet   ✔ Healthy     48s    canary
│  │  └──□ reviews-v1-5665fcbd47-5qrml  Pod          ✔ Running     47s    ready:2/2
│  └──α reviews-v1-5665fcbd47-18        AnalysisRun  ◌ Running     7s     ✔ 1
├──# revision:17                                                          
│  ├──⧉ reviews-v1-7f9bff4bbb           ReplicaSet   ✔ Healthy     132m   stable
│  │  └──□ reviews-v1-7f9bff4bbb-ws2c7  Pod          ✔ Running     6m11s  ready:2/2
│  └──α reviews-v1-7f9bff4bbb-17        AnalysisRun  ✔ Successful  6m11s  ✖ 1
├──# revision:16                                                          
│  ├──⧉ reviews-v1-6b87995785           ReplicaSet   • ScaledDown  132m   
│  └──α reviews-v1-6b87995785-16-2      AnalysisRun  ✔ Successful  15m    ✔ 5
├──# revision:14                                                          
│  └──α reviews-v1-6b87995785-14-2      AnalysisRun  ✖ Failed      24m    ✖ 4
└──# revision:12                                                          
   └──α reviews-v1-6b87995785-12-2      AnalysisRun  ⚠ Error       27m    ⚠ 5
   
   

kubectl argo rollouts promote  reviews-v1 -n istio

```



清理：

kubectl delete vs reviews-vs -n istio

kubectl delete rollout reviews-v1 -n istio

kubectl delete AnalysisTemplate success-rate -n istio



job

release/canary/argo/argo-AnalysisTemplate-job-reviews.yaml

kubectl apply -f argo-AnalysisTemplate-job-reviews.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: success-rate
spec:
  args:
  - name: service-name
  metrics:
  - name: success-rate
    interval: 60s
    count: 5
    successCondition: result[0] >= 0.5
    failureLimit: 3
    provider:
      job:
        spec:
          backoffLimit: 1
          template:
            metadata:
              annotations:
                sidecar.istio.io/inject: “true”
            spec:
              containers:
              - name: test
                image: busybox
                command: [wget]
                args: ["http://192.168.229.134:30684/reviews/0"]
              restartPolicy: Never
```

release/canary/argo/rollout-canary-reviewsAnalysisTemplate.yaml

kubectl apply -f rollout-canary-reviewsAnalysisTemplate.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
  template:
    metadata:
      labels:
        app: reviews
        version: v1
        version: v2
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      trafficRouting:
        istio:
          virtualService:
            name: reviews-vs
            routes:
            - http-primary
          destinationRule:
            name: reviews
            canarySubsetName: v2
            stableSubsetName: v1
      steps:
      - setWeight: 20
      - pause: {}
      - analysis:
          templates:
          - templateName: success-rate
            clusterScope: false
          args:
          - name: service-name
            value: reviews-v1-canary.istio.svc.cluster.local
      - setWeight: 40
      - pause: {duration: 10}
      - setWeight: 60
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
      
```

release/canary/argo/argo-vs-reviews.yaml

kubectl apply -f argo-vs-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-vs
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - "*"
  http:
  - name: http-primary
    route:
    - destination:
        host: reviews-v1-stable
      weight: 100
    - destination:
        host: reviews-v1-canary
      weight: 0
```

release/canary/argo/dr-reviews.yaml

kubectl apply -f dr-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews.istio.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
  subsets:
  - name: v1
    labels:
      version: v1
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
  - name: v2
    labels:
      version: v2
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN
```



```
 kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio
kubectl argo rollouts get rollout reviews-v1 --watch -n istio

Name:            reviews-v1
Namespace:       istio
Status:          ◌ Progressing
Message:         waiting for all steps to complete
Strategy:        Canary
  Step:          2/9
  SetWeight:     20
  ActualWeight:  20
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 (stable)
                 docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (canary)
Replicas:
  Desired:       1
  Current:       2
  Updated:       1
  Ready:         2
  Available:     2

NAME                                                            KIND         STATUS         AGE    INFO
⟳ reviews-v1                                                    Rollout      ◌ Progressing  3m40s  
├──# revision:2                                                                                    
│  ├──⧉ reviews-v1-6b87995785                                   ReplicaSet   ✔ Healthy      3m22s  canary
│  │  └──□ reviews-v1-6b87995785-hghjp                          Pod          ✔ Running      3m22s  ready:2/2
│  └──α reviews-v1-6b87995785-2-2                               AnalysisRun  ◌ Running      2m32s  ✔ 3
│     └──⊞ aa9ca4a9-7557-4d4e-bf4a-71a7b5b3d1bf.success-rate.3  Job          ✔ Successful   30s    
└──# revision:1                                                                                    
   └──⧉ reviews-v1-7f9bff4bbb                                   ReplicaSet   ✔ Healthy      3m40s  stable
      └──□ reviews-v1-7f9bff4bbb-4b4gd                          Pod          ✔ Running      3m40s  ready:2/2
   
   

kubectl argo rollouts promote  reviews-v1 -n istio

```



清理：

kubectl delete vs reviews-vs -n istio

kubectl delete rollout reviews-v1 -n istio

kubectl delete AnalysisTemplate success-rate -n istio





web

release/canary/argo/argo-AnalysisTemplate-web-reviews.yaml

kubectl apply -f argo-AnalysisTemplate-web-reviews.yaml -n istio

```
{
  "data": {
    "ok": true,
    "successPercent": 0.95
  }
}
```



```
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: success-rate
spec:
  args:
  - name: service-name
  metrics:
  - name: webmetric
    successCondition: "result.ok && result.successPercent >= 0.90"
    provider:
      web:
        url: "http://my-server.com/api/v1/measurement?service={{ args.service-name }}"
        headers:
          - key: Authorization
            value: "Bearer {{ args.api-token }}"
        jsonPath: "{$.data}"
```

release/canary/argo/rollout-canary-reviewsAnalysisTemplate.yaml

kubectl apply -f rollout-canary-reviewsAnalysisTemplate.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      trafficRouting:
        istio:
          virtualService:
            name: reviews-vs
            routes:
            - http-primary
          destinationRule:
            name: reviews
            canarySubsetName: v2
            stableSubsetName: v1
      steps:
      - setWeight: 20
      - pause: {}
      - analysis:
          templates:
          - templateName: success-rate
            clusterScope: false
          args:
          - name: service-name
            value: reviews-v1-canary.istio.svc.cluster.local
      - setWeight: 40
      - pause: {duration: 10}
      - setWeight: 60
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
      
```

release/canary/argo/argo-vs-reviews.yaml

kubectl apply -f argo-vs-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-vs
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - "*"
  http:
  - name: http-primary
    route:
    - destination:
        host: reviews-v1-stable
      weight: 100
    - destination:
        host: reviews-v1-canary
      weight: 0
```

release/canary/argo/dr-reviews.yaml

kubectl apply -f dr-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews.istio.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
  subsets:
  - name: v1
    labels:
      version: v1
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
  - name: v2
    labels:
      version: v2
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN
```



```
 kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio
kubectl argo rollouts get rollout reviews-v1 --watch -n istio

   
   

kubectl argo rollouts promote  reviews-v1 -n istio

```



清理：

kubectl delete vs reviews-vs -n istio

kubectl delete rollout reviews-v1 -n istio

kubectl delete AnalysisTemplate success-rate -n istio



consecutiveErrorLimit

连续错误限值

release/canary/argo/argo-AnalysisTemplate-job-consecutiveErrorLimit.yaml

kubectl apply -f argo-AnalysisTemplate-job-consecutiveErrorLimit.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: success-rate
spec:
  args:
  - name: service-name
  metrics:
  - name: success-rate
    interval: 60s
    count: 5
    successCondition: result[0] >= 0.5
    failureLimit: 3
    consecutiveErrorLimit: 2
    provider:
      job:
        spec:
          backoffLimit: 1
          template:
            metadata:
              annotations:
                sidecar.istio.io/inject: “true”
            spec:
              containers:
              - name: test
                image: busybox
                command: [wget]
                args: ["http://192.168.229.134:30684/error"]
              restartPolicy: Never
```

release/canary/argo/rollout-canary-reviewsAnalysisTemplate.yaml

kubectl apply -f rollout-canary-reviewsAnalysisTemplate.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
  template:
    metadata:
      labels:
        app: reviews
        version: v1
        version: v2
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      trafficRouting:
        istio:
          virtualService:
            name: reviews-vs
            routes:
            - http-primary
          destinationRule:
            name: reviews
            canarySubsetName: v2
            stableSubsetName: v1
      steps:
      - setWeight: 20
      - pause: {}
      - analysis:
          
          templates:
          - templateName: success-rate
            clusterScope: false
          args:
          - name: service-name
            value: reviews-v1-canary.istio.svc.cluster.local
      - setWeight: 40
      - pause: {duration: 10}
      - setWeight: 60
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
      
```

release/canary/argo/argo-vs-reviews.yaml

kubectl apply -f argo-vs-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-vs
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - "*"
  http:
  - name: http-primary
    route:
    - destination:
        host: reviews-v1-stable
      weight: 100
    - destination:
        host: reviews-v1-canary
      weight: 0
```

release/canary/argo/dr-reviews.yaml

kubectl apply -f dr-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews.istio.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
  subsets:
  - name: v1
    labels:
      version: v1
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
  - name: v2
    labels:
      version: v2
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN
```



```
 kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio
kubectl argo rollouts get rollout reviews-v1 --watch -n istio

 Name:            reviews-v1
Namespace:       istio
Status:          ✖ Degraded
Message:         RolloutAborted: Rollout aborted update to revision 3: metric "success-rate" assessed Failed due to failed (4) > failureLimit (3)
Strategy:        Canary
  Step:          0/9
  SetWeight:     0
  ActualWeight:  0
Images:          docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (stable)
Replicas:
  Desired:       1
  Current:       1
  Updated:       0
  Ready:         1
  Available:     1

NAME                                                            KIND         STATUS         AGE    INFO
⟳ reviews-v1                                                    Rollout      ✖ Degraded     24m    
├──# revision:3                                                                                    
│  ├──⧉ reviews-v1-7f9bff4bbb                                   ReplicaSet   • ScaledDown   24m    canary
│  │  └──□ reviews-v1-7f9bff4bbb-r5mh8                          Pod          ◌ Terminating  4m3s   ready:2/2
│  └──α reviews-v1-7f9bff4bbb-3-2                               AnalysisRun  ✖ Failed       3m50s  ✖ 4
│     └──⊞ 9126fd9c-bb2b-49b7-a0e1-064b9a706834.success-rate.4  Job          ✖ Failed       15s    
└──# revision:2                                                                                    
   ├──⧉ reviews-v1-6b87995785                                   ReplicaSet   ✔ Healthy      24m    stable
   │  └──□ reviews-v1-6b87995785-hghjp                          Pod          ✔ Running      24m    ready:2/2
   └──α reviews-v1-6b87995785-2-2                               AnalysisRun  ✔ Successful   23m    ✔ 5
      └──⊞ aa9ca4a9-7557-4d4e-bf4a-71a7b5b3d1bf.success-rate.5  Job          ✔ Successful   19m    

kubectl argo rollouts promote  reviews-v1 -n istio

```



清理：

kubectl delete vs reviews-vs -n istio

kubectl delete rollout reviews-v1 -n istio

kubectl delete AnalysisTemplate success-rate -n istio





inconclusiveLimit

不确定结论限值

release/canary/argo/argo-AnalysisTemplate-inconclusiveLimit.yaml

kubectl apply -f argo-AnalysisTemplate-inconclusiveLimit.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: success-rate
spec:
  args:
  - name: service-name
  metrics:
  - name: success-rate
    interval: 60s
    count: 5
    successCondition: result[0] <= 0.60 and result[0] > 0.50
    failureCondition: result[0] <= 0.50
    failureLimit: 3
    inconclusiveLimit: 2    
    provider:
      prometheus:
        address: http://prometheus.istio-system:9090
        query: |
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}",response_code!~"5.*"}[5m]
          )) / 
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}"}[5m]
          ))
```

release/canary/argo/rollout-canary-reviewsAnalysisTemplate.yaml

kubectl apply -f rollout-canary-reviewsAnalysisTemplate.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      trafficRouting:
        istio:
          virtualService:
            name: reviews-vs
            routes:
            - http-primary
          destinationRule:
            name: reviews
            canarySubsetName: v2
            stableSubsetName: v1
      steps:
      - setWeight: 20
      - pause: {}
      - analysis:
          templates:
          - templateName: success-rate
            clusterScope: false
          args:
          - name: service-name
            value: reviews.istio.svc.cluster.local
      - setWeight: 40
      - pause: {duration: 10}
      - setWeight: 60
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
      
```

release/canary/argo/argo-vs-reviews.yaml

kubectl apply -f argo-vs-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-vs
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - "*"
  http:
  - name: http-primary
    route:
    - destination:
        host: reviews
      weight: 100
    - destination:
        host: reviews
      weight: 0
```

release/canary/argo/dr-reviews.yaml

kubectl apply -f dr-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews.istio.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
  subsets:
  - name: v1
    labels:
      version: v1
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
  - name: v2
    labels:
      version: v2
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN
```



```
 kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio
kubectl argo rollouts get rollout reviews-v1 --watch -n istio

Name:            reviews-v1
Namespace:       istio
Status:          ॥ Paused
Message:         InconclusiveAnalysisRun
Strategy:        Canary
  Step:          2/9
  SetWeight:     20
  ActualWeight:  20
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 (canary)
                 docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (stable)
Replicas:
  Desired:       1
  Current:       2
  Updated:       1
  Ready:         2
  Available:     2

NAME                                                            KIND         STATUS          AGE    INFO
⟳ reviews-v1                                                    Rollout      ॥ Paused        42m    
├──# revision:7                                                                                     
│  ├──⧉ reviews-v1-7f9bff4bbb                                   ReplicaSet   ✔ Healthy       42m    canary
│  │  └──□ reviews-v1-7f9bff4bbb-cpdxf                          Pod          ✔ Running       2m54s  ready:2/2
│  └──α reviews-v1-7f9bff4bbb-7-2                               AnalysisRun  ? Inconclusive  2m20s  ? 3
├──# revision:6                                                                                     
│  └──⧉ reviews-v1-6b87995785                                   ReplicaSet   ✔ Healthy       42m    stable
│     └──□ reviews-v1-6b87995785-hghjp                          Pod          ✔ Running       42m    ready:2/2
├──# revision:5                                                                                     
│  └──α reviews-v1-7f9bff4bbb-5-2                               AnalysisRun  ✖ Failed        9m20s  ✖ 4
├──# revision:3                                                                                     
│  └──α reviews-v1-7f9bff4bbb-3-2                               AnalysisRun  ✖ Failed        21m    ✖ 4
│     └──⊞ 9126fd9c-bb2b-49b7-a0e1-064b9a706834.success-rate.4  Job          ✖ Failed        18m    
└──# revision:2                                                                                     
   └──α reviews-v1-6b87995785-2-2                               AnalysisRun  ✔ Successful    41m    ✔ 5
      └──⊞ aa9ca4a9-7557-4d4e-bf4a-71a7b5b3d1bf.success-rate.5  Job          ✔ Successful    37m  
      
      kubectl argo rollouts promote  reviews-v1 -n istio
```

initialDelay

开始延迟

release/canary/argo/argo-AnalysisTemplate-job-initialDelay.yaml

kubectl apply -f argo-AnalysisTemplate-job-initialDelay.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: success-rate
spec:
  args:
  - name: service-name
  metrics:
  - name: success-rate
    interval: 60s
    count: 5
    successCondition: result[0] >= 0.5
    failureLimit: 3
    initialDelay: 30s
    provider:
      job:
        spec:
          backoffLimit: 1
          template:
            metadata:
              annotations:
                sidecar.istio.io/inject: “true”
            spec:
              containers:
              - name: test
                image: busybox
                command: [wget]
                args: ["http://192.168.229.134:30684/reviews/0"]
              restartPolicy: Never
```

release/canary/argo/rollout-canary-reviewsAnalysisTemplate.yaml

kubectl apply -f rollout-canary-reviewsAnalysisTemplate.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
  template:
    metadata:
      labels:
        app: reviews
        version: v1
        version: v2
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      trafficRouting:
        istio:
          virtualService:
            name: reviews-vs
            routes:
            - http-primary
          destinationRule:
            name: reviews
            canarySubsetName: v2
            stableSubsetName: v1
      steps:
      - setWeight: 20
      - pause: {}
      - analysis:
          templates:
          - templateName: success-rate
            clusterScope: false
          args:
          - name: service-name
            value: reviews-v1-canary.istio.svc.cluster.local
      - setWeight: 40
      - pause: {duration: 10}
      - setWeight: 60
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
      
```

release/canary/argo/argo-vs-reviews.yaml

kubectl apply -f argo-vs-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-vs
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - "*"
  http:
  - name: http-primary
    route:
    - destination:
        host: reviews-v1-stable
      weight: 100
    - destination:
        host: reviews-v1-canary
      weight: 0
```

release/canary/argo/dr-reviews.yaml

kubectl apply -f dr-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews.istio.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
  subsets:
  - name: v1
    labels:
      version: v1
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
  - name: v2
    labels:
      version: v2
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN
```



```
 kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio
kubectl argo rollouts get rollout reviews-v1 --watch -n istio

Namespace:       istio
Status:          ◌ Progressing
Message:         waiting for all steps to complete
Strategy:        Canary
  Step:          2/9
  SetWeight:     20
  ActualWeight:  20
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 (canary)
                 docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (stable)
Replicas:
  Desired:       1
  Current:       2
  Updated:       1
  Ready:         2
  Available:     2

NAME                                                            KIND         STATUS          AGE    INFO
⟳ reviews-v1                                                    Rollout      ◌ Progressing   52m    
├──# revision:11                                                                                    
│  ├──⧉ reviews-v1-7f9bff4bbb                                   ReplicaSet   ✔ Healthy       52m    canary
│  │  └──□ reviews-v1-7f9bff4bbb-8ch84                          Pod          ✔ Running       48s    ready:2/2
│  └──α reviews-v1-7f9bff4bbb-11-2                              AnalysisRun  ◌ Running       33s    ✔ 1
│     └──⊞ a9c42d8b-1deb-45c0-a621-675502216d6d.success-rate.1  Job          ✔ Successful    3s     
├──# revision:10                                                                                    
│  └──⧉ reviews-v1-6b87995785                                   ReplicaSet   ✔ Healthy       52m    stable
│     └──□ reviews-v1-6b87995785-hghjp                          Pod          ✔ Running       52m    ready:2/2
├──# revision:7                                                                                     
│  ├──α reviews-v1-7f9bff4bbb-7-2                               AnalysisRun  ? Inconclusive  12m    ? 3
│  └──α reviews-v1-7f9bff4bbb-7-2.1                             AnalysisRun  ? Inconclusive  8m43s  ? 3
├──# revision:5                                                                                     
│  └──α reviews-v1-7f9bff4bbb-5-2                               AnalysisRun  ✖ Failed        19m    ✖ 4
├──# revision:3                                                                                     
│  └──α reviews-v1-7f9bff4bbb-3-2                               AnalysisRun  ✖ Failed        31m    ✖ 4
│     └──⊞ 9126fd9c-bb2b-49b7-a0e1-064b9a706834.success-rate.4  Job          ✖ Failed        27m    
└──# revision:2                                                                                     
   └──α reviews-v1-6b87995785-2-2                               AnalysisRun  ✔ Successful    51m    ✔ 5
      └──⊞ aa9ca4a9-7557-4d4e-bf4a-71a7b5b3d1bf.success-rate.5  Job          ✔ Successful    47m    

   
   

kubectl argo rollouts promote  reviews-v1 -n istio

```



清理：

kubectl delete vs reviews-vs -n istio

kubectl delete rollout reviews-v1 -n istio

kubectl delete AnalysisTemplate success-rate -n istio



failureCondition，successCondition

失败成功条件,略



###### notifications

安装

kubectl apply -f notifications-install.yaml -n argo-rollouts 



release/canary/argo/argocd-notifications-secret.yaml

kubectl apply -f argocd-notifications-secret.yaml -n argo-rollouts

```
apiVersion: v1
kind: Secret
metadata:
  name: argocd-notifications-secret
stringData:
  slack-token: xoxb-2481573454896-2504639062320-N8MXtmRUrsSDZaQFoDTI6Bax
```

release/canary/argo/argocd-notifications-cm.yaml

kubectl apply -f argocd-notifications-cm.yaml -n argo-rollouts

```
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
data:
  service.slack: |
    #apiURL: <url>                 # optional URL, e.g. https://example.com/api
    token: $slack-token
    #username: <override-username> # optional username
    #icon:
```

email



slack

release/canary/argo/rollout-canary-notifications.yaml

kubectl apply -f rollout-canary-notifications.yaml -n ist

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
  annotations:
    notifications.argoproj.io/subscribe.on-rollout-step-completed.slack: test
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
  template:
    metadata:
      labels:
        app: reviews
        version: v1
        version: v2
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      trafficRouting:
        istio:
          virtualService:
            name: reviews-vs
            routes:
            - http-primary
          destinationRule:
            name: reviews
            canarySubsetName: v2
            stableSubsetName: v1
      steps:
      - setWeight: 20
      - setWeight: 40
      - pause: {duration: 10}
      - setWeight: 60
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
      
```

release/canary/argo/argo-vs-reviews.yaml

kubectl apply -f argo-vs-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-vs
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - "*"
  http:
  - name: http-primary
    route:
    - destination:
        host: reviews-v1-stable
      weight: 100
    - destination:
        host: reviews-v1-canary
      weight: 0
```

release/canary/argo/dr-reviews.yaml

kubectl apply -f dr-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews.istio.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
  subsets:
  - name: v1
    labels:
      version: v1
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
  - name: v2
    labels:
      version: v2
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN
```



```
 kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio
kubectl argo rollouts get rollout reviews-v1 --watch -n istio

  

   
   

kubectl argo rollouts promote  reviews-v1 -n istio

```



清理：

kubectl delete vs reviews-vs -n istio

kubectl delete rollout reviews-v1 -n istio

kubectl delete AnalysisTemplate success-rate -n istio





webhook





##### experiments

What is the Experiment CRD

The Experiment CRD allows users to have ephemeral runs of one or more ReplicaSets. In addition to running ephemeral ReplicaSets, the Experiment CRD can launch AnalysisRuns alongside the ReplicaSets. Generally, those AnalysisRun is used to confirm that new ReplicaSets are running as expected.



An Experiment is intended to temporarily run one or more templates. The lifecycle of an Experiment is as follows:

1. Create and scale a ReplicaSet for each pod template specified under `spec.templates`
2. Wait for all ReplicaSets reach full availability. If a ReplicaSet does not become available within `spec.progressDeadlineSeconds`, the Experiment will fail. Once available, the Experiment will transition from the `Pending` state to a `Running` state.
3. Once an Experiment is considered `Running`, it will begin an AnalysisRun for every AnalysisTemplate referenced under `spec.analyses`.
4. If a duration is specified under `spec.duration`, the Experiment will wait until the duration has elapsed before completing the Experiment.
5. If an AnalysisRun fails or errors, the Experiment will end prematurely, with a status equal to the unsuccessful AnalysisRun (i.e. `Failed` or `Error`)
6. If one or more of the referenced AnalysisTemplates is marked with `requiredForCompletion: true`, the Experiment will not complete until those AnalysisRuns have completed, even if it exceeds the Experiment duration.
7. If neither a `spec.duration` or `requiredForCompletion: true` is specified, the Experiment will run indefinitely, until explicitly terminated (by setting `spec.terminate: true`).
8. Once an Experiment is complete, the ReplicaSets will be scaled to zero, and any incomplete AnalysisRuns will be terminated.





```
apiVersion: argoproj.io/v1alpha1
kind: Experiment
metadata:
  name: reviews-v1
spec:
  # Duration of the experiment, beginning from when all ReplicaSets became healthy (optional)
  # If omitted, will run indefinitely until terminated, or until all analyses which were marked
  # `requiredForCompletion` have completed.
  duration: 20m

  # Deadline in seconds in which a ReplicaSet should make progress towards becoming available.
  # If exceeded, the Experiment will fail.
  progressDeadlineSeconds: 30

  # List of pod template specs to run in the experiment as ReplicaSets
  templates:
  - name: purple
    # Number of replicas to run (optional). If omitted, will run a single replica
    replicas: 1
    selector:
      matchLabels:
        app: canary-demo
        color: purple
    template:
      metadata:
        labels:
          app: canary-demo
          color: purple
      spec:
        containers:
        - name: rollouts-demo
          image: argoproj/rollouts-demo:purple
          imagePullPolicy: Always
          ports:
          - name: http
            containerPort: 8080
            protocol: TCP
  - name: orange
    replicas: 1
    minReadySeconds: 10
    selector:
      matchLabels:
        app: canary-demo
        color: orange
    template:
      metadata:
        labels:
          app: canary-demo
          color: orange
      spec:
        containers:
        - name: rollouts-demo
          image: argoproj/rollouts-demo:orange
          imagePullPolicy: Always
          ports:
          - name: http
            containerPort: 8080
            protocol: TCP

  # List of AnalysisTemplate references to perform during the experiment
  analyses:
  - name: purple
    templateName: http-benchmark
    args:
    - name: host
      value: purple
  - name: orange
    templateName: http-benchmark
    args:
    - name: host
      value: orange
  - name: compare-results
    templateName: compare
    # If requiredForCompletion is true for an analysis reference, the Experiment will not complete
    # until this analysis has completed.
    requiredForCompletion: true
    args:
    - name: host
      value: purple
```



release/canary/argo/rollout-canary-reviews-Experiment.yaml

kubectl apply -f rollout-canary-reviews-Experiment.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
  template:
    metadata:
      labels:
        app: reviews
        stable: stable
        canary: canary
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary: 
      steps:
      - experiment:
          duration: 1m
          templates:
          - name: baseline
            specRef: stable
            replicas: 3
            metadata:
              annotations:
                test: testbase
              labels: 
                test: testbaase
          - name: canary
            specRef: canary
            replicas: 2
            metadata:
              annotations:
                test: testcanary
              labels: 
                test: testbanary
          analyses:
          - name: test
            templateName: success-rate
            args:
            - name: service-name
              value: reviews.istio.svc.cluster.local
```



release/canary/argo/argo-AnalysisTemplate-reviews.yaml

kubectl apply -f argo-AnalysisTemplate-reviews.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: success-rate
spec:
  args:
  - name: service-name
  metrics:
  - name: success-rate
    interval: 60s
    count: 5
    successCondition: result[0] >= 0.50
    failureLimit: 3
    provider:
      prometheus:
        address: http://prometheus.istio-system:9090
        query: |
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}",response_code!~"5.*"}[5m]
          )) / 
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}"}[5m]
          ))
```

```
 kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio
kubectl argo rollouts get rollout reviews-v1 --watch -n istio

Strategy:        Canary
  Step:          0/1
  SetWeight:     0
  ActualWeight:  0
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 (stable, Σ:baseline)
                 docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (Σ:canary)
Replicas:
  Desired:       1
  Current:       1
  Updated:       0
  Ready:         1
  Available:     1

NAME                                                    KIND         STATUS         AGE    INFO
⟳ reviews-v1                                            Rollout      ◌ Progressing  38m    
├──# revision:5                                                                            
│  ├──⧉ reviews-v1-7476b89c5d                           ReplicaSet   • ScaledDown   34s    canary
│  └──Σ reviews-v1-7476b89c5d-5-0                       Experiment   ◌ Running      34s    
│     ├──⧉ reviews-v1-7476b89c5d-5-0-baseline           ReplicaSet   ✔ Healthy      34s    
│     │  ├──□ reviews-v1-7476b89c5d-5-0-baseline-b8hww  Pod          ✔ Running      34s    ready:2/2
│     │  ├──□ reviews-v1-7476b89c5d-5-0-baseline-vhdvk  Pod          ✔ Running      34s    ready:2/2
│     │  └──□ reviews-v1-7476b89c5d-5-0-baseline-zmpdg  Pod          ✔ Running      34s    ready:2/2
│     ├──⧉ reviews-v1-7476b89c5d-5-0-canary             ReplicaSet   ✔ Healthy      34s    
│     │  ├──□ reviews-v1-7476b89c5d-5-0-canary-9fq2l    Pod          ✔ Running      34s    ready:2/2
│     │  └──□ reviews-v1-7476b89c5d-5-0-canary-zbnjd    Pod          ✔ Running      34s    ready:2/2
│     └──α reviews-v1-7476b89c5d-5-0-test               AnalysisRun  ◌ Running      22s    ✔ 1
├──# revision:4                                                                            
│  ├──⧉ reviews-v1-84b4c5ccd9                           ReplicaSet   ✔ Healthy      3m34s  stable
│  │  └──□ reviews-v1-84b4c5ccd9-2j5cs                  Pod          ✔ Running      2m23s  ready:2/2
│  └──Σ reviews-v1-84b4c5ccd9-4-0                       Experiment   ✔ Successful   3m34s  
│     ├──⧉ reviews-v1-84b4c5ccd9-4-0-baseline           ReplicaSet   • ScaledDown   3m34s  
│     ├──⧉ reviews-v1-84b4c5ccd9-4-0-canary             ReplicaSet   • ScaledDown   3m34s  
│     └──α reviews-v1-84b4c5ccd9-4-0-test               AnalysisRun  ✔ Successful   3m25s  ✖ 1
├──# revision:3                                                                            
│  └──⧉ reviews-v1-6d5599f745                           ReplicaSet   • ScaledDown   38m    
└──# revision:2                                                                            
   └──⧉ reviews-v1-77d9dfbb54                           ReplicaSet   • ScaledDown   38m    
```



standalone

release/canary/argo/rollout-canary-reviews-Experiment-standalone.yaml

kubectl apply -f rollout-canary-reviews-Experiment-standalone.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Experiment
metadata:
  name: reviews-v1
spec:
  duration: 20m
  progressDeadlineSeconds: 30
  templates:
  - name: old
    replicas: 1
    selector:
      matchLabels:
        app: canary-demo
        color: purple
    template:
      metadata:
        labels:
          app: canary-demo
          color: purple
      spec:
        serviceAccountName: bookinfo-reviews
        containers:
        - name: reviews
          image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
          imagePullPolicy: IfNotPresent
          env:
          - name: LOG_DIR
            value: "/tmp/logs"
          ports:
          - containerPort: 9080
          resources:
            requests:
              cpu: 0.02
              memory: 10Mi
          volumeMounts:
          - name: tmp
            mountPath: /tmp
          - name: wlp-output
            mountPath: /opt/ibm/wlp/output
          securityContext:
            runAsUser: 1000
        volumes:
        - name: wlp-output
          emptyDir: {}
        - name: tmp
          emptyDir: {}
  - name: orange
    replicas: 1
    minReadySeconds: 10
    selector:
      matchLabels:
        app: canary-demo
        color: orange
    template:
      metadata:
        labels:
          app: canary-demo
          color: orange
      spec:
        serviceAccountName: bookinfo-reviews
        containers:
        - name: reviews
          image: docker.io/istio/examples-bookinfo-reviews-v2:1.16.2
          imagePullPolicy: IfNotPresent
          env:
          - name: LOG_DIR
            value: "/tmp/logs"
          ports:
          - containerPort: 9080
          resources:
            requests:
              cpu: 0.02
              memory: 10Mi
          volumeMounts:
          - name: tmp
            mountPath: /tmp
          - name: wlp-output
            mountPath: /opt/ibm/wlp/output
          securityContext:
            runAsUser: 1000
        volumes:
        - name: wlp-output
          emptyDir: {}
        - name: tmp
          emptyDir: {}
  analyses:
  - name: compare
    requiredForCompletion: true
    templateName: success-rate
    args:
    - name: service-name
      value: reviews.istio.svc.cluster.local  
```

release/canary/argo/argo-AnalysisTemplate-reviews.yaml

kubectl apply -f argo-AnalysisTemplate-reviews.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: success-rate
spec:
  args:
  - name: service-name
  metrics:
  - name: success-rate
    interval: 60s
    count: 5
    successCondition: result[0] >= 0.50
    failureLimit: 3
    provider:
      prometheus:
        address: http://prometheus.istio-system:9090
        query: |
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}",response_code!~"5.*"}[5m]
          )) / 
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}"}[5m]
          ))
```



#####  ClusterAnalysisTemplate 

release/canary/argo/argo-ClusterAnalysisTemplate -reviews.yaml

kubectl apply -f argo-ClusterAnalysisTemplate-reviews.yaml -n default

```
apiVersion: argoproj.io/v1alpha1
kind: ClusterAnalysisTemplate
metadata:
  name: success-rate
spec:
  args:
  - name: service-name
  metrics:
  - name: success-rate
    interval: 60s
    count: 5
    successCondition: result[0] >= 0.50
    failureLimit: 3
    provider:
      prometheus:
        address: http://prometheus.istio-system:9090
        query: |
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}",response_code!~"5.*"}[5m]
          )) / 
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}"}[5m]
          ))
```

release/canary/argo/rollout-canary-reviews-ClusterAnalysisTemplate.yaml

kubectl apply -f rollout-canary-reviews-ClusterAnalysisTemplate.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
        stable: stable
        canary: canary
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      trafficRouting:
        istio:
          virtualService:
            name: reviews-vs
            routes:
            - http-primary
          destinationRule:
            name: reviews
            canarySubsetName: v2
            stableSubsetName: v1
      steps:
      - setWeight: 20
      - pause: {}
      - analysis:
          templates:
          - templateName: success-rate
            clusterScope: true
          args:
          - name: service-name
            value: reviews.istio.svc.cluster.local
      - setWeight: 40
      - pause: {duration: 10}
      - setWeight: 60
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
      
```

release/canary/argo/argo-vs-reviews.yaml

kubectl apply -f argo-vs-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-vs
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - "*"
  http:
  - name: http-primary
    route:
    - destination:
        host: reviews
        subset: v1
      weight: 100
    - destination:
        host: reviews
        subset: v2
      weight: 0
```

release/canary/argo/dr-reviews.yaml

kubectl apply -f dr-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews.istio.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
  subsets:
  - name: v1
    labels:
      stable: stable
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
  - name: v2
    labels:
      canary: canary
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN
```





```
go-stress-testing -c 10 -n 1000000 -u http://192.168.229.134:30684/reviews/0

kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio
kubectl argo rollouts get rollout reviews-v1 --watch -n istio


kubectl argo rollouts promote  reviews-v1 -n istio

```



清理：

kubectl delete vs reviews-vs -n istio

kubectl delete rollout reviews-v1 -n istio

kubectl delete  ClusterAnalysisTemplate success-rate -n istio

##### HPA 

release/canary/argo/rollout-canary-istio-HPA.yaml

kubectl apply -f rollout-canary-istio-HPA.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      argo: argo
  template:
    metadata:
      labels:
        app: reviews
        argo: argo
        canary: canary
        stable: stable
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      trafficRouting:
        istio:
          virtualService:
            name: reviews-vs
            routes:
            - http-primary
          destinationRule:
            name: reviews
            canarySubsetName: v2
            stableSubsetName: v1
      steps:
      - setWeight: 20
      - pause: {}
      - setWeight: 80
      - pause: {duration: 10}

```



release/canary/argo/argo-vs-reviews-subset.yaml

kubectl apply -f argo-vs-reviews-subset.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-vs
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - "*"
  http:
  - name: http-primary
    route:
    - destination:
        host: reviews
        subset: v1
      weight: 100
    - destination:
        host: reviews
        subset: v2
      weight: 0
```

release/canary/argo/dr-reviews.yaml

kubectl apply -f dr-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews.istio.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
  subsets:
  - name: v1
    labels:
      stable: stable
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
  - name: v2
    labels:
      canary: canary
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN

```



```
go-stress-testing -c 10 -n 1000000 -u http://192.168.229.134:30684/reviews/0

kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio
kubectl argo rollouts get rollout reviews-v1 --watch -n istio


Name:            reviews-v1
Namespace:       istio
Status:          ✔ Healthy
Strategy:        Canary
  Step:          4/4
  SetWeight:     100
  ActualWeight:  100
Images:          docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (stable)
Replicas:
  Desired:       5
  Current:       5
  Updated:       5
  Ready:         5
  Available:     5

NAME                                    KIND        STATUS        AGE   INFO
⟳ reviews-v1                            Rollout     ✔ Healthy     103m  
├──# revision:4                                                         
│  └──⧉ reviews-v1-77d9dfbb54           ReplicaSet  ✔ Healthy     103m  stable
│     ├──□ reviews-v1-77d9dfbb54-h9svk  Pod         ✔ Running     79s   ready:2/2
│     ├──□ reviews-v1-77d9dfbb54-4xnst  Pod         ✔ Running     45s   ready:2/2
│     ├──□ reviews-v1-77d9dfbb54-r4bl5  Pod         ✔ Running     45s   ready:2/2
│     ├──□ reviews-v1-77d9dfbb54-zdlxl  Pod         ✔ Running     45s   ready:2/2
│     └──□ reviews-v1-77d9dfbb54-sscsl  Pod         ✔ Running     26s   ready:2/2
└──# revision:3                                                         
   └──⧉ reviews-v1-6d5599f745           ReplicaSet  • ScaledDown  103m  

```



#### dashboard

kubectl apply -f dashboard-install.yaml -n argo-rollouts 

kubectl port-forward --address 0.0.0.0 -n argo-rollouts argo-rollouts-dashboard-64784f5cbf-9s928

![rollouts-list](images\rollouts-list.png)



![rollout-ui](images\rollout-ui.png)



#### 命令行

```
[root@node01 ~]# kubectl argo rollouts 
Usage:
  kubectl-argo-rollouts COMMAND [flags]
  kubectl-argo-rollouts [command]

Examples:
  # Get guestbook rollout and watch progress
  kubectl argo rollouts get rollout guestbook -w

  # Pause the guestbook rollout
  kubectl argo rollouts pause guestbook

  # Promote the guestbook rollout
  kubectl argo rollouts promote guestbook

  # Abort the guestbook rollout
  kubectl argo rollouts abort guestbook

  # Retry the guestbook rollout
  kubectl argo rollouts retry guestbook

Available Commands:
  abort       Abort a rollout
  create      Create a Rollout, Experiment, AnalysisTemplate, ClusterAnalysisTemplate, or AnalysisRun resource
  dashboard   Start UI dashboard
  get         Get details about rollouts and experiments
  help        Help about any command
  lint        Lint and validate a Rollout
  list        List rollouts or experiments
  pause       Pause a rollout
  promote     Promote a rollout
  restart     Restart the pods of a rollout
  retry       Retry a rollout or experiment
  set         Update various values on resources
  status      Show the status of a rollout
  terminate   Terminate an AnalysisRun or Experiment
  undo        Undo a rollout
  version     Print version

Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
  -h, --help                           help for kubectl-argo-rollouts
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use

Use "kubectl-argo-rollouts [command] --help" for more information about a command.
```

##### get

```
[root@node01 ~]# kubectl argo rollouts get --help
This command consists of multiple subcommands which can be used to get extended information about a rollout or experiment.

Usage:
  kubectl-argo-rollouts get <rollout|experiment> RESOURCE_NAME [flags]
  kubectl-argo-rollouts get [command]

Examples:
        # Get a rollout
        kubectl argo rollouts get rollout guestbook

        # Watch a rollouts progress
        kubectl argo rollouts get rollout guestbook -w
  
        # Get an experiment
        kubectl argo rollouts get experiment my-experiment

Available Commands:
  experiment  Get details about an Experiment
  rollout     Get details about a rollout

Flags:
  -h, --help   help for get

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use

Use "kubectl-argo-rollouts get [command] --help" for more information about a command.
```

###### experiment

```
[root@node01 ~]# kubectl argo rollouts get experiment
Usage:
  kubectl-argo-rollouts get experiment EXPERIMENT_NAME [flags]

Aliases:
  experiment, exp, experiments

Examples:
        # Get an experiment
        kubectl argo rollouts get experiment my-experiment

        # Watch experiment progress
        kubectl argo rollouts get experiment my-experiment -w

Flags:
  -h, --help       help for experiment
      --no-color   Do not colorize output
  -w, --watch      Watch live updates to the rollout

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use
```

kubectl argo rollouts get experiment reviews-v1 -n istio

kubectl argo rollouts get experiment reviews-v1 -n istio -w

###### rollout

```
[root@node01 ~]# kubectl argo rollouts get rollout --help
Get details about and visual representation of a rollout. It returns a bunch of metadata on a resource and a tree view of the child resources created by the parent.

Tree view icons

| Icon | Kind |
|:----:|:-----------:|
| ⟳ | Rollout |
| Σ | Experiment |
| α | AnalysisRun |
| # | Revision |
| ⧉ | ReplicaSet |
| □ | Pod |
| ⊞ | Job |

Usage:
  kubectl-argo-rollouts get rollout ROLLOUT_NAME [flags]

Aliases:
  rollout, ro, rollouts

Examples:
        # Get a rollout
        kubectl argo rollouts get rollout guestbook

        # Watch progress of a rollout
        kubectl argo rollouts get rollout guestbook -w

Flags:
  -h, --help                  help for rollout
      --no-color              Do not colorize output
      --timeout-seconds int   Timeout after specified seconds
  -w, --watch                 Watch live updates to the rollout

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use
```

kubectl argo rollouts get rollout reviews-v1 -n istio

kubectl argo rollouts get rollout reviews-v1 -n istio -w



##### create

```
[root@node01 ~]# kubectl argo rollouts create --help
This command creates a new Rollout, Experiment, AnalysisTemplate, ClusterAnalysisTemplate, or AnalysisRun resource from a file.

Usage:
  kubectl-argo-rollouts create [flags]
  kubectl-argo-rollouts create [command]

Examples:
        # Create an experiment and watch it
        kubectl argo rollouts create -f my-experiment.yaml -w

Available Commands:
  analysisrun Create an AnalysisRun from an AnalysisTemplate or a ClusterAnalysisTemplate

Flags:
  -f, --filename stringArray   Files to use to create the resource
  -h, --help                   help for create
      --no-color               Do not colorize output
  -w, --watch                  Watch live updates to the resource after creating

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use

Use "kubectl-argo-rollouts create [command] --help" for more information about a command.
```

kubectl argo rollouts create -f rollout-canary-reviews-Experiment.yaml -w

kubectl argo rollouts create -f rollout-canary-reviews-Experiment.yaml 

###### analysisrun

```
root@node01 ~]# kubectl argo rollouts create analysisrun --help
This command creates a new AnalysisRun from an existing AnalysisTemplate resources or from an AnalysisTemplate file.

Usage:
  kubectl-argo-rollouts create analysisrun [flags]

Aliases:
  analysisrun, ar

Examples:
        # Create an AnalysisRun from a local AnalysisTemplate file
        kubectl argo rollouts create analysisrun --from-file my-analysis-template.yaml
  
        # Create an AnalysisRun from a AnalysisTemplate in the cluster
        kubectl argo rollouts create analysisrun --from my-analysis-template

        # Create an AnalysisRun from a local ClusterAnalysisTemplate file
        kubectl argo rollouts create analysisrun --global --from my-analysis-cluster-template.yaml

        # Create an AnalysisRun from a ClusterAnalysisTemplate in the cluster
        kubectl argo rollouts create analysisrun --global --from my-analysis-cluster-template

Flags:
  -a, --argument stringArray   Arguments to the parameter template
      --from string            Create an AnalysisRun from an AnalysisTemplate or ClusterAnalysisTemplate in the cluster
      --from-file string       Create an AnalysisRun from an AnalysisTemplate or ClusterAnalysisTemplate in a local file
      --generate-name string   Use the specified generateName for the run
      --global                 Use a ClusterAnalysisTemplate instead of a AnalysisTemplate
  -h, --help                   help for analysisrun
      --instance-id string     Instance-ID for the AnalysisRun
      --name string            Use the specified name for the run

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use
```



##### set

```
[root@node01 ~]# kubectl argo rollouts set
Usage:
  kubectl-argo-rollouts set COMMAND [flags]
  kubectl-argo-rollouts set [command]

Examples:
  # Set rollout image
  kubectl argo rollouts set image my-rollout argoproj/rollouts-demo:yellow

Available Commands:
  image       Update the image of a rollout

Flags:
  -h, --help   help for set

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use

Use "kubectl-argo-rollouts set [command] --help" for more information about a command.
```

###### image

```
[root@node01 ~]# kubectl argo rollouts set image --help
Update the image of a rollout

Usage:
  kubectl-argo-rollouts set image ROLLOUT_NAME CONTAINER=IMAGE [flags]

Examples:
  # Set rollout image
  kubectl argo rollouts set image my-rollout www=image:v2

Flags:
  -h, --help   help for image

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use
```

 kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

##### abort

```
[root@node01 ~]# kubectl argo rollouts  abort
Usage:
  kubectl-argo-rollouts abort ROLLOUT_NAME [flags]

Examples:
  # Abort a rollout
  kubectl argo rollouts abort guestbook

Flags:
  -h, --help   help for abort

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use
```

kubectl argo rollouts abort reviews-v1 -n istio

##### list

```
[root@node01 ~]# kubectl argo rollouts  list --help
This command consists of multiple subcommands which can be used to lists all of the 
rollouts or experiments for a specified namespace (uses current namespace context if namespace not specified).

Usage:
  kubectl-argo-rollouts list <rollout|experiment> [flags]
  kubectl-argo-rollouts list [command]

Examples:
        # List rollouts
        kubectl argo rollouts list rollouts

        # List experiments
        kubectl argo rollouts list experiments

Available Commands:
  experiments List experiments
  rollouts    List rollouts

Flags:
  -h, --help   help for list

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use

Use "kubectl-argo-rollouts list [command] --help" for more information about a command.
```

###### experiments

```
[root@node01 ~]# kubectl argo rollouts  list experiment --help
This command lists all of the experiments for a specified namespace (uses current namespace context if namespace not specified).

Usage:
  kubectl-argo-rollouts list experiments [flags]

Aliases:
  experiments, exp, experiment

Examples:
        # List rollouts
        kubectl argo rollouts list experiments
  
        # List rollouts from all namespaces
        kubectl argo rollouts list experiments --all-namespaces
  
        # List rollouts and watch for changes
        kubectl argo rollouts list experiments --watch

Flags:
      --all-namespaces   Include all namespaces
  -h, --help             help for experiments

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use
```

kubectl argo rollouts list experiments -n istio

kubectl argo rollouts list experiments --all-namespaces

###### rollouts

```
[root@node01 ~]# kubectl argo rollouts  list rollouts --help
This command lists all of the rollouts for a specified namespace (uses current namespace context if namespace not specified).

Usage:
  kubectl-argo-rollouts list rollouts [flags]

Aliases:
  rollouts, ro, rollout

Examples:
        # List rollouts
        kubectl argo rollouts list rollouts
  
        # List rollouts from all namespaces
        kubectl argo rollouts list rollouts --all-namespaces
  
        # List rollouts and watch for changes
        kubectl argo rollouts list rollouts --watch

Flags:
  -A, --all-namespaces   Include all namespaces
  -h, --help             help for rollouts
      --name string      Only show rollout with specified name
      --timestamps       Print timestamps on updates
  -w, --watch            Watch for changes

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use
```

kubectl argo rollouts list rollouts -n istio

kubectl argo rollouts list rollouts --all-namespaces

kubectl argo rollouts list rollouts --watch -n istio

kubectl argo rollouts list rollouts -n istio  --name reviews-v1

kubectl argo rollouts list rollouts -n istio --timestamps  

##### lint

```
[root@node01 ~]# kubectl argo rollouts lint
Usage:
  kubectl-argo-rollouts lint [flags]

Examples:
        # Lint a rollout
        kubectl argo rollouts lint -f my-rollout.yaml

Flags:
  -f, --filename string   File to lint
  -h, --help              help for lint

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use
```

kubectl argo rollouts lint -f rollout-canary-steps.yaml

##### pause

```
[root@node01 ~]# kubectl argo rollouts pause
Usage:
  kubectl-argo-rollouts pause ROLLOUT_NAME [flags]

Examples:
  # Pause a rollout
  kubectl argo rollouts pause guestbook

Flags:
  -h, --help   help for pause

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use
```

kubectl argo rollouts pause reviews-v1 -n istio

##### promote

```
[root@node01 ~]# kubectl argo rollouts promote
Usage:
  kubectl-argo-rollouts promote ROLLOUT_NAME [flags]

Examples:
        # Promote a paused rollout
        kubectl argo rollouts promote guestbook

        # Fully promote a rollout to desired version, skipping analysis, pauses, and steps
        kubectl argo rollouts promote guestbook --full

Flags:
      --full   Perform a full promotion, skipping analysis, pauses, and steps
  -h, --help   help for promote

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use
```

kubectl argo rollouts promote reviews-v1 -n istio

kubectl argo rollouts promote reviews-v1 -n istio --full

##### restart

```
[root@node01 ~]# kubectl argo rollouts restart
Usage:
  kubectl-argo-rollouts restart ROLLOUT [flags]

Examples:
        # Restart the pods of a rollout in now
        kubectl argo rollouts restart ROLLOUT_NAME

        # Restart the pods of a rollout in ten seconds
        kubectl argo rollouts restart ROLLOUT_NAME --in 10s

Flags:
  -h, --help        help for restart
  -i, --in string   Amount of time before a restart. (e.g. 30s, 5m, 1h)

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use
```

kubectl argo rollouts restart  reviews-v1 -n istio

kubectl argo rollouts restart  reviews-v1 -n istio --in 60s

##### retry

```
[root@node01 ~]# kubectl argo rollouts retry
Usage:
  kubectl-argo-rollouts retry <rollout|experiment> RESOURCE_NAME [flags]
  kubectl-argo-rollouts retry [command]

Examples:
        # Retry an aborted rollout
        kubectl argo rollouts retry rollout guestbook

        # Retry a failed experiment
        kubectl argo rollouts retry experiment my-experiment

Available Commands:
  experiment  Retry an experiment
  rollout     Retry an aborted rollout

Flags:
  -h, --help   help for retry

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use

Use "kubectl-argo-rollouts retry [command] --help" for more information about a command.
```

experiment

```
[root@node01 ~]# kubectl argo rollouts retry experiment --help
Retry a failed experiment.

Usage:
  kubectl-argo-rollouts retry experiment EXPERIMENT_NAME [flags]

Aliases:
  experiment, exp, experiments

Examples:
        # Retry an experiment
        kubectl argo rollouts retry experiment my-experiment

Flags:
  -h, --help   help for experiment

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use
```

kubectl argo rollouts retry experiment  reviews-v1 -n istio

rollout

```
[root@node01 ~]# kubectl argo rollouts retry rollout
Usage:
  kubectl-argo-rollouts retry rollout ROLLOUT_NAME [flags]

Aliases:
  rollout, ro, rollouts

Examples:
        # Retry an aborted rollout
        kubectl argo rollouts retry rollout guestbook

Flags:
  -h, --help   help for rollout

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use
```

kubectl argo rollouts retry rollout reviews-v1 -n istio

##### status

```
[root@node01 ~]# kubectl argo rollouts status
Usage:
  kubectl-argo-rollouts status ROLLOUT_NAME [flags]

Examples:
        # Watch the rollout until it succeeds
        kubectl argo rollouts status guestbook

        # Watch the rollout until it succeeds, fail if it takes more than 60 seconds
        kubectl argo rollouts status --timeout 60s guestbook


Flags:
  -h, --help               help for status
  -t, --timeout duration   The length of time to watch before giving up. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). Zero means wait forever
  -w, --watch              Watch the status of the rollout until it's done (default true)

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use
```

kubectl argo rollouts status reviews-v1 -n istio

kubectl argo rollouts status reviews-v1 -n istio --watch

kubectl argo rollouts status reviews-v1 -n istio --timeout 60s

##### terminate

```
[root@node01 ~]# kubectl argo rollouts terminate
Usage:
  kubectl-argo-rollouts terminate <analysisrun|experiment> RESOURCE_NAME [flags]
  kubectl-argo-rollouts terminate [command]

Examples:
        # Terminate an analysisRun
        kubectl argo rollouts terminate analysisrun guestbook-877894d5b-4-success-rate.1

        # Terminate a failed experiment
        kubectl argo rollouts terminate experiment my-experiment

Available Commands:
  analysisrun Terminate an AnalysisRun
  experiment  Terminate an experiment

Flags:
  -h, --help   help for terminate

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use

Use "kubectl-argo-rollouts terminate [command] --help" for more information about a command.
```

###### analysisrun

```
[root@node01 ~]# kubectl argo rollouts terminate analysisrun
Usage:
  kubectl-argo-rollouts terminate analysisrun ANALYSISRUN_NAME [flags]

Aliases:
  analysisrun, ar, analysisruns

Examples:
        # Terminate an AnalysisRun
        kubectl argo rollouts terminate analysisrun guestbook-877894d5b-4-success-rate.1

Flags:
  -h, --help   help for analysisrun

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use
```

kubectl argo rollouts terminate analysisrun reviews-v1-877894d5b-4-success-rate.1 -n istio

###### experiment

```
[root@node01 ~]# kubectl argo rollouts terminate experiment
Usage:
  kubectl-argo-rollouts terminate experiment EXPERIMENT_NAME [flags]

Aliases:
  experiment, exp, experiments

Examples:
        # Terminate an experiment
        kubectl argo rollouts terminate experiment my-experiment

Flags:
  -h, --help   help for experiment

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use
```

kubectl argo rollouts terminate experiment reviews-v1 -n istio

##### undo

```
[root@node01 ~]# kubectl argo rollouts undo
Usage:
  kubectl-argo-rollouts undo ROLLOUT_NAME [flags]

Examples:
        # Undo a rollout
        kubectl argo rollouts undo guestbook

        # Undo a rollout revision 3
        kubectl argo rollouts undo guestbook --to-revision=3

Flags:
  -h, --help              help for undo
      --to-revision int   The revision to rollback to. Default to 0 (last revision).

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use
```

kubectl argo rollouts undo  reviews-v1 -n istio

kubectl argo rollouts undo reviews-v1 -n istio --to-revision=3

##### version

```
[root@node01 ~]# kubectl argo rollouts version --help
Show the version and build information of the Argo Rollouts plugin.

Usage:
  kubectl-argo-rollouts version [flags]

Examples:
        # Get full version info
        kubectl argo rollouts version

        # Get just plugin version number
        kubectl argo rollouts version --short

Flags:
  -h, --help    help for version
      --short   print just the version number

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use
```

kubectl argo rollouts version

kubectl argo rollouts version --short

##### dashboard

```
[root@node01 ~]# kubectl argo rollouts dashboard --help
Start UI dashboard

Usage:
  kubectl-argo-rollouts dashboard [flags]

Flags:
  -h, --help   help for dashboard

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use
```

kubectl-argo-rollouts dashboard

```
[root@node01 ~]# kubectl argo rollouts dashboard
INFO[0000] Argo Rollouts Dashboard is now available at localhost 3100 
```



#### 迁移

There are ways to migrate to Rollout:

- Convert an existing Deployment resource to a Rollout resource.
- Reference an existing Deployment from a Rollout using `workloadRef` field.

Convert Deployment to Rollout

When converting a Deployment to a Rollout, it involves changing three fields:

1. Replacing the `apiVersion` from `apps/v1` to `argoproj.io/v1alpha1`
2. Replacing the `kind` from `Deployment` to `Rollout`
3. Replacing the deployment strategy with a [blue-green](https://argoproj.github.io/argo-rollouts/features/bluegreen/) or [canary](https://argoproj.github.io/argo-rollouts/features/canary/) strategy

Below is an example of a Rollout resource using the canary strategy.

# 蓝绿发布

##  **什么是蓝绿**发布

蓝绿发布是指，同一个系统有两套部署，其中绿部署代表对外提供服务的应用， 蓝部署代表备用部署，如果有相关的升级，回退操作，都在蓝部署上执行，确定测试没有问题，可以实现蓝绿转换。
优缺点
优点：
1.可以实现服务不停机
2.保留老版本，随时可以回退
3.所有的流量都走当前版本
弱点：
使用蓝绿部署需要注意的一些细节包括：
1、当切换到蓝色环境时，需要妥当处理未完成的业务和新的业务。可能引起服务宕机
2、需要提前考虑数据库与应用部署同步迁移/回滚的问题。
3、蓝绿部署需要有基础设施支持。
4、在非隔离基础架构（ VM 、 Docker 等）上执行蓝绿部署，蓝色环境和绿色环境有被摧毁的风险。
5、另外，这种方式不好的地方还在于冗余产生的额外维护、配置的成本，以及服务器本身运行的开销。
蓝绿部署适用的场景：
1、不停止老版本，额外搞一套新版本，等测试发现新版本OK后，删除老版本。
2、蓝绿发布是一种用于升级与更新的发布策略，部署的最小维度是容器，而发布的最小维度是应用。
3、蓝绿发布对于增量升级有比较好的支持，但是对于涉及数据表结构变更等等不可逆转的升级，并不完全合适用蓝绿发布来实现，需要结合一些业务的逻辑以及数据迁移与回滚的策略才可以完全满足需求。

## 过程

1. 线上原版本为v1。
2. 部署新版本v2，线上同时存在两个版本（蓝和绿版本）。
3. 切换50%路由到v2。
4. 验证通过后，切换100%路由到v2。如果验证失败，切换100%路由回v1（回滚）。

![flagger-bluegreen-steps](images\flagger-bluegreen-steps.png)





## 案例

### 手工实现



### flagger

blue-green-reviews.yaml

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  provider: istio
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  # the maximum time in seconds for the canary deployment
  # to make progress before rollback (default 600s)
  progressDeadlineSeconds: 60
  service:
    port: 9080
    name: reviews
    portDiscovery: true
  analysis:
    # schedule interval (default 60s)
    interval: 30s
    threshold: 2
    iterations: 10
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        # maximum req duration P99
        # milliseconds
        thresholdRange:
          max: 500
        interval: 30s
    # acceptance/load testing hooks
    webhooks:
      - name: smoke-test
        type: pre-rollout
        url: http://flagger-loadtester.test/
        timeout: 15s
        metadata:
          type: bash
          cmd: "curl -sd 'anon' http://reviews-canary.istio:9080/reviews/0 "
      - name: load-test
        url: http://flagger-loadtester.istio/
        timeout: 5s
        metadata:
          type: cmd
          cmd: "hey -z 1m -q 10 -c 2 http://reviews-canary.istio:9080/reviews/0"
```

过程

```
Blue/Green scenario:
on bootstrap, Flagger will create three ClusterIP services (app-primary,app-canary, app)
and a shadow deployment named app-primary that represents the blue version
when a new version is detected, Flagger would scale up the green version and run the conformance tests
(the tests should target the app-canary ClusterIP service to reach the green version)
if the conformance tests are passing, Flagger would start the load tests and validate them with custom Prometheus queries
if the load test analysis is successful, Flagger will promote the new version to app-primary and scale down the green version
```



### argo-rollout

![argo-blue-green-deployments](images\argo-blue-green-deployments.png)

The following describes the sequence of events that happen during a blue-green update.

1. Beginning at a fully promoted, steady-state, a revision 1 ReplicaSet is pointed to by both the `activeService` and `previewService`.
2. A user initiates an update by modifying the pod template (`spec.template.spec`).
3. The revision 2 ReplicaSet is created with size 0.
4. The preview service is modified to point to the revision 2 ReplicaSet. The `activeService` remains pointing to revision 1.
5. The revision 2 ReplicaSet is scaled to either `spec.replicas` or `previewReplicaCount` if set.
6. Once revision 2 ReplicaSet Pods are fully available, `prePromotionAnalysis` begins.
7. Upon success of `prePromotionAnalysis`, the blue/green pauses if `autoPromotionEnabled` is false, or `autoPromotionSeconds` is non-zero.
8. The rollout is resumed either manually by a user, or automatically by surpassing `autoPromotionSeconds`.
9. The revision 2 ReplicaSet is scaled to the `spec.replicas`, if the `previewReplicaCount` feature was used.
10. The rollout "promotes" the revision 2 ReplicaSet by updating the `activeService` to point to it. At this point, there are no services pointing to revision 1
11. `postPromotionAnalysis` analysis begins
12. Once `postPromotionAnalysis` completes successfully, the update is successful and the revision 2 ReplicaSet is marked as stable. The rollout is considered fully-promoted.
13. After waiting `scaleDownDelaySeconds` (default 30 seconds), the revision 1 ReplicaSet is scaled down



**autoPromotionEnabled**

The AutoPromotionEnabled will make the rollout automatically promote the new ReplicaSet to the active service once the new ReplicaSet is healthy. This field is defaulted to true if it is not specified.

Defaults to true

**autoPromotionSeconds**

The AutoPromotionSeconds will make the rollout automatically promote the new ReplicaSet to active Service after the AutoPromotionSeconds time has passed since the rollout has entered a paused state. If the `AutoPromotionEnabled` field is set to true, this field will be ignored

Defaults to nil

**antiAffinity**

Check out the [Anti Affinity document](https://argoproj.github.io/argo-rollouts/features/anti-affinity/anti-affinity/) document for more information.

Defaults to nil

*maxUnavailable*

The maximum number of pods that can be unavailable during the update. Value can be an absolute number (ex: 5) or a percentage of desired pods (ex: 10%). This can not be 0 if MaxSurge is 0.

Defaults to 0

**prePromotionAnalysis**

Configures the [Analysis](https://argoproj.github.io/argo-rollouts/features/analysis/#bluegreen-pre-promotion-analysis) before it switches traffic to the new version. The AnalysisRun can be used to block the Service selector switch until the AnalysisRun finishes successful. The success or failure of the analysis run decides if the Rollout will switch traffic, or abort the Rollout completely.

Defaults to nil

**postPromotionAnalysis**

Configures the [Analysis](https://argoproj.github.io/argo-rollouts/features/analysis/#bluegreen-pre-promotion-analysis) after the traffic switch to new version. If the analysis run fails or errors out, the Rollout enters an aborted state and switch traffic back to the previous stable Replicaset. If `scaleDownDelaySeconds` is specified, the controller will cancel any AnalysisRuns at time of `scaleDownDelay` to scale down the ReplicaSet. If it is omitted, and post analysis is specified, it will scale down the ReplicaSet only after the AnalysisRun completes (with a minimum of 30 seconds).

Defaults to nil

**previewService**

The PreviewService field references a Service that will be modified to send traffic to the new ReplicaSet before the new one is promoted to receiving traffic from the active service. Once the new ReplicaSet starts receiving traffic from the active service, the preview service will also be modified to send traffic to the new ReplicaSet as well. The Rollout always makes sure that the preview service is sending traffic to the newest ReplicaSet. As a result, if a new version is introduced before the old version is promoted to the active service, the controller will immediately switch over to that brand new version.

This feature is used to provide an endpoint that can be used to test a new version of an application.

Defaults to an empty string

**previewReplicaCount**

The PreviewReplicaCount field will indicate the number of replicas that the new version of an application should run. Once the application is ready to promote to the active service, the controller will scale the new ReplicaSet to the value of the `spec.replicas`. The rollout will not switch over the active service to the new ReplicaSet until it matches the `spec.replicas` count.

This feature is mainly used to save resources during the testing phase. If the application does not need a fully scaled up application for the tests, this feature can help save some resources.

If omitted, the preview ReplicaSet stack will be scaled to 100% of the replicas.

**scaleDownDelaySeconds**

The ScaleDownDelaySeconds is used to delay scaling down the old ReplicaSet after the active Service is switched to the new ReplicaSet.

Defaults to 30

**scaleDownDelayRevisionLimit**

The ScaleDownDelayRevisionLimit limits the number of old active ReplicaSets to keep scaled up while they wait for the scaleDownDelay to pass after being removed from the active service.

If omitted, all ReplicaSets will be retained for the specified scaleDownDelay





```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    blueGreen: 
      activeService: rollout-bluegreen-active
      previewService: rollout-bluegreen-preview
      autoPromotionEnabled: false
```



```
spec:
  strategy:
    blueGreen:
      autoPromotionEnabled: boolean
      autoPromotionSeconds: *int32
      antiAffinity:
        requiredDuringSchedulingIgnoredDuringExecution: {}
        preferredDuringSchedulingIgnoredDuringExecution:
          weight: 1 # Between 1 - 100
      previewService: string
      prePromotionAnalysis:
        templates:
        - templateName: success-rate
        args:
        - name: service-name
          value: guestbook-svc.default.svc.cluster.local
      postPromotionAnalysis:
        templates:
        - templateName: success-rate
        args:
        - name: service-name
          value: guestbook-svc.default.svc.cluster.local
      previewReplicaCount: *int32
      scaleDownDelaySeconds: *int32
      scaleDownDelayRevisionLimit: *int32
```



activeService,previewService

release/blueGreen/argo-rollout/bg-reviews-activeService-previewService.yaml

kubectl apply -f bg-reviews-activeService-previewService.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
  template:
    metadata:
      labels:
        app: reviews
        blue: blue
        green: green
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    blueGreen: 
      activeService: rollout-bluegreen-active
      previewService: rollout-bluegreen-preview
```

svc-rollout-bluegreen-active.yaml

kubectl apply -f svc-rollout-bluegreen-active.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: rollout-bluegreen-active
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    green: green
```

svc-rollout-bluegreen-preview.yaml

kubectl apply -f svc-rollout-bluegreen-preview.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: rollout-bluegreen-preview
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    blue: blue
```

activeMetadata,previewMetadata



previewReplicaCount



maxUnavailable



autoPromotionEnabled,autoPromotionSeconds



antiAffinity



scaleDownDelayRevisionLimit



scaleDownDelaySeconds



prePromotionAnalysis



postPromotionAnalysis



HPA 



# A/B test

## 什么是A/B test

AB Test 实验一般有 2 个目的：

1. 判断哪个更好：例如，有 2 个 UI 设计，究竟是 A 更好一些，还是 B 更好一些，我们需要实验判定
2. 计算收益：例如，最近新上线了一个直播功能，那么直播功能究竟给平台带了来多少额外的 DAU，多少额外的使用时长，多少直播以外的视频观看时长等

我们一般比较熟知的是上述第 1 个目的，对于第 2 个目的，**对于收益的量化，计算 ROI，往往对数据分析师和管理者非常重要**。

对于一般的 ABTest 实验，其实本质上就是把平台的流量均匀分为几个组，每个组添加不同的策略，然后根据这几个组的用户数据指标，例如：留存、人均观看时长、基础互动率等等核心指标，最终选择一个最好的组上线。

实验的几个基本步骤一般如下：

![1630278084(1)](images\1630278084(1).jpg)

**流量分配**

实验设计时有两个目标：

- 希望尽快得到实验结论，尽快决策
- 希望收益最大化，用户体验影响最小

因此经常需要在流量分配时有所权衡，一般有以下几个情况：

- 不影响用户体验：如 UI 实验、文案类实验等，一般可以均匀分配流量实验，可以快速得到实验结论
- 不确定性较强的实验：如产品新功能上线，一般需小流量实验，尽量减小用户体验影响，在允许的时间内得到结论
- 希望收益最大化的实验：如运营活动等，尽可能将效果最大化，一般需要大流量实验，留出小部分对照组用于评估 ROI

![111](images\111.jpg)

根据实验的预期结果，大盘用户量，确定实验所需最小流量，可以通过一个**网站**专门计算所需样本量：

- 以次日留存率为例，目前大盘次日留存率 80%，预期实验能够提升 0.2pp
  （这里的留存率可以转换为点击率、渗透率等等，只要是比例值就可以，**如果估不准，为了保证实验能够得到结果，此处可低估，不可高估，也就是 0.2pp 是预期能够提升地最小值**）
- 网站计算，最少样本量就是 63W
  （**这里的最少样本量，指的是最少流量实验组的样本量**）
- 如果我们每天只有 5W 的用户可用于实验（5W 的用户，指最少流量实验组是 5W 用户），63/ 5 = 13 天，我们需要至少 13 天才能够得到实验结论

## 过程

![flagger-abtest-steps](images\flagger-abtest-steps.png)



 **SLO(服务等级目标)**指定了服务所提供功能的一种期望状态 

什么是 SLI、SLO和SLA

https://www.cnblogs.com/itcomputer/p/7138655.html

## 案例

### Flagger

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: podinfo
  namespace: test
spec:
  # deployment reference
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: podinfo
  # the maximum time in seconds for the canary deployment
  # to make progress before it is rollback (default 600s)
  progressDeadlineSeconds: 60
  # HPA reference (optional)
  autoscalerRef:
    apiVersion: autoscaling/v2beta2
    kind: HorizontalPodAutoscaler
    name: podinfo
  service:
    # container port
    port: 9898
    # Istio gateways (optional)
    gateways:
    - public-gateway.istio-system.svc.cluster.local
    # Istio virtual service host names (optional)
    hosts:
    - app.example.com
    # Istio traffic policy (optional)
    trafficPolicy:
      tls:
        # use ISTIO_MUTUAL when mTLS is enabled
        mode: DISABLE
  analysis:
    # schedule interval (default 60s)
    interval: 1m
    # total number of iterations
    iterations: 10
    # max number of failed iterations before rollback
    threshold: 2
    # canary match condition
    match:
      - headers:
          user-agent:
            regex: ".*Firefox.*"
      - headers:
          cookie:
            regex: "^(.*?;)?(type=insider)(;.*)?$"
    metrics:
    - name: request-success-rate
      # minimum req success rate (non 5xx responses)
      # percentage (0-100)
      thresholdRange:
        min: 99
      interval: 1m
    - name: request-duration
      # maximum req duration P99
      # milliseconds
      thresholdRange:
        max: 500
      interval: 30s
    # generate traffic during analysis
    webhooks:
      - name: load-test
        url: http://flagger-loadtester.test/
        timeout: 15s
        metadata:
          cmd: "hey -z 1m -q 10 -c 2 -H 'Cookie: type=insider' http://podinfo.test:9898/"
```

