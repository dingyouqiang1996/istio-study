# 1什么是rocketmq_proxy

rocketmq_proxy是envoy集成rocketmq的一个network filter。主要作用就是控制rocketmq的路由。

## 1.1rocketmq架构

![2](44rocketmq\2.png)

如上图所示， RocketMQ的部署结构有以下特点：

- Name Server是一个几乎无状态节点，可集群部署，节点之间无任何信息同步。
- Broker部署相对复杂，Broker分为Master与Slave，一个Master可以对应多个Slave，但是一个Slave只能对应一个Master，Master与Slave的对应关系通过指定相同的BrokerName，不同的BrokerId来定义，BrokerId为0表示Master，非0表示Slave。Master也可以部署多个。每个Broker与Name Server集群中的所有节点建立长连接，定时注册Topic信息到所有Name Server。
- Producer与Name Server集群中的其中一个节点（随机选择）建立长连接，定期从Name Server取Topic路由信息，并向提供Topic服务的Master建立长连接，且定时向Master发送心跳。Producer完全无状态，可集群部署。
- Consumer与Name Server集群中的其中一个节点（随机选择）建立长连接，定期从Name Server取Topic路由信息，并向提供Topic服务的Master、Slave建立长连接，且定时向Master、Slave发送心跳。Consumer既可以从Master订阅消息，也可以从Slave订阅消息，订阅规则由Broker配置决定。

## 1.2RocketMQ 特点

- 是一个队列模型的消息中间件，具有高性能、高可靠、高实时、分布式特点。
- Producer、Consumer、队列都可以分布式。
- Producer向一些队列轮流发送消息，队列集合称为Topic，Consumer如果做广播消费，则一个consumer实例消费这个Topic对应的所有队列，如果做集群消费，则多个Consumer实例平均消费这个topic对应的队列集合。
- 能够保证严格的消息顺序
- 提供丰富的消息拉取模式
- 高效的订阅者水平扩展能力
- 实时的消息订阅机制
- 亿级消息堆积能力
- 较少的依赖

# 2配置

```
{
  "stat_prefix": "...",stat前缀
  "route_config": "{...}",路由配置
  "transient_object_life_span": "{...}",瞬时对象生存时间
  "develop_mode": "..."是否启用开发模式
}
```

route_config：

```
{
  "name": "...",名称
  "routes": []路由配置
}
```

routes：

```
{
  "match": "{...}",匹配条件
  "route": "{...}"路由
}
```

match：

```
{
  "topic": "{...}",主题匹配
  "headers": []头匹配
}
```

topic：

```
{
  "exact": "...",精确匹配
  "prefix": "...",前缀匹配
  "suffix": "...",后缀匹配
  "safe_regex": "{...}",正则匹配
  "contains": "...",包含匹配
  "ignore_case": "..."忽略大小写
}
```

headers：

```
{
  "name": "...", 都名称
  "exact_match": "...",精确匹配
  "safe_regex_match": "{...}",正则匹配
  "range_match": "{...}",范围匹配
  "present_match": "...",存在匹配
  "prefix_match": "...",前缀匹配
  "suffix_match": "...",后缀匹配
  "contains_match": "...",包含匹配
  "string_match": "{...}",字符串匹配
  "invert_match": "..."反向匹配
}
```

route：

```
{
  "cluster": "...",集群
  "metadata_match": "{...}"元数据匹配
}
```

metadata_match：

```
{
  "filter_metadata": "{...}",
  "typed_filter_metadata": "{...}"
}
```

# 3实战

## 3.1准备工作

### 3.1.1部署rocketmq

kubectl label ns default istio-injection=enabled

部署rocketmq

```
git clone https://github.com/apache/rocketmq-operator.git
cd rocketmq-operator

./install-operator.sh 

kubectl apply -f example/rocketmq_v1alpha1_rocketmq_cluster.yaml 
```

broker size改为2个方便测试

rocketmq_v1alpha1_rocketmq_cluster.yaml 

```
apiVersion: v1
kind: ConfigMap
metadata:
  name: broker-config
data:
  # BROKER_MEM sets the broker JVM, if set to "" then Xms = Xmx = max(min(1/2 ram, 1024MB), min(1/4 ram, 8GB))
  BROKER_MEM: " -Xms2g -Xmx2g -Xmn1g "
  broker-common.conf: |
    # brokerClusterName, brokerName, brokerId are automatically generated by the operator and do not set it manually!!!
    deleteWhen=04
    fileReservedTime=48
    flushDiskType=ASYNC_FLUSH
    # set brokerRole to ASYNC_MASTER or SYNC_MASTER. DO NOT set to SLAVE because the replica instance will automatically be set!!!
    brokerRole=ASYNC_MASTER

---
apiVersion: rocketmq.apache.org/v1alpha1
kind: Broker
metadata:
  # name of broker cluster
  name: broker
spec:
  # size is the number of the broker cluster, each broker cluster contains a master broker and [replicaPerGroup] replica brokers.
  size: 2
  # nameServers is the [ip:port] list of name service
  nameServers: ""
  # replicaPerGroup is the number of each broker cluster
  replicaPerGroup: 1
  # brokerImage is the customized docker image repo of the RocketMQ broker
  brokerImage: apacherocketmq/rocketmq-broker:4.5.0-alpine-operator-0.3.0
  # imagePullPolicy is the image pull policy
  imagePullPolicy: Always
  # resources describes the compute resource requirements and limits
  resources:
    requests:
      memory: "2048Mi"
      cpu: "250m"
    limits:
      memory: "12288Mi"
      cpu: "500m"
  # allowRestart defines whether allow pod restart
  allowRestart: true
  # storageMode can be EmptyDir, HostPath, StorageClass
  storageMode: EmptyDir
  # hostPath is the local path to store data
  hostPath: /data/rocketmq/broker
  # scalePodName is [Broker name]-[broker group number]-master-0
  scalePodName: broker-0-master-0
  # env defines custom env, e.g. BROKER_MEM
  env:
    - name: BROKER_MEM
      valueFrom:
        configMapKeyRef:
          name: broker-config
          key: BROKER_MEM
  # volumes defines the broker.conf
  volumes:
    - name: broker-config
      configMap:
        name: broker-config
        items:
          - key: broker-common.conf
            path: broker-common.conf
  # volumeClaimTemplates defines the storageClass
  volumeClaimTemplates:
    - metadata:
        name: broker-storage
      spec:
        accessModes:
          - ReadWriteOnce
        storageClassName: rocketmq-storage
        resources:
          requests:
            storage: 8Gi
---
apiVersion: rocketmq.apache.org/v1alpha1
kind: NameService
metadata:
  name: name-service
spec:
  # size is the the name service instance number of the name service cluster
  size: 1
  # nameServiceImage is the customized docker image repo of the RocketMQ name service
  nameServiceImage: apacherocketmq/rocketmq-nameserver:4.5.0-alpine-operator-0.3.0
  # imagePullPolicy is the image pull policy
  imagePullPolicy: Always
  # hostNetwork can be true or false
  hostNetwork: true
  #  Set DNS policy for the pod.
  #  Defaults to "ClusterFirst".
  #  Valid values are 'ClusterFirstWithHostNet', 'ClusterFirst', 'Default' or 'None'.
  #  DNS parameters given in DNSConfig will be merged with the policy selected with DNSPolicy.
  #  To have DNS options set along with hostNetwork, you have to specify DNS policy
  #  explicitly to 'ClusterFirstWithHostNet'.
  dnsPolicy: ClusterFirstWithHostNet
  # resources describes the compute resource requirements and limits
  resources:
    requests:
      memory: "512Mi"
      cpu: "250m"
    limits:
      memory: "1024Mi"
      cpu: "500m"
  # storageMode can be EmptyDir, HostPath, StorageClass
  storageMode: EmptyDir
  # hostPath is the local path to store data
  hostPath: /data/rocketmq/nameserver
  # volumeClaimTemplates defines the storageClass
  volumeClaimTemplates:
    - metadata:
        name: namesrv-storage
      spec:
        accessModes:
          - ReadWriteOnce
        storageClassName: rocketmq-storage
        resources:
          requests:
            storage: 1Gi

---
apiVersion: rocketmq.apache.org/v1alpha1
kind: Console
metadata:
  name: console
spec:
  # nameServers is the [ip:port] list of name service
  nameServers: ""
  # consoleDeployment define the console deployment
  consoleDeployment:
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      labels:
        app: rocketmq-console
    spec:
      replicas: 1
      selector:
        matchLabels:
          app: rocketmq-console
      template:
        metadata:
          labels:
            app: rocketmq-console
        spec:
          containers:
            - name: console
              image: apacherocketmq/rocketmq-console:2.0.0
              ports:
                - containerPort: 8080
```



参考网址

https://github.com/apache/rocketmq-operator



创建service

svc-rocketmq.yaml

kubectl apply -f svc-rocketmq.yaml 

```
---
apiVersion: v1
kind: Service
metadata:
  name: name-service
spec:
  selector:
    app: name_service
  ports:
    - name: tcp-name
      protocol: TCP
      port: 9876
      targetPort: 9876
---

apiVersion: v1
kind: Service
metadata:
  name: broker-0
spec:
  selector:
    app: broker
    broker_cr: broker
    statefulset.kubernetes.io/pod-name: broker-0-master-0
  ports:
    - name: tcp-vip
      protocol: TCP
      port: 10909
      targetPort: 10909
    - name: tcp-main
      protocol: TCP
      port: 10911
      targetPort: 10911
    - name: tcp-ha
      protocol: TCP
      port: 10912
      targetPort: 10912
---
apiVersion: v1
kind: Service
metadata:
  name: broker-1
spec:
  selector:
    app: broker
    broker_cr: broker
    statefulset.kubernetes.io/pod-name: broker-1-master-0
  ports:
    - name: tcp-vip
      protocol: TCP
      port: 10909
      targetPort: 10909
    - name: tcp-main
      protocol: TCP
      port: 10911
      targetPort: 10911
    - name: tcp-ha
      protocol: TCP
      port: 10912
      targetPort: 10912
---
apiVersion: v1
kind: Service
metadata:
  name: console
spec:
  type: NodePort
  selector:
    app: rocketmq-console
  ports:
    - name: tcp-console
      protocol: TCP
      port: 8080
      targetPort: 8080
```

pod：

![4](44rocketmq\4.jpg)



控制台：

![1](44rocketmq\1.jpg)



发消息

```
 kubectl exec -it broker-0-master-0  bash
 sh ./tools.sh org.apache.rocketmq.example.quickstart.Producer

```

收消息

```
kubectl exec -it broker-0-replica-1-0 bash

sh ./tools.sh org.apache.rocketmq.example.quickstart.Consumer
```



### 3.1.2部署客户端

https://github.com/Shingekino-Kyojin/rocketMQDemo

clone

```
git clone https://github.com/13567436138/rocketmq-demo.git
```

修改配置：

```
cd rocketMQDemo/
cd src/main/resources/
vi application.properties 
namesrvAddr=192.168.229.129:9876

```

部署jdk8，maven：

略

编译：

```
mvn package -DskipTests
```

编译docker镜像

Dockerfile

```
FROM fabric8/java-alpine-openjdk8-jdk

ADD ./demo-0.0.1-SNAPSHOT.jar /

ENTRYPOINT java  -jar  /demo-0.0.1-SNAPSHOT.jar

```

build

```
docker build --tag registry.cn-hangzhou.aliyuncs.com/hxpdocker/rocketmq-demo .
```

push

```
docker push registry.cn-hangzhou.aliyuncs.com/hxpdocker/rocketmq-demo:latest
```

创建pod

rocketmq-client.yaml

```
apiVersion: v1
kind: Pod
metadata:
  name: rocketmq
  labels:
    name: rocketmq
spec:
  containers:
  - name: nginx
    image: registry.cn-hangzhou.aliyuncs.com/hxpdocker/rocketmq-demo:latest
    imagePullPolicy: Always    
```

效果：

![3](44rocketmq\3.jpg)



```
package com.xiaoi.rocketmq.demo.rocketmq;

import org.apache.rocketmq.client.producer.DefaultMQProducer;
import org.apache.rocketmq.client.producer.SendResult;
import org.apache.rocketmq.common.message.MessageConst;
import org.apache.rocketmq.spring.core.RocketMQTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.messaging.Message;
import org.springframework.messaging.support.MessageBuilder;
import org.springframework.stereotype.Component;

import javax.annotation.PostConstruct;
import java.io.UnsupportedEncodingException;

@Component
public class Producer {

    @Autowired
    private RocketMQTemplate rocketMQTemplate;

    @PostConstruct
    public void defaultMQProducer() throws UnsupportedEncodingException {
            for (int i = 0; i < 100; i++) {
                String messageBody = "我是消息内容:" + i;
                String message = new String(messageBody.getBytes(), "utf-8");
                //构建消息

                //Message msg = new Message(topic, tags, "key_" + i /* Keys */, message.getBytes());
                Message<String> msg = MessageBuilder.withPayload(message)
                        .setHeader(MessageConst.PROPERTY_KEYS, "key_" + i )
                        .setHeader("TAGS", "tag")
                        .setHeader(MessageConst.PROPERTY_BUYER_ID,"20191018a")
                        .setHeader(MessageConst.PROPERTY_PRODUCER_GROUP,"group1")
                        .setHeader("MQ", "user_mq")
                        .build();
                //发送消息
                rocketMQTemplate.send("topic1",msg);

            }
    }
}
```

```
package com.xiaoi.rocketmq.demo.rocketmq;
import org.apache.rocketmq.client.consumer.DefaultMQPushConsumer;
import org.apache.rocketmq.client.consumer.listener.ConsumeConcurrentlyContext;
import org.apache.rocketmq.client.consumer.listener.ConsumeConcurrentlyStatus;
import org.apache.rocketmq.client.consumer.listener.MessageListenerConcurrently;
import org.apache.rocketmq.common.consumer.ConsumeFromWhere;
import org.apache.rocketmq.common.message.MessageExt;
import org.apache.rocketmq.common.protocol.heartbeat.MessageModel;
import org.apache.rocketmq.spring.annotation.RocketMQMessageListener;
import org.apache.rocketmq.spring.core.RocketMQListener;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;

import javax.annotation.PostConstruct;
import java.util.List;

@Component
@RocketMQMessageListener(
        topic = "topic1",
        consumerGroup = "group1",
        selectorExpression = "*"
)
public class Consumer implements RocketMQListener<String> {

    @Override
    public void onMessage(String s) {
        try {
            // 睡眠五十毫秒，确保消息成功接收
            Thread.sleep(50);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println("收到消息:"+s);
    }
}
```



## 3.2route_config

### 3.2.1topic

```
{
  "exact": "...",
  "prefix": "...",
  "suffix": "...",
  "safe_regex": "{...}",
  "contains": "...",
  "ignore_case": "..."
}
```

#### 3.2.1.1exact_match

ef-route_config-topic-exact_match.yaml

kubectl apply -f ef-route_config-topic-exact_match.yaml 

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: rocketmq
spec:
  workloadSelector:
    labels:
      name: rocketmq
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        portNumber: 10911
        filterChain:
          filter:
            name: "envoy.filters.network.tcp_proxy"
    patch:
      operation: REPLACE
      value:
            name: envoy.filters.network.rocketmq_proxy
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.rocketmq_proxy.v3.RocketmqProxy
              stat_prefix: rocketmq
              route_config:
                name: rocketmq
                routes:
                - match:
                    topic:
                      exact: topic1
                  route:
                    cluster: outbound|10911||broker-0.default.svc.cluster.local
                - match:
                    topic:
                      exact: topic2
                  route:
                    cluster: outbound|10911||broker-1.default.svc.cluster.local                  
```

Failed to convert protobuf message to JSON string: INTERNAL:Invalid type URL, unknown type: envoy.extensions.filters.network.rocketmq_proxy.v3.RocketmqProxy

https://github.com/istio/istio/issues/38147

#### 3.2.1.2prefix

ef-route_config-topic-prefix.yaml

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: rocketmq
spec:
  workloadSelector:
    labels:
      name: rocketmq
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        portNumber: 10911
        filterChain:
          filter:
            name: "envoy.filters.network.tcp_proxy"
    patch:
      operation: REPLACE
      value:
            name: envoy.filters.network.rocketmq_proxy
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.rocketmq_proxy.v3.RocketmqProxy
              stat_prefix: rocketmq
              route_config:
                name: rocketmq
                routes:
                - match:
                    topic:
                      prefix: topic
                  route:
                    cluster: outbound|10911||broker-0.default.svc.cluster.local
                - match:
                    topic:
                      exact: topic2
                  route:
                    cluster: outbound|10911||broker-1.default.svc.cluster.local
```



#### 3.2.1.3suffix

ef-route_config-topic-suffix.yaml

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: rocketmq
spec:
  workloadSelector:
    labels:
      name: rocketmq
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        portNumber: 10911
        filterChain:
          filter:
            name: "envoy.filters.network.tcp_proxy"
    patch:
      operation: REPLACE
      value:
            name: envoy.filters.network.rocketmq_proxy
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.rocketmq_proxy.v3.RocketmqProxy
              stat_prefix: rocketmq
              route_config:
                name: rocketmq
                routes:
                - match:
                    topic:
                      suffix: "1"
                  route:
                    cluster: outbound|10911||broker-0.default.svc.cluster.local
                - match:
                    topic:
                      exact: topic2
                  route:
                    cluster: outbound|10911||broker-1.default.svc.cluster.local
```



#### 3.2.1.4safe_regex

ef-route_config-topic-safe_regex.yaml

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: rocketmq
spec:
  workloadSelector:
    labels:
      name: rocketmq
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        portNumber: 10911
        filterChain:
          filter:
            name: "envoy.filters.network.tcp_proxy"
    patch:
      operation: REPLACE
      value:
            name: envoy.filters.network.rocketmq_proxy
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.rocketmq_proxy.v3.RocketmqProxy
              stat_prefix: rocketmq
              route_config:
                name: rocketmq
                routes:
                - match:
                    topic:
                      safe_regex:
                        google_re2: {}
                        regex: "^to.*"
                  route:
                    cluster: outbound|10911||broker-0.default.svc.cluster.local
                - match:
                    topic:
                      exact: topic2
                  route:
                    cluster: outbound|10911||broker-1.default.svc.cluster.local
```



#### 3.2.1.5contains

ef-route_config-topic-contains.yaml

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: rocketmq
spec:
  workloadSelector:
    labels:
      name: rocketmq
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        portNumber: 10911
        filterChain:
          filter:
            name: "envoy.filters.network.tcp_proxy"
    patch:
      operation: REPLACE
      value:
            name: envoy.filters.network.rocketmq_proxy
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.rocketmq_proxy.v3.RocketmqProxy
              stat_prefix: rocketmq
              route_config:
                name: rocketmq
                routes:
                - match:
                    topic:
                      contains: topic
                  route:
                    cluster: outbound|10911||broker-0.default.svc.cluster.local
                - match:
                    topic:
                      exact: topic2
                  route:
                    cluster: outbound|10911||broker-1.default.svc.cluster.local
```



#### 3.2.1.6ignore_case

ef-route_config-topic-ignore_case.yaml

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: rocketmq
spec:
  workloadSelector:
    labels:
      name: rocketmq
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        portNumber: 10911
        filterChain:
          filter:
            name: "envoy.filters.network.tcp_proxy"
    patch:
      operation: REPLACE
      value:
            name: envoy.filters.network.rocketmq_proxy
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.rocketmq_proxy.v3.RocketmqProxy
              stat_prefix: rocketmq
              route_config:
                name: rocketmq
                routes:
                - match:
                    topic:
                      contains: Topic
                      ignore_case: true
                  route:
                    cluster: outbound|10911||broker-0.default.svc.cluster.local
                - match:
                    topic:
                      exact: topic2
                  route:
                    cluster: outbound|10911||broker-1.default.svc.cluster.local
```



### 3.2.2headers

```
{
  "name": "...",
  "exact_match": "...",
  "safe_regex_match": "{...}",
  "range_match": "{...}",
  "present_match": "...",
  "prefix_match": "...",
  "suffix_match": "...",
  "contains_match": "...",
  "string_match": "{...}",
  "invert_match": "..."
}
```

#### 3.2.2.1exact_match

ef-route_config-headers-exact_match.yaml

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: rocketmq
spec:
  workloadSelector:
    labels:
      name: rocketmq
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        portNumber: 10911
        filterChain:
          filter:
            name: "envoy.filters.network.tcp_proxy"
    patch:
      operation: REPLACE
      value:
            name: envoy.filters.network.rocketmq_proxy
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.rocketmq_proxy.v3.RocketmqProxy
              stat_prefix: rocketmq
              route_config:
                name: rocketmq
                routes:
                - match:
                    headers:
                    - name: MQ
                      exact_match: user_mq
                  route:
                    cluster: outbound|10911||broker-0.default.svc.cluster.local
                - match:
                    headers:
                    - name: MQ
                      exact_match: user_mq2
                  route:
                    cluster: outbound|10911||broker-1.default.svc.cluster.local
```



#### 3.2.2.2safe_regex_match

ef-route_config-headers-safe_regex_match.yaml

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: rocketmq
spec:
  workloadSelector:
    labels:
      name: rocketmq
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        portNumber: 10911
        filterChain:
          filter:
            name: "envoy.filters.network.tcp_proxy"
    patch:
      operation: REPLACE
      value:
            name: envoy.filters.network.rocketmq_proxy
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.rocketmq_proxy.v3.RocketmqProxy
              stat_prefix: rocketmq
              route_config:
                name: rocketmq
                routes:
                - match:
                    headers:
                    - name: MQ
                      safe_regex_match:
                       google_re2: {}
                       regex: "^user.*"
                  route:
                    cluster: outbound|10911||broker-0.default.svc.cluster.local
                - match:
                    headers:
                    - name: MQ
                      exact_match: user_mq2
                  route:
                    cluster: outbound|10911||broker-1.default.svc.cluster.local
```



#### 3.2.2.3range_match

ef-route_config-headers-range_match.yaml

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: rocketmq
spec:
  workloadSelector:
    labels:
      name: rocketmq
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        portNumber: 10911
        filterChain:
          filter:
            name: "envoy.filters.network.tcp_proxy"
    patch:
      operation: REPLACE
      value:
            name: envoy.filters.network.rocketmq_proxy
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.rocketmq_proxy.v3.RocketmqProxy
              stat_prefix: rocketmq
              route_config:
                name: rocketmq
                routes:
                - match:
                    headers:
                    - name: MQ
                      range_match:
                        start: 1
                        end: 100
                  route:
                    cluster: outbound|10911||broker-0.default.svc.cluster.local
                - match:
                    headers:
                    - name: MQ
                      exact_match: user_mq
                  route:
                    cluster: outbound|10911||broker-1.default.svc.cluster.local
```



#### 3.2.2.4present_match

ef-route_config-headers-present_match.yaml

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: rocketmq
spec:
  workloadSelector:
    labels:
      name: rocketmq
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        portNumber: 10911
        filterChain:
          filter:
            name: "envoy.filters.network.tcp_proxy"
    patch:
      operation: REPLACE
      value:
            name: envoy.filters.network.rocketmq_proxy
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.rocketmq_proxy.v3.RocketmqProxy
              stat_prefix: rocketmq
              route_config:
                name: rocketmq
                routes:
                - match:
                    headers:
                    - name: MQ
                      present_match: true
                  route:
                    cluster: outbound|10911||broker-0.default.svc.cluster.local
                - match:
                    headers:
                    - name: MQ
                      exact_match: user_mq2
                  route:
                    cluster: outbound|10911||broker-1.default.svc.cluster.local
```



#### 3.2.2.5prefix_match

ef-route_config-headers-prefix_match.yaml

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: rocketmq
spec:
  workloadSelector:
    labels:
      name: rocketmq
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        portNumber: 10911
        filterChain:
          filter:
            name: "envoy.filters.network.tcp_proxy"
    patch:
      operation: REPLACE
      value:
            name: envoy.filters.network.rocketmq_proxy
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.rocketmq_proxy.v3.RocketmqProxy
              stat_prefix: rocketmq
              route_config:
                name: rocketmq
                routes:
                - match:
                    headers:
                    - name: MQ
                      prefix_match: user
                  route:
                    cluster: outbound|10911||broker-0.default.svc.cluster.local
                - match:
                    headers:
                    - name: MQ
                      exact_match: user_mq2
                  route:
                    cluster: outbound|10911||broker-1.default.svc.cluster.local
```



#### 3.2.2.6suffix_match

ef-route_config-headers-suffix_match.yaml

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: rocketmq
spec:
  workloadSelector:
    labels:
      name: rocketmq
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        portNumber: 10911
        filterChain:
          filter:
            name: "envoy.filters.network.tcp_proxy"
    patch:
      operation: REPLACE
      value:
            name: envoy.filters.network.rocketmq_proxy
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.rocketmq_proxy.v3.RocketmqProxy
              stat_prefix: rocketmq
              route_config:
                name: rocketmq
                routes:
                - match:
                    headers:
                    - name: MQ
                      suffix_match: mq
                  route:
                    cluster: outbound|10911||broker-0.default.svc.cluster.local
                - match:
                    headers:
                    - name: MQ
                      exact_match: user_mq2
                  route:
                    cluster: outbound|10911||broker-1.default.svc.cluster.local
```



#### 3.2.2.7contains_match

ef-route_config-headers-contains_match.yaml

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: rocketmq
spec:
  workloadSelector:
    labels:
      name: rocketmq
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        portNumber: 10911
        filterChain:
          filter:
            name: "envoy.filters.network.tcp_proxy"
    patch:
      operation: REPLACE
      value:
            name: envoy.filters.network.rocketmq_proxy
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.rocketmq_proxy.v3.RocketmqProxy
              stat_prefix: rocketmq
              route_config:
                name: rocketmq
                routes:
                - match:
                    headers:
                    - name: MQ
                      contains_match: mq
                  route:
                    cluster: outbound|10911||broker-0.default.svc.cluster.local
                - match:
                    headers:
                    - name: MQ
                      exact_match: user_mq2
                  route:
                    cluster: outbound|10911||broker-1.default.svc.cluster.local
```



#### 3.2.2.8string_match

```
{
  "exact": "...",
  "prefix": "...",
  "suffix": "...",
  "safe_regex": "{...}",
  "contains": "...",
  "ignore_case": "..."
}
```

ef-route_config-headers-string_match.yaml

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: rocketmq
spec:
  workloadSelector:
    labels:
      name: rocketmq
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        portNumber: 10911
        filterChain:
          filter:
            name: "envoy.filters.network.tcp_proxy"
    patch:
      operation: REPLACE
      value:
            name: envoy.filters.network.rocketmq_proxy
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.rocketmq_proxy.v3.RocketmqProxy
              stat_prefix: rocketmq
              route_config:
                name: rocketmq
                routes:
                - match:
                    headers:
                    - name: MQ
                      string_match: 
                        suffix: mq
                  route:
                    cluster: outbound|10911||broker-0.default.svc.cluster.local
                - match:
                    headers:
                    - name: MQ
                      exact_match: user_mq2
                  route:
                    cluster: outbound|10911||broker-1.default.svc.cluster.local
```



#### 3.2.2.9invert_match

ef-route_config-headers-invert_match.yaml

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: rocketmq
spec:
  workloadSelector:
    labels:
      name: rocketmq
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        portNumber: 10911
        filterChain:
          filter:
            name: "envoy.filters.network.tcp_proxy"
    patch:
      operation: REPLACE
      value:
            name: envoy.filters.network.rocketmq_proxy
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.rocketmq_proxy.v3.RocketmqProxy
              stat_prefix: rocketmq
              route_config:
                name: rocketmq
                routes:
                - match:
                    headers:
                    - name: MQ 
                      suffix_match: mq
                      invert_match: true
                  route:
                    cluster: outbound|10911||broker-0.default.svc.cluster.local
                - match:
                    headers:
                    - name: MQ
                      exact_match: user_mq
                  route:
                    cluster: outbound|10911||broker-1.default.svc.cluster.local
```



### 3.2.3action

```
{
  "cluster": "...",
  "metadata_match": "{...}"
}
```

#### 3.2.3.1filter_metadata

ef-route_config-action-filter_metadata.yaml

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: rocketmq
spec:
  workloadSelector:
    labels:
      name: rocketmq
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        portNumber: 10911
        filterChain:
          filter:
            name: "envoy.filters.network.tcp_proxy"
    patch:
      operation: REPLACE
      value:
            name: envoy.filters.network.rocketmq_proxy
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.rocketmq_proxy.v3.RocketmqProxy
              stat_prefix: rocketmq
              route_config:
                name: rocketmq
                routes:
                - match:
                    headers:
                    - name: MQ
                      suffix_match: mq
                  route:
                    cluster: cluster123
                    metadata_match:
                      filter_metadata:
                        envoy.lb:
                          env: mark
  - applyTo: CLUSTER
    patch:
      operation: ADD
      value: 
        name: "cluster123"
        type: STRICT_DNS
        connect_timeout: 0.5s
        lb_policy: ROUND_ROBIN
        lb_subset_config:
          fallback_policy: DEFAULT_SUBSET
          default_subset:
            env: "taobao"
          subset_selectors:
          - keys:
            - env
        load_assignment:
          cluster_name: cluster123
          endpoints:
          - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: broker-0.default.svc.cluster.local
                    port_value: 10911
              metadata:
                filter_metadata:
                  envoy.lb:
                    env: hema
            - endpoint:
                address:
                  socket_address:
                    address: broker-1.default.svc.cluster.local
                    port_value: 10911
              metadata:
                filter_metadata:
                  envoy.lb:
                    env: taobao 
```



#### 3.2.3.2typed_filter_metadata

ef-route_config-action-typed_filter_metadata.yaml

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: rocketmq
spec:
  workloadSelector:
    labels:
      name: rocketmq
  configPatches:
  - applyTo: LISTENER
    match:
      context: SIDECAR_OUTBOUND
    patch:
      operation: ADD
      value:
        name: rocketmq
        address:
          socket_address:
            protocol: TCP
            address: 0.0.0.0
            port_value: 10911
        traffic_direction: "OUTBOUND"
        bind_to_port: false
        filter_chains:
        - filters:
          - name: envoy.filters.network.rocketmq_proxy
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.rocketmq_proxy.v3.RocketmqProxy
              stat_prefix: rocketmq
              route_config:
                name: rocketmq
                routes:
                - match:
                    headers:
                    - name: MQ
                      string_match: 
                        suffix: mq
                      invert_match: true
                  route:
                    cluster: outbound|10911||broker-0.default.svc.cluster.local
                    metadata_match:
                      typed_filter_metadata:
                        '@type': ""
                        envoy.lb:
                          canary: true
```

不知道支持的type

## 3.3transient_object_life_span

ef-transient_object_life_span.yaml

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: rocketmq
spec:
  workloadSelector:
    labels:
      name: rocketmq
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        portNumber: 10911
        filterChain:
          filter:
            name: "envoy.filters.network.tcp_proxy"
    patch:
      operation: REPLACE
      value:
            name: envoy.filters.network.rocketmq_proxy
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.rocketmq_proxy.v3.RocketmqProxy
              stat_prefix: rocketmq
              transient_object_life_span: 30s
              route_config:
                name: rocketmq
                routes:
                - match:
                    topic:
                      exact: topic1
                  route:
                    cluster: outbound|10911||broker-0.default.svc.cluster.local
```



## 3.4develop_mode

ef--rocketmq-develop_mode.yaml

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: rocketmq
spec:
  workloadSelector:
    labels:
      name: rocketmq
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        portNumber: 10911
        filterChain:
          filter:
            name: "envoy.filters.network.tcp_proxy"
    patch:
      operation: REPLACE
      value:
            name: envoy.filters.network.rocketmq_proxy
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.rocketmq_proxy.v3.RocketmqProxy
              stat_prefix: rocketmq
              develop_mode: true
              route_config:
                name: rocketmq
                routes:
                - match:
                    topic:
                      exact: topic1
                  route:
                    cluster: outbound|10911||broker-0.default.svc.cluster.local
```

