# 1什么是负载均衡配置

isito负载均衡有三种类型，分别是一致性hash，简单负载均衡，基于位置的负载均衡。istio中负载均衡是通过destinationrule实现的。用envoyfilter实现负载均衡主要是通过修改cluster和路由。

# 2实战

## 2.1consistentHash

### 2.1.1httpCookie

destinationrule实现

```
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: productpage
spec:
  host: productpage
  trafficPolicy:
    loadBalancer:
      consistentHash:         
        httpCookie:
          name: user
          ttl: 0s
```

envoyfilter实现

```
cat << EOF > ef-lb-consistentHash-httpCookie.yaml
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      listener:
        #name: 0.0.0.0_8080  
        portNumber: 8080
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
    patch:
      operation: MERGE
      value:
        name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": "type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager"
          codec_type: AUTO
          stat_prefix: ingress_http
          route_config:
            name: http.8080
            virtual_hosts:
            - name: “*.80”
              domains:
              - "*"
              routes:
              - match:
                  caseSensitive: true
                  prefix: /productpage
                route:
                  cluster: outbound|9080||productpage.istio.svc.cluster.local
                  hash_policy:
                  - cookie:
                      name: user
                      ttl: "0"
  - applyTo: CLUSTER
    match:
      cluster:
        name: outbound|9080||productpage.istio.svc.cluster.local
    patch:
      operation: MERGE
      value: 
        lb_policy: RING_HASH
        ring_hash_lb_config:
          minimum_ring_size: 1024
EOF

kubectl apply -f  ef-lb-consistentHash-httpCookie.yaml -n istio-system --context context-cluster1
```

### 2.1.2httpHeaderName

destinationrule实现

```
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: productpage
spec:
  host: productpage
  trafficPolicy:
    loadBalancer:
      consistentHash:
        httpHeaderName: end-user
```

envoyfilter实现

```
cat << EOF > ef-lb-consistentHash-httpHeaderName.yaml
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      listener:
        #name: 0.0.0.0_8080  
        portNumber: 8080
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
    patch:
      operation: MERGE
      value:
        name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": "type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager"
          codec_type: AUTO
          stat_prefix: ingress_http
          route_config:
            name: http.8080
            virtual_hosts:
            - name: “*.80”
              domains:
              - "*"
              routes:
              - match:
                  caseSensitive: true
                  prefix: /productpage
                route:
                  cluster: outbound|9080||productpage.istio.svc.cluster.local
                  hash_policy:
                  - header:
                      header_name: end-user
  - applyTo: CLUSTER
    match:
      cluster:
        name: outbound|9080||productpage.istio.svc.cluster.local
    patch:
      operation: MERGE
      value: 
        lb_policy: RING_HASH
        ring_hash_lb_config:
          minimum_ring_size: 1024
EOF

kubectl apply -f  ef-lb-consistentHash-httpHeaderName.yaml -n istio-system --context context-cluster1
```

### 2.1.3useSourceIp

destinationrule实现

```
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: productpage
spec:
  host: productpage
  trafficPolicy:
    loadBalancer:
      consistentHash:
        useSourceIp: true
```

envoyfilter实现

```
cat << EOF > ef-lb-consistentHash-useSourceIp.yaml
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      listener:
        #name: 0.0.0.0_8080  
        portNumber: 8080
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
    patch:
      operation: MERGE
      value:
        name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": "type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager"
          codec_type: AUTO
          stat_prefix: ingress_http
          route_config:
            name: http.8080
            virtual_hosts:
            - name: “*.80”
              domains:
              - "*"
              routes:
              - match:
                  caseSensitive: true
                  prefix: /productpage
                route:
                  cluster: outbound|9080||productpage.istio.svc.cluster.local
                  hash_policy:
                  - connection_properties:
                      source_ip: true
  - applyTo: CLUSTER
    match:
      cluster:
        name: outbound|9080||productpage.istio.svc.cluster.local
    patch:
      operation: MERGE
      value: 
        lb_policy: RING_HASH
        ring_hash_lb_config:
          minimum_ring_size: 1024
EOF

kubectl apply -f  ef-lb-consistentHash-useSourceIp.yaml -n istio-system --context context-cluster1
```



### 2.1.4httpQueryParameterName

destinationrule实现

```
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: productpage
spec:
  host: productpage
  trafficPolicy:
    loadBalancer:
      consistentHash:
        httpQueryParameterName: test
```

envoyfilter实现

```
cat << EOF > ef-lb-consistentHash-httpQueryParameterName.yaml
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      listener:
        #name: 0.0.0.0_8080  
        portNumber: 8080
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
    patch:
      operation: MERGE
      value:
        name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": "type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager"
          codec_type: AUTO
          stat_prefix: ingress_http
          route_config:
            name: http.8080
            virtual_hosts:
            - name: “*.80”
              domains:
              - "*"
              routes:
              - match:
                  caseSensitive: true
                  prefix: /productpage
                route:
                  cluster: outbound|9080||productpage.istio.svc.cluster.local
                  hash_policy:
                  - query_parameter:
                      name: test
  - applyTo: CLUSTER
    match:
      cluster:
        name: outbound|9080||productpage.istio.svc.cluster.local
    patch:
      operation: MERGE
      value: 
        lb_policy: RING_HASH
        ring_hash_lb_config:
          minimum_ring_size: 1024
EOF

kubectl apply -f  ef-lb-consistentHash-httpQueryParameterName.yaml -n istio-system --context context-cluster1
```



## 3.1simple

### 3.1.1LEAST_CONN

destinationrule实现

```
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: productpage
spec:
  host: productpage
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
```

envoyfilter实现

```
cat << EOF > ef-lb-simple-LEAST_CONN.yaml
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      listener:
        #name: 0.0.0.0_8080  
        portNumber: 8080
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
    patch:
      operation: MERGE
      value:
        name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": "type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager"
          codec_type: AUTO
          stat_prefix: ingress_http
          route_config:
            name: http.8080
            virtual_hosts:
            - name: “*.80”
              domains:
              - "*"
              routes:
              - match:
                  caseSensitive: true
                  prefix: /
                route:
                  cluster: outbound|9080||productpage.istio.svc.cluster.local
  - applyTo: CLUSTER
    match:
      cluster:
        name: outbound|9080||productpage.istio.svc.cluster.local
    patch:
      operation: MERGE
      value: 
        lb_policy: LEAST_REQUEST
EOF

kubectl apply -f  ef-lb-simple-LEAST_CONN.yaml -n istio-system --context context-cluster1
```



### 3.1.2ROUND_ROBIN

destinationrule实现

```
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: productpage
spec:
  host: productpage
  trafficPolicy:
    loadBalancer:
      simple: ROUND_ROBIN
```

envoyfilter实现

```
cat << EOF > ef-lb-simple-ROUND_ROBIN.yaml
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      listener:
        #name: 0.0.0.0_8080  
        portNumber: 8080
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
    patch:
      operation: MERGE
      value:
        name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": "type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager"
          codec_type: AUTO
          stat_prefix: ingress_http
          route_config:
            name: http.8080
            virtual_hosts:
            - name: “*.80”
              domains:
              - "*"
              routes:
              - match:
                  caseSensitive: true
                  prefix: /
                route:
                  cluster: outbound|9080||productpage.istio.svc.cluster.local
  - applyTo: CLUSTER
    match:
      cluster:
        name: outbound|9080||productpage.istio.svc.cluster.local
    patch:
      operation: MERGE
      value: 
        lb_policy: ROUND_ROBIN
EOF

kubectl apply -f  ef-lb-simple-ROUND_ROBIN.yaml -n istio-system --context context-cluster1
```



### 3.1.2RANDOM

destinationrule实现

```
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: productpage
spec:
  host: productpage
  trafficPolicy:
    loadBalancer:
      simple: RANDOM
```

envoyfilter实现

```
cat << EOF > ef-lb-simple-RANDOM.yaml
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      listener:
        #name: 0.0.0.0_8080  
        portNumber: 8080
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
    patch:
      operation: MERGE
      value:
        name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": "type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager"
          codec_type: AUTO
          stat_prefix: ingress_http
          route_config:
            name: http.8080
            virtual_hosts:
            - name: “*.80”
              domains:
              - "*"
              routes:
              - match:
                  caseSensitive: true
                  prefix: /
                route:
                  cluster: outbound|9080||productpage.istio.svc.cluster.local
  - applyTo: CLUSTER
    match:
      cluster:
        name: outbound|9080||productpage.istio.svc.cluster.local
    patch:
      operation: MERGE
      value: 
        lb_policy: RANDOM
EOF

kubectl apply -f  ef-lb-simple-RANDOM.yaml -n istio-system --context context-cluster1
```



### 3.1.2PASSTHROUGH

destinationrule实现

```
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: productpage
spec:
  host: productpage
  trafficPolicy:
    loadBalancer:
      simple: PASSTHROUGH
```

envoyfilter实现

```
cat << EOF > ef-lb-simple-original_dst_lb_config.yaml
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      listener:
        #name: 0.0.0.0_8080  
        portNumber: 8080
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
    patch:
      operation: MERGE
      value:
        name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": "type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager"
          codec_type: AUTO
          stat_prefix: ingress_http
          route_config:
            name: http.9080
            virtual_hosts:
            - name: “*.9080”
              domains:
              - "*"
              routes:
              - match:
                  prefix: /
                  caseSensitive: true
                route:
                  cluster: cluster123
  - applyTo: CLUSTER
    patch:
      operation: ADD
      value: 
        name: "cluster123"
        connect_timeout: 0.5s
        type: ORIGINAL_DST
        lb_policy: CLUSTER_PROVIDED
        original_dst_lb_config:
          use_http_header: true
          http_header_name: x-envoy-original-dst-host 
EOF

kubectl apply -f  ef-lb-simple-original_dst_lb_config.yaml -n istio-system --context context-cluster1
```

 curl -H "x-envoy-original-dst-host: 172.20.0.235:9080"  http://192.168.229.128:30555/productpage

## 4基于位置负载均衡

不能用envoyfilter实现



## 5lb_policy

### 5.1MAGLEV

redis_proxy

1部署redis

applyto/redis/redis-cluster-deploy.yaml

kubectl apply -f redis-cluster-deploy.yaml -n istio

```
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: redis-cluster
data:
  update-node.sh: |
    #!/bin/sh
    REDIS_NODES="/data/nodes.conf"
    sed -i -e "/myself/ s/[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}/${POD_IP}/" ${REDIS_NODES}
    exec "$@"
  redis.conf: |+
    cluster-enabled yes
    cluster-require-full-coverage no
    cluster-node-timeout 15000
    cluster-config-file /data/nodes.conf
    cluster-migration-barrier 1
    appendonly yes
    protected-mode no
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: redis-cluster
spec:
  serviceName: redis-cluster
  replicas: 6
  selector:
    matchLabels:
      app: redis-cluster
  template:
    metadata:
      labels:
        app: redis-cluster
    spec:
      containers:
      - name: redis
        image: redis:6.0.8-alpine
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 6379
          name: tcp-client
        - containerPort: 16379
          name: tcp-gossip
        command: ["/conf/update-node.sh", "redis-server", "/conf/redis.conf", "--cluster-announce-ip $(POD_IP)"]
        env:
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: conf
          mountPath: /conf
          readOnly: false
      volumes:
      - name: conf
        configMap:
          name: redis-cluster
          defaultMode: 0755

---
apiVersion: v1
kind: Service
metadata:
  name: redis-cluster
spec:
  type: ClusterIP
  clusterIP: None
  ports:
  - port: 6379
    targetPort: 6379
    name: tcp-client
  - port: 16379
    targetPort: 16379
    name: tcp-gossip
  selector:
    app: redis-cluster
    
---
apiVersion: v1
kind: Service
metadata:
  name: redis-cluster-op
spec:
  type: ClusterIP
  ports:
  - port: 6379
    targetPort: 6379
    name: tcp-client
  - port: 16379
    targetPort: 16379
    name: tcp-gossip
  selector:
    app: redis-cluster
```

applyto/redis/redis-client-deploy.yaml

kubectl apply -f redis-client-deploy.yaml -n istio

```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis-client
  labels:
    app: redis-client
spec:
  selector:
    matchLabels:
      app: redis-client
  replicas: 1
  template:
    metadata:
      labels:
        app: redis-client
    spec:
      containers:
      - name: redis-client
        image: redis
        imagePullPolicy: IfNotPresent
```

2设置 envoyfilter cluster

applyto/redis/envoyfilter-cluster.yaml

kubectl apply -f envoyfilter-cluster.yaml -n istio-system

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: custom-redis-cluster
  namespace: istio-system
spec:
  configPatches:
  - applyTo: CLUSTER
    patch:
      operation: ADD
      value:
        name: "custom-redis-cluster"
        type: STRICT_DNS
        connect_timeout: 0.5s
        #lb_policy: CLUSTER_PROVIDED
        lb_policy: MAGLEV
        load_assignment:
          cluster_name: custom-redis-cluster
          endpoints:
          - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: redis-cluster-0.redis-cluster.istio.svc.cluster.local
                    port_value: 6379
            - endpoint:
                address:
                  socket_address:
                    address: redis-cluster-1.redis-cluster.istio.svc.cluster.local
                    port_value: 6379
            - endpoint:
                address:
                  socket_address:
                    address: redis-cluster-2.redis-cluster.istio.svc.cluster.local
                    port_value: 6379
            - endpoint:
                address:
                  socket_address:
                    address: redis-cluster-3.redis-cluster.istio.svc.cluster.local
                    port_value: 6379
            - endpoint:
                address:
                  socket_address:
                    address: redis-cluster-4.redis-cluster.istio.svc.cluster.local
                    port_value: 6379
            - endpoint:
                address:
                  socket_address:
                    address: redis-cluster-5.redis-cluster.istio.svc.cluster.local
                    port_value: 6379
        cluster_type:
          name: envoy.clusters.redis
          typed_config:
            "@type": type.googleapis.com/google.protobuf.Struct
            value:
              cluster_refresh_rate: 5s
              cluster_refresh_timeout: 3s
              redirect_refresh_interval: 5s
              redirect_refresh_threshold: 5
```

3设置redis_proxy

applyto/redis/envoyfilter-redis-proxy.yaml

kubectl apply -f envoyfilter-redis-proxy.yaml -n istio-system

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: add-redis-proxy
  namespace: istio-system
spec:
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      listener:
        name: ${REDIS_VIP}_6379               # Replace REDIS_VIP with the cluster IP of "redis-cluster service
        filterChain:
          filter:
            name: "envoy.filters.network.tcp_proxy"
    patch:
      operation: REPLACE
      value:
        name: envoy.filters.network.redis_proxy
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.redis_proxy.v3.RedisProxy
          stat_prefix: redis_stats
          prefix_routes:
            catch_all_route:
              cluster: custom-redis-cluster
          settings:
            op_timeout: 5s
            enable_redirection: true
            enable_command_stats: true
            read_policy: REPLICA
```

替换REDIS_VIP

4构建redis集群

获取pod ip

 kubectl get pods -l app=redis-cluster -o jsonpath='{range.items[*]}{.status.podIP}:6379 ' -n istio

构建集群

kubectl exec -it  redis-cluster-0 -n istio  -- redis-cli --cluster create --cluster-replicas 1 172.20.0.227:6379 172.20.1.238:6379 172.20.2.209:6379 172.20.0.228:6379 172.20.1.239:6379 172.20.2.210:6379

验证集群是否成功

kubectl exec -it redis-cluster-0 -c redis -n istio -- redis-cli cluster info 

进入客户端

 kubectl exec -it redis-client-6c4b6c4fb5-7hbv9  -n istio -- /bin/bash

连接集群

 redis-cli -h redis-cluster-op  -p 6379 -c

设置数据

set  a a等

验证数据

kubectl exec redis-cluster-0 -c redis -n istio -- redis-cli --scan



```
kubectl delete -f redis-cluster-deploy.yaml -n istio
kubectl delete -f redis-client-deploy.yaml -n istio
kubectl delete envoyfilter custom-redis-cluster -n istio-system
kubectl delete envoyfilter add-redis-proxy -n istio-system
```



## 6lb_subset_config

```
{
  "fallback_policy": "...",
  "default_subset": "{...}",
  "subset_selectors": [],
  "locality_weight_aware": "...",
  "scale_locality_weight": "...",
  "panic_mode_any": "...",
  "list_as_any": "..."
}
```

https://zyfjeff.github.io/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/envoy/subset_lb/

https://github.com/envoyproxy/envoy/blob/main/source/docs/subset_load_balancer.md

### 6.1fallback_policy

#### 6.1.1DEFAULT_SUBSET

ef-lb_subset_config-fallback_policy-DEFAULT_SUBSET.yaml

kubectl apply -f ef-lb_subset_config-fallback_policy-DEFAULT_SUBSET.yaml -n istio-system

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      listener:
        #name: 0.0.0.0_8080  
        portNumber: 8080
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
    patch:
      operation: MERGE
      value:
        name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": "type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager"
          codec_type: AUTO
          stat_prefix: ingress_http
          route_config:
            name: http.9080
            virtual_hosts:
            - name: “*.9080”
              domains:
              - "*"
              routes:
              - match:
                  prefix: /
                  caseSensitive: true
                route:
                  cluster: cluster123
                  metadata_match:
                    filter_metadata:
                      envoy.lb:
                        env: mark
  - applyTo: CLUSTER
    patch:
      operation: ADD
      value: 
        name: "cluster123"
        type: STRICT_DNS
        connect_timeout: 0.5s
        lb_policy: ROUND_ROBIN
        lb_subset_config:
          fallback_policy: DEFAULT_SUBSET
          default_subset:
            env: "taobao"
          subset_selectors:
          - keys:
            - env
        load_assignment:
          cluster_name: cluster123
          endpoints:
          - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: productpage.istio.svc.cluster.local
                    port_value: 9080
              metadata:
                filter_metadata:
                  envoy.lb:
                    env: hema
            - endpoint:
                address:
                  socket_address:
                    address: productpage.istio-2.svc.cluster.local
                    port_value: 9080
              metadata:
                filter_metadata:
                  envoy.lb:
                    env: taobao
```

deploy-productpage.yaml

kubectl apply -f deploy-productpage.yaml -n istio-2

```
apiVersion: v1
kind: Service
metadata:
  name: productpage
  labels:
    app: productpage
    service: productpage
spec:
  ports:
  - port: 9080
    name: http
  selector:
    app: productpage
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: bookinfo-productpage
  labels:
    account: productpage
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: productpage-v1
  labels:
    app: productpage
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: productpage
      version: v1
  template:
    metadata:
      labels:
        app: productpage
        version: v1
    spec:
      serviceAccountName: bookinfo-productpage
      containers:
      - name: productpage
        image: docker.io/istio/examples-bookinfo-productpage-v1:1.16.4
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 9080
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        securityContext:
          runAsUser: 1000
      volumes:
      - name: tmp
        emptyDir: {}
---
```



#### 6.1.2NO_FALLBACK

ef-lb_subset_config-fallback_policy-NO_FALLBACK.yaml

kubectl apply -f ef-lb_subset_config-fallback_policy-NO_FALLBACK.yaml -n istio-system

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      listener:
        #name: 0.0.0.0_8080  
        portNumber: 8080
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
    patch:
      operation: MERGE
      value:
        name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": "type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager"
          codec_type: AUTO
          stat_prefix: ingress_http
          route_config:
            name: http.9080
            virtual_hosts:
            - name: “*.9080”
              domains:
              - "*"
              routes:
              - match:
                  prefix: /
                  caseSensitive: true
                route:
                  cluster: cluster123
                  metadata_match:
                    filter_metadata:
                      envoy.lb:
                        env: mark
  - applyTo: CLUSTER
    patch:
      operation: ADD
      value: 
        name: "cluster123"
        type: STRICT_DNS
        connect_timeout: 0.5s
        lb_policy: ROUND_ROBIN
        lb_subset_config:
          fallback_policy: NO_FALLBACK
          default_subset:
            env: "taobao"
          subset_selectors:
          - keys:
            - env
        load_assignment:
          cluster_name: cluster123
          endpoints:
          - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: productpage.istio.svc.cluster.local
                    port_value: 9080
              metadata:
                filter_metadata:
                  envoy.lb:
                    env: hema
            - endpoint:
                address:
                  socket_address:
                    address: productpage.istio-2.svc.cluster.local
                    port_value: 9080
              metadata:
                filter_metadata:
                  envoy.lb:
                    env: taobao
```



#### 6.1.3ANY_ENDPOINT

ef-lb_subset_config-fallback_policy-ANY_ENDPOINT.yaml

kubectl apply -f ef-lb_subset_config-fallback_policy-ANY_ENDPOINT.yaml -n istio-system

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      listener:
        #name: 0.0.0.0_8080  
        portNumber: 8080
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
    patch:
      operation: MERGE
      value:
        name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": "type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager"
          codec_type: AUTO
          stat_prefix: ingress_http
          route_config:
            name: http.9080
            virtual_hosts:
            - name: “*.9080”
              domains:
              - "*"
              routes:
              - match:
                  prefix: /
                  caseSensitive: true
                route:
                  cluster: cluster123
                  metadata_match:
                    filter_metadata:
                      envoy.lb:
                        env: mark
  - applyTo: CLUSTER
    patch:
      operation: ADD
      value: 
        name: "cluster123"
        type: STRICT_DNS
        connect_timeout: 0.5s
        lb_policy: ROUND_ROBIN
        lb_subset_config:
          fallback_policy: ANY_ENDPOINT
          default_subset:
            env: "taobao"
          subset_selectors:
          - keys:
            - env
        load_assignment:
          cluster_name: cluster123
          endpoints:
          - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: productpage.istio.svc.cluster.local
                    port_value: 9080
              metadata:
                filter_metadata:
                  envoy.lb:
                    env: hema
            - endpoint:
                address:
                  socket_address:
                    address: productpage.istio-2.svc.cluster.local
                    port_value: 9080
              metadata:
                filter_metadata:
                  envoy.lb:
                    env: taobao
```

### 6.2locality

ef-lb_subset_config-locality.yaml

kubectl apply -f ef-lb_subset_config-locality.yaml -n istio-system

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      listener:
        #name: 0.0.0.0_8080  
        portNumber: 8080
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
    patch:
      operation: MERGE
      value:
        name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": "type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager"
          codec_type: AUTO
          stat_prefix: ingress_http
          route_config:
            name: http.9080
            virtual_hosts:
            - name: “*.9080”
              domains:
              - "*"
              routes:
              - match:
                  prefix: /
                  caseSensitive: true
                route:
                  cluster: cluster123
                  metadata_match:
                    filter_metadata:
                      envoy.lb:
                        env: mark
  - applyTo: CLUSTER
    patch:
      operation: ADD
      value: 
        name: "cluster123"
        type: STRICT_DNS
        connect_timeout: 0.5s
        lb_policy: ROUND_ROBIN
        lb_subset_config:
          fallback_policy: ANY_ENDPOINT
          default_subset:
            env: "taobao"
          subset_selectors:
          - keys:
            - env
          locality_weight_aware: true
          scale_locality_weight: true
        load_assignment:
          cluster_name: cluster123
          endpoints:
          - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: productpage.istio.svc.cluster.local
                    port_value: 9080
              metadata:
                filter_metadata:
                  envoy.lb:
                    env: hema
            - endpoint:
                address:
                  socket_address:
                    address: productpage.istio-2.svc.cluster.local
                    port_value: 9080
              metadata:
                filter_metadata:
                  envoy.lb:
                    env: taobao
```

### 6.3panic_mode_any

ef-lb_subset_config-panic_mode_any.yaml

kubectl apply -f ef-lb_subset_config-panic_mode_any.yaml -n istio-system

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      listener:
        #name: 0.0.0.0_8080  
        portNumber: 8080
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
    patch:
      operation: MERGE
      value:
        name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": "type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager"
          codec_type: AUTO
          stat_prefix: ingress_http
          route_config:
            name: http.9080
            virtual_hosts:
            - name: “*.9080”
              domains:
              - "*"
              routes:
              - match:
                  prefix: /
                  caseSensitive: true
                route:
                  cluster: cluster123
                  metadata_match:
                    filter_metadata:
                      envoy.lb:
                        env: mark
  - applyTo: CLUSTER
    patch:
      operation: ADD
      value: 
        name: "cluster123"
        type: STRICT_DNS
        connect_timeout: 0.5s
        lb_policy: ROUND_ROBIN
        lb_subset_config:
          fallback_policy: DEFAULT_SUBSET
          default_subset:
            env: "mark"
          subset_selectors:
          - keys:
            - env
          panic_mode_any: true
        load_assignment:
          cluster_name: cluster123
          endpoints:
          - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: productpage.istio.svc.cluster.local
                    port_value: 9080
              metadata:
                filter_metadata:
                  envoy.lb:
                    env: hema
            - endpoint:
                address:
                  socket_address:
                    address: productpage.istio-2.svc.cluster.local
                    port_value: 9080
              metadata:
                filter_metadata:
                  envoy.lb:
                    env: taobao
```



### 6.4list_as_any

ef-lb_subset_config-list_as_any.yaml

kubectl apply -f ef-lb_subset_config-list_as_any.yaml -n istio-system

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      listener:
        #name: 0.0.0.0_8080  
        portNumber: 8080
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
    patch:
      operation: MERGE
      value:
        name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": "type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager"
          codec_type: AUTO
          stat_prefix: ingress_http
          route_config:
            name: http.9080
            virtual_hosts:
            - name: “*.9080”
              domains:
              - "*"
              routes:
              - match:
                  prefix: /
                  caseSensitive: true
                route:
                  cluster: cluster123
                  metadata_match:
                    filter_metadata:
                      envoy.lb:
                        env: taobao
  - applyTo: CLUSTER
    patch:
      operation: ADD
      value: 
        name: "cluster123"
        type: STRICT_DNS
        connect_timeout: 0.5s
        lb_policy: ROUND_ROBIN
        lb_subset_config:
          fallback_policy: DEFAULT_SUBSET
          default_subset:
            env: "mark"
          subset_selectors:
          - keys:
            - env
          list_as_any: true
        load_assignment:
          cluster_name: cluster123
          endpoints:
          - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: productpage.istio.svc.cluster.local
                    port_value: 9080
              metadata:
                filter_metadata:
                  envoy.lb:
                    env: 
                    - hema
                    - titi
            - endpoint:
                address:
                  socket_address:
                    address: productpage.istio-2.svc.cluster.local
                    port_value: 9080
              metadata:
                filter_metadata:
                  envoy.lb:
                    env:
                    - taobao
                    - tianmao
```

### 6.5subset_selectors

#### 6.5.1fallback_policy

ef-lb_subset_config-subset_selectors-fallback_policy-NO_FALLBACK.yaml

kubectl apply -f ef-lb_subset_config-subset_selectors-fallback_policy-NO_FALLBACK.yaml -n istio-system

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      listener:
        #name: 0.0.0.0_8080  
        portNumber: 8080
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
    patch:
      operation: MERGE
      value:
        name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": "type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager"
          codec_type: AUTO
          stat_prefix: ingress_http
          route_config:
            name: http.9080
            virtual_hosts:
            - name: “*.9080”
              domains:
              - "*"
              routes:
              - match:
                  prefix: /
                  caseSensitive: true
                route:
                  cluster: cluster123
                  metadata_match:
                    filter_metadata:
                      envoy.lb:
                        env: mark
  - applyTo: CLUSTER
    patch:
      operation: ADD
      value: 
        name: "cluster123"
        type: STRICT_DNS
        connect_timeout: 0.5s
        lb_policy: ROUND_ROBIN
        lb_subset_config:
          fallback_policy: DEFAULT_SUBSET
          default_subset:
            env: "taobao"
          subset_selectors:
          - keys:
            - env
            fallback_policy: NO_FALLBACK
        load_assignment:
          cluster_name: cluster123
          endpoints:
          - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: productpage.istio.svc.cluster.local
                    port_value: 9080
              metadata:
                filter_metadata:
                  envoy.lb:
                    env: hema
            - endpoint:
                address:
                  socket_address:
                    address: productpage.istio-2.svc.cluster.local
                    port_value: 9080
              metadata:
                filter_metadata:
                  envoy.lb:
                    env: taobao
```



#### 6.5.2fallback_keys_subset

ef-lb_subset_config-subset_selectors-fallback_keys_subset.yaml

kubectl apply -f ef-lb_subset_config-subset_selectors-fallback_keys_subset.yaml -n istio-system

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      listener:
        #name: 0.0.0.0_8080  
        portNumber: 8080
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
    patch:
      operation: MERGE
      value:
        name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": "type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager"
          codec_type: AUTO
          stat_prefix: ingress_http
          route_config:
            name: http.9080
            virtual_hosts:
            - name: “*.9080”
              domains:
              - "*"
              routes:
              - match:
                  prefix: /
                  caseSensitive: true
                route:
                  cluster: cluster123
                  metadata_match:
                    filter_metadata:
                      envoy.lb:
                        env: mark
                        stage: test
  - applyTo: CLUSTER
    patch:
      operation: ADD
      value: 
        name: "cluster123"
        type: STRICT_DNS
        connect_timeout: 0.5s
        lb_policy: ROUND_ROBIN
        lb_subset_config:
          fallback_policy: DEFAULT_SUBSET
          default_subset:
            env: "taobao"
            stage: test
          subset_selectors:
          - keys:
            - env
            - stage
            fallback_policy: KEYS_SUBSET
            fallback_keys_subset:
            - stage
        load_assignment:
          cluster_name: cluster123
          endpoints:
          - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: productpage.istio.svc.cluster.local
                    port_value: 9080
              metadata:
                filter_metadata:
                  envoy.lb:
                    env: hema
                    stage: prod
            - endpoint:
                address:
                  socket_address:
                    address: productpage.istio-2.svc.cluster.local
                    port_value: 9080
              metadata:
                filter_metadata:
                  envoy.lb:
                    env: taobao
                    stage: test
```





## 7ring_hash_lb_config

```
cat << EOF > ef-lb-consistentHash-ring_hash_lb_config.yaml
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      listener:
        #name: 0.0.0.0_8080  
        portNumber: 8080
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
    patch:
      operation: MERGE
      value:
        name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": "type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager"
          codec_type: AUTO
          stat_prefix: ingress_http
          route_config:
            name: http.8080
            virtual_hosts:
            - name: “*.80”
              domains:
              - "*"
              routes:
              - match:
                  caseSensitive: true
                  prefix: /productpage
                route:
                  cluster: outbound|9080||productpage.istio.svc.cluster.local
                  hash_policy:
                  - header:
                      header_name: end-user
  - applyTo: CLUSTER
    match:
      cluster:
        name: outbound|9080||productpage.istio.svc.cluster.local
    patch:
      operation: MERGE
      value: 
        lb_policy: RING_HASH
        ring_hash_lb_config:
          minimum_ring_size: 1024
          hash_function: MURMUR_HASH_2
          maximum_ring_size: 10240
EOF

kubectl apply -f  ef-lb-consistentHash-ring_hash_lb_config.yaml -n istio-system --context context-cluster1
```



## 8original_dst_lb_config

```
cat << EOF > ef-lb-simple-original_dst_lb_config.yaml
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      listener:
        #name: 0.0.0.0_8080  
        portNumber: 8080
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
    patch:
      operation: MERGE
      value:
        name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": "type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager"
          codec_type: AUTO
          stat_prefix: ingress_http
          route_config:
            name: http.9080
            virtual_hosts:
            - name: “*.9080”
              domains:
              - "*"
              routes:
              - match:
                  prefix: /
                  caseSensitive: true
                route:
                  cluster: cluster123
  - applyTo: CLUSTER
    patch:
      operation: ADD
      value: 
        name: "cluster123"
        connect_timeout: 0.5s
        type: ORIGINAL_DST
        lb_policy: CLUSTER_PROVIDED
        original_dst_lb_config:
          use_http_header: true
          http_header_name: x-envoy-original-dst-host 
EOF

kubectl apply -f  ef-lb-simple-original_dst_lb_config.yaml -n istio-system --context context-cluster1
```

 curl -H "x-envoy-original-dst-host: 172.20.0.235:9080"  http://192.168.229.128:30555/productpage

## 9least_request_lb_config

```
cat << EOF > ef-lb-simple-least_request_lb_config.yaml
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      listener:
        #name: 0.0.0.0_8080  
        portNumber: 8080
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
    patch:
      operation: MERGE
      value:
        name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": "type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager"
          codec_type: AUTO
          stat_prefix: ingress_http
          route_config:
            name: http.8080
            virtual_hosts:
            - name: “*.80”
              domains:
              - "*"
              routes:
              - match:
                  caseSensitive: true
                  prefix: /
                route:
                  cluster: outbound|9080||productpage.istio.svc.cluster.local
  - applyTo: CLUSTER
    match:
      cluster:
        name: outbound|9080||productpage.istio.svc.cluster.local
    patch:
      operation: MERGE
      value: 
        lb_policy: LEAST_REQUEST
        least_request_lb_config:
          choice_count: 2
          active_request_bias:
            default_value: 0.5
            runtime_key: least_request_bias
          slow_start_config:
            slow_start_window: 60s
            aggression:
              default_value: 1.0
              runtime_key: least_request_slow_start_aggression
            min_weight_percent:
              value: 0.1
            
EOF

kubectl apply -f  ef-lb-simple-least_request_lb_config.yaml -n istio-system --context context-cluster1
```



## 10round_robin_lb_config

```
cat << EOF > ef-lb-simple-round_robin_lb_config.yaml
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      listener:
        #name: 0.0.0.0_8080  
        portNumber: 8080
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
    patch:
      operation: MERGE
      value:
        name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": "type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager"
          codec_type: AUTO
          stat_prefix: ingress_http
          route_config:
            name: http.8080
            virtual_hosts:
            - name: “*.80”
              domains:
              - "*"
              routes:
              - match:
                  caseSensitive: true
                  prefix: /
                route:
                  cluster: outbound|9080||productpage.istio.svc.cluster.local
  - applyTo: CLUSTER
    match:
      cluster:
        name: outbound|9080||productpage.istio.svc.cluster.local
    patch:
      operation: MERGE
      value: 
        lb_policy: ROUND_ROBIN
        round_robin_lb_config:
          slow_start_config:
            slow_start_window: 60s
            aggression:
              default_value: 1.0
              runtime_key: least_request_slow_start_aggression
            min_weight_percent:
              value: 0.1
EOF

kubectl apply -f  ef-lb-simple-round_robin_lb_config.yaml -n istio-system --context context-cluster1
```

## 11common_lb_config

```
{
  "healthy_panic_threshold": "{...}",
  "zone_aware_lb_config": "{...}",
  "locality_weighted_lb_config": "{...}",
  "update_merge_window": "{...}",
  "ignore_new_hosts_until_first_hc": "...",
  "close_connections_on_host_set_change": "...",
  "consistent_hashing_lb_config": "{...}",
  "override_host_status": "{...}"
}
```



```
cat << EOF > ef-lb-simple-common_lb_config.yaml
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      listener:
        #name: 0.0.0.0_8080  
        portNumber: 8080
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
    patch:
      operation: MERGE
      value:
        name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": "type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager"
          codec_type: AUTO
          stat_prefix: ingress_http
          route_config:
            name: http.8080
            virtual_hosts:
            - name: “*.80”
              domains:
              - "*"
              routes:
              - match:
                  caseSensitive: true
                  prefix: /
                route:
                  cluster: outbound|9080||productpage.istio.svc.cluster.local
  - applyTo: CLUSTER
    match:
      cluster:
        name: outbound|9080||productpage.istio.svc.cluster.local
    patch:
      operation: MERGE
      value: 
        lb_policy: LEAST_REQUEST
        common_lb_config:
          healthy_panic_threshold:
            value: 0.5
          zone_aware_lb_config:
            routing_enabled:
              value: 1
            min_cluster_size: 6
            fail_traffic_on_panic: true
          update_merge_window: 1000ms
          ignore_new_hosts_until_first_hc: true
          close_connections_on_host_set_change: true
          override_host_status:
            statuses:
            - HEALTHY
            - DRAINING
            - DEGRADED
EOF

kubectl apply -f  ef-lb-simple-common_lb_config.yaml -n istio-system --context context-cluster1
```

