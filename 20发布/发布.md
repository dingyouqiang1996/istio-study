# 金丝雀发布/灰度发布

## 什么是金丝雀发布

灰度发布也叫金丝雀部署 ，是指通过控制流量的比例，实现新老版本的逐步更替。
比如对于服务A 有 version1 version2 两个版本 ， 当前两个版本同时部署，但是version1比例90% ，version2比例10% ，看运行效果，如果效果好逐步调整 流量占比 80～20 ，70～30 ·····10～90 ，0，100 ，最终version1版本下线。
灰度发布的特点
1.新老板共存
2.可以实时根据反馈 动态调整占比
3.理论上不存在服务完全宕机的情况。
适合于服务的平滑升级与动态更新。
4、当前针对k8s的环境部署平台， 我们可以使用servicemesh 服务网格完成 各种部署场景，满足我们的业务需求。

## 过程

1. 线上原版本为v1。
2. 部署新版本v2，线上同时存在两个版本（蓝和绿版本）。
3. 切换10%路由到v2。
4. 验证通过后，把更多的流量（比如20%），切换到v2。
5. 逐步增加分发给v2的流量，直到把100%的流量都分发给v2。
6. 如果验证失败，切换100%路由回v1（回滚）
7. 待新版本服务稳定运行后，删除老版本服务。

![flagger-canary-steps](images\flagger-canary-steps.png)



## 案例

### 手工实现



### **Flagger** 

#### 什么是flagger

[Flagger](https://github.com/weaveworks/flagger)是一个能使运行在k8s体系上的应用发布流程全自动(无人参与)的工具, 它能减少发布的人为关注时间, 并且在发布过程中能自动识别一些风险(例如:RT,成功率,自定义metrics)并回滚.



文档https://docs.flagger.app/

#### flagger功能

![1630227083(1)](images\1630227083(1).jpg)



![1630227187(1)](images\1630227187(1).jpg)

#### 部署策略

![1630227405(1)](images\1630227405(1).jpg)



#### 部署flagger

```
kubectl apply -f flagger-crd.yaml

helm repo add flagger https://flagger.app

helm upgrade -i flagger-test flagger/flagger \
--namespace=istio-system \
--set crd.create=false \
--set meshProvider=istio \
--set metricsServer=http://prometheus:9090

[root@master01 release]# kubectl get pod -n istio-system  
NAME                                    READY   STATUS    RESTARTS   AGE
flagger-5574cbff7c-7485p                1/1     Running   0          45s
istio-egressgateway-6bddfd6fd9-s47d7    1/1     Running   2          26h
istio-ingressgateway-7cdccb7b58-nc2gf   1/1     Running   2          26h
istiod-7fbdd57c4f-8dcm7                 1/1     Running   2          26h


addons/prometheus.yaml
kubectl apply -f prometheus.yaml -n istio-system

addons/grafana.yaml
kubectl apply -f grafana.yaml -n istio-system

[root@master01 addons]# kubectl get pod -n istio-system  -w
NAME                                    READY   STATUS    RESTARTS   AGE
flagger-5574cbff7c-7485p                1/1     Running   0          5m47s
grafana-784c89f4cf-p6vww                1/1     Running   0          92s
istio-egressgateway-6bddfd6fd9-s47d7    1/1     Running   2          26h
istio-ingressgateway-7cdccb7b58-nc2gf   1/1     Running   2          26h
istiod-7fbdd57c4f-8dcm7                 1/1     Running   2          26h
prometheus-7bfddb8dbf-bt498             2/2     Running   0          4m13s
```

#### 升级流程

Gated canary promotion stages:

- scan for canary deployments
- check primary and canary deployment status
  - halt advancement if a rolling update is underway
  - halt advancement if pods are unhealthy
- call confirm-rollout webhooks and check results
  - halt advancement if any hook returns a non HTTP 2xx result
- call pre-rollout webhooks and check results
  - halt advancement if any hook returns a non HTTP 2xx result
  - increment the failed checks counter
- increase canary traffic weight percentage from 0% to 2% (step weight)
- call rollout webhooks and check results
- check canary HTTP request success rate and latency
  - halt advancement if any metric is under the specified threshold
  - increment the failed checks counter
- check if the number of failed checks reached the threshold
  - route all traffic to primary
  - scale to zero the canary deployment and mark it as failed
  - call post-rollout webhooks
  - post the analysis result to Slack
  - wait for the canary deployment to be updated and start over
- increase canary traffic weight by 2% (step weight) till it reaches 50% (max weight) 
  - halt advancement if any webhook call fails
  - halt advancement while canary request success rate is under the threshold
  - halt advancement while canary request duration P99 is over the threshold
  - halt advancement while any custom metric check fails
  - halt advancement if the primary or canary deployment becomes unhealthy 
  - halt advancement while canary deployment is being scaled up/down by HPA
- call confirm-promotion webhooks and check results
  - halt advancement if any hook returns a non HTTP 2xx result
- promote canary to primary
  - copy ConfigMaps and Secrets from canary to primary
  - copy canary deployment spec template over primary
- wait for primary rolling update to finish
  - halt advancement if pods are unhealthy
- route all traffic to primary
- scale to zero the canary deployment
- mark rollout as finished
- call post-rollout webhooks
- send notification with the canary analysis result
- wait for the canary deployment to be updated and start over

#### crd详解

```
[root@master01 addons]# kubectl get crd |grep flagger
alertproviders.flagger.app                           2021-08-29T09:01:58Z
canaries.flagger.app                                 2021-08-29T09:01:56Z
metrictemplates.flagger.app                          2021-08-29T09:01:58Z
```

##### canary

###### stepWeight

release/canary/flagger/canary-reviews-stepWeight.yaml

kubectl apply -f canary-reviews-stepWeight.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  service:
    port: 9080
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 5
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
```

流程图：

![flagger-canary-hpa](images\flagger-canary-hpa.png)

资源变化：

```
# applied 
canary.flagger.app/bookinfo

# generated 
deployment.apps/reviews-v1-primary
service/reviews-v1-canary
service/reviews-v1-primary
destinationrule.networking.istio.io/reviews-v1-canary
destinationrule.networking.istio.io/reviews-v1-primary
virtualservice.networking.istio.io/reviews-v1
```

执行升级：

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2

执行请求：
go-stress-testing -n 10000 -c 5 -u http://192.168.229.134:30468/reviews/0

kubectl describe canary bookinfo -n istio

  Type     Reason  Age                From     Message
  ----     ------  ----               ----     -------
  Warning  Synced  35m                flagger  reviews-v1-primary.istio not ready: waiting for rollout to finish: observed deployment generation less than desired generation
  Normal   Synced  34m (x2 over 35m)  flagger  all the metrics providers are available!
  Normal   Synced  34m                flagger  Initialization done! bookinfo.istio
  Normal   Synced  30m                flagger  New revision detected! Scaling up reviews-v1.istio
  Normal   Synced  29m                flagger  Starting canary analysis for reviews-v1.istio
  Normal   Synced  29m                flagger  Advance bookinfo.istio canary weight 5
  Warning  Synced  28m                flagger  Halt advancement no values found for istio metric request-success-rate probably reviews-v1.istio is not receiving traffic: running query failed: no values found
  Normal   Synced  27m                flagger  Advance bookinfo.istio canary weight 10
  Normal   Synced  26m                flagger  Advance bookinfo.istio canary weight 15
  Normal   Synced  25m                flagger  Advance bookinfo.istio canary weight 20
  Normal   Synced  24m                flagger  Advance bookinfo.istio canary weight 25
  Normal   Synced  16m (x8 over 23m)  flagger  (combined from similar events): Promotion completed! Scaling down reviews-v1.istio

```

清理：

kubectl delete -f canary-reviews-stepWeight.yaml -n istio



触发条件

A canary deployment is triggered by changes in any of the following objects:

- Deployment PodSpec (container image, command, ports, env, resources, etc)
- ConfigMaps mounted as volumes or mapped to environment variables
- Secrets mounted as volumes or mapped to environment variables



######  mirroring 

release/canary/flagger/canary-reviews-mirroring.yaml

kubectl apply -f canary-reviews-mirroring.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  service:
    port: 9080
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    iterations: 10
    mirror: true
    mirrorWeight: 100
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
```

![flagger-canary-traffic-mirroring](images\flagger-canary-traffic-mirroring.png)

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v3:1.16.2

执行请求：
go-stress-testing -n 10000 -c 5 -u http://192.168.229.134:30468/reviews/0

kubectl describe canary bookinfo -n istio

Type     Reason  Age                From     Message
  ----     ------  ----               ----     -------
  Warning  Synced  39m                flagger  reviews-v1-primary.istio not ready: waiting for rollout to finish: observed deployment generation less than desired generation
  Normal   Synced  38m (x2 over 39m)  flagger  all the metrics providers are available!
  Normal   Synced  38m                flagger  Initialization done! bookinfo.istio
  Normal   Synced  34m                flagger  New revision detected! Scaling up reviews-v1.istio
  Normal   Synced  33m                flagger  Starting canary analysis for reviews-v1.istio
  Normal   Synced  33m                flagger  Advance bookinfo.istio canary iteration 1/10
  Warning  Synced  32m                flagger  Halt bookinfo.istio advancement request duration 4.842s > 500ms
  Normal   Synced  31m                flagger  Advance bookinfo.istio canary iteration 2/10
  Normal   Synced  30m                flagger  Advance bookinfo.istio canary iteration 3/10
  Normal   Synced  29m                flagger  Advance bookinfo.istio canary iteration 4/10
  Normal   Synced  28m                flagger  Advance bookinfo.istio canary iteration 5/10
  Normal   Synced  19m (x9 over 27m)  flagger  (combined from similar events): Promotion completed! Scaling down reviews-v1.istio
  
  
  spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - mirror:
      host: reviews-v1-canary
    mirrorPercentage:
      value: 100
    route:
    - destination:
        host: reviews-v1-primary
      weight: 100
    - destination:
        host: reviews-v1-canary
      weight: 0
```

清理：

kubectl delete canary bookinfo -n istio



######  skipAnalysis 

release/canary/flagger/canary-reviews-skipAnalysis.yaml

kubectl apply -f canary-reviews-skipAnalysis.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  service:
    port: 9080
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  skipAnalysis: true
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 5
  
```



```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v3:1.16.2

执行请求：
go-stress-testing -n 10000 -c 5 -u http://192.168.229.134:30468/reviews/0

kubectl describe canary bookinfo -n istio

  Type    Reason  Age    From     Message
  ----    ------  ----   ----     -------
  Normal  Synced  2m10s  flagger  Initialization done! bookinfo.istio
  Normal  Synced  71s    flagger  New revision detected! Scaling up reviews-v1.istio
  Normal  Synced  11s    flagger  Copying reviews-v1.istio template spec to reviews-v1-primary.istio
  Normal  Synced  11s    flagger  Promotion completed! Canary analysis was skipped for reviews-v1.istio
```

清理：

kubectl delete canary bookinfo -n istio



######  stepWeights

release/canary/flagger/canary-reviews-non-linear.yaml

kubectl apply -f canary-reviews-non-linear.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  service:
    port: 9080
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeights: [30, 45, 90]
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2

执行请求：
go-stress-testing -n 10000 -c 5 -u http://192.168.229.134:30468/reviews/0

 kubectl describe canary bookinfo -n istio

  Type     Reason  Age                 From     Message
  ----     ------  ----                ----     -------
  Warning  Synced  88m                 flagger  reviews-v1-primary.istio not ready: waiting for rollout to finish: observed deployment generation less than desired generation
  Normal   Synced  87m (x2 over 88m)   flagger  all the metrics providers are available!
  Normal   Synced  87m                 flagger  Initialization done! bookinfo.istio
  Normal   Synced  83m                 flagger  Advance bookinfo.istio canary weight 1
  Warning  Synced  73m (x10 over 82m)  flagger  Halt advancement no values found for istio metric request-success-rate probably reviews-v1.istio is not receiving traffic: running query failed: no values found
  Warning  Synced  72m                 flagger  Canary failed! Scaling down bookinfo.istio
  Warning  Synced  72m                 flagger  Rolling back bookinfo.istio failed checks threshold reached 10
  Normal   Synced  67m (x2 over 84m)   flagger  New revision detected! Scaling up reviews-v1.istio
  Normal   Synced  66m (x2 over 83m)   flagger  Starting canary analysis for reviews-v1.istio
  Normal   Synced  66m                 flagger  Advance bookinfo.istio canary weight 30
  Normal   Synced  65m                 flagger  Advance bookinfo.istio canary weight 45
  Normal   Synced  64m                 flagger  Advance bookinfo.istio canary weight 90
  Normal   Synced  63m                 flagger  Copying reviews-v1.istio template spec to reviews-v1-primary.istio
  Normal   Synced  62m                 flagger  Routing all traffic to primary
  Normal   Synced  61m                 flagger  Promotion completed! Scaling down reviews-v1.istio
```

清理：

kubectl delete canary bookinfo -n istio



###### metricsServer

release/canary/flagger/canary-reviews-metricsServer.yaml

kubectl apply -f canary-reviews-metricsServer.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  metricsServer: "http://prometheus:9090"
  service:
    port: 9080
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2

执行请求：
go-stress-testing -n 10000 -c 5 -u http://192.168.229.134:30468/reviews/0

kubectl describe canary bookinfo -n istio
  Type     Reason  Age                From     Message
  ----     ------  ----               ----     -------
  Warning  Synced  11m                flagger  reviews-v1-primary.istio not ready: waiting for rollout to finish: observed deployment generation less than desired generation
  Normal   Synced  10m (x2 over 11m)  flagger  all the metrics providers are available!
  Normal   Synced  10m                flagger  Initialization done! bookinfo.istio
  Normal   Synced  7m35s              flagger  New revision detected! Scaling up reviews-v1.istio
  Normal   Synced  6m35s              flagger  Starting canary analysis for reviews-v1.istio
  Normal   Synced  6m34s              flagger  Advance bookinfo.istio canary weight 20
  Normal   Synced  5m35s              flagger  Advance bookinfo.istio canary weight 40
  Normal   Synced  4m35s              flagger  Advance bookinfo.istio canary weight 60
  Normal   Synced  3m35s              flagger  Copying reviews-v1.istio template spec to reviews-v1-primary.istio
  Normal   Synced  2m35s              flagger  Routing all traffic to primary
  Normal   Synced  95s                flagger  (combined from similar events): Promotion completed! Scaling down reviews-v1.istio
```

清理：

kubectl delete canary bookinfo -n istio





###### provider

release/canary/flagger/canary-reviews-provider.yaml

kubectl apply -f canary-reviews-provider.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2

执行请求：
go-stress-testing -n 10000 -c 5 -u http://192.168.229.134:30468/reviews/0

kubectl describe canary bookinfo -n istio

  Type     Reason  Age                  From     Message
  ----     ------  ----                 ----     -------
  Warning  Synced  10m                  flagger  reviews-v1-primary.istio not ready: waiting for rollout to finish: observed deployment generation less than desired generation
  Warning  Synced  9m13s (x2 over 10m)  flagger  Error checking metric providers: prometheus not avaiable: running query failed: request failed: Get "prometheus:///api/v1/query?query=vector%281%29": unsupported protocol scheme "prometheus"
  Normal   Synced  9m10s                flagger  Initialization done! bookinfo.istio
  Normal   Synced  8m13s                flagger  New revision detected! Scaling up reviews-v1.istio
  Normal   Synced  7m13s                flagger  Starting canary analysis for reviews-v1.istio
  Normal   Synced  7m12s                flagger  Advance bookinfo.istio canary weight 20
  Normal   Synced  6m13s                flagger  Advance bookinfo.istio canary weight 40
  Normal   Synced  5m13s                flagger  Advance bookinfo.istio canary weight 60
  Normal   Synced  4m13s                flagger  Copying reviews-v1.istio template spec to reviews-v1-primary.istio
  Normal   Synced  3m13s                flagger  Routing all traffic to primary
  Normal   Synced  2m13s                flagger  Promotion completed! Scaling down reviews-v1.istio
```

清理：

kubectl delete canary bookinfo -n istio





###### autoscalerRef

release/canary/flagger/reviews-deploy-with-resources.yaml 

kubectl apply -f reviews-deploy-with-resources.yaml  -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: reviews
  labels:
    app: reviews
    service: reviews
spec:
  ports:
  - port: 9080
    name: http
  selector:
    app: reviews
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: bookinfo-reviews
  labels:
    account: reviews
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.2
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: reviews-v2
  labels:
    app: reviews
    version: v2
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v2
  template:
    metadata:
      labels:
        app: reviews
        version: v2
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v2:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.2
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: reviews-v3
  labels:
    app: reviews
    version: v3
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v3
  template:
    metadata:
      labels:
        app: reviews
        version: v3
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v3:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.2
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
```

release/canary/flagger/reviews-hpa.yaml 

kubectl  apply -f reviews-hpa.yaml  -n istio

```
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: review-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  minReplicas: 1
  maxReplicas: 2
  targetCPUUtilizationPercentage: 180
```

release/canary/flagger/canary-reviews-autoscalerRef.yaml

kubectl apply -f canary-reviews-autoscalerRef.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  autoscalerRef:
    apiVersion: autoscaling/v1
    kind: HorizontalPodAutoscaler
    name: review-hpa
  service:
    port: 9080
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2

执行请求：
go-stress-testing -n 10000 -c 5 -u http://192.168.229.134:30468/reviews/0

发生了hpa：
reviews-v1-85d4f9f455-cvl7w           2/2     Running   0          21s
reviews-v1-85d4f9f455-jft2f           2/2     Running   0          113s
reviews-v1-primary-84c6698dc5-lz6bp   2/2     Running   0          22s
reviews-v1-primary-84c6698dc5-xx6tm   2/2     Running   0          4m53s

 kubectl describe canary bookinfo -n istio

  Type     Reason  Age                From     Message
  ----     ------  ----               ----     -------
  Warning  Synced  14m                flagger  reviews-v1-primary.istio not ready: waiting for rollout to finish: observed deployment generation less than desired generation
  Normal   Synced  13m (x2 over 14m)  flagger  all the metrics providers are available!
  Normal   Synced  13m                flagger  Initialization done! bookinfo.istio
  Normal   Synced  8m3s               flagger  New revision detected! Scaling up reviews-v1.istio
  Normal   Synced  7m3s               flagger  Starting canary analysis for reviews-v1.istio
  Normal   Synced  7m3s               flagger  Advance bookinfo.istio canary weight 20
  Warning  Synced  6m3s               flagger  Halt advancement no values found for istio metric request-success-rate probably reviews-v1.istio is not receiving traffic: running query failed: no values found
  Normal   Synced  5m3s               flagger  Advance bookinfo.istio canary weight 40
  Warning  Synced  4m3s               flagger  Halt bookinfo.istio advancement request duration 795ms > 500ms
  Normal   Synced  3m3s               flagger  Advance bookinfo.istio canary weight 60
  Normal   Synced  2m3s               flagger  Copying reviews-v1.istio template spec to reviews-v1-primary.istio
  Normal   Synced  63s                flagger  Routing all traffic to primary
  Normal   Synced  3s                 flagger  (combined from similar events): Promotion completed! Scaling down reviews-v1.istio


```

清理：

kubectl delete canary bookinfo -n istio

kubectl delete hpa review-hpa -n istio





###### service

1name

Kubernetes service name

release/canary/flagger/canary-reviews-service-name.yaml

kubectl apply -f canary-reviews-service-name.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
svc的名字
reviews-canary              ClusterIP   10.68.246.93    <none>        9080/TCP                        9m12s
reviews-primary             ClusterIP   10.68.131.56    <none>        9080/TCP                        9m12s

kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2

执行请求：
go-stress-testing -n 10000 -c 5 -u http://192.168.229.134:30468/reviews/0

kubectl describe canary bookinfo -n istio

  Type     Reason  Age                From     Message
  ----     ------  ----               ----     -------
  Warning  Synced  11m                flagger  reviews-v1-primary.istio not ready: waiting for rollout to finish: observed deployment generation less than desired generation
  Normal   Synced  10m (x2 over 11m)  flagger  all the metrics providers are available!
  Normal   Synced  10m                flagger  Initialization done! bookinfo.istio
  Normal   Synced  8m7s               flagger  New revision detected! Scaling up reviews-v1.istio
  Normal   Synced  7m7s               flagger  Starting canary analysis for reviews-v1.istio
  Normal   Synced  7m6s               flagger  Advance bookinfo.istio canary weight 20
  Normal   Synced  6m6s               flagger  Advance bookinfo.istio canary weight 40
  Normal   Synced  4m6s               flagger  Advance bookinfo.istio canary weight 60
  Normal   Synced  3m6s               flagger  Copying reviews-v1.istio template spec to reviews-v1-primary.istio
  Normal   Synced  2m7s               flagger  Routing all traffic to primary
  Normal   Synced  67s                flagger  (combined from similar events): Promotion completed! Scaling down reviews-v1.istio
```

清理：

kubectl delete canary bookinfo -n istio



2portDiscovery

自动发现port

release/canary/flagger/canary-reviews-service-portDiscovery.yaml

kubectl apply -f canary-reviews-service-portDiscovery.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    portDiscovery: true
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2

执行请求：
go-stress-testing -n 10000 -c 5 -u http://192.168.229.134:30468/reviews/0


kubectl describe canary bookinfo -n istio

  Type     Reason  Age                 From     Message
  ----     ------  ----                ----     -------
  Warning  Synced  10m                 flagger  reviews-v1-primary.istio not ready: waiting for rollout to finish: observed deployment generation less than desired generation
  Normal   Synced  9m3s (x2 over 10m)  flagger  all the metrics providers are available!
  Normal   Synced  9m2s                flagger  Initialization done! bookinfo.istio
  Normal   Synced  6m3s                flagger  New revision detected! Scaling up reviews-v1.istio
  Normal   Synced  5m2s                flagger  Starting canary analysis for reviews-v1.istio
  Normal   Synced  5m2s                flagger  Advance bookinfo.istio canary weight 20
  Normal   Synced  4m2s                flagger  Advance bookinfo.istio canary weight 40
  Normal   Synced  3m3s                flagger  Advance bookinfo.istio canary weight 60
  Normal   Synced  2m3s                flagger  Copying reviews-v1.istio template spec to reviews-v1-primary.istio
  Normal   Synced  63s                 flagger  Routing all traffic to primary
  Normal   Synced  3s                  flagger  (combined from similar events): Promotion completed! Scaling down reviews-v1.istio
```

清理：

kubectl delete canary bookinfo -n istio



3portName

release/canary/flagger/canary-reviews-service-portName.yaml

kubectl apply -f canary-reviews-service-portName.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    portName: http-reviews-x
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


kubectl get svc -n istio reviews-primary -o yaml
spec:
  clusterIP: 10.68.4.21
  clusterIPs:
  - 10.68.4.21
  ports:
  - name: http-reviews-x
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
  sessionAffinity: None
  type: ClusterIP
  
  Type     Reason  Age                From     Message
  ----     ------  ----               ----     -------
  Warning  Synced  17m                flagger  reviews-v1-primary.istio not ready: waiting for rollout to finish: observed deployment generation less than desired generation
  Normal   Synced  16m (x2 over 17m)  flagger  all the metrics providers are available!
  Normal   Synced  16m                flagger  Initialization done! bookinfo.istio
  Normal   Synced  15m                flagger  New revision detected! Scaling up reviews-v1.istio
  Normal   Synced  14m                flagger  Starting canary analysis for reviews-v1.istio
  Normal   Synced  14m                flagger  Advance bookinfo.istio canary weight 20
  Normal   Synced  13m                flagger  Advance bookinfo.istio canary weight 40
  Normal   Synced  12m                flagger  Advance bookinfo.istio canary weight 60
  Normal   Synced  11m                flagger  Copying reviews-v1.istio template spec to reviews-v1-primary.istio
  Normal   Synced  10m                flagger  Routing all traffic to primary
  Normal   Synced  9m10s              flagger  (combined from similar events): Promotion completed! Scaling down reviews-v1.istio
```

清理：

kubectl delete canary bookinfo -n istio



4apex

vs labels and annotations

release/canary/flagger/canary-reviews-service-apex.yaml

kubectl apply -f canary-reviews-service-apex.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    apex:
      annotations:
        test: "test"
      labels:
        test: "test"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
[root@node01 ~]# kubectl get vs -n istio reviews -o yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  annotations:
    kustomize.toolkit.fluxcd.io/reconcile: disabled
    test: test
  creationTimestamp: "2022-04-11T06:03:07Z"
  generation: 1
  labels:
    app: reviews
    test: test
  name: reviews
  namespace: istio
  ownerReferences:
  - apiVersion: flagger.app/v1beta1
    blockOwnerDeletion: true
    controller: true
    kind: Canary
    name: bookinfo
    uid: f18bc15d-9560-480b-b270-a03118a14672
  resourceVersion: "6050928"
  uid: c35cce5d-e26d-47c1-9464-5c7bcec95ead
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2

执行请求：
go-stress-testing -n 10000 -c 5 -u http://192.168.229.134:30468/reviews/0


kubectl describe canary bookinfo -n istio


  Type     Reason  Age                  From     Message
  ----     ------  ----                 ----     -------
  Warning  Synced  9m6s                 flagger  reviews-v1-primary.istio not ready: waiting for rollout to finish: observed deployment generation less than desired generation
  Normal   Synced  8m7s (x2 over 9m7s)  flagger  all the metrics providers are available!
  Normal   Synced  8m6s                 flagger  Initialization done! bookinfo.istio
  Normal   Synced  6m7s                 flagger  New revision detected! Scaling up reviews-v1.istio
  Normal   Synced  5m7s                 flagger  Starting canary analysis for reviews-v1.istio
  Normal   Synced  5m7s                 flagger  Advance bookinfo.istio canary weight 20
  Normal   Synced  4m7s                 flagger  Advance bookinfo.istio canary weight 40
  Normal   Synced  3m7s                 flagger  Advance bookinfo.istio canary weight 60
  Normal   Synced  2m7s                 flagger  Copying reviews-v1.istio template spec to reviews-v1-primary.istio
  Normal   Synced  67s                  flagger  Routing all traffic to primary
  Normal   Synced  7s                   flagger  (combined from similar events): Promotion completed! Scaling down reviews-v1.istio
```

清理：

kubectl delete canary bookinfo -n istio



5canary，primary

release/canary/flagger/canary-reviews-service-canary-primary.yaml

kubectl apply -f canary-reviews-service-canary-primary.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    canary:
      annotations:
        test: "test"
      labels:
        test: "test"
    primary:
      annotations:
        test: "test"
      labels:
        test: "test"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2

执行请求：
go-stress-testing -n 10000 -c 5 -u http://192.168.229.134:30468/reviews/0

kubectl describe canary bookinfo -n istio


kubectl get svc -n istio reviews-canary -o yaml
apiVersion: v1
kind: Service
metadata:
  annotations:
    test: test
  creationTimestamp: "2021-08-30T06:41:17Z"
  labels:
    app: reviews-canary
    test: test
    
kubectl get svc -n istio reviews-primary -o yaml
apiVersion: v1
kind: Service
metadata:
  annotations:
    test: test
  creationTimestamp: "2021-08-30T06:41:18Z"
  labels:
    app: reviews-primary
    test: test

  Type     Reason  Age                From     Message
  ----     ------  ----               ----     -------
  Warning  Synced  35m                flagger  reviews-v1-primary.istio not ready: waiting for rollout to finish: observed deployment generation less than desired generation
  Normal   Synced  34m (x2 over 35m)  flagger  all the metrics providers are available!
  Normal   Synced  34m                flagger  Initialization done! bookinfo.istio
  Normal   Synced  7m42s              flagger  New revision detected! Scaling up reviews-v1.istio
  Normal   Synced  6m42s              flagger  Starting canary analysis for reviews-v1.istio
  Normal   Synced  6m42s              flagger  Advance bookinfo.istio canary weight 20
  Normal   Synced  5m42s              flagger  Advance bookinfo.istio canary weight 40
  Normal   Synced  4m41s              flagger  Advance bookinfo.istio canary weight 60
  Normal   Synced  3m42s              flagger  Copying reviews-v1.istio template spec to reviews-v1-primary.istio
  Normal   Synced  2m42s              flagger  Routing all traffic to primary
  Normal   Synced  102s               flagger  Promotion completed! Scaling down reviews-v1.istio
```

清理：

kubectl delete canary bookinfo -n istio



6targetPort

release/canary/flagger/canary-reviews-service-targetPort.yaml

kubectl apply -f canary-reviews-service-targetPort.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9999
    name: reviews
    targetPort: 9080
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```


kubectl get svc -n istio reviews-primary -o yaml
spec:
  clusterIP: 10.68.147.119
  clusterIPs:
  - 10.68.147.119
  ipFamilies:
  - IPv4
  ipFamilyPolicy: SingleStack
  ports:
  - name: http
    port: 9999
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews-primary
  sessionAffinity: None
  type: ClusterIP

kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2

执行请求：
go-stress-testing -n 10000 -c 5 -u http://192.168.229.134:30468/reviews/0

kubectl describe canary bookinfo -n istio

  Type     Reason  Age                    From     Message
  ----     ------  ----                   ----     -------
  Warning  Synced  9m23s                  flagger  reviews-v1-primary.istio not ready: waiting for rollout to finish: observed deployment generation less than desired generation
  Normal   Synced  8m24s (x2 over 9m24s)  flagger  all the metrics providers are available!
  Normal   Synced  8m23s                  flagger  Initialization done! bookinfo.istio
  Normal   Synced  7m24s                  flagger  New revision detected! Scaling up reviews-v1.istio
  Normal   Synced  6m24s                  flagger  Starting canary analysis for reviews-v1.istio
  Normal   Synced  6m24s                  flagger  Advance bookinfo.istio canary weight 20
  Normal   Synced  4m24s                  flagger  Advance bookinfo.istio canary weight 40
  Normal   Synced  3m24s                  flagger  Advance bookinfo.istio canary weight 60
  Normal   Synced  2m24s                  flagger  Copying reviews-v1.istio template spec to reviews-v1-primary.istio
  Normal   Synced  84s                    flagger  Routing all traffic to primary
  Normal   Synced  23s                    flagger  (combined from similar events): Promotion completed! Scaling down reviews-v1.istio
```

清理：

kubectl delete canary bookinfo -n istio



7timeout

release/canary/flagger/canary-reviews-service-timeout.yaml

kubectl apply -f canary-reviews-service-timeout.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    timeout: 1s
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


kubectl get vs -n istio reviews -o yaml
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0
    timeout: 1s

```

清理：

kubectl delete canary bookinfo -n istio



8delegation

release/canary/flagger/canary-reviews-service-delegation.yaml

kubectl apply -f canary-reviews-service-delegation.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    delegation: true
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


kubectl get vs -n istio reviews -o yaml
spec:
  hosts: []
  http:
  - route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0
```

清理：

kubectl delete canary bookinfo -n istio





9headers

[1]request

release/canary/flagger/canary-reviews-service-headers-request.yaml

kubectl apply -f canary-reviews-service-headers-request.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    headers:
      request:
        add:
          test: test
        remove:
        - test2
        set: 
          test3: test
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - headers:
      request:
        add:
          test: test
        remove:
        - test2
        set:
          test3: test
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0
```

清理：

kubectl delete canary bookinfo -n istio





[2]response

release/canary/flagger/canary-reviews-service-headers-response.yaml

kubectl apply -f canary-reviews-service-headers-response.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    headers:
      response:
        add:
          test: test
        remove:
        - test2
        set: 
          test3: test
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


kubectl get vs -n istio reviews -o yaml
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - headers:
      response:
        add:
          test: test
        remove:
        - test2
        set:
          test3: test
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio



10match

和istio差不多

[1]authority

exact

release/canary/flagger/canary-reviews-service-match-authority-exact.yaml

kubectl apply -f canary-reviews-service-match-authority-exact.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - authority:
        exact: "bookinfo.demo:31110"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m

```



```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


kubectl get vs -n istio reviews -o yaml
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - authority:
        exact: bookinfo.demo:31110
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0
```

清理：

kubectl delete canary bookinfo -n istio



prefix

release/canary/flagger/canary-reviews-service-match-authority-prefix.yaml

kubectl apply -f canary-reviews-service-match-authority-prefix.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - authority:
        prefix: "bookinfo"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - authority:
        prefix: bookinfo
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio





regex

release/canary/flagger/canary-reviews-service-match-authority-regex.yaml

kubectl apply -f canary-reviews-service-match-authority-regex.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - authority:
        regex: "bookinfo.de.*"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - authority:
        regex: bookinfo.de.*
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0
 

```

清理：

kubectl delete canary bookinfo -n istio



[2]gateways

release/canary/flagger/canary-reviews-service-match-gateways.yaml

kubectl apply -f canary-reviews-service-match-gateways.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - gateways:
      - bookinfo-gateway-02
    gateways:
    - istio/bookinfo-gateway
    - istio/bookinfo-gateway-02
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 spec:
  gateways:
  - istio/bookinfo-gateway
  - istio/bookinfo-gateway-02
  hosts:
  - '*'
  http:
  - match:
    - gateways:
      - bookinfo-gateway-02
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0
 

```

清理：

kubectl delete canary bookinfo -n istio





[3]headers

cookie

release/canary/flagger/canary-reviews-service-match-headers-cookie.yaml

kubectl apply -f canary-reviews-service-match-headers-cookie.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - headers:
        cookie:
          regex: "^(.*?;)?(session=.*)(;.*)?$"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - headers:
        cookie:
          regex: ^(.*?;)?(session=.*)(;.*)?$
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio



exact

release/canary/flagger/canary-reviews-service-match-headers-exact.yaml

kubectl apply -f canary-reviews-service-match-headers-exact.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - headers:
        end-user:
          exact: mark
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - headers:
        end-user:
          exact: mark
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0
 

```

清理：

kubectl delete canary bookinfo -n istio



prefix

release/canary/flagger/canary-reviews-service-match-headers-prefix.yaml

kubectl apply -f canary-reviews-service-match-headers-prefix.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - headers:
        end-user:
          prefix: ma
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - headers:
        end-user:
          prefix: ma
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio



regex

release/canary/flagger/canary-reviews-service-match-headers-regex.yaml

kubectl apply -f canary-reviews-service-match-headers-regex.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - headers:
        end-user:
          regex: "m.*k"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - headers:
        end-user:
          regex: m.*k
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio



user-agent

release/canary/flagger/canary-reviews-service-match-headers-user-agent.yaml

kubectl apply -f canary-reviews-service-match-headers-user-agent.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - headers:
        user-agent:
          regex: ".*Chrome.*"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - headers:
        user-agent:
          regex: .*Chrome.*
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio





[4]ignoreUriCase

release/canary/flagger/canary-reviews-service-match-ignoreUriCase.yaml

kubectl apply -f canary-reviews-service-match-ignoreUriCase.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - uri:
        exact: "/pRODUCTPAGE"
      ignoreUriCase: true
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - ignoreUriCase: true
      uri:
        exact: /pRODUCTPAGE
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio





[5]method

exact

release/canary/flagger/canary-reviews-service-match-method-exact.yaml

kubectl apply -f canary-reviews-service-match-method-exact.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - method:
        exact: "GET"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - method:
        exact: GET
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio





prefix

release/canary/flagger/canary-reviews-service-match-method-prefix.yaml

kubectl apply -f canary-reviews-service-match-method-prefix.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - method:
        prefix: "G"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - method:
        prefix: G
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0
 

```

清理：

kubectl delete canary bookinfo -n istio





regex

release/canary/flagger/canary-reviews-service-match-method-regex.yaml

kubectl apply -f canary-reviews-service-match-method-regex.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - method:
        regex: "G.*T"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - method:
        regex: G.*T
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0
```

清理：

kubectl delete canary bookinfo -n istio





[6]name

release/canary/flagger/canary-reviews-service-match-name.yaml

kubectl apply -f canary-reviews-service-match-name.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - uri:
        exact: /productpage
      name: book
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - name: book
      uri:
        exact: /productpage
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0
 

```

清理：

kubectl delete canary bookinfo -n istio





[7]port

release/canary/flagger/canary-reviews-service-match-port.yaml

kubectl apply -f canary-reviews-service-match-port.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - port: 80
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - port: 80
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio





[8]queryParams

exact

release/canary/flagger/canary-reviews-service-match-queryParams-exact.yaml

kubectl apply -f canary-reviews-service-match-queryParams-exact.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - queryParams:
        test:
          exact: test
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - queryParams:
        test:
          exact: test
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio





prefix

release/canary/flagger/canary-reviews-service-match-queryParams-prefix.yaml

kubectl apply -f canary-reviews-service-match-queryParams-prefix.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - queryParams:
        test:
          prefix: mark
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - queryParams:
        test:
          prefix: mark
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio





regex

release/canary/flagger/canary-reviews-service-match-queryParams-regex.yaml

kubectl apply -f canary-reviews-service-match-queryParams-regex.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - queryParams:
        test:
          regex: "\\d+$"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - queryParams:
        test:
          regex: \d+$
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio







[9]scheme

exact

release/canary/flagger/canary-reviews-service-match-scheme-exact.yaml

kubectl apply -f canary-reviews-service-match-scheme-exact.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - scheme:
        exact: "http"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - scheme:
        exact: http
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0
```

清理：

kubectl delete canary bookinfo -n istio





prefix

release/canary/flagger/canary-reviews-service-match-scheme-prefix.yaml

kubectl apply -f canary-reviews-service-match-scheme-prefix.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - scheme:
        prefix: "http"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - scheme:
        prefix: http
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio





regex

release/canary/flagger/canary-reviews-service-match-scheme-regex.yaml

kubectl apply -f canary-reviews-service-match-scheme-regex.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - scheme:
        regex: ".*"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
   gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - scheme:
        regex: .*
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio





[10]sourceLabels

release/canary/flagger/canary-reviews-service-match-sourceLabels.yaml

kubectl apply -f canary-reviews-service-match-sourceLabels.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - sourceLabels:
        app: productpage
        version: v1
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - sourceLabels:
        app: productpage
        version: v1
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio





[11]sourceNamespace

release/canary/flagger/canary-reviews-service-match-sourceNamespace.yaml

kubectl apply -f canary-reviews-service-match-sourceNamespace.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - sourceNamespace: istio-system
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - sourceNamespace: istio-system
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio





[12]uri

exact

release/canary/flagger/canary-reviews-service-match-uri-exact.yaml

kubectl apply -f canary-reviews-service-match-uri-exact.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - uri:
        exact: /productpage
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - uri:
        exact: /productpage
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0
 

```

清理：

kubectl delete canary bookinfo -n istio



prefix

release/canary/flagger/canary-reviews-service-match-uri-prefix.yaml

kubectl apply -f canary-reviews-service-match-uri-prefix.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - uri:
        prefix: /product
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - uri:
        prefix: /product
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio





regex

release/canary/flagger/canary-reviews-service-match-uri-regex.yaml

kubectl apply -f canary-reviews-service-match-uri-regex.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - uri:
        regex: "/p.*e"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - uri:
        regex: /p.*e
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio





[13]withoutHeaders

exact

release/canary/flagger/canary-reviews-service-match-withoutHeaders-exact.yaml

kubectl apply -f canary-reviews-service-match-withoutHeaders-exact.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - withoutHeaders:
        end-user:
          exact: mark
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - withoutHeaders:
        end-user:
          exact: mark
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio





prefix

release/canary/flagger/canary-reviews-service-match-withoutHeaders-prefix.yaml

kubectl apply -f canary-reviews-service-match-withoutHeaders-prefix.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - withoutHeaders:
        end-user:
          prefix: ma
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - withoutHeaders:
        end-user:
          prefix: ma
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio





regex

release/canary/flagger/canary-reviews-service-match-withoutHeaders-regex.yaml

kubectl apply -f canary-reviews-service-match-withoutHeaders-regex.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - withoutHeaders:
        end-user:
          regex: "m.*k"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - withoutHeaders:
        end-user:
          regex: m.*k
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0
```

清理：

kubectl delete canary bookinfo -n istio



11corsPolicy

[1]allowCredentials

release/canary/flagger/canary-reviews-service-corsPolicy-allowCredentials.yaml

kubectl apply -f canary-reviews-service-corsPolicy-allowCredentials.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    corsPolicy:
      allowCredentials: true
      allowOrigins:
      - exact: "http://mytest.com:8081"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - corsPolicy:
      allowCredentials: true
      allowOrigins:
      - exact: http://mytest.com:8081
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio



[2]allowOrigins

exact

上面已有

prefix

release/canary/flagger/canary-reviews-service-corsPolicy-allowOrigins-prefix.yaml

kubectl apply -f canary-reviews-service-corsPolicy-allowOrigins-prefix.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    corsPolicy:
      allowOrigins:
      - prefix: "http://mytest"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - corsPolicy:
      allowOrigins:
      - prefix: http://mytest
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio





regex

release/canary/flagger/canary-reviews-service-corsPolicy-allowOrigins-regex.yaml

kubectl apply -f canary-reviews-service-corsPolicy-allowOrigins-regex.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    corsPolicy:
      allowOrigins:
      - regex: ".*"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - corsPolicy:
      allowOrigins:
      - regex: .*
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio



exposeHeaders

release/canary/flagger/canary-reviews-service-corsPolicy-exposeHeaders.yaml

kubectl apply -f canary-reviews-service-corsPolicy-exposeHeaders.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    corsPolicy:
      allowOrigins:
      - exact: "http://mytest.com:8081"
      exposeHeaders: 
      - test
      - test2
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - corsPolicy:
      allowOrigins:
      - exact: http://mytest.com:8081
      exposeHeaders:
      - test
      - test2
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0
```

清理：

kubectl delete canary bookinfo -n istio





allowHeaders

release/canary/flagger/canary-reviews-service-corsPolicy-allowHeaders.yaml

kubectl apply -f canary-reviews-service-corsPolicy-allowHeaders.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    corsPolicy:
      allowOrigins:
      - exact: "http://mytest.com:8081"
      allowMethods:
      - GET
      - OPTIONS
      allowHeaders:
      - content-type
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - corsPolicy:
      allowHeaders:
      - content-type
      allowMethods:
      - GET
      - OPTIONS
      allowOrigins:
      - exact: http://mytest.com:8081
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio





allowMethods

release/canary/flagger/canary-reviews-service-corsPolicy-allowMethods.yaml

kubectl apply -f canary-reviews-service-corsPolicy-allowMethods.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    corsPolicy:
      allowOrigins:
      - exact: "http://mytest.com:8081"
      allowMethods:
      - DELETE
      - OPTIONS
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - corsPolicy:
      allowMethods:
      - DELETE
      - OPTIONS
      allowOrigins:
      - exact: http://mytest.com:8081
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio





maxAge

release/canary/flagger/canary-reviews-service-corsPolicy-maxAge.yaml

kubectl apply -f canary-reviews-service-corsPolicy-maxAge.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    corsPolicy:
      allowOrigins:
      - exact: "http://mytest.com:8081"
      allowMethods:
      - GET
      - OPTIONS
      maxAge: "10s"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 
 spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - corsPolicy:
      allowMethods:
      - GET
      - OPTIONS
      allowOrigins:
      - exact: http://mytest.com:8081
      maxAge: 10s
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0

```

清理：

kubectl delete canary bookinfo -n istio







12retries

retryOn

release/canary/flagger/canary-reviews-service-retries-retryOn.yaml

kubectl apply -f canary-reviews-service-retries-retryOn.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    retries:
      attempts: 5
      perTryTimeout: 3s
      retryOn: 5xx,connect-failure
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 

spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - retries:
      attempts: 5
      perTryTimeout: 3s
      retryOn: 5xx,connect-failure
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0
```

清理：

kubectl delete canary bookinfo -n istio





retryRemoteLocalities

这个istio有，flagger没有



13rewrite

uri

release/canary/flagger/canary-reviews-service-rewrite-uri.yaml

kubectl apply -f canary-reviews-service-rewrite-uri.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    match:
    - uri:
        regex: "/m.*k"
    rewrite:
      uri: "/productpage"
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


 kubectl get vs -n istio reviews -o yaml
 

spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - uri:
        regex: /m.*k
    rewrite:
      uri: /productpage
    route:
    - destination:
        host: reviews-primary
      weight: 100
    - destination:
        host: reviews-canary
      weight: 0
```

清理：

kubectl delete canary bookinfo -n istio





authority

istio有但是flagger没有



14trafficPolicy

和DestinationRule相关

[1]connectionPool

tcp

istio有flagger没有



1http

release/canary/flagger/trafficPolicy/canary-reviews-trafficPolicy-connectionPool-http.yaml

kubectl apply -f canary-reviews-trafficPolicy-connectionPool-http.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    trafficPolicy:
      connectionPool:
        http:
          http2MaxRequests: 10
          maxRequestsPerConnection: 1
          http1MaxPendingRequests: 1
          maxRetries: 1
          idleTimeout: 10s
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


kubectl get dr -n istio reviews-primary -o yaml
 
spec:
  host: reviews-canary
  trafficPolicy:
    connectionPool:
      http:
        http1MaxPendingRequests: 1
        http2MaxRequests: 10
        idleTimeout: 10s
        maxRequestsPerConnection: 1
        maxRetries: 1

kubectl get dr -n istio reviews-canary -o yaml
spec:
  host: reviews-primary
  trafficPolicy:
    connectionPool:
      http:
        http1MaxPendingRequests: 1
        http2MaxRequests: 10
        idleTimeout: 10s
        maxRequestsPerConnection: 1
        maxRetries: 1

```

清理：

kubectl delete canary bookinfo -n istio



h2UpgradePolicy

DEFAULT

release/canary/flagger/trafficPolicy/canary-reviews-trafficPolicy-connectionPool-http-h2UpgradePolicy-DEFAULT.yaml

kubectl apply -f canary-reviews-trafficPolicy-connectionPool-http-h2UpgradePolicy-DEFAULT.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    trafficPolicy:
      connectionPool:
        http:
          h2UpgradePolicy: DEFAULT
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


kubectl get dr -n istio reviews-primary -o yaml
 
spec:
  host: reviews-primary
  trafficPolicy:
    connectionPool:
      http:
        h2UpgradePolicy: DEFAULT

kubectl get dr -n istio reviews-canary -o yaml

spec:
  host: reviews-canary
  trafficPolicy:
    connectionPool:
      http:
        h2UpgradePolicy: DEFAULT
```

清理：

kubectl delete canary bookinfo -n istio





DO_NOT_UPGRADE

release/canary/flagger/trafficPolicy/canary-reviews-trafficPolicy-connectionPool-http-h2UpgradePolicy-DO_NOT_UPGRADE.yaml

kubectl apply -f canary-reviews-trafficPolicy-connectionPool-http-h2UpgradePolicy-DO_NOT_UPGRADE.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    trafficPolicy:
      connectionPool:
        http:
          h2UpgradePolicy: DO_NOT_UPGRADE
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


kubectl get dr -n istio reviews-primary -o yaml
 
spec:
  host: reviews-primary
  trafficPolicy:
    connectionPool:
      http:
        h2UpgradePolicy: DO_NOT_UPGRADE

kubectl get dr -n istio reviews-canary -o yaml
spec:
  host: reviews-canary
  trafficPolicy:
    connectionPool:
      http:
        h2UpgradePolicy: DO_NOT_UPGRADE

```

清理：

kubectl delete canary bookinfo -n istio









UPGRADE

release/canary/flagger/trafficPolicy/canary-reviews-trafficPolicy-connectionPool-http-h2UpgradePolicy-UPGRADE.yaml

kubectl apply -f canary-reviews-trafficPolicy-connectionPool-http-h2UpgradePolicy-UPGRADE.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    trafficPolicy:
      connectionPool:
        http:
          h2UpgradePolicy: UPGRADE
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


kubectl get dr -n istio reviews-primary -o yaml
 
spec:
  host: reviews-primary
  trafficPolicy:
    connectionPool:
      http:
        h2UpgradePolicy: UPGRADE

kubectl get dr -n istio reviews-canary -o yaml

spec:
  host: reviews-canary
  trafficPolicy:
    connectionPool:
      http:
        h2UpgradePolicy: UPGRADE
```

清理：

kubectl delete canary bookinfo -n istio



useClientProtocol

istio有，flagger没有



2loadBalancer

consistentHash

httpCookie

release/canary/flagger/trafficPolicy/loadBalancer/consistentHash/canary-reviews-trafficPolicy-loadBalancer-consistentHash-httpCookie.yaml

kubectl apply -f canary-reviews-trafficPolicy-loadBalancer-consistentHash-httpCookie.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    trafficPolicy:
      loadBalancer:
        consistentHash:
          httpCookie:
            name: user
            ttl: 0s
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


kubectl get dr -n istio reviews-primary -o yaml
 spec:
  host: reviews-primary
  trafficPolicy:
    loadBalancer:
      consistentHash:
        httpCookie:
          name: user
          ttl: 0s

kubectl get dr -n istio reviews-canary -o yaml
spec:
  host: reviews-canary
  trafficPolicy:
    loadBalancer:
      consistentHash:
        httpCookie:
          name: user
          ttl: 0s
```

清理：

kubectl delete canary bookinfo -n istio





httpHeaderName

release/canary/flagger/trafficPolicy/loadBalancer/consistentHash/canary-reviews-trafficPolicy-loadBalancer-consistentHash-httpHeaderName.yaml

kubectl apply -f canary-reviews-trafficPolicy-loadBalancer-consistentHash-httpHeaderName.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    trafficPolicy:
      loadBalancer:
        consistentHash:
          httpHeaderName: test
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


kubectl get dr -n istio reviews-primary -o yaml
 
spec:
  host: reviews-primary
  trafficPolicy:
    loadBalancer:
      consistentHash:
        httpHeaderName: test
        
kubectl get dr -n istio reviews-canary -o yaml
spec:
  host: reviews-canary
  trafficPolicy:
    loadBalancer:
      consistentHash:
        httpHeaderName: test

```

清理：

kubectl delete canary bookinfo -n istio





httpQueryParameterName

release/canary/flagger/trafficPolicy/loadBalancer/consistentHash/canary-reviews-trafficPolicy-loadBalancer-consistentHash-httpQueryParameterName.yaml

kubectl apply -f canary-reviews-trafficPolicy-loadBalancer-consistentHash-httpQueryParameterName.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    trafficPolicy:
      loadBalancer:
        consistentHash:
          httpQueryParameterName: test
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


kubectl get dr -n istio reviews-primary -o yaml
spec:
  host: reviews-primary
  trafficPolicy:
    loadBalancer:
      consistentHash: {}

kubectl get dr -n istio reviews-canary -o yaml
spec:
  host: reviews-canary
  trafficPolicy:
    loadBalancer:
      consistentHash: {}
      
有问题，consistentHash空了
```

清理：

kubectl delete canary bookinfo -n istio





minimumRingSize

release/canary/flagger/trafficPolicy/loadBalancer/consistentHash/canary-reviews-trafficPolicy-loadBalancer-consistentHash-minimumRingSize.yaml

kubectl apply -f canary-reviews-trafficPolicy-loadBalancer-consistentHash-minimumRingSize.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    trafficPolicy:
      loadBalancer:
        consistentHash:
          minimumRingSize: 1
          httpQueryParameterName: test
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


kubectl get dr -n istio reviews-primary -o yaml
这里丢掉了httpQueryParameterName: test ，可能是bug
 spec:
  host: reviews-primary
  trafficPolicy:
    loadBalancer:
      consistentHash:
        minimumRingSize: 1

kubectl get dr -n istio reviews-canary -o yaml
这里丢掉了httpQueryParameterName: test ，可能是bug
spec:
  host: reviews-canary
  trafficPolicy:
    loadBalancer:
      consistentHash:
        minimumRingSize: 1
```

清理：

kubectl delete canary bookinfo -n istio





useSourceIp

release/canary/flagger/trafficPolicy/loadBalancer/consistentHash/canary-reviews-trafficPolicy-loadBalancer-consistentHash-useSourceIp.yaml

kubectl apply -f canary-reviews-trafficPolicy-loadBalancer-consistentHash-useSourceIp.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    trafficPolicy:
      loadBalancer:
        consistentHash:
          useSourceIp: true
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


kubectl get dr -n istio reviews-primary -o yaml
 spec:
  host: reviews-primary
  trafficPolicy:
    loadBalancer:
      consistentHash:
        useSourceIp: true

kubectl get dr -n istio reviews-canary -o yaml
spec:
  host: reviews-canary
  trafficPolicy:
    loadBalancer:
      consistentHash:
        useSourceIp: true
```

清理：

kubectl delete canary bookinfo -n istio





localityLbSetting

distribute

release/canary/flagger/trafficPolicy/loadBalancer/localityLbSetting/canary-reviews-trafficPolicy-loadBalancer-localityLbSetting-distribute.yaml

kubectl apply -f canary-reviews-trafficPolicy-loadBalancer-localityLbSetting-distribute.yaml -n istio

必须加上simple，istio里不需要加

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN
        localityLbSetting:
          enabled: true
          distribute:
          - from: "us-central2/z2/*"
            to:
              "us-central3/z3/*": 100
              #"us-central2/z2/*": 100
              #"us-central1/z1/*": 100
      outlierDetection:
        consecutive5xxErrors: 1
        interval: 5m
        baseEjectionTime: 15m
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio


kubectl get dr -n istio reviews-primary -o yaml
spec:
  host: reviews-primary
  trafficPolicy:
    loadBalancer:
      localityLbSetting:
        distribute:
        - from: us-central2/z2/*
          to:
            us-central3/z3/*: 100
        enabled: true
      simple: LEAST_CONN
    outlierDetection:
      baseEjectionTime: 15m
      consecutive5xxErrors: 1
      interval: 5m

kubectl get dr -n istio reviews-canary -o yaml
spec:
  host: reviews-canary
  trafficPolicy:
    loadBalancer:
      localityLbSetting:
        distribute:
        - from: us-central2/z2/*
          to:
            us-central3/z3/*: 100
        enabled: true
      simple: LEAST_CONN
    outlierDetection:
      baseEjectionTime: 15m
      consecutive5xxErrors: 1
      interval: 5m

```

清理：

kubectl delete canary bookinfo -n istio





failover

release/canary/flagger/trafficPolicy/loadBalancer/localityLbSetting/canary-reviews-trafficPolicy-loadBalancer-localityLbSetting-failover.yaml

kubectl apply -f canary-reviews-trafficPolicy-loadBalancer-localityLbSetting-failover.yaml -n istio

必须加上simple，istio里不需要加

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN
        localityLbSetting:
          enabled: true
          failover:
          - from: us-central1
            to: us-central2
          - from: us-central2
            to: us-central1
      outlierDetection:
        consecutive5xxErrors: 1
        interval: 5m
        baseEjectionTime: 15m
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio

kubectl get dr -n istio reviews-primary -o yaml
spec:
  host: reviews-primary
  trafficPolicy:
    loadBalancer:
      localityLbSetting:
        enabled: true
        failover:
        - from: us-central1
          to: us-central2
        - from: us-central2
          to: us-central1
      simple: LEAST_CONN
    outlierDetection:
      baseEjectionTime: 15m
      consecutive5xxErrors: 1
      interval: 5m

kubectl get dr -n istio reviews-canary -o yaml
spec:
  host: reviews-canary
  trafficPolicy:
    loadBalancer:
      localityLbSetting:
        enabled: true
        failover:
        - from: us-central1
          to: us-central2
        - from: us-central2
          to: us-central1
      simple: LEAST_CONN
    outlierDetection:
      baseEjectionTime: 15m
      consecutive5xxErrors: 1
      interval: 5m

```

清理：

kubectl delete canary bookinfo -n istio



simple

leastconn

release/canary/flagger/trafficPolicy/loadBalancer/simple/canary-reviews-trafficPolicy-loadBalancer-simple-leastconn.yaml

kubectl apply -f canary-reviews-trafficPolicy-loadBalancer-simple-leastconn.yaml -n istio



```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio

kubectl get dr -n istio reviews-primary -o yaml
spec:
  host: reviews-primary
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN

kubectl get dr -n istio reviews-canary -o yaml
spec:
  host: reviews-canary
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN

```

清理：

kubectl delete canary bookinfo -n istio





random

release/canary/flagger/trafficPolicy/loadBalancer/simple/canary-reviews-trafficPolicy-loadBalancer-simple-random.yaml

kubectl apply -f canary-reviews-trafficPolicy-loadBalancer-simple-random.yaml -n istio



```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    trafficPolicy:
      loadBalancer:
        simple: RANDOM
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio

kubectl get dr -n istio reviews-primary -o yaml
spec:
  host: reviews-primary
  trafficPolicy:
    loadBalancer:
      simple: RANDOM

kubectl get dr -n istio reviews-canary -o yaml
spec:
  host: reviews-canary
  trafficPolicy:
    loadBalancer:
      simple: RANDOM

```

清理：

kubectl delete canary bookinfo -n istio





roundrobin

release/canary/flagger/trafficPolicy/loadBalancer/simple/canary-reviews-trafficPolicy-loadBalancer-simple-roundrobin.yaml

kubectl apply -f canary-reviews-trafficPolicy-loadBalancer-simple-roundrobin.yaml -n istio



```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio

kubectl get dr -n istio reviews-primary -o yaml
spec:
  host: reviews-primary
  trafficPolicy:
    loadBalancer:
      simple: ROUND_ROBIN

kubectl get dr -n istio reviews-canary -o yaml
spec:
  host: reviews-canary
  trafficPolicy:
    loadBalancer:
      simple: ROUND_ROBIN

```

清理：

kubectl delete canary bookinfo -n istio





passthrough

release/canary/flagger/trafficPolicy/loadBalancer/simple/canary-reviews-trafficPolicy-loadBalancer-simple-passthrough.yaml

kubectl apply -f canary-reviews-trafficPolicy-loadBalancer-simple-passthrough.yaml -n istio



```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    trafficPolicy:
      loadBalancer:
        simple: PASSTHROUGH
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio

kubectl get dr -n istio reviews-primary -o yaml
spec:
  host: reviews-primary
  trafficPolicy:
    loadBalancer:
      simple: PASSTHROUGH

kubectl get dr -n istio reviews-canary -o yaml

spec:
  host: reviews-canary
  trafficPolicy:
    loadBalancer:
      simple: PASSTHROUGH
```

清理：

kubectl delete canary bookinfo -n istio



[2]outlierDetection

release/canary/flagger/trafficPolicy/outlierDetection/canary-reviews-trafficPolicy-outlierDetection.yaml

kubectl apply -f canary-reviews-trafficPolicy-outlierDetection.yaml -n istio



```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    trafficPolicy:
      connectionPool:
        http:
          http2MaxRequests: 50
          maxRequestsPerConnection: 5
      outlierDetection:
        consecutiveErrors: 5
        interval: 10s
        baseEjectionTime: 30s
        maxEjectionPercent: 100
        minHealthPercent: 0
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio

kubectl get dr -n istio reviews-primary -o yaml
spec:
  host: reviews-primary
  trafficPolicy:
    connectionPool:
      http:
        http2MaxRequests: 50
        maxRequestsPerConnection: 5
    outlierDetection:
      baseEjectionTime: 30s
      consecutiveErrors: 5
      interval: 10s
      maxEjectionPercent: 100

kubectl get dr -n istio reviews-canary -o yaml

spec:
  host: reviews-canary
  trafficPolicy:
    connectionPool:
      http:
        http2MaxRequests: 50
        maxRequestsPerConnection: 5
    outlierDetection:
      baseEjectionTime: 30s
      consecutiveErrors: 5
      interval: 10s
      maxEjectionPercent: 100
```

清理：

kubectl delete canary bookinfo -n istio





[3]tls

release/canary/flagger/trafficPolicy/tls/canary-reviews-trafficPolicy-tls.yaml

kubectl apply -f canary-reviews-trafficPolicy-tls.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    trafficPolicy:
      tls:
        mode: MUTUAL
        caCertificates: /etc/my-cert/ca.crt
        clientCertificate: /etc/my-cert/tls.crt
        privateKey: /etc/my-cert/tls.key
        sni: reviews.istio.svc.cluster.local
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio

kubectl get dr -n istio reviews-primary -o yaml
spec:
  host: reviews-primary
  trafficPolicy:
    tls:
      caCertificates: /etc/my-cert/ca.crt
      clientCertificate: /etc/my-cert/tls.crt
      mode: MUTUAL
      privateKey: /etc/my-cert/tls.key
      sni: reviews.istio.svc.cluster.local

kubectl get dr -n istio reviews-canary -o yaml
spec:
  host: reviews-canary
  trafficPolicy:
    tls:
      caCertificates: /etc/my-cert/ca.crt
      clientCertificate: /etc/my-cert/tls.crt
      mode: MUTUAL
      privateKey: /etc/my-cert/tls.key
      sni: reviews.istio.svc.cluster.local
```

清理：

kubectl delete canary bookinfo -n istio



mode

DISABLE

release/canary/flagger/trafficPolicy/tls/canary-reviews-trafficPolicy-tls-mode-DISABLE.yaml

kubectl apply -f canary-reviews-trafficPolicy-tls-mode-DISABLE.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    trafficPolicy:
      tls:
        mode: DISABLE
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio

kubectl get dr -n istio reviews-primary -o yaml
spec:
  host: reviews-primary
  trafficPolicy:
    tls:
      mode: DISABLE

kubectl get dr -n istio reviews-canary -o yaml
spec:
  host: reviews-canary
  trafficPolicy:
    tls:
      mode: DISABLE
```

清理：

kubectl delete canary bookinfo -n istio





ISTIO_MUTUAL

release/canary/flagger/trafficPolicy/tls/canary-reviews-trafficPolicy-tls-mode-ISTIO_MUTUAL.yaml

kubectl apply -f canary-reviews-trafficPolicy-tls-mode-ISTIO_MUTUAL.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    trafficPolicy:
      tls:
        mode: ISTIO_MUTUAL
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio

kubectl get dr -n istio reviews-primary -o yaml
spec:
  host: reviews-primary
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL

kubectl get dr -n istio reviews-canary -o yaml
spec:
  host: reviews-canary
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL
```

清理：

kubectl delete canary bookinfo -n istio



credentialName

istio支持，flagger不支持



subjectAltNames

release/canary/flagger/trafficPolicy/tls/canary-reviews-trafficPolicy-tls-subjectAltNames.yaml

kubectl apply -f canary-reviews-trafficPolicy-tls-subjectAltNames.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  provider: istio
  service:
    port: 9080
    name: reviews
    trafficPolicy:
      tls:
        mode: SIMPLE
        caCertificates: /etc/my-cert/ca.crt
        sni: productpage.istio.svc.cluster.local
        subjectAltNames: 
        - spiffe://cluster.local/ns/istio/sa/bookinfo-productpage
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2


kubectl describe canary bookinfo -n istio

kubectl get dr -n istio reviews-primary -o yaml
spec:
  host: reviews-primary
  trafficPolicy:
    tls:
      caCertificates: /etc/my-cert/ca.crt
      mode: SIMPLE
      sni: productpage.istio.svc.cluster.local
      subjectAltNames:
      - spiffe://cluster.local/ns/istio/sa/bookinfo-productpage

kubectl get dr -n istio reviews-canary -o yaml
spec:
  host: reviews-canary
  trafficPolicy:
    tls:
      caCertificates: /etc/my-cert/ca.crt
      mode: SIMPLE
      sni: productpage.istio.svc.cluster.local
      subjectAltNames:
      - spiffe://cluster.local/ns/istio/sa/bookinfo-productpage
```

清理：

kubectl delete canary bookinfo -n istio



###### analysis

[1]stepWeightPromotion

release/canary/flagger/canary-reviews-stepWeightPromotion.yaml

kubectl apply -f canary-reviews-stepWeightPromotion.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  service:
    port: 9080
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    stepWeightPromotion: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
```





```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2

go-stress-testing -n 10000000 -c 5 -u http://192.168.229.134:32542/reviews/0

kubectl describe canary bookinfo -n istio

   Type     Reason  Age                  From     Message
  ----     ------  ----                 ----     -------
  Warning  Synced  11m                  flagger  reviews-v1-primary.istio not ready: waiting for rollout to finish: observed deployment generation less than desired generation
  Normal   Synced  10m (x2 over 11m)    flagger  all the metrics providers are available!
  Normal   Synced  10m                  flagger  Initialization done! bookinfo.istio
  Normal   Synced  9m14s                flagger  New revision detected! Scaling up reviews-v1.istio
  Normal   Synced  8m14s                flagger  Starting canary analysis for reviews-v1.istio
  Normal   Synced  8m14s                flagger  Advance bookinfo.istio canary weight 20
  Normal   Synced  7m14s                flagger  Advance bookinfo.istio canary weight 40
  Warning  Synced  6m14s                flagger  Halt bookinfo.istio advancement request duration 4.315s > 500ms
  Normal   Synced  5m14s                flagger  Advance bookinfo.istio canary weight 60
  Normal   Synced  4m14s                flagger  Copying reviews-v1.istio template spec to reviews-v1-primary.istio
  Normal   Synced  3m14s                flagger  Advance bookinfo.istio primary weight 60
  Normal   Synced  14s (x3 over 2m14s)  flagger  (combined from similar events): Promotion completed! Scaling down reviews-v1.istio

```

清理：

kubectl delete canary bookinfo -n istio



[2]metrics

 Builtin metrics 

略



 Custom metrics 

release/canary/flagger/canary-reviews-metrics-Custom.yaml

kubectl apply -f canary-reviews-metrics-Custom.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  service:
    port: 9080
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: "my metric"
        thresholdRange:
          min: 0
          max: 10
        interval: 1m
        query: |
          100 - sum(
               rate(
                    istio_requests_total{
                      reporter="destination",
                      destination_workload_namespace="{{ namespace }}",
                      destination_workload="{{ target }}",
                      response_code!="404"
                    }[{{ interval }}]
                )
            )
            /
            sum(
                rate(
                    istio_requests_total{
                      reporter="destination",
                      destination_workload_namespace="{{ namespace }}",
                      destination_workload="{{ target }}"
                    }[{{ interval }}]
                )
            ) * 100
        

```





```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2

go-stress-testing -n 10000000 -c 5 -u http://192.168.229.134:32542/reviews/0

kubectl describe canary bookinfo -n istio


Events:
  Type     Reason  Age                  From     Message
  ----     ------  ----                 ----     -------
  Warning  Synced  8m3s                 flagger  reviews-v1-primary.istio not ready: waiting for rollout to finish: observed deployment generation less than desired generation
  Normal   Synced  7m3s (x2 over 8m3s)  flagger  all the metrics providers are available!
  Normal   Synced  7m2s                 flagger  Initialization done! bookinfo.istio
  Normal   Synced  6m3s                 flagger  New revision detected! Scaling up reviews-v1.istio
  Normal   Synced  5m3s                 flagger  Starting canary analysis for reviews-v1.istio
  Normal   Synced  5m3s                 flagger  Advance bookinfo.istio canary weight 20
  Normal   Synced  4m3s                 flagger  Advance bookinfo.istio canary weight 40
  Normal   Synced  3m3s                 flagger  Advance bookinfo.istio canary weight 60
  Normal   Synced  2m3s                 flagger  Copying reviews-v1.istio template spec to reviews-v1-primary.istio
  Normal   Synced  63s                  flagger  Routing all traffic to primary
  Normal   Synced  3s                   flagger  (combined from similar events): Promotion completed! Scaling down reviews-v1.istio
```

清理：

kubectl delete canary bookinfo -n istio



threshold

release/canary/flagger/canary-reviews-metrics-Custom-threshold.yaml

kubectl apply -f canary-reviews-metrics-Custom-threshold.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  service:
    port: 9080
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: "my metric"
        threshold: 10
        interval: 1m
        query: |
          100 - sum(
               rate(
                    istio_requests_total{
                      reporter="destination",
                      destination_workload_namespace="{{ namespace }}",
                      destination_workload="{{ target }}",
                      response_code!="404"
                    }[{{ interval }}]
                )
            )
            /
            sum(
                rate(
                    istio_requests_total{
                      reporter="destination",
                      destination_workload_namespace="{{ namespace }}",
                      destination_workload="{{ target }}"
                    }[{{ interval }}]
                )
            ) * 100
        

```





```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2

执行请求：
go-stress-testing -n 10000 -c 5 -u http://192.168.229.134:30468/reviews/0

kubectl describe canary bookinfo -n istio

Events:
  Type     Reason  Age                From     Message
  ----     ------  ----               ----     -------
  Warning  Synced  11m                flagger  reviews-v1-primary.istio not ready: waiting for rollout to finish: observed deployment generation less than desired generation
  Normal   Synced  10m (x2 over 11m)  flagger  all the metrics providers are available!
  Normal   Synced  10m                flagger  Initialization done! bookinfo.istio
  Normal   Synced  9m44s              flagger  New revision detected! Scaling up reviews-v1.istio
  Normal   Synced  8m44s              flagger  Starting canary analysis for reviews-v1.istio
  Normal   Synced  8m44s              flagger  Advance bookinfo.istio canary weight 20
  Normal   Synced  7m44s              flagger  Advance bookinfo.istio canary weight 40
  Normal   Synced  6m44s              flagger  Advance bookinfo.istio canary weight 60
  Normal   Synced  5m44s              flagger  Copying reviews-v1.istio template spec to reviews-v1-primary.istio
  Normal   Synced  4m44s              flagger  Routing all traffic to primary
  Normal   Synced  3m44s              flagger  (combined from similar events): Promotion completed! Scaling down reviews-v1.istio
```

清理：

kubectl delete canary bookinfo -n istio



[3]webhooks

There are several types of hooks:

- **confirm-rollout** hooks are executed before scaling up the canary deployment and can be used for manual approval. The rollout is paused until the hook returns a successful HTTP status code.
- **pre-rollout** hooks are executed before routing traffic to canary. The canary advancement is paused if a pre-rollout hook fails and if the number of failures reach the threshold the canary will be rollback.
- **rollout** hooks are executed during the analysis on each iteration before the metric checks. If a rollout hook call fails the canary advancement is paused and eventfully rolled back.
- **confirm-traffic-increase** hooks are executed right before the weight on the canary is increased. The canary advancement is paused until this hook returns HTTP 200.
- **confirm-promotion** hooks are executed before the promotion step. The canary promotion is paused until the hooks return HTTP 200. While the promotion is paused, Flagger will continue to run the metrics checks and rollout hooks.
- **post-rollout** hooks are executed after the canary has been promoted or rolled back. If a post rollout hook fails the error is logged.
- **rollback** hooks are executed while a canary deployment is in either Progressing or Waiting status. This provides the ability to rollback during analysis or while waiting for a confirmation. If a rollback hook returns a successful HTTP status code, Flagger will stop the analysis and mark the canary release as failed.
- **event** hooks are executed every time Flagger emits a Kubernetes event. When configured, every action that Flagger takes during a canary deployment will be sent as JSON via an HTTP POST request.



安装loadtester

 helm pull flagger/loadtester 

```
[root@master01 flagger]# tree loadtester/
loadtester/
├── Chart.yaml
├── README.md
├── templates
│   ├── appmesh.yaml
│   ├── deployment.yaml
│   ├── _helpers.tpl
│   ├── istio-gw.yaml
│   ├── istio-vs.yaml
│   ├── NOTES.txt
│   ├── pdb.yaml
│   ├── rbac.yaml
│   ├── service.yaml
│   └── virtual-node.yaml
└── values.yaml


helm upgrade -i flagger loadtester --namespace=istio-system --set cmd.timeout=1h
```



release/canary/flagger/canary-reviews-webhooks.yaml

kubectl apply -f canary-reviews-webhooks.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  service:
    port: 9080
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
    webhooks:
      - name: "start gate"
        type: confirm-rollout
        url: http://flagger-loadtester.istio-system/gate/approve
#      - name: "helm test"
#        type: pre-rollout
#        url: http://flagger-loadtester.istio-system/
#        timeout: 3m
#        metadata:
#          type: "helmv3"
#          cmd: "test reviews -n istio"
      - name: "load test"
        type: rollout
        url: http://flagger-loadtester.istio-system/
        timeout: 15s
        metadata:
          cmd: "hey -z 1m -q 5 -c 2 http://reviews.istio:9080/reviews/0/"
      - name: "traffic increase gate"
        type: confirm-traffic-increase
        url: http://flagger-loadtester.istio-system/gate/approve
      - name: "promotion gate"
        type: confirm-promotion
        url: http://flagger-loadtester.istio-system/gate/approve
#      - name: "notify"
#        type: post-rollout
#        url: http://telegram.bot:8080/
#        timeout: 5s
#        metadata:
#          some: "message"
      - name: "rollback gate"
        type: rollback
        url: http://flagger-loadtester.istio-system/rollback/check
#      - name: "send to Slack"
#        type: event
#        url: http://event-recevier.notifications/slack
#        metadata:
#          environment: "test"
#          cluster: "flagger-test"
        

```





```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2

go-stress-testing -n 10000 -c 5 -u http://192.168.229.134:30468/reviews/0


kubectl describe canary bookinfo -n istio

 Type     Reason  Age                    From     Message
  ----     ------  ----                   ----     -------
  Normal   Synced  11m (x2 over 156m)     flagger  New revision detected! Scaling up reviews-v1.istio
  Normal   Synced  10m (x2 over 155m)     flagger  Starting canary analysis for reviews-v1.istio
  Normal   Synced  10m (x2 over 155m)     flagger  Advance bookinfo.istio canary weight 20
  Warning  Synced  8m35s (x2 over 9m35s)  flagger  Halt advancement no values found for istio metric request-success-rate probably reviews-v1.istio is not receiving traffic: running query failed: no values found
  Normal   Synced  7m35s                  flagger  Advance bookinfo.istio canary weight 40
  Normal   Synced  6m35s                  flagger  Advance bookinfo.istio canary weight 60
  Normal   Synced  5m35s (x6 over 10m)    flagger  Rollback hook rollback gate not signaling a rollback
  Normal   Synced  5m35s (x4 over 10m)    flagger  Confirm-traffic-increase check traffic increase gate passed
  Normal   Synced  5m35s                  flagger  Confirm-promotion check promotion gate passed
  Normal   Synced  5m35s                  flagger  Copying reviews-v1.istio template spec to reviews-v1-primary.istio
  Normal   Synced  3m35s (x2 over 4m35s)  flagger  (combined from similar events): Promotion completed! Scaling down reviews-v1.istio

```

清理：

kubectl delete canary bookinfo -n istio



rollout

release/canary/flagger/reviews-deploy-with-resources.yaml 

kubectl apply -f reviews-deploy-with-resources.yaml  -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: reviews
  labels:
    app: reviews
    service: reviews
spec:
  ports:
  - port: 9080
    name: http
  selector:
    app: reviews
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: bookinfo-reviews
  labels:
    account: reviews
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: reviews-v2
  labels:
    app: reviews
    version: v2
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v2
  template:
    metadata:
      labels:
        app: reviews
        version: v2
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v2:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: reviews-v3
  labels:
    app: reviews
    version: v3
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v3
  template:
    metadata:
      labels:
        app: reviews
        version: v3
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v3:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
```

release/canary/flagger/reviews-hpa.yaml 

kubectl  apply -f reviews-hpa.yaml  -n istio

```
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: review-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  minReplicas: 1
  maxReplicas: 2
  targetCPUUtilizationPercentage: 50
```

release/canary/flagger/canary-reviews-webhook-rollout.yaml

kubectl apply -f canary-reviews-webhook-rollout.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  autoscalerRef:
    apiVersion: autoscaling/v1
    kind: HorizontalPodAutoscaler
    name: review-hpa
  service:
    port: 9080
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
    webhooks:
      - name: "start gate"
        type: confirm-rollout
        url: http://flagger-loadtester.istio-system/gate/approve
#      - name: "helm test"
#        type: pre-rollout
#        url: http://flagger-loadtester.istio-system/
#        timeout: 3m
#        metadata:
#          type: "helmv3"
#          cmd: "test reviews -n istio"
      - name: "load test"
        type: rollout
        url: http://flagger-loadtester.istio-system/
        timeout: 15s
        metadata:
          cmd: "hey -z 1m -q 5 -c 2 http://reviews.istio:9080/reviews/0/"
      - name: "traffic increase gate"
        type: confirm-traffic-increase
        url: http://flagger-loadtester.istio-system/gate/approve
      - name: "promotion gate"
        type: confirm-promotion
        url: http://flagger-loadtester.istio-system/gate/approve
      - name: "notify"
        type: post-rollout
        url: https://hooks.slack.com/services/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
        timeout: 5s
        metadata:
          some: "message"
      - name: "rollback gate"
        type: rollback
        url: http://flagger-loadtester.istio-system/rollback/check
      - name: "send to Slack"
        type: event
        url: https://hooks.slack.com/services/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
        metadata:
          environment: "test"
          cluster: "flagger-test" 
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2



启用压测
go-stress-testing -c 10 -n 1000000 -u http://bookinfo.com:31773/reviews/0

 kubectl describe canary bookinfo -n istio

  Type     Reason  Age                    From     Message
  ----     ------  ----                   ----     -------
  Normal   Synced  8m33s                  flagger  Confirm-rollout check start gate passed
  Normal   Synced  7m33s                  flagger  New revision detected! Restarting analysis for reviews-v1.istio
  Normal   Synced  6m33s                  flagger  Starting canary analysis for reviews-v1.istio
  Normal   Synced  6m32s                  flagger  Advance bookinfo.istio canary weight 20
  Warning  Synced  5m33s                  flagger  Halt bookinfo.istio advancement request duration 606ms > 500ms
  Normal   Synced  4m32s                  flagger  Advance bookinfo.istio canary weight 40
  Normal   Synced  3m32s                  flagger  Advance bookinfo.istio canary weight 60
  Normal   Synced  2m33s (x4 over 6m32s)  flagger  Confirm-traffic-increase check traffic increase gate passed
  Normal   Synced  2m33s (x5 over 6m33s)  flagger  Rollback hook rollback gate not signaling a rollback
  Normal   Synced  2m32s                  flagger  Confirm-promotion check promotion gate passed
  Normal   Synced  33s (x3 over 2m32s)    flagger  (combined from similar events): Promotion completed! Scaling down reviews-v1.istio
[root@node01 ~]# 
```

清理：

kubectl delete canary bookinfo -n istio

kubectl delete hpa review-hpa -n istio





一致性测试

cd release/canary/flagger/helm/reviews-v1

helm install reviews-v1 -n istio .

赋予权限

kubectl create clusterrolebinding flagger-loadtest-admin --serviceaccount=istio-system:default  --clusterrole=cluster-admin



release/canary/flagger/reviews-hpa.yaml 

kubectl  apply -f reviews-hpa.yaml  -n istio

```
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: review-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  minReplicas: 1
  maxReplicas: 2
  targetCPUUtilizationPercentage: 50
```

release/canary/flagger/canary-reviews-webhook-uniformity.yaml

kubectl apply -f canary-reviews-webhook-uniformity.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  autoscalerRef:
    apiVersion: autoscaling/v1
    kind: HorizontalPodAutoscaler
    name: review-hpa
  service:
    port: 9080
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
    webhooks:
      - name: "start gate"
        type: confirm-rollout
        url: http://flagger-loadtester.istio-system/gate/approve
      - name: "helm test"
        type: pre-rollout
        url: http://flagger-loadtester.istio-system/
        timeout: 3m
        metadata:
          type: "helmv3"
          cmd: "test reviews-v1 -n istio"
      - name: "load test"
        type: rollout
        url: http://flagger-loadtester.istio-system/
        timeout: 15s
        metadata:
          cmd: "hey -z 1m -q 5 -c 2 http://reviews.istio:9080/reviews/0/"
      - name: "notify"
        type: post-rollout
        url: https://hooks.slack.com/services/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
        timeout: 5s
        metadata:
          some: "message" 
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2



启用压测
go-stress-testing -c 10 -n 1000000 -u http://bookinfo.com:32545/reviews/0

 kubectl describe canary bookinfo -n istio

  Normal   Synced  11m (x4 over 133m)    flagger  New revision detected! Scaling up reviews-v1.istio
  Normal   Synced  10m (x5 over 157m)    flagger  New revision detected! Restarting analysis for reviews-v1.istio
  Normal   Synced  9m9s (x36 over 156m)  flagger  Starting canary analysis for reviews-v1.istio
  Normal   Synced  8m57s (x3 over 156m)  flagger  Advance bookinfo.istio canary weight 20
  Normal   Synced  8m57s                 flagger  Pre-rollout check helm test passed
  Warning  Synced  8m9s                  flagger  Halt bookinfo.istio advancement request duration 1.955s > 500ms
  Warning  Synced  7m9s                  flagger  Halt bookinfo.istio advancement success rate 71.22% < 99%
  Normal   Synced  2m9s                  flagger  Routing all traffic to primary、
  
  kubectl logs -f -n istio-system flagger-test-7ccc74b6ff-xd94q 
  
  {"level":"info","ts":"2021-09-06T03:16:37.425Z","caller":"controller/events.go:33","msg":"New revision detected! Restarting analysis for reviews-v1.istio","canary":"bookinfo.istio"}
{"level":"info","ts":"2021-09-06T03:17:37.457Z","caller":"controller/events.go:33","msg":"Starting canary analysis for reviews-v1.istio","canary":"bookinfo.istio"}
{"level":"info","ts":"2021-09-06T03:17:49.846Z","caller":"controller/events.go:33","msg":"Pre-rollout check helm test passed","canary":"bookinfo.istio"}
{"level":"info","ts":"2021-09-06T03:17:49.909Z","caller":"controller/events.go:33","msg":"Advance bookinfo.istio canary weight 20","canary":"bookinfo.istio"}
{"level":"info","ts":"2021-09-06T03:18:37.500Z","caller":"controller/events.go:45","msg":"Halt bookinfo.istio advancement request duration 1.955s > 500ms","canary":"bookinfo.istio"}
{"level":"info","ts":"2021-09-06T03:19:37.532Z","caller":"controller/events.go:45","msg":"Halt bookinfo.istio advancement success rate 71.22% < 99%","canary":"bookinfo.istio"}
{"level":"info","ts":"2021-09-06T03:20:37.433Z","caller":"controller/events.go:45","msg":"Halt bookinfo.istio advancement request duration 1.625s > 500ms","canary":"bookinfo.istio"}
{"level":"info","ts":"2021-09-06T03:21:37.446Z","caller":"controller/events.go:33","msg":"Advance bookinfo.istio canary weight 40","canary":"bookinfo.istio"}
{"level":"info","ts":"2021-09-06T03:22:37.441Z","caller":"controller/events.go:33","msg":"Advance bookinfo.istio canary weight 60","canary":"bookinfo.istio"}
{"level":"info","ts":"2021-09-06T03:23:37.481Z","caller":"controller/events.go:33","msg":"Copying reviews-v1.istio template spec to reviews-v1-primary.istio","canary":"bookinfo.istio"}
{"level":"info","ts":"2021-09-06T03:24:37.427Z","caller":"controller/events.go:33","msg":"Routing all traffic to primary","canary":"bookinfo.istio"}
{"level":"info","ts":"2021-09-06T03:25:37.949Z","caller":"controller/events.go:45","msg":"Post-rollout hook notify failed no_text","canary":"bookinfo.istio"}
{"level":"info","ts":"2021-09-06T03:25:37.949Z","caller":"controller/events.go:33","msg":"Promotion completed! Scaling down reviews-v1.istio","canary":"bookinfo.istio"}
```

清理：

kubectl delete canary bookinfo -n istio

kubectl delete hpa review-hpa -n istio

helm uninstall reviews-v1 -n istio



向钉钉发送消息

release/canary/flagger/reviews-deploy-with-resources.yaml 

kubectl apply -f reviews-deploy-with-resources.yaml  -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: reviews
  labels:
    app: reviews
    service: reviews
spec:
  ports:
  - port: 9080
    name: http
  selector:
    app: reviews
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: bookinfo-reviews
  labels:
    account: reviews
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: reviews-v2
  labels:
    app: reviews
    version: v2
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v2
  template:
    metadata:
      labels:
        app: reviews
        version: v2
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v2:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: reviews-v3
  labels:
    app: reviews
    version: v3
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v3
  template:
    metadata:
      labels:
        app: reviews
        version: v3
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v3:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
```

release/canary/flagger/reviews-hpa.yaml 

kubectl  apply -f reviews-hpa.yaml  -n istio

```
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: review-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  minReplicas: 1
  maxReplicas: 2
  targetCPUUtilizationPercentage: 50
```

release/canary/flagger/canary-reviews-webhook-rollout.yaml

kubectl apply -f canary-reviews-webhook-rollout.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  autoscalerRef:
    apiVersion: autoscaling/v1
    kind: HorizontalPodAutoscaler
    name: review-hpa
  service:
    port: 9080
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
    webhooks:
      - name: "start gate"
        type: confirm-rollout
        url: http://flagger-loadtester.istio-system/gate/approve
      - name: "load test"
        type: rollout
        url: http://flagger-loadtester.istio-system/
        timeout: 15s
        metadata:
          cmd: "hey -z 1m -q 5 -c 2 http://reviews.istio:9080/reviews/0/"
      - name: "traffic increase gate"
        type: confirm-traffic-increase
        url: http://flagger-loadtester.istio-system/gate/approve
      - name: "promotion gate"
        type: confirm-promotion
        url: http://flagger-loadtester.istio-system/gate/approve
      - name: "notify"
        type: post-rollout
        url: 钉钉url
        timeout: 5s
        metadata:
          some: "message"
      - name: "rollback gate"
        type: rollback
        url: http://flagger-loadtester.istio-system/rollback/check
      - name: "send to 钉钉"
        type: event
        url: 钉钉url
        metadata:
          environment: "test"
          cluster: "flagger-test" 
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2



启用压测
go-stress-testing -c 10 -n 1000000 -u http://bookinfo.com:31773/reviews/0

 kubectl describe canary bookinfo -n istio

```





##### alertproviders

###### slack

release/canary/flagger/canary-reviews-alertproviders-slack.yaml

kubectl apply -f canary-reviews-alertproviders-slack.yaml -n istio-system

type: "slack", "msteams", "discord", "rocket", "gchat"

```
apiVersion: flagger.app/v1beta1
kind: AlertProvider
metadata:
  name: on-call
spec:
  type: slack
  channel: test
  username: test
  address: https://hooks.slack.com/services/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
```



release/canary/flagger/canary-reviews-alertproviders-slack-canray.yaml

kubectl apply -f canary-reviews-alertproviders-slack-canray.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  service:
    port: 9080
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    alerts:
    - name: alert-slack
      providerRef:
        name: on-call
        namespace: istio-system
      severity: info # error warn
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
  
```

```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v1:1.16.2

执行请求：
go-stress-testing -n 10000 -c 5 -u http://192.168.229.134:30468/reviews/0

kubectl describe canary bookinfo -n istio

Events:
  Type     Reason  Age                  From     Message
  ----     ------  ----                 ----     -------
  Warning  Synced  8m1s                 flagger  reviews-v1-primary.istio not ready: waiting for rollout to finish: observed deployment generation less than desired generation
  Normal   Synced  7m1s (x2 over 8m1s)  flagger  all the metrics providers are available!
  Normal   Synced  7m                   flagger  Initialization done! bookinfo.istio
  Normal   Synced  6m1s                 flagger  New revision detected! Scaling up reviews-v1.istio
  Normal   Synced  5m1s                 flagger  Starting canary analysis for reviews-v1.istio
  Normal   Synced  5m1s                 flagger  Advance bookinfo.istio canary weight 20
  Normal   Synced  4m1s                 flagger  Advance bookinfo.istio canary weight 40
  Normal   Synced  3m1s                 flagger  Advance bookinfo.istio canary weight 60
  Normal   Synced  2m1s                 flagger  Copying reviews-v1.istio template spec to reviews-v1-primary.istio
  Normal   Synced  61s                  flagger  Routing all traffic to primary
  Normal   Synced  1s                   flagger  (combined from similar events): Promotion completed! Scaling down reviews-v1.istio
```

清理：

kubectl delete canary bookinfo -n istio



![1630885085(1)](images\1630885085(1).jpg)



######  Prometheus Alert Manager 

配置在prometheus中

```
      - alert: canary_rollback
        expr: flagger_canary_status > 1
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "Canary failed"
          description: "Workload {{ $labels.name }} namespace {{ $labels.namespace }}"
```







##### metrictemplates

###### prometheus

release/canary/flagger/canary-reviews-metrictemplates-prometheus.yaml

kubectl apply -f canary-reviews-metrictemplates-prometheus.yaml -n istio-system

```
apiVersion: flagger.app/v1beta1
kind: MetricTemplate
metadata:
  name: not-found-percentage
  namespace: istio-system
spec:
  provider:
    type: prometheus
    address: http://prometheus.istio-system:9090
  query: |
    100 - sum(
        rate(
            istio_requests_total{
              reporter="destination",
              destination_workload_namespace="{{ namespace }}",
              destination_workload="{{ target }}",
              response_code!="404"
            }[{{ interval }}]
        )
    )
    /
    sum(
        rate(
            istio_requests_total{
              reporter="destination",
              destination_workload_namespace="{{ namespace }}",
              destination_workload="{{ target }}"
            }[{{ interval }}]
        )
    ) * 100
```

release/canary/flagger/canary-reviews-metrictemplates-prometheus-canary.yaml

kubectl apply -f canary-reviews-metrictemplates-prometheus-canary.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  service:
    port: 9080
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 20
    metrics:
    - templateRef:
        namespace: istio-system
        name: not-found-percentage
      name: not-found-percentage
      thresholdRange:
        max: 10
      interval: 1m
        
```





```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2

kubectl describe canary bookinfo -n istio


  Type     Reason  Age                 From     Message
  ----     ------  ----                ----     -------
  Warning  Synced  11h                 flagger  Rolling back bookinfo.istio failed checks threshold reached 10
  Warning  Synced  11h                 flagger  Canary failed! Scaling down bookinfo.istio
  Normal   Synced  11h (x2 over 11h)   flagger  New revision detected! Scaling up reviews-v1.istio
  Normal   Synced  11h (x2 over 11h)   flagger  Starting canary analysis for reviews-v1.istio
  Normal   Synced  11h (x2 over 11h)   flagger  Advance bookinfo.istio canary weight 20
  Warning  Synced  11h (x18 over 11h)  flagger  Halt advancement no values found for istio metric request-duration probably reviews-v1.istio is not receiving traffic
  Warning  Synced  46m                 flagger  reviews-v1-primary.istio not ready: waiting for rollout to finish: 0 of 1 updated replicas are available
  Warning  Synced  44m (x2 over 45m)   flagger  Halt advancement no values found for istio metric request-duration probably reviews-v1.istio is not receiving traffic
  Warning  Synced  43m                 flagger  Rolling back bookinfo.istio failed checks threshold reached 10
  Warning  Synced  43m                 flagger  Canary failed! Scaling down bookinfo.istio
  Normal   Synced  7m33s               flagger  New revision detected! Scaling up reviews-v1.istio
  Normal   Synced  6m33s               flagger  Starting canary analysis for reviews-v1.istio
  Normal   Synced  6m33s               flagger  Advance bookinfo.istio canary weight 20
  Warning  Synced  5m33s               flagger  Halt bookinfo.istio advancement request duration 49ms > 10ms
  Normal   Synced  4m33s               flagger  Advance bookinfo.istio canary weight 40
  Normal   Synced  3m33s               flagger  Advance bookinfo.istio canary weight 60
  Normal   Synced  2m33s               flagger  Copying reviews-v1.istio template spec to reviews-v1-primary.istio
  Normal   Synced  93s                 flagger  Routing all traffic to primary
  Normal   Synced  33s                 flagger  Promotion completed! Scaling down reviews-v1.istio

```

清理：

kubectl delete canary bookinfo -n istio

kubectl delete MetricTemplate -n istio-system not-found-percentage



### argo-rollout

#### 什么是argo-rollout

Argo-Rollout是一个Kubernetes Controller和对应一系列的CRD，提供更强大的Deployment能力。包括灰度发布、蓝绿部署、更新测试(experimentation)、渐进式交付(progressive delivery)等特性。

支持特性如下：

- 蓝绿色更新策略
- 金丝雀更新策略
- 细粒度，加权流量转移
- 自动回rollback和promotion
- 手动判断
  - 可定制的指标查询和业务KPI分析`

- 入口控制器集成：NGINX，ALB
- 服务网格集成：Istio，Linkerd，SMI
- Metric provider集成：Prometheus，Wavefront，Kayenta，Web，Kubernetes Jobs

Argo原理和Deployment差不多，只是加强rollout的策略和流量控制。当spec.template发送变化时，Argo-Rollout就会根据spec.strategy进行rollout，通常会产生一个新的ReplicaSet，逐步scale down之前的ReplicaSet的pod数量。



#### 安装

```
kubectl create namespace argo-rollouts
kubectl apply -f argo-rollout-install.yaml -n argo-rollouts

安装argo-rollouts的kubectl plugin
curl -LO https://github.com/argoproj/argo-rollouts/releases/latest/download/kubectl-argo-rollouts-linux-amd64
chmod +x ./kubectl-argo-rollouts-linux-amd64
mv ./kubectl-argo-rollouts-linux-amd64 /usr/local/bin/kubectl-argo-rollouts
```

#### 过程

![argo-canary-deployments](images\argo-canary-deployments.png)



#### 架构

![argo-rollout-architecture](images\argo-rollout-architecture.png)



#### UI Dashboard

The Argo Rollouts Kubectl plugin can serve a local UI Dashboard to visualize your Rollouts.

To start it, run `kubectl argo rollouts dashboard` in the namespace that contains your Rollouts. Then visit `localhost:3100` to view the user interface.

![rollouts-list](images\rollouts-list.png)



#### crd详解

```
[root@node01 ~]# kubectl get crd | grep argo
analysisruns.argoproj.io                   2021-09-06T03:37:06Z
analysistemplates.argoproj.io              2021-09-06T03:37:07Z
clusteranalysistemplates.argoproj.io       2021-09-06T03:37:07Z
experiments.argoproj.io                    2021-09-06T03:37:08Z
rollouts.argoproj.io                       2021-09-06T03:37:09Z
```

![1630907337(1)](images\1630907337(1).jpg)



##### rollouts

###### normal

release/canary/argo/rollout-canary-steps.yaml

kubectl apply -f rollout-canary-steps.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      steps:
      - setWeight: 20
      - pause: {}
      - setWeight: 40
      - pause: {duration: 10}
      - setWeight: 60
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
```

```
 kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio

Events:
  Type    Reason                Age   From                 Message
  ----    ------                ----  ----                 -------
  Normal  RolloutUpdated        108s  rollouts-controller  Rollout updated to revision 1
  Normal  NewReplicaSetCreated  108s  rollouts-controller  Created ReplicaSet reviews-v1-c68bcbf9 (revision 1)
  Normal  ScalingReplicaSet     108s  rollouts-controller  Scaled up ReplicaSet reviews-v1-c68bcbf9 (revision 1) from 0 to 1
  Normal  RolloutCompleted      108s  rollouts-controller  Rollout completed update to revision 1 (c68bcbf9): Initial deploy
  Normal  RolloutUpdated        82s   rollouts-controller  Rollout updated to revision 2
  Normal  NewReplicaSetCreated  82s   rollouts-controller  Created ReplicaSet reviews-v1-6777b77548 (revision 2)
  Normal  ScalingReplicaSet     82s   rollouts-controller  Scaled up ReplicaSet reviews-v1-6777b77548 (revision 2) from 0 to 1
  Normal  RolloutStepCompleted  75s   rollouts-controller  Rollout step 1/8 completed (setWeight: 20)
  Normal  RolloutPaused         75s   rollouts-controller  Rollout is paused (CanaryPauseStep)
  

kubectl argo rollouts get rollout reviews-v1 --watch -n istio

Name:            reviews-v1
Namespace:       istio
Status:          ॥ Paused
Message:         CanaryPauseStep
Strategy:        Canary
  Step:          1/8
  SetWeight:     20
  ActualWeight:  50
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 (stable)
                 docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (canary)
Replicas:
  Desired:       1
  Current:       2
  Updated:       1
  Ready:         2
  Available:     2

NAME                                    KIND        STATUS     AGE  INFO
⟳ reviews-v1                            Rollout     ॥ Paused   85s  
├──# revision:2                                                     
│  └──⧉ reviews-v1-6777b77548           ReplicaSet  ✔ Healthy  59s  canary
│     └──□ reviews-v1-6777b77548-8t5d6  Pod         ✔ Running  59s  ready:2/2
└──# revision:1                                                     
   └──⧉ reviews-v1-c68bcbf9             ReplicaSet  ✔ Healthy  85s  stable
      └──□ reviews-v1-c68bcbf9-d56dq    Pod         ✔ Running  85s  ready:2/2


kubectl argo rollouts promote  reviews-v1 -n istio
kubectl argo rollouts promote  reviews-v1 -n istio
kubectl argo rollouts promote  reviews-v1 -n istio


kubectl argo rollouts get rollout reviews-v1 --watch -n istio

Name:            reviews-v1
Namespace:       istio
Status:          ✔ Healthy
Strategy:        Canary
  Step:          8/8
  SetWeight:     100
  ActualWeight:  100
Images:          docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (stable)
Replicas:
  Desired:       1
  Current:       1
  Updated:       1
  Ready:         1
  Available:     1

NAME                                    KIND        STATUS        AGE    INFO
⟳ reviews-v1                            Rollout     ✔ Healthy     5m15s  
├──# revision:2                                                          
│  └──⧉ reviews-v1-6777b77548           ReplicaSet  ✔ Healthy     4m49s  stable
│     └──□ reviews-v1-6777b77548-8t5d6  Pod         ✔ Running     4m49s  ready:2/2
└──# revision:1                                                          
   └──⧉ reviews-v1-c68bcbf9             ReplicaSet  • ScaledDown  5m15s
   
 
 kubectl describe rollout reviews-v1  -n istio

Events:
  Type    Reason                Age                  From                 Message
  ----    ------                ----                 ----                 -------
  Normal  RolloutUpdated        5m58s                rollouts-controller  Rollout updated to revision 1
  Normal  NewReplicaSetCreated  5m58s                rollouts-controller  Created ReplicaSet reviews-v1-c68bcbf9 (revision 1)
  Normal  ScalingReplicaSet     5m58s                rollouts-controller  Scaled up ReplicaSet reviews-v1-c68bcbf9 (revision 1) from 0 to 1
  Normal  RolloutCompleted      5m58s                rollouts-controller  Rollout completed update to revision 1 (c68bcbf9): Initial deploy
  Normal  RolloutUpdated        5m32s                rollouts-controller  Rollout updated to revision 2
  Normal  NewReplicaSetCreated  5m32s                rollouts-controller  Created ReplicaSet reviews-v1-6777b77548 (revision 2)
  Normal  ScalingReplicaSet     5m32s                rollouts-controller  Scaled up ReplicaSet reviews-v1-6777b77548 (revision 2) from 0 to 1
  Normal  RolloutStepCompleted  5m25s                rollouts-controller  Rollout step 1/8 completed (setWeight: 20)
  Normal  RolloutStepCompleted  86s                  rollouts-controller  Rollout step 3/8 completed (setWeight: 40)
  Normal  RolloutStepCompleted  86s                  rollouts-controller  Rollout step 2/8 completed (pause)
  Normal  RolloutStepCompleted  76s                  rollouts-controller  Rollout step 4/8 completed (pause: 10)
  Normal  RolloutStepCompleted  76s                  rollouts-controller  Rollout step 5/8 completed (setWeight: 60)
  Normal  RolloutPaused         67s (x4 over 5m25s)  rollouts-controller  Rollout is paused (CanaryPauseStep)
  Normal  RolloutStepCompleted  67s                  rollouts-controller  Rollout step 6/8 completed (pause: 10)
  Normal  RolloutStepCompleted  67s                  rollouts-controller  Rollout step 7/8 completed (setWeight: 80)
  Normal  RolloutResumed        57s (x2 over 76s)    rollouts-controller  Rollout is resumed
  Normal  RolloutStepCompleted  57s                  rollouts-controller  Rollout step 8/8 completed (pause: 10)
  Normal  ScalingReplicaSet     57s                  rollouts-controller  Scaled down ReplicaSet reviews-v1-c68bcbf9 (revision 1) from 1 to 0
  Normal  RolloutCompleted      57s                  rollouts-controller  Rollout completed update to revision 2 (6777b77548): Completed all 8 canary steps
```



清理：

kubectl delete rollout reviews-v1 -n istio





###### workloadRef

release/canary/argo/rollout-canary-workloadRef.yaml

kubectl apply -f rollout-canary-workloadRef.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  workloadRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  strategy:
    canary:
      steps:
      - setWeight: 20
      - pause: {}
      - setWeight: 40
      - pause: {duration: 10}
      - setWeight: 60
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
```

release/canary/argo/review-v1-deploy.yaml

kubectl apply -f review-v1-deploy.yaml -n istio

```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
```



```
 kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio

Events:
  Type    Reason                Age   From                 Message
  ----    ------                ----  ----                 -------
  Normal  RolloutUpdated        99s   rollouts-controller  Rollout updated to revision 1
  Normal  NewReplicaSetCreated  99s   rollouts-controller  Created ReplicaSet reviews-v1-5dd84788d7 (revision 1)
  Normal  ScalingReplicaSet     99s   rollouts-controller  Scaled up ReplicaSet reviews-v1-5dd84788d7 (revision 1) from 0 to 1
  Normal  RolloutCompleted      99s   rollouts-controller  Rollout completed update to revision 1 (5dd84788d7): Initial deploy
  Normal  RolloutUpdated        31s   rollouts-controller  Rollout updated to revision 2
  Normal  NewReplicaSetCreated  31s   rollouts-controller  Created ReplicaSet reviews-v1-df9cc9448 (revision 2)
  Normal  ScalingReplicaSet     31s   rollouts-controller  Scaled up ReplicaSet reviews-v1-df9cc9448 (revision 2) from 0 to 1
  Normal  RolloutStepCompleted  24s   rollouts-controller  Rollout step 1/8 completed (setWeight: 20)
  Normal  RolloutPaused         24s   rollouts-controller  Rollout is paused (CanaryPauseStep)

kubectl argo rollouts get rollout reviews-v1 --watch -n istio

Name:            reviews-v1
Namespace:       istio
Status:          ॥ Paused
Message:         CanaryPauseStep
Strategy:        Canary
  Step:          1/8
  SetWeight:     20
  ActualWeight:  50
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 (canary)
                 docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (stable)
Replicas:
  Desired:       1
  Current:       2
  Updated:       1
  Ready:         2
  Available:     2

NAME                                    KIND        STATUS     AGE  INFO
⟳ reviews-v1                            Rollout     ॥ Paused   80s  
├──# revision:2                                                     
│  └──⧉ reviews-v1-df9cc9448            ReplicaSet  ✔ Healthy  12s  canary
│     └──□ reviews-v1-df9cc9448-g987w   Pod         ✔ Running  12s  ready:2/2
└──# revision:1                                                     
   └──⧉ reviews-v1-5dd84788d7           ReplicaSet  ✔ Healthy  80s  stable
      └──□ reviews-v1-5dd84788d7-trww2  Pod         ✔ Running  80s  ready:2/2


kubectl argo rollouts promote  reviews-v1 -n istio
kubectl argo rollouts promote  reviews-v1 -n istio
kubectl argo rollouts promote  reviews-v1 -n istio

kubectl argo rollouts get rollout reviews-v1 --watch -n istio

Name:            reviews-v1
Namespace:       istio
Status:          ✔ Healthy
Strategy:        Canary
  Step:          8/8
  SetWeight:     100
  ActualWeight:  100
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 (stable)
Replicas:
  Desired:       1
  Current:       1
  Updated:       1
  Ready:         1
  Available:     1

NAME                                    KIND        STATUS         AGE    INFO
⟳ reviews-v1                            Rollout     ✔ Healthy      2m18s  
├──# revision:2                                                           
│  └──⧉ reviews-v1-df9cc9448            ReplicaSet  ✔ Healthy      70s    stable
│     └──□ reviews-v1-df9cc9448-g987w   Pod         ✔ Running      70s    ready:2/2
└──# revision:1                                                           
   └──⧉ reviews-v1-5dd84788d7           ReplicaSet  • ScaledDown   2m18s  
      └──□ reviews-v1-5dd84788d7-trww2  Pod         ◌ Terminating  2m18s  ready:2/2

kubectl describe rollout reviews-v1  -n istio

Events:
  Type    Reason                Age                From                 Message
  ----    ------                ----               ----                 -------
  Normal  RolloutUpdated        2m54s              rollouts-controller  Rollout updated to revision 1
  Normal  NewReplicaSetCreated  2m54s              rollouts-controller  Created ReplicaSet reviews-v1-5dd84788d7 (revision 1)
  Normal  ScalingReplicaSet     2m54s              rollouts-controller  Scaled up ReplicaSet reviews-v1-5dd84788d7 (revision 1) from 0 to 1
  Normal  RolloutCompleted      2m54s              rollouts-controller  Rollout completed update to revision 1 (5dd84788d7): Initial deploy
  Normal  RolloutUpdated        106s               rollouts-controller  Rollout updated to revision 2
  Normal  NewReplicaSetCreated  106s               rollouts-controller  Created ReplicaSet reviews-v1-df9cc9448 (revision 2)
  Normal  ScalingReplicaSet     106s               rollouts-controller  Scaled up ReplicaSet reviews-v1-df9cc9448 (revision 2) from 0 to 1
  Normal  RolloutStepCompleted  99s                rollouts-controller  Rollout step 1/8 completed (setWeight: 20)
  Normal  RolloutStepCompleted  56s                rollouts-controller  Rollout step 3/8 completed (setWeight: 40)
  Normal  RolloutStepCompleted  56s                rollouts-controller  Rollout step 2/8 completed (pause)
  Normal  RolloutStepCompleted  50s                rollouts-controller  Rollout step 4/8 completed (pause: 10)
  Normal  RolloutStepCompleted  50s                rollouts-controller  Rollout step 5/8 completed (setWeight: 60)
  Normal  RolloutPaused         45s (x4 over 99s)  rollouts-controller  Rollout is paused (CanaryPauseStep)
  Normal  RolloutStepCompleted  45s                rollouts-controller  Rollout step 6/8 completed (pause: 10)
  Normal  RolloutStepCompleted  45s                rollouts-controller  Rollout step 7/8 completed (setWeight: 80)
  Normal  RolloutStepCompleted  40s                rollouts-controller  Rollout step 8/8 completed (pause: 10)
  Normal  ScalingReplicaSet     40s                rollouts-controller  Scaled down ReplicaSet reviews-v1-5dd84788d7 (revision 1) from 1 to 0
  Normal  RolloutCompleted      40s                rollouts-controller  Rollout completed update to revision 2 (df9cc9448): Completed all 8 canary steps
```

清理：

kubectl delete rollout reviews-v1 -n istio



###### rollingupdate

release/canary/argo/rollout-canary-rollingupdate.yaml

kubectl apply -f rollout-canary-rollingupdate.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    # For a normal rolling update, simply specify the canary strategy without steps defined.
    # The maxSurge and maxUnavailable fields can be specified. If omitted, defaults to 25% and 0
    # respectively.
    canary:
      maxSurge: 1
      maxUnavailable: 1
```

```
 kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio

Events:
  Type    Reason                Age   From                 Message
  ----    ------                ----  ----                 -------
  Normal  RolloutUpdated        17s   rollouts-controller  Rollout updated to revision 1
  Normal  NewReplicaSetCreated  17s   rollouts-controller  Created ReplicaSet reviews-v1-c68bcbf9 (revision 1)
  Normal  ScalingReplicaSet     17s   rollouts-controller  Scaled up ReplicaSet reviews-v1-c68bcbf9 (revision 1) from 0 to 1
  Normal  RolloutCompleted      17s   rollouts-controller  Rollout completed update to revision 1 (c68bcbf9): Initial deploy
  
kubectl argo rollouts get rollout reviews-v1 --watch -n istio

Name:            reviews-v1
Namespace:       istio
Status:          ✔ Healthy
Strategy:        Canary
  Step:          
  SetWeight:     100
  ActualWeight:  100
Images:          docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (stable)
Replicas:
  Desired:       1
  Current:       1
  Updated:       1
  Ready:         1
  Available:     1

NAME                                    KIND        STATUS         AGE  INFO
⟳ reviews-v1                            Rollout     ✔ Healthy      94s  
├──# revision:2                                                         
│  └──⧉ reviews-v1-6777b77548           ReplicaSet  ✔ Healthy      11s  stable
│     └──□ reviews-v1-6777b77548-4gc6h  Pod         ✔ Running      11s  ready:2/2
└──# revision:1                                                         
   └──⧉ reviews-v1-c68bcbf9             ReplicaSet  • ScaledDown   94s  
      └──□ reviews-v1-c68bcbf9-5fb2j    Pod         ◌ Terminating  94s  ready:0/2


```



清理：

kubectl delete rollout reviews-v1 -n istio



###### minReadySeconds

最小就绪时间

release/canary/argo/rollout-canary-minReadySeconds.yaml

kubectl apply -f rollout-canary-minReadySeconds.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  minReadySeconds: 2
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      maxSurge: 1
      maxUnavailable: 1
```

```
 kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio

Name:            reviews-v1
Namespace:       istio
Status:          ✔ Healthy
Strategy:        Canary
  Step:          
  SetWeight:     100
  ActualWeight:  100
Images:          docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (stable)
Replicas:
  Desired:       1
  Current:       1
  Updated:       1
  Ready:         1
  Available:     1

NAME                                    KIND        STATUS        AGE  INFO
⟳ reviews-v1                            Rollout     ✔ Healthy     51s  
├──# revision:2                                                        
│  └──⧉ reviews-v1-6777b77548           ReplicaSet  ✔ Healthy     24s  stable
│     └──□ reviews-v1-6777b77548-x9jkp  Pod         ✔ Running     24s  ready:2/2
└──# revision:1                                                        
   └──⧉ reviews-v1-c68bcbf9             ReplicaSet  • ScaledDown  51s  

Events:
  Type    Reason                Age   From                 Message
  ----    ------                ----  ----                 -------
  Normal  RolloutUpdated        73s   rollouts-controller  Rollout updated to revision 1
  Normal  NewReplicaSetCreated  73s   rollouts-controller  Created ReplicaSet reviews-v1-c68bcbf9 (revision 1)
  Normal  ScalingReplicaSet     73s   rollouts-controller  Scaled up ReplicaSet reviews-v1-c68bcbf9 (revision 1) from 0 to 1
  Normal  RolloutCompleted      73s   rollouts-controller  Rollout completed update to revision 1 (c68bcbf9): Initial deploy
  Normal  RolloutUpdated        46s   rollouts-controller  Rollout updated to revision 2
  Normal  NewReplicaSetCreated  46s   rollouts-controller  Created ReplicaSet reviews-v1-6777b77548 (revision 2)
  Normal  ScalingReplicaSet     46s   rollouts-controller  Scaled down ReplicaSet reviews-v1-c68bcbf9 (revision 1) from 1 to 0
  Normal  ScalingReplicaSet     45s   rollouts-controller  Scaled up ReplicaSet reviews-v1-6777b77548 (revision 2) from 0 to 1
  Normal  RolloutCompleted      32s   rollouts-controller  Rollout completed update to revision 2 (6777b77548): Completed all 0 canary steps
```



清理：

kubectl delete rollout reviews-v1 -n istio





###### paused

是否暂停

rollout-reviews-paused.yaml

kubectl apply -f rollout-reviews-paused.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  paused: true
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      steps:
      - setWeight: 20
      - pause: {}
      - setWeight: 40
      - pause: {duration: 10}
      - setWeight: 60
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
```

```
 kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio
 
kubectl argo rollouts get rollout reviews-v1 --watch -n istio

Name:            reviews-v1
Namespace:       istio
Status:          ॥ Paused
Message:         manually paused
Strategy:        Canary
  Step:          8/8
  SetWeight:     100
  ActualWeight:  100
Replicas:
  Desired:       1
  Current:       0
  Updated:       0
  Ready:         0
  Available:     0

NAME          KIND     STATUS    AGE  INFO
⟳ reviews-v1  Rollout  ॥ Paused  25s 


kubectl argo rollouts promote  reviews-v1 -n istio


Name:            reviews-v1
Namespace:       istio
Status:          ॥ Paused
Message:         CanaryPauseStep
Strategy:        Canary
  Step:          1/8
  SetWeight:     20
  ActualWeight:  50
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 (stable)
                 docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (canary)
Replicas:
  Desired:       1
  Current:       2
  Updated:       1
  Ready:         2
  Available:     2

NAME                                    KIND        STATUS     AGE    INFO
⟳ reviews-v1                            Rollout     ॥ Paused   2m45s  
├──# revision:2                                                       
│  └──⧉ reviews-v1-6777b77548           ReplicaSet  ✔ Healthy  104s   canary
│     └──□ reviews-v1-6777b77548-mwzdp  Pod         ✔ Running  40s    ready:2/2
└──# revision:1                                                       
   └──⧉ reviews-v1-c68bcbf9             ReplicaSet  ✔ Healthy  2m45s  stable
      └──□ reviews-v1-c68bcbf9-f9zx6    Pod         ✔ Running  40s    ready:2/2

Events:
  Type    Reason                Age                  From                 Message
  ----    ------                ----                 ----                 -------
  Normal  RolloutUpdated        6m56s                rollouts-controller  Rollout updated to revision 1
  Normal  RolloutCompleted      6m56s                rollouts-controller  Rollout completed update to revision 1 (c68bcbf9): Initial deploy
  Normal  RolloutUpdated        5m56s                rollouts-controller  Rollout updated to revision 2
  Normal  ScalingReplicaSet     4m52s                rollouts-controller  Scaled up ReplicaSet reviews-v1-c68bcbf9 (revision 1) from 0 to 1
  Normal  ScalingReplicaSet     4m52s                rollouts-controller  Scaled up ReplicaSet reviews-v1-6777b77548 (revision 2) from 0 to 1
  Normal  RolloutStepCompleted  29s                  rollouts-controller  Rollout step 2/8 completed (pause)
  Normal  RolloutStepCompleted  29s                  rollouts-controller  Rollout step 3/8 completed (setWeight: 40)
  Normal  RolloutStepCompleted  27s                  rollouts-controller  Rollout step 5/8 completed (setWeight: 60)
  Normal  RolloutStepCompleted  27s                  rollouts-controller  Rollout step 4/8 completed (pause: 10)
  Normal  RolloutPaused         17s (x4 over 4m52s)  rollouts-controller  Rollout is paused (CanaryPauseStep)
  Normal  RolloutStepCompleted  17s                  rollouts-controller  Rollout step 6/8 completed (pause: 10)
  Normal  RolloutResumed        17s                  rollouts-controller  Rollout is resumed
  Normal  RolloutStepCompleted  17s                  rollouts-controller  Rollout step 7/8 completed (setWeight: 80)
  Normal  RolloutStepCompleted  11s                  rollouts-controller  Rollout step 8/8 completed (pause: 10)
  Normal  ScalingReplicaSet     11s                  rollouts-controller  Scaled down ReplicaSet reviews-v1-c68bcbf9 (revision 1) from 1 to 0
  Normal  RolloutCompleted      11s                  rollouts-controller  Rollout completed update to revision 2 (6777b77548): Completed all 8 canary steps
```

清理：

kubectl delete rollout reviews-v1 -n istio



###### progressDeadlineSeconds

升级最大处理时间

rollout-reviews-progressDeadlineSeconds.yaml

kubectl apply -f rollout-reviews-progressDeadlineSeconds.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 5
  progressDeadlineSeconds: 1
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      maxSurge: 1
      maxUnavailable: 1
```

```
 kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl argo rollouts get rollout reviews-v1 --watch -n istio

Name:            reviews-v1
Namespace:       istio
Status:          ✔ Healthy
Strategy:        Canary
  Step:          
  SetWeight:     100
  ActualWeight:  100
Images:          docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (stable)
Replicas:
  Desired:       5
  Current:       5
  Updated:       5
  Ready:         5
  Available:     5

NAME                                    KIND        STATUS        AGE    INFO
⟳ reviews-v1                            Rollout     ✔ Healthy     3m14s  
├──# revision:2                                                          
│  └──⧉ reviews-v1-6b87995785           ReplicaSet  ✔ Healthy     106s   stable
│     ├──□ reviews-v1-6b87995785-lt4qk  Pod         ✔ Running     106s   ready:2/2
│     ├──□ reviews-v1-6b87995785-pzk48  Pod         ✔ Running     106s   ready:2/2
│     ├──□ reviews-v1-6b87995785-vnbvq  Pod         ✔ Running     102s   ready:2/2
│     ├──□ reviews-v1-6b87995785-888gv  Pod         ✔ Running     101s   ready:2/2
│     └──□ reviews-v1-6b87995785-vmw7h  Pod         ✔ Running     94s    ready:2/2
└──# revision:1                                                          
   └──⧉ reviews-v1-7f9bff4bbb           ReplicaSet  • ScaledDown  3m14s  



kubectl argo rollouts promote  reviews-v1 -n istio


Events:
  Type    Reason                Age   From                 Message
  ----    ------                ----  ----                 -------
  Normal  RolloutUpdated        106s  rollouts-controller  Rollout updated to revision 1
  Normal  NewReplicaSetCreated  106s  rollouts-controller  Created ReplicaSet reviews-v1-c68bcbf9 (revision 1)
  Normal  ScalingReplicaSet     106s  rollouts-controller  Scaled up ReplicaSet reviews-v1-c68bcbf9 (revision 1) from 0 to 5
  Normal  RolloutCompleted      106s  rollouts-controller  Rollout completed update to revision 1 (c68bcbf9): Initial deploy
  Normal  RolloutUpdated        73s   rollouts-controller  Rollout updated to revision 2
  Normal  NewReplicaSetCreated  73s   rollouts-controller  Created ReplicaSet reviews-v1-6777b77548 (revision 2)
  Normal  ScalingReplicaSet     73s   rollouts-controller  Scaled down ReplicaSet reviews-v1-c68bcbf9 (revision 1) from 5 to 4
  Normal  ScalingReplicaSet     72s   rollouts-controller  Scaled up ReplicaSet reviews-v1-6777b77548 (revision 2) from 0 to 2
  Normal  ScalingReplicaSet     53s   rollouts-controller  Scaled down ReplicaSet reviews-v1-c68bcbf9 (revision 1) from 4 to 3
  Normal  ScalingReplicaSet     53s   rollouts-controller  Scaled down ReplicaSet reviews-v1-c68bcbf9 (revision 1) from 3 to 2
  Normal  ScalingReplicaSet     52s   rollouts-controller  Scaled up ReplicaSet reviews-v1-6777b77548 (revision 2) from 2 to 4
  Normal  ScalingReplicaSet     37s   rollouts-controller  Scaled down ReplicaSet reviews-v1-c68bcbf9 (revision 1) from 2 to 0
  Normal  ScalingReplicaSet     37s   rollouts-controller  Scaled up ReplicaSet reviews-v1-6777b77548 (revision 2) from 4 to 5
  Normal  RolloutCompleted      29s   rollouts-controller  Rollout completed update to revision 2 (6777b77548): Completed all 0 canary steps
```

清理：

kubectl delete rollout reviews-v1 -n istio





###### progressDeadlineAbort

rollout-reviews-progressDeadlineAbort.yaml

kubectl apply -f rollout-reviews-progressDeadlineAbort.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 5
  progressDeadlineSeconds: 1
  progressDeadlineAbort: true
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      maxSurge: 1
      maxUnavailable: 1
```

```
 kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl argo rollouts get rollout reviews-v1 --watch -n istio

 
Name:            reviews-v1
Namespace:       istio
Status:          ✖ Degraded
Message:         RolloutAborted: Rollout aborted update to revision 2
Strategy:        Canary
  Step:          
  SetWeight:     0
  ActualWeight:  100
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 (stable)
Replicas:
  Desired:       5
  Current:       5
  Updated:       0
  Ready:         4
  Available:     4

NAME                                  KIND        STATUS         AGE  INFO
⟳ reviews-v1                          Rollout     ✖ Degraded     61s  
├──# revision:2                                                       
│  └──⧉ reviews-v1-6777b77548         ReplicaSet  • ScaledDown   15s  canary
└──# revision:1                                                       
   └──⧉ reviews-v1-c68bcbf9           ReplicaSet  ✔ Healthy      61s  stable
      ├──□ reviews-v1-c68bcbf9-bxmbn  Pod         ✔ Running      61s  ready:2/2
      ├──□ reviews-v1-c68bcbf9-2nbpg  Pod         ✔ Running      60s  ready:2/2
      ├──□ reviews-v1-c68bcbf9-5c42q  Pod         ✔ Running      60s  ready:2/2
      ├──□ reviews-v1-c68bcbf9-5j52s  Pod         ✔ Running      60s  ready:2/2
      ├──□ reviews-v1-c68bcbf9-x6lmq  Pod         ◌ Terminating  60s  ready:0/2
      └──□ reviews-v1-c68bcbf9-cj2rc  Pod         ✔ Running      13s  ready:2/2
      

Events:
  Type     Reason                Age   From                 Message
  ----     ------                ----  ----                 -------
  Normal   NewReplicaSetCreated  88s   rollouts-controller  Created ReplicaSet reviews-v1-c68bcbf9 (revision 1)
  Normal   ScalingReplicaSet     88s   rollouts-controller  Scaled up ReplicaSet reviews-v1-c68bcbf9 (revision 1) from 0 to 5
  Normal   RolloutCompleted      88s   rollouts-controller  Rollout completed update to revision 1 (c68bcbf9): Initial deploy
  Normal   RolloutUpdated        88s   rollouts-controller  Rollout updated to revision 1
  Warning  RolloutAborted        87s   rollouts-controller  ReplicaSet "reviews-v1-c68bcbf9" has timed out progressing.
  Warning  RolloutAborted        87s   rollouts-controller  Rollout aborted update to revision 1
  Normal   ScalingReplicaSet     42s   rollouts-controller  Scaled down ReplicaSet reviews-v1-c68bcbf9 (revision 1) from 5 to 4
  Normal   RolloutUpdated        42s   rollouts-controller  Rollout updated to revision 2
  Normal   NewReplicaSetCreated  42s   rollouts-controller  Created ReplicaSet reviews-v1-6777b77548 (revision 2)
  Normal   ScalingReplicaSet     40s   rollouts-controller  Scaled up ReplicaSet reviews-v1-6777b77548 (revision 2) from 0 to 2
  Warning  RolloutAborted        40s   rollouts-controller  ReplicaSet "reviews-v1-6777b77548" has timed out progressing.
  Normal   ScalingReplicaSet     40s   rollouts-controller  Scaled down ReplicaSet reviews-v1-6777b77548 (revision 2) from 2 to 0
  Warning  RolloutAborted        40s   rollouts-controller  Rollout aborted update to revision 2
  Normal   ScalingReplicaSet     40s   rollouts-controller  Scaled up ReplicaSet reviews-v1-c68bcbf9 (revision 1) from 4 to 5

```

清理：

kubectl delete rollout reviews-v1 -n istio



###### replicas

副本数量,略



###### restartAt

重新开始时间

 Users can schedule a restart on their Rollout by setting the `.spec.restartAt` field to a time in the future. The controller only starts the restart after the current time is after the restartAt time. 

 For various reasons, applications often need to be restarted, e.g. for hygiene purposes or to force startup logic to occur again such as reloading of a modified Secret. In these scenarios, it is undesirable to go through an entire blue-green or canary update process. Argo Rollouts supports the ability to restart all of its Pods by performing a rolling recreate of all the Pods in a Rollout while skipping the regular BlueGreen or Canary update strategy. 

rollout-reviews-restartAt.yaml

kubectl apply -f rollout-reviews-restartAt.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 5
  restartAt: "2021-09-11T16:16:20Z"
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      steps:
      - setWeight: 20
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
```

```

 kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl argo rollouts get rollout reviews-v1 --watch -n istio
Name:            reviews-v1
Namespace:       istio
Status:          ◌ Progressing
Message:         rollout is restarting
Strategy:        Canary
  Step:          
  SetWeight:     100
  ActualWeight:  100
Images:          docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (stable)
Replicas:
  Desired:       5
  Current:       5
  Updated:       5
  Ready:         5
  Available:     5

NAME                                    KIND        STATUS         AGE   INFO
⟳ reviews-v1                            Rollout     ◌ Progressing  2m8s  
├──# revision:2                                                          
│  └──⧉ reviews-v1-6b87995785           ReplicaSet  ✔ Healthy      2m    stable
│     ├──□ reviews-v1-6b87995785-6xrwz  Pod         ✔ Running      118s  ready:2/2
│     ├──□ reviews-v1-6b87995785-fxd8c  Pod         ✔ Running      118s  ready:2/2
│     ├──□ reviews-v1-6b87995785-rsn86  Pod         ✔ Running      113s  ready:2/2
│     ├──□ reviews-v1-6b87995785-kdlh9  Pod         ✔ Running      108s  ready:2/2
│     └──□ reviews-v1-6b87995785-cfr84  Pod         ✔ Running      104s  ready:2/2
└──# revision:1                                                          
   └──⧉ reviews-v1-7f9bff4bbb           ReplicaSet  • ScaledDown   2m8s 
```

清理：

kubectl delete rollout reviews-v1 -n istio





###### revisionHistoryLimit

历史版本数量

rollout-reviews-revisionHistoryLimit.yaml

kubectl apply -f rollout-reviews-revisionHistoryLimit.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  revisionHistoryLimit: 5
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      maxSurge: 1
      maxUnavailable: 1
```



```

 kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl argo rollouts get rollout reviews-v1 --watch -n istio

Name:            reviews-v1
Namespace:       istio
Status:          ✔ Healthy
Strategy:        Canary
  Step:          
  SetWeight:     100
  ActualWeight:  100
Images:          docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (stable)
Replicas:
  Desired:       1
  Current:       1
  Updated:       1
  Ready:         1
  Available:     1

NAME                                    KIND        STATUS        AGE    INFO
⟳ reviews-v1                            Rollout     ✔ Healthy     2m18s  
├──# revision:2                                                          
│  └──⧉ reviews-v1-6777b77548           ReplicaSet  ✔ Healthy     98s    stable
│     └──□ reviews-v1-6777b77548-zk7t9  Pod         ✔ Running     97s    ready:2/2
└──# revision:1                                                          
   └──⧉ reviews-v1-c68bcbf9             ReplicaSet  • ScaledDown  2m18s  
```

清理：

kubectl delete rollout reviews-v1 -n istio



###### strategy

[1]canary

canaryService，stableService

release/canary/argo/rollout-reviews-canaryService-stableService.yaml

kubectl apply -f rollout-reviews-canaryService-stableService.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      canaryService: reviews-v1-canary
      stableService: reviews-v1-stable
      steps:
      - setWeight: 20
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
```

release/canary/argo/argo-svc-reviews-canary.yaml

kubectl apply -f argo-svc-reviews-canary.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: reviews-v1-canary
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
```

release/canary/argo/argo-svc-reviews-stable.yaml

kubectl apply -f argo-svc-reviews-stable.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: reviews-v1-stable
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
```



```
kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio
kubectl argo rollouts get rollout reviews-v1 --watch -n istio

Name:            reviews-v1
Namespace:       istio
Status:          ✔ Healthy
Strategy:        Canary
  Step:          4/4
  SetWeight:     100
  ActualWeight:  100
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 (stable)
Replicas:
  Desired:       1
  Current:       1
  Updated:       1
  Ready:         1
  Available:     1

NAME                                    KIND        STATUS         AGE   INFO
⟳ reviews-v1                            Rollout     ✔ Healthy      2m9s  
├──# revision:3                                                          
│  └──⧉ reviews-v1-7f9bff4bbb           ReplicaSet  ✔ Healthy      2m9s  stable
│     └──□ reviews-v1-7f9bff4bbb-827rh  Pod         ✔ Running      32s   ready:2/2
└──# revision:2                                                          
   └──⧉ reviews-v1-6b87995785           ReplicaSet  • ScaledDown   71s   
      └──□ reviews-v1-6b87995785-k56kr  Pod         ◌ Terminating  71s   ready:0/2
```

清理：

kubectl delete rollout reviews-v1 -n istio

kubectl delete svc -n istio  reviews-v1-stable

kubectl delete svc -n istio  reviews-v1-canary



canaryMetadata，stableMetadata

release/canary/argo/rollout-reviews-canaryMetadata-stableMetadata.yaml

kubectl apply -f rollout-reviews-canaryMetadata-stableMetadata.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      canaryService: reviews-v1-canary
      stableService: reviews-v1-stable
      canaryMetadata:
        annotations:
          testcanary: testcanary
        labels:
          testcanary: testcanary
      stableMetadata:
        annotations:
          teststable: teststable
        labels:
          teststable: teststable  
      steps:
      - setWeight: 20
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
```

release/canary/argo/argo-svc-reviews-canary.yaml

kubectl apply -f argo-svc-reviews-canary.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: reviews-v1-canary
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
```

release/canary/argo/argo-svc-reviews-stable.yaml

kubectl apply -f argo-svc-reviews-stable.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: reviews-v1-stable
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
```

```
[root@node01 argo]# kubectl get pod -n istio reviews-v1-7f9bff4bbb-pr67p -o yaml
apiVersion: v1
kind: Pod
metadata:
  annotations:
    kubectl.kubernetes.io/default-container: reviews
    kubectl.kubernetes.io/default-logs-container: reviews
    prometheus.io/path: /stats/prometheus
    prometheus.io/port: "15020"
    prometheus.io/scrape: "true"
    sidecar.istio.io/status: '{"initContainers":["istio-init"],"containers":["istio-proxy"],"volumes":["istio-envoy","istio-data","istio-podinfo","istio-token","istiod-ca-cert"],"imagePullSecrets":null,"revision":"default"}'
    teststable: teststable
  creationTimestamp: "2021-09-11T09:29:25Z"
  generateName: reviews-v1-7f9bff4bbb-
  labels:
    app: reviews
    rollouts-pod-template-hash: 7f9bff4bbb
    security.istio.io/tlsMode: istio
    service.istio.io/canonical-name: reviews
    service.istio.io/canonical-revision: v1
    teststable: teststable
    version: v1

 kubectl get svc -n istio reviews-v1-stable -o yaml
spec:
  clusterIP: 10.68.155.208
  clusterIPs:
  - 10.68.155.208
  ipFamilies:
  - IPv4
  ipFamilyPolicy: SingleStack
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
    rollouts-pod-template-hash: 6777b77548
  sessionAffinity: None
  type: ClusterIP
  
kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio
kubectl argo rollouts get rollout reviews-v1 --watch -n istio

Name:            reviews-v1
Namespace:       istio
Status:          ✔ Healthy
Strategy:        Canary
  Step:          4/4
  SetWeight:     100
  ActualWeight:  100
Images:          docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (stable)
Replicas:
  Desired:       1
  Current:       1
  Updated:       1
  Ready:         1
  Available:     1

NAME                                    KIND        STATUS        AGE    INFO
⟳ reviews-v1                            Rollout     ✔ Healthy     2m59s  
├──# revision:2                                                          
│  └──⧉ reviews-v1-6777b77548           ReplicaSet  ✔ Healthy     99s    stable
│     └──□ reviews-v1-6777b77548-6m8zp  Pod         ✔ Running     99s    ready:2/2
└──# revision:1                                                          
   └──⧉ reviews-v1-c68bcbf9             ReplicaSet  • ScaledDown  2m59s 
   
 
 Events:
  Type    Reason                Age                  From                 Message
  ----    ------                ----                 ----                 -------
  Normal  NewReplicaSetCreated  3m26s                rollouts-controller  Created ReplicaSet reviews-v1-c68bcbf9 (revision 1)
  Normal  ScalingReplicaSet     3m26s                rollouts-controller  Scaled up ReplicaSet reviews-v1-c68bcbf9 (revision 1) from 0 to 1
  Normal  RolloutCompleted      3m26s                rollouts-controller  Rollout completed update to revision 1 (c68bcbf9): Initial deploy
  Normal  RolloutUpdated        3m26s                rollouts-controller  Rollout updated to revision 1
  Normal  SwitchService         3m20s                rollouts-controller  Switched selector for service 'reviews-v1-stable' from '' to 'c68bcbf9'
  Normal  SwitchService         3m20s                rollouts-controller  Switched selector for service 'reviews-v1-canary' from '' to 'c68bcbf9'
  Normal  RolloutUpdated        2m6s                 rollouts-controller  Rollout updated to revision 2
  Normal  NewReplicaSetCreated  2m6s                 rollouts-controller  Created ReplicaSet reviews-v1-6777b77548 (revision 2)
  Normal  ScalingReplicaSet     2m6s                 rollouts-controller  Scaled up ReplicaSet reviews-v1-6777b77548 (revision 2) from 0 to 1
  Normal  RolloutStepCompleted  2m2s                 rollouts-controller  Rollout step 1/4 completed (setWeight: 20)
  Normal  SwitchService         2m2s                 rollouts-controller  Switched selector for service 'reviews-v1-canary' from 'c68bcbf9' to '6777b77548'
  Normal  RolloutPaused         112s (x2 over 2m2s)  rollouts-controller  Rollout is paused (CanaryPauseStep)
  Normal  RolloutStepCompleted  112s                 rollouts-controller  Rollout step 2/4 completed (pause: 10)
  Normal  RolloutStepCompleted  112s                 rollouts-controller  Rollout step 3/4 completed (setWeight: 80)
  Normal  RolloutResumed        102s (x2 over 112s)  rollouts-controller  Rollout is resumed
  Normal  RolloutStepCompleted  102s                 rollouts-controller  Rollout step 4/4 completed (pause: 10)
  Normal  ScalingReplicaSet     102s                 rollouts-controller  Scaled down ReplicaSet reviews-v1-c68bcbf9 (revision 1) from 1 to 0
  Normal  RolloutCompleted      102s                 rollouts-controller  Rollout completed update to revision 2 (6777b77548): Completed all 4 canary steps
  Normal  SwitchService         102s                 rollouts-controller  Switched selector for service 'reviews-v1-stable' from 'c68bcbf9' to '6777b77548'
```

清理：

kubectl delete rollout reviews-v1 -n istio

kubectl delete svc -n istio  reviews-v1-stable

kubectl delete svc -n istio  reviews-v1-canary





 antiAffinity 

preferredDuringSchedulingIgnoredDuringExecution

 does not force a new version's pods to be on a separate node than the previous versions. The scheduler attempts to place the new version's pods on separate node(s). If that's not possible, the new version's pods will still be scheduled. The `Weight` is used to create a priority order for preferred anti-affinity rules. 

release/canary/argo/rollout-canary-istio-preferredDuringSchedulingIgnoredDuringExecution.yaml

kubectl apply -f rollout-canary-istio-preferredDuringSchedulingIgnoredDuringExecution.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      argo: argo
  template:
    metadata:
      labels:
        app: reviews
        argo: argo
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      canaryMetadata:
        labels:
          canary: canary
      stableMetadata:
        labels:
          stable: stable  
      antiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          weight: 1
      trafficRouting:
        istio:
          virtualService:
            name: reviews-vs
            routes:
            - http-primary
          destinationRule:
            name: reviews
            canarySubsetName: v2
            stableSubsetName: v1
      steps:
      - setWeight: 20
      - pause: {}
      - setWeight: 80
      - pause: {duration: 10}

```



release/canary/argo/argo-vs-reviews-subset.yaml

kubectl apply -f argo-vs-reviews-subset.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-vs
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - "*"
  http:
  - name: http-primary
    route:
    - destination:
        host: reviews
        subset: v1
      weight: 100
    - destination:
        host: reviews
        subset: v2
      weight: 0
```

release/canary/argo/dr-reviews.yaml

kubectl apply -f dr-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews.istio.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
  subsets:
  - name: v1
    labels:
      stable: stable
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
  - name: v2
    labels:
      canary: canary
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN

```



```
kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio
kubectl argo rollouts get rollout reviews-v1 --watch -n istio


kubectl argo rollouts promote reviews-v1 -n istio

Name:            reviews-v1
Namespace:       istio
Status:          ✔ Healthy
Strategy:        Canary
  Step:          4/4
  SetWeight:     100
  ActualWeight:  100
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
                 docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (stable)
Replicas:
  Desired:       1
  Current:       2
  Updated:       1
  Ready:         2
  Available:     2

NAME                                    KIND        STATUS     AGE    INFO
⟳ reviews-v1                            Rollout     ✔ Healthy  2m22s  
├──# revision:2                                                       
│  └──⧉ reviews-v1-68bfb8c897           ReplicaSet  ✔ Healthy  66s    stable
│     └──□ reviews-v1-68bfb8c897-kntnm  Pod         ✔ Running  66s    ready:2/2
└──# revision:1                                                       
   └──⧉ reviews-v1-6d5c6b48f4           ReplicaSet  ✔ Healthy  2m1s   delay:25s
      └──□ reviews-v1-6d5c6b48f4-4fk6z  Pod         ✔ Running  104s   ready:2/2
      
Events:
  Type     Reason                   Age                     From                 Message
  ----     ------                   ----                    ----                 -------
  Normal   RolloutUpdated           3m                      rollouts-controller  Rollout updated to revision 1
  Normal   NewReplicaSetCreated     3m                      rollouts-controller  Created ReplicaSet reviews-v1-6d5c6b48f4 (revision 1)
  Warning  DestinationRuleNotFound  2m51s (x10 over 2m59s)  rollouts-controller  DestinationRule `reviews` not found
  Normal   UpdatedDestinationRule   2m43s                   rollouts-controller  DestinationRule reviews subset updated (v2: 6d5c6b48f4, v1: )
  Normal   TrafficWeightUpdated     2m43s                   rollouts-controller  Traffic weight updated to 0
  Normal   ScalingReplicaSet        2m43s                   rollouts-controller  Scaled up ReplicaSet reviews-v1-6d5c6b48f4 (revision 1) from 0 to 1
  Normal   RolloutCompleted         2m43s                   rollouts-controller  Rollout completed update to revision 1 (6d5c6b48f4): Initial deploy
  Normal   TrafficWeightUpdated     2m43s                   rollouts-controller  Traffic weight updated
  Normal   UpdatedDestinationRule   2m39s (x6 over 2m43s)   rollouts-controller  DestinationRule reviews subset updated (v2: 6d5c6b48f4, v1: 6d5c6b48f4)
  Normal   RolloutUpdated           2m5s                    rollouts-controller  Rollout updated to revision 2
  Normal   NewReplicaSetCreated     2m5s                    rollouts-controller  Created ReplicaSet reviews-v1-68bfb8c897 (revision 2
```

清理：

kubectl delete rollout reviews-v1 -n istio

kubectl delete vs -n istio  reviews-vs

kubectl delete dr -n istio  reviews





requiredDuringSchedulingIgnoredDuringExecution

 requires a new version's pods to be on a separate node than the previous versions. If this is not possible, the the new version's pods will not be scheduled. 

release/canary/argo/rollout-canary-istio-requiredDuringSchedulingIgnoredDuringExecution.yaml

kubectl apply -f rollout-canary-istio-requiredDuringSchedulingIgnoredDuringExecution.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      argo: argo
  template:
    metadata:
      labels:
        app: reviews
        argo: argo
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      canaryMetadata:
        labels:
          canary: canary
      stableMetadata:
        labels:
          stable: stable  
      antiAffinity:
        requiredDuringSchedulingIgnoredDuringExecution: {}
      trafficRouting:
        istio:
          virtualService:
            name: reviews-vs
            routes:
            - http-primary
          destinationRule:
            name: reviews
            canarySubsetName: v2
            stableSubsetName: v1
      steps:
      - setWeight: 20
      - pause: {}
      - setWeight: 80
      - pause: {duration: 10}

```



release/canary/argo/argo-vs-reviews-subset.yaml

kubectl apply -f argo-vs-reviews-subset.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-vs
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - "*"
  http:
  - name: http-primary
    route:
    - destination:
        host: reviews
        subset: v1
      weight: 100
    - destination:
        host: reviews
        subset: v2
      weight: 0
```

release/canary/argo/dr-reviews.yaml

kubectl apply -f dr-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews.istio.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
  subsets:
  - name: v1
    labels:
      stable: stable
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
  - name: v2
    labels:
      canary: canary
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN

```



```
kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio
kubectl argo rollouts get rollout reviews-v1 --watch -n istio


kubectl argo rollouts promote reviews-v1 -n istio

Name:            reviews-v1
Namespace:       istio
Status:          ॥ Paused
Message:         CanaryPauseStep
Strategy:        Canary
  Step:          1/4
  SetWeight:     20
  ActualWeight:  20
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 (stable)
                 docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (canary)
Replicas:
  Desired:       1
  Current:       2
  Updated:       1
  Ready:         2
  Available:     2

NAME                                    KIND        STATUS     AGE  INFO
⟳ reviews-v1                            Rollout     ॥ Paused   64s  
├──# revision:2                                                     
│  └──⧉ reviews-v1-68bfb8c897           ReplicaSet  ✔ Healthy  7s   canary
│     └──□ reviews-v1-68bfb8c897-tk4nm  Pod         ✔ Running  7s   ready:2/2
└──# revision:1                                                     
   └──⧉ reviews-v1-6d5c6b48f4           ReplicaSet  ✔ Healthy  54s  stable
      └──□ reviews-v1-6d5c6b48f4-b7hn6  Pod         ✔ Running  45s  ready:2/2
      

Events:
  Type     Reason                   Age                    From                 Message
  ----     ------                   ----                   ----                 -------
  Normal   RolloutUpdated           2m25s                  rollouts-controller  Rollout updated to revision 1
  Normal   NewReplicaSetCreated     2m25s                  rollouts-controller  Created ReplicaSet reviews-v1-6d5c6b48f4 (revision 1)
  Warning  DestinationRuleNotFound  2m21s (x9 over 2m25s)  rollouts-controller  DestinationRule `reviews` not found
  Normal   UpdatedDestinationRule   2m17s                  rollouts-controller  DestinationRule reviews subset updated (v2: 6d5c6b48f4, v1: )
  Normal   TrafficWeightUpdated     2m17s                  rollouts-controller  Traffic weight updated to 0
  Normal   ScalingReplicaSet        2m16s                  rollouts-controller  Scaled up ReplicaSet reviews-v1-6d5c6b48f4 (revision 1) from 0 to 1
  Normal   RolloutCompleted         2m16s                  rollouts-controller  Rollout completed update to revision 1 (6d5c6b48f4): Initial deploy
  Normal   TrafficWeightUpdated     2m16s                  rollouts-controller  Traffic weight updated
  Normal   UpdatedDestinationRule   2m3s (x6 over 2m16s)   rollouts-controller  DestinationRule reviews subset updated (v2: 6d5c6b48f4, v1: 6d5c6b48f4)
  Normal   RolloutUpdated           98s                    rollouts-controller  Rollout updated to revision 2
  Normal   NewReplicaSetCreated     98s                    rollouts-controller  Created ReplicaSet reviews-v1-68bfb8c897 (revision 2)
  Normal   UpdatedDestinationRule   98s                    rollouts-controller  DestinationRule reviews subset updated (v2: 68bfb8c897, v1: 6d5c6b48f4)
```

清理：

kubectl delete rollout reviews-v1 -n istio

kubectl delete vs -n istio  reviews-vs

kubectl delete dr -n istio  reviews



scaleDownDelaySeconds

release/canary/argo/rollout-reviews-scaleDownDelaySeconds.yaml

kubectl apply -f rollout-reviews-scaleDownDelaySeconds.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      scaleDownDelaySeconds: 60
      canaryMetadata:
        labels:
          canary: canary
      stableMetadata:
        labels:
          stable: stable  
      trafficRouting:
        istio:
          virtualService:
            name: reviews-vs
            routes:
            - http-primary
          destinationRule:
            name: reviews
            canarySubsetName: v2
            stableSubsetName: v1
      steps:
      - setWeight: 20
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
```



release/canary/argo/argo-vs-reviews-subset.yaml

kubectl apply -f argo-vs-reviews-subset.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-vs
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - "*"
  http:
  - name: http-primary
    route:
    - destination:
        host: reviews
        subset: v1
      weight: 100
    - destination:
        host: reviews
        subset: v2
      weight: 0
```

release/canary/argo/dr-reviews.yaml

kubectl apply -f dr-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews.istio.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
  subsets:
  - name: v1
    labels:
      stable: stable
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
  - name: v2
    labels:
      canary: canary
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN

```



```
kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio
kubectl argo rollouts get rollout reviews-v1 --watch -n istio


kubectl argo rollouts promote reviews-v1 -n istio


Name:            reviews-v1
Namespace:       istio
Status:          ✔ Healthy
Strategy:        Canary
  Step:          4/4
  SetWeight:     100
  ActualWeight:  100
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
                 docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (stable)
Replicas:
  Desired:       1
  Current:       2
  Updated:       1
  Ready:         2
  Available:     2

NAME                                    KIND        STATUS     AGE    INFO
⟳ reviews-v1                            Rollout     ✔ Healthy  3m55s  
├──# revision:2                                                       
│  └──⧉ reviews-v1-6777b77548           ReplicaSet  ✔ Healthy  35s    stable
│     └──□ reviews-v1-6777b77548-db5dt  Pod         ✔ Running  35s    ready:2/2
└──# revision:1                                                       
   └──⧉ reviews-v1-c68bcbf9             ReplicaSet  ✔ Healthy  82s    delay:50s
      └──□ reviews-v1-c68bcbf9-mldlk    Pod         ✔ Running  82s    ready:2/2
 
 Events:
  Type    Reason                  Age                    From                 Message
  ----    ------                  ----                   ----                 -------
  Normal  RolloutUpdated          2m30s                  rollouts-controller  Rollout updated to revision 1
  Normal  NewReplicaSetCreated    2m30s                  rollouts-controller  Created ReplicaSet reviews-v1-c68bcbf9 (revision 1)
  Normal  UpdatedDestinationRule  2m30s (x2 over 2m30s)  rollouts-controller  DestinationRule reviews subset updated (v2: c68bcbf9, v1: )
  Normal  TrafficWeightUpdated    2m30s (x2 over 2m30s)  rollouts-controller  Traffic weight updated to 0
  Normal  ScalingReplicaSet       2m30s                  rollouts-controller  Scaled up ReplicaSet reviews-v1-c68bcbf9 (revision 1) from 0 to 1
  Normal  RolloutCompleted        2m30s                  rollouts-controller  Rollout completed update to revision 1 (c68bcbf9): Initial deploy
  Normal  UpdatedDestinationRule  2m17s (x7 over 2m30s)  rollouts-controller  DestinationRule reviews subset updated (v2: c68bcbf9, v1: c68bcbf9)
  Normal  TrafficWeightUpdated    103s (x3 over 2m30s)   rollouts-controller  Traffic weight updated
  Normal  RolloutUpdated          103s                   rollouts-controller  Rollout updated to revision 2
  Normal  NewReplicaSetCreated    103s                   rollouts-controller  Created ReplicaSet reviews-v1-6777b77548 (revision 2)
  Normal  UpdatedDestinationRule  103s (x4 over 103s)    rollouts-controller  DestinationRule reviews subset updated (v2: 6777b77548, v1: c68bcbf9)
  Normal  ScalingReplicaSet       103s                   rollouts-controller  Scaled up ReplicaSet reviews-v1-6777b77548 (revision 2) from 0 to 1
```

清理：

kubectl delete rollout reviews-v1 -n istio

kubectl delete vs -n istio  reviews-vs

kubectl delete dr -n istio  reviews



scaleDownDelayRevisionLimit



pingPong

release/canary/argo/rollout-reviews-pingPong.yaml

kubectl apply -f rollout-reviews-pingPong.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      pingPong:
        pingService: reviews-v1-canary
        pongService: reviews-v1-stable
      steps:
      - setWeight: 20
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
```

release/canary/argo/argo-svc-reviews-canary.yaml

kubectl apply -f argo-svc-reviews-canary.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: reviews-v1-canary
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
```

release/canary/argo/argo-svc-reviews-stable.yaml

kubectl apply -f argo-svc-reviews-stable.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: reviews-v1-stable
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
```



```
kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio
kubectl argo rollouts get rollout reviews-v1 --watch -n istio

Name:            reviews-v1
Namespace:       istio
Status:          ◌ Progressing
Message:         old replicas are pending termination
Strategy:        Canary
  Step:          0/4
  SetWeight:     20
  ActualWeight:  0
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 (stable, ping)
                 docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (canary, pong)
Replicas:
  Desired:       1
  Current:       2
  Updated:       1
  Ready:         1
  Available:     1

NAME                                    KIND        STATUS         AGE  INFO
⟳ reviews-v1                            Rollout     ◌ Progressing  29s  
├──# revision:2                                                         
│  └──⧉ reviews-v1-6777b77548           ReplicaSet  ◌ Progressing  3s   canary,pong
│     └──□ reviews-v1-6777b77548-ngr5b  Pod         ✔ Running      3s   ready:1/2
└──# revision:1                                                         
   └──⧉ reviews-v1-c68bcbf9             ReplicaSet  ✔ Healthy      29s  stable,ping
      └──□ reviews-v1-c68bcbf9-5xsj9    Pod         ✔ Running      29s  ready:2/2
      
Events:
  Type    Reason                Age                From                 Message
  ----    ------                ----               ----                 -------
  Normal  RolloutUpdated        67s                rollouts-controller  Rollout updated to revision 1
  Normal  NewReplicaSetCreated  67s                rollouts-controller  Created ReplicaSet reviews-v1-c68bcbf9 (revision 1)
  Normal  SwitchService         67s                rollouts-controller  Switched selector for service 'reviews-v1-canary' from '' to 'c68bcbf9'
  Normal  ScalingReplicaSet     67s                rollouts-controller  Scaled up ReplicaSet reviews-v1-c68bcbf9 (revision 1) from 0 to 1
  Normal  RolloutCompleted      67s                rollouts-controller  Rollout completed update to revision 1 (c68bcbf9): Initial deploy
  Normal  RolloutUpdated        41s                rollouts-controller  Rollout updated to revision 2
  Normal  NewReplicaSetCreated  41s                rollouts-controller  Created ReplicaSet reviews-v1-6777b77548 (revision 2)
  Normal  SwitchService         41s                rollouts-controller  Switched selector for service 'reviews-v1-stable' from '' to '6777b77548'
  Normal  ScalingReplicaSet     41s                rollouts-controller  Scaled up ReplicaSet reviews-v1-6777b77548 (revision 2) from 0 to 1
  Normal  RolloutStepCompleted  37s                rollouts-controller  Rollout step 1/4 completed (setWeight: 20)
  Normal  RolloutPaused         27s (x2 over 37s)  rollouts-controller  Rollout is paused (CanaryPauseStep)
  Normal  RolloutStepCompleted  27s                rollouts-controller  Rollout step 2/4 completed (pause: 10)
  Normal  RolloutStepCompleted  27s                rollouts-controller  Rollout step 3/4 completed (setWeight: 80)
  Normal  RolloutResumed        17s (x2 over 27s)  rollouts-controller  Rollout is resumed
  Normal  RolloutStepCompleted  17s                rollouts-controller  Rollout step 4/4 completed (pause: 10)
  Normal  ScalingReplicaSet     17s                rollouts-controller  Scaled down ReplicaSet reviews-v1-c68bcbf9 (revision 1) from 1 to 0
  Normal  RolloutCompleted      17s                rollouts-controller  Rollout completed update to revision 2 (6777b77548): Completed all 4 canary steps
```

清理：

kubectl delete rollout reviews-v1 -n istio

kubectl delete svc -n istio  reviews-v1-stable

kubectl delete svc -n istio  reviews-v1-canary



dynamicStableScale

release/canary/argo/rollout-reviews-dynamicStableScale.yaml

kubectl apply -f rollout-reviews-dynamicStableScale.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 5
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      dynamicStableScale: true
      canaryMetadata:
        labels:
          canary: canary
      stableMetadata:
        labels:
          stable: stable  
      trafficRouting:
        istio:
          virtualService:
            name: reviews-vs
            routes:
            - http-primary
          destinationRule:
            name: reviews
            canarySubsetName: v2
            stableSubsetName: v1
      steps:
      - setWeight: 20
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
```

release/canary/argo/argo-vs-reviews-subset.yaml

kubectl apply -f argo-vs-reviews-subset.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-vs
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - "*"
  http:
  - name: http-primary
    route:
    - destination:
        host: reviews
        subset: v1
      weight: 100
    - destination:
        host: reviews
        subset: v2
      weight: 0
```

release/canary/argo/dr-reviews.yaml

kubectl apply -f dr-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews.istio.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
  subsets:
  - name: v1
    labels:
      stable: stable
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
  - name: v2
    labels:
      canary: canary
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN

```



```
kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio
kubectl argo rollouts get rollout reviews-v1 --watch -n istio

Name:            reviews-v1
Namespace:       istio
Status:          ◌ Progressing
Message:         more replicas need to be updated
Strategy:        Canary
  Step:          3/4
  SetWeight:     80
  ActualWeight:  80
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 (stable)
                 docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (canary)
Replicas:
  Desired:       5
  Current:       8
  Updated:       4
  Ready:         8
  Available:     8

NAME                                    KIND        STATUS         AGE   INFO
⟳ reviews-v1                            Rollout     ◌ Progressing  114s  
├──# revision:2                                                          
│  └──⧉ reviews-v1-6777b77548           ReplicaSet  ✔ Healthy      34s   canary
│     ├──□ reviews-v1-6777b77548-4q822  Pod         ✔ Running      34s   ready:2/2
│     ├──□ reviews-v1-6777b77548-g66pm  Pod         ✔ Running      9s    ready:2/2
│     ├──□ reviews-v1-6777b77548-ggrz7  Pod         ✔ Running      9s    ready:2/2
│     └──□ reviews-v1-6777b77548-w4q44  Pod         ✔ Running      9s    ready:2/2
└──# revision:1                                                          
   └──⧉ reviews-v1-c68bcbf9             ReplicaSet  ✔ Healthy      114s  stable
      ├──□ reviews-v1-c68bcbf9-2lq56    Pod         ◌ Terminating  114s  ready:2/2
      ├──□ reviews-v1-c68bcbf9-8j5bp    Pod         ◌ Terminating  114s  ready:2/2
      ├──□ reviews-v1-c68bcbf9-vbd7d    Pod         ✔ Running      114s  ready:2/2
      └──□ reviews-v1-c68bcbf9-xpq2j    Pod         ◌ Terminating  114s  ready:2/2
      
Events:
  Type    Reason                  Age                    From                 Message
  ----    ------                  ----                   ----                 -------
  Normal  RolloutUpdated          3m7s                   rollouts-controller  Rollout updated to revision 1
  Normal  NewReplicaSetCreated    3m7s                   rollouts-controller  Created ReplicaSet reviews-v1-c68bcbf9 (revision 1)
  Normal  UpdatedDestinationRule  3m7s                   rollouts-controller  DestinationRule reviews subset updated (v2: c68bcbf9, v1: )
  Normal  TrafficWeightUpdated    3m7s                   rollouts-controller  Traffic weight updated to 0
  Normal  ScalingReplicaSet       3m7s                   rollouts-controller  Scaled up ReplicaSet reviews-v1-c68bcbf9 (revision 1) from 0 to 5
  Normal  RolloutCompleted        3m7s                   rollouts-controller  Rollout completed update to revision 1 (c68bcbf9): Initial deploy
  Normal  UpdatedDestinationRule  2m36s (x10 over 3m7s)  rollouts-controller  DestinationRule reviews subset updated (v2: c68bcbf9, v1: c68bcbf9)
  Normal  TrafficWeightUpdated    107s (x3 over 3m7s)    rollouts-controller  Traffic weight updated
  Normal  RolloutUpdated          107s                   rollouts-controller  Rollout updated to revision 2
  Normal  NewReplicaSetCreated    107s                   rollouts-controller  Created ReplicaSet reviews-v1-6777b77548 (revision 2)
  Normal  ScalingReplicaSet       107s                   rollouts-controller  Scaled up ReplicaSet reviews-v1-6777b77548 (revision 2) from 0 to 1
  Normal  UpdatedDestinationRule  106s (x3 over 107s)    rollouts-controller  DestinationRule reviews subset updated (v2: 6777b77548, v1: c68bcbf9)
```

清理：

kubectl delete rollout reviews-v1 -n istio

kubectl delete vs -n istio  reviews-vs

kubectl delete dr -n istio  reviews



trafficRouting

istio

virtualService

release/canary/argo/rollout-canary-istio.yaml

kubectl apply -f rollout-canary-istio.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      canaryService: reviews-v1-canary
      stableService: reviews-v1-stable
      trafficRouting:
        istio:
          virtualService:
            name: reviews-vs
            routes:
            - http-primary
      steps:
      - setWeight: 20
      - pause: {}
      - setWeight: 40
      - pause: {duration: 10}
      - setWeight: 60
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
```

release/canary/argo/argo-vs-reviews.yaml

kubectl apply -f argo-vs-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-vs
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - "*"
  http:
  - name: http-primary
    route:
    - destination:
        host: reviews-v1-stable
      weight: 100
    - destination:
        host: reviews-v1-canary
      weight: 0
```

release/canary/argo/argo-svc-reviews-canary.yaml

kubectl apply -f argo-svc-reviews-canary.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: reviews-v1-canary
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
```

release/canary/argo/argo-svc-reviews-stable.yaml

kubectl apply -f argo-svc-reviews-stable.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: reviews-v1-stable
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
```



```
 kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio
kubectl argo rollouts get rollout reviews-v1 --watch -n istio


Name:            reviews-v1
Namespace:       istio
Status:          ✔ Healthy
Strategy:        Canary
  Step:          8/8
  SetWeight:     100
  ActualWeight:  100
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 (stable)
Replicas:
  Desired:       1
  Current:       1
  Updated:       1
  Ready:         1
  Available:     1

NAME                                   KIND        STATUS        AGE    INFO
⟳ reviews-v1                           Rollout     ✔ Healthy     49m    
├──# revision:3                                                         
│  └──⧉ reviews-v1-54b55d79d           ReplicaSet  ✔ Healthy     49m    stable
│     └──□ reviews-v1-54b55d79d-tjgr4  Pod         ✔ Running     3m17s  ready:2/2
└──# revision:2                                                         
   └──⧉ reviews-v1-9db5f6df9           ReplicaSet  • ScaledDown  44m 
   
   

kubectl argo rollouts promote  reviews-v1 -n istio

```

清理：

kubectl delete svc reviews-v1-stable -n istio

kubectl delete svc reviews-v1-canary -n istio

kubectl delete vs reviews-vs -n istio

kubectl delete rollout reviews-v1 -n istio



tlsRoutes

1创建证书

mkdir certs

cd certs

 openssl req -x509 -sha256 -nodes -days 365 -newkey rsa:2048 -subj '/O=example Inc./CN=example.com' -keyout example.com.key -out example.com.crt 

 openssl req -out nginx.example.com.csr -newkey rsa:2048 -nodes -keyout nginx.example.com.key -subj "/CN=nginx.example.com/O=some organization" 

 openssl x509 -req -days 365 -CA example.com.crt -CAkey example.com.key -set_serial 0 -in nginx.example.com.csr -out nginx.example.com.crt 

2创建secret

 kubectl create secret tls nginx-server-certs --key nginx.example.com.key --cert nginx.example.com.crt  -n istio

3创建nginx配置文件

```
events {
}

http {
  log_format main '$remote_addr - $remote_user [$time_local]  $status '
  '"$request" $body_bytes_sent "$http_referer" '
  '"$http_user_agent" "$http_x_forwarded_for"';
  access_log /var/log/nginx/access.log main;
  error_log  /var/log/nginx/error.log;

  server {
    listen 443 ssl;

    root /usr/share/nginx/html;
    index index.html;

    server_name nginx.example.com;
    ssl_certificate /etc/nginx-server-certs/tls.crt;
    ssl_certificate_key /etc/nginx-server-certs/tls.key;
  }
}
```

 kubectl create configmap nginx-configmap --from-file=nginx.conf=./nginx.conf  -nistio



4nginx-rollout.yaml

kubectl apply -f nginx-rollout.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: my-nginx
spec:
  selector:
    matchLabels:
      run: my-nginx
  replicas: 1
  template:
    metadata:
      labels:
        run: my-nginx
    spec:
      containers:
      - name: my-nginx
        image: nginx
        ports:
        - containerPort: 443
        volumeMounts:
        - name: nginx-config
          mountPath: /etc/nginx
          readOnly: true
        - name: nginx-server-certs
          mountPath: /etc/nginx-server-certs
          readOnly: true
      volumes:
      - name: nginx-config
        configMap:
          name: nginx-configmap
      - name: nginx-server-certs
        secret:
          secretName: nginx-server-certs
  strategy:
    canary:
      canaryService: my-nginx-canary
      stableService: my-nginx-stable
      trafficRouting:
        istio:
          virtualService:
            name: nginx-vs
            tlsRoutes:
            - port: 443
              sniHosts:
              - nginx.example.com
      steps:
      - setWeight: 20
      - pause: {}
      - setWeight: 40
      - pause: {duration: 10}
      - setWeight: 60
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
```

5创建vs

vs-nginx-sniHosts.yaml

kubectl apply -f vs-nginx-sniHosts.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: nginx-vs
spec:
  hosts:
  - nginx.example.com
  tls:
  - match:
    - sniHosts:
      - nginx.example.com
      port: 443
    route:
    - destination:
        host: my-nginx-canary
        port:
          number: 443
      weight: 0
    - destination:
        host: my-nginx-stable
        port:
          number: 443
      weight: 100
```



release/canary/argo/argo-svc-nginx-canary.yaml

kubectl apply -f argo-svc-nginx-canary.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: my-nginx-canary
spec:
  ports:
  - name: https-canary
    port: 443
    protocol: TCP
    targetPort: 443
  selector:
    run: my-nginx
```

release/canary/argo/argo-svc-nginx-stable.yaml

kubectl apply -f argo-svc-nginx-stable.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: my-nginx-stable
spec:
  ports:
  - name: https-stable
    port: 443
    protocol: TCP
    targetPort: 443
  selector:
    run: my-nginx
```



```
 kubectl argo rollouts set  image my-nginx my-nginx=docker.io/nginx:1.21.6 -n istio

kubectl describe rollout my-nginx  -n istio
kubectl argo rollouts get rollout my-nginx --watch -n istio

Name:            my-nginx
Namespace:       istio
Status:          ◌ Progressing
Message:         waiting for all steps to complete
Strategy:        Canary
  Step:          0/8
  SetWeight:     20
  ActualWeight:  20
Images:          docker.io/nginx:1.21.6 (canary)
                 nginx (stable)
Replicas:
  Desired:       1
  Current:       2
  Updated:       1
  Ready:         1
  Available:     1

NAME                                  KIND        STATUS             AGE    INFO
⟳ my-nginx                            Rollout     ◌ Progressing      3m30s  
├──# revision:2                                                             
│  └──⧉ my-nginx-6d4486f9f7           ReplicaSet  ◌ Progressing      12s    canary
│     └──□ my-nginx-6d4486f9f7-75m2l  Pod           PodInitializing  12s    ready:0/2
└──# revision:1                                                             
   └──⧉ my-nginx-77569964d4           ReplicaSet  ✔ Healthy          3m30s  stable
      └──□ my-nginx-77569964d4-hg7df  Pod         ✔ Running          3m30s  ready:2/2
      
 kubectl argo rollouts promote my-nginx -n istio

Events:
  Type    Reason                  Age                    From                 Message
  ----    ------                  ----                   ----                 -------
  Normal  RolloutUpdated          7m12s                  rollouts-controller  Rollout updated to revision 1
  Normal  NewReplicaSetCreated    7m12s                  rollouts-controller  Created ReplicaSet my-nginx-77569964d4 (revision 1)
  Normal  TrafficWeightUpdated    7m12s (x2 over 7m12s)  rollouts-controller  Traffic weight updated to 0
  Normal  ScalingReplicaSet       7m12s                  rollouts-controller  Scaled up ReplicaSet my-nginx-77569964d4 (revision 1) from 0 to 1
  Normal  RolloutCompleted        7m12s                  rollouts-controller  Rollout completed update to revision 1 (77569964d4): Initial deploy
  Normal  SwitchService           6m54s                  rollouts-controller  Switched selector for service 'my-nginx-stable' from '' to '77569964d4'
  Normal  SwitchService           6m54s                  rollouts-controller  Switched selector for service 'my-nginx-canary' from '' to '77569964d4'
  Normal  TrafficWeightUpdated    3m54s (x3 over 7m12s)  rollouts-controller  Traffic weight updated
  Normal  RolloutUpdated          3m54s                  rollouts-controller  Rollout updated to revision 2
  Normal  NewReplicaSetCreated    3m54s                  rollouts-controller  Created ReplicaSet my-nginx-6d4486f9f7 (revision 2)
  Normal  ScalingReplicaSet       3m54s                  rollouts-controller  Scaled up ReplicaSet my-nginx-6d4486f9f7 (revision 2) from 0 to 1
  Normal  RolloutStepCompleted    2m17s                  rollouts-controller  Rollout step 1/8 completed (setWeight: 20)
  Normal  Updated VirtualService  2m17s                  rollouts-controller  VirtualService `nginx-vs` set to desiredWeight '20'
  Normal  TrafficWeightUpdated    2m17s                  rollouts-controller  Traffic weight updated from 0 to 20
  Normal  SwitchService           2m17s                  rollouts-controller  Switched selector for service 'my-nginx-canary' from '77569964d4' to '6d4486f9f7'
  Normal  RolloutPaused           88s (x2 over 2m17s)    rollouts-controller  Rollout is paused (CanaryPauseStep)
  Normal  RolloutStepCompleted    88s                    rollouts-controller  Rollout step 2/8 completed (pause)
  Normal  Updated VirtualService  88s                    rollouts-controller  VirtualService `nginx-vs` set to desiredWeight '40'
  Normal  TrafficWeightUpdated    88s                    rollouts-controller  Traffic weight updated from 20 to 40
  Normal  RolloutStepCompleted    88s                    rollouts-controller  Rollout step 3/8 completed (setWeight: 40)
  Normal  RolloutStepCompleted    78s                    rollouts-controller  Rollout step 4/8 completed (pause: 10)
  Normal  RolloutResumed          78s                    rollouts-controller  Rollout is resumed
```

清理：

kubectl delete svc my-nginx-stable -n istio

kubectl delete svc my-nginx-canary -n istio

kubectl delete vs  nginx-vs  -n istio

kubectl delete rollout my-nginx -n istio

kubectl delete cm -n istio nginx-configmap

kubectl delete secret -n istio nginx-server-certs





destinationRule

release/canary/argo/rollout-canary-istio-destinationRule.yaml

kubectl apply -f rollout-canary-istio-destinationRule.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      argo: argo
  template:
    metadata:
      labels:
        app: reviews
        argo: argo
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      canaryMetadata:
        labels:
          canary: canary
      stableMetadata:
        labels:
          stable: stable 
      trafficRouting:
        istio:
          virtualService:
            name: reviews-vs
            routes:
            - http-primary
          destinationRule:
            name: reviews
            canarySubsetName: v2
            stableSubsetName: v1
      steps:
      - setWeight: 20
      - pause: {}
      - setWeight: 80
      - pause: {duration: 10}

```



release/canary/argo/argo-vs-reviews-subset.yaml

kubectl apply -f argo-vs-reviews-subset.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-vs
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - "*"
  http:
  - name: http-primary
    route:
    - destination:
        host: reviews
        subset: v1
      weight: 100
    - destination:
        host: reviews
        subset: v2
      weight: 0
```

release/canary/argo/dr-reviews.yaml

kubectl apply -f dr-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews.istio.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
  subsets:
  - name: v1
    labels:
      stable: stable
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
  - name: v2
    labels:
      canary: canary
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN

```





```
 kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio
kubectl argo rollouts get rollout reviews-v1 --watch -n istio

Name:            reviews-v1
Namespace:       istio
Status:          ◌ Progressing
Message:         waiting for all steps to complete
Strategy:        Canary
  Step:          0/4
  SetWeight:     20
  ActualWeight:  20
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 (stable)
                 docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (canary)
Replicas:
  Desired:       1
  Current:       2
  Updated:       1
  Ready:         1
  Available:     1

NAME                                    KIND        STATUS         AGE  INFO
⟳ reviews-v1                            Rollout     ◌ Progressing  76s  
├──# revision:2                                                         
│  └──⧉ reviews-v1-68bfb8c897           ReplicaSet  ◌ Progressing  4s   canary
│     └──□ reviews-v1-68bfb8c897-wcvld  Pod         ✔ Running      3s   ready:1/2
└──# revision:1                                                         
   └──⧉ reviews-v1-6d5c6b48f4           ReplicaSet  ✔ Healthy      60s  stable
      └──□ reviews-v1-6d5c6b48f4-d9pbl  Pod         ✔ Running      43s  ready:2/2
      
kubectl argo rollouts promote reviews-v1 -n istio

Events:
  Type     Reason                   Age                     From                 Message
  ----     ------                   ----                    ----                 -------
  Normal   RolloutUpdated           2m35s                   rollouts-controller  Rollout updated to revision 1
  Normal   NewReplicaSetCreated     2m35s                   rollouts-controller  Created ReplicaSet reviews-v1-6d5c6b48f4 (revision 1)
  Warning  DestinationRuleNotFound  2m26s (x10 over 2m35s)  rollouts-controller  DestinationRule `reviews` not found
  Normal   UpdatedDestinationRule   2m18s                   rollouts-controller  DestinationRule reviews subset updated (v2: 6d5c6b48f4, v1: )
  Normal   TrafficWeightUpdated     2m18s                   rollouts-controller  Traffic weight updated to 0
  Normal   ScalingReplicaSet        2m18s                   rollouts-controller  Scaled up ReplicaSet reviews-v1-6d5c6b48f4 (revision 1) from 0 to 1
  Normal   RolloutCompleted         2m18s                   rollouts-controller  Rollout completed update to revision 1 (6d5c6b48f4): Initial deploy
  Normal   TrafficWeightUpdated     2m18s                   rollouts-controller  Traffic weight updated
  Normal   UpdatedDestinationRule   2m14s (x6 over 2m18s)   rollouts-controller  DestinationRule reviews subset updated (v2: 6d5c6b48f4, v1: 6d5c6b48f4)
  Normal   RolloutUpdated           98s                     rollouts-controller  Rollout updated to revision 2
  Normal   NewReplicaSetCreated     98s                     rollouts-controller  Created ReplicaSet reviews-v1-68bfb8c897 (revision 2)
```

清理：

kubectl delete dr reviews -n istio

kubectl delete vs reviews-vs -n istio

kubectl delete rollout reviews-v1 -n istio



steps

setCanaryScale

release/canary/argo/rollout-reviews-steps-setCanaryScale.yaml

kubectl apply -f rollout-reviews-steps-setCanaryScale.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      canaryMetadata:
        labels:
          canary: canary
      stableMetadata:
        labels:
          stable: stable
      trafficRouting:
        istio:
          virtualService:
            name: reviews-vs
            routes:
            - http-primary
          destinationRule:
            name: reviews
            canarySubsetName: v2
            stableSubsetName: v1
      steps:
      - setWeight: 20
      - setCanaryScale:
          matchTrafficWeight: true
          replicas: 3
          weight: 20
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
```



release/canary/argo/argo-vs-reviews-subset.yaml

kubectl apply -f argo-vs-reviews-subset.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-vs
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - "*"
  http:
  - name: http-primary
    route:
    - destination:
        host: reviews
        subset: v1
      weight: 100
    - destination:
        host: reviews
        subset: v2
      weight: 0
```

release/canary/argo/dr-reviews.yaml

kubectl apply -f dr-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews.istio.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
  subsets:
  - name: v1
    labels:
      stable: stable
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
  - name: v2
    labels:
      canary: canary
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN
```





```
 kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio
kubectl argo rollouts get rollout reviews-v1 --watch -n istio

Name:            reviews-v1
Namespace:       istio
Status:          ॥ Paused
Message:         CanaryPauseStep
Strategy:        Canary
  Step:          2/5
  SetWeight:     20
  ActualWeight:  20
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 (stable)
                 docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (canary)
Replicas:
  Desired:       1
  Current:       2
  Updated:       1
  Ready:         2
  Available:     2

NAME                                    KIND        STATUS     AGE  INFO
⟳ reviews-v1                            Rollout     ॥ Paused   23s  
├──# revision:2                                                     
│  └──⧉ reviews-v1-6777b77548           ReplicaSet  ✔ Healthy  6s   canary
│     └──□ reviews-v1-6777b77548-nkz8b  Pod         ✔ Running  6s   ready:2/2
└──# revision:1                                                     
   └──⧉ reviews-v1-c68bcbf9             ReplicaSet  ✔ Healthy  23s  stable
      └──□ reviews-v1-c68bcbf9-mhqtg    Pod         ✔ Running  22s  ready:2/2

Events:
  Type    Reason                  Age                  From                 Message
  ----    ------                  ----                 ----                 -------
  Normal  RolloutUpdated          111s                 rollouts-controller  Rollout updated to revision 1
  Normal  NewReplicaSetCreated    111s                 rollouts-controller  Created ReplicaSet reviews-v1-c68bcbf9 (revision 1)
  Normal  UpdatedDestinationRule  111s (x2 over 111s)  rollouts-controller  DestinationRule reviews subset updated (v2: c68bcbf9, v1: )
  Normal  TrafficWeightUpdated    111s (x2 over 111s)  rollouts-controller  Traffic weight updated to 0
  Normal  ScalingReplicaSet       111s                 rollouts-controller  Scaled up ReplicaSet reviews-v1-c68bcbf9 (revision 1) from 0 to 1
  Normal  RolloutCompleted        111s                 rollouts-controller  Rollout completed update to revision 1 (c68bcbf9): Initial deploy
  Normal  UpdatedDestinationRule  106s (x7 over 110s)  rollouts-controller  DestinationRule reviews subset updated (v2: c68bcbf9, v1: c68bcbf9)
  Normal  TrafficWeightUpdated    94s (x3 over 110s)   rollouts-controller  Traffic weight updated
  Normal  RolloutUpdated          94s                  rollouts-controller  Rollout updated to revision 2
  Normal  NewReplicaSetCreated    94s                  rollouts-controller  Created ReplicaSet reviews-v1-6777b77548 (revision 2)
  Normal  UpdatedDestinationRule  94s (x4 over 94s)    rollouts-controller  DestinationRule reviews subset updated (v2: 6777b77548, v1: c68bcbf9)
  Normal  ScalingReplicaSet       94s                  rollouts-controller  Scaled up ReplicaSet reviews-v1-6777b77548 (revision 2) from 0 to 1
```

清理：

kubectl delete dr reviews -n istio

kubectl delete vs reviews-vs -n istio

kubectl delete rollout reviews-v1 -n istio



##### AnalysisTemplate

###### analysis steps

release/canary/argo/argo-AnalysisTemplate-reviews.yaml

kubectl apply -f argo-AnalysisTemplate-reviews.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: success-rate
spec:
  args:
  - name: service-name
  metrics:
  - name: success-rate
    interval: 60s
    count: 5
    successCondition: result[0] >= 0.50
    failureLimit: 3
    provider:
      prometheus:
        address: http://prometheus.istio-system:9090
        query: |
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}",response_code!~"5.*"}[5m]
          )) / 
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}"}[5m]
          ))
```

release/canary/argo/rollout-canary-reviewsAnalysisTemplate.yaml

kubectl apply -f rollout-canary-reviewsAnalysisTemplate.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      canaryMetadata:
        labels:
          canary: canary
      stableMetadata:
        labels:
          stable: stable
      trafficRouting:
        istio:
          virtualService:
            name: reviews-vs
            routes:
            - http-primary
          destinationRule:
            name: reviews
            canarySubsetName: v2
            stableSubsetName: v1
      steps:
      - setWeight: 20
      - pause: {}
      - analysis:
          templates:
          - templateName: success-rate
            clusterScope: false
          args:
          - name: service-name
            value: reviews.istio.svc.cluster.local
      - setWeight: 40
      - pause: {duration: 10}
      - setWeight: 60
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
      
```

istio-teaching/gateway/gateway-01.yaml

```
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
```

release/canary/argo/argo-vs-reviews-subset.yaml

kubectl apply -f argo-vs-reviews-subset.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-vs
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - "*"
  http:
  - name: http-primary
    route:
    - destination:
        host: reviews
        subset: v1
      weight: 100
    - destination:
        host: reviews
        subset: v2
      weight: 0
```



release/canary/argo/dr-reviews.yaml

kubectl apply -f dr-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews.istio.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
  subsets:
  - name: v1
    labels:
      stable: stable
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
  - name: v2
    labels:
      canary: canary
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN
```





```
go-stress-testing -c 10 -n 1000000 -u http://192.168.229.134:30684/reviews/0

kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio
kubectl argo rollouts get rollout reviews-v1 --watch -n istio

Name:            reviews-v1
Namespace:       istio
Status:          ॥ Paused
Message:         CanaryPauseStep
Strategy:        Canary
  Step:          6/9
  SetWeight:     60
  ActualWeight:  60
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 (stable)
                 docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (canary)
Replicas:
  Desired:       1
  Current:       2
  Updated:       1
  Ready:         2
  Available:     2

NAME                                    KIND         STATUS        AGE    INFO
⟳ reviews-v1                            Rollout      ॥ Paused      121m   
├──# revision:16                                                          
│  ├──⧉ reviews-v1-6b87995785           ReplicaSet   ✔ Healthy     120m   canary
│  │  └──□ reviews-v1-6b87995785-8t7xp  Pod          ✔ Running     4m33s  ready:2/2
│  └──α reviews-v1-6b87995785-16-2      AnalysisRun  ✔ Successful  4m16s  ✔ 5
├──# revision:15                                                          
│  └──⧉ reviews-v1-7f9bff4bbb           ReplicaSet   ✔ Healthy     121m   stable
│     └──□ reviews-v1-7f9bff4bbb-j46nz  Pod          ✔ Running     29m    ready:2/2
├──# revision:14                                                          
│  └──α reviews-v1-6b87995785-14-2      AnalysisRun  ✖ Failed      13m    ✖ 4
└──# revision:12                                                          
   └──α reviews-v1-6b87995785-12-2      AnalysisRun  ⚠ Error       16m    ⚠ 5
   
   

kubectl argo rollouts promote  reviews-v1 -n istio


Events:
  Type    Reason                  Age                    From                 Message
  ----    ------                  ----                   ----                 -------
  Normal  RolloutUpdated          6m27s                  rollouts-controller  Rollout updated to revision 1
  Normal  NewReplicaSetCreated    6m27s                  rollouts-controller  Created ReplicaSet reviews-v1-c68bcbf9 (revision 1)
  Normal  UpdatedDestinationRule  6m27s (x2 over 6m27s)  rollouts-controller  DestinationRule reviews subset updated (v2: c68bcbf9, v1: )
  Normal  TrafficWeightUpdated    6m27s (x2 over 6m27s)  rollouts-controller  Traffic weight updated to 0
  Normal  ScalingReplicaSet       6m27s                  rollouts-controller  Scaled up ReplicaSet reviews-v1-c68bcbf9 (revision 1) from 0 to 1
  Normal  RolloutCompleted        6m27s                  rollouts-controller  Rollout completed update to revision 1 (c68bcbf9): Initial deploy
  Normal  UpdatedDestinationRule  6m22s (x6 over 6m26s)  rollouts-controller  DestinationRule reviews subset updated (v2: c68bcbf9, v1: c68bcbf9)
  Normal  TrafficWeightUpdated    6m5s (x3 over 6m26s)   rollouts-controller  Traffic weight updated
  Normal  RolloutUpdated          6m5s                   rollouts-controller  Rollout updated to revision 2
  Normal  NewReplicaSetCreated    6m5s                   rollouts-controller  Created ReplicaSet reviews-v1-6777b77548 (revision 2)
  Normal  ScalingReplicaSet       6m5s                   rollouts-controller  Scaled up ReplicaSet reviews-v1-6777b77548 (revision 2) from 0 to 1
  Normal  UpdatedDestinationRule  80s (x24 over 6m5s)    rollouts-controller  DestinationRule reviews subset updated (v2: 6777b77548, v1: c68bcbf9)
```



清理：

kubectl delete vs reviews-vs -n istio

kubectl delete dr reviews -n istio

kubectl delete rollout reviews-v1 -n istio

kubectl delete AnalysisTemplate success-rate -n istio



###### analysis-outside

release/canary/argo/argo-AnalysisTemplate-reviews.yaml

kubectl apply -f argo-AnalysisTemplate-reviews.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: success-rate
spec:
  args:
  - name: service-name
  metrics:
  - name: success-rate
    interval: 60s
    count: 5
    successCondition: result[0] >= 0.50
    failureLimit: 3
    provider:
      prometheus:
        address: http://prometheus.istio-system:9090
        query: |
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}",response_code!~"5.*"}[5m]
          )) / 
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}"}[5m]
          ))
```

release/canary/argo/rollout-canary-reviews-analysis-outside.yaml

kubectl apply -f rollout-canary-reviews-analysis-outside.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      canaryMetadata:
        labels:
          canary: canary
      stableMetadata:
        labels:
          stable: stable 
      trafficRouting:
        istio:
          virtualService:
            name: reviews-vs
            routes:
            - http-primary
          destinationRule:
            name: reviews
            canarySubsetName: v2
            stableSubsetName: v1
      analysis:
        templates:
        - templateName: success-rate
          clusterScope: false
        args:
        - name: service-name
          value: reviews.istio.svc.cluster.local
      steps:
      - setWeight: 20
      - pause: {}
      - setWeight: 40
      - pause: {duration: 10}
      - setWeight: 60
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
      
```

release/canary/argo/argo-vs-reviews-subset.yaml

kubectl apply -f argo-vs-reviews-subset.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-vs
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - "*"
  http:
  - name: http-primary
    route:
    - destination:
        host: reviews
        subset: v1
      weight: 100
    - destination:
        host: reviews
        subset: v2
      weight: 0
```

release/canary/argo/dr-reviews.yaml

kubectl apply -f dr-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews.istio.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
  subsets:
  - name: v1
    labels:
      stable: stable
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
  - name: v2
    labels:
      canary: canary
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN
```



```
 kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio
 
  go-stress-testing -c 10 -n 1000000 -u http://192.168.229.134:30468/reviews/0

kubectl describe rollout reviews-v1  -n istio
kubectl argo rollouts get rollout reviews-v1 --watch -n istio

Name:            reviews-v1
Namespace:       istio
Status:          ✔ Healthy
Strategy:        Canary
  Step:          8/8
  SetWeight:     100
  ActualWeight:  100
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 (stable)
Replicas:
  Desired:       1
  Current:       2
  Updated:       1
  Ready:         2
  Available:     2

NAME                                    KIND         STATUS         AGE   INFO
⟳ reviews-v1                            Rollout      ✔ Healthy      127m  
├──# revision:17                                                          
│  ├──⧉ reviews-v1-7f9bff4bbb           ReplicaSet   ✔ Healthy      127m  stable
│  │  └──□ reviews-v1-7f9bff4bbb-ws2c7  Pod          ✔ Running      81s   ready:2/2
│  └──α reviews-v1-7f9bff4bbb-17        AnalysisRun  ✔ Successful   81s   ✖ 1
├──# revision:16                                                          
│  ├──⧉ reviews-v1-6b87995785           ReplicaSet   • ScaledDown   127m  
│  │  └──□ reviews-v1-6b87995785-8t7xp  Pod          ◌ Terminating  11m   ready:2/2
│  └──α reviews-v1-6b87995785-16-2      AnalysisRun  ✔ Successful   10m   ✔ 5
├──# revision:14                                                          
│  └──α reviews-v1-6b87995785-14-2      AnalysisRun  ✖ Failed       19m   ✖ 4
└──# revision:12                                                          
   └──α reviews-v1-6b87995785-12-2      AnalysisRun  ⚠ Error        22m   ⚠ 5

   
   

kubectl argo rollouts promote  reviews-v1 -n istio


Events:
  Type    Reason                  Age                    From                 Message
  ----    ------                  ----                   ----                 -------
  Normal  RolloutUpdated          4m28s                  rollouts-controller  Rollout updated to revision 1
  Normal  NewReplicaSetCreated    4m28s                  rollouts-controller  Created ReplicaSet reviews-v1-c68bcbf9 (revision 1)
  Normal  UpdatedDestinationRule  4m28s (x2 over 4m28s)  rollouts-controller  DestinationRule reviews subset updated (v2: c68bcbf9, v1: )
  Normal  TrafficWeightUpdated    4m28s (x2 over 4m28s)  rollouts-controller  Traffic weight updated to 0
  Normal  ScalingReplicaSet       4m28s                  rollouts-controller  Scaled up ReplicaSet reviews-v1-c68bcbf9 (revision 1) from 0 to 1
  Normal  RolloutCompleted        4m28s                  rollouts-controller  Rollout completed update to revision 1 (c68bcbf9): Initial deploy
  Normal  UpdatedDestinationRule  4m15s (x7 over 4m28s)  rollouts-controller  DestinationRule reviews subset updated (v2: c68bcbf9, v1: c68bcbf9)
  Normal  RolloutUpdated          4m4s                   rollouts-controller  Rollout updated to revision 2
  Normal  NewReplicaSetCreated    4m4s                   rollouts-controller  Created ReplicaSet reviews-v1-6777b77548 (revision 2)
  Normal  TrafficWeightUpdated    4m3s (x3 over 4m28s)   rollouts-controller  Traffic weight updated
  Normal  UpdatedDestinationRule  4m3s (x3 over 4m4s)    rollouts-controller  DestinationRule reviews subset updated (v2: 6777b77548, v1: c68bcbf9)
  Normal  AnalysisRunRunning      4m3s                   rollouts-controller  Background Analysis Run 'reviews-v1-6777b77548-2' Status New: 'Running' Previous: 'NoPreviousStatus'
  Normal  ScalingReplicaSet       4m3s                   rollouts-controller  Scaled up ReplicaSet reviews-v1-6777b77548 (revision 2) from 0 to 1
```



清理：

kubectl delete vs reviews-vs -n istio

kubectl delete dr reviews -n istio

kubectl delete rollout reviews-v1 -n istio

kubectl delete AnalysisTemplate success-rate -n istio



###### startingStep

release/canary/argo/argo-AnalysisTemplate-reviews.yaml

kubectl apply -f argo-AnalysisTemplate-reviews.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: success-rate
spec:
  args:
  - name: service-name
  metrics:
  - name: success-rate
    interval: 60s
    count: 5
    successCondition: result[0] >= 0.50
    failureLimit: 3
    provider:
      prometheus:
        address: http://prometheus.istio-system:9090
        query: |
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}",response_code!~"5.*"}[5m]
          )) / 
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}"}[5m]
          ))
```

release/canary/argo/rollout-canary-reviews-analysis-outside-startingStep.yaml

kubectl apply -f rollout-canary-reviews-analysis-outside-startingStep.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
  template:
    metadata:
      labels:
        app: reviews
        version: v1
        version: v2
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      canaryMetadata:
        labels:
          canary: canary
      stableMetadata:
        labels:
          stable: stable 
      trafficRouting:
        istio:
          virtualService:
            name: reviews-vs
            routes:
            - http-primary
          destinationRule:
            name: reviews
            canarySubsetName: v2
            stableSubsetName: v1
      analysis:
        startingStep: 5
        templates:
        - templateName: success-rate
          clusterScope: false
        args:
        - name: service-name
          value: reviews.istio.svc.cluster.local
      steps:
      - setWeight: 20
      - pause: {}
      - setWeight: 40
      - pause: {duration: 10}
      - setWeight: 60
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
      
```

release/canary/argo/argo-vs-reviews-subset.yaml

kubectl apply -f argo-vs-reviews-subset.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-vs
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - "*"
  http:
  - name: http-primary
    route:
    - destination:
        host: reviews
        subset: v1
      weight: 100
    - destination:
        host: reviews
        subset: v2
      weight: 0
```

release/canary/argo/dr-reviews.yaml

kubectl apply -f dr-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews.istio.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
  subsets:
  - name: v1
    labels:
      stable: stable
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
  - name: v2
    labels:
      canary: canary
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN
```





```
 kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio
kubectl argo rollouts get rollout reviews-v1 --watch -n istio

Name:            reviews-v1
Namespace:       istio
Status:          ॥ Paused
Message:         CanaryPauseStep
Strategy:        Canary
  Step:          5/8
  SetWeight:     60
  ActualWeight:  60
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 (canary, stable)
Replicas:
  Desired:       1
  Current:       2
  Updated:       1
  Ready:         2
  Available:     2

NAME                                    KIND         STATUS        AGE    INFO
⟳ reviews-v1                            Rollout      ॥ Paused      132m   
├──# revision:18                                                          
│  ├──⧉ reviews-v1-5665fcbd47           ReplicaSet   ✔ Healthy     48s    canary
│  │  └──□ reviews-v1-5665fcbd47-5qrml  Pod          ✔ Running     47s    ready:2/2
│  └──α reviews-v1-5665fcbd47-18        AnalysisRun  ◌ Running     7s     ✔ 1
├──# revision:17                                                          
│  ├──⧉ reviews-v1-7f9bff4bbb           ReplicaSet   ✔ Healthy     132m   stable
│  │  └──□ reviews-v1-7f9bff4bbb-ws2c7  Pod          ✔ Running     6m11s  ready:2/2
│  └──α reviews-v1-7f9bff4bbb-17        AnalysisRun  ✔ Successful  6m11s  ✖ 1
├──# revision:16                                                          
│  ├──⧉ reviews-v1-6b87995785           ReplicaSet   • ScaledDown  132m   
│  └──α reviews-v1-6b87995785-16-2      AnalysisRun  ✔ Successful  15m    ✔ 5
├──# revision:14                                                          
│  └──α reviews-v1-6b87995785-14-2      AnalysisRun  ✖ Failed      24m    ✖ 4
└──# revision:12                                                          
   └──α reviews-v1-6b87995785-12-2      AnalysisRun  ⚠ Error       27m    ⚠ 5
   
   

kubectl argo rollouts promote  reviews-v1 -n istio

Events:
  Type    Reason                  Age                    From                 Message
  ----    ------                  ----                   ----                 -------
  Normal  RolloutUpdated          6m53s                  rollouts-controller  Rollout updated to revision 1
  Normal  NewReplicaSetCreated    6m53s                  rollouts-controller  Created ReplicaSet reviews-v1-5f7dbd7788 (revision 1)
  Normal  UpdatedDestinationRule  6m52s (x2 over 6m53s)  rollouts-controller  DestinationRule reviews subset updated (v2: 5f7dbd7788, v1: )
  Normal  TrafficWeightUpdated    6m52s (x2 over 6m53s)  rollouts-controller  Traffic weight updated to 0
  Normal  ScalingReplicaSet       6m52s                  rollouts-controller  Scaled up ReplicaSet reviews-v1-5f7dbd7788 (revision 1) from 0 to 1
  Normal  RolloutCompleted        6m52s                  rollouts-controller  Rollout completed update to revision 1 (5f7dbd7788): Initial deploy
  Normal  UpdatedDestinationRule  6m48s (x7 over 6m52s)  rollouts-controller  DestinationRule reviews subset updated (v2: 5f7dbd7788, v1: 5f7dbd7788)
  Normal  TrafficWeightUpdated    6m20s (x3 over 6m52s)  rollouts-controller  Traffic weight updated
  Normal  RolloutUpdated          6m20s                  rollouts-controller  Rollout updated to revision 2
  Normal  NewReplicaSetCreated    6m20s                  rollouts-controller  Created ReplicaSet reviews-v1-7fc68d9675 (revision 2)
  Normal  ScalingReplicaSet       6m20s                  rollouts-controller  Scaled up ReplicaSet reviews-v1-7fc68d9675 (revision 2) from 0 to 1
  Normal  UpdatedDestinationRule  6m19s (x4 over 6m20s)  rollouts-controller  DestinationRule reviews subset updated (v2: 7fc68d9675, v1: 5f7dbd7788)
```



清理：

kubectl delete vs reviews-vs -n istio

kubectl delete dr reviews -n istio

kubectl delete rollout reviews-v1 -n istio

kubectl delete AnalysisTemplate success-rate -n istio



###### job

release/canary/argo/argo-AnalysisTemplate-job-reviews.yaml

kubectl apply -f argo-AnalysisTemplate-job-reviews.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: success-rate
spec:
  args:
  - name: service-name
  metrics:
  - name: success-rate
    interval: 60s
    count: 5
    successCondition: result[0] >= 0.5
    failureLimit: 3
    provider:
      job:
        spec:
          backoffLimit: 1
          template:
            metadata:
              annotations:
                sidecar.istio.io/inject: “true”
            spec:
              containers:
              - name: test
                image: busybox
                command: [wget]
                args: ["http://192.168.229.134:30684/reviews/0"]
              restartPolicy: Never
```

release/canary/argo/rollout-canary-reviewsAnalysisTemplate.yaml

kubectl apply -f rollout-canary-reviewsAnalysisTemplate.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
  template:
    metadata:
      labels:
        app: reviews
        version: v1
        version: v2
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      canaryMetadata:
        labels:
          canary: canary
      stableMetadata:
        labels:
          stable: stable
      trafficRouting:
        istio:
          virtualService:
            name: reviews-vs
            routes:
            - http-primary
          destinationRule:
            name: reviews
            canarySubsetName: v2
            stableSubsetName: v1
      steps:
      - setWeight: 20
      - pause: {}
      - analysis:
          templates:
          - templateName: success-rate
            clusterScope: false
          args:
          - name: service-name
            value: reviews.istio.svc.cluster.local
      - setWeight: 40
      - pause: {duration: 10}
      - setWeight: 60
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
      
```

release/canary/argo/argo-vs-reviews-subset.yaml

kubectl apply -f argo-vs-reviews-subset.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-vs
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - "*"
  http:
  - name: http-primary
    route:
    - destination:
        host: reviews
        subset: v1
      weight: 100
    - destination:
        host: reviews
        subset: v2
      weight: 0
```

release/canary/argo/dr-reviews.yaml

kubectl apply -f dr-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews.istio.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
  subsets:
  - name: v1
    labels:
      stable: stable
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
  - name: v2
    labels:
      canary: canary
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN
```



```
 kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio
   go-stress-testing -c 10 -n 1000000 -u http://192.168.229.134:30468/reviews/0

kubectl describe rollout reviews-v1  -n istio
kubectl argo rollouts get rollout reviews-v1 --watch -n istio

Name:            reviews-v1
Namespace:       istio
Status:          ◌ Progressing
Message:         waiting for all steps to complete
Strategy:        Canary
  Step:          2/9
  SetWeight:     20
  ActualWeight:  20
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 (stable)
                 docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (canary)
Replicas:
  Desired:       1
  Current:       2
  Updated:       1
  Ready:         2
  Available:     2

NAME                                                            KIND         STATUS         AGE    INFO
⟳ reviews-v1                                                    Rollout      ◌ Progressing  3m40s  
├──# revision:2                                                                                    
│  ├──⧉ reviews-v1-6b87995785                                   ReplicaSet   ✔ Healthy      3m22s  canary
│  │  └──□ reviews-v1-6b87995785-hghjp                          Pod          ✔ Running      3m22s  ready:2/2
│  └──α reviews-v1-6b87995785-2-2                               AnalysisRun  ◌ Running      2m32s  ✔ 3
│     └──⊞ aa9ca4a9-7557-4d4e-bf4a-71a7b5b3d1bf.success-rate.3  Job          ✔ Successful   30s    
└──# revision:1                                                                                    
   └──⧉ reviews-v1-7f9bff4bbb                                   ReplicaSet   ✔ Healthy      3m40s  stable
      └──□ reviews-v1-7f9bff4bbb-4b4gd                          Pod          ✔ Running      3m40s  ready:2/2
   
   

kubectl argo rollouts promote  reviews-v1 -n istio


Events:
  Type    Reason                  Age                    From                 Message
  ----    ------                  ----                   ----                 -------
  Normal  RolloutUpdated          16m                    rollouts-controller  Rollout updated to revision 1
  Normal  NewReplicaSetCreated    16m                    rollouts-controller  Created ReplicaSet reviews-v1-5f7dbd7788 (revision 1)
  Normal  UpdatedDestinationRule  16m (x2 over 16m)      rollouts-controller  DestinationRule reviews subset updated (v2: 5f7dbd7788, v1: )
  Normal  TrafficWeightUpdated    16m (x2 over 16m)      rollouts-controller  Traffic weight updated to 0
  Normal  ScalingReplicaSet       16m                    rollouts-controller  Scaled up ReplicaSet reviews-v1-5f7dbd7788 (revision 1) from 0 to 1
  Normal  RolloutCompleted        16m                    rollouts-controller  Rollout completed update to revision 1 (5f7dbd7788): Initial deploy
  Normal  UpdatedDestinationRule  16m (x7 over 16m)      rollouts-controller  DestinationRule reviews subset updated (v2: 5f7dbd7788, v1: 5f7dbd7788)
  Normal  TrafficWeightUpdated    16m (x3 over 16m)      rollouts-controller  Traffic weight updated
  Normal  RolloutUpdated          16m                    rollouts-controller  Rollout updated to revision 2
  Normal  NewReplicaSetCreated    16m                    rollouts-controller  Created ReplicaSet reviews-v1-7fc68d9675 (revision 2)
  Normal  ScalingReplicaSet       16m                    rollouts-controller  Scaled up ReplicaSet reviews-v1-7fc68d9675 (revision 2) from 0 to 1
  Normal  UpdatedDestinationRule  16m (x4 over 16m)      rollouts-controller  DestinationRule reviews subset updated (v2: 7fc68d9675, v1: 5f7dbd7788)
  Normal  RolloutUpdated          4m25s                  rollouts-controller  Rollout updated to revision 3
  Normal  UpdatedDestinationRule  102s (x24 over 4m25s)  rollouts-controller  DestinationRule reviews subset updated (v2: 5f7dbd7788, v1: 7fc68d9675)
```



清理：

kubectl delete vs reviews-vs -n istio

kubectl delete dr reviews -n istio

kubectl delete rollout reviews-v1 -n istio

kubectl delete AnalysisTemplate success-rate -n istio





###### web

release/canary/argo/argo-AnalysisTemplate-web-reviews.yaml

kubectl apply -f argo-AnalysisTemplate-web-reviews.yaml -n istio

```
{
  "data": {
    "ok": true,
    "successPercent": 0.95
  }
}
```



```
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: success-rate
spec:
  args:
  - name: service-name
  metrics:
  - name: webmetric
    successCondition: "result.ok && result.successPercent >= 0.90"
    provider:
      web:
        url: "http://my-server.com/api/v1/measurement?service={{ args.service-name }}"
        headers:
          - key: Authorization
            value: "Bearer {{ args.api-token }}"
        jsonPath: "{$.data}"
```

release/canary/argo/rollout-canary-reviewsAnalysisTemplate.yaml

kubectl apply -f rollout-canary-reviewsAnalysisTemplate.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      canaryMetadata:
        labels:
          canary: canary
      stableMetadata:
        labels:
          stable: stable
      trafficRouting:
        istio:
          virtualService:
            name: reviews-vs
            routes:
            - http-primary
          destinationRule:
            name: reviews
            canarySubsetName: v2
            stableSubsetName: v1
      steps:
      - setWeight: 20
      - pause: {}
      - analysis:
          templates:
          - templateName: success-rate
            clusterScope: false
          args:
          - name: service-name
            value: reviews.istio.svc.cluster.local
      - setWeight: 40
      - pause: {duration: 10}
      - setWeight: 60
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
      
```

release/canary/argo/argo-vs-reviews-subset.yaml

kubectl apply -f argo-vs-reviews-subset.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-vs
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - "*"
  http:
  - name: http-primary
    route:
    - destination:
        host: reviews
        subset: v1
      weight: 100
    - destination:
        host: reviews
        subset: v2
      weight: 0
```

release/canary/argo/dr-reviews.yaml

kubectl apply -f dr-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews.istio.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
  subsets:
  - name: v1
    labels:
      stable: stable
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
  - name: v2
    labels:
      canary: canary
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN
```



```
 kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio
kubectl argo rollouts get rollout reviews-v1 --watch -n istio

   
   

kubectl argo rollouts promote  reviews-v1 -n istio

```



清理：

kubectl delete vs reviews-vs -n istio

kubectl delete dr reviews -n istio

kubectl delete rollout reviews-v1 -n istio

kubectl delete AnalysisTemplate success-rate -n istio



###### consecutiveErrorLimit

连续错误限值

release/canary/argo/argo-AnalysisTemplate-job-consecutiveErrorLimit.yaml

kubectl apply -f argo-AnalysisTemplate-job-consecutiveErrorLimit.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: success-rate
spec:
  args:
  - name: service-name
  metrics:
  - name: success-rate
    interval: 60s
    count: 5
    successCondition: result[0] >= 0.5
    failureLimit: 3
    consecutiveErrorLimit: 2
    provider:
      job:
        spec:
          backoffLimit: 1
          template:
            metadata:
              annotations:
                sidecar.istio.io/inject: “true”
            spec:
              containers:
              - name: test
                image: busybox
                command: [wget]
                args: ["http://192.168.229.134:30684/error"]
              restartPolicy: Never
```

release/canary/argo/rollout-canary-reviewsAnalysisTemplate.yaml

kubectl apply -f rollout-canary-reviewsAnalysisTemplate.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
  template:
    metadata:
      labels:
        app: reviews
        version: v1
        version: v2
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      canaryMetadata:
        labels:
          canary: canary
      stableMetadata:
        labels:
          stable: stable
      trafficRouting:
        istio:
          virtualService:
            name: reviews-vs
            routes:
            - http-primary
          destinationRule:
            name: reviews
            canarySubsetName: v2
            stableSubsetName: v1
      steps:
      - setWeight: 20
      - pause: {}
      - analysis:
          templates:
          - templateName: success-rate
            clusterScope: false
          args:
          - name: service-name
            value: reviews.istio.svc.cluster.local
      - setWeight: 40
      - pause: {duration: 10}
      - setWeight: 60
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
      
```

release/canary/argo/argo-vs-reviews-subset.yaml

kubectl apply -f argo-vs-reviews-subset.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-vs
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - "*"
  http:
  - name: http-primary
    route:
    - destination:
        host: reviews
        subset: v1
      weight: 100
    - destination:
        host: reviews
        subset: v2
      weight: 0
```

release/canary/argo/dr-reviews.yaml

kubectl apply -f dr-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews.istio.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
  subsets:
  - name: v1
    labels:
      stable: stable
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
  - name: v2
    labels:
      canary: canary
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN
```



```
 kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio
kubectl argo rollouts get rollout reviews-v1 --watch -n istio

 Name:            reviews-v1
Namespace:       istio
Status:          ✖ Degraded
Message:         RolloutAborted: Rollout aborted update to revision 3: metric "success-rate" assessed Failed due to failed (4) > failureLimit (3)
Strategy:        Canary
  Step:          0/9
  SetWeight:     0
  ActualWeight:  0
Images:          docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (stable)
Replicas:
  Desired:       1
  Current:       1
  Updated:       0
  Ready:         1
  Available:     1

NAME                                                            KIND         STATUS         AGE    INFO
⟳ reviews-v1                                                    Rollout      ✖ Degraded     24m    
├──# revision:3                                                                                    
│  ├──⧉ reviews-v1-7f9bff4bbb                                   ReplicaSet   • ScaledDown   24m    canary
│  │  └──□ reviews-v1-7f9bff4bbb-r5mh8                          Pod          ◌ Terminating  4m3s   ready:2/2
│  └──α reviews-v1-7f9bff4bbb-3-2                               AnalysisRun  ✖ Failed       3m50s  ✖ 4
│     └──⊞ 9126fd9c-bb2b-49b7-a0e1-064b9a706834.success-rate.4  Job          ✖ Failed       15s    
└──# revision:2                                                                                    
   ├──⧉ reviews-v1-6b87995785                                   ReplicaSet   ✔ Healthy      24m    stable
   │  └──□ reviews-v1-6b87995785-hghjp                          Pod          ✔ Running      24m    ready:2/2
   └──α reviews-v1-6b87995785-2-2                               AnalysisRun  ✔ Successful   23m    ✔ 5
      └──⊞ aa9ca4a9-7557-4d4e-bf4a-71a7b5b3d1bf.success-rate.5  Job          ✔ Successful   19m    

kubectl argo rollouts promote  reviews-v1 -n istio

Events:
  Type    Reason                  Age                  From                 Message
  ----    ------                  ----                 ----                 -------
  Normal  NewReplicaSetCreated    49m                  rollouts-controller  Created ReplicaSet reviews-v1-5f7dbd7788 (revision 1)
  Normal  RolloutUpdated          49m                  rollouts-controller  Rollout updated to revision 1
  Normal  UpdatedDestinationRule  49m (x2 over 49m)    rollouts-controller  DestinationRule reviews subset updated (v2: 5f7dbd7788, v1: )
  Normal  TrafficWeightUpdated    49m (x2 over 49m)    rollouts-controller  Traffic weight updated to 0
  Normal  ScalingReplicaSet       49m                  rollouts-controller  Scaled up ReplicaSet reviews-v1-5f7dbd7788 (revision 1) from 0 to 1
  Normal  RolloutCompleted        49m                  rollouts-controller  Rollout completed update to revision 1 (5f7dbd7788): Initial deploy
  Normal  RolloutUpdated          48m                  rollouts-controller  Rollout updated to revision 2
  Normal  NewReplicaSetCreated    48m                  rollouts-controller  Created ReplicaSet reviews-v1-7fc68d9675 (revision 2)
  Normal  ScalingReplicaSet       48m                  rollouts-controller  Scaled up ReplicaSet reviews-v1-7fc68d9675 (revision 2) from 0 to 1
  Normal  RolloutUpdated          37m                  rollouts-controller  Rollout updated to revision 3
  Normal  UpdatedDestinationRule  34m (x24 over 37m)   rollouts-controller  DestinationRule reviews subset updated (v2: 5f7dbd7788, v1: 7fc68d9675)
  Normal  UpdatedDestinationRule  22m (x18 over 49m)   rollouts-controller  DestinationRule reviews subset updated (v2: 5f7dbd7788, v1: 5f7dbd7788)
  Normal  TrafficWeightUpdated    7m47s (x6 over 49m)  rollouts-controller  Traffic weight updated
  Normal  RolloutUpdated          7m47s                rollouts-controller  Rollout updated to revision 4
  Normal  UpdatedDestinationRule  77s (x48 over 48m)   rollouts-controller  DestinationRule reviews subset updated (v2: 7fc68d9675, v1: 5f7dbd7788)
```



清理：

kubectl delete vs reviews-vs -n istio

kubectl delete dr reviews -n istio

kubectl delete rollout reviews-v1 -n istio

kubectl delete AnalysisTemplate success-rate -n istio





###### inconclusiveLimit

不确定结论限值

release/canary/argo/argo-AnalysisTemplate-inconclusiveLimit.yaml

kubectl apply -f argo-AnalysisTemplate-inconclusiveLimit.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: success-rate
spec:
  args:
  - name: service-name
  metrics:
  - name: success-rate
    interval: 60s
    count: 5
    successCondition: result[0] <= 0.60 and result[0] > 0.50
    failureCondition: result[0] <= 0.50
    failureLimit: 3
    inconclusiveLimit: 2    
    provider:
      prometheus:
        address: http://prometheus.istio-system:9090
        query: |
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}",response_code!~"5.*"}[5m]
          )) / 
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}"}[5m]
          ))
```

release/canary/argo/rollout-canary-reviewsAnalysisTemplate.yaml

kubectl apply -f rollout-canary-reviewsAnalysisTemplate.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      canaryMetadata:
        labels:
          canary: canary
      stableMetadata:
        labels:
          stable: stable
      trafficRouting:
        istio:
          virtualService:
            name: reviews-vs
            routes:
            - http-primary
          destinationRule:
            name: reviews
            canarySubsetName: v2
            stableSubsetName: v1
      steps:
      - setWeight: 20
      - pause: {}
      - analysis:
          templates:
          - templateName: success-rate
            clusterScope: false
          args:
          - name: service-name
            value: reviews.istio.svc.cluster.local
      - setWeight: 40
      - pause: {duration: 10}
      - setWeight: 60
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
      
```

release/canary/argo/argo-vs-reviews-subset.yaml

kubectl apply -f argo-vs-reviews-subset.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-vs
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - "*"
  http:
  - name: http-primary
    route:
    - destination:
        host: reviews
        subset: v1
      weight: 100
    - destination:
        host: reviews
        subset: v2
      weight: 0
```

release/canary/argo/dr-reviews.yaml

kubectl apply -f dr-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews.istio.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
  subsets:
  - name: v1
    labels:
      stable: stable
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
  - name: v2
    labels:
      canary: canary
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN
```



```
 kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio
kubectl argo rollouts get rollout reviews-v1 --watch -n istio

Name:            reviews-v1
Namespace:       istio
Status:          ॥ Paused
Message:         InconclusiveAnalysisRun
Strategy:        Canary
  Step:          2/9
  SetWeight:     20
  ActualWeight:  20
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 (canary)
                 docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (stable)
Replicas:
  Desired:       1
  Current:       2
  Updated:       1
  Ready:         2
  Available:     2

NAME                                                            KIND         STATUS          AGE    INFO
⟳ reviews-v1                                                    Rollout      ॥ Paused        42m    
├──# revision:7                                                                                     
│  ├──⧉ reviews-v1-7f9bff4bbb                                   ReplicaSet   ✔ Healthy       42m    canary
│  │  └──□ reviews-v1-7f9bff4bbb-cpdxf                          Pod          ✔ Running       2m54s  ready:2/2
│  └──α reviews-v1-7f9bff4bbb-7-2                               AnalysisRun  ? Inconclusive  2m20s  ? 3
├──# revision:6                                                                                     
│  └──⧉ reviews-v1-6b87995785                                   ReplicaSet   ✔ Healthy       42m    stable
│     └──□ reviews-v1-6b87995785-hghjp                          Pod          ✔ Running       42m    ready:2/2
├──# revision:5                                                                                     
│  └──α reviews-v1-7f9bff4bbb-5-2                               AnalysisRun  ✖ Failed        9m20s  ✖ 4
├──# revision:3                                                                                     
│  └──α reviews-v1-7f9bff4bbb-3-2                               AnalysisRun  ✖ Failed        21m    ✖ 4
│     └──⊞ 9126fd9c-bb2b-49b7-a0e1-064b9a706834.success-rate.4  Job          ✖ Failed        18m    
└──# revision:2                                                                                     
   └──α reviews-v1-6b87995785-2-2                               AnalysisRun  ✔ Successful    41m    ✔ 5
      └──⊞ aa9ca4a9-7557-4d4e-bf4a-71a7b5b3d1bf.success-rate.5  Job          ✔ Successful    37m  
      
      kubectl argo rollouts promote  reviews-v1 -n istio
```

kubectl delete vs reviews-vs -n istio

kubectl delete dr reviews -n istio

kubectl delete rollout reviews-v1 -n istio

kubectl delete AnalysisTemplate success-rate -n istio



###### initialDelay

开始延迟

release/canary/argo/argo-AnalysisTemplate-job-initialDelay.yaml

kubectl apply -f argo-AnalysisTemplate-job-initialDelay.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: success-rate
spec:
  args:
  - name: service-name
  metrics:
  - name: success-rate
    interval: 60s
    count: 5
    successCondition: result[0] >= 0.5
    failureLimit: 3
    initialDelay: 30s
    provider:
      job:
        spec:
          backoffLimit: 1
          template:
            metadata:
              annotations:
                sidecar.istio.io/inject: “true”
            spec:
              containers:
              - name: test
                image: busybox
                command: [wget]
                args: ["http://192.168.229.134:30684/reviews/0"]
              restartPolicy: Never
```

release/canary/argo/rollout-canary-reviewsAnalysisTemplate.yaml

kubectl apply -f rollout-canary-reviewsAnalysisTemplate.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      canaryMetadata:
        labels:
          canary: canary
      stableMetadata:
        labels:
          stable: stable
      trafficRouting:
        istio:
          virtualService:
            name: reviews-vs
            routes:
            - http-primary
          destinationRule:
            name: reviews
            canarySubsetName: v2
            stableSubsetName: v1
      steps:
      - setWeight: 20
      - pause: {}
      - analysis:
          templates:
          - templateName: success-rate
            clusterScope: false
          args:
          - name: service-name
            value: reviews-.istio.svc.cluster.local
      - setWeight: 40
      - pause: {duration: 10}
      - setWeight: 60
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
      
```

release/canary/argo/argo-vs-reviews-subset.yaml

kubectl apply -f argo-vs-reviews-subset.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-vs
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - "*"
  http:
  - name: http-primary
    route:
    - destination:
        host: reviews
        subset: v1
      weight: 100
    - destination:
        host: reviews
        subset: v2
      weight: 0
```

release/canary/argo/dr-reviews.yaml

kubectl apply -f dr-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews.istio.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
  subsets:
  - name: v1
    labels:
      stable: stable
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
  - name: v2
    labels:
      canary: canary
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN
```



```
 kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio
kubectl argo rollouts get rollout reviews-v1 --watch -n istio

Namespace:       istio
Status:          ◌ Progressing
Message:         waiting for all steps to complete
Strategy:        Canary
  Step:          2/9
  SetWeight:     20
  ActualWeight:  20
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 (canary)
                 docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (stable)
Replicas:
  Desired:       1
  Current:       2
  Updated:       1
  Ready:         2
  Available:     2

NAME                                                            KIND         STATUS          AGE    INFO
⟳ reviews-v1                                                    Rollout      ◌ Progressing   52m    
├──# revision:11                                                                                    
│  ├──⧉ reviews-v1-7f9bff4bbb                                   ReplicaSet   ✔ Healthy       52m    canary
│  │  └──□ reviews-v1-7f9bff4bbb-8ch84                          Pod          ✔ Running       48s    ready:2/2
│  └──α reviews-v1-7f9bff4bbb-11-2                              AnalysisRun  ◌ Running       33s    ✔ 1
│     └──⊞ a9c42d8b-1deb-45c0-a621-675502216d6d.success-rate.1  Job          ✔ Successful    3s     
├──# revision:10                                                                                    
│  └──⧉ reviews-v1-6b87995785                                   ReplicaSet   ✔ Healthy       52m    stable
│     └──□ reviews-v1-6b87995785-hghjp                          Pod          ✔ Running       52m    ready:2/2
├──# revision:7                                                                                     
│  ├──α reviews-v1-7f9bff4bbb-7-2                               AnalysisRun  ? Inconclusive  12m    ? 3
│  └──α reviews-v1-7f9bff4bbb-7-2.1                             AnalysisRun  ? Inconclusive  8m43s  ? 3
├──# revision:5                                                                                     
│  └──α reviews-v1-7f9bff4bbb-5-2                               AnalysisRun  ✖ Failed        19m    ✖ 4
├──# revision:3                                                                                     
│  └──α reviews-v1-7f9bff4bbb-3-2                               AnalysisRun  ✖ Failed        31m    ✖ 4
│     └──⊞ 9126fd9c-bb2b-49b7-a0e1-064b9a706834.success-rate.4  Job          ✖ Failed        27m    
└──# revision:2                                                                                     
   └──α reviews-v1-6b87995785-2-2                               AnalysisRun  ✔ Successful    51m    ✔ 5
      └──⊞ aa9ca4a9-7557-4d4e-bf4a-71a7b5b3d1bf.success-rate.5  Job          ✔ Successful    47m    

   
   

kubectl argo rollouts promote  reviews-v1 -n istio

```



清理：

kubectl delete vs reviews-vs -n istio

kubectl delete dr reviews -n istio

kubectl delete rollout reviews-v1 -n istio

kubectl delete AnalysisTemplate success-rate -n istio



###### failureCondition，successCondition

失败成功条件,略



##### notifications

安装

kubectl apply -f notifications-install.yaml -n argo-rollouts 



模板：

argo-rollouts-notification-configmap.yaml

kubectl apply -f argo-rollouts-notification-configmap.yaml -n argo-rollouts

```
apiVersion: v1
data:
  template.analysis-run-error: |
    message: Rollout {{.rollout.metadata.name}}'s analysis run is in error state.
    email:
      subject: Rollout {{.rollout.metadata.name}}'s analysis run is in error state.
    slack:
      attachments: |
          [{
            "title": "{{ .rollout.metadata.name}}",
            "color": "#ECB22E",
            "fields": [
            {
              "title": "Strategy",
              "value": "{{if .rollout.spec.strategy.blueGreen}}BlueGreen{{end}}{{if .rollout.spec.strategy.canary}}Canary{{end}}",
              "short": true
            }
            {{range $index, $c := .rollout.spec.template.spec.containers}}
              {{if not $index}},{{end}}
              {{if $index}},{{end}}
              {
                "title": "{{$c.name}}",
                "value": "{{$c.image}}",
                "short": true
              }
            {{end}}
            ]
          }]
  template.analysis-run-failed: |
    message: Rollout {{.rollout.metadata.name}}'s analysis run failed.
    email:
      subject: Rollout {{.rollout.metadata.name}}'s analysis run failed.
    slack:
      attachments: |
          [{
            "title": "{{ .rollout.metadata.name}}",
            "color": "#E01E5A",
            "fields": [
            {
              "title": "Strategy",
              "value": "{{if .rollout.spec.strategy.blueGreen}}BlueGreen{{end}}{{if .rollout.spec.strategy.canary}}Canary{{end}}",
              "short": true
            }
            {{range $index, $c := .rollout.spec.template.spec.containers}}
              {{if not $index}},{{end}}
              {{if $index}},{{end}}
              {
                "title": "{{$c.name}}",
                "value": "{{$c.image}}",
                "short": true
              }
            {{end}}
            ]
          }]
  template.analysis-run-running: |
    message: Rollout {{.rollout.metadata.name}}'s analysis run is running.
    email:
      subject: Rollout {{.rollout.metadata.name}}'s analysis run is running.
    slack:
      attachments: |
          [{
            "title": "{{ .rollout.metadata.name}}",
            "color": "#18be52",
            "fields": [
            {
              "title": "Strategy",
              "value": "{{if .rollout.spec.strategy.blueGreen}}BlueGreen{{end}}{{if .rollout.spec.strategy.canary}}Canary{{end}}",
              "short": true
            }
            {{range $index, $c := .rollout.spec.template.spec.containers}}
              {{if not $index}},{{end}}
              {{if $index}},{{end}}
              {
                "title": "{{$c.name}}",
                "value": "{{$c.image}}",
                "short": true
              }
            {{end}}
            ]
          }]
  template.rollout-aborted: |
    message: Rollout {{.rollout.metadata.name}} has been aborted.
    email:
      subject: Rollout {{.rollout.metadata.name}} has been aborted.
    slack:
      attachments: |
          [{
            "title": "{{ .rollout.metadata.name}}",
            "color": "#E01E5A",
            "fields": [
            {
              "title": "Strategy",
              "value": "{{if .rollout.spec.strategy.blueGreen}}BlueGreen{{end}}{{if .rollout.spec.strategy.canary}}Canary{{end}}",
              "short": true
            }
            {{range $index, $c := .rollout.spec.template.spec.containers}}
              {{if not $index}},{{end}}
              {{if $index}},{{end}}
              {
                "title": "{{$c.name}}",
                "value": "{{$c.image}}",
                "short": true
              }
            {{end}}
            ]
          }]
  template.rollout-completed: |
    message: Rollout {{.rollout.metadata.name}} has been completed.
    email:
      subject: Rollout {{.rollout.metadata.name}} has been completed.
    slack:
      attachments: |
          [{
            "title": "{{ .rollout.metadata.name}}",
            "color": "#18be52",
            "fields": [
            {
              "title": "Strategy",
              "value": "{{if .rollout.spec.strategy.blueGreen}}BlueGreen{{end}}{{if .rollout.spec.strategy.canary}}Canary{{end}}",
              "short": true
            }
            {{range $index, $c := .rollout.spec.template.spec.containers}}
              {{if not $index}},{{end}}
              {{if $index}},{{end}}
              {
                "title": "{{$c.name}}",
                "value": "{{$c.image}}",
                "short": true
              }
            {{end}}
            ]
          }]
  template.rollout-paused: |
    message: Rollout {{.rollout.metadata.name}} has been paused.
    email:
      subject: Rollout {{.rollout.metadata.name}} has been paused.
    slack:
      attachments: |
          [{
            "title": "{{ .rollout.metadata.name}}",
            "color": "#18be52",
            "fields": [
            {
              "title": "Strategy",
              "value": "{{if .rollout.spec.strategy.blueGreen}}BlueGreen{{end}}{{if .rollout.spec.strategy.canary}}Canary{{end}}",
              "short": true
            }
            {{range $index, $c := .rollout.spec.template.spec.containers}}
              {{if not $index}},{{end}}
              {{if $index}},{{end}}
              {
                "title": "{{$c.name}}",
                "value": "{{$c.image}}",
                "short": true
              }
            {{end}}
            ]
          }]
  template.rollout-step-completed: |
    message: Rollout {{.rollout.metadata.name}} step number {{ add .rollout.status.currentStepIndex 1}}/{{len .rollout.spec.strategy.canary.steps}} has been completed.
    email:
      subject: Rollout {{.rollout.metadata.name}} step number {{ add .rollout.status.currentStepIndex 1}}/{{len .rollout.spec.strategy.canary.steps}} has been completed.
    slack:
      attachments: |
          [{
            "title": "{{ .rollout.metadata.name}}",
            "color": "#18be52",
            "fields": [
            {
              "title": "Strategy",
              "value": "{{if .rollout.spec.strategy.blueGreen}}BlueGreen{{end}}{{if .rollout.spec.strategy.canary}}Canary{{end}}",
              "short": true
            },
            {
              "title": "Step completed",
              "value": "{{add .rollout.status.currentStepIndex 1}}/{{len .rollout.spec.strategy.canary.steps}}",
              "short": true
            }
            {{range $index, $c := .rollout.spec.template.spec.containers}}
              {{if not $index}},{{end}}
              {{if $index}},{{end}}
              {
                "title": "{{$c.name}}",
                "value": "{{$c.image}}",
                "short": true
              }
            {{end}}
            ]
          }]
  template.rollout-updated: |
    message: Rollout {{.rollout.metadata.name}} has been updated.
    email:
      subject: Rollout {{.rollout.metadata.name}} has been updated.
    slack:
      attachments: |
          [{
            "title": "{{ .rollout.metadata.name}}",
            "color": "#18be52",
            "fields": [
            {
              "title": "Strategy",
              "value": "{{if .rollout.spec.strategy.blueGreen}}BlueGreen{{end}}{{if .rollout.spec.strategy.canary}}Canary{{end}}",
              "short": true
            }
            {{range $index, $c := .rollout.spec.template.spec.containers}}
              {{if not $index}},{{end}}
              {{if $index}},{{end}}
              {
                "title": "{{$c.name}}",
                "value": "{{$c.image}}",
                "short": true
              }
            {{end}}
            ]
          }]
  template.scaling-replicaset: |
    message: Scaling Rollout {{.rollout.metadata.name}}'s replicaset to {{.rollout.spec.replicas}}.
    email:
      subject: Scaling Rollout {{.rollout.metadata.name}}'s replcaset to {{.rollout.spec.replicas}}.
    slack:
      attachments: |
          [{
            "title": "{{ .rollout.metadata.name}}",
            "color": "#18be52",
            "fields": [
            {
              "title": "Strategy",
              "value": "{{if .rollout.spec.strategy.blueGreen}}BlueGreen{{end}}{{if .rollout.spec.strategy.canary}}Canary{{end}}",
              "short": true
            },
            {
              "title": "Desired replica",
              "value": "{{.rollout.spec.replicas}}",
              "short": true
            },
            {
              "title": "Updated replicas",
              "value": "{{.rollout.status.updatedReplicas}}",
              "short": true
            }
            {{range $index, $c := .rollout.spec.template.spec.containers}}
              {{if not $index}},{{end}}
              {{if $index}},{{end}}
              {
                "title": "{{$c.name}}",
                "value": "{{$c.image}}",
                "short": true
              }
            {{end}}
            ]
          }]
  trigger.on-analysis-run-error: |
    - send: [analysis-run-error]
  trigger.on-analysis-run-failed: |
    - send: [analysis-run-failed]
  trigger.on-analysis-run-running: |
    - send: [analysis-run-running]
  trigger.on-rollout-aborted: |
    - send: [rollout-aborted]
  trigger.on-rollout-completed: |
    - send: [rollout-completed,github-commit-status]
  trigger.on-rollout-paused: |
    - send: [rollout-paused]
  trigger.on-rollout-step-completed: |
    - send: [rollout-step-completed]
  trigger.on-rollout-updated: |
    - send: [rollout-updated]
  trigger.on-scaling-replica-set: |
    - send: [scaling-replicaset]
  service.email.163: |
    username: $email-username
    password: $email-password
    host: smtp.163.com
    port: 25
    from: $from-email-username
  service.webhook.test: |
    url: https://<hostname>/<optional-path>
    headers: 
    - name: <header-name>
      value: <header-value>
    basicAuth:
      username: <username>
      password: <api-key>
  service.slack: |
    apiURL: <url>               
    token: $slack-token
    username: <override-username> 
    icon:
  template.github-commit-status: |
    webhook:
      <webhook-name>:
        method: POST 
        path: <optional-path-template>
        body: |
          <optional-body-template>
          
kind: ConfigMap
metadata:
  name: argo-rollouts-notification-configmap
```



Currently the following triggers have [built-in templates](https://github.com/argoproj/argo-rollouts/tree/master/manifests/notifications).

- `on-rollout-completed` when a rollout is finished and all its steps are completed
- `on-rollout-step-completed` when an individual step inside a rollout definition is completed
- `on-rollout-updated` when a rollout definition is changed
- `on-scaling-replica-set` when the number of replicas in a rollout is changed



release/canary/argo/argo-rollouts-notifications-secret.yaml

kubectl apply -f argo-rollouts-notifications-secret.yaml -n argo-rollouts

```
apiVersion: v1
kind: Secret
metadata:
  name: argo-rollouts-notification-secret
stringData:
  slack-token: xoxb-2481573454896-2504639062320-N8MXtmRUrsSDZaQFoDTI6Bax
  email-username: mark195446040@163.com
  email-password: VGRHMPDKPBPWHBTU
  from-email-username: mark195446040@163.com
```



slack

Annotation key consists of following parts:

- `on-rollout-step-completed` - trigger name
- `slack` - notification service name
- test，`my-channel1;my-channel2` - a semicolon separated list of recipients



release/canary/argo/rollout-canary-notifications.yaml

kubectl apply -f rollout-canary-notifications.yaml -n ist

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
  annotations:
    notifications.argoproj.io/subscribe.on-rollout-step-completed.slack: test
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      canaryMetadata:
        labels:
          canary: canary
      stableMetadata:
        labels:
          stable: stable
      trafficRouting:
        istio:
          virtualService:
            name: reviews-vs
            routes:
            - http-primary
          destinationRule:
            name: reviews
            canarySubsetName: v2
            stableSubsetName: v1
      steps:
      - setWeight: 20
      - setWeight: 40
      - pause: {duration: 10}
      - setWeight: 60
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
      
```

release/canary/argo/argo-vs-reviews-subset.yaml

kubectl apply -f argo-vs-reviews-subset.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-vs
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - "*"
  http:
  - name: http-primary
    route:
    - destination:
        host: reviews
        subset: v1
      weight: 100
    - destination:
        host: reviews
        subset: v2
      weight: 0
```

release/canary/argo/dr-reviews.yaml

kubectl apply -f dr-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews.istio.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
  subsets:
  - name: v1
    labels:
      stable: stable
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
  - name: v2
    labels:
      canary: canary
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN
```



```
 kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio
kubectl argo rollouts get rollout reviews-v1 --watch -n istio

  

   
   

kubectl argo rollouts promote  reviews-v1 -n istio

```



清理：

kubectl delete vs reviews-vs -n istio

kubectl delete dr reviews -n istio

kubectl delete rollout reviews-v1 -n istio

kubectl delete AnalysisTemplate success-rate -n istio



email

The Email notification service sends email notifications using SMTP protocol and requires specifying the following settings:

- `host` - the SMTP server host name
- `port` - the SMTP server port
- `username` - username
- `password` - password
- `from` - from email address
- `html` - optional bool, true or false
- `insecure_skip_verify` - optional bool, true or false



release/canary/argo/rollout-canary-notifications-email.yaml

kubectl apply -f rollout-canary-notifications-email.yaml -n ist

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
  annotations:
    notifications.argoproj.io/subscribe.on-rollout-step-completed.163: mark195446040@163.com
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      canaryMetadata:
        labels:
          canary: canary
      stableMetadata:
        labels:
          stable: stable
      trafficRouting:
        istio:
          virtualService:
            name: reviews-vs
            routes:
            - http-primary
          destinationRule:
            name: reviews
            canarySubsetName: v2
            stableSubsetName: v1
      steps:
      - setWeight: 20
      - setWeight: 40
      - pause: {duration: 10}
      - setWeight: 60
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
      
```

release/canary/argo/argo-vs-reviews-subset.yaml

kubectl apply -f argo-vs-reviews-subset.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-vs
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - "*"
  http:
  - name: http-primary
    route:
    - destination:
        host: reviews
        subset: v1
      weight: 100
    - destination:
        host: reviews
        subset: v2
      weight: 0
```

release/canary/argo/dr-reviews.yaml

kubectl apply -f dr-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews.istio.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
  subsets:
  - name: v1
    labels:
      stable: stable
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
  - name: v2
    labels:
      canary: canary
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN
```



```
 kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio
kubectl argo rollouts get rollout reviews-v1 --watch -n istio

  
Name:            reviews-v1
Namespace:       istio
Status:          ✔ Healthy
Strategy:        Canary
  Step:          7/7
  SetWeight:     100
  ActualWeight:  100
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 (stable)
Replicas:
  Desired:       1
  Current:       1
  Updated:       1
  Ready:         1
  Available:     1

NAME                                  KIND        STATUS        AGE    INFO
⟳ reviews-v1                          Rollout     ✔ Healthy     27m    
├──# revision:3                                                        
│  └──⧉ reviews-v1-c68bcbf9           ReplicaSet  ✔ Healthy     27m    stable
│     └──□ reviews-v1-c68bcbf9-bdb8s  Pod         ✔ Running     4m20s  ready:2/2
└──# revision:2                                                        
   └──⧉ reviews-v1-6777b77548         ReplicaSet  • ScaledDown  27m 
   
   

kubectl argo rollouts promote  reviews-v1 -n istio

  Type    Reason                  Age                     From                 Message
  ----    ------                  ----                    ----                 -------
  Normal  RolloutUpdated          28m                     rollouts-controller  Rollout updated to revision 1
  Normal  NewReplicaSetCreated    28m                     rollouts-controller  Created ReplicaSet reviews-v1-c68bcbf9 (revision 1)
  Normal  UpdatedDestinationRule  28m (x2 over 28m)       rollouts-controller  DestinationRule reviews subset updated (v2: c68bcbf9, v1: )
  Normal  TrafficWeightUpdated    28m (x2 over 28m)       rollouts-controller  Traffic weight updated to 0
  Normal  ScalingReplicaSet       28m                     rollouts-controller  Scaled up ReplicaSet reviews-v1-c68bcbf9 (revision 1) from 0 to 1
  Normal  RolloutCompleted        28m                     rollouts-controller  Rollout completed update to revision 1 (c68bcbf9): Initial deploy
  Normal  UpdatedDestinationRule  28m (x6 over 28m)       rollouts-controller  DestinationRule reviews subset updated (v2: c68bcbf9, v1: c68bcbf9)
  Normal  TrafficWeightUpdated    27m (x3 over 28m)       rollouts-controller  Traffic weight updated
  Normal  RolloutUpdated          27m                     rollouts-controller  Rollout updated to revision 2
  Normal  NewReplicaSetCreated    27m                     rollouts-controller  Created ReplicaSet reviews-v1-6777b77548 (revision 2)
  Normal  UpdatedDestinationRule  27m (x5 over 27m)       rollouts-controller  DestinationRule reviews subset updated (v2: 6777b77548, v1: c68bcbf9)
  Normal  ScalingReplicaSet       27m                     rollouts-controller  Scaled up ReplicaSet reviews-v1-6777b77548 (revision 2) from 0 to 1
  Normal  UpdatedDestinationRule  10m (x15 over 26m)      rollouts-controller  DestinationRule reviews subset updated (v2: 6777b77548, v1: 6777b77548)
  Normal  UpdatedDestinationRule  5m28s (x2 over 5m28s)   rollouts-controller  DestinationRule reviews subset updated (v2: 6777b77548, v1: 6777b77548)
  Normal  RolloutUpdated          4m46s                   rollouts-controller  Rollout updated to revision 3
  Normal  TrafficWeightUpdated    4m46s (x2 over 4m46s)   rollouts-controller  Traffic weight updated
  Normal  ScalingReplicaSet       4m46s                   rollouts-controller  Scaled up ReplicaSet reviews-v1-c68bcbf9 (revision 3) from 0 to 1
  Normal  Updated VirtualService  4m39s                   rollouts-controller  VirtualService `reviews-vs` set to desiredWeight '20'
  Normal  TrafficWeightUpdated    4m39s                   rollouts-controller  Traffic weight updated from 0 to 20
  Normal  RolloutStepCompleted    4m39s                   rollouts-controller  Rollout step 1/7 completed (setWeight: 20)
  Normal  Updated VirtualService  4m35s                   rollouts-controller  VirtualService `reviews-vs` set to desiredWeight '40'
  Normal  TrafficWeightUpdated    4m35s                   rollouts-controller  Traffic weight updated from 20 to 40
  Normal  RolloutStepCompleted    4m35s                   rollouts-controller  Rollout step 2/7 completed (setWeight: 40)
  Normal  RolloutPaused           4m33s                   rollouts-controller  Rollout is paused (CanaryPauseStep)
  Normal  UpdatedDestinationRule  4m23s (x12 over 4m46s)  rollouts-controller  DestinationRule reviews subset updated (v2: c68bcbf9, v1: 6777b77548)

```



清理：

kubectl delete vs reviews-vs -n istio

kubectl delete dr reviews -n istio

kubectl delete rollout reviews-v1 -n istio



webhook

release/canary/argo/rollout-canary-notifications-webhook.yaml

kubectl apply -f rollout-canary-notifications-webhook.yaml -n ist

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
  annotations:
    notifications.argoproj.io/subscribe.on-rollout-step-completed.test: test
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      canaryMetadata:
        labels:
          canary: canary
      stableMetadata:
        labels:
          stable: stable
      trafficRouting:
        istio:
          virtualService:
            name: reviews-vs
            routes:
            - http-primary
          destinationRule:
            name: reviews
            canarySubsetName: v2
            stableSubsetName: v1
      steps:
      - setWeight: 20
      - setWeight: 40
      - pause: {duration: 10}
      - setWeight: 60
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
      
```

release/canary/argo/argo-vs-reviews-subset.yaml

kubectl apply -f argo-vs-reviews-subset.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-vs
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - "*"
  http:
  - name: http-primary
    route:
    - destination:
        host: reviews
        subset: v1
      weight: 100
    - destination:
        host: reviews
        subset: v2
      weight: 0
```

release/canary/argo/dr-reviews.yaml

kubectl apply -f dr-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews.istio.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
  subsets:
  - name: v1
    labels:
      stable: stable
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
  - name: v2
    labels:
      canary: canary
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN
```



```
 kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio
kubectl argo rollouts get rollout reviews-v1 --watch -n istio

  

   
   

kubectl argo rollouts promote  reviews-v1 -n istio

```



清理：

kubectl delete vs reviews-vs -n istio

kubectl delete dr reviews -n istio

kubectl delete rollout reviews-v1 -n istio



##### experiments

What is the Experiment CRD

The Experiment CRD allows users to have ephemeral runs of one or more ReplicaSets. In addition to running ephemeral ReplicaSets, the Experiment CRD can launch AnalysisRuns alongside the ReplicaSets. Generally, those AnalysisRun is used to confirm that new ReplicaSets are running as expected.



An Experiment is intended to temporarily run one or more templates. The lifecycle of an Experiment is as follows:

1. Create and scale a ReplicaSet for each pod template specified under `spec.templates`
2. Wait for all ReplicaSets reach full availability. If a ReplicaSet does not become available within `spec.progressDeadlineSeconds`, the Experiment will fail. Once available, the Experiment will transition from the `Pending` state to a `Running` state.
3. Once an Experiment is considered `Running`, it will begin an AnalysisRun for every AnalysisTemplate referenced under `spec.analyses`.
4. If a duration is specified under `spec.duration`, the Experiment will wait until the duration has elapsed before completing the Experiment.
5. If an AnalysisRun fails or errors, the Experiment will end prematurely, with a status equal to the unsuccessful AnalysisRun (i.e. `Failed` or `Error`)
6. If one or more of the referenced AnalysisTemplates is marked with `requiredForCompletion: true`, the Experiment will not complete until those AnalysisRuns have completed, even if it exceeds the Experiment duration.
7. If neither a `spec.duration` or `requiredForCompletion: true` is specified, the Experiment will run indefinitely, until explicitly terminated (by setting `spec.terminate: true`).
8. Once an Experiment is complete, the ReplicaSets will be scaled to zero, and any incomplete AnalysisRuns will be terminated.





```
apiVersion: argoproj.io/v1alpha1
kind: Experiment
metadata:
  name: reviews-v1
spec:
  # Duration of the experiment, beginning from when all ReplicaSets became healthy (optional)
  # If omitted, will run indefinitely until terminated, or until all analyses which were marked
  # `requiredForCompletion` have completed.
  duration: 20m

  # Deadline in seconds in which a ReplicaSet should make progress towards becoming available.
  # If exceeded, the Experiment will fail.
  progressDeadlineSeconds: 30

  # List of pod template specs to run in the experiment as ReplicaSets
  templates:
  - name: purple
    # Number of replicas to run (optional). If omitted, will run a single replica
    replicas: 1
    selector:
      matchLabels:
        app: canary-demo
        color: purple
    template:
      metadata:
        labels:
          app: canary-demo
          color: purple
      spec:
        containers:
        - name: rollouts-demo
          image: argoproj/rollouts-demo:purple
          imagePullPolicy: Always
          ports:
          - name: http
            containerPort: 8080
            protocol: TCP
  - name: orange
    replicas: 1
    minReadySeconds: 10
    selector:
      matchLabels:
        app: canary-demo
        color: orange
    template:
      metadata:
        labels:
          app: canary-demo
          color: orange
      spec:
        containers:
        - name: rollouts-demo
          image: argoproj/rollouts-demo:orange
          imagePullPolicy: Always
          ports:
          - name: http
            containerPort: 8080
            protocol: TCP

  # List of AnalysisTemplate references to perform during the experiment
  analyses:
  - name: purple
    templateName: http-benchmark
    args:
    - name: host
      value: purple
  - name: orange
    templateName: http-benchmark
    args:
    - name: host
      value: orange
  - name: compare-results
    templateName: compare
    # If requiredForCompletion is true for an analysis reference, the Experiment will not complete
    # until this analysis has completed.
    requiredForCompletion: true
    args:
    - name: host
      value: purple
```



release/canary/argo/rollout-canary-reviews-Experiment.yaml

kubectl apply -f rollout-canary-reviews-Experiment.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
  template:
    metadata:
      labels:
        app: reviews
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      steps:
      - experiment:
          duration: 1m
          templates:
          - name: baseline
            specRef: stable
            replicas: 3
            metadata:
              annotations:
                stable: stable
              labels: 
                stable: stable 
          - name: canary
            specRef: canary
            replicas: 2
            metadata:
              annotations:
                canary: canary
              labels: 
                canary: canary 
          analyses:
          - name: test
            templateName: success-rate
            args:
            - name: service-name
              value: reviews.istio.svc.cluster.local
```

release/canary/argo/argo-vs-reviews-subset.yaml

kubectl apply -f argo-vs-reviews-subset.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-vs
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - "*"
  http:
  - name: http-primary
    route:
    - destination:
        host: reviews
        subset: v1
      weight: 100
    - destination:
        host: reviews
        subset: v2
      weight: 0
```



release/canary/argo/dr-reviews.yaml

kubectl apply -f dr-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews.istio.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
  subsets:
  - name: v1
    labels:
      stable: stable
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
  - name: v2
    labels:
      canary: canary
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN
```



release/canary/argo/argo-AnalysisTemplate-reviews.yaml

kubectl apply -f argo-AnalysisTemplate-reviews.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: success-rate
spec:
  args:
  - name: service-name
  metrics:
  - name: success-rate
    interval: 60s
    count: 5
    successCondition: result[0] >= 0.50
    failureLimit: 3
    provider:
      prometheus:
        address: http://prometheus.istio-system:9090
        query: |
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}",response_code!~"5.*"}[5m]
          )) / 
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}"}[5m]
          ))
```

```
 kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio
 
go-stress-testing -c 10 -n 1000000 -u http://192.168.229.134:30684/reviews/0


kubectl describe rollout reviews-v1  -n istio
kubectl argo rollouts get rollout reviews-v1 --watch -n istio

Strategy:        Canary
  Step:          0/1
  SetWeight:     0
  ActualWeight:  0
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 (stable, Σ:baseline)
                 docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (Σ:canary)
Replicas:
  Desired:       1
  Current:       1
  Updated:       0
  Ready:         1
  Available:     1

NAME                                                    KIND         STATUS         AGE    INFO
⟳ reviews-v1                                            Rollout      ◌ Progressing  38m    
├──# revision:5                                                                            
│  ├──⧉ reviews-v1-7476b89c5d                           ReplicaSet   • ScaledDown   34s    canary
│  └──Σ reviews-v1-7476b89c5d-5-0                       Experiment   ◌ Running      34s    
│     ├──⧉ reviews-v1-7476b89c5d-5-0-baseline           ReplicaSet   ✔ Healthy      34s    
│     │  ├──□ reviews-v1-7476b89c5d-5-0-baseline-b8hww  Pod          ✔ Running      34s    ready:2/2
│     │  ├──□ reviews-v1-7476b89c5d-5-0-baseline-vhdvk  Pod          ✔ Running      34s    ready:2/2
│     │  └──□ reviews-v1-7476b89c5d-5-0-baseline-zmpdg  Pod          ✔ Running      34s    ready:2/2
│     ├──⧉ reviews-v1-7476b89c5d-5-0-canary             ReplicaSet   ✔ Healthy      34s    
│     │  ├──□ reviews-v1-7476b89c5d-5-0-canary-9fq2l    Pod          ✔ Running      34s    ready:2/2
│     │  └──□ reviews-v1-7476b89c5d-5-0-canary-zbnjd    Pod          ✔ Running      34s    ready:2/2
│     └──α reviews-v1-7476b89c5d-5-0-test               AnalysisRun  ◌ Running      22s    ✔ 1
├──# revision:4                                                                            
│  ├──⧉ reviews-v1-84b4c5ccd9                           ReplicaSet   ✔ Healthy      3m34s  stable
│  │  └──□ reviews-v1-84b4c5ccd9-2j5cs                  Pod          ✔ Running      2m23s  ready:2/2
│  └──Σ reviews-v1-84b4c5ccd9-4-0                       Experiment   ✔ Successful   3m34s  
│     ├──⧉ reviews-v1-84b4c5ccd9-4-0-baseline           ReplicaSet   • ScaledDown   3m34s  
│     ├──⧉ reviews-v1-84b4c5ccd9-4-0-canary             ReplicaSet   • ScaledDown   3m34s  
│     └──α reviews-v1-84b4c5ccd9-4-0-test               AnalysisRun  ✔ Successful   3m25s  ✖ 1
├──# revision:3                                                                            
│  └──⧉ reviews-v1-6d5599f745                           ReplicaSet   • ScaledDown   38m    
└──# revision:2                                                                            
   └──⧉ reviews-v1-77d9dfbb54                           ReplicaSet   • ScaledDown   38m    
```

kubectl delete vs reviews-vs -n istio

kubectl delete dr reviews -n istio

kubectl delete rollout reviews-v1 -n istio

kubectl delete AnalysisTemplate success-rate -n istio





standalone

release/canary/argo/rollout-canary-reviews-Experiment-standalone.yaml

kubectl apply -f rollout-canary-reviews-Experiment-standalone.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Experiment
metadata:
  name: reviews-v1
spec:
  duration: 1m
  progressDeadlineSeconds: 30
  templates:
  - name: old
    replicas: 1
    selector:
      matchLabels:
        app: reviews
        color: purple
    template:
      metadata:
        labels:
          app: reviews
          color: purple
          stable: stable
      spec:
        serviceAccountName: bookinfo-reviews
        containers:
        - name: reviews
          image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
          imagePullPolicy: IfNotPresent
          env:
          - name: LOG_DIR
            value: "/tmp/logs"
          ports:
          - containerPort: 9080
          resources:
            requests:
              cpu: 0.02
              memory: 10Mi
          volumeMounts:
          - name: tmp
            mountPath: /tmp
          - name: wlp-output
            mountPath: /opt/ibm/wlp/output
          securityContext:
            runAsUser: 1000
        volumes:
        - name: wlp-output
          emptyDir: {}
        - name: tmp
          emptyDir: {}
  - name: orange
    replicas: 1
    minReadySeconds: 10
    selector:
      matchLabels:
        app: reviews
        color: orange
    template:
      metadata:
        labels:
          app: reviews
          color: orange
          canary: canary
      spec:
        serviceAccountName: bookinfo-reviews
        containers:
        - name: reviews
          image: docker.io/istio/examples-bookinfo-reviews-v2:1.16.2
          imagePullPolicy: IfNotPresent
          env:
          - name: LOG_DIR
            value: "/tmp/logs"
          ports:
          - containerPort: 9080
          resources:
            requests:
              cpu: 0.02
              memory: 10Mi
          volumeMounts:
          - name: tmp
            mountPath: /tmp
          - name: wlp-output
            mountPath: /opt/ibm/wlp/output
          securityContext:
            runAsUser: 1000
        volumes:
        - name: wlp-output
          emptyDir: {}
        - name: tmp
          emptyDir: {}
  analyses:
  - name: compare
    requiredForCompletion: true
    templateName: success-rate
    args:
    - name: service-name
      value: reviews.istio.svc.cluster.local  
```

release/canary/argo/argo-AnalysisTemplate-reviews.yaml

kubectl apply -f argo-AnalysisTemplate-reviews.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: success-rate
spec:
  args:
  - name: service-name
  metrics:
  - name: success-rate
    interval: 60s
    count: 5
    successCondition: result[0] >= 0.50
    failureLimit: 3
    provider:
      prometheus:
        address: http://prometheus.istio-system:9090
        query: |
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}",response_code!~"5.*"}[5m]
          )) / 
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}"}[5m]
          ))
```



release/canary/argo/argo-vs-reviews-subset.yaml

kubectl apply -f argo-vs-reviews-subset.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-vs
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - "*"
  http:
  - name: http-primary
    route:
    - destination:
        host: reviews
        subset: v1
      weight: 100
    - destination:
        host: reviews
        subset: v2
      weight: 0
```



release/canary/argo/dr-reviews-experiment.yaml

kubectl apply -f dr-reviews-experiment.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews.istio.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
  subsets:
  - name: v1
    labels:
      app: reviews
      color: purple
      stable: stable
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
  - name: v2
    labels:
      app: reviews
      color: orange
      canary: canary
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN
```

kubectl delete vs reviews-vs -n istio

kubectl delete dr reviews -n istio

kubectl delete Experiment reviews-v1 -n istio

kubectl delete AnalysisTemplate success-rate -n istio





#####  ClusterAnalysisTemplate 

release/canary/argo/argo-ClusterAnalysisTemplate -reviews.yaml

kubectl apply -f argo-ClusterAnalysisTemplate-reviews.yaml -n default

```
apiVersion: argoproj.io/v1alpha1
kind: ClusterAnalysisTemplate
metadata:
  name: success-rate
spec:
  args:
  - name: service-name
  metrics:
  - name: success-rate
    interval: 60s
    count: 5
    successCondition: result[0] >= 0.50
    failureLimit: 3
    provider:
      prometheus:
        address: http://prometheus.istio-system:9090
        query: |
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}",response_code!~"5.*"}[5m]
          )) / 
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}"}[5m]
          ))
```

release/canary/argo/rollout-canary-reviews-ClusterAnalysisTemplate.yaml

kubectl apply -f rollout-canary-reviews-ClusterAnalysisTemplate.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      canaryMetadata:
        labels:
          canary: canary
      stableMetadata:
        labels:
          stable: stable
      trafficRouting:
        istio:
          virtualService:
            name: reviews-vs
            routes:
            - http-primary
          destinationRule:
            name: reviews
            canarySubsetName: v2
            stableSubsetName: v1
      steps:
      - setWeight: 20
      - pause: {}
      - analysis:
          templates:
          - templateName: success-rate
            clusterScope: true
          args:
          - name: service-name
            value: reviews.istio.svc.cluster.local
      - setWeight: 40
      - pause: {duration: 10}
      - setWeight: 60
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
      
```

release/canary/argo/argo-vs-reviews-subset.yaml

kubectl apply -f argo-vs-reviews-subset.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-vs
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - "*"
  http:
  - name: http-primary
    route:
    - destination:
        host: reviews
        subset: v1
      weight: 100
    - destination:
        host: reviews
        subset: v2
      weight: 0
```

release/canary/argo/dr-reviews.yaml

kubectl apply -f dr-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews.istio.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
  subsets:
  - name: v1
    labels:
      stable: stable
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
  - name: v2
    labels:
      canary: canary
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN
```





```
go-stress-testing -c 10 -n 1000000 -u http://192.168.229.134:30684/reviews/0

kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio
kubectl argo rollouts get rollout reviews-v1 --watch -n istio


kubectl argo rollouts promote  reviews-v1 -n istio


Name:            reviews-v1
Namespace:       istio
Status:          ◌ Progressing
Message:         waiting for all steps to complete
Strategy:        Canary
  Step:          2/9
  SetWeight:     20
  ActualWeight:  20
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 (stable)
                 docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (canary)
Replicas:
  Desired:       1
  Current:       2
  Updated:       1
  Ready:         2
  Available:     2

NAME                                    KIND         STATUS         AGE    INFO
⟳ reviews-v1                            Rollout      ◌ Progressing  3m22s  
├──# revision:2                                                            
│  ├──⧉ reviews-v1-85fd5ff994           ReplicaSet   ✔ Healthy      49s    canary
│  │  └──□ reviews-v1-85fd5ff994-frqgz  Pod          ✔ Running      49s    ready:2/2
│  └──α reviews-v1-85fd5ff994-2-2       AnalysisRun  ◌ Running      12s    ✔ 1
└──# revision:1                                                            
   └──⧉ reviews-v1-685f6cbb9            ReplicaSet   ✔ Healthy      67s    stable
      └──□ reviews-v1-685f6cbb9-5vcs4   Pod          ✔ Running      66s    ready:2/2
```



清理：

kubectl delete vs reviews-vs -n istio

kubectl delete dr reviews -n istio

kubectl delete rollout reviews-v1 -n istio

kubectl delete  ClusterAnalysisTemplate success-rate -n istio



##### HPA 

release/canary/argo/rollout-canary-istio-HPA.yaml

kubectl apply -f rollout-canary-istio-HPA.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      argo: argo
  template:
    metadata:
      labels:
        app: reviews
        argo: argo
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    canary:
      canaryMetadata:
        labels:
          canary: canary
      stableMetadata:
        labels:
          stable: stable
      trafficRouting:
        istio:
          virtualService:
            name: reviews-vs
            routes:
            - http-primary
          destinationRule:
            name: reviews
            canarySubsetName: v2
            stableSubsetName: v1
      steps:
      - setWeight: 20
      - pause: {}
      - setWeight: 80
      - pause: {duration: 10}

```

release/canary/argo/istio-HPA.yaml

kubectl apply -f istio-HPA.yaml -n istio

```
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: hpa-rollout
spec:
  maxReplicas: 6
  minReplicas: 1
  scaleTargetRef:
    apiVersion: argoproj.io/v1alpha1
    kind: Rollout
    name: reviews-v1
  targetCPUUtilizationPercentage: 50
```

release/canary/argo/argo-vs-reviews-subset.yaml

kubectl apply -f argo-vs-reviews-subset.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-vs
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - "*"
  http:
  - name: http-primary
    route:
    - destination:
        host: reviews
        subset: v1
      weight: 100
    - destination:
        host: reviews
        subset: v2
      weight: 0
```

release/canary/argo/dr-reviews.yaml

kubectl apply -f dr-reviews.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews.istio.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
  subsets:
  - name: v1
    labels:
      stable: stable
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
  - name: v2
    labels:
      canary: canary
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN

```

kubectl delete vs reviews-vs -n istio

kubectl delete dr reviews -n istio

kubectl delete rollout reviews-v1 -n istio

kubectl delete  hpa hpa-rollout  -n istio



```
go-stress-testing -c 10 -n 1000000 -u http://192.168.229.134:30684/reviews/0

kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews-v1  -n istio
kubectl argo rollouts get rollout reviews-v1 --watch -n istio


Name:            reviews-v1
Namespace:       istio
Status:          ✔ Healthy
Strategy:        Canary
  Step:          4/4
  SetWeight:     100
  ActualWeight:  100
Images:          docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (stable)
Replicas:
  Desired:       5
  Current:       5
  Updated:       5
  Ready:         5
  Available:     5

NAME                                    KIND        STATUS        AGE   INFO
⟳ reviews-v1                            Rollout     ✔ Healthy     103m  
├──# revision:4                                                         
│  └──⧉ reviews-v1-77d9dfbb54           ReplicaSet  ✔ Healthy     103m  stable
│     ├──□ reviews-v1-77d9dfbb54-h9svk  Pod         ✔ Running     79s   ready:2/2
│     ├──□ reviews-v1-77d9dfbb54-4xnst  Pod         ✔ Running     45s   ready:2/2
│     ├──□ reviews-v1-77d9dfbb54-r4bl5  Pod         ✔ Running     45s   ready:2/2
│     ├──□ reviews-v1-77d9dfbb54-zdlxl  Pod         ✔ Running     45s   ready:2/2
│     └──□ reviews-v1-77d9dfbb54-sscsl  Pod         ✔ Running     26s   ready:2/2
└──# revision:3                                                         
   └──⧉ reviews-v1-6d5599f745           ReplicaSet  • ScaledDown  103m  

```



#### dashboard

kubectl apply -f dashboard-install.yaml -n argo-rollouts 

kubectl port-forward --address 0.0.0.0 -n argo-rollouts argo-rollouts-dashboard-64784f5cbf-9s928

![rollouts-list](images\rollouts-list.png)



![rollout-ui](images\rollout-ui.png)



#### 命令行

```
[root@node01 ~]# kubectl argo rollouts 
Usage:
  kubectl-argo-rollouts COMMAND [flags]
  kubectl-argo-rollouts [command]

Examples:
  # Get guestbook rollout and watch progress
  kubectl argo rollouts get rollout guestbook -w

  # Pause the guestbook rollout
  kubectl argo rollouts pause guestbook

  # Promote the guestbook rollout
  kubectl argo rollouts promote guestbook

  # Abort the guestbook rollout
  kubectl argo rollouts abort guestbook

  # Retry the guestbook rollout
  kubectl argo rollouts retry guestbook

Available Commands:
  abort       Abort a rollout
  create      Create a Rollout, Experiment, AnalysisTemplate, ClusterAnalysisTemplate, or AnalysisRun resource
  dashboard   Start UI dashboard
  get         Get details about rollouts and experiments
  help        Help about any command
  lint        Lint and validate a Rollout
  list        List rollouts or experiments
  pause       Pause a rollout
  promote     Promote a rollout
  restart     Restart the pods of a rollout
  retry       Retry a rollout or experiment
  set         Update various values on resources
  status      Show the status of a rollout
  terminate   Terminate an AnalysisRun or Experiment
  undo        Undo a rollout
  version     Print version

Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
  -h, --help                           help for kubectl-argo-rollouts
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use

Use "kubectl-argo-rollouts [command] --help" for more information about a command.
```

##### get

```
[root@node01 ~]# kubectl argo rollouts get --help
This command consists of multiple subcommands which can be used to get extended information about a rollout or experiment.

Usage:
  kubectl-argo-rollouts get <rollout|experiment> RESOURCE_NAME [flags]
  kubectl-argo-rollouts get [command]

Examples:
        # Get a rollout
        kubectl argo rollouts get rollout guestbook

        # Watch a rollouts progress
        kubectl argo rollouts get rollout guestbook -w
  
        # Get an experiment
        kubectl argo rollouts get experiment my-experiment

Available Commands:
  experiment  Get details about an Experiment
  rollout     Get details about a rollout

Flags:
  -h, --help   help for get

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use

Use "kubectl-argo-rollouts get [command] --help" for more information about a command.
```

###### experiment

```
[root@node01 ~]# kubectl argo rollouts get experiment
Usage:
  kubectl-argo-rollouts get experiment EXPERIMENT_NAME [flags]

Aliases:
  experiment, exp, experiments

Examples:
        # Get an experiment
        kubectl argo rollouts get experiment my-experiment

        # Watch experiment progress
        kubectl argo rollouts get experiment my-experiment -w

Flags:
  -h, --help       help for experiment
      --no-color   Do not colorize output
  -w, --watch      Watch live updates to the rollout

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use
```

kubectl argo rollouts get experiment reviews-v1 -n istio

kubectl argo rollouts get experiment reviews-v1 -n istio -w

###### rollout

```
[root@node01 ~]# kubectl argo rollouts get rollout --help
Get details about and visual representation of a rollout. It returns a bunch of metadata on a resource and a tree view of the child resources created by the parent.

Tree view icons

| Icon | Kind |
|:----:|:-----------:|
| ⟳ | Rollout |
| Σ | Experiment |
| α | AnalysisRun |
| # | Revision |
| ⧉ | ReplicaSet |
| □ | Pod |
| ⊞ | Job |

Usage:
  kubectl-argo-rollouts get rollout ROLLOUT_NAME [flags]

Aliases:
  rollout, ro, rollouts

Examples:
        # Get a rollout
        kubectl argo rollouts get rollout guestbook

        # Watch progress of a rollout
        kubectl argo rollouts get rollout guestbook -w

Flags:
  -h, --help                  help for rollout
      --no-color              Do not colorize output
      --timeout-seconds int   Timeout after specified seconds
  -w, --watch                 Watch live updates to the rollout

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use
```

kubectl argo rollouts get rollout reviews-v1 -n istio

kubectl argo rollouts get rollout reviews-v1 -n istio -w



##### create

```
[root@node01 ~]# kubectl argo rollouts create --help
This command creates a new Rollout, Experiment, AnalysisTemplate, ClusterAnalysisTemplate, or AnalysisRun resource from a file.

Usage:
  kubectl-argo-rollouts create [flags]
  kubectl-argo-rollouts create [command]

Examples:
        # Create an experiment and watch it
        kubectl argo rollouts create -f my-experiment.yaml -w

Available Commands:
  analysisrun Create an AnalysisRun from an AnalysisTemplate or a ClusterAnalysisTemplate

Flags:
  -f, --filename stringArray   Files to use to create the resource
  -h, --help                   help for create
      --no-color               Do not colorize output
  -w, --watch                  Watch live updates to the resource after creating

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use

Use "kubectl-argo-rollouts create [command] --help" for more information about a command.
```

kubectl argo rollouts create -f rollout-canary-reviews-Experiment.yaml -w

kubectl argo rollouts create -f rollout-canary-reviews-Experiment.yaml 

###### analysisrun

```
root@node01 ~]# kubectl argo rollouts create analysisrun --help
This command creates a new AnalysisRun from an existing AnalysisTemplate resources or from an AnalysisTemplate file.

Usage:
  kubectl-argo-rollouts create analysisrun [flags]

Aliases:
  analysisrun, ar

Examples:
        # Create an AnalysisRun from a local AnalysisTemplate file
        kubectl argo rollouts create analysisrun --from-file my-analysis-template.yaml
  
        # Create an AnalysisRun from a AnalysisTemplate in the cluster
        kubectl argo rollouts create analysisrun --from my-analysis-template

        # Create an AnalysisRun from a local ClusterAnalysisTemplate file
        kubectl argo rollouts create analysisrun --global --from my-analysis-cluster-template.yaml

        # Create an AnalysisRun from a ClusterAnalysisTemplate in the cluster
        kubectl argo rollouts create analysisrun --global --from my-analysis-cluster-template

Flags:
  -a, --argument stringArray   Arguments to the parameter template
      --from string            Create an AnalysisRun from an AnalysisTemplate or ClusterAnalysisTemplate in the cluster
      --from-file string       Create an AnalysisRun from an AnalysisTemplate or ClusterAnalysisTemplate in a local file
      --generate-name string   Use the specified generateName for the run
      --global                 Use a ClusterAnalysisTemplate instead of a AnalysisTemplate
  -h, --help                   help for analysisrun
      --instance-id string     Instance-ID for the AnalysisRun
      --name string            Use the specified name for the run

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use
```



##### set

```
[root@node01 ~]# kubectl argo rollouts set
Usage:
  kubectl-argo-rollouts set COMMAND [flags]
  kubectl-argo-rollouts set [command]

Examples:
  # Set rollout image
  kubectl argo rollouts set image my-rollout argoproj/rollouts-demo:yellow

Available Commands:
  image       Update the image of a rollout

Flags:
  -h, --help   help for set

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use

Use "kubectl-argo-rollouts set [command] --help" for more information about a command.
```

###### image

```
[root@node01 ~]# kubectl argo rollouts set image --help
Update the image of a rollout

Usage:
  kubectl-argo-rollouts set image ROLLOUT_NAME CONTAINER=IMAGE [flags]

Examples:
  # Set rollout image
  kubectl argo rollouts set image my-rollout www=image:v2

Flags:
  -h, --help   help for image

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use
```

 kubectl argo rollouts set  image reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

##### abort

```
[root@node01 ~]# kubectl argo rollouts  abort
Usage:
  kubectl-argo-rollouts abort ROLLOUT_NAME [flags]

Examples:
  # Abort a rollout
  kubectl argo rollouts abort guestbook

Flags:
  -h, --help   help for abort

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use
```

kubectl argo rollouts abort reviews-v1 -n istio

##### list

```
[root@node01 ~]# kubectl argo rollouts  list --help
This command consists of multiple subcommands which can be used to lists all of the 
rollouts or experiments for a specified namespace (uses current namespace context if namespace not specified).

Usage:
  kubectl-argo-rollouts list <rollout|experiment> [flags]
  kubectl-argo-rollouts list [command]

Examples:
        # List rollouts
        kubectl argo rollouts list rollouts

        # List experiments
        kubectl argo rollouts list experiments

Available Commands:
  experiments List experiments
  rollouts    List rollouts

Flags:
  -h, --help   help for list

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use

Use "kubectl-argo-rollouts list [command] --help" for more information about a command.
```

###### experiments

```
[root@node01 ~]# kubectl argo rollouts  list experiment --help
This command lists all of the experiments for a specified namespace (uses current namespace context if namespace not specified).

Usage:
  kubectl-argo-rollouts list experiments [flags]

Aliases:
  experiments, exp, experiment

Examples:
        # List rollouts
        kubectl argo rollouts list experiments
  
        # List rollouts from all namespaces
        kubectl argo rollouts list experiments --all-namespaces
  
        # List rollouts and watch for changes
        kubectl argo rollouts list experiments --watch

Flags:
      --all-namespaces   Include all namespaces
  -h, --help             help for experiments

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use
```

kubectl argo rollouts list experiments -n istio

kubectl argo rollouts list experiments --all-namespaces

###### rollouts

```
[root@node01 ~]# kubectl argo rollouts  list rollouts --help
This command lists all of the rollouts for a specified namespace (uses current namespace context if namespace not specified).

Usage:
  kubectl-argo-rollouts list rollouts [flags]

Aliases:
  rollouts, ro, rollout

Examples:
        # List rollouts
        kubectl argo rollouts list rollouts
  
        # List rollouts from all namespaces
        kubectl argo rollouts list rollouts --all-namespaces
  
        # List rollouts and watch for changes
        kubectl argo rollouts list rollouts --watch

Flags:
  -A, --all-namespaces   Include all namespaces
  -h, --help             help for rollouts
      --name string      Only show rollout with specified name
      --timestamps       Print timestamps on updates
  -w, --watch            Watch for changes

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use
```

kubectl argo rollouts list rollouts -n istio

kubectl argo rollouts list rollouts --all-namespaces

kubectl argo rollouts list rollouts --watch -n istio

kubectl argo rollouts list rollouts -n istio  --name reviews-v1

kubectl argo rollouts list rollouts -n istio --timestamps  

##### lint

```
[root@node01 ~]# kubectl argo rollouts lint
Usage:
  kubectl-argo-rollouts lint [flags]

Examples:
        # Lint a rollout
        kubectl argo rollouts lint -f my-rollout.yaml

Flags:
  -f, --filename string   File to lint
  -h, --help              help for lint

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use
```

kubectl argo rollouts lint -f rollout-canary-steps.yaml

##### pause

```
[root@node01 ~]# kubectl argo rollouts pause
Usage:
  kubectl-argo-rollouts pause ROLLOUT_NAME [flags]

Examples:
  # Pause a rollout
  kubectl argo rollouts pause guestbook

Flags:
  -h, --help   help for pause

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use
```

kubectl argo rollouts pause reviews-v1 -n istio

##### promote

```
[root@node01 ~]# kubectl argo rollouts promote
Usage:
  kubectl-argo-rollouts promote ROLLOUT_NAME [flags]

Examples:
        # Promote a paused rollout
        kubectl argo rollouts promote guestbook

        # Fully promote a rollout to desired version, skipping analysis, pauses, and steps
        kubectl argo rollouts promote guestbook --full

Flags:
      --full   Perform a full promotion, skipping analysis, pauses, and steps
  -h, --help   help for promote

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use
```

kubectl argo rollouts promote reviews-v1 -n istio

kubectl argo rollouts promote reviews-v1 -n istio --full

##### restart

```
[root@node01 ~]# kubectl argo rollouts restart
Usage:
  kubectl-argo-rollouts restart ROLLOUT [flags]

Examples:
        # Restart the pods of a rollout in now
        kubectl argo rollouts restart ROLLOUT_NAME

        # Restart the pods of a rollout in ten seconds
        kubectl argo rollouts restart ROLLOUT_NAME --in 10s

Flags:
  -h, --help        help for restart
  -i, --in string   Amount of time before a restart. (e.g. 30s, 5m, 1h)

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use
```

kubectl argo rollouts restart  reviews-v1 -n istio

kubectl argo rollouts restart  reviews-v1 -n istio --in 60s

##### retry

```
[root@node01 ~]# kubectl argo rollouts retry
Usage:
  kubectl-argo-rollouts retry <rollout|experiment> RESOURCE_NAME [flags]
  kubectl-argo-rollouts retry [command]

Examples:
        # Retry an aborted rollout
        kubectl argo rollouts retry rollout guestbook

        # Retry a failed experiment
        kubectl argo rollouts retry experiment my-experiment

Available Commands:
  experiment  Retry an experiment
  rollout     Retry an aborted rollout

Flags:
  -h, --help   help for retry

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use

Use "kubectl-argo-rollouts retry [command] --help" for more information about a command.
```

experiment

```
[root@node01 ~]# kubectl argo rollouts retry experiment --help
Retry a failed experiment.

Usage:
  kubectl-argo-rollouts retry experiment EXPERIMENT_NAME [flags]

Aliases:
  experiment, exp, experiments

Examples:
        # Retry an experiment
        kubectl argo rollouts retry experiment my-experiment

Flags:
  -h, --help   help for experiment

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use
```

kubectl argo rollouts retry experiment  reviews-v1 -n istio

rollout

```
[root@node01 ~]# kubectl argo rollouts retry rollout
Usage:
  kubectl-argo-rollouts retry rollout ROLLOUT_NAME [flags]

Aliases:
  rollout, ro, rollouts

Examples:
        # Retry an aborted rollout
        kubectl argo rollouts retry rollout guestbook

Flags:
  -h, --help   help for rollout

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use
```

kubectl argo rollouts retry rollout reviews-v1 -n istio

##### status

```
[root@node01 ~]# kubectl argo rollouts status
Usage:
  kubectl-argo-rollouts status ROLLOUT_NAME [flags]

Examples:
        # Watch the rollout until it succeeds
        kubectl argo rollouts status guestbook

        # Watch the rollout until it succeeds, fail if it takes more than 60 seconds
        kubectl argo rollouts status --timeout 60s guestbook


Flags:
  -h, --help               help for status
  -t, --timeout duration   The length of time to watch before giving up. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). Zero means wait forever
  -w, --watch              Watch the status of the rollout until it's done (default true)

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use
```

kubectl argo rollouts status reviews-v1 -n istio

kubectl argo rollouts status reviews-v1 -n istio --watch

kubectl argo rollouts status reviews-v1 -n istio --timeout 60s

##### terminate

```
[root@node01 ~]# kubectl argo rollouts terminate
Usage:
  kubectl-argo-rollouts terminate <analysisrun|experiment> RESOURCE_NAME [flags]
  kubectl-argo-rollouts terminate [command]

Examples:
        # Terminate an analysisRun
        kubectl argo rollouts terminate analysisrun guestbook-877894d5b-4-success-rate.1

        # Terminate a failed experiment
        kubectl argo rollouts terminate experiment my-experiment

Available Commands:
  analysisrun Terminate an AnalysisRun
  experiment  Terminate an experiment

Flags:
  -h, --help   help for terminate

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use

Use "kubectl-argo-rollouts terminate [command] --help" for more information about a command.
```

###### analysisrun

```
[root@node01 ~]# kubectl argo rollouts terminate analysisrun
Usage:
  kubectl-argo-rollouts terminate analysisrun ANALYSISRUN_NAME [flags]

Aliases:
  analysisrun, ar, analysisruns

Examples:
        # Terminate an AnalysisRun
        kubectl argo rollouts terminate analysisrun guestbook-877894d5b-4-success-rate.1

Flags:
  -h, --help   help for analysisrun

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use
```

kubectl argo rollouts terminate analysisrun reviews-v1-877894d5b-4-success-rate.1 -n istio

###### experiment

```
[root@node01 ~]# kubectl argo rollouts terminate experiment
Usage:
  kubectl-argo-rollouts terminate experiment EXPERIMENT_NAME [flags]

Aliases:
  experiment, exp, experiments

Examples:
        # Terminate an experiment
        kubectl argo rollouts terminate experiment my-experiment

Flags:
  -h, --help   help for experiment

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use
```

kubectl argo rollouts terminate experiment reviews-v1 -n istio

##### undo

```
[root@node01 ~]# kubectl argo rollouts undo
Usage:
  kubectl-argo-rollouts undo ROLLOUT_NAME [flags]

Examples:
        # Undo a rollout
        kubectl argo rollouts undo guestbook

        # Undo a rollout revision 3
        kubectl argo rollouts undo guestbook --to-revision=3

Flags:
  -h, --help              help for undo
      --to-revision int   The revision to rollback to. Default to 0 (last revision).

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use
```

kubectl argo rollouts undo  reviews-v1 -n istio

kubectl argo rollouts undo reviews-v1 -n istio --to-revision=3

##### version

```
[root@node01 ~]# kubectl argo rollouts version --help
Show the version and build information of the Argo Rollouts plugin.

Usage:
  kubectl-argo-rollouts version [flags]

Examples:
        # Get full version info
        kubectl argo rollouts version

        # Get just plugin version number
        kubectl argo rollouts version --short

Flags:
  -h, --help    help for version
      --short   print just the version number

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use
```

kubectl argo rollouts version

kubectl argo rollouts version --short

##### dashboard

```
[root@node01 ~]# kubectl argo rollouts dashboard --help
Start UI dashboard

Usage:
  kubectl-argo-rollouts dashboard [flags]

Flags:
  -h, --help   help for dashboard

Global Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "/root/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
  -v, --kloglevel int                  Log level for kubernetes client library
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
      --loglevel string                Log level for kubectl argo rollouts (default "info")
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use
```

kubectl-argo-rollouts dashboard

```
[root@node01 ~]# kubectl argo rollouts dashboard
INFO[0000] Argo Rollouts Dashboard is now available at localhost 3100 
```



#### 迁移

There are ways to migrate to Rollout:

- Convert an existing Deployment resource to a Rollout resource.
- Reference an existing Deployment from a Rollout using `workloadRef` field.

Convert Deployment to Rollout

When converting a Deployment to a Rollout, it involves changing three fields:

1. Replacing the `apiVersion` from `apps/v1` to `argoproj.io/v1alpha1`
2. Replacing the `kind` from `Deployment` to `Rollout`
3. Replacing the deployment strategy with a [blue-green](https://argoproj.github.io/argo-rollouts/features/bluegreen/) or [canary](https://argoproj.github.io/argo-rollouts/features/canary/) strategy

Below is an example of a Rollout resource using the canary strategy.

# 蓝绿发布

##  什么是蓝绿发布

蓝绿发布是指，同一个系统有两套部署，其中绿部署代表对外提供服务的应用， 蓝部署代表备用部署，如果有相关的升级，回退操作，都在蓝部署上执行，确定测试没有问题，可以实现蓝绿转换。
优缺点
优点：
1.可以实现服务不停机
2.保留老版本，随时可以回退
3.所有的流量都走当前版本
弱点：
使用蓝绿部署需要注意的一些细节包括：
1、当切换到蓝色环境时，需要妥当处理未完成的业务和新的业务。可能引起服务宕机
2、需要提前考虑数据库与应用部署同步迁移/回滚的问题。
3、蓝绿部署需要有基础设施支持。
4、在非隔离基础架构（ VM 、 Docker 等）上执行蓝绿部署，蓝色环境和绿色环境有被摧毁的风险。
5、另外，这种方式不好的地方还在于冗余产生的额外维护、配置的成本，以及服务器本身运行的开销。
蓝绿部署适用的场景：
1、不停止老版本，额外搞一套新版本，等测试发现新版本OK后，删除老版本。
2、蓝绿发布是一种用于升级与更新的发布策略，部署的最小维度是容器，而发布的最小维度是应用。
3、蓝绿发布对于增量升级有比较好的支持，但是对于涉及数据表结构变更等等不可逆转的升级，并不完全合适用蓝绿发布来实现，需要结合一些业务的逻辑以及数据迁移与回滚的策略才可以完全满足需求。

## 过程

![flagger-bluegreen-steps](images\flagger-bluegreen-steps.png)





## 案例

### 手工实现



### flagger

blue-green-reviews.yaml

kubectl apply -f blue-green-reviews.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  revertOnDeletion: true
  provider: istio
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  # the maximum time in seconds for the canary deployment
  # to make progress before rollback (default 600s)
  progressDeadlineSeconds: 60
  service:
    port: 9080
    name: reviews
    portDiscovery: true
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    # schedule interval (default 60s)
    interval: 30s
    threshold: 2
    iterations: 10
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        # maximum req duration P99
        # milliseconds
        thresholdRange:
          max: 500
        interval: 30s
    # acceptance/load testing hooks
    webhooks:
      - name: smoke-test
        type: pre-rollout
        url: http://flagger-loadtester.istio-system/
        timeout: 15s
        metadata:
          type: bash
          cmd: "curl -sd 'anon' http://reviews-canary.istio:9080/reviews/0 "
      - name: load-test
        url: http://flagger-loadtester.istio-system/
        type: rollout
        timeout: 5s
        metadata:
          type: cmd
          cmd: "hey -z 10m -q 10 -c 2 http://reviews-canary.istio:9080/reviews/0"
```



vs-reviews-canary.yaml

kubectl apply -f vs-reviews-canary.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews-canary
spec:
  gateways:
  - bookinfo-gateway
  hosts:
  - "*"
  http:
  - route:
    - destination:
        host: reviews-canary
        port:
          number: 9080
```



```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2

kubectl describe canary bookinfo -n istio

执行请求：
go-stress-testing -n 10000 -c 5 -u http://192.168.229.134:30468/reviews/0

 kubectl get vs -n istio reviews -o yaml
spec:
  gateways:
  - mesh
  hosts:
  - reviews
  http:
  - route:
    - destination:
        host: reviews-primary
      weight: 0
    - destination:
        host: reviews-canary
      weight: 100
      
Events:
  Type     Reason  Age                    From     Message
  ----     ------  ----                   ----     -------
  Warning  Synced  9m10s                  flagger  reviews-v1-primary.istio not ready: waiting for rollout to finish: observed deployment generation less than desired generation
  Normal   Synced  8m40s (x2 over 9m10s)  flagger  all the metrics providers are available!
  Normal   Synced  8m40s                  flagger  Initialization done! bookinfo.istio
  Normal   Synced  7m40s                  flagger  New revision detected! Scaling up reviews-v1.istio
  Normal   Synced  7m10s                  flagger  Starting canary analysis for reviews-v1.istio
  Normal   Synced  7m10s                  flagger  Pre-rollout check smoke-test passed
  Normal   Synced  7m10s                  flagger  Advance bookinfo.istio canary iteration 1/10
  Normal   Synced  6m39s                  flagger  Advance bookinfo.istio canary iteration 2/10
  Warning  Synced  6m10s                  flagger  Halt advancement no values found for istio metric request-duration probably reviews-v1.istio is not receiving traffic
  Normal   Synced  5m40s                  flagger  Advance bookinfo.istio canary iteration 3/10
  Normal   Synced  5m10s                  flagger  Advance bookinfo.istio canary iteration 4/10
  Normal   Synced  10s (x10 over 4m40s)   flagger  (combined from similar events): Promotion completed! Scaling down reviews-v1.istio
```

清理：

kubectl delete canary bookinfo -n istio

kubectl delete vs reviews-canary -n istio



### argo-rollout

![argo-blue-green-deployments](images\argo-blue-green-deployments.png)

The following describes the sequence of events that happen during a blue-green update.

1. Beginning at a fully promoted, steady-state, a revision 1 ReplicaSet is pointed to by both the `activeService` and `previewService`.
2. A user initiates an update by modifying the pod template (`spec.template.spec`).
3. The revision 2 ReplicaSet is created with size 0.
4. The preview service is modified to point to the revision 2 ReplicaSet. The `activeService` remains pointing to revision 1.
5. The revision 2 ReplicaSet is scaled to either `spec.replicas` or `previewReplicaCount` if set.
6. Once revision 2 ReplicaSet Pods are fully available, `prePromotionAnalysis` begins.
7. Upon success of `prePromotionAnalysis`, the blue/green pauses if `autoPromotionEnabled` is false, or `autoPromotionSeconds` is non-zero.
8. The rollout is resumed either manually by a user, or automatically by surpassing `autoPromotionSeconds`.
9. The revision 2 ReplicaSet is scaled to the `spec.replicas`, if the `previewReplicaCount` feature was used.
10. The rollout "promotes" the revision 2 ReplicaSet by updating the `activeService` to point to it. At this point, there are no services pointing to revision 1
11. `postPromotionAnalysis` analysis begins
12. Once `postPromotionAnalysis` completes successfully, the update is successful and the revision 2 ReplicaSet is marked as stable. The rollout is considered fully-promoted.
13. After waiting `scaleDownDelaySeconds` (default 30 seconds), the revision 1 ReplicaSet is scaled down



**autoPromotionEnabled**

The AutoPromotionEnabled will make the rollout automatically promote the new ReplicaSet to the active service once the new ReplicaSet is healthy. This field is defaulted to true if it is not specified.

Defaults to true

**autoPromotionSeconds**

The AutoPromotionSeconds will make the rollout automatically promote the new ReplicaSet to active Service after the AutoPromotionSeconds time has passed since the rollout has entered a paused state. If the `AutoPromotionEnabled` field is set to true, this field will be ignored

Defaults to nil

**antiAffinity**

Check out the [Anti Affinity document](https://argoproj.github.io/argo-rollouts/features/anti-affinity/anti-affinity/) document for more information.

Defaults to nil

***maxUnavailable***

The maximum number of pods that can be unavailable during the update. Value can be an absolute number (ex: 5) or a percentage of desired pods (ex: 10%). This can not be 0 if MaxSurge is 0.

Defaults to 0

**prePromotionAnalysis**

Configures the [Analysis](https://argoproj.github.io/argo-rollouts/features/analysis/#bluegreen-pre-promotion-analysis) before it switches traffic to the new version. The AnalysisRun can be used to block the Service selector switch until the AnalysisRun finishes successful. The success or failure of the analysis run decides if the Rollout will switch traffic, or abort the Rollout completely.

Defaults to nil

**postPromotionAnalysis**

Configures the [Analysis](https://argoproj.github.io/argo-rollouts/features/analysis/#bluegreen-pre-promotion-analysis) after the traffic switch to new version. If the analysis run fails or errors out, the Rollout enters an aborted state and switch traffic back to the previous stable Replicaset. If `scaleDownDelaySeconds` is specified, the controller will cancel any AnalysisRuns at time of `scaleDownDelay` to scale down the ReplicaSet. If it is omitted, and post analysis is specified, it will scale down the ReplicaSet only after the AnalysisRun completes (with a minimum of 30 seconds).

Defaults to nil

**previewService**

The PreviewService field references a Service that will be modified to send traffic to the new ReplicaSet before the new one is promoted to receiving traffic from the active service. Once the new ReplicaSet starts receiving traffic from the active service, the preview service will also be modified to send traffic to the new ReplicaSet as well. The Rollout always makes sure that the preview service is sending traffic to the newest ReplicaSet. As a result, if a new version is introduced before the old version is promoted to the active service, the controller will immediately switch over to that brand new version.

This feature is used to provide an endpoint that can be used to test a new version of an application.

Defaults to an empty string

**previewReplicaCount**

The PreviewReplicaCount field will indicate the number of replicas that the new version of an application should run. Once the application is ready to promote to the active service, the controller will scale the new ReplicaSet to the value of the `spec.replicas`. The rollout will not switch over the active service to the new ReplicaSet until it matches the `spec.replicas` count.

This feature is mainly used to save resources during the testing phase. If the application does not need a fully scaled up application for the tests, this feature can help save some resources.

If omitted, the preview ReplicaSet stack will be scaled to 100% of the replicas.

**scaleDownDelaySeconds**

The ScaleDownDelaySeconds is used to delay scaling down the old ReplicaSet after the active Service is switched to the new ReplicaSet.

Defaults to 30

**scaleDownDelayRevisionLimit**

The ScaleDownDelayRevisionLimit limits the number of old active ReplicaSets to keep scaled up while they wait for the scaleDownDelay to pass after being removed from the active service.

If omitted, all ReplicaSets will be retained for the specified scaleDownDelay





#### activeService,previewService

release/blueGreen/argo-rollout/bg-reviews-activeService-previewService.yaml

kubectl apply -f bg-reviews-activeService-previewService.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
  template:
    metadata:
      labels:
        app: reviews
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    blueGreen: 
      activeService: rollout-bluegreen-active
      previewService: rollout-bluegreen-preview
```

svc-rollout-bluegreen-active.yaml

kubectl apply -f svc-rollout-bluegreen-active.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: rollout-bluegreen-active
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
```

svc-rollout-bluegreen-preview.yaml

kubectl apply -f svc-rollout-bluegreen-preview.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: rollout-bluegreen-preview
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
```



```
 kubectl argo rollouts set  image reviews reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews  -n istio
kubectl argo rollouts get rollout reviews --watch -n istio

Name:            reviews
Namespace:       istio
Status:          ✔ Healthy
Strategy:        BlueGreen
Images:          docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (stable, active)
Replicas:
  Desired:       1
  Current:       1
  Updated:       1
  Ready:         1
  Available:     1

NAME                                 KIND        STATUS         AGE    INFO
⟳ reviews                            Rollout     ✔ Healthy      3m41s  
├──# revision:2                                                        
│  └──⧉ reviews-5895cfcd85           ReplicaSet  ✔ Healthy      43s    stable,active
│     └──□ reviews-5895cfcd85-rwk9m  Pod         ✔ Running      43s    ready:2/2
└──# revision:1                                                        
   └──⧉ reviews-db897675d            ReplicaSet  • ScaledDown   3m41s  
      └──□ reviews-db897675d-b6cqc   Pod         ◌ Terminating  3m41s  ready:0/2


Events:
  Type    Reason                Age    From                 Message
  ----    ------                ----   ----                 -------
  Normal  RolloutUpdated        3m55s  rollouts-controller  Rollout updated to revision 1
  Normal  NewReplicaSetCreated  3m55s  rollouts-controller  Created ReplicaSet reviews-db897675d (revision 1)
  Normal  SwitchService         3m55s  rollouts-controller  Switched selector for service 'rollout-bluegreen-preview' from '' to 'db897675d'
  Normal  ScalingReplicaSet     3m55s  rollouts-controller  Scaled up ReplicaSet reviews-db897675d (revision 1) from 0 to 1
  Normal  RolloutCompleted      3m55s  rollouts-controller  Rollout completed update to revision 1 (db897675d): Initial deploy
  Normal  SwitchService         3m49s  rollouts-controller  Switched selector for service 'rollout-bluegreen-active' from '' to 'db897675d'
  Normal  RolloutUpdated        57s    rollouts-controller  Rollout updated to revision 2
  Normal  NewReplicaSetCreated  57s    rollouts-controller  Created ReplicaSet reviews-5895cfcd85 (revision 2)
  Normal  SwitchService         57s    rollouts-controller  Switched selector for service 'rollout-bluegreen-preview' from 'db897675d' to '5895cfcd85'
  Normal  ScalingReplicaSet     57s    rollouts-controller  Scaled up ReplicaSet reviews-5895cfcd85 (revision 2) from 0 to 1
  Normal  SwitchService         53s    rollouts-controller  Switched selector for service 'rollout-bluegreen-active' from 'db897675d' to '5895cfcd85'
  Normal  RolloutCompleted      53s    rollouts-controller  Rollout completed update to revision 2 (5895cfcd85): Completed blue-green update
  Normal  ScalingReplicaSet     23s    rollouts-controller  Scaled down ReplicaSet reviews-db897675d (revision 1) from 1 to 0
```

清理：

kubectl delete rollout reviews -n istio

kubectl delete svc  -n istio rollout-bluegreen-active

kubectl delete svc -n istio  rollout-bluegreen-preview



#### activeMetadata,previewMetadata

release/blueGreen/argo-rollout/bg-reviews-activeMetadata-previewMetadata.yaml

kubectl apply -f bg-reviews-activeMetadata-previewMetadata.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
  template:
    metadata:
      labels:
        app: reviews
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    blueGreen: 
      activeService: rollout-bluegreen-active
      previewService: rollout-bluegreen-preview
      activeMetadata:
        annotations:
          stable: stable
        labels:
          stable: stable
      previewMetadata:
        annotations:
          preview: preview
        labels:
          preview: preview
```

svc-rollout-bluegreen-active.yaml

kubectl apply -f svc-rollout-bluegreen-active.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: rollout-bluegreen-active
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
```

svc-rollout-bluegreen-preview.yaml

kubectl apply -f svc-rollout-bluegreen-preview.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: rollout-bluegreen-preview
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
```



```
 kubectl argo rollouts set  image reviews reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews  -n istio
kubectl argo rollouts get rollout reviews --watch -n istio

Name:            reviews
Namespace:       istio
Status:          ✔ Healthy
Strategy:        BlueGreen
Images:          docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (stable, active)
Replicas:
  Desired:       1
  Current:       1
  Updated:       1
  Ready:         1
  Available:     1

NAME                                 KIND        STATUS        AGE    INFO
⟳ reviews                            Rollout     ✔ Healthy     2m50s  
├──# revision:2                                                       
│  └──⧉ reviews-5895cfcd85           ReplicaSet  ✔ Healthy     2m16s  stable,active
│     └──□ reviews-5895cfcd85-965ms  Pod         ✔ Running     2m16s  ready:2/2
└──# revision:1                                                       
   └──⧉ reviews-db897675d            ReplicaSet  • ScaledDown  2m50s  

Events:
  Type    Reason                Age    From                 Message
  ----    ------                ----   ----                 -------
  Normal  RolloutUpdated        3m9s   rollouts-controller  Rollout updated to revision 1
  Normal  NewReplicaSetCreated  3m9s   rollouts-controller  Created ReplicaSet reviews-db897675d (revision 1)
  Normal  SwitchService         3m9s   rollouts-controller  Switched selector for service 'rollout-bluegreen-preview' from '' to 'db897675d'
  Normal  ScalingReplicaSet     3m8s   rollouts-controller  Scaled up ReplicaSet reviews-db897675d (revision 1) from 0 to 1
  Normal  RolloutCompleted      3m8s   rollouts-controller  Rollout completed update to revision 1 (db897675d): Initial deploy
  Normal  SwitchService         3m2s   rollouts-controller  Switched selector for service 'rollout-bluegreen-active' from '' to 'db897675d'
  Normal  RolloutUpdated        2m35s  rollouts-controller  Rollout updated to revision 2
  Normal  NewReplicaSetCreated  2m35s  rollouts-controller  Created ReplicaSet reviews-5895cfcd85 (revision 2)
  Normal  SwitchService         2m35s  rollouts-controller  Switched selector for service 'rollout-bluegreen-preview' from 'db897675d' to '5895cfcd85'
  Normal  ScalingReplicaSet     2m35s  rollouts-controller  Scaled up ReplicaSet reviews-5895cfcd85 (revision 2) from 0 to 1
  Normal  SwitchService         2m31s  rollouts-controller  Switched selector for service 'rollout-bluegreen-active' from 'db897675d' to '5895cfcd85'
  Normal  RolloutCompleted      2m31s  rollouts-controller  Rollout completed update to revision 2 (5895cfcd85): Completed blue-green update
  Normal  ScalingReplicaSet     2m1s   rollouts-controller  Scaled down ReplicaSet reviews-db897675d (revision 1) from 1 to 0
```

清理：

kubectl delete rollout reviews -n istio

kubectl delete svc  -n istio rollout-bluegreen-active

kubectl delete svc -n istio  rollout-bluegreen-preview



#### previewReplicaCount

release/blueGreen/argo-rollout/bg-reviews-previewReplicaCount.yaml

kubectl apply -f bg-reviews-previewReplicaCount.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
  template:
    metadata:
      labels:
        app: reviews
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    blueGreen: 
      activeService: rollout-bluegreen-active
      previewService: rollout-bluegreen-preview
      previewReplicaCount: 3
```

svc-rollout-bluegreen-active.yaml

kubectl apply -f svc-rollout-bluegreen-active.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: rollout-bluegreen-active
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
```

svc-rollout-bluegreen-preview.yaml

kubectl apply -f svc-rollout-bluegreen-preview.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: rollout-bluegreen-preview
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
```



```
kubectl argo rollouts set  image reviews reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews  -n istio
kubectl argo rollouts get rollout reviews --watch -n istio

Name:            reviews
Namespace:       istio
Status:          ◌ Progressing
Message:         updated replicas are still becoming available
Strategy:        BlueGreen
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 (stable, active)
                 docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (preview)
Replicas:
  Desired:       1
  Current:       4
  Updated:       3
  Ready:         1
  Available:     1

NAME                                 KIND        STATUS             AGE  INFO
⟳ reviews                            Rollout     ◌ Progressing      25s  
├──# revision:2                                                          
│  └──⧉ reviews-5895cfcd85           ReplicaSet  ◌ Progressing      3s   preview
│     ├──□ reviews-5895cfcd85-7nk7g  Pod           PodInitializing  3s   ready:0/2
│     ├──□ reviews-5895cfcd85-94sbw  Pod           PodInitializing  3s   ready:0/2
│     └──□ reviews-5895cfcd85-hhnrf  Pod         ✔ Running          3s   ready:1/2
└──# revision:1                                                          
   └──⧉ reviews-db897675d            ReplicaSet  ✔ Healthy          25s  stable,active
      └──□ reviews-db897675d-kqjc6   Pod         ✔ Running          24s  ready:2/2


Events:
  Type    Reason                Age   From                 Message
  ----    ------                ----  ----                 -------
  Normal  RolloutUpdated        92s   rollouts-controller  Rollout updated to revision 1
  Normal  NewReplicaSetCreated  92s   rollouts-controller  Created ReplicaSet reviews-db897675d (revision 1)
  Normal  SwitchService         91s   rollouts-controller  Switched selector for service 'rollout-bluegreen-preview' from '' to 'db897675d'
  Normal  ScalingReplicaSet     91s   rollouts-controller  Scaled up ReplicaSet reviews-db897675d (revision 1) from 0 to 1
  Normal  RolloutCompleted      91s   rollouts-controller  Rollout completed update to revision 1 (db897675d): Initial deploy
  Normal  SwitchService         87s   rollouts-controller  Switched selector for service 'rollout-bluegreen-active' from '' to 'db897675d'
  Normal  NewReplicaSetCreated  70s   rollouts-controller  Created ReplicaSet reviews-5895cfcd85 (revision 2)
  Normal  RolloutUpdated        70s   rollouts-controller  Rollout updated to revision 2
  Normal  SwitchService         70s   rollouts-controller  Switched selector for service 'rollout-bluegreen-preview' from 'db897675d' to '5895cfcd85'
  Normal  ScalingReplicaSet     70s   rollouts-controller  Scaled up ReplicaSet reviews-5895cfcd85 (revision 2) from 0 to 3
  Normal  ScalingReplicaSet     39s   rollouts-controller  Scaled down ReplicaSet reviews-5895cfcd85 (revision 2) from 3 to 1
  Normal  SwitchService         38s   rollouts-controller  Switched selector for service 'rollout-bluegreen-active' from 'db897675d' to '5895cfcd85'
  Normal  RolloutCompleted      38s   rollouts-controller  Rollout completed update to revision 2 (5895cfcd85): Completed blue-green update
  Normal  ScalingReplicaSet     7s    rollouts-controller  Scaled down ReplicaSet reviews-db897675d (revision 1) from 1 to 0
```

清理：

kubectl delete rollout reviews -n istio

kubectl delete svc  -n istio rollout-bluegreen-active

kubectl delete svc -n istio  rollout-bluegreen-preview



#### maxUnavailable

release/blueGreen/argo-rollout/bg-reviews-maxUnavailable.yaml

kubectl apply -f bg-reviews-maxUnavailable.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews
spec:
  replicas: 5
  selector:
    matchLabels:
      app: reviews
  template:
    metadata:
      labels:
        app: reviews
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    blueGreen: 
      activeService: rollout-bluegreen-active
      previewService: rollout-bluegreen-preview
      maxUnavailable: 3
```

svc-rollout-bluegreen-active.yaml

kubectl apply -f svc-rollout-bluegreen-active.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: rollout-bluegreen-active
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
```

svc-rollout-bluegreen-preview.yaml

kubectl apply -f svc-rollout-bluegreen-preview.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: rollout-bluegreen-preview
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
```



```
kubectl argo rollouts set  image reviews reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews  -n istio
kubectl argo rollouts get rollout reviews --watch -n istio

Name:            reviews
Namespace:       istio
Status:          ✔ Healthy
Strategy:        BlueGreen
Images:          docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (stable, active)
Replicas:
  Desired:       5
  Current:       5
  Updated:       5
  Ready:         5
  Available:     5

NAME                                 KIND        STATUS         AGE   INFO
⟳ reviews                            Rollout     ✔ Healthy      118s  
├──# revision:2                                                       
│  └──⧉ reviews-5895cfcd85           ReplicaSet  ✔ Healthy      53s   stable,active
│     ├──□ reviews-5895cfcd85-2hhp4  Pod         ✔ Running      52s   ready:2/2
│     ├──□ reviews-5895cfcd85-5w9wk  Pod         ✔ Running      52s   ready:2/2
│     ├──□ reviews-5895cfcd85-7tstz  Pod         ✔ Running      52s   ready:2/2
│     ├──□ reviews-5895cfcd85-fw7pc  Pod         ✔ Running      52s   ready:2/2
│     └──□ reviews-5895cfcd85-xhcdd  Pod         ✔ Running      52s   ready:2/2
└──# revision:1                                                       
   └──⧉ reviews-db897675d            ReplicaSet  • ScaledDown   118s  
      ├──□ reviews-db897675d-7t7x8   Pod         ◌ Terminating  118s  ready:2/2
      ├──□ reviews-db897675d-lhjr8   Pod         ◌ Terminating  118s  ready:2/2
      ├──□ reviews-db897675d-ndq2n   Pod         ◌ Terminating  118s  ready:2/2
      ├──□ reviews-db897675d-55p8d   Pod         ◌ Terminating  117s  ready:2/2
      └──□ reviews-db897675d-sztgr   Pod         ◌ Terminating  117s  ready:2/2
      
Events:
  Type    Reason                Age    From                 Message
  ----    ------                ----   ----                 -------
  Normal  RolloutUpdated        2m25s  rollouts-controller  Rollout updated to revision 1
  Normal  NewReplicaSetCreated  2m25s  rollouts-controller  Created ReplicaSet reviews-db897675d (revision 1)
  Normal  SwitchService         2m25s  rollouts-controller  Switched selector for service 'rollout-bluegreen-preview' from '' to 'db897675d'
  Normal  ScalingReplicaSet     2m25s  rollouts-controller  Scaled up ReplicaSet reviews-db897675d (revision 1) from 0 to 5
  Normal  RolloutCompleted      2m25s  rollouts-controller  Rollout completed update to revision 1 (db897675d): Initial deploy
  Normal  SwitchService         99s    rollouts-controller  Switched selector for service 'rollout-bluegreen-active' from '' to 'db897675d'
  Normal  RolloutUpdated        79s    rollouts-controller  Rollout updated to revision 2
  Normal  NewReplicaSetCreated  79s    rollouts-controller  Created ReplicaSet reviews-5895cfcd85 (revision 2)
  Normal  SwitchService         79s    rollouts-controller  Switched selector for service 'rollout-bluegreen-preview' from 'db897675d' to '5895cfcd85'
  Normal  ScalingReplicaSet     79s    rollouts-controller  Scaled up ReplicaSet reviews-5895cfcd85 (revision 2) from 0 to 5
  Normal  SwitchService         58s    rollouts-controller  Switched selector for service 'rollout-bluegreen-active' from 'db897675d' to '5895cfcd85'
  Normal  RolloutCompleted      58s    rollouts-controller  Rollout completed update to revision 2 (5895cfcd85): Completed blue-green update
  Normal  ScalingReplicaSet     28s    rollouts-controller  Scaled down ReplicaSet reviews-db897675d (revision 1) from 5 to 0
```

清理：

kubectl delete rollout reviews -n istio

kubectl delete svc  -n istio rollout-bluegreen-active

kubectl delete svc -n istio  rollout-bluegreen-preview



#### autoPromotionEnabled,autoPromotionSeconds

##### enabled

release/blueGreen/argo-rollout/bg-reviews-autoPromotionEnabled-enabled.yaml

kubectl apply -f bg-reviews-autoPromotionEnabled-enabled.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews
spec:
  replicas: 5
  selector:
    matchLabels:
      app: reviews
  template:
    metadata:
      labels:
        app: reviews
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    blueGreen: 
      activeService: rollout-bluegreen-active
      previewService: rollout-bluegreen-preview
      autoPromotionEnabled: true
      autoPromotionSeconds: 120
```

svc-rollout-bluegreen-active.yaml

kubectl apply -f svc-rollout-bluegreen-active.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: rollout-bluegreen-active
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
```

svc-rollout-bluegreen-preview.yaml

kubectl apply -f svc-rollout-bluegreen-preview.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: rollout-bluegreen-preview
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
```



```
kubectl argo rollouts set  image reviews reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews  -n istio
kubectl argo rollouts get rollout reviews --watch -n istio

Name:            reviews
Namespace:       istio
Status:          ॥ Paused
Message:         BlueGreenPause
Strategy:        BlueGreen
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 (stable, active)
                 docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (preview)
Replicas:
  Desired:       5
  Current:       10
  Updated:       5
  Ready:         5
  Available:     5

NAME                                 KIND        STATUS     AGE    INFO
⟳ reviews                            Rollout     ॥ Paused   2m57s  
├──# revision:2                                                    
│  └──⧉ reviews-5895cfcd85           ReplicaSet  ✔ Healthy  2m14s  preview
│     ├──□ reviews-5895cfcd85-gbdsc  Pod         ✔ Running  2m12s  ready:2/2
│     ├──□ reviews-5895cfcd85-lbzx7  Pod         ✔ Running  2m12s  ready:2/2
│     ├──□ reviews-5895cfcd85-t6lq4  Pod         ✔ Running  2m12s  ready:2/2
│     ├──□ reviews-5895cfcd85-6s9rr  Pod         ✔ Running  2m11s  ready:2/2
│     └──□ reviews-5895cfcd85-f2mkl  Pod         ✔ Running  2m11s  ready:2/2
└──# revision:1                                                    
   └──⧉ reviews-db897675d            ReplicaSet  ✔ Healthy  2m57s  stable,active
      ├──□ reviews-db897675d-9r87c   Pod         ✔ Running  2m57s  ready:2/2
      ├──□ reviews-db897675d-gnjpf   Pod         ✔ Running  2m57s  ready:2/2
      ├──□ reviews-db897675d-hgqnh   Pod         ✔ Running  2m57s  ready:2/2
      ├──□ reviews-db897675d-t2wkm   Pod         ✔ Running  2m57s  ready:2/2
      └──□ reviews-db897675d-x4gct   Pod         ✔ Running  2m57s  ready:2/2

Events:
  Type    Reason                Age    From                 Message
  ----    ------                ----   ----                 -------
  Normal  NewReplicaSetCreated  3m29s  rollouts-controller  Created ReplicaSet reviews-db897675d (revision 1)
  Normal  SwitchService         3m29s  rollouts-controller  Switched selector for service 'rollout-bluegreen-preview' from '' to 'db897675d'
  Normal  ScalingReplicaSet     3m29s  rollouts-controller  Scaled up ReplicaSet reviews-db897675d (revision 1) from 0 to 5
  Normal  RolloutCompleted      3m29s  rollouts-controller  Rollout completed update to revision 1 (db897675d): Initial deploy
  Normal  RolloutUpdated        3m29s  rollouts-controller  Rollout updated to revision 1
  Normal  SwitchService         2m46s  rollouts-controller  Switched selector for service 'rollout-bluegreen-active' from '' to 'db897675d'
  Normal  SwitchService         2m45s  rollouts-controller  Switched selector for service 'rollout-bluegreen-preview' from 'db897675d' to '5895cfcd85'
  Normal  RolloutUpdated        2m45s  rollouts-controller  Rollout updated to revision 2
  Normal  NewReplicaSetCreated  2m45s  rollouts-controller  Created ReplicaSet reviews-5895cfcd85 (revision 2)
  Normal  ScalingReplicaSet     2m44s  rollouts-controller  Scaled up ReplicaSet reviews-5895cfcd85 (revision 2) from 0 to 5
  Normal  RolloutPaused         2m10s  rollouts-controller  Rollout is paused (BlueGreenPause)
  Normal  SwitchService         10s    rollouts-controller  Switched selector for service 'rollout-bluegreen-active' from 'db897675d' to '5895cfcd85'
  Normal  RolloutCompleted      10s    rollouts-controller  Rollout completed update to revision 2 (5895cfcd85): Completed blue-green update
  Normal  RolloutResumed        10s    rollouts-controller  Rollout is resumed

```

清理：

kubectl delete rollout reviews -n istio

kubectl delete svc  -n istio rollout-bluegreen-active

kubectl delete svc -n istio  rollout-bluegreen-preview



##### disabled

release/blueGreen/argo-rollout/bg-reviews-autoPromotionEnabled-disabled.yaml

kubectl apply -f bg-reviews-autoPromotionEnabled-disabled.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews
spec:
  replicas: 5
  selector:
    matchLabels:
      app: reviews
  template:
    metadata:
      labels:
        app: reviews
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    blueGreen: 
      activeService: rollout-bluegreen-active
      previewService: rollout-bluegreen-preview
      autoPromotionEnabled: false
```

svc-rollout-bluegreen-active.yaml

kubectl apply -f svc-rollout-bluegreen-active.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: rollout-bluegreen-active
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
```

svc-rollout-bluegreen-preview.yaml

kubectl apply -f svc-rollout-bluegreen-preview.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: rollout-bluegreen-preview
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
```



```
kubectl argo rollouts set  image reviews reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews  -n istio
kubectl argo rollouts get rollout reviews --watch -n istio

Name:            reviews
Namespace:       istio
Status:          ॥ Paused
Message:         BlueGreenPause
Strategy:        BlueGreen
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 (stable, active)
                 docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (preview)
Replicas:
  Desired:       5
  Current:       10
  Updated:       5
  Ready:         5
  Available:     5

NAME                                 KIND        STATUS     AGE    INFO
⟳ reviews                            Rollout     ॥ Paused   5m28s  
├──# revision:2                                                    
│  └──⧉ reviews-5895cfcd85           ReplicaSet  ✔ Healthy  4m41s  preview
│     ├──□ reviews-5895cfcd85-2td9r  Pod         ✔ Running  4m40s  ready:2/2
│     ├──□ reviews-5895cfcd85-78k55  Pod         ✔ Running  4m40s  ready:2/2
│     ├──□ reviews-5895cfcd85-l4s7q  Pod         ✔ Running  4m40s  ready:2/2
│     ├──□ reviews-5895cfcd85-wc85n  Pod         ✔ Running  4m40s  ready:2/2
│     └──□ reviews-5895cfcd85-mffzf  Pod         ✔ Running  4m39s  ready:2/2
└──# revision:1                                                    
   └──⧉ reviews-db897675d            ReplicaSet  ✔ Healthy  5m28s  stable,active
      ├──□ reviews-db897675d-4w2mz   Pod         ✔ Running  5m27s  ready:2/2
      ├──□ reviews-db897675d-drdhx   Pod         ✔ Running  5m27s  ready:2/2
      ├──□ reviews-db897675d-g25wc   Pod         ✔ Running  5m27s  ready:2/2
      ├──□ reviews-db897675d-jwrcw   Pod         ✔ Running  5m27s  ready:2/2
      └──□ reviews-db897675d-qzpqv   Pod         ✔ Running  5m27s  ready:2/2
      
Events:
  Type    Reason                Age    From                 Message
  ----    ------                ----   ----                 -------
  Normal  RolloutUpdated        5m48s  rollouts-controller  Rollout updated to revision 1
  Normal  NewReplicaSetCreated  5m48s  rollouts-controller  Created ReplicaSet reviews-db897675d (revision 1)
  Normal  SwitchService         5m48s  rollouts-controller  Switched selector for service 'rollout-bluegreen-preview' from '' to 'db897675d'
  Normal  ScalingReplicaSet     5m48s  rollouts-controller  Scaled up ReplicaSet reviews-db897675d (revision 1) from 0 to 5
  Normal  RolloutCompleted      5m48s  rollouts-controller  Rollout completed update to revision 1 (db897675d): Initial deploy
  Normal  SwitchService         5m2s   rollouts-controller  Switched selector for service 'rollout-bluegreen-active' from '' to 'db897675d'
  Normal  RolloutUpdated        5m1s   rollouts-controller  Rollout updated to revision 2
  Normal  NewReplicaSetCreated  5m1s   rollouts-controller  Created ReplicaSet reviews-5895cfcd85 (revision 2)
  Normal  SwitchService         5m1s   rollouts-controller  Switched selector for service 'rollout-bluegreen-preview' from 'db897675d' to '5895cfcd85'
  Normal  ScalingReplicaSet     5m     rollouts-controller  Scaled up ReplicaSet reviews-5895cfcd85 (revision 2) from 0 to 5
  Normal  RolloutPaused         4m27s  rollouts-controller  Rollout is paused (BlueGreenPause)
  
  
  kubectl argo rollouts promote reviews -n istio

```

清理：

kubectl delete rollout reviews -n istio

kubectl delete svc  -n istio rollout-bluegreen-active

kubectl delete svc -n istio  rollout-bluegreen-preview



#### antiAffinity

##### preferredDuringSchedulingIgnoredDuringExecution

release/blueGreen/argo-rollout/bg-reviews-antiAffinity-preferredDuringSchedulingIgnoredDuringExecution.yaml

kubectl apply -f bg-reviews-antiAffinity-preferredDuringSchedulingIgnoredDuringExecution.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews
spec:
  replicas: 5
  selector:
    matchLabels:
      app: reviews
  template:
    metadata:
      labels:
        app: reviews
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    blueGreen: 
      activeService: rollout-bluegreen-active
      previewService: rollout-bluegreen-preview
      antiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution: 
          weight: 1
```

svc-rollout-bluegreen-active.yaml

kubectl apply -f svc-rollout-bluegreen-active.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: rollout-bluegreen-active
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
```

svc-rollout-bluegreen-preview.yaml

kubectl apply -f svc-rollout-bluegreen-preview.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: rollout-bluegreen-preview
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
```



```
kubectl argo rollouts set  image reviews reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews  -n istio
kubectl argo rollouts get rollout reviews --watch -n istio


Name:            reviews
Namespace:       istio
Status:          ◌ Progressing
Message:         active service cutover pending
Strategy:        BlueGreen
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 (stable, active)
                 docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (preview)
Replicas:
  Desired:       5
  Current:       10
  Updated:       5
  Ready:         5
  Available:     5

NAME                                 KIND        STATUS             AGE  INFO
⟳ reviews                            Rollout     ◌ Progressing      94s  
├──# revision:2                                                          
│  └──⧉ reviews-5895cfcd85           ReplicaSet  ◌ Progressing      38s  preview
│     ├──□ reviews-5895cfcd85-b84ng  Pod           PodInitializing  38s  ready:0/2
│     ├──□ reviews-5895cfcd85-qjh55  Pod           PodInitializing  38s  ready:0/2
│     ├──□ reviews-5895cfcd85-zgj2b  Pod           PodInitializing  38s  ready:0/2
│     ├──□ reviews-5895cfcd85-mm6jn  Pod           PodInitializing  37s  ready:0/2
│     └──□ reviews-5895cfcd85-rjtrb  Pod           PodInitializing  37s  ready:0/2
└──# revision:1                                                          
   └──⧉ reviews-db897675d            ReplicaSet  ✔ Healthy          94s  stable,active
      ├──□ reviews-db897675d-mrs94   Pod         ✔ Running          94s  ready:2/2
      ├──□ reviews-db897675d-2pcz4   Pod         ✔ Running          93s  ready:2/2
      ├──□ reviews-db897675d-dr5pv   Pod         ✔ Running          93s  ready:2/2
      ├──□ reviews-db897675d-rf5hk   Pod         ✔ Running          93s  ready:2/2
      └──□ reviews-db897675d-wtdgn   Pod         ✔ Running          93s  ready:2/2
      

Events:
  Type    Reason                Age    From                 Message
  ----    ------                ----   ----                 -------
  Normal  RolloutUpdated        3m54s  rollouts-controller  Rollout updated to revision 1
  Normal  NewReplicaSetCreated  3m54s  rollouts-controller  Created ReplicaSet reviews-db897675d (revision 1)
  Normal  SwitchService         3m54s  rollouts-controller  Switched selector for service 'rollout-bluegreen-preview' from '' to 'db897675d'
  Normal  ScalingReplicaSet     3m54s  rollouts-controller  Scaled up ReplicaSet reviews-db897675d (revision 1) from 0 to 5
  Normal  RolloutCompleted      3m54s  rollouts-controller  Rollout completed update to revision 1 (db897675d): Initial deploy
  Normal  SwitchService         3m9s   rollouts-controller  Switched selector for service 'rollout-bluegreen-active' from '' to 'db897675d'
  Normal  RolloutUpdated        2m58s  rollouts-controller  Rollout updated to revision 2
  Normal  NewReplicaSetCreated  2m58s  rollouts-controller  Created ReplicaSet reviews-5895cfcd85 (revision 2)
  Normal  SwitchService         2m58s  rollouts-controller  Switched selector for service 'rollout-bluegreen-preview' from 'db897675d' to '5895cfcd85'
  Normal  ScalingReplicaSet     2m58s  rollouts-controller  Scaled up ReplicaSet reviews-5895cfcd85 (revision 2) from 0 to 5
  Normal  SwitchService         49s    rollouts-controller  Switched selector for service 'rollout-bluegreen-active' from 'db897675d' to '5895cfcd85'
  Normal  RolloutCompleted      49s    rollouts-controller  Rollout completed update to revision 2 (5895cfcd85): Completed blue-green update
  Normal  ScalingReplicaSet     19s    rollouts-controller  Scaled down ReplicaSet reviews-db897675d (revision 1) from 5 to 0
```

清理：

kubectl delete rollout reviews -n istio

kubectl delete svc  -n istio rollout-bluegreen-active

kubectl delete svc -n istio  rollout-bluegreen-preview



##### requiredDuringSchedulingIgnoredDuringExecution

release/blueGreen/argo-rollout/bg-reviews-antiAffinity-requiredDuringSchedulingIgnoredDuringExecution.yaml

kubectl apply -f bg-reviews-antiAffinity-requiredDuringSchedulingIgnoredDuringExecution.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews
spec:
  replicas: 5
  selector:
    matchLabels:
      app: reviews
  template:
    metadata:
      labels:
        app: reviews
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    blueGreen: 
      activeService: rollout-bluegreen-active
      previewService: rollout-bluegreen-preview
      antiAffinity:
        requiredDuringSchedulingIgnoredDuringExecution: 
          weight: 1
```

svc-rollout-bluegreen-active.yaml

kubectl apply -f svc-rollout-bluegreen-active.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: rollout-bluegreen-active
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
```

svc-rollout-bluegreen-preview.yaml

kubectl apply -f svc-rollout-bluegreen-preview.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: rollout-bluegreen-preview
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
```



```
kubectl argo rollouts set  image reviews reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews  -n istio
kubectl argo rollouts get rollout reviews --watch -n istio

Name:            reviews
Namespace:       istio
Status:          ✔ Healthy
Strategy:        BlueGreen
Images:          docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (stable, active)
Replicas:
  Desired:       5
  Current:       5
  Updated:       5
  Ready:         5
  Available:     5

NAME                                 KIND        STATUS         AGE  INFO
⟳ reviews                            Rollout     ✔ Healthy      81s  
├──# revision:2                                                      
│  └──⧉ reviews-5895cfcd85           ReplicaSet  ✔ Healthy      35s  stable,active
│     ├──□ reviews-5895cfcd85-cmbss  Pod         ✔ Running      35s  ready:2/2
│     ├──□ reviews-5895cfcd85-jwsng  Pod         ✔ Running      34s  ready:2/2
│     ├──□ reviews-5895cfcd85-lwzxh  Pod         ✔ Running      34s  ready:2/2
│     ├──□ reviews-5895cfcd85-qjxws  Pod         ✔ Running      34s  ready:2/2
│     └──□ reviews-5895cfcd85-wrndb  Pod         ✔ Running      34s  ready:2/2
└──# revision:1                                                      
   └──⧉ reviews-db897675d            ReplicaSet  • ScaledDown   81s  
      ├──□ reviews-db897675d-cs2zr   Pod         ◌ Terminating  80s  ready:2/2
      ├──□ reviews-db897675d-mj6r8   Pod         ◌ Terminating  80s  ready:2/2
      ├──□ reviews-db897675d-ttnfj   Pod         ◌ Terminating  80s  ready:2/2
      ├──□ reviews-db897675d-ws4qb   Pod         ◌ Terminating  80s  ready:2/2
      └──□ reviews-db897675d-xh59c   Pod         ◌ Terminating  80s  ready:2/2
      
Events:
  Type    Reason                Age   From                 Message
  ----    ------                ----  ----                 -------
  Normal  RolloutUpdated        100s  rollouts-controller  Rollout updated to revision 1
  Normal  NewReplicaSetCreated  100s  rollouts-controller  Created ReplicaSet reviews-db897675d (revision 1)
  Normal  SwitchService         100s  rollouts-controller  Switched selector for service 'rollout-bluegreen-preview' from '' to 'db897675d'
  Normal  ScalingReplicaSet     100s  rollouts-controller  Scaled up ReplicaSet reviews-db897675d (revision 1) from 0 to 5
  Normal  RolloutCompleted      100s  rollouts-controller  Rollout completed update to revision 1 (db897675d): Initial deploy
  Normal  RolloutUpdated        54s   rollouts-controller  Rollout updated to revision 2
  Normal  NewReplicaSetCreated  54s   rollouts-controller  Created ReplicaSet reviews-5895cfcd85 (revision 2)
  Normal  SwitchService         54s   rollouts-controller  Switched selector for service 'rollout-bluegreen-preview' from 'db897675d' to '5895cfcd85'
  Normal  RolloutCompleted      54s   rollouts-controller  Rollout completed update to revision 2 (5895cfcd85): Initial deploy
  Normal  ScalingReplicaSet     53s   rollouts-controller  Scaled up ReplicaSet reviews-5895cfcd85 (revision 2) from 0 to 5
  Normal  SwitchService         43s   rollouts-controller  Switched selector for service 'rollout-bluegreen-active' from '' to '5895cfcd85'
  Normal  ScalingReplicaSet     23s   rollouts-controller  Scaled down ReplicaSet reviews-db897675d (revision 1) from 5 to 0

```

清理：

kubectl delete rollout reviews -n istio

kubectl delete svc  -n istio rollout-bluegreen-active

kubectl delete svc -n istio  rollout-bluegreen-preview



#### scaleDownDelayRevisionLimit

release/blueGreen/argo-rollout/bg-reviews-scaleDownDelayRevisionLimit.yaml

kubectl apply -f bg-reviews-scaleDownDelayRevisionLimit.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews
spec:
  replicas: 5
  selector:
    matchLabels:
      app: reviews
  template:
    metadata:
      labels:
        app: reviews
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    blueGreen: 
      activeService: rollout-bluegreen-active
      previewService: rollout-bluegreen-preview
      scaleDownDelayRevisionLimit: 1
```

svc-rollout-bluegreen-active.yaml

kubectl apply -f svc-rollout-bluegreen-active.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: rollout-bluegreen-active
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
```

svc-rollout-bluegreen-preview.yaml

kubectl apply -f svc-rollout-bluegreen-preview.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: rollout-bluegreen-preview
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
```



```
kubectl argo rollouts set  image reviews reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews  -n istio
kubectl argo rollouts get rollout reviews --watch -n istio

Name:            reviews
Namespace:       istio
Status:          ✔ Healthy
Strategy:        BlueGreen
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
                 docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (stable, active)
Replicas:
  Desired:       5
  Current:       10
  Updated:       5
  Ready:         5
  Available:     5

NAME                                 KIND        STATUS     AGE  INFO
⟳ reviews                            Rollout     ✔ Healthy  66s  
├──# revision:2                                                  
│  └──⧉ reviews-5895cfcd85           ReplicaSet  ✔ Healthy  21s  stable,active
│     ├──□ reviews-5895cfcd85-jsjl6  Pod         ✔ Running  20s  ready:2/2
│     ├──□ reviews-5895cfcd85-nvw4q  Pod         ✔ Running  20s  ready:2/2
│     ├──□ reviews-5895cfcd85-2t9rf  Pod         ✔ Running  19s  ready:2/2
│     ├──□ reviews-5895cfcd85-q99rl  Pod         ✔ Running  19s  ready:2/2
│     └──□ reviews-5895cfcd85-wvqvt  Pod         ✔ Running  19s  ready:2/2
└──# revision:1                                                  
   └──⧉ reviews-db897675d            ReplicaSet  ✔ Healthy  66s  delay:10s
      ├──□ reviews-db897675d-bn5kh   Pod         ✔ Running  66s  ready:2/2
      ├──□ reviews-db897675d-cjdtn   Pod         ✔ Running  66s  ready:2/2
      ├──□ reviews-db897675d-kwhf6   Pod         ✔ Running  66s  ready:2/2
      ├──□ reviews-db897675d-qrmcd   Pod         ✔ Running  66s  ready:2/2
      └──□ reviews-db897675d-t2wn8   Pod         ✔ Running  66s  ready:2/2

Events:
  Type    Reason                Age   From                 Message
  ----    ------                ----  ----                 -------
  Normal  RolloutUpdated        84s   rollouts-controller  Rollout updated to revision 1
  Normal  NewReplicaSetCreated  84s   rollouts-controller  Created ReplicaSet reviews-db897675d (revision 1)
  Normal  SwitchService         84s   rollouts-controller  Switched selector for service 'rollout-bluegreen-preview' from '' to 'db897675d'
  Normal  ScalingReplicaSet     84s   rollouts-controller  Scaled up ReplicaSet reviews-db897675d (revision 1) from 0 to 5
  Normal  RolloutCompleted      84s   rollouts-controller  Rollout completed update to revision 1 (db897675d): Initial deploy
  Normal  RolloutUpdated        38s   rollouts-controller  Rollout updated to revision 2
  Normal  NewReplicaSetCreated  38s   rollouts-controller  Created ReplicaSet reviews-5895cfcd85 (revision 2)
  Normal  SwitchService         38s   rollouts-controller  Switched selector for service 'rollout-bluegreen-preview' from 'db897675d' to '5895cfcd85'
  Normal  RolloutCompleted      38s   rollouts-controller  Rollout completed update to revision 2 (5895cfcd85): Initial deploy
  Normal  ScalingReplicaSet     37s   rollouts-controller  Scaled up ReplicaSet reviews-5895cfcd85 (revision 2) from 0 to 5
  Normal  SwitchService         27s   rollouts-controller  Switched selector for service 'rollout-bluegreen-active' from '' to '5895cfcd85'
  Normal  ScalingReplicaSet     7s    rollouts-controller  Scaled down ReplicaSet reviews-db897675d (revision 1) from 5 to 0
  
  
```

清理：

kubectl delete rollout reviews -n istio

kubectl delete svc  -n istio rollout-bluegreen-active

kubectl delete svc -n istio  rollout-bluegreen-preview



#### scaleDownDelaySeconds

release/blueGreen/argo-rollout/bg-reviews-scaleDownDelaySeconds.yaml

kubectl apply -f bg-reviews-scaleDownDelaySeconds.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews
spec:
  replicas: 5
  selector:
    matchLabels:
      app: reviews
  template:
    metadata:
      labels:
        app: reviews
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    blueGreen: 
      activeService: rollout-bluegreen-active
      previewService: rollout-bluegreen-preview
      scaleDownDelaySeconds: 60
```

svc-rollout-bluegreen-active.yaml

kubectl apply -f svc-rollout-bluegreen-active.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: rollout-bluegreen-active
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
```

svc-rollout-bluegreen-preview.yaml

kubectl apply -f svc-rollout-bluegreen-preview.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: rollout-bluegreen-preview
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
```



```
kubectl argo rollouts set  image reviews reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

kubectl describe rollout reviews  -n istio
kubectl argo rollouts get rollout reviews --watch -n istio

Name:            reviews
Namespace:       istio
Status:          ✔ Healthy
Strategy:        BlueGreen
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
                 docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (stable, active)
Replicas:
  Desired:       5
  Current:       10
  Updated:       5
  Ready:         5
  Available:     5

NAME                                 KIND        STATUS     AGE    INFO
⟳ reviews                            Rollout     ✔ Healthy  6m2s   
├──# revision:4                                                    
│  └──⧉ reviews-5895cfcd85           ReplicaSet  ✔ Healthy  5m17s  stable,active
│     ├──□ reviews-5895cfcd85-jlkp8  Pod         ✔ Running  14s    ready:2/2
│     ├──□ reviews-5895cfcd85-t7lk4  Pod         ✔ Running  14s    ready:2/2
│     ├──□ reviews-5895cfcd85-424cq  Pod         ✔ Running  13s    ready:2/2
│     ├──□ reviews-5895cfcd85-4qsf2  Pod         ✔ Running  13s    ready:2/2
│     └──□ reviews-5895cfcd85-8ht5l  Pod         ✔ Running  13s    ready:2/2
└──# revision:3                                                    
   └──⧉ reviews-db897675d            ReplicaSet  ✔ Healthy  6m2s   delay:55s
      ├──□ reviews-db897675d-8stbh   Pod         ✔ Running  4m20s  ready:2/2
      ├──□ reviews-db897675d-gvcfd   Pod         ✔ Running  4m20s  ready:2/2
      ├──□ reviews-db897675d-mhncc   Pod         ✔ Running  4m20s  ready:2/2
      ├──□ reviews-db897675d-mnfnp   Pod         ✔ Running  4m20s  ready:2/2
      └──□ reviews-db897675d-rpv8v   Pod         ✔ Running  4m20s  ready:2/2
      

Events:
  Type    Reason                Age                  From                 Message
  ----    ------                ----                 ----                 -------
  Normal  NewReplicaSetCreated  6m20s                rollouts-controller  Created ReplicaSet reviews-db897675d (revision 1)
  Normal  SwitchService         6m20s                rollouts-controller  Switched selector for service 'rollout-bluegreen-preview' from '' to 'db897675d'
  Normal  ScalingReplicaSet     6m20s                rollouts-controller  Scaled up ReplicaSet reviews-db897675d (revision 1) from 0 to 5
  Normal  RolloutCompleted      6m20s                rollouts-controller  Rollout completed update to revision 1 (db897675d): Initial deploy
  Normal  RolloutUpdated        6m20s                rollouts-controller  Rollout updated to revision 1
  Normal  NewReplicaSetCreated  5m34s                rollouts-controller  Created ReplicaSet reviews-5895cfcd85 (revision 2)
  Normal  RolloutUpdated        5m34s                rollouts-controller  Rollout updated to revision 2
  Normal  RolloutCompleted      5m34s                rollouts-controller  Rollout completed update to revision 2 (5895cfcd85): Initial deploy
  Normal  ScalingReplicaSet     5m33s                rollouts-controller  Scaled up ReplicaSet reviews-5895cfcd85 (revision 2) from 0 to 5
  Normal  SwitchService         5m23s                rollouts-controller  Switched selector for service 'rollout-bluegreen-active' from '' to '5895cfcd85'
  Normal  ScalingReplicaSet     5m3s                 rollouts-controller  Scaled down ReplicaSet reviews-db897675d (revision 1) from 5 to 0
  Normal  RolloutUpdated        4m39s                rollouts-controller  Rollout updated to revision 3
  Normal  SwitchService         4m39s                rollouts-controller  Switched selector for service 'rollout-bluegreen-preview' from '5895cfcd85' to 'db897675d'
  Normal  ScalingReplicaSet     4m38s                rollouts-controller  Scaled up ReplicaSet reviews-db897675d (revision 3) from 0 to 5
  Normal  SwitchService         3m39s                rollouts-controller  Switched selector for service 'rollout-bluegreen-active' from '5895cfcd85' to 'db897675d'
  Normal  RolloutCompleted      3m39s                rollouts-controller  Rollout completed update to revision 3 (db897675d): Completed blue-green update
  Normal  ScalingReplicaSet     3m8s                 rollouts-controller  Scaled down ReplicaSet reviews-5895cfcd85 (revision 2) from 5 to 0
  Normal  SwitchService         32s (x2 over 5m34s)  rollouts-controller  Switched selector for service 'rollout-bluegreen-preview' from 'db897675d' to '5895cfcd85'
  Normal  RolloutUpdated        32s                  rollouts-controller  Rollout updated to revision 4
  Normal  ScalingReplicaSet     32s                  rollouts-controller  Scaled up ReplicaSet reviews-5895cfcd85 (revision 4) from 0 to 5
  Normal  SwitchService         22s                  rollouts-controller  Switched selector for service 'rollout-bluegreen-active' from 'db897675d' to '5895cfcd85'
  Normal  RolloutCompleted      22s                  rollouts-controller  Rollout completed update to revision 4 (5895cfcd85): Completed blue-green update
```

清理：

kubectl delete rollout reviews -n istio

kubectl delete svc  -n istio rollout-bluegreen-active

kubectl delete svc -n istio  rollout-bluegreen-preview



#### prePromotionAnalysis

release/blueGreen/argo-rollout/bg-reviews-prePromotionAnalysis.yaml

kubectl apply -f bg-reviews-prePromotionAnalysis.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews
spec:
  replicas: 5
  selector:
    matchLabels:
      app: reviews
  template:
    metadata:
      labels:
        app: reviews
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    blueGreen: 
      activeService: rollout-bluegreen-active
      previewService: rollout-bluegreen-preview
      prePromotionAnalysis:
        templates:
        - templateName: success-rate
          clusterScope: false
        args:
        - name: service-name
          value: rollout-bluegreen-preview.istio.svc.cluster.local
```

argo-AnalysisTemplate-reviews.yaml

kubectl apply -f argo-AnalysisTemplate-reviews.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: success-rate
spec:
  args:
  - name: service-name
  metrics:
  - name: success-rate
    interval: 60s
    count: 5
    successCondition: result[0] >= 0.50
    failureLimit: 3
    provider:
      prometheus:
        address: http://prometheus.istio-system:9090
        query: |
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}",response_code!~"5.*"}[5m]
          )) / 
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}"}[5m]
          ))
```

vs-reviews-preview-nopost.yaml

kubectl apply -f vs-reviews-preview-nopost.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: rollout-bluegreen-preview
spec:
  gateways:
  - bookinfo-gateway
  hosts:
  - "*"
  http:
  - route:
    - destination:
        host: rollout-bluegreen-preview
        port:
          number: 9080
```



svc-rollout-bluegreen-active.yaml

kubectl apply -f svc-rollout-bluegreen-active.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: rollout-bluegreen-active
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
```

svc-rollout-bluegreen-preview.yaml

kubectl apply -f svc-rollout-bluegreen-preview.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: rollout-bluegreen-preview
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
```



```
kubectl argo rollouts set  image reviews reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

go-stress-testing -c 10 -n 1000000 -u http://192.168.229.134:30468/reviews/0

kubectl describe rollout reviews  -n istio
kubectl argo rollouts get rollout reviews --watch -n istio

Name:            reviews
Namespace:       istio
Status:          ✔ Healthy
Strategy:        BlueGreen
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 (stable, active)
                 docker.io/istio/examples-bookinfo-reviews-v2:1.16.2
Replicas:
  Desired:       5
  Current:       10
  Updated:       5
  Ready:         5
  Available:     5

NAME                                 KIND         STATUS        AGE    INFO
⟳ reviews                            Rollout      ✔ Healthy     32m    
├──# revision:7                                                        
│  ├──⧉ reviews-db897675d            ReplicaSet   ✔ Healthy     32m    stable,active
│  │  ├──□ reviews-db897675d-mzqjc   Pod          ✔ Running     5m33s  ready:2/2
│  │  ├──□ reviews-db897675d-k9gsl   Pod          ✔ Running     5m32s  ready:2/2
│  │  ├──□ reviews-db897675d-twtt6   Pod          ✔ Running     5m32s  ready:2/2
│  │  ├──□ reviews-db897675d-txglh   Pod          ✔ Running     5m32s  ready:2/2
│  │  └──□ reviews-db897675d-vt4xp   Pod          ✔ Running     5m32s  ready:2/2
│  └──α reviews-db897675d-7-pre      AnalysisRun  ✔ Successful  3m40s  ✖ 2,⚠ 1
├──# revision:6                                                        
│  └──⧉ reviews-5895cfcd85           ReplicaSet   ✔ Healthy     32m    delay:13s
│     ├──□ reviews-5895cfcd85-jlkp8  Pod          ✔ Running     27m    ready:2/2
│     ├──□ reviews-5895cfcd85-t7lk4  Pod          ✔ Running     27m    ready:2/2
│     ├──□ reviews-5895cfcd85-424cq  Pod          ✔ Running     27m    ready:2/2
│     ├──□ reviews-5895cfcd85-4qsf2  Pod          ✔ Running     27m    ready:2/2
│     └──□ reviews-5895cfcd85-8ht5l  Pod          ✔ Running     27m    ready:2/2
└──# revision:5                                                        
   └──α reviews-db897675d-5-pre      AnalysisRun  ⚠ Error       8m30s  ⚠ 5
   
   
Events:
  Type     Reason                 Age                  From                 Message
  ----     ------                 ----                 ----                 -------
  Normal   NewReplicaSetCreated   33m                  rollouts-controller  Created ReplicaSet reviews-db897675d (revision 1)
  Normal   SwitchService          33m                  rollouts-controller  Switched selector for service 'rollout-bluegreen-preview' from '' to 'db897675d'
  Normal   ScalingReplicaSet      33m                  rollouts-controller  Scaled up ReplicaSet reviews-db897675d (revision 1) from 0 to 5
  Normal   RolloutCompleted       33m                  rollouts-controller  Rollout completed update to revision 1 (db897675d): Initial deploy
  Normal   RolloutUpdated         33m                  rollouts-controller  Rollout updated to revision 1
  Normal   NewReplicaSetCreated   32m                  rollouts-controller  Created ReplicaSet reviews-5895cfcd85 (revision 2)
  Normal   RolloutUpdated         32m                  rollouts-controller  Rollout updated to revision 2
  Normal   RolloutCompleted       32m                  rollouts-controller  Rollout completed update to revision 2 (5895cfcd85): Initial deploy
  Normal   ScalingReplicaSet      32m                  rollouts-controller  Scaled up ReplicaSet reviews-5895cfcd85 (revision 2) from 0 to 5
  Normal   SwitchService          32m                  rollouts-controller  Switched selector for service 'rollout-bluegreen-active' from '' to '5895cfcd85'
  Normal   ScalingReplicaSet      32m                  rollouts-controller  Scaled down ReplicaSet reviews-db897675d (revision 1) from 5 to 0
  Normal   RolloutUpdated         31m                  rollouts-controller  Rollout updated to revision 3
  Normal   ScalingReplicaSet      31m                  rollouts-controller  Scaled up ReplicaSet reviews-db897675d (revision 3) from 0 to 5
  Normal   SwitchService          30m                  rollouts-controller  Switched selector for service 'rollout-bluegreen-active' from '5895cfcd85' to 'db897675d'
  Normal   RolloutCompleted       30m                  rollouts-controller  Rollout completed update to revision 3 (db897675d): Completed blue-green update
  Normal   ScalingReplicaSet      30m                  rollouts-controller  Scaled down ReplicaSet reviews-5895cfcd85 (revision 2) from 5 to 0
  Normal   SwitchService          27m (x2 over 32m)    rollouts-controller  Switched selector for service 'rollout-bluegreen-preview' from 'db897675d' to '5895cfcd85'
  Normal   RolloutUpdated         27m                  rollouts-controller  Rollout updated to revision 4
  Normal   ScalingReplicaSet      27m                  rollouts-controller  Scaled up ReplicaSet reviews-5895cfcd85 (revision 4) from 0 to 5
  Normal   RolloutCompleted       27m                  rollouts-controller  Rollout completed update to revision 4 (5895cfcd85): Completed blue-green update
  Normal   SwitchService          27m                  rollouts-controller  Switched selector for service 'rollout-bluegreen-active' from 'db897675d' to '5895cfcd85'
  Normal   ScalingReplicaSet      26m                  rollouts-controller  Scaled down ReplicaSet reviews-db897675d (revision 3) from 5 to 0
  Normal   ScalingReplicaSet      9m25s                rollouts-controller  Scaled up ReplicaSet reviews-db897675d (revision 5) from 0 to 5
  Normal   RolloutUpdated         9m25s                rollouts-controller  Rollout updated to revision 5
  Normal   SwitchService          9m25s (x2 over 31m)  rollouts-controller  Switched selector for service 'rollout-bluegreen-preview' from '5895cfcd85' to 'db897675d'
  Normal   AnalysisRunRunning     8m24s                rollouts-controller  PrePromotion Analysis Run 'reviews-db897675d-5-pre' Status New: 'Running' Previous: ''
  Warning  AnalysisRunError       7m44s                rollouts-controller  PrePromotion Analysis Run 'reviews-db897675d-5-pre' Status New: 'Error' Previous: 'Running'
  Warning  RolloutAborted         7m44s                rollouts-controller  Rollout aborted update to revision 5: Metric "success-rate" assessed Error due to consecutiveErrors (5) > consecutiveErrorLimit (4): "Error Message: reflect: slice index out of range"
  Normal   AnalysisRunRunning     4m3s                 rollouts-controller  PrePromotion Analysis Run 'reviews-db897675d-7-pre' Status New: 'Running' Previous: ''
  Normal   AnalysisRunSuccessful  72s                  rollouts-controller  PrePromotion Analysis Run 'reviews-db897675d-7-pre' Status New: 'Successful' Previous: 'Running'
  Normal   SwitchService          42s                  rollouts-controller  Switched selector for service 'rollout-bluegreen-active' from '5895cfcd85' to 'db897675d'
  Normal   RolloutCompleted       42s                  rollouts-controller  Rollout completed update to revision 7 (db897675d): Completed blue-green update
  Normal   ScalingReplicaSet      9s                   rollouts-controller  Scaled down ReplicaSet reviews-5895cfcd85 (revision 6) from 5 to 0
```

清理：

kubectl delete rollout reviews -n istio

kubectl delete svc  -n istio rollout-bluegreen-active

kubectl delete svc -n istio  rollout-bluegreen-preview

kubectl delete AnalysisTemplate success-rate -n istio

kubectl delete vs rollout-bluegreen-preview -n istio



#### postPromotionAnalysis

release/blueGreen/argo-rollout/bg-reviews-postPromotionAnalysis.yaml

kubectl apply -f bg-reviews-postPromotionAnalysis.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews
spec:
  replicas: 5
  selector:
    matchLabels:
      app: reviews
  template:
    metadata:
      labels:
        app: reviews
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    blueGreen: 
      activeService: rollout-bluegreen-active
      previewService: rollout-bluegreen-preview
      prePromotionAnalysis:
        templates:
        - templateName: success-rate
          clusterScope: false
        args:
        - name: service-name
          value: rollout-bluegreen-preview.istio.svc.cluster.local
      postPromotionAnalysis:
        templates:
        - templateName: success-rate
          clusterScope: false
        args:
        - name: service-name
          value: rollout-bluegreen-active.istio.svc.cluster.local      
```

argo-AnalysisTemplate-reviews.yaml

kubectl apply -f argo-AnalysisTemplate-reviews.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: success-rate
spec:
  args:
  - name: service-name
  metrics:
  - name: success-rate
    interval: 60s
    count: 5
    successCondition: result[0] >= 0.50
    failureLimit: 3
    provider:
      prometheus:
        address: http://prometheus.istio-system:9090
        query: |
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}",response_code!~"5.*"}[5m]
          )) / 
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}"}[5m]
          ))
```

vs-reviews-preview.yaml

kubectl apply -f vs-reviews-preview.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: rollout-bluegreen-preview
spec:
  gateways:
  - bookinfo-gateway
  hosts:
  - "*"
  http:
  - match:
    - queryParams:
        test:
          exact: test
    route:
    - destination:
        host: rollout-bluegreen-preview
        port:
          number: 9080
  - route:
    - destination:
        host: rollout-bluegreen-active
        port:
          number: 9080
```



svc-rollout-bluegreen-active.yaml

kubectl apply -f svc-rollout-bluegreen-active.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: rollout-bluegreen-active
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
```

svc-rollout-bluegreen-preview.yaml

kubectl apply -f svc-rollout-bluegreen-preview.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: rollout-bluegreen-preview
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
```



```
kubectl argo rollouts set  image reviews reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

go-stress-testing -c 10 -n 1000000 -u http://192.168.229.134:30468/reviews/0?test=test
go-stress-testing -c 10 -n 1000000 -u http://192.168.229.134:30468/reviews/0

kubectl describe rollout reviews  -n istio
kubectl argo rollouts get rollout reviews --watch -n istio

Name:            reviews
Namespace:       istio
Status:          ◌ Progressing
Message:         active service cutover pending
Strategy:        BlueGreen
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 (preview)
                 docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (stable, active)
Replicas:
  Desired:       5
  Current:       10
  Updated:       5
  Ready:         5
  Available:     5

NAME                                 KIND         STATUS         AGE    INFO
⟳ reviews                            Rollout      ◌ Progressing  3m4s   
├──# revision:3                                                         
│  ├──⧉ reviews-db897675d            ReplicaSet   ✔ Healthy      3m4s   preview
│  │  ├──□ reviews-db897675d-7nbss   Pod          ✔ Running      96s    ready:2/2
│  │  ├──□ reviews-db897675d-dg6js   Pod          ✔ Running      96s    ready:2/2
│  │  ├──□ reviews-db897675d-ww5mt   Pod          ✔ Running      96s    ready:2/2
│  │  ├──□ reviews-db897675d-rlwsb   Pod          ✔ Running      95s    ready:2/2
│  │  └──□ reviews-db897675d-sggnw   Pod          ✔ Running      95s    ready:2/2
│  └──α reviews-db897675d-3-pre      AnalysisRun  ◌ Running      37s    ✖ 1
└──# revision:2                                                         
   └──⧉ reviews-5895cfcd85           ReplicaSet   ✔ Healthy      2m17s  stable,active
      ├──□ reviews-5895cfcd85-8d42s  Pod          ✔ Running      2m16s  ready:2/2
      ├──□ reviews-5895cfcd85-b7dkl  Pod          ✔ Running      2m16s  ready:2/2
      ├──□ reviews-5895cfcd85-hx6pt  Pod          ✔ Running      2m16s  ready:2/2
      ├──□ reviews-5895cfcd85-q6wdn  Pod          ✔ Running      2m16s  ready:2/2
      └──□ reviews-5895cfcd85-sj7qx  Pod          ✔ Running      2m16s  ready:2/2
      
Name:            reviews
Namespace:       istio
Status:          ◌ Progressing
Message:         waiting for analysis to complete
Strategy:        BlueGreen
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 (active)
                 docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (stable)
Replicas:
  Desired:       5
  Current:       10
  Updated:       5
  Ready:         5
  Available:     5

NAME                                 KIND         STATUS         AGE    INFO
⟳ reviews                            Rollout      ◌ Progressing  8m8s   
├──# revision:3                                                         
│  ├──⧉ reviews-db897675d            ReplicaSet   ✔ Healthy      8m8s   active
│  │  ├──□ reviews-db897675d-7nbss   Pod          ✔ Running      6m40s  ready:2/2
│  │  ├──□ reviews-db897675d-dg6js   Pod          ✔ Running      6m40s  ready:2/2
│  │  ├──□ reviews-db897675d-ww5mt   Pod          ✔ Running      6m40s  ready:2/2
│  │  ├──□ reviews-db897675d-rlwsb   Pod          ✔ Running      6m39s  ready:2/2
│  │  └──□ reviews-db897675d-sggnw   Pod          ✔ Running      6m39s  ready:2/2
│  ├──α reviews-db897675d-3-pre      AnalysisRun  ✔ Successful   5m41s  ✔ 4,✖ 1,⚠ 2
│  └──α reviews-db897675d-3-post     AnalysisRun  ◌ Running      12s    ⚠ 2
└──# revision:2                                                         
   └──⧉ reviews-5895cfcd85           ReplicaSet   ✔ Healthy      7m21s  stable
      ├──□ reviews-5895cfcd85-8d42s  Pod          ✔ Running      7m20s  ready:2/2
      ├──□ reviews-5895cfcd85-b7dkl  Pod          ✔ Running      7m20s  ready:2/2
      ├──□ reviews-5895cfcd85-hx6pt  Pod          ✔ Running      7m20s  ready:2/2
      ├──□ reviews-5895cfcd85-q6wdn  Pod          ✔ Running      7m20s  ready:2/2
      └──□ reviews-5895cfcd85-sj7qx  Pod          ✔ Running      7m20s  ready:2/2
      
Events:
  Type     Reason                 Age    From                 Message
  ----     ------                 ----   ----                 -------
  Normal   RolloutUpdated         10m    rollouts-controller  Rollout updated to revision 1
  Normal   NewReplicaSetCreated   10m    rollouts-controller  Created ReplicaSet reviews-db897675d (revision 1)
  Normal   SwitchService          10m    rollouts-controller  Switched selector for service 'rollout-bluegreen-preview' from '' to 'db897675d'
  Normal   ScalingReplicaSet      10m    rollouts-controller  Scaled up ReplicaSet reviews-db897675d (revision 1) from 0 to 5
  Normal   RolloutCompleted       10m    rollouts-controller  Rollout completed update to revision 1 (db897675d): Initial deploy
  Normal   RolloutUpdated         9m16s  rollouts-controller  Rollout updated to revision 2
  Normal   NewReplicaSetCreated   9m16s  rollouts-controller  Created ReplicaSet reviews-5895cfcd85 (revision 2)
  Normal   SwitchService          9m16s  rollouts-controller  Switched selector for service 'rollout-bluegreen-preview' from 'db897675d' to '5895cfcd85'
  Normal   RolloutCompleted       9m16s  rollouts-controller  Rollout completed update to revision 2 (5895cfcd85): Initial deploy
  Normal   ScalingReplicaSet      9m15s  rollouts-controller  Scaled up ReplicaSet reviews-5895cfcd85 (revision 2) from 0 to 5
  Normal   SwitchService          9m6s   rollouts-controller  Switched selector for service 'rollout-bluegreen-active' from '' to '5895cfcd85'
  Normal   ScalingReplicaSet      8m45s  rollouts-controller  Scaled down ReplicaSet reviews-db897675d (revision 1) from 5 to 0
  Normal   RolloutUpdated         8m35s  rollouts-controller  Rollout updated to revision 3
  Normal   SwitchService          8m35s  rollouts-controller  Switched selector for service 'rollout-bluegreen-preview' from '5895cfcd85' to 'db897675d'
  Normal   ScalingReplicaSet      8m35s  rollouts-controller  Scaled up ReplicaSet reviews-db897675d (revision 3) from 0 to 5
  Normal   AnalysisRunRunning     7m36s  rollouts-controller  PrePromotion Analysis Run 'reviews-db897675d-3-pre' Status New: 'Running' Previous: ''
  Normal   SwitchService          2m7s   rollouts-controller  Switched selector for service 'rollout-bluegreen-active' from '5895cfcd85' to 'db897675d'
  Normal   AnalysisRunSuccessful  2m7s   rollouts-controller  PrePromotion Analysis Run 'reviews-db897675d-3-pre' Status New: 'Successful' Previous: 'Running'
  Normal   AnalysisRunRunning     2m6s   rollouts-controller  PostPromotion Analysis Run 'reviews-db897675d-3-post' Status New: 'Running' Previous: ''
  Warning  AnalysisRunError       87s    rollouts-controller  PostPromotion Analysis Run 'reviews-db897675d-3-post' Status New: 'Error' Previous: 'Running'
  Warning  RolloutAborted         87s    rollouts-controller  Rollout aborted update to revision 3: Metric "success-rate" assessed Error due to consecutiveErrors (5) > consecutiveErrorLimit (4): "Error Message: reflect: slice index out of range"
  Normal   SwitchService          87s    rollouts-controller  Switched selector for service 'rollout-bluegreen-active' from 'db897675d' to '5895cfcd85'
  Normal   ScalingReplicaSet      57s    rollouts-controller  Scaled down ReplicaSet reviews-db897675d (revision 3) from 5 to 0
```

清理：

kubectl delete rollout reviews -n istio

kubectl delete svc  -n istio rollout-bluegreen-active

kubectl delete svc -n istio  rollout-bluegreen-preview

kubectl delete AnalysisTemplate success-rate -n istio

kubectl delete vs rollout-bluegreen-preview -n istio



#### HPA 

istio-HPA.yaml

kubectl apply -f istio-HPA.yaml -n istio

```
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: hpa-rollout
spec:
  maxReplicas: 5
  minReplicas: 1
  scaleTargetRef:
    apiVersion: argoproj.io/v1alpha1
    kind: Rollout
    name: reviews
  targetCPUUtilizationPercentage: 10
```

release/blueGreen/argo-rollout/bg-reviews-HPA.yaml

kubectl apply -f bg-reviews-HPA.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: reviews
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
  template:
    metadata:
      labels:
        app: reviews
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        resources:
          requests:
            cpu: 0.02
            memory: 10Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
        securityContext:
          runAsUser: 1000
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
  strategy:
    blueGreen: 
      activeService: rollout-bluegreen-active
      previewService: rollout-bluegreen-preview
      prePromotionAnalysis:
        templates:
        - templateName: success-rate
          clusterScope: false
        args:
        - name: service-name
          value: rollout-bluegreen-preview.istio.svc.cluster.local
      postPromotionAnalysis:
        templates:
        - templateName: success-rate
          clusterScope: false
        args:
        - name: service-name
          value: rollout-bluegreen-active.istio.svc.cluster.local      
```

argo-AnalysisTemplate-reviews.yaml

kubectl apply -f argo-AnalysisTemplate-reviews.yaml -n istio

```
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: success-rate
spec:
  args:
  - name: service-name
  metrics:
  - name: success-rate
    interval: 60s
    count: 5
    successCondition: result[0] >= 0.50
    failureLimit: 3
    provider:
      prometheus:
        address: http://prometheus.istio-system:9090
        query: |
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}",response_code!~"5.*"}[5m]
          )) / 
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}"}[5m]
          ))
```

vs-reviews-preview.yaml

kubectl apply -f vs-reviews-preview.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: rollout-bluegreen-preview
spec:
  gateways:
  - bookinfo-gateway
  hosts:
  - "*"
  http:
  - match:
    - queryParams:
        test:
          exact: test
    route:
    - destination:
        host: rollout-bluegreen-preview
        port:
          number: 9080
  - route:
    - destination:
        host: rollout-bluegreen-active
        port:
          number: 9080
```



svc-rollout-bluegreen-active.yaml

kubectl apply -f svc-rollout-bluegreen-active.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: rollout-bluegreen-active
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
```

svc-rollout-bluegreen-preview.yaml

kubectl apply -f svc-rollout-bluegreen-preview.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: rollout-bluegreen-preview
spec:
  ports:
  - name: http
    port: 9080
    protocol: TCP
    targetPort: 9080
  selector:
    app: reviews
```



```
kubectl argo rollouts set  image reviews reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 -n istio

go-stress-testing -c 10 -n 1000000 -u http://192.168.229.134:30468/reviews/0?test=test

go-stress-testing -c 10 -n 1000000 -u http://192.168.229.134:30468/reviews/0

kubectl describe rollout reviews  -n istio
kubectl argo rollouts get rollout reviews --watch -n istio

Name:            reviews
Namespace:       istio
Status:          ◌ Progressing
Message:         updated replicas are still becoming available
Strategy:        BlueGreen
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 (stable, active)
                 docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (preview)
Replicas:
  Desired:       2
  Current:       4
  Updated:       2
  Ready:         1
  Available:     1

NAME                                 KIND         STATUS         AGE    INFO
⟳ reviews                            Rollout      ◌ Progressing  4m16s  
├──# revision:2                                                         
│  ├──⧉ reviews-5895cfcd85           ReplicaSet   ✔ Healthy      3m     preview
│  │  ├──□ reviews-5895cfcd85-9k62f  Pod          ✔ Running      3m     ready:2/2
│  │  └──□ reviews-5895cfcd85-hmcln  Pod          ✔ Running      9s     ready:2/2
│  └──α reviews-5895cfcd85-2-pre     AnalysisRun  ✔ Successful   2m54s  ✔ 2,✖ 1
└──# revision:1                                                         
   └──⧉ reviews-db897675d            ReplicaSet   ✔ Healthy      4m16s  stable,active
      ├──□ reviews-db897675d-sl8r9   Pod          ✔ Running      4m16s  ready:2/2
      └──□ reviews-db897675d-8qclp   Pod          ✔ Running      9s     ready:2/2
      
Name:            reviews
Namespace:       istio
Status:          ◌ Progressing
Message:         updated replicas are still becoming available
Strategy:        BlueGreen
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 (stable, active)
                 docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (preview)
Replicas:
  Desired:       5
  Current:       10
  Updated:       5
  Ready:         3
  Available:     3

NAME                                 KIND         STATUS         AGE    INFO
⟳ reviews                            Rollout      ◌ Progressing  8m17s  
├──# revision:2                                                         
│  ├──⧉ reviews-5895cfcd85           ReplicaSet   ✔ Healthy      7m1s   preview
│  │  ├──□ reviews-5895cfcd85-9k62f  Pod          ✔ Running      7m1s   ready:2/2
│  │  ├──□ reviews-5895cfcd85-hmcln  Pod          ✔ Running      4m10s  ready:2/2
│  │  ├──□ reviews-5895cfcd85-84rfc  Pod          ✔ Running      106s   ready:2/2
│  │  ├──□ reviews-5895cfcd85-5hkzx  Pod          ✔ Running      39s    ready:2/2
│  │  └──□ reviews-5895cfcd85-jpf6w  Pod          ✔ Running      39s    ready:2/2
│  ├──α reviews-5895cfcd85-2-pre     AnalysisRun  ✔ Successful   6m55s  ✔ 2,✖ 1
│  └──α reviews-5895cfcd85-2-pre.1   AnalysisRun  ✔ Successful   3m33s  ✔ 2,⚠ 1
└──# revision:1                                                         
   └──⧉ reviews-db897675d            ReplicaSet   ✔ Healthy      8m17s  stable,active
      ├──□ reviews-db897675d-sl8r9   Pod          ✔ Running      8m17s  ready:2/2
      ├──□ reviews-db897675d-8qclp   Pod          ✔ Running      4m10s  ready:2/2
      ├──□ reviews-db897675d-jnwh8   Pod          ✔ Running      108s   ready:2/2
      ├──□ reviews-db897675d-vgbxk   Pod          ✔ Running      40s    ready:2/2
      └──□ reviews-db897675d-l6m86   Pod          ✔ Running      39s    ready:2/2
      
Name:            reviews
Namespace:       istio
Status:          ◌ Progressing
Message:         waiting for analysis to complete
Strategy:        BlueGreen
Images:          docker.io/istio/examples-bookinfo-reviews-v1:1.16.2 (stable)
                 docker.io/istio/examples-bookinfo-reviews-v2:1.16.2 (active)
Replicas:
  Desired:       5
  Current:       10
  Updated:       5
  Ready:         5
  Available:     5

NAME                                 KIND         STATUS         AGE    INFO
⟳ reviews                            Rollout      ◌ Progressing  7m9s   
├──# revision:2                                                         
│  ├──⧉ reviews-5895cfcd85           ReplicaSet   ✔ Healthy      6m56s  active
│  │  ├──□ reviews-5895cfcd85-ss6wz  Pod          ✔ Running      6m55s  ready:2/2
│  │  ├──□ reviews-5895cfcd85-8gmr7  Pod          ✔ Running      6m54s  ready:2/2
│  │  ├──□ reviews-5895cfcd85-9jjjh  Pod          ✔ Running      6m54s  ready:2/2
│  │  ├──□ reviews-5895cfcd85-9pjgx  Pod          ✔ Running      6m54s  ready:2/2
│  │  └──□ reviews-5895cfcd85-ws2zd  Pod          ✔ Running      5m28s  ready:2/2
│  ├──α reviews-5895cfcd85-2-pre     AnalysisRun  ✔ Successful   6m20s  ✖ 1
│  ├──α reviews-5895cfcd85-2-pre.1   AnalysisRun  ✔ Successful   5m12s  ✔ 5
│  └──α reviews-5895cfcd85-2-post    AnalysisRun  ◌ Running      68s    ✔ 2
└──# revision:1                                                         
   └──⧉ reviews-db897675d            ReplicaSet   ✔ Healthy      7m9s   stable
      ├──□ reviews-db897675d-vtb9x   Pod          ✔ Running      7m9s   ready:2/2
      ├──□ reviews-db897675d-hkhwv   Pod          ✔ Running      6m56s  ready:2/2
      ├──□ reviews-db897675d-ltzzz   Pod          ✔ Running      6m56s  ready:2/2
      ├──□ reviews-db897675d-m5zvj   Pod          ✔ Running      6m56s  ready:2/2
      └──□ reviews-db897675d-lwcnw   Pod          ✔ Running      5m28s  ready:2/2

Events:
  Type    Reason                 Age    From                 Message
  ----    ------                 ----   ----                 -------
  Normal  RolloutUpdated         10m    rollouts-controller  Rollout updated to revision 1
  Normal  NewReplicaSetCreated   10m    rollouts-controller  Created ReplicaSet reviews-db897675d (revision 1)
  Normal  SwitchService          10m    rollouts-controller  Switched selector for service 'rollout-bluegreen-preview' from '' to 'db897675d'
  Normal  ScalingReplicaSet      10m    rollouts-controller  Scaled up ReplicaSet reviews-db897675d (revision 1) from 0 to 1
  Normal  RolloutCompleted       10m    rollouts-controller  Rollout completed update to revision 1 (db897675d): Initial deploy
  Normal  SwitchService          10m    rollouts-controller  Switched selector for service 'rollout-bluegreen-active' from '' to 'db897675d'
  Normal  ScalingReplicaSet      10m    rollouts-controller  Scaled up ReplicaSet reviews-db897675d (revision 1) from 1 to 4
  Normal  RolloutUpdated         10m    rollouts-controller  Rollout updated to revision 2
  Normal  NewReplicaSetCreated   10m    rollouts-controller  Created ReplicaSet reviews-5895cfcd85 (revision 2)
  Normal  SwitchService          10m    rollouts-controller  Switched selector for service 'rollout-bluegreen-preview' from 'db897675d' to '5895cfcd85'
  Normal  ScalingReplicaSet      10m    rollouts-controller  Scaled up ReplicaSet reviews-5895cfcd85 (revision 2) from 0 to 4
  Normal  AnalysisRunRunning     10m    rollouts-controller  PrePromotion Analysis Run 'reviews-5895cfcd85-2-pre' Status New: 'Running' Previous: ''
  Normal  ScalingReplicaSet      9m10s  rollouts-controller  Scaled up ReplicaSet reviews-db897675d (revision 1) from 4 to 5
  Normal  ScalingReplicaSet      9m10s  rollouts-controller  Scaled up ReplicaSet reviews-5895cfcd85 (revision 2) from 4 to 5
  Normal  AnalysisRunRunning     8m53s  rollouts-controller  PrePromotion Analysis Run 'reviews-5895cfcd85-2-pre.1' Status New: 'Running' Previous: ''
  Normal  SwitchService          4m50s  rollouts-controller  Switched selector for service 'rollout-bluegreen-active' from 'db897675d' to '5895cfcd85'
  Normal  AnalysisRunSuccessful  4m50s  rollouts-controller  PrePromotion Analysis Run 'reviews-5895cfcd85-2-pre.1' Status New: 'Successful' Previous: 'Running'
  Normal  AnalysisRunRunning     4m49s  rollouts-controller  PostPromotion Analysis Run 'reviews-5895cfcd85-2-post' Status New: 'Running' Previous: ''
  Normal  AnalysisRunSuccessful  49s    rollouts-controller  PostPromotion Analysis Run 'reviews-5895cfcd85-2-post' Status New: 'Successful' Previous: 'Running'
  Normal  RolloutCompleted       49s    rollouts-controller  Rollout completed update to revision 2 (5895cfcd85): Completed blue-green update
  Normal  ScalingReplicaSet      19s    rollouts-controller  Scaled down ReplicaSet reviews-db897675d (revision 1) from 5 to 0
```

清理：

kubectl delete rollout reviews -n istio

kubectl delete svc  -n istio rollout-bluegreen-active

kubectl delete svc -n istio  rollout-bluegreen-preview

kubectl delete AnalysisTemplate success-rate -n istio

kubectl delete vs rollout-bluegreen-preview -n istio

kubectl delete hpa hpa-rollout -n istio



# A/B test

## 什么是A/B test

AB Test 实验一般有 2 个目的：

1. 判断哪个更好：例如，有 2 个 UI 设计，究竟是 A 更好一些，还是 B 更好一些，我们需要实验判定
2. 计算收益：例如，最近新上线了一个直播功能，那么直播功能究竟给平台带了来多少额外的 DAU，多少额外的使用时长，多少直播以外的视频观看时长等

我们一般比较熟知的是上述第 1 个目的，对于第 2 个目的，**对于收益的量化，计算 ROI，往往对数据分析师和管理者非常重要**。

对于一般的 ABTest 实验，其实本质上就是把平台的流量均匀分为几个组，每个组添加不同的策略，然后根据这几个组的用户数据指标，例如：留存、人均观看时长、基础互动率等等核心指标，最终选择一个最好的组上线。

实验的几个基本步骤一般如下：

![1630278084(1)](images\1630278084(1).jpg)

**流量分配**

实验设计时有两个目标：

- 希望尽快得到实验结论，尽快决策
- 希望收益最大化，用户体验影响最小

因此经常需要在流量分配时有所权衡，一般有以下几个情况：

- 不影响用户体验：如 UI 实验、文案类实验等，一般可以均匀分配流量实验，可以快速得到实验结论
- 不确定性较强的实验：如产品新功能上线，一般需小流量实验，尽量减小用户体验影响，在允许的时间内得到结论
- 希望收益最大化的实验：如运营活动等，尽可能将效果最大化，一般需要大流量实验，留出小部分对照组用于评估 ROI

![111](images\111.jpg)

根据实验的预期结果，大盘用户量，确定实验所需最小流量，可以通过一个**网站**专门计算所需样本量：

- 以次日留存率为例，目前大盘次日留存率 80%，预期实验能够提升 0.2pp
  （这里的留存率可以转换为点击率、渗透率等等，只要是比例值就可以，**如果估不准，为了保证实验能够得到结果，此处可低估，不可高估，也就是 0.2pp 是预期能够提升地最小值**）
- 网站计算，最少样本量就是 63W
  （**这里的最少样本量，指的是最少流量实验组的样本量**）
- 如果我们每天只有 5W 的用户可用于实验（5W 的用户，指最少流量实验组是 5W 用户），63/ 5 = 13 天，我们需要至少 13 天才能够得到实验结论

## 过程

![flagger-abtest-steps](images\flagger-abtest-steps.png)



 **SLO(服务等级目标)**指定了服务所提供功能的一种期望状态 

什么是 SLI、SLO和SLA

https://www.cnblogs.com/itcomputer/p/7138655.html

## 案例

### Flagger

ab-test-canary-reviews-v1.yaml

kubectl apply -f ab-test-canary-reviews-v1.yaml -n istio

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: bookinfo
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: reviews-v1
  progressDeadlineSeconds: 600
  service:
    port: 9080
    gateways:
    - istio/bookinfo-gateway
    hosts:
    - "*"
  analysis:
    interval: 30s
    iterations: 5
    threshold: 2
    match:
      - headers:
          test1:
            exact: test1
    metrics:
    - name: request-success-rate
      thresholdRange:
        min: 99
      interval: 1m
    - name: request-duration
      thresholdRange:
        max: 500
      interval: 30s
    webhooks:
      - name: load-test
        url: http://flagger-loadtester.istio-system/
        timeout: 15s
        metadata:
          cmd: "hey -z 1m -q 10 -c 2  http://reviews-v1-canary.istio:9080/reviews/0"
```





```
kubectl -n istio set image deployment/reviews-v1 reviews=docker.io/istio/examples-bookinfo-reviews-v2:1.16.2

执行请求：
go-stress-testing -n 10000 -c 5 -u http://192.168.229.134:30468/reviews/0

go-stress-testing -n 10000 -c 5 -H "test1: test1" -u http://192.168.229.134:30468/reviews/0

kubectl describe canary bookinfo -n istio

  Type     Reason  Age                    From     Message
  ----     ------  ----                   ----     -------
  Warning  Synced  6m12s                  flagger  reviews-v1-primary.istio not ready: waiting for rollout to finish: observed deployment generation less than desired generation
  Normal   Synced  5m42s (x2 over 6m12s)  flagger  all the metrics providers are available!
  Normal   Synced  5m42s                  flagger  Initialization done! bookinfo.istio
  Normal   Synced  4m42s                  flagger  New revision detected! Scaling up reviews-v1.istio
  Normal   Synced  4m12s                  flagger  Starting canary analysis for reviews-v1.istio
  Normal   Synced  4m12s                  flagger  Advance bookinfo.istio canary iteration 1/5
  Warning  Synced  3m42s                  flagger  Halt advancement no values found for istio metric request-success-rate probably reviews-v1.istio is not receiving traffic: running query failed: no values found
  Normal   Synced  3m12s                  flagger  Advance bookinfo.istio canary iteration 2/5
  Normal   Synced  2m42s                  flagger  Advance bookinfo.istio canary iteration 3/5
  Normal   Synced  2m12s                  flagger  Advance bookinfo.istio canary iteration 4/5
  Normal   Synced  102s                   flagger  Advance bookinfo.istio canary iteration 5/5
  Normal   Synced  12s (x3 over 72s)      flagger  (combined from similar events): Promotion completed! Scaling down reviews-v1.istio


 kubectl get vs -n istio reviews-v1 -o yaml
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - headers:
        test1:
          exact: test1
    route:
    - destination:
        host: reviews-v1-primary
      weight: 100
    - destination:
        host: reviews-v1-canary
      weight: 0
  - route:
    - destination:
        host: reviews-v1-primary
      weight: 100
      
spec:
  gateways:
  - istio/bookinfo-gateway
  hosts:
  - '*'
  http:
  - match:
    - headers:
        test1:
          exact: test1
    route:
    - destination:
        host: reviews-v1-primary
      weight: 0
    - destination:
        host: reviews-v1-canary
      weight: 100
  - route:
    - destination:
        host: reviews-v1-primary
      weight: 0
      
      
匹配
      - headers:
          test1:
            exact: test1
 表示新版本
 
 不匹配表示老版本
```





kubectl delete canary bookinfo -n istio
