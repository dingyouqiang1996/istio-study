# 项目

来源：

https://github.com/GoogleCloudPlatform/microservices-demo

## 架构

![architecture-diagram](images\architecture-diagram.png)



## 模块

| [frontend](https://github.com/GoogleCloudPlatform/microservices-demo/blob/main/src/frontend) | Go            | Exposes an HTTP server to serve the website. Does not require signup/login and generates session IDs for all users automatically. |
| ------------------------------------------------------------ | ------------- | ------------------------------------------------------------ |
| [cartservice](https://github.com/GoogleCloudPlatform/microservices-demo/blob/main/src/cartservice) | C#            | Stores the items in the user's shopping cart in Redis and retrieves it. |
| [productcatalogservice](https://github.com/GoogleCloudPlatform/microservices-demo/blob/main/src/productcatalogservice) | Go            | Provides the list of products from a JSON file and ability to search products and get individual products. |
| [currencyservice](https://github.com/GoogleCloudPlatform/microservices-demo/blob/main/src/currencyservice) | Node.js       | Converts one money amount to another currency. Uses real values fetched from European Central Bank. It's the highest QPS service. |
| [paymentservice](https://github.com/GoogleCloudPlatform/microservices-demo/blob/main/src/paymentservice) | Node.js       | Charges the given credit card info (mock) with the given amount and returns a transaction ID. |
| [shippingservice](https://github.com/GoogleCloudPlatform/microservices-demo/blob/main/src/shippingservice) | Go            | Gives shipping cost estimates based on the shopping cart. Ships items to the given address (mock) |
| [emailservice](https://github.com/GoogleCloudPlatform/microservices-demo/blob/main/src/emailservice) | Python        | Sends users an order confirmation email (mock).              |
| [checkoutservice](https://github.com/GoogleCloudPlatform/microservices-demo/blob/main/src/checkoutservice) | Go            | Retrieves user cart, prepares order and orchestrates the payment, shipping and the email notification. |
| [recommendationservice](https://github.com/GoogleCloudPlatform/microservices-demo/blob/main/src/recommendationservice) | Python        | Recommends other products based on what's given in the cart. |
| [adservice](https://github.com/GoogleCloudPlatform/microservices-demo/blob/main/src/adservice) | Java          | Provides text ads based on given context words.              |
| [loadgenerator](https://github.com/GoogleCloudPlatform/microservices-demo/blob/main/src/loadgenerator) | Python/Locust | Continuously sends requests imitating realistic user shopping flows to the frontend. |



## 效果

![online-boutique-frontend-1](images\online-boutique-frontend-1.png)



![online-boutique-frontend-2](images\online-boutique-frontend-2.png)



## 部署：

```
kubectl apply -f kubernetes-manifests-v0.3.6.yaml -n demo-01

kubectl apply -f kubernetes-manifests-v0.2.1.yaml -n demo-01
```

### 1

kubernetes-manifests-v0.3.6.yaml

```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: emailservice-v2
spec:
  selector:
    matchLabels:
      app: emailservice
      version: v2
  template:
    metadata:
      labels:
        app: emailservice
        version: v2
        line: v2
      annotations:
        sidecar.istio.io/userVolumeMount: '[{"name":"wasm", "mountPath":"/var/local/lib/wasm-filters", "readonly":true},{"name":"wasm-2", "mountPath":"/var/local/lib/wasm-filters-2", "readonly":true},{"name":"wasm-3", "mountPath":"/var/local/lib/wasm-filters-3", "readonly":true}]'
        sidecar.istio.io/userVolume: '[{"name":"wasm", "configmap":{"name":"wasm"}},{"name":"wasm-2", "configmap":{"name":"wasm-2"}},{"name":"wasm-3", "configmap":{"name":"wasm-3"}}]'
    spec:
      serviceAccountName: default
      terminationGracePeriodSeconds: 5
      containers:
      - name: server
        image: alexshu/emailservice:v0.3.6
        ports:
        - containerPort: 8080
        env:
        - name: PORT
          value: "8080"
        - name: DISABLE_TRACING
          value: "1"
        - name: DISABLE_PROFILER
          value: "1"
        readinessProbe:
          periodSeconds: 5
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:8080"]
        livenessProbe:
          periodSeconds: 5
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:8080"]
---
apiVersion: v1
kind: Service
metadata:
  name: emailservice
spec:
  type: ClusterIP
  selector:
    app: emailservice
  ports:
  - name: grpc
    port: 5000
    targetPort: 8080
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: checkoutservice-v2
spec:
  selector:
    matchLabels:
      app: checkoutservice
      version: v2
  template:
    metadata:
      labels:
        app: checkoutservice
        version: v2
        line: v2
      annotations:
        sidecar.istio.io/userVolumeMount: '[{"name":"wasm", "mountPath":"/var/local/lib/wasm-filters", "readonly":true},{"name":"wasm-2", "mountPath":"/var/local/lib/wasm-filters-2", "readonly":true},{"name":"wasm-3", "mountPath":"/var/local/lib/wasm-filters-3", "readonly":true}]'
        sidecar.istio.io/userVolume: '[{"name":"wasm", "configmap":{"name":"wasm"}},{"name":"wasm-2", "configmap":{"name":"wasm-2"}},{"name":"wasm-3", "configmap":{"name":"wasm-3"}}]'
    spec:
      serviceAccountName: default
      containers:
        - name: server
          image: alexshu/checkoutservice:v0.3.6
          ports:
          - containerPort: 5050
          readinessProbe:
            exec:
              command: ["/bin/grpc_health_probe", "-addr=:5050"]
          livenessProbe:
            exec:
              command: ["/bin/grpc_health_probe", "-addr=:5050"]
          env:
          - name: PORT
            value: "5050"
          - name: PRODUCT_CATALOG_SERVICE_ADDR
            value: "productcatalogservice:3550"
          - name: SHIPPING_SERVICE_ADDR
            value: "shippingservice:50051"
          - name: PAYMENT_SERVICE_ADDR
            value: "paymentservice:50051"
          - name: EMAIL_SERVICE_ADDR
            value: "emailservice:5000"
          - name: CURRENCY_SERVICE_ADDR
            value: "currencyservice:7000"
          - name: CART_SERVICE_ADDR
            value: "cartservice:7070"
          - name: DISABLE_STATS
            value: "1"
          - name: DISABLE_TRACING
            value: "1"
          - name: DISABLE_PROFILER
            value: "1"
          # - name: JAEGER_SERVICE_ADDR
          #   value: "jaeger-collector:14268"
---
apiVersion: v1
kind: Service
metadata:
  name: checkoutservice
spec:
  type: ClusterIP
  selector:
    app: checkoutservice
  ports:
  - name: grpc
    port: 5050
    targetPort: 5050
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: recommendationservice-v2
spec:
  selector:
    matchLabels:
      app: recommendationservice
      version: v2
  template:
    metadata:
      labels:
        app: recommendationservice
        version: v2
        line: v2
      annotations:
        sidecar.istio.io/userVolumeMount: '[{"name":"wasm", "mountPath":"/var/local/lib/wasm-filters", "readonly":true},{"name":"wasm-2", "mountPath":"/var/local/lib/wasm-filters-2", "readonly":true},{"name":"wasm-3", "mountPath":"/var/local/lib/wasm-filters-3", "readonly":true}]'
        sidecar.istio.io/userVolume: '[{"name":"wasm", "configmap":{"name":"wasm"}},{"name":"wasm-2", "configmap":{"name":"wasm-2"}},{"name":"wasm-3", "configmap":{"name":"wasm-3"}}]'
    spec:
      serviceAccountName: default
      terminationGracePeriodSeconds: 5
      containers:
      - name: server
        image: alexshu/recommendationservice:v0.3.6
        ports:
        - containerPort: 8080
        readinessProbe:
          periodSeconds: 5
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:8080"]
        livenessProbe:
          periodSeconds: 5
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:8080"]
        env:
        - name: PORT
          value: "8080"
        - name: PRODUCT_CATALOG_SERVICE_ADDR
          value: "productcatalogservice:3550"
        - name: DISABLE_TRACING
          value: "1"
        - name: DISABLE_PROFILER
          value: "1"
        - name: DISABLE_DEBUGGER
          value: "1"

---
apiVersion: v1
kind: Service
metadata:
  name: recommendationservice
spec:
  type: ClusterIP
  selector:
    app: recommendationservice
  ports:
  - name: grpc
    port: 8080
    targetPort: 8080
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend-v2
spec:
  selector:
    matchLabels:
      app: frontend
      version: v2
  template:
    metadata:
      labels:
        app: frontend
        version: v2
        line: front-v2
      annotations:
        sidecar.istio.io/userVolumeMount: '[{"name":"wasm", "mountPath":"/var/local/lib/wasm-filters", "readonly":true}]'
        sidecar.istio.io/userVolume: '[{"name":"wasm", "configmap":{"name":"wasm"}}]'
        sidecar.istio.io/rewriteAppHTTPProbers: "true"
    spec:
      serviceAccountName: default
      containers:
        - name: server
          image: alexshu/frontend:v0.3.6
          ports:
          - containerPort: 8080
          readinessProbe:
            initialDelaySeconds: 10
            httpGet:
              path: "/_healthz"
              port: 8080
              httpHeaders:
              - name: "Cookie"
                value: "shop_session-id=x-readiness-probe"
          livenessProbe:
            initialDelaySeconds: 10
            httpGet:
              path: "/_healthz"
              port: 8080
              httpHeaders:
              - name: "Cookie"
                value: "shop_session-id=x-liveness-probe"
          env:
          - name: PORT
            value: "8080"
          - name: PRODUCT_CATALOG_SERVICE_ADDR
            value: "productcatalogservice:3550"
          - name: CURRENCY_SERVICE_ADDR
            value: "currencyservice:7000"
          - name: CART_SERVICE_ADDR
            value: "cartservice:7070"
          - name: RECOMMENDATION_SERVICE_ADDR
            value: "recommendationservice:8080"
          - name: SHIPPING_SERVICE_ADDR
            value: "shippingservice:50051"
          - name: CHECKOUT_SERVICE_ADDR
            value: "checkoutservice:5050"
          - name: AD_SERVICE_ADDR
            value: "adservice:9555"
          # # ENV_PLATFORM: One of: local, gcp, aws, azure, onprem, alibaba
          # # When not set, defaults to "local" unless running in GKE, otherwies auto-sets to gcp 
          # - name: ENV_PLATFORM 
          #   value: "aws"
          - name: DISABLE_TRACING
            value: "1"
          - name: DISABLE_PROFILER
            value: "1"
          # - name: JAEGER_SERVICE_ADDR
          #   value: "jaeger-collector:14268"
          # - name: CYMBAL_BRANDING
          #   value: "true"

---
apiVersion: v1
kind: Service
metadata:
  name: frontend
spec:
  type: ClusterIP
  selector:
    app: frontend
  ports:
  - name: http
    port: 80
    targetPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: frontend-external
spec:
  type: LoadBalancer
  selector:
    app: frontend
  ports:
  - name: http
    port: 80
    targetPort: 8080
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: paymentservice-v2
spec:
  selector:
    matchLabels:
      app: paymentservice
      version: v2
  template:
    metadata:
      labels:
        app: paymentservice
        version: v2
        line: v2
      annotations:
        sidecar.istio.io/userVolumeMount: '[{"name":"wasm", "mountPath":"/var/local/lib/wasm-filters", "readonly":true},{"name":"wasm-2", "mountPath":"/var/local/lib/wasm-filters-2", "readonly":true},{"name":"wasm-3", "mountPath":"/var/local/lib/wasm-filters-3", "readonly":true}]'
        sidecar.istio.io/userVolume: '[{"name":"wasm", "configmap":{"name":"wasm"}},{"name":"wasm-2", "configmap":{"name":"wasm-2"}},{"name":"wasm-3", "configmap":{"name":"wasm-3"}}]'
    spec:
      serviceAccountName: default
      terminationGracePeriodSeconds: 5
      containers:
      - name: server
        image: alexshu/paymentservice:v0.3.6
        ports:
        - containerPort: 50051
        env:
        - name: PORT
          value: "50051"
        - name: DISABLE_TRACING
          value: "1"
        - name: DISABLE_PROFILER
          value: "1"
        - name: DISABLE_DEBUGGER
          value: "1"
        readinessProbe:
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:50051"]
        livenessProbe:
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:50051"]

---
apiVersion: v1
kind: Service
metadata:
  name: paymentservice
spec:
  type: ClusterIP
  selector:
    app: paymentservice
  ports:
  - name: grpc
    port: 50051
    targetPort: 50051
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: productcatalogservice-v2
spec:
  selector:
    matchLabels:
      app: productcatalogservice
      version: v2
  template:
    metadata:
      labels:
        app: productcatalogservice
        version: v2
        line: v2
      annotations:
        sidecar.istio.io/userVolumeMount: '[{"name":"wasm", "mountPath":"/var/local/lib/wasm-filters", "readonly":true},{"name":"wasm-2", "mountPath":"/var/local/lib/wasm-filters-2", "readonly":true},{"name":"wasm-3", "mountPath":"/var/local/lib/wasm-filters-3", "readonly":true}]'
        sidecar.istio.io/userVolume: '[{"name":"wasm", "configmap":{"name":"wasm"}},{"name":"wasm-2", "configmap":{"name":"wasm-2"}},{"name":"wasm-3", "configmap":{"name":"wasm-3"}}]'
    spec:
      serviceAccountName: default
      terminationGracePeriodSeconds: 5
      containers:
      - name: server
        image: alexshu/productcatalogservice:v0.3.6
        ports:
        - containerPort: 3550
        env:
        - name: PORT
          value: "3550"
        - name: DISABLE_STATS
          value: "1"
        - name: DISABLE_TRACING
          value: "1"
        - name: DISABLE_PROFILER
          value: "1"
        # - name: JAEGER_SERVICE_ADDR
        #   value: "jaeger-collector:14268"
        readinessProbe:
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:3550"]
        livenessProbe:
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:3550"]

---
apiVersion: v1
kind: Service
metadata:
  name: productcatalogservice
spec:
  type: ClusterIP
  selector:
    app: productcatalogservice
  ports:
  - name: grpc
    port: 3550
    targetPort: 3550
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cartservice-v2
spec:
  selector:
    matchLabels:
      app: cartservice
      version: v2
  template:
    metadata:
      labels:
        app: cartservice
        version: v2
        line: v2
      annotations:
        sidecar.istio.io/userVolumeMount: '[{"name":"wasm", "mountPath":"/var/local/lib/wasm-filters", "readonly":true},{"name":"wasm-2", "mountPath":"/var/local/lib/wasm-filters-2", "readonly":true},{"name":"wasm-3", "mountPath":"/var/local/lib/wasm-filters-3", "readonly":true}]'
        sidecar.istio.io/userVolume: '[{"name":"wasm", "configmap":{"name":"wasm"}},{"name":"wasm-2", "configmap":{"name":"wasm-2"}},{"name":"wasm-3", "configmap":{"name":"wasm-3"}}]'
    spec:
      serviceAccountName: default
      terminationGracePeriodSeconds: 5
      containers:
      - name: server
        image: alexshu/cartservice:v0.3.6
        ports:
        - containerPort: 7070
        env:
        - name: REDIS_ADDR
          value: "redis-cart:6379"
        readinessProbe:
          initialDelaySeconds: 15
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:7070", "-rpc-timeout=5s"]
        livenessProbe:
          initialDelaySeconds: 15
          periodSeconds: 10
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:7070", "-rpc-timeout=5s"]
---
apiVersion: v1
kind: Service
metadata:
  name: cartservice
spec:
  type: ClusterIP
  selector:
    app: cartservice
  ports:
  - name: grpc
    port: 7070
    targetPort: 7070
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: loadgenerator-v2
spec:
  selector:
    matchLabels:
      app: loadgenerator
      version: v2
  replicas: 1
  template:
    metadata:
      labels:
        app: loadgenerator
        version: v2
        line: v2
      annotations:
        sidecar.istio.io/userVolumeMount: '[{"name":"wasm", "mountPath":"/var/local/lib/wasm-filters", "readonly":true},{"name":"wasm-2", "mountPath":"/var/local/lib/wasm-filters-2", "readonly":true},{"name":"wasm-3", "mountPath":"/var/local/lib/wasm-filters-3", "readonly":true}]'
        sidecar.istio.io/userVolume: '[{"name":"wasm", "configmap":{"name":"wasm"}},{"name":"wasm-2", "configmap":{"name":"wasm-2"}},{"name":"wasm-3", "configmap":{"name":"wasm-3"}}]'
        sidecar.istio.io/rewriteAppHTTPProbers: "true"
    spec:
      serviceAccountName: default
      terminationGracePeriodSeconds: 5
      restartPolicy: Always
      initContainers:
      - command:
        - /bin/sh
        - -exc
        - |
          echo "Init container pinging frontend: ${FRONTEND_ADDR}..."
          STATUSCODE=$(wget --server-response http://${FRONTEND_ADDR} 2>&1 | awk '/^  HTTP/{print $2}')
          if test $STATUSCODE -ne 200; then
              echo "Error: Could not reach frontend - Status code: ${STATUSCODE}"
              exit 1
          fi
        name: frontend-check
        image: busybox:latest
        env:
        - name: FRONTEND_ADDR
          value: "frontend:80"
      containers:
      - name: main
        image: alexshu/loadgenerator:v0.3.6
        env:
        - name: FRONTEND_ADDR
          value: "frontend:80"
        - name: USERS
          value: "10"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: currencyservice-v2
spec:
  selector:
    matchLabels:
      app: currencyservice
      version: v2
  template:
    metadata:
      labels:
        app: currencyservice
        version: v2
        line: v2
      annotations:
        sidecar.istio.io/userVolumeMount: '[{"name":"wasm", "mountPath":"/var/local/lib/wasm-filters", "readonly":true},{"name":"wasm-2", "mountPath":"/var/local/lib/wasm-filters-2", "readonly":true},{"name":"wasm-3", "mountPath":"/var/local/lib/wasm-filters-3", "readonly":true}]'
        sidecar.istio.io/userVolume: '[{"name":"wasm", "configmap":{"name":"wasm"}},{"name":"wasm-2", "configmap":{"name":"wasm-2"}},{"name":"wasm-3", "configmap":{"name":"wasm-3"}}]'
    spec:
      serviceAccountName: default
      terminationGracePeriodSeconds: 5
      containers:
      - name: server
        image: alexshu/currencyservice:v0.3.6
        ports:
        - name: grpc
          containerPort: 7000
        env:
        - name: PORT
          value: "7000"
        - name: DISABLE_TRACING
          value: "1"
        - name: DISABLE_PROFILER
          value: "1"
        - name: DISABLE_DEBUGGER
          value: "1"
        readinessProbe:
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:7000"]
        livenessProbe:
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:7000"]
---
apiVersion: v1
kind: Service
metadata:
  name: currencyservice
spec:
  type: ClusterIP
  selector:
    app: currencyservice
  ports:
  - name: grpc
    port: 7000
    targetPort: 7000
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: shippingservice-v2
spec:
  selector:
    matchLabels:
      app: shippingservice
      version: v2
  template:
    metadata:
      labels:
        app: shippingservice
        version: v2
        line: v2
      annotations:
        sidecar.istio.io/userVolumeMount: '[{"name":"wasm", "mountPath":"/var/local/lib/wasm-filters", "readonly":true},{"name":"wasm-2", "mountPath":"/var/local/lib/wasm-filters-2", "readonly":true},{"name":"wasm-3", "mountPath":"/var/local/lib/wasm-filters-3", "readonly":true}]'
        sidecar.istio.io/userVolume: '[{"name":"wasm", "configmap":{"name":"wasm"}},{"name":"wasm-2", "configmap":{"name":"wasm-2"}},{"name":"wasm-3", "configmap":{"name":"wasm-3"}}]'
    spec:
      serviceAccountName: default
      containers:
      - name: server
        image: alexshu/shippingservice:v0.3.6
        ports:
        - containerPort: 50051
        env:
        - name: PORT
          value: "50051"
        - name: DISABLE_STATS
          value: "1"
        - name: DISABLE_TRACING
          value: "1"
        - name: DISABLE_PROFILER
          value: "1"
        # - name: JAEGER_SERVICE_ADDR
        #   value: "jaeger-collector:14268"
        readinessProbe:
          periodSeconds: 5
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:50051"]
        livenessProbe:
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:50051"]
---
apiVersion: v1
kind: Service
metadata:
  name: shippingservice
spec:
  type: ClusterIP
  selector:
    app: shippingservice
  ports:
  - name: grpc
    port: 50051
    targetPort: 50051
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis-cart-v2
spec:
  selector:
    matchLabels:
      app: redis-cart
      version: v2
  template:
    metadata:
      labels:
        app: redis-cart
        version: v2
        line: v2
      annotations:
        sidecar.istio.io/userVolumeMount: '[{"name":"wasm", "mountPath":"/var/local/lib/wasm-filters", "readonly":true},{"name":"wasm-2", "mountPath":"/var/local/lib/wasm-filters-2", "readonly":true},{"name":"wasm-3", "mountPath":"/var/local/lib/wasm-filters-3", "readonly":true}]'
        sidecar.istio.io/userVolume: '[{"name":"wasm", "configmap":{"name":"wasm"}},{"name":"wasm-2", "configmap":{"name":"wasm-2"}},{"name":"wasm-3", "configmap":{"name":"wasm-3"}}]'
    spec:
      containers:
      - name: redis
        image: redis:alpine
        ports:
        - containerPort: 6379
        readinessProbe:
          periodSeconds: 5
          tcpSocket:
            port: 6379
        livenessProbe:
          periodSeconds: 5
          tcpSocket:
            port: 6379
        volumeMounts:
        - mountPath: /data
          name: redis-data
      volumes:
      - name: redis-data
        emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: redis-cart
spec:
  type: ClusterIP
  selector:
    app: redis-cart
  ports:
  - name: redis
    port: 6379
    targetPort: 6379
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: adservice-v2
spec:
  selector:
    matchLabels:
      app: adservice
      version: v2
  template:
    metadata:
      labels:
        app: adservice
        version: v2
        line: v2
      annotations:
        sidecar.istio.io/userVolumeMount: '[{"name":"wasm", "mountPath":"/var/local/lib/wasm-filters", "readonly":true},{"name":"wasm-2", "mountPath":"/var/local/lib/wasm-filters-2", "readonly":true},{"name":"wasm-3", "mountPath":"/var/local/lib/wasm-filters-3", "readonly":true}]'
        sidecar.istio.io/userVolume: '[{"name":"wasm", "configmap":{"name":"wasm"}},{"name":"wasm-2", "configmap":{"name":"wasm-2"}},{"name":"wasm-3", "configmap":{"name":"wasm-3"}}]'
    spec:
      serviceAccountName: default
      terminationGracePeriodSeconds: 5
      containers:
      - name: server
        image: alexshu/adservice:v0.3.6
        ports:
        - containerPort: 9555
        env:
        - name: PORT
          value: "9555"
        - name: DISABLE_STATS
          value: "1"
        - name: DISABLE_TRACING
          value: "1"
        # - name: JAEGER_SERVICE_ADDR
        #   value: "jaeger-collector:14268"
        readinessProbe:
          initialDelaySeconds: 20
          periodSeconds: 15
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:9555"]
        livenessProbe:
          initialDelaySeconds: 20
          periodSeconds: 15
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:9555"]
---
apiVersion: v1
kind: Service
metadata:
  name: adservice
spec:
  type: ClusterIP
  selector:
    app: adservice
  ports:
  - name: grpc
    port: 9555
    targetPort: 9555
---

```

### 2

kubernetes-manifests-v0.2.1.yaml

```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: emailservice-v1
spec:
  selector:
    matchLabels:
      app: emailservice
      version: v1
  template:
    metadata:
      labels:
        app: emailservice
        version: v1
        line: v1 
      annotations:
        sidecar.istio.io/userVolumeMount: '[{"name":"wasm", "mountPath":"/var/local/lib/wasm-filters", "readonly":true},{"name":"wasm-2", "mountPath":"/var/local/lib/wasm-filters-2", "readonly":true},{"name":"wasm-3", "mountPath":"/var/local/lib/wasm-filters-3", "readonly":true}]'
        sidecar.istio.io/userVolume: '[{"name":"wasm", "configmap":{"name":"wasm"}},{"name":"wasm-2", "configmap":{"name":"wasm-2"}},{"name":"wasm-3", "configmap":{"name":"wasm-3"}}]'
    spec:
      serviceAccountName: default
      terminationGracePeriodSeconds: 5
      containers:
      - name: server
        image: alexshu/emailservice:v0.2.1
        ports:
        - containerPort: 8080
        env:
        - name: PORT
          value: "8080"
        # - name: DISABLE_TRACING
        #   value: "1"
        - name: DISABLE_PROFILER
          value: "1"
        readinessProbe:
          periodSeconds: 5
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:8080"]
        livenessProbe:
          periodSeconds: 5
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:8080"]
---
apiVersion: v1
kind: Service
metadata:
  name: emailservice
spec:
  type: ClusterIP
  selector:
    app: emailservice
  ports:
  - name: grpc
    port: 5000
    targetPort: 8080
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: checkoutservice-v1
spec:
  selector:
    matchLabels:
      app: checkoutservice
      version: v1
  template:
    metadata:
      labels:
        app: checkoutservice
        version: v1
        line: v1 
      annotations:
        sidecar.istio.io/userVolumeMount: '[{"name":"wasm", "mountPath":"/var/local/lib/wasm-filters", "readonly":true},{"name":"wasm-2", "mountPath":"/var/local/lib/wasm-filters-2", "readonly":true},{"name":"wasm-3", "mountPath":"/var/local/lib/wasm-filters-3", "readonly":true}]'
        sidecar.istio.io/userVolume: '[{"name":"wasm", "configmap":{"name":"wasm"}},{"name":"wasm-2", "configmap":{"name":"wasm-2"}},{"name":"wasm-3", "configmap":{"name":"wasm-3"}}]'
    spec:
      serviceAccountName: default
      containers:
        - name: server
          image: alexshu/checkoutservice:v0.2.1
          ports:
          - containerPort: 5050
          readinessProbe:
            exec:
              command: ["/bin/grpc_health_probe", "-addr=:5050"]
          livenessProbe:
            exec:
              command: ["/bin/grpc_health_probe", "-addr=:5050"]
          env:
          - name: PORT
            value: "5050"
          - name: PRODUCT_CATALOG_SERVICE_ADDR
            value: "productcatalogservice:3550"
          - name: SHIPPING_SERVICE_ADDR
            value: "shippingservice:50051"
          - name: PAYMENT_SERVICE_ADDR
            value: "paymentservice:50051"
          - name: EMAIL_SERVICE_ADDR
            value: "emailservice:5000"
          - name: CURRENCY_SERVICE_ADDR
            value: "currencyservice:7000"
          - name: CART_SERVICE_ADDR
            value: "cartservice:7070"
          # - name: DISABLE_STATS
          #   value: "1"
          # - name: DISABLE_TRACING
          #   value: "1"
          # - name: DISABLE_PROFILER
          #   value: "1"
          # - name: JAEGER_SERVICE_ADDR
          #   value: "jaeger-collector:14268"
---
apiVersion: v1
kind: Service
metadata:
  name: checkoutservice
spec:
  type: ClusterIP
  selector:
    app: checkoutservice
  ports:
  - name: grpc
    port: 5050
    targetPort: 5050
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: recommendationservice-v1
spec:
  selector:
    matchLabels:
      app: recommendationservice
      version: v1
  template:
    metadata:
      labels:
        app: recommendationservice
        version: v1
        line: v1 
      annotations:
        sidecar.istio.io/userVolumeMount: '[{"name":"wasm", "mountPath":"/var/local/lib/wasm-filters", "readonly":true},{"name":"wasm-2", "mountPath":"/var/local/lib/wasm-filters-2", "readonly":true},{"name":"wasm-3", "mountPath":"/var/local/lib/wasm-filters-3", "readonly":true}]'
        sidecar.istio.io/userVolume: '[{"name":"wasm", "configmap":{"name":"wasm"}},{"name":"wasm-2", "configmap":{"name":"wasm-2"}},{"name":"wasm-3", "configmap":{"name":"wasm-3"}}]'
    spec:
      terminationGracePeriodSeconds: 5
      containers:
      - name: server
        image: alexshu/recommendationservice:v0.2.1
        ports:
        - containerPort: 8080
        readinessProbe:
          periodSeconds: 5
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:8080"]
        livenessProbe:
          periodSeconds: 5
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:8080"]
        env:
        - name: PORT
          value: "8080"
        - name: PRODUCT_CATALOG_SERVICE_ADDR
          value: "productcatalogservice:3550"
        # - name: DISABLE_TRACING
        #   value: "1"
        # - name: DISABLE_PROFILER
        #   value: "1"
        # - name: DISABLE_DEBUGGER
        #   value: "1"
---
apiVersion: v1
kind: Service
metadata:
  name: recommendationservice
spec:
  type: ClusterIP
  selector:
    app: recommendationservice
  ports:
  - name: grpc
    port: 8080
    targetPort: 8080
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend-v1
spec:
  selector:
    matchLabels:
      app: frontend
      version: v1
  template:
    metadata:
      labels:
        app: frontend
        version: v1
        line: front-v1
      annotations:
        sidecar.istio.io/userVolumeMount: '[{"name":"wasm", "mountPath":"/var/local/lib/wasm-filters", "readonly":true}]'
        sidecar.istio.io/userVolume: '[{"name":"wasm", "configmap":{"name":"wasm"}}]'
        sidecar.istio.io/rewriteAppHTTPProbers: "true"
    spec:
      serviceAccountName: default
      containers:
        - name: server
          image: alexshu/frontend:v0.2.1
          ports:
          - containerPort: 8080
          readinessProbe:
            initialDelaySeconds: 10
            httpGet:
              path: "/_healthz"
              port: 8080
              httpHeaders:
              - name: "Cookie"
                value: "shop_session-id=x-readiness-probe"
          livenessProbe:
            initialDelaySeconds: 10
            httpGet:
              path: "/_healthz"
              port: 8080
              httpHeaders:
              - name: "Cookie"
                value: "shop_session-id=x-liveness-probe"
          env:
          - name: PORT
            value: "8080"
          - name: PRODUCT_CATALOG_SERVICE_ADDR
            value: "productcatalogservice:3550"
          - name: CURRENCY_SERVICE_ADDR
            value: "currencyservice:7000"
          - name: CART_SERVICE_ADDR
            value: "cartservice:7070"
          - name: RECOMMENDATION_SERVICE_ADDR
            value: "recommendationservice:8080"
          - name: SHIPPING_SERVICE_ADDR
            value: "shippingservice:50051"
          - name: CHECKOUT_SERVICE_ADDR
            value: "checkoutservice:5050"
          - name: AD_SERVICE_ADDR
            value: "adservice:9555"
          - name: ENV_PLATFORM
            value: "gcp"
          # - name: DISABLE_TRACING
          #   value: "1"
          # - name: DISABLE_PROFILER
          #   value: "1"
          # - name: JAEGER_SERVICE_ADDR
          #   value: "jaeger-collector:14268"
---
apiVersion: v1
kind: Service
metadata:
  name: frontend
spec:
  type: ClusterIP
  selector:
    app: frontend
  ports:
  - name: http
    port: 80
    targetPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: frontend-external
spec:
  type: LoadBalancer
  selector:
    app: frontend
  ports:
  - name: http
    port: 80
    targetPort: 8080
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: paymentservice-v1
spec:
  selector:
    matchLabels:
      app: paymentservice
      version: v1
  template:
    metadata:
      labels:
        app: paymentservice
        version: v1
        line: v1 
      annotations:
        sidecar.istio.io/userVolumeMount: '[{"name":"wasm", "mountPath":"/var/local/lib/wasm-filters", "readonly":true},{"name":"wasm-2", "mountPath":"/var/local/lib/wasm-filters-2", "readonly":true},{"name":"wasm-3", "mountPath":"/var/local/lib/wasm-filters-3", "readonly":true}]'
        sidecar.istio.io/userVolume: '[{"name":"wasm", "configmap":{"name":"wasm"}},{"name":"wasm-2", "configmap":{"name":"wasm-2"}},{"name":"wasm-3", "configmap":{"name":"wasm-3"}}]'
    spec:
      serviceAccountName: default
      terminationGracePeriodSeconds: 5
      containers:
      - name: server
        image: alexshu/paymentservice:v0.2.1
        ports:
        - containerPort: 50051
        env:
        - name: PORT
          value: "50051"
        readinessProbe:
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:50051"]
        livenessProbe:
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:50051"]
---
apiVersion: v1
kind: Service
metadata:
  name: paymentservice
spec:
  type: ClusterIP
  selector:
    app: paymentservice
  ports:
  - name: grpc
    port: 50051
    targetPort: 50051
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: productcatalogservice-v1
spec:
  selector:
    matchLabels:
      app: productcatalogservice
      version: v1
  template:
    metadata:
      labels:
        app: productcatalogservice
        version: v1
        line: v1 
      annotations:
        sidecar.istio.io/userVolumeMount: '[{"name":"wasm", "mountPath":"/var/local/lib/wasm-filters", "readonly":true},{"name":"wasm-2", "mountPath":"/var/local/lib/wasm-filters-2", "readonly":true},{"name":"wasm-3", "mountPath":"/var/local/lib/wasm-filters-3", "readonly":true}]'
        sidecar.istio.io/userVolume: '[{"name":"wasm", "configmap":{"name":"wasm"}},{"name":"wasm-2", "configmap":{"name":"wasm-2"}},{"name":"wasm-3", "configmap":{"name":"wasm-3"}}]'
    spec:
      serviceAccountName: default
      terminationGracePeriodSeconds: 5
      containers:
      - name: server
        image: alexshu/productcatalogservice:v0.2.1
        ports:
        - containerPort: 3550
        env:
        - name: PORT
          value: "3550"
        - name: DISABLE_TRACING
          value: "1"
        - name: DISABLE_PROFILER
          value: "1"
        - name: DISABLE_DEBUGGER
          value: "1"
        # - name: JAEGER_SERVICE_ADDR
        #   value: "jaeger-collector:14268"
        readinessProbe:
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:3550"]
        livenessProbe:
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:3550"]
---
apiVersion: v1
kind: Service
metadata:
  name: productcatalogservice
spec:
  type: ClusterIP
  selector:
    app: productcatalogservice
  ports:
  - name: grpc
    port: 3550
    targetPort: 3550
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cartservice-v1
spec:
  selector:
    matchLabels:
      app: cartservice
      version: v1
  template:
    metadata:
      labels:
        app: cartservice
        version: v1
        line: v1 
      annotations:
        sidecar.istio.io/userVolumeMount: '[{"name":"wasm", "mountPath":"/var/local/lib/wasm-filters", "readonly":true},{"name":"wasm-2", "mountPath":"/var/local/lib/wasm-filters-2", "readonly":true},{"name":"wasm-3", "mountPath":"/var/local/lib/wasm-filters-3", "readonly":true}]'
        sidecar.istio.io/userVolume: '[{"name":"wasm", "configmap":{"name":"wasm"}},{"name":"wasm-2", "configmap":{"name":"wasm-2"}},{"name":"wasm-3", "configmap":{"name":"wasm-3"}}]'
    spec:
      serviceAccountName: default
      terminationGracePeriodSeconds: 5
      containers:
      - name: server
        image: alexshu/cartservice:v0.2.1
        ports:
        - containerPort: 7070
        env:
        - name: REDIS_ADDR
          value: "redis-cart:6379"
        - name: PORT
          value: "7070"
        - name: LISTEN_ADDR
          value: "0.0.0.0"
        readinessProbe:
          initialDelaySeconds: 15
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:7070", "-rpc-timeout=5s"]
        livenessProbe:
          initialDelaySeconds: 15
          periodSeconds: 10
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:7070", "-rpc-timeout=5s"]
---
apiVersion: v1
kind: Service
metadata:
  name: cartservice
spec:
  type: ClusterIP
  selector:
    app: cartservice
  ports:
  - name: grpc
    port: 7070
    targetPort: 7070
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: loadgenerator-v1
spec:
  selector:
    matchLabels:
      app: loadgenerator
      version: v1
  replicas: 1
  template:
    metadata:
      labels:
        app: loadgenerator
        version: v1
        line: v1 
      annotations:
        sidecar.istio.io/userVolumeMount: '[{"name":"wasm", "mountPath":"/var/local/lib/wasm-filters", "readonly":true},{"name":"wasm-2", "mountPath":"/var/local/lib/wasm-filters-2", "readonly":true},{"name":"wasm-3", "mountPath":"/var/local/lib/wasm-filters-3", "readonly":true}]'
        sidecar.istio.io/userVolume: '[{"name":"wasm", "configmap":{"name":"wasm"}},{"name":"wasm-2", "configmap":{"name":"wasm-2"}},{"name":"wasm-3", "configmap":{"name":"wasm-3"}}]'
        sidecar.istio.io/rewriteAppHTTPProbers: "true"
    spec:
      serviceAccountName: default
      terminationGracePeriodSeconds: 5
      restartPolicy: Always
      containers:
      - name: main
        image: alexshu/loadgenerator:v0.2.1
        env:
        - name: FRONTEND_ADDR
          value: "frontend:80"
        - name: USERS
          value: "10"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: currencyservice-v1
spec:
  selector:
    matchLabels:
      app: currencyservice
      version: v1
  template:
    metadata:
      labels:
        app: currencyservice
        version: v1
        line: v1 
      annotations:
        sidecar.istio.io/userVolumeMount: '[{"name":"wasm", "mountPath":"/var/local/lib/wasm-filters", "readonly":true},{"name":"wasm-2", "mountPath":"/var/local/lib/wasm-filters-2", "readonly":true},{"name":"wasm-3", "mountPath":"/var/local/lib/wasm-filters-3", "readonly":true}]'
        sidecar.istio.io/userVolume: '[{"name":"wasm", "configmap":{"name":"wasm"}},{"name":"wasm-2", "configmap":{"name":"wasm-2"}},{"name":"wasm-3", "configmap":{"name":"wasm-3"}}]'
    spec:
      serviceAccountName: default
      terminationGracePeriodSeconds: 5
      containers:
      - name: server
        image: alexshu/currencyservice:v0.2.1
        ports:
        - name: grpc
          containerPort: 7000
        env:
        - name: PORT
          value: "7000"
        # - name: DISABLE_TRACING
        #   value: "1"
        # - name: DISABLE_PROFILER
        #   value: "1"
        # - name: DISABLE_DEBUGGER
        #   value: "1"
        readinessProbe:
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:7000"]
        livenessProbe:
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:7000"]
---
apiVersion: v1
kind: Service
metadata:
  name: currencyservice
spec:
  type: ClusterIP
  selector:
    app: currencyservice
  ports:
  - name: grpc
    port: 7000
    targetPort: 7000
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: shippingservice-v1
spec:
  selector:
    matchLabels:
      app: shippingservice
      version: v1
  template:
    metadata:
      labels:
        app: shippingservice
        version: v1
        line: v1 
      annotations:
        sidecar.istio.io/userVolumeMount: '[{"name":"wasm", "mountPath":"/var/local/lib/wasm-filters", "readonly":true},{"name":"wasm-2", "mountPath":"/var/local/lib/wasm-filters-2", "readonly":true},{"name":"wasm-3", "mountPath":"/var/local/lib/wasm-filters-3", "readonly":true}]'
        sidecar.istio.io/userVolume: '[{"name":"wasm", "configmap":{"name":"wasm"}},{"name":"wasm-2", "configmap":{"name":"wasm-2"}},{"name":"wasm-3", "configmap":{"name":"wasm-3"}}]'
    spec:
      containers:
      - name: server
        image: alexshu/shippingservice:v0.2.1
        ports:
        - containerPort: 50051
        env:
        - name: PORT
          value: "50051"
        # - name: DISABLE_STATS
        #   value: "1"
        # - name: DISABLE_TRACING
        #   value: "1"
        # - name: DISABLE_PROFILER
        #   value: "1"
        # - name: JAEGER_SERVICE_ADDR
        #   value: "jaeger-collector:14268"
        readinessProbe:
          periodSeconds: 5
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:50051"]
        livenessProbe:
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:50051"]
---
apiVersion: v1
kind: Service
metadata:
  name: shippingservice
spec:
  type: ClusterIP
  selector:
    app: shippingservice
  ports:
  - name: grpc
    port: 50051
    targetPort: 50051
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis-cart-v1
spec:
  selector:
    matchLabels:
      app: redis-cart
      version: v1
  template:
    metadata:
      labels:
        app: redis-cart
        version: v1
        line: v1 
      annotations:
        sidecar.istio.io/userVolumeMount: '[{"name":"wasm", "mountPath":"/var/local/lib/wasm-filters", "readonly":true},{"name":"wasm-2", "mountPath":"/var/local/lib/wasm-filters-2", "readonly":true},{"name":"wasm-3", "mountPath":"/var/local/lib/wasm-filters-3", "readonly":true}]'
        sidecar.istio.io/userVolume: '[{"name":"wasm", "configmap":{"name":"wasm"}},{"name":"wasm-2", "configmap":{"name":"wasm-2"}},{"name":"wasm-3", "configmap":{"name":"wasm-3"}}]'
    spec:
      containers:
      - name: redis
        image: redis:alpine
        ports:
        - containerPort: 6379
        readinessProbe:
          periodSeconds: 5
          tcpSocket:
            port: 6379
        livenessProbe:
          periodSeconds: 5
          tcpSocket:
            port: 6379
        volumeMounts:
        - mountPath: /data
          name: redis-data
      volumes:
      - name: redis-data
        emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: redis-cart
spec:
  type: ClusterIP
  selector:
    app: redis-cart
  ports:
  - name: redis
    port: 6379
    targetPort: 6379
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: adservice-v1
spec:
  selector:
    matchLabels:
      app: adservice
      version: v1
  template:
    metadata:
      labels:
        app: adservice
        version: v1
        line: v1 
      annotations:
        sidecar.istio.io/userVolumeMount: '[{"name":"wasm", "mountPath":"/var/local/lib/wasm-filters", "readonly":true},{"name":"wasm-2", "mountPath":"/var/local/lib/wasm-filters-2", "readonly":true},{"name":"wasm-3", "mountPath":"/var/local/lib/wasm-filters-3", "readonly":true}]'
        sidecar.istio.io/userVolume: '[{"name":"wasm", "configmap":{"name":"wasm"}},{"name":"wasm-2", "configmap":{"name":"wasm-2"}},{"name":"wasm-3", "configmap":{"name":"wasm-3"}}]'
    spec:
      serviceAccountName: default
      terminationGracePeriodSeconds: 5
      containers:
      - name: server
        image: alexshu/adservice:v0.2.1
        ports:
        - containerPort: 9555
        env:
        - name: PORT
          value: "9555"
        # - name: DISABLE_STATS
        #   value: "1"
        # - name: DISABLE_TRACING
        #   value: "1"
        #- name: JAEGER_SERVICE_ADDR
        #  value: "jaeger-collector:14268"
        readinessProbe:
          initialDelaySeconds: 20
          periodSeconds: 15
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:9555"]
        livenessProbe:
          initialDelaySeconds: 20
          periodSeconds: 15
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:9555"]
---
apiVersion: v1
kind: Service
metadata:
  name: adservice
spec:
  type: ClusterIP
  selector:
    app: adservice
  ports:
  - name: grpc
    port: 9555
    targetPort: 9555
---

```

istio

### 3

dr.yaml

kubectl apply -f dr.yaml -n demo-01

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: emailservice
spec:
  host: emailservice
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: checkoutservice
spec:
  host: checkoutservice
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: recommendationservice
spec:
  host: recommendationservice
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: frontend
spec:
  host: frontend
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: paymentservice
spec:
  host: paymentservice
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: productcatalogservice
spec:
  host: productcatalogservice
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: cartservice
spec:
  host: cartservice
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: currencyservice
spec:
  host: currencyservice
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: shippingservice
spec:
  host: shippingservice
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: redis-cart
spec:
  host: redis-cart
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: adservice
spec:
  host: adservice
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
---
```

### 4

vs.yaml

kubectl apply -f vs.yaml -n demo-01

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: emailservice
spec:
  hosts:
  - "emailservice"
  http:
  - match:
    - headers:
        version:
          exact: v2
      uri:
        prefix: /
    route:
    - destination:
        host: emailservice
        subset: v2
  - match:
    - headers:
        version:
          exact: v1
      uri:
        prefix: /
    route:
    - destination:
        host: emailservice
        subset: v1
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: checkoutservice
spec:
  hosts:
  - "checkoutservice"
  http:
  - match:
    - headers:
        version:
          exact: v2
      uri:
        prefix: /
    route:
    - destination:
        host: checkoutservice
        subset: v2
  - match:
    - headers:
        version:
          exact: v1
      uri:
        prefix: /
    route:
    - destination:
        host: checkoutservice
        subset: v1
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: recommendationservice
spec:
  hosts:
  - "recommendationservice"
  http:
  - match:
    - headers:
        version:
          exact: v2
      uri:
        prefix: /
    route:
    - destination:
        host: recommendationservice
        subset: v2
  - match:
    - headers:
        version:
          exact: v1
      uri:
        prefix: /
    route:
    - destination:
        host: recommendationservice
        subset: v1
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: paymentservice
spec:
  hosts:
  - "paymentservice"
  http:
  - match:
    - headers:
        version:
          exact: v2
      uri:
        prefix: /
    route:
    - destination:
        host: paymentservice
        subset: v2
  - match:
    - headers:
        version:
          exact: v1
      uri:
        prefix: /
    route:
    - destination:
        host: paymentservice
        subset: v1
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: productcatalogservice
spec:
  hosts:
  - "productcatalogservice"
  http:
  - match:
    - headers:
        version:
          exact: v2
      uri:
        prefix: /
    route:
    - destination:
        host: productcatalogservice
        subset: v2
  - match:
    - headers:
        version:
          exact: v1
      uri:
        prefix: /
    route:
    - destination:
        host: productcatalogservice
        subset: v1
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: cartservice
spec:
  hosts:
  - "cartservice"
  http:
  - match:
    - headers:
        version:
          exact: v2
      uri:
        prefix: /
    route:
    - destination:
        host: cartservice
        subset: v2
  - match:
    - headers:
        version:
          exact: v1
      uri:
        prefix: /
    route:
    - destination:
        host: cartservice
        subset: v1
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: currencyservice
spec:
  hosts:
  - "currencyservice"
  http:
  - match:
    - headers:
        version:
          exact: v2
      uri:
        prefix: /
    route:
    - destination:
        host: currencyservice
        subset: v2
  - match:
    - headers:
        version:
          exact: v1
      uri:
        prefix: /
    route:
    - destination:
        host: currencyservice
        subset: v1
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: shippingservice
spec:
  hosts:
  - "shippingservice"
  http:
  - match:
    - headers:
        version:
          exact: v2
      uri:
        prefix: /
    route:
    - destination:
        host: shippingservice
        subset: v2
  - match:
    - headers:
        version:
          exact: v1
      uri:
        prefix: /
    route:
    - destination:
        host: shippingservice
        subset: v1
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: redis-cart
spec:
  hosts:
  - "redis-cart"
  http:
  - match:
    - headers:
        version:
          exact: v2
      uri:
        prefix: /
    route:
    - destination:
        host: redis-cart
        subset: v2
  - match:
    - headers:
        version:
          exact: v1
      uri:
        prefix: /
    route:
    - destination:
        host: redis-cart
        subset: v1
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: adservice
spec:
  hosts:
  - "adservice"
  http:
  - match:
    - headers:
        version:
          exact: v2
      uri:
        prefix: /
    route:
    - destination:
        host: adservice
        subset: v2
  - match:
    - headers:
        version:
          exact: v1
      uri:
        prefix: /
    route:
    - destination:
        host: adservice
        subset: v1
---
```

### 5

ef.yaml

kubectl apply -f ef.yaml -n demo-01

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: request-header-v1
spec:
  workloadSelector:
    labels:
      line: front-v1
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.router
    patch:
      operation: INSERT_BEFORE
      value:
        name: istio.stats
        typed_config:
          '@type': type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              configuration:
                '@type': type.googleapis.com/google.protobuf.StringValue
                value: |
                  {
                    "header_key":"version",
                    "header_value":"v1"
                  }
              root_id: version_v1
              vm_config:
                allow_precompiled: true
                code:
                  local:
                    filename: /var/local/lib/wasm-filters/request_header.wasm
                runtime: envoy.wasm.runtime.v8
                vm_id: version_v1
---
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: request-header-v2
spec:
  workloadSelector:
    labels:
      line: front-v2
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.router
    patch:
      operation: INSERT_BEFORE
      value:
        name: istio.stats
        typed_config:
          '@type': type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              configuration:
                '@type': type.googleapis.com/google.protobuf.StringValue
                value: |
                  {
                    "header_key":"version",
                    "header_value":"v2"
                  }
              root_id: version_v2
              vm_config:
                allow_precompiled: true
                code:
                  local:
                    filename: /var/local/lib/wasm-filters/request_header.wasm
                runtime: envoy.wasm.runtime.v8
                vm_id: version_v2

---
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: request-header-line-v1
spec:
  workloadSelector:
    labels:
      line: v1
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_INBOUND
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.router
    patch:
      operation: INSERT_BEFORE
      value:
        name: istio.stats
        typed_config:
          '@type': type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              configuration:
                '@type': type.googleapis.com/google.protobuf.StringValue
                value: |
                  {
                    
                  }
              root_id: inbound_v1
              vm_config:
                allow_precompiled: true
                code:
                  local:
                    filename: /var/local/lib/wasm-filters-2/inbound.wasm
                runtime: envoy.wasm.runtime.v8
                vm_id: inbound_outbound_v1
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.router
    patch:
      operation: INSERT_BEFORE
      value:
        name: istio.stats
        typed_config:
          '@type': type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              configuration:
                '@type': type.googleapis.com/google.protobuf.StringValue
                value: |
                  {
                  }
              root_id: outbound-v1
              vm_config:
                allow_precompiled: true
                code:
                  local:
                    filename: /var/local/lib/wasm-filters-3/outbound.wasm
                runtime: envoy.wasm.runtime.v8
                vm_id: inbound_outbound_v1
---
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: request-header-line-v2
spec:
  workloadSelector:
    labels:
      line: v2
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_INBOUND
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.router
    patch:
      operation: INSERT_BEFORE
      value:
        name: istio.stats
        typed_config:
          '@type': type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              configuration:
                '@type': type.googleapis.com/google.protobuf.StringValue
                value: |
                  {
                    
                  }
              root_id: inbound_v2
              vm_config:
                allow_precompiled: true
                code:
                  local:
                    filename: /var/local/lib/wasm-filters-2/inbound.wasm
                runtime: envoy.wasm.runtime.v8
                vm_id: inbound_outbound_v2
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.router
    patch:
      operation: INSERT_BEFORE
      value:
        name: istio.stats
        typed_config:
          '@type': type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              configuration:
                '@type': type.googleapis.com/google.protobuf.StringValue
                value: |
                  {
                  }
              root_id: outbound-v2
              vm_config:
                allow_precompiled: true
                code:
                  local:
                    filename: /var/local/lib/wasm-filters-3/outbound.wasm
                runtime: envoy.wasm.runtime.v8
                vm_id: inbound_outbound_v2

```

wasm代码：

main.go

front:

```
package main

import (
        "fmt"
        "github.com/tidwall/gjson"
        
        "github.com/tetratelabs/proxy-wasm-go-sdk/proxywasm"
        "github.com/tetratelabs/proxy-wasm-go-sdk/proxywasm/types"
)


func main() {
        proxywasm.SetVMContext(&vmContext{})
}

type vmContext struct {
        // Embed the default VM context here,
        // so that we don't need to reimplement all the methods.
        types.DefaultVMContext
}

// Override types.DefaultVMContext.
func (*vmContext) NewPluginContext(contextID uint32) types.PluginContext {
        return &pluginContext{}
}

type pluginContext struct {
        // Embed the default plugin context here,
        // so that we don't need to reimplement all the methods.
        types.DefaultPluginContext
        configuration pluginConfiguration
}

type pluginConfiguration struct {
        header_key string
        header_value string
}

func (ctx *pluginContext) OnPluginStart(pluginConfigurationSize int) types.OnPluginStartStatus {
        data, err := proxywasm.GetPluginConfiguration()
        proxywasm.LogCriticalf("plugin configuration: %s", string(data))
        
        if err != nil {
                proxywasm.LogCriticalf("error reading plugin configuration: %v", err)
        }
        config, err := parsePluginConfiguration(data)
        if err != nil {
                proxywasm.LogCriticalf("error parsing plugin configuration: %v", err)
                return types.OnPluginStartStatusFailed
        }
        ctx.configuration = config
        
        return types.OnPluginStartStatusOK
}

func parsePluginConfiguration(data []byte) (pluginConfiguration, error) {
        if len(data) == 0 {
                proxywasm.LogCriticalf("plugin configuration data length is 0")
                return pluginConfiguration{}, nil
        }

        config := &pluginConfiguration{}
        if !gjson.ValidBytes(data) {
                return pluginConfiguration{}, fmt.Errorf("the plugin configuration is not a valid json: %q", string(data))
        }

        jsonData := gjson.ParseBytes(data)
        header_key:= jsonData.Get("header_key").String()
        header_value:= jsonData.Get("header_value").String()
        config.header_key=header_key
        config.header_value=header_value

        return *config, nil
}

// Override types.DefaultPluginContext.
func (p *pluginContext) NewHttpContext(contextID uint32) types.HttpContext {
        return &httpHeaders{contextID: contextID,header_key:p.configuration.header_key,header_value:p.configuration.header_value}
}

type httpHeaders struct {
        // Embed the default http context here,
        // so that we don't need to reimplement all the methods.
        types.DefaultHttpContext
        contextID uint32
        header_key string
        header_value string
}

// Override types.DefaultHttpContext.
func (ctx *httpHeaders) OnHttpRequestHeaders(numHeaders int, endOfStream bool) types.Action {      
        err := proxywasm.ReplaceHttpRequestHeader(ctx.header_key,ctx.header_value)
        if err != nil {
                proxywasm.LogCriticalf("failed to set request headers(%s,%s): %v",ctx.header_key,ctx.header_value, err)
        }
		proxywasm.LogCriticalf("set request headers(%s,%s)",ctx.header_key,ctx.header_value)
        return types.ActionContinue
}

```





inbound



main.go

```
package main

import (
        
        "github.com/tetratelabs/proxy-wasm-go-sdk/proxywasm"
        "github.com/tetratelabs/proxy-wasm-go-sdk/proxywasm/types"
)


func main() {
        proxywasm.SetVMContext(&vmContext{})
}

type vmContext struct {
        // Embed the default VM context here,
        // so that we don't need to reimplement all the methods.
        types.DefaultVMContext
}

// Override types.DefaultVMContext.
func (*vmContext) NewPluginContext(contextID uint32) types.PluginContext {
        return &pluginContext{}
}

type pluginContext struct {
        // Embed the default plugin context here,
        // so that we don't need to reimplement all the methods.
        types.DefaultPluginContext
}


// Override types.DefaultPluginContext.
func (p *pluginContext) NewHttpContext(contextID uint32) types.HttpContext {
        return &httpHeaders{contextID: contextID}
}

type httpHeaders struct {
        // Embed the default http context here,
        // so that we don't need to reimplement all the methods.
        types.DefaultHttpContext
        contextID uint32
}

// Override types.DefaultHttpContext.
func (ctx *httpHeaders) OnHttpRequestHeaders(numHeaders int, endOfStream bool) types.Action {
        version,err:=proxywasm.GetHttpRequestHeader("version");
        if err != nil {
                proxywasm.LogCriticalf("failed to get request headers(%s,%s): %v","version",version, err)
        }
        if err := proxywasm.SetSharedData("version", []byte(version), 0); err != nil {
                proxywasm.LogWarnf("error setting shared data on OnHttpRequestHeaders: %v", err)
        }

		proxywasm.LogCriticalf("set SetProperty(%s,%s)","version",version)
        return types.ActionContinue
}

```



outbound:

main.go

```
package main

import (
        
        "github.com/tetratelabs/proxy-wasm-go-sdk/proxywasm"
        "github.com/tetratelabs/proxy-wasm-go-sdk/proxywasm/types"
)


func main() {
        proxywasm.SetVMContext(&vmContext{})
}

type vmContext struct {
        // Embed the default VM context here,
        // so that we don't need to reimplement all the methods.
        types.DefaultVMContext
}

// Override types.DefaultVMContext.
func (*vmContext) NewPluginContext(contextID uint32) types.PluginContext {
        return &pluginContext{}
}

type pluginContext struct {
        // Embed the default plugin context here,
        // so that we don't need to reimplement all the methods.
        types.DefaultPluginContext
}


// Override types.DefaultPluginContext.
func (p *pluginContext) NewHttpContext(contextID uint32) types.HttpContext {
        return &httpHeaders{contextID: contextID}
}

type httpHeaders struct {
        // Embed the default http context here,
        // so that we don't need to reimplement all the methods.
        types.DefaultHttpContext
        contextID uint32
}

// Override types.DefaultHttpContext.
func (ctx *httpHeaders) OnHttpRequestHeaders(numHeaders int, endOfStream bool) types.Action {
         version, _, err := proxywasm.GetSharedData("version")
		  if err != nil {
                proxywasm.LogCriticalf("failed to GetSharedData(%s,%s): %v","version",string(version), err)
        }
        err = proxywasm.ReplaceHttpRequestHeader("version",string(version))
        if err != nil {
                proxywasm.LogCriticalf("failed to set request headers(%s,%s): %v","version",string(version), err)
        }
		proxywasm.LogCriticalf("set request headers(%s,%s)","version",string(version))
        return types.ActionContinue
}

```



编译

```
export GOPROXY=https://proxy.golang.com.cn,direct

tinygo build -o request_header.wasm -scheduler=none -target=wasi main.go
```

### 6

```
kubectl create cm wasm --from-file=request_header.wasm -n demo-01

kubectl create cm wasm-2 --from-file=inbound.wasm -n demo-01
kubectl create cm wasm-3 --from-file=outbound.wasm -n demo-01
```



### 7

gw-vs.yaml

kubectl apply -f gw-vs.yaml -n demo-01

```
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: frontend-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: frontend-ingress-v1
spec:
  hosts:
  - "myshop-1.demo"
  gateways:
  - frontend-gateway
  http:
  - match:
    - uri:
        prefix: /
    route:
    - destination:
        host: frontend
        port:
          number: 80
        subset: v1
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: frontend-ingress-v2
spec:
  hosts:
  - "myshop-2.demo"
  gateways:
  - frontend-gateway
  http:
  - match:
    - uri:
        prefix: /
    route:
    - destination:
        host: frontend
        port:
          number: 80
        subset: v2
```

gw.yaml

```
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: frontend-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
```



istio-ingressgateway.yaml

kubectl apply -f istio-ingressgateway.yaml -n istio-system

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: istio-ingressgateway
spec:
  host: istio-ingressgateway
  trafficPolicy:
    loadBalancer:
      consistentHash:
        httpCookie:
          name: shop_session-id
          ttl: 0s
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: istio-ingressgateway
spec:
  hosts:
  - "myshop-1.demo"
  gateways:
  - demo-01/frontend-gateway
  http:
  - match:
    - uri:
        prefix: /
    route:
    - destination:
        host: istio-ingressgateway
```



## 每个微服务都更新

### flagger

#### 金丝雀发布

canary-whole-jsq.yaml

kubectl apply -f canary-whole-jsq.yaml -n demo-01

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: frontend
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: frontend-v1
  service:
    port: 80
    targetPort: 8080
    gateways:
    - demo-01/frontend-gateway
    hosts:
    - "*"
    trafficPolicy:
      loadBalancer:
        consistentHash:
          httpCookie:
            name: shop_session-id
            ttl: 0s
  analysis:
    interval: 1m
    threshold: 3
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
```





```
kubectl -n demo-01 edit deployment frontend-v1

image:
frontend:v0.3.6
pod label:
line: front-v2

image:
frontend:v0.2.1
pod label:
line: front-v1


执行请求：
go-stress-testing -n 1000000 -c 5 -u http://192.168.229.128:30247/

kubectl describe canary frontend -n demo-01


```

kubectl delete canary frontend -n demo-01



#### 蓝绿发布

canary-whole-bluegreen.yaml

kubectl apply -f canary-whole-bluegreen.yaml -n demo-01

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: frontend
spec:
  revertOnDeletion: true
  provider: istio
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: frontend-v1
  progressDeadlineSeconds: 60
  service:
    port: 80
    targetPort: 8080
    gateways:
    - demo-01/frontend-gateway
    hosts:
    - "myshop-1.demo"
    trafficPolicy:
      loadBalancer:
        consistentHash:
          httpCookie:
            name: shop_session-id
            ttl: 0s
  analysis:
    interval: 30s
    threshold: 10
    iterations: 5
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 30s
```



vs-frontend-canary.yaml

kubectl apply -f vs-frontend-canary.yaml -n demo-01

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: frontend-canary
spec:
  gateways:
  - frontend-gateway
  hosts:
  - "myshop-2.demo"
  http:
  - route:
    - destination:
        host: frontend-v1-canary
        port:
          number: 80
```





```
kubectl -n demo-01 edit deployment frontend-v1

image:
frontend:v0.3.6
pod label:
line: front-v2

image:
frontend:v0.2.1
pod label:
line: front-v1

执行请求：
go-stress-testing -n 1000000 -c 5 -u http://192.168.229.128:30247/

kubectl describe canary frontend -n demo-01

```

kubectl delete canary frontend -n demo-01

kubectl delete vs  frontend-canary -n demo-01



### argo-rollout

#### 金丝雀发布

argo-AnalysisTemplate-frontend.yaml

kubectl apply -f argo-AnalysisTemplate-frontend.yaml -n demo-01

```
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: success-rate
spec:
  args:
  - name: service-name
  metrics:
  - name: success-rate
    interval: 60s
    count: 5
    successCondition: result[0] >= 0.50
    failureLimit: 3
    provider:
      prometheus:
        address: http://prometheus.istio-system:9090
        query: |
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}",response_code!~"5.*"}[5m]
          )) / 
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}"}[5m]
          ))
```

rollout-canary-frontend-analysis-outside.yaml

kubectl apply -f rollout-canary-frontend-analysis-outside.yaml -n demo-01

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: frontend-v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: frontend
      version: v1
  template:
    metadata:
      labels:
        app: frontend
        version: v1
        line: front-v1
      annotations:
        sidecar.istio.io/userVolumeMount: '[{"name":"wasm", "mountPath":"/var/local/lib/wasm-filters", "readonly":true}]'
        sidecar.istio.io/userVolume: '[{"name":"wasm", "configmap":{"name":"wasm"}}]'
        sidecar.istio.io/rewriteAppHTTPProbers: "true"
    spec:
      serviceAccountName: default
      containers:
        - name: server
          image: alexshu/frontend:v0.2.1
          ports:
          - containerPort: 8080
          readinessProbe:
            initialDelaySeconds: 10
            httpGet:
              path: "/_healthz"
              port: 8080
              httpHeaders:
              - name: "Cookie"
                value: "shop_session-id=x-readiness-probe"
          livenessProbe:
            initialDelaySeconds: 10
            httpGet:
              path: "/_healthz"
              port: 8080
              httpHeaders:
              - name: "Cookie"
                value: "shop_session-id=x-liveness-probe"
          env:
          - name: PORT
            value: "8080"
          - name: PRODUCT_CATALOG_SERVICE_ADDR
            value: "productcatalogservice:3550"
          - name: CURRENCY_SERVICE_ADDR
            value: "currencyservice:7000"
          - name: CART_SERVICE_ADDR
            value: "cartservice:7070"
          - name: RECOMMENDATION_SERVICE_ADDR
            value: "recommendationservice:8080"
          - name: SHIPPING_SERVICE_ADDR
            value: "shippingservice:50051"
          - name: CHECKOUT_SERVICE_ADDR
            value: "checkoutservice:5050"
          - name: AD_SERVICE_ADDR
            value: "adservice:9555"
          - name: ENV_PLATFORM
            value: "gcp"
          # - name: DISABLE_TRACING
          #   value: "1"
          # - name: DISABLE_PROFILER
          #   value: "1"
          # - name: JAEGER_SERVICE_ADDR
          #   value: "jaeger-collector:14268"
  strategy:
    canary:
      canaryMetadata:
        labels:
          canary: canary
      stableMetadata:
        labels:
          stable: stable 
      trafficRouting:
        istio:
          virtualService:
            name: frontend-vs
            routes:
            - http-primary
          destinationRule:
            name: frontend
            canarySubsetName: v2
            stableSubsetName: v1
      analysis:
        startingStep: 1
        templates:
        - templateName: success-rate
          clusterScope: false
        args:
        - name: service-name
          value: frontend.demo-01.svc.cluster.local
      steps:
      - setWeight: 20
      - pause: {}
      - setWeight: 40
      - pause: {duration: 10}
      - setWeight: 60
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
      
```

argo-vs-frontend-subset.yaml

kubectl apply -f argo-vs-frontend-subset.yaml -n demo-01

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: frontend-vs
spec:
  gateways:
  - demo-01/frontend-gateway
  hosts:
  - "*"
  http:
  - name: http-primary
    route:
    - destination:
        host: frontend
        subset: v1
        port: 
          number: 80
      weight: 100
    - destination:
        host: frontend
        subset: v2
        port: 
          number: 80
      weight: 0
```

dr-frontend.yaml

kubectl apply -f dr-frontend.yaml -n demo-01

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: frontend
spec:
  host: frontend
  trafficPolicy:
    loadBalancer:
      consistentHash:
        httpCookie:
          name: shop_session-id
          ttl: 0s
  subsets:
  - name: v1
    labels:
      stable: stable
  - name: v2
    labels:
      canary: canary
```



```
kubectl -n demo-01 edit rollout frontend-v1

image:
frontend:v0.3.6
pod label:
line: front-v2

image:
frontend:v0.2.1
pod label:
line: front-v1

执行请求：
go-stress-testing -n 1000000 -c 5 -u http://192.168.229.128:30247/

kubectl argo rollouts promote frontend-v1 -n demo-01 


kubectl argo rollouts get rollout frontend-v1 -w -n demo-01

Name:            frontend-v1
Namespace:       demo-01
Status:          ✔ Healthy
Strategy:        Canary
  Step:          8/8
  SetWeight:     100
  ActualWeight:  100
Images:          alexshu/frontend:v0.2.1
                 alexshu/frontend:v0.3.6 (stable)
Replicas:
  Desired:       1
  Current:       2
  Updated:       1
  Ready:         2
  Available:     2

NAME                                     KIND         STATUS        AGE    INFO
⟳ frontend-v1                            Rollout      ✔ Healthy     11m    
├──# revision:4                                                            
│  ├──⧉ frontend-v1-5ccdc99fbb           ReplicaSet   ✔ Healthy     5m18s  stable
│  │  └──□ frontend-v1-5ccdc99fbb-z8ltn  Pod          ✔ Running     93s    ready:2/2
│  └──α frontend-v1-5ccdc99fbb-4         AnalysisRun  ✔ Successful  73s    ✔ 2
├──# revision:3                                                            
│  └──⧉ frontend-v1-587544bdb5           ReplicaSet   ✔ Healthy     11m    delay:27s
│     └──□ frontend-v1-587544bdb5-67mnp  Pod          ✔ Running     11m    ready:2/2
```



kubectl delete AnalysisTemplate success-rate -n demo-01

kubectl delete rollout frontend-v1 -n demo-01

kubectl delete vs  frontend-vs -n demo-01

kubectl delete dr frontend -n demo-01

dr-frontend-original.yaml

kubectl apply -f dr-frontend-original.yaml -n demo-01

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: frontend
spec:
  host: frontend
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
```





#### 蓝绿发布

bg-frontend-postPromotionAnalysis.yaml

kubectl apply -f bg-frontend-postPromotionAnalysis.yaml -n demo-01

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: frontend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: frontend
      version: v1
  template:
    metadata:
      labels:
        app: frontend
        version: v1
        line: front-v1
      annotations:
        sidecar.istio.io/userVolumeMount: '[{"name":"wasm", "mountPath":"/var/local/lib/wasm-filters", "readonly":true}]'
        sidecar.istio.io/userVolume: '[{"name":"wasm", "configmap":{"name":"wasm"}}]'
        sidecar.istio.io/rewriteAppHTTPProbers: "true"
    spec:
      serviceAccountName: default
      containers:
        - name: server
          image: alexshu/frontend:v0.2.1
          ports:
          - containerPort: 8080
          readinessProbe:
            initialDelaySeconds: 10
            httpGet:
              path: "/_healthz"
              port: 8080
              httpHeaders:
              - name: "Cookie"
                value: "shop_session-id=x-readiness-probe"
          livenessProbe:
            initialDelaySeconds: 10
            httpGet:
              path: "/_healthz"
              port: 8080
              httpHeaders:
              - name: "Cookie"
                value: "shop_session-id=x-liveness-probe"
          env:
          - name: PORT
            value: "8080"
          - name: PRODUCT_CATALOG_SERVICE_ADDR
            value: "productcatalogservice:3550"
          - name: CURRENCY_SERVICE_ADDR
            value: "currencyservice:7000"
          - name: CART_SERVICE_ADDR
            value: "cartservice:7070"
          - name: RECOMMENDATION_SERVICE_ADDR
            value: "recommendationservice:8080"
          - name: SHIPPING_SERVICE_ADDR
            value: "shippingservice:50051"
          - name: CHECKOUT_SERVICE_ADDR
            value: "checkoutservice:5050"
          - name: AD_SERVICE_ADDR
            value: "adservice:9555"
          - name: ENV_PLATFORM
            value: "gcp"
          # - name: DISABLE_TRACING
          #   value: "1"
          # - name: DISABLE_PROFILER
          #   value: "1"
          # - name: JAEGER_SERVICE_ADDR
          #   value: "jaeger-collector:14268"
  strategy:
    blueGreen: 
      activeService: rollout-bluegreen-active
      previewService: rollout-bluegreen-preview
      prePromotionAnalysis:
        templates:
        - templateName: success-rate
          clusterScope: false
        args:
        - name: service-name
          value: rollout-bluegreen-preview.demo-01.svc.cluster.local
      postPromotionAnalysis:
        templates:
        - templateName: success-rate
          clusterScope: false
        args:
        - name: service-name
          value: rollout-bluegreen-active.demo-01.svc.cluster.local      
```

argo-AnalysisTemplate-frontend.yaml

kubectl apply -f argo-AnalysisTemplate-frontend.yaml -n demo-01

```
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: success-rate
spec:
  args:
  - name: service-name
  metrics:
  - name: success-rate
    interval: 60s
    count: 5
    successCondition: result[0] >= 0.50
    failureLimit: 3
    provider:
      prometheus:
        address: http://prometheus.istio-system:9090
        query: |
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}",response_code!~"5.*"}[5m]
          )) / 
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}"}[5m]
          ))
```

vs-frontend-preview.yaml

kubectl apply -f vs-frontend-preview.yaml -n demo-01

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: rollout-bluegreen-active
spec:
  gateways:
  - frontend-gateway
  hosts:
  - "myshop-1.demo"
  http:
  - route:
    - destination:
        host: rollout-bluegreen-active
        port:
          number: 8080
---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: rollout-bluegreen-preview
spec:
  gateways:
  - frontend-gateway
  hosts:
  - "myshop-2.demo"
  http:
  - route:
    - destination:
        host: rollout-bluegreen-preview
        port:
          number: 8080
```



svc-rollout-bluegreen-active.yaml

kubectl apply -f svc-rollout-bluegreen-active.yaml -n demo-01

```
apiVersion: v1
kind: Service
metadata:
  name: rollout-bluegreen-active
spec:
  ports:
  - name: http
    port: 8080
    protocol: TCP
    targetPort: 8080
  selector:
    app: frontend
```

svc-rollout-bluegreen-preview.yaml

kubectl apply -f svc-rollout-bluegreen-preview.yaml -n demo-01

```
apiVersion: v1
kind: Service
metadata:
  name: rollout-bluegreen-preview
spec:
  ports:
  - name: http
    port: 8080
    protocol: TCP
    targetPort: 8080
  selector:
    app: frontend
```



```
kubectl -n demo-01 edit rollout frontend

image:
frontend:v0.3.6
pod label:
line: front-v2

image:
frontend:v0.2.1
pod label:
line: front-v1

执行请求：
go-stress-testing -n 1000000 -c 5 -u http://192.168.229.128:30247/
go-stress-testing -n 1000000 -c 5 -u http://192.168.229.128:30247/?test=test

kubectl argo rollouts promote frontend-v1 -n demo-01 


kubectl argo rollouts get rollout frontend -w -n demo-01

Name:            frontend
Namespace:       demo-01
Status:          ◌ Progressing
Message:         waiting for analysis to complete
Strategy:        BlueGreen
Images:          alexshu/frontend:v0.2.1 (stable)
                 alexshu/frontend:v0.3.6 (active)
Replicas:
  Desired:       1
  Current:       2
  Updated:       1
  Ready:         1
  Available:     1

NAME                                  KIND         STATUS         AGE    INFO
⟳ frontend                            Rollout      ◌ Progressing  9m27s  
├──# revision:2                                                          
│  ├──⧉ frontend-5ccdc99fbb           ReplicaSet   ✔ Healthy      7m33s  active
│  │  └──□ frontend-5ccdc99fbb-m967d  Pod          ✔ Running      7m32s  ready:2/2
│  ├──α frontend-5ccdc99fbb-2-pre     AnalysisRun  ✔ Successful   7m12s  ✔ 5,⚠ 2
│  └──α frontend-5ccdc99fbb-2-post    AnalysisRun  ◌ Running      2m52s  ✔ 3
└──# revision:1                                                          
   └──⧉ frontend-587544bdb5           ReplicaSet   ✔ Healthy      9m27s  stable
      └──□ frontend-587544bdb5-sjdpn  Pod          ✔ Running      9m27s  ready:2/2
```



kubectl delete AnalysisTemplate success-rate -n demo-01

kubectl delete rollout frontend -n demo-01

kubectl delete vs rollout-bluegreen-preview -n demo-01

kubectl delete vs rollout-bluegreen-active -n demo-01

kubectl delete svc rollout-bluegreen-active -n demo-01

kubectl delete svc rollout-bluegreen-preview -n demo-01



## 部分微服务更新

更新：checkoutservice，recommendationservice，paymentservice

假设checkoutservice和paymentservice有依赖性，必须同时使用新的版本

![architecture-diagram](images\architecture-diagram.png)

vs-part.yaml

kubectl apply -f vs-part.yaml -n demo-01

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: emailservice
spec:
  hosts:
  - "emailservice"
  http:
  - route:
    - destination:
        host: emailservice
        subset: v1
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: paymentservice
spec:
  hosts:
  - "paymentservice"
  http:
  - match:
    - headers:
        version:
          exact: v2
      uri:
        prefix: /
    route:
    - destination:
        host: paymentservice
        subset: v2
  - match:
    - headers:
        version:
          exact: v1
      uri:
        prefix: /
    route:
    - destination:
        host: paymentservice
        subset: v1
  - route:
    - destination:
        host: paymentservice
        subset: v1
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: productcatalogservice
spec:
  hosts:
  - "productcatalogservice"
  http:
  - route:
    - destination:
        host: productcatalogservice
        subset: v1
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: cartservice
spec:
  hosts:
  - "cartservice"
  http:
  - route:
    - destination:
        host: cartservice
        subset: v1
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: currencyservice
spec:
  hosts:
  - "currencyservice"
  http:
  - route:
    - destination:
        host: currencyservice
        subset: v1
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: shippingservice
spec:
  hosts:
  - "shippingservice"
  http:
  - route:
    - destination:
        host: shippingservice
        subset: v1
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: redis-cart
spec:
  hosts:
  - "redis-cart"
  http:
  - route:
    - destination:
        host: redis-cart
        subset: v1
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: adservice
spec:
  hosts:
  - "adservice"
  http:
  - route:
    - destination:
        host: adservice
        subset: v1
---
```



paymentservice-deploy.yaml

kubectl apply -f paymentservice-deploy.yaml -n demo-01

```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: paymentservice-v2
spec:
  selector:
    matchLabels:
      app: paymentservice
      version: v2
  template:
    metadata:
      labels:
        app: paymentservice
        version: v2
        line: v2
      annotations:
        sidecar.istio.io/userVolumeMount: '[{"name":"wasm", "mountPath":"/var/local/lib/wasm-filters", "readonly":true},{"name":"wasm-2", "mountPath":"/var/local/lib/wasm-filters-2", "readonly":true},{"name":"wasm-3", "mountPath":"/var/local/lib/wasm-filters-3", "readonly":true}]'
        sidecar.istio.io/userVolume: '[{"name":"wasm", "configmap":{"name":"wasm"}},{"name":"wasm-2", "configmap":{"name":"wasm-2"}},{"name":"wasm-3", "configmap":{"name":"wasm-3"}}]'
    spec:
      serviceAccountName: default
      terminationGracePeriodSeconds: 5
      containers:
      - name: server
        image: alexshu/paymentservice:v0.3.6
        ports:
        - containerPort: 50051
        env:
        - name: PORT
          value: "50051"
        - name: DISABLE_TRACING
          value: "1"
        - name: DISABLE_PROFILER
          value: "1"
        - name: DISABLE_DEBUGGER
          value: "1"
        readinessProbe:
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:50051"]
        livenessProbe:
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:50051"]


```



### 金丝雀发布

#### flagger

kubectl delete -f ef.yaml -n demo-01



ef-part-checkoutservice.yaml

kubectl apply -f ef-part-checkoutservice.yaml -n demo-01

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: request-header-v1
spec:
  workloadSelector:
    labels:
      app: checkoutservice
      version: v1
      line: v1
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.router
    patch:
      operation: INSERT_BEFORE
      value:
        name: istio.stats
        typed_config:
          '@type': type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              configuration:
                '@type': type.googleapis.com/google.protobuf.StringValue
                value: |
                  {
                    "header_key":"version",
                    "header_value":"v1"
                  }
              root_id: version_v1
              vm_config:
                allow_precompiled: true
                code:
                  local:
                    filename: /var/local/lib/wasm-filters/request_header.wasm
                runtime: envoy.wasm.runtime.v8
                vm_id: version_v1
---
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: request-header-v2
spec:
  workloadSelector:
    labels:
      app: checkoutservice
      version: v1
      line: v2
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.router
    patch:
      operation: INSERT_BEFORE
      value:
        name: istio.stats
        typed_config:
          '@type': type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              configuration:
                '@type': type.googleapis.com/google.protobuf.StringValue
                value: |
                  {
                    "header_key":"version",
                    "header_value":"v2"
                  }
              root_id: version_v2
              vm_config:
                allow_precompiled: true
                code:
                  local:
                    filename: /var/local/lib/wasm-filters/request_header.wasm
                runtime: envoy.wasm.runtime.v8
                vm_id: version_v2

---
```



canary-part-jsq-checkoutservice.yaml

kubectl apply -f canary-part-jsq-checkoutservice.yaml -n demo-01

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: checkoutservice
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: checkoutservice-v1
  service:
    port: 5050
    targetPort: 5050
    portName: grpc
    name: checkoutservice
    hosts:
    - "checkoutservice"
    trafficPolicy:
      loadBalancer:
        consistentHash:
          httpCookie:
            name: shop_session-id
            ttl: 0s
  analysis:
    interval: 1m
    threshold: 3
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
```





```
kubectl -n demo-01 edit deployment checkoutservice-v1

image:
checkoutservice:v0.3.6
line: v2

image:
checkoutservice:v0.2.1
line: v1


执行请求：
go-stress-testing -n 1000000 -c 5 -u http://myshop-1.demo:30247/

kubectl describe canary checkoutservice -n demo-01


```



canary-part-jsq-recommendationservice.yaml

kubectl apply -f canary-part-jsq-recommendationservice.yaml -n demo-01

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: recommendationservice
spec:
  revertOnDeletion: true
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: recommendationservice-v1
  service:
    port: 8080
    targetPort: 8080
    portName: grpc
    name: recommendationservice
    hosts:
    - "recommendationservice"
    trafficPolicy:
      loadBalancer:
        consistentHash:
          httpCookie:
            name: shop_session-id
            ttl: 0s
  analysis:
    interval: 1m
    threshold: 3
    maxWeight: 50
    stepWeight: 20
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
```





```
kubectl -n demo-01 edit deployment recommendationservice-v1

image:
recommendationservice:v0.3.6

image:
recommendationservice:v0.2.1


执行请求：
go-stress-testing -n 1000000 -c 5 -u http://myshop-1.demo:30247/

kubectl describe canary recommendationservice -n demo-01


```



kubectl delete canary checkoutservice -n demo-01

kubectl delete canary recommendationservice -n demo-01





#### argo-rollouts

kubectl delete -f vs-part-bluegreen.yaml -n demo-01

kubectl apply -f vs-part.yaml -n demo-01



kubectl delete -f ef.yaml -n demo-01



ef-part-checkoutservice.yaml

kubectl apply -f ef-part-checkoutservice.yaml -n demo-01

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: request-header-v1
spec:
  workloadSelector:
    labels:
      app: checkoutservice
      version: v1
      line: v1
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.router
    patch:
      operation: INSERT_BEFORE
      value:
        name: istio.stats
        typed_config:
          '@type': type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              configuration:
                '@type': type.googleapis.com/google.protobuf.StringValue
                value: |
                  {
                    "header_key":"version",
                    "header_value":"v1"
                  }
              root_id: version_v1
              vm_config:
                allow_precompiled: true
                code:
                  local:
                    filename: /var/local/lib/wasm-filters/request_header.wasm
                runtime: envoy.wasm.runtime.v8
                vm_id: version_v1
---
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: request-header-v2
spec:
  workloadSelector:
    labels:
      app: checkoutservice
      version: v1
      line: v2
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.router
    patch:
      operation: INSERT_BEFORE
      value:
        name: istio.stats
        typed_config:
          '@type': type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              configuration:
                '@type': type.googleapis.com/google.protobuf.StringValue
                value: |
                  {
                    "header_key":"version",
                    "header_value":"v2"
                  }
              root_id: version_v2
              vm_config:
                allow_precompiled: true
                code:
                  local:
                    filename: /var/local/lib/wasm-filters/request_header.wasm
                runtime: envoy.wasm.runtime.v8
                vm_id: version_v2

---
```

paymentservice-deploy.yaml

kubectl apply -f paymentservice-deploy.yaml -n demo-01

```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: paymentservice-v2
spec:
  selector:
    matchLabels:
      app: paymentservice
      version: v2
  template:
    metadata:
      labels:
        app: paymentservice
        version: v2
        line: v2
      annotations:
        sidecar.istio.io/userVolumeMount: '[{"name":"wasm", "mountPath":"/var/local/lib/wasm-filters", "readonly":true},{"name":"wasm-2", "mountPath":"/var/local/lib/wasm-filters-2", "readonly":true},{"name":"wasm-3", "mountPath":"/var/local/lib/wasm-filters-3", "readonly":true}]'
        sidecar.istio.io/userVolume: '[{"name":"wasm", "configmap":{"name":"wasm"}},{"name":"wasm-2", "configmap":{"name":"wasm-2"}},{"name":"wasm-3", "configmap":{"name":"wasm-3"}}]'
    spec:
      serviceAccountName: default
      terminationGracePeriodSeconds: 5
      containers:
      - name: server
        image: alexshu/paymentservice:v0.3.6
        ports:
        - containerPort: 50051
        env:
        - name: PORT
          value: "50051"
        - name: DISABLE_TRACING
          value: "1"
        - name: DISABLE_PROFILER
          value: "1"
        - name: DISABLE_DEBUGGER
          value: "1"
        readinessProbe:
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:50051"]
        livenessProbe:
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:50051"]


```



argo-AnalysisTemplate-frontend.yaml

kubectl apply -f argo-AnalysisTemplate-frontend.yaml -n demo-01

```
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: success-rate
spec:
  args:
  - name: service-name
  metrics:
  - name: success-rate
    interval: 60s
    count: 5
    successCondition: result[0] >= 0.50
    failureLimit: 3
    provider:
      prometheus:
        address: http://prometheus.istio-system:9090
        query: |
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}",response_code!~"5.*"}[5m]
          )) / 
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}"}[5m]
          ))
```

rollout-canary-checkoutservice-analysis-outside.yaml

kubectl apply -f rollout-canary-checkoutservice-analysis-outside.yaml -n demo-01

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: checkoutservice-v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: checkoutservice
      version: v1
  template:
    metadata:
      labels:
        app: checkoutservice
        version: v1
        line: v1 
      annotations:
        sidecar.istio.io/userVolumeMount: '[{"name":"wasm", "mountPath":"/var/local/lib/wasm-filters", "readonly":true},{"name":"wasm-2", "mountPath":"/var/local/lib/wasm-filters-2", "readonly":true},{"name":"wasm-3", "mountPath":"/var/local/lib/wasm-filters-3", "readonly":true}]'
        sidecar.istio.io/userVolume: '[{"name":"wasm", "configmap":{"name":"wasm"}},{"name":"wasm-2", "configmap":{"name":"wasm-2"}},{"name":"wasm-3", "configmap":{"name":"wasm-3"}}]'
    spec:
      serviceAccountName: default
      containers:
        - name: server
          image: alexshu/checkoutservice:v0.2.1
          ports:
          - containerPort: 5050
          readinessProbe:
            exec:
              command: ["/bin/grpc_health_probe", "-addr=:5050"]
          livenessProbe:
            exec:
              command: ["/bin/grpc_health_probe", "-addr=:5050"]
          env:
          - name: PORT
            value: "5050"
          - name: PRODUCT_CATALOG_SERVICE_ADDR
            value: "productcatalogservice:3550"
          - name: SHIPPING_SERVICE_ADDR
            value: "shippingservice:50051"
          - name: PAYMENT_SERVICE_ADDR
            value: "paymentservice:50051"
          - name: EMAIL_SERVICE_ADDR
            value: "emailservice:5000"
          - name: CURRENCY_SERVICE_ADDR
            value: "currencyservice:7000"
          - name: CART_SERVICE_ADDR
            value: "cartservice:7070"
          # - name: DISABLE_STATS
          #   value: "1"
          # - name: DISABLE_TRACING
          #   value: "1"
          # - name: DISABLE_PROFILER
          #   value: "1"
          # - name: JAEGER_SERVICE_ADDR
          #   value: "jaeger-collector:14268"
  strategy:
    canary:
      canaryMetadata:
        labels:
          canary: canary
      stableMetadata:
        labels:
          stable: stable 
      trafficRouting:
        istio:
          virtualService:
            name: checkoutservice-vs
            routes:
            - http-primary
          destinationRule:
            name: checkoutservice
            canarySubsetName: v2
            stableSubsetName: v1
      analysis:
        startingStep: 1
        templates:
        - templateName: success-rate
          clusterScope: false
        args:
        - name: service-name
          value: checkoutservice.demo-01.svc.cluster.local
      steps:
      - setWeight: 20
      - pause: {}
      - setWeight: 40
      - pause: {duration: 10}
      - setWeight: 60
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
      
```

argo-vs-checkoutservice-subset.yaml

kubectl apply -f argo-vs-checkoutservice-subset.yaml -n demo-01

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: checkoutservice-vs
spec:
  hosts:
  - "checkoutservice"
  http:
  - name: http-primary
    route:
    - destination:
        host: checkoutservice
        subset: v1
        port: 
          number: 5050
      weight: 100
    - destination:
        host: checkoutservice
        subset: v2
        port: 
          number: 5050
      weight: 0
```

dr-checkoutservice.yaml

kubectl apply -f dr-checkoutservice.yaml -n demo-01

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: checkoutservice
spec:
  host: checkoutservice
  trafficPolicy:
    loadBalancer:
      consistentHash:
        httpCookie:
          name: shop_session-id
          ttl: 0s
  subsets:
  - name: v1
    labels:
      stable: stable
  - name: v2
    labels:
      canary: canary
```



```
kubectl -n demo-01 edit deployment checkoutservice-v1

image:
checkoutservice:v0.3.6
line: v2

image:
checkoutservice:v0.2.1
line: v1


执行请求：
go-stress-testing -n 1000000 -c 5 -u http://myshop-1.demo:30247/

kubectl argo rollouts promote checkoutservice-v1 -n demo-01 


kubectl argo rollouts get rollout checkoutservice-v1 -w -n demo-01
```



rollout-canary-recommendationservice-analysis-outside.yaml

kubectl apply -f rollout-canary-recommendationservice-analysis-outside.yaml -n demo-01

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: recommendationservice-v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: recommendationservice
      version: v1
  template:
    metadata:
      labels:
        app: recommendationservice
        version: v1
        line: v1 
      annotations:
        sidecar.istio.io/userVolumeMount: '[{"name":"wasm", "mountPath":"/var/local/lib/wasm-filters", "readonly":true},{"name":"wasm-2", "mountPath":"/var/local/lib/wasm-filters-2", "readonly":true},{"name":"wasm-3", "mountPath":"/var/local/lib/wasm-filters-3", "readonly":true}]'
        sidecar.istio.io/userVolume: '[{"name":"wasm", "configmap":{"name":"wasm"}},{"name":"wasm-2", "configmap":{"name":"wasm-2"}},{"name":"wasm-3", "configmap":{"name":"wasm-3"}}]'
    spec:
      terminationGracePeriodSeconds: 5
      containers:
      - name: server
        image: alexshu/recommendationservice:v0.2.1
        ports:
        - containerPort: 8080
        readinessProbe:
          periodSeconds: 5
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:8080"]
        livenessProbe:
          periodSeconds: 5
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:8080"]
        env:
        - name: PORT
          value: "8080"
        - name: PRODUCT_CATALOG_SERVICE_ADDR
          value: "productcatalogservice:3550"
        # - name: DISABLE_TRACING
        #   value: "1"
        # - name: DISABLE_PROFILER
        #   value: "1"
        # - name: DISABLE_DEBUGGER
        #   value: "1"
  strategy:
    canary:
      canaryMetadata:
        labels:
          canary: canary
      stableMetadata:
        labels:
          stable: stable 
      trafficRouting:
        istio:
          virtualService:
            name: recommendationservice-vs
            routes:
            - http-primary
          destinationRule:
            name: recommendationservice
            canarySubsetName: v2
            stableSubsetName: v1
      analysis:
        startingStep: 1
        templates:
        - templateName: success-rate
          clusterScope: false
        args:
        - name: service-name
          value: recommendationservice.demo-01.svc.cluster.local
      steps:
      - setWeight: 20
      - pause: {}
      - setWeight: 40
      - pause: {duration: 10}
      - setWeight: 60
      - pause: {duration: 10}
      - setWeight: 80
      - pause: {duration: 10}
      
```

argo-vs-recommendationservice-subset.yaml

kubectl apply -f argo-vs-recommendationservice-subset.yaml -n demo-01

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: recommendationservice-vs
spec:
  hosts:
  - "recommendationservice"
  http:
  - name: http-primary
    route:
    - destination:
        host: recommendationservice
        subset: v1
        port: 
          number: 8080
      weight: 100
    - destination:
        host: recommendationservice
        subset: v2
        port: 
          number: 8080
      weight: 0
```

dr-recommendationservice.yaml

kubectl apply -f dr-recommendationservice.yaml -n demo-01

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: recommendationservice
spec:
  host: recommendationservice
  trafficPolicy:
    loadBalancer:
      consistentHash:
        httpCookie:
          name: shop_session-id
          ttl: 0s
  subsets:
  - name: v1
    labels:
      stable: stable
  - name: v2
    labels:
      canary: canary
```



```
kubectl -n demo-01 edit rollout recommendationservice-v1

image:
recommendationservice:v0.3.6

image:
recommendationservice:v0.2.1


执行请求：
go-stress-testing -n 1000000 -c 5 -u http://myshop-1.demo:30247/

kubectl argo rollouts promote recommendationservice-v1 -n demo-01 


kubectl argo rollouts get rollout recommendationservice-v1 -w -n demo-01
```



kubectl delete  -f ef-part-checkoutservice.yaml -n demo-01

kubectl delete AnalysisTemplate success-rate -n demo-01

kubectl delete rollout checkoutservice-v1 -n demo-01

kubectl delete vs checkoutservice-vs -n demo-01

kubectl delete dr checkoutservice -n demo-01

kubectl delete rollout recommendationservice-v1 -n demo-01

kubectl delete vs recommendationservice-vs -n demo-01

kubectl delete dr recommendationservice -n demo-01

kubectl apply -f dr.yaml -n demo-01



### 蓝绿发布

#### flagger

vs-part-bluegreen.yaml

kubectl apply -f vs-part-bluegreen.yaml -n demo-01

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: emailservice
spec:
  hosts:
  - "emailservice"
  http:
  - route:
    - destination:
        host: emailservice
        subset: v1
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: checkout
spec:
  hosts:
  - "checkoutservice"
  http:
  - match:
    - headers:
        version:
          exact: v2
      uri:
        prefix: /
    route:
    - destination:
        host: checkoutservice-canary
  - match:
    - headers:
        version:
          exact: v1
      uri:
        prefix: /
    delegate:
      name: checkoutservice
      namespace: demo-01
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: recommendation
spec:
  hosts:
  - "recommendationservice"
  http:
  - match:
    - headers:
        version:
          exact: v2
      uri:
        prefix: /
    route:
    - destination:
        host: recommendationservice-canary
  - match:
    - headers:
        version:
          exact: v1
      uri:
        prefix: /
    delegate:
      name: recommendationservice
      namespace: demo-01
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: payment
spec:
  hosts:
  - "paymentservice"
  http:
  - match:
    - headers:
        version:
          exact: v2
      uri:
        prefix: /
    route:
    - destination:
        host: paymentservice-canary
  - match:
    - headers:
        version:
          exact: v1
      uri:
        prefix: /
    delegate:
      name: paymentservice
      namespace: demo-01
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: productcatalogservice
spec:
  hosts:
  - "productcatalogservice"
  http:
  - route:
    - destination:
        host: productcatalogservice
        subset: v1
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: cartservice
spec:
  hosts:
  - "cartservice"
  http:
  - route:
    - destination:
        host: cartservice
        subset: v1
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: currencyservice
spec:
  hosts:
  - "currencyservice"
  http:
  - route:
    - destination:
        host: currencyservice
        subset: v1
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: shippingservice
spec:
  hosts:
  - "shippingservice"
  http:
  - route:
    - destination:
        host: shippingservice
        subset: v1
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: redis-cart
spec:
  hosts:
  - "redis-cart"
  http:
  - route:
    - destination:
        host: redis-cart
        subset: v1
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: adservice
spec:
  hosts:
  - "adservice"
  http:
  - route:
    - destination:
        host: adservice
        subset: v1
---
```



kubectl delete -f ef-part-checkoutservice.yaml -n demo-01

kubectl apply -f ef.yaml -n demo-01



vs-frontend-canary.yaml

kubectl apply -f vs-frontend-canary.yaml -n demo-01

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: frontend-canary
spec:
  gateways:
  - frontend-gateway
  hosts:
  - "myshop-2.demo"
  http:
  - route:
    - destination:
        host: frontend-v1-canary
        port:
          number: 80
```





deploy-frontend-v2.yaml

kubectl apply -f deploy-frontend-v2.yaml -n demo-01

```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend-v2
spec:
  selector:
    matchLabels:
      app: frontend
      version: v2
  template:
    metadata:
      labels:
        app: frontend
        version: v2
        line: front-v2
      annotations:
        sidecar.istio.io/userVolumeMount: '[{"name":"wasm", "mountPath":"/var/local/lib/wasm-filters", "readonly":true}]'
        sidecar.istio.io/userVolume: '[{"name":"wasm", "configmap":{"name":"wasm"}}]'
        sidecar.istio.io/rewriteAppHTTPProbers: "true"
    spec:
      serviceAccountName: default
      containers:
        - name: server
          image: alexshu/frontend:v0.2.1
          ports:
          - containerPort: 8080
          readinessProbe:
            initialDelaySeconds: 10
            httpGet:
              path: "/_healthz"
              port: 8080
              httpHeaders:
              - name: "Cookie"
                value: "shop_session-id=x-readiness-probe"
          livenessProbe:
            initialDelaySeconds: 10
            httpGet:
              path: "/_healthz"
              port: 8080
              httpHeaders:
              - name: "Cookie"
                value: "shop_session-id=x-liveness-probe"
          env:
          - name: PORT
            value: "8080"
          - name: PRODUCT_CATALOG_SERVICE_ADDR
            value: "productcatalogservice:3550"
          - name: CURRENCY_SERVICE_ADDR
            value: "currencyservice:7000"
          - name: CART_SERVICE_ADDR
            value: "cartservice:7070"
          - name: RECOMMENDATION_SERVICE_ADDR
            value: "recommendationservice:8080"
          - name: SHIPPING_SERVICE_ADDR
            value: "shippingservice:50051"
          - name: CHECKOUT_SERVICE_ADDR
            value: "checkoutservice:5050"
          - name: AD_SERVICE_ADDR
            value: "adservice:9555"
          # # ENV_PLATFORM: One of: local, gcp, aws, azure, onprem, alibaba
          # # When not set, defaults to "local" unless running in GKE, otherwies auto-sets to gcp 
          # - name: ENV_PLATFORM 
          #   value: "aws"
          - name: DISABLE_TRACING
            value: "1"
          - name: DISABLE_PROFILER
            value: "1"
          # - name: JAEGER_SERVICE_ADDR
          #   value: "jaeger-collector:14268"
          # - name: CYMBAL_BRANDING
          #   value: "true"
```



canary-part-bluegreen-checkoutservice.yaml

kubectl apply -f canary-part-bluegreen-checkoutservice.yaml -n demo-01

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: checkoutservice
spec:
  revertOnDeletion: true
  provider: istio
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: checkoutservice-v1
  progressDeadlineSeconds: 60
  service:
    delegation: true
    name: checkoutservice
    port: 5050
    portName: grpc
    targetPort: 5050
    trafficPolicy:
      loadBalancer:
        consistentHash:
          httpCookie:
            name: shop_session-id
            ttl: 0s
  analysis:
    interval: 30s
    threshold: 10
    iterations: 5
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 30s
```



```
kubectl -n demo-01 edit rollout checkoutservice-v1

image:
checkoutservice:v0.3.6
line: v2

image:
checkoutservice:v0.2.1
line: v1


执行请求：
go-stress-testing -n 1000000 -c 5 -u http://myshop-1.demo:30247/

kubectl describe canary checkoutservice -n demo-01
```



canary-part-bluegreen-recommendationservice.yaml

kubectl apply -f canary-part-bluegreen-recommendationservice.yaml -n demo-01

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: recommendationservice
spec:
  revertOnDeletion: true
  provider: istio
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: recommendationservice-v1
  progressDeadlineSeconds: 60
  service:
    delegation: true
    name: recommendationservice
    port: 8080
    targetPort: 8080
    portName: grpc
    trafficPolicy:
      loadBalancer:
        consistentHash:
          httpCookie:
            name: shop_session-id
            ttl: 0s
  analysis:
    interval: 30s
    threshold: 10
    iterations: 5
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 30s
```



```
kubectl -n demo-01 edit deployment recommendationservice-v1

image:
recommendationservice:v0.3.6
label:
line: v2

image:
recommendationservice:v0.2.1
label:
line: v1

执行请求：
go-stress-testing -n 1000000 -c 5 -u http://myshop-1.demo:30247/

kubectl describe canary recommendationservice -n demo-01
```



canary-part-bluegreen-paymentservice.yaml

kubectl apply -f canary-part-bluegreen-paymentservice.yaml -n demo-01

```
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: paymentservice
spec:
  revertOnDeletion: true
  provider: istio
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: paymentservice-v1
  progressDeadlineSeconds: 60
  service:
    delegation: true
    name: paymentservice
    portName: grpc
    port: 50051
    targetPort: 50051
    trafficPolicy:
      loadBalancer:
        consistentHash:
          httpCookie:
            name: shop_session-id
            ttl: 0s
  analysis:
    interval: 30s
    threshold: 10
    iterations: 5
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 30s
```



```
kubectl -n demo-01 edit deployment paymentservice-v1

image:
paymentservice:v0.3.6
label:
line: v2

image:
paymentservice:v0.2.1
label:
line: v1

执行请求：
go-stress-testing -n 1000000 -c 5 -u http://myshop-1.demo:30247/

kubectl describe canary paymentservice -n demo-01
```



kubectl delete canary paymentservice -n demo-01

kubectl delete canary recommendationservice -n demo-01

kubectl delete canary checkoutservice -n demo-01

kubectl delete canary frontend -n demo-01



**需要注意的是promotion需要手动控制**

难题，如何整体回滚



#### argo-rollouts

deploy-payment-v1.yaml

kubectl apply -f deploy-payment-v1.yaml -n demo-01

```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: paymentservice-v1
spec:
  selector:
    matchLabels:
      app: paymentservice
      version: v1
  template:
    metadata:
      labels:
        app: paymentservice
        version: v1
        line: v1 
      annotations:
        sidecar.istio.io/userVolumeMount: '[{"name":"wasm", "mountPath":"/var/local/lib/wasm-filters", "readonly":true},{"name":"wasm-2", "mountPath":"/var/local/lib/wasm-filters-2", "readonly":true},{"name":"wasm-3", "mountPath":"/var/local/lib/wasm-filters-3", "readonly":true}]'
        sidecar.istio.io/userVolume: '[{"name":"wasm", "configmap":{"name":"wasm"}},{"name":"wasm-2", "configmap":{"name":"wasm-2"}},{"name":"wasm-3", "configmap":{"name":"wasm-3"}}]'
    spec:
      serviceAccountName: default
      terminationGracePeriodSeconds: 5
      containers:
      - name: server
        image: alexshu/paymentservice:v0.2.1
        ports:
        - containerPort: 50051
        env:
        - name: PORT
          value: "50051"
        readinessProbe:
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:50051"]
        livenessProbe:
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:50051"]
```

deploy-frontend-v2.yaml

kubectl apply -f deploy-frontend-v2.yaml -n demo-01

```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend-v2
spec:
  selector:
    matchLabels:
      app: frontend
      version: v2
  template:
    metadata:
      labels:
        app: frontend
        version: v2
        line: front-v2
      annotations:
        sidecar.istio.io/userVolumeMount: '[{"name":"wasm", "mountPath":"/var/local/lib/wasm-filters", "readonly":true}]'
        sidecar.istio.io/userVolume: '[{"name":"wasm", "configmap":{"name":"wasm"}}]'
        sidecar.istio.io/rewriteAppHTTPProbers: "true"
    spec:
      serviceAccountName: default
      containers:
        - name: server
          image: alexshu/frontend:v0.2.1
          ports:
          - containerPort: 8080
          readinessProbe:
            initialDelaySeconds: 10
            httpGet:
              path: "/_healthz"
              port: 8080
              httpHeaders:
              - name: "Cookie"
                value: "shop_session-id=x-readiness-probe"
          livenessProbe:
            initialDelaySeconds: 10
            httpGet:
              path: "/_healthz"
              port: 8080
              httpHeaders:
              - name: "Cookie"
                value: "shop_session-id=x-liveness-probe"
          env:
          - name: PORT
            value: "8080"
          - name: PRODUCT_CATALOG_SERVICE_ADDR
            value: "productcatalogservice:3550"
          - name: CURRENCY_SERVICE_ADDR
            value: "currencyservice:7000"
          - name: CART_SERVICE_ADDR
            value: "cartservice:7070"
          - name: RECOMMENDATION_SERVICE_ADDR
            value: "recommendationservice:8080"
          - name: SHIPPING_SERVICE_ADDR
            value: "shippingservice:50051"
          - name: CHECKOUT_SERVICE_ADDR
            value: "checkoutservice:5050"
          - name: AD_SERVICE_ADDR
            value: "adservice:9555"
          # # ENV_PLATFORM: One of: local, gcp, aws, azure, onprem, alibaba
          # # When not set, defaults to "local" unless running in GKE, otherwies auto-sets to gcp 
          # - name: ENV_PLATFORM 
          #   value: "aws"
          - name: DISABLE_TRACING
            value: "1"
          - name: DISABLE_PROFILER
            value: "1"
          # - name: JAEGER_SERVICE_ADDR
          #   value: "jaeger-collector:14268"
          # - name: CYMBAL_BRANDING
          #   value: "true"
```



ef-part-bluegreen-argo-rollouts.yaml

kubectl apply -f ef-part-bluegreen-argo-rollouts.yaml -n demo-01

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: request-header-v1
spec:
  workloadSelector:
    labels:
      line: front-v1
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.router
    patch:
      operation: INSERT_BEFORE
      value:
        name: istio.stats
        typed_config:
          '@type': type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              configuration:
                '@type': type.googleapis.com/google.protobuf.StringValue
                value: |
                  {
                    "header_key":"version",
                    "header_value":"v1"
                  }
              root_id: version_v1
              vm_config:
                allow_precompiled: true
                code:
                  local:
                    filename: /var/local/lib/wasm-filters/request_header.wasm
                runtime: envoy.wasm.runtime.v8
                vm_id: version_v1
---
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: request-header-v2
spec:
  workloadSelector:
    labels:
      line: front-v2
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.router
    patch:
      operation: INSERT_BEFORE
      value:
        name: istio.stats
        typed_config:
          '@type': type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              configuration:
                '@type': type.googleapis.com/google.protobuf.StringValue
                value: |
                  {
                    "header_key":"version",
                    "header_value":"v2"
                  }
              root_id: version_v2
              vm_config:
                allow_precompiled: true
                code:
                  local:
                    filename: /var/local/lib/wasm-filters/request_header.wasm
                runtime: envoy.wasm.runtime.v8
                vm_id: version_v2

---
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: request-header-v1-checkoutservice
spec:
  workloadSelector:
    labels:
      app: checkoutservice
      version: v1
      line: v1
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.router
    patch:
      operation: INSERT_BEFORE
      value:
        name: istio.stats
        typed_config:
          '@type': type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              configuration:
                '@type': type.googleapis.com/google.protobuf.StringValue
                value: |
                  {
                    "header_key":"version",
                    "header_value":"v1"
                  }
              root_id: version_v1
              vm_config:
                allow_precompiled: true
                code:
                  local:
                    filename: /var/local/lib/wasm-filters/request_header.wasm
                runtime: envoy.wasm.runtime.v8
                vm_id: version_v1
---
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: request-header-v2-checkoutservice
spec:
  workloadSelector:
    labels:
      app: checkoutservice
      version: v1
      line: v2
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.router
    patch:
      operation: INSERT_BEFORE
      value:
        name: istio.stats
        typed_config:
          '@type': type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              configuration:
                '@type': type.googleapis.com/google.protobuf.StringValue
                value: |
                  {
                    "header_key":"version",
                    "header_value":"v2"
                  }
              root_id: version_v2
              vm_config:
                allow_precompiled: true
                code:
                  local:
                    filename: /var/local/lib/wasm-filters/request_header.wasm
                runtime: envoy.wasm.runtime.v8
                vm_id: version_v2

---
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: request-header-line-v1-emailservice
spec:
  workloadSelector:
    labels:
      app: emailservice
      version: v1
      line: v1 
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_INBOUND
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.router
    patch:
      operation: INSERT_BEFORE
      value:
        name: istio.stats
        typed_config:
          '@type': type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              configuration:
                '@type': type.googleapis.com/google.protobuf.StringValue
                value: |
                  {
                    
                  }
              root_id: inbound_v1
              vm_config:
                allow_precompiled: true
                code:
                  local:
                    filename: /var/local/lib/wasm-filters-2/inbound.wasm
                runtime: envoy.wasm.runtime.v8
                vm_id: inbound_outbound_v1
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.router
    patch:
      operation: INSERT_BEFORE
      value:
        name: istio.stats
        typed_config:
          '@type': type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              configuration:
                '@type': type.googleapis.com/google.protobuf.StringValue
                value: |
                  {
                  }
              root_id: outbound-v1
              vm_config:
                allow_precompiled: true
                code:
                  local:
                    filename: /var/local/lib/wasm-filters-3/outbound.wasm
                runtime: envoy.wasm.runtime.v8
                vm_id: inbound_outbound_v1
---
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: request-header-line-recommendationservice
spec:
  workloadSelector:
    labels:
      app: recommendationservice
      version: v1
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_INBOUND
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.router
    patch:
      operation: INSERT_BEFORE
      value:
        name: istio.stats
        typed_config:
          '@type': type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              configuration:
                '@type': type.googleapis.com/google.protobuf.StringValue
                value: |
                  {
                    
                  }
              root_id: inbound_v1
              vm_config:
                allow_precompiled: true
                code:
                  local:
                    filename: /var/local/lib/wasm-filters-2/inbound.wasm
                runtime: envoy.wasm.runtime.v8
                vm_id: inbound_outbound_v1
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.router
    patch:
      operation: INSERT_BEFORE
      value:
        name: istio.stats
        typed_config:
          '@type': type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              configuration:
                '@type': type.googleapis.com/google.protobuf.StringValue
                value: |
                  {
                  }
              root_id: outbound-v1
              vm_config:
                allow_precompiled: true
                code:
                  local:
                    filename: /var/local/lib/wasm-filters-3/outbound.wasm
                runtime: envoy.wasm.runtime.v8
                vm_id: inbound_outbound_v1
---
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: request-header-line-paymentservice
spec:
  workloadSelector:
    labels:
      app: paymentservice
      version: v1
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_INBOUND
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.router
    patch:
      operation: INSERT_BEFORE
      value:
        name: istio.stats
        typed_config:
          '@type': type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              configuration:
                '@type': type.googleapis.com/google.protobuf.StringValue
                value: |
                  {
                    
                  }
              root_id: inbound_v1
              vm_config:
                allow_precompiled: true
                code:
                  local:
                    filename: /var/local/lib/wasm-filters-2/inbound.wasm
                runtime: envoy.wasm.runtime.v8
                vm_id: inbound_outbound_v1
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.router
    patch:
      operation: INSERT_BEFORE
      value:
        name: istio.stats
        typed_config:
          '@type': type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              configuration:
                '@type': type.googleapis.com/google.protobuf.StringValue
                value: |
                  {
                  }
              root_id: outbound-v1
              vm_config:
                allow_precompiled: true
                code:
                  local:
                    filename: /var/local/lib/wasm-filters-3/outbound.wasm
                runtime: envoy.wasm.runtime.v8
                vm_id: inbound_outbound_v1
---
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: request-header-line-v1-productcatalogservice
spec:
  workloadSelector:
    labels:
      app: productcatalogservice
      version: v1
      line: v1 
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_INBOUND
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.router
    patch:
      operation: INSERT_BEFORE
      value:
        name: istio.stats
        typed_config:
          '@type': type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              configuration:
                '@type': type.googleapis.com/google.protobuf.StringValue
                value: |
                  {
                    
                  }
              root_id: inbound_v1
              vm_config:
                allow_precompiled: true
                code:
                  local:
                    filename: /var/local/lib/wasm-filters-2/inbound.wasm
                runtime: envoy.wasm.runtime.v8
                vm_id: inbound_outbound_v1
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.router
    patch:
      operation: INSERT_BEFORE
      value:
        name: istio.stats
        typed_config:
          '@type': type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              configuration:
                '@type': type.googleapis.com/google.protobuf.StringValue
                value: |
                  {
                  }
              root_id: outbound-v1
              vm_config:
                allow_precompiled: true
                code:
                  local:
                    filename: /var/local/lib/wasm-filters-3/outbound.wasm
                runtime: envoy.wasm.runtime.v8
                vm_id: inbound_outbound_v1
---
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: request-header-line-v1-cartservice
spec:
  workloadSelector:
    labels:
      app: cartservice
      version: v1
      line: v1 
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_INBOUND
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.router
    patch:
      operation: INSERT_BEFORE
      value:
        name: istio.stats
        typed_config:
          '@type': type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              configuration:
                '@type': type.googleapis.com/google.protobuf.StringValue
                value: |
                  {
                    
                  }
              root_id: inbound_v1
              vm_config:
                allow_precompiled: true
                code:
                  local:
                    filename: /var/local/lib/wasm-filters-2/inbound.wasm
                runtime: envoy.wasm.runtime.v8
                vm_id: inbound_outbound_v1
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.router
    patch:
      operation: INSERT_BEFORE
      value:
        name: istio.stats
        typed_config:
          '@type': type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              configuration:
                '@type': type.googleapis.com/google.protobuf.StringValue
                value: |
                  {
                  }
              root_id: outbound-v1
              vm_config:
                allow_precompiled: true
                code:
                  local:
                    filename: /var/local/lib/wasm-filters-3/outbound.wasm
                runtime: envoy.wasm.runtime.v8
                vm_id: inbound_outbound_v1
---
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: request-header-line-v1-currencyservice
spec:
  workloadSelector:
    labels:
      app: currencyservice
      version: v1
      line: v1 
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_INBOUND
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.router
    patch:
      operation: INSERT_BEFORE
      value:
        name: istio.stats
        typed_config:
          '@type': type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              configuration:
                '@type': type.googleapis.com/google.protobuf.StringValue
                value: |
                  {
                    
                  }
              root_id: inbound_v1
              vm_config:
                allow_precompiled: true
                code:
                  local:
                    filename: /var/local/lib/wasm-filters-2/inbound.wasm
                runtime: envoy.wasm.runtime.v8
                vm_id: inbound_outbound_v1
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.router
    patch:
      operation: INSERT_BEFORE
      value:
        name: istio.stats
        typed_config:
          '@type': type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              configuration:
                '@type': type.googleapis.com/google.protobuf.StringValue
                value: |
                  {
                  }
              root_id: outbound-v1
              vm_config:
                allow_precompiled: true
                code:
                  local:
                    filename: /var/local/lib/wasm-filters-3/outbound.wasm
                runtime: envoy.wasm.runtime.v8
                vm_id: inbound_outbound_v1
---
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: request-header-line-v1-shippingservice
spec:
  workloadSelector:
    labels:
      app: shippingservice
      version: v1
      line: v1 
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_INBOUND
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.router
    patch:
      operation: INSERT_BEFORE
      value:
        name: istio.stats
        typed_config:
          '@type': type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              configuration:
                '@type': type.googleapis.com/google.protobuf.StringValue
                value: |
                  {
                    
                  }
              root_id: inbound_v1
              vm_config:
                allow_precompiled: true
                code:
                  local:
                    filename: /var/local/lib/wasm-filters-2/inbound.wasm
                runtime: envoy.wasm.runtime.v8
                vm_id: inbound_outbound_v1
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.router
    patch:
      operation: INSERT_BEFORE
      value:
        name: istio.stats
        typed_config:
          '@type': type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              configuration:
                '@type': type.googleapis.com/google.protobuf.StringValue
                value: |
                  {
                  }
              root_id: outbound-v1
              vm_config:
                allow_precompiled: true
                code:
                  local:
                    filename: /var/local/lib/wasm-filters-3/outbound.wasm
                runtime: envoy.wasm.runtime.v8
                vm_id: inbound_outbound_v1
---
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: request-header-line-v1-redis-cart
spec:
  workloadSelector:
    labels:
      app: redis-cart
      version: v1
      line: v1 
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_INBOUND
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.router
    patch:
      operation: INSERT_BEFORE
      value:
        name: istio.stats
        typed_config:
          '@type': type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              configuration:
                '@type': type.googleapis.com/google.protobuf.StringValue
                value: |
                  {
                    
                  }
              root_id: inbound_v1
              vm_config:
                allow_precompiled: true
                code:
                  local:
                    filename: /var/local/lib/wasm-filters-2/inbound.wasm
                runtime: envoy.wasm.runtime.v8
                vm_id: inbound_outbound_v1
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.router
    patch:
      operation: INSERT_BEFORE
      value:
        name: istio.stats
        typed_config:
          '@type': type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              configuration:
                '@type': type.googleapis.com/google.protobuf.StringValue
                value: |
                  {
                  }
              root_id: outbound-v1
              vm_config:
                allow_precompiled: true
                code:
                  local:
                    filename: /var/local/lib/wasm-filters-3/outbound.wasm
                runtime: envoy.wasm.runtime.v8
                vm_id: inbound_outbound_v1
---
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: request-header-line-v1-adservice
spec:
  workloadSelector:
    labels:
      app: adservice
      version: v1
      line: v1 
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_INBOUND
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.router
    patch:
      operation: INSERT_BEFORE
      value:
        name: istio.stats
        typed_config:
          '@type': type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              configuration:
                '@type': type.googleapis.com/google.protobuf.StringValue
                value: |
                  {
                    
                  }
              root_id: inbound_v1
              vm_config:
                allow_precompiled: true
                code:
                  local:
                    filename: /var/local/lib/wasm-filters-2/inbound.wasm
                runtime: envoy.wasm.runtime.v8
                vm_id: inbound_outbound_v1
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.router
    patch:
      operation: INSERT_BEFORE
      value:
        name: istio.stats
        typed_config:
          '@type': type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              configuration:
                '@type': type.googleapis.com/google.protobuf.StringValue
                value: |
                  {
                  }
              root_id: outbound-v1
              vm_config:
                allow_precompiled: true
                code:
                  local:
                    filename: /var/local/lib/wasm-filters-3/outbound.wasm
                runtime: envoy.wasm.runtime.v8
                vm_id: inbound_outbound_v1
---
```



vs-part-bluegreen-argo.yaml

kubectl apply -f vs-part-bluegreen.yaml -n demo-01

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: emailservice
spec:
  hosts:
  - "emailservice"
  http:
  - route:
    - destination:
        host: emailservice
        subset: v1
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: checkout
spec:
  hosts:
  - "checkoutservice"
  http:
  - match:
    - headers:
        version:
          exact: v2
      uri:
        prefix: /
    route:
    - destination:
        host: checkoutservice-canary
  - match:
    - headers:
        version:
          exact: v1
      uri:
        prefix: /
    route:
    - destination:
        host: checkoutservice-primary
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: recommendation
spec:
  hosts:
  - "recommendationservice"
  http:
  - match:
    - headers:
        version:
          exact: v2
      uri:
        prefix: /
    route:
    - destination:
        host: recommendationservice-canary
  - match:
    - headers:
        version:
          exact: v1
      uri:
        prefix: /
    route:
    - destination:
        host: recommendationservice-primary
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: payment
spec:
  hosts:
  - "paymentservice"
  http:
  - match:
    - headers:
        version:
          exact: v2
      uri:
        prefix: /
    route:
    - destination:
        host: paymentservice
        subset: v2
  - match:
    - headers:
        version:
          exact: v1
      uri:
        prefix: /
    route:
    - destination:
        host: paymentservice
        subset: v1
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: productcatalogservice
spec:
  hosts:
  - "productcatalogservice"
  http:
  - route:
    - destination:
        host: productcatalogservice
        subset: v1
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: cartservice
spec:
  hosts:
  - "cartservice"
  http:
  - route:
    - destination:
        host: cartservice
        subset: v1
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: currencyservice
spec:
  hosts:
  - "currencyservice"
  http:
  - route:
    - destination:
        host: currencyservice
        subset: v1
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: shippingservice
spec:
  hosts:
  - "shippingservice"
  http:
  - route:
    - destination:
        host: shippingservice
        subset: v1
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: redis-cart
spec:
  hosts:
  - "redis-cart"
  http:
  - route:
    - destination:
        host: redis-cart
        subset: v1
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: adservice
spec:
  hosts:
  - "adservice"
  http:
  - route:
    - destination:
        host: adservice
        subset: v1
---
```

argo-AnalysisTemplate-frontend.yaml

kubectl apply -f argo-AnalysisTemplate-frontend.yaml -n demo-01

```
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: success-rate
spec:
  args:
  - name: service-name
  metrics:
  - name: success-rate
    interval: 60s
    count: 5
    successCondition: result[0] >= 0.50
    failureLimit: 3
    provider:
      prometheus:
        address: http://prometheus.istio-system:9090
        query: |
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}",response_code!~"5.*"}[5m]
          )) / 
          sum(irate(
            istio_requests_total{reporter="source",destination_service=~"{{args.service-name}}"}[5m]
          ))
```





bg-checkoutservice-postPromotionAnalysis.yaml

kubectl apply -f bg-checkoutservice-postPromotionAnalysis.yaml -n demo-01

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: checkoutservice
spec:
  replicas: 1
  selector:
    matchLabels:
      app: checkoutservice
      version: v1
  template:
    metadata:
      labels:
        app: checkoutservice
        version: v1
        line: v1 
      annotations:
        sidecar.istio.io/userVolumeMount: '[{"name":"wasm", "mountPath":"/var/local/lib/wasm-filters", "readonly":true},{"name":"wasm-2", "mountPath":"/var/local/lib/wasm-filters-2", "readonly":true},{"name":"wasm-3", "mountPath":"/var/local/lib/wasm-filters-3", "readonly":true}]'
        sidecar.istio.io/userVolume: '[{"name":"wasm", "configmap":{"name":"wasm"}},{"name":"wasm-2", "configmap":{"name":"wasm-2"}},{"name":"wasm-3", "configmap":{"name":"wasm-3"}}]'
    spec:
      serviceAccountName: default
      containers:
        - name: server
          image: alexshu/checkoutservice:v0.2.1
          ports:
          - containerPort: 5050
          readinessProbe:
            exec:
              command: ["/bin/grpc_health_probe", "-addr=:5050"]
          livenessProbe:
            exec:
              command: ["/bin/grpc_health_probe", "-addr=:5050"]
          env:
          - name: PORT
            value: "5050"
          - name: PRODUCT_CATALOG_SERVICE_ADDR
            value: "productcatalogservice:3550"
          - name: SHIPPING_SERVICE_ADDR
            value: "shippingservice:50051"
          - name: PAYMENT_SERVICE_ADDR
            value: "paymentservice:50051"
          - name: EMAIL_SERVICE_ADDR
            value: "emailservice:5000"
          - name: CURRENCY_SERVICE_ADDR
            value: "currencyservice:7000"
          - name: CART_SERVICE_ADDR
            value: "cartservice:7070"
          # - name: DISABLE_STATS
          #   value: "1"
          # - name: DISABLE_TRACING
          #   value: "1"
          # - name: DISABLE_PROFILER
          #   value: "1"
          # - name: JAEGER_SERVICE_ADDR
          #   value: "jaeger-collector:14268"
  strategy:
    blueGreen: 
      activeService: checkoutservice-primary
      previewService: checkoutservice-canary
      prePromotionAnalysis:
        templates:
        - templateName: success-rate
          clusterScope: false
        args:
        - name: service-name
          value: checkoutservice-canary.demo-01.svc.cluster.local
      postPromotionAnalysis:
        templates:
        - templateName: success-rate
          clusterScope: false
        args:
        - name: service-name
          value: checkoutservice-primary.demo-01.svc.cluster.local      
```



svc-checkoutservice-primary.yaml

kubectl apply -f svc-checkoutservice-primary.yaml -n demo-01

```
apiVersion: v1
kind: Service
metadata:
  name: checkoutservice-primary
spec:
  ports:
  - name: grpc
    port: 5050
    protocol: TCP
    targetPort: 5050
  selector:
    app: checkoutservice
```

svc-checkoutservice-canary.yaml

kubectl apply -f svc-checkoutservice-canary.yaml -n demo-01

```
apiVersion: v1
kind: Service
metadata:
  name: checkoutservice-canary
spec:
  ports:
  - name: grpc
    port: 5050
    protocol: TCP
    targetPort: 5050
  selector:
    app: checkoutservice
```

```
kubectl -n demo-01 edit rollout checkoutservice

image:
checkoutservice:v0.3.6
label:
line: v2

image:
checkoutservice:v0.2.1
label:
line: v1


kubectl argo rollouts promote checkoutservice -n demo-01 


kubectl argo rollouts get rollout checkoutservice -w -n demo-01
```



bg-recommendationservice-postPromotionAnalysis.yaml

kubectl apply -f bg-recommendationservice-postPromotionAnalysis.yaml -n demo-01

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: recommendationservice
spec:
  replicas: 1
  selector:
    matchLabels:
      app: recommendationservice
      version: v1
  template:
    metadata:
      labels:
        app: recommendationservice
        version: v1
        line: v1 
      annotations:
        sidecar.istio.io/userVolumeMount: '[{"name":"wasm", "mountPath":"/var/local/lib/wasm-filters", "readonly":true},{"name":"wasm-2", "mountPath":"/var/local/lib/wasm-filters-2", "readonly":true},{"name":"wasm-3", "mountPath":"/var/local/lib/wasm-filters-3", "readonly":true}]'
        sidecar.istio.io/userVolume: '[{"name":"wasm", "configmap":{"name":"wasm"}},{"name":"wasm-2", "configmap":{"name":"wasm-2"}},{"name":"wasm-3", "configmap":{"name":"wasm-3"}}]'
    spec:
      terminationGracePeriodSeconds: 5
      containers:
      - name: server
        image: alexshu/recommendationservice:v0.2.1
        ports:
        - containerPort: 8080
        readinessProbe:
          periodSeconds: 5
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:8080"]
        livenessProbe:
          periodSeconds: 5
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:8080"]
        env:
        - name: PORT
          value: "8080"
        - name: PRODUCT_CATALOG_SERVICE_ADDR
          value: "productcatalogservice:3550"
        # - name: DISABLE_TRACING
        #   value: "1"
        # - name: DISABLE_PROFILER
        #   value: "1"
        # - name: DISABLE_DEBUGGER
        #   value: "1"
  strategy:
    blueGreen: 
      activeService: recommendationservice-primary
      previewService: recommendationservice-canary
      prePromotionAnalysis:
        templates:
        - templateName: success-rate
          clusterScope: false
        args:
        - name: service-name
          value: recommendationservice-canary.demo-01.svc.cluster.local
      postPromotionAnalysis:
        templates:
        - templateName: success-rate
          clusterScope: false
        args:
        - name: service-name
          value: recommendationservice-primary.demo-01.svc.cluster.local      
```



svc-recommendationservice-primary.yaml

kubectl apply -f svc-recommendationservice-primary.yaml -n demo-01

```
apiVersion: v1
kind: Service
metadata:
  name: recommendationservice-primary
spec:
  ports:
  - name: grpc
    port: 8080
    protocol: TCP
    targetPort: 8080
  selector:
    app: recommendationservice
```

svc-recommendationservice-canary.yaml

kubectl apply -f svc-recommendationservice-canary.yaml -n demo-01

```
apiVersion: v1
kind: Service
metadata:
  name: recommendationservice-canary
spec:
  ports:
  - name: grpc
    port: 8080
    protocol: TCP
    targetPort: 8080
  selector:
    app: recommendationservice
```



```
kubectl -n demo-01 edit rollout recommendationservice

image:
recommendationservice:v0.3.6

image:
recommendationservice:v0.2.1


kubectl argo rollouts promote recommendationservice -n demo-01 


kubectl argo rollouts get rollout recommendationservice -w -n demo-01
```



# 资源删不掉怎么办：

canary更改了service name会导致资源删不掉

```
kubectl patch  canaries.flagger.app -n demo-01 checkoutservice  -p '{"metadata":{"finalizers":[]}}' --type=merge
```



# 关于发布的一些思考：

1css js更改的界面发布问题 

2选择哪个发布框架

3采用哪个发布方式
