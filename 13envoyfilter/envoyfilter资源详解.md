# 学习目标

# ![1618898650(1)](images\1618898650(1).jpg)13-1什么是EnvoyFilter

 `EnvoyFilter` provides a mechanism to customize the Envoy configuration generated by Istio Pilot. Use EnvoyFilter to modify values for certain fields, add specific filters, or even add entirely new listeners, clusters, etc. This feature must be used with care, as incorrect configurations could potentially destabilize the entire mesh. Unlike other Istio networking objects, EnvoyFilters are additively applied. Any number of EnvoyFilters can exist for a given workload in a specific namespace. The order of application of these EnvoyFilters is as follows: all EnvoyFilters in the config [root namespace](https://istio.io/latest/docs/reference/config/istio.mesh.v1alpha1/#MeshConfig), followed by all matching EnvoyFilters in the workload’s namespace. 



# 资源详解

| Field              | Type                       | Description                                                  | Required |
| ------------------ | -------------------------- | ------------------------------------------------------------ | -------- |
| `workloadSelector` | `WorkloadSelector`         | Criteria used to select the specific set of pods/VMs on which this patch configuration should be applied. If omitted, the set of patches in this configuration will be applied to all workload instances in the same namespace. If omitted, the `EnvoyFilter` patches will be applied to all workloads in the same namespace. If the `EnvoyFilter` is present in the config root namespace, it will be applied to all applicable workloads in any namespace. | No       |
| `configPatches`    | `EnvoyConfigObjectPatch[]` | One or more patches with match conditions.                   | Yes      |
| `priority`         | `int32`                    | Priority defines the order in which patch sets are applied within a context. When one patch depends on another patch, the order of patch application is significant. The API provides two primary ways to order patches. Patch sets in the root namespace are applied before the patch sets in the workload namespace. Patches within a patch set are processed in the order that they appear in the `configPatches` list.The default value for priority is 0 and the range is [ min-int32, max-int32 ]. A patch set with a negative priority is processed before the default. A patch set with a positive priority is processed after the default.It is recommended to start with priority values that are multiples of 10 to leave room for further insertion.Patch sets are sorted in the following ascending key order: priority, creation time, fully qualified resource name. | N        |

## 13-2没有workloadSelector

### 全局有效

ef-accesslog-global.yaml

kubectl apply -f ef-accesslog-global.yaml -n istio-system

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: access-log
  namespace: istio-system
spec:
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      listener:
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
    patch:
      operation: MERGE
      value:
        typed_config:
          "@type": "type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager"
          access_log:
          - name: envoy.access_loggers.file
            typed_config:
              "@type": "type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog"
              path: /dev/stdout
              log_format:
                text_format: "[%START_TIME%] \" %RESPONSE_CODE% \n"
```

virtaulservice/vs-bookinfo-star.yaml

kubectl apply -f vs-bookinfo-star.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: bookinfo
spec:
  exportTo:
  - '*'
  hosts:
  - "*"
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        prefix: /static
    - uri:
        exact: /login
    - uri:
        exact: /logout
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage.istio.svc.cluster.local
        port:
          number: 9080
```



kubectl apply -f gateway-01.yaml -n istio

gateway/gateway-01.yaml

```
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
```

kubectl edit cm istio -n istio-system

去掉

accessLogFile: /dev/stdout



清除：

kubectl delete vs bookinfo -n istio

kubectl delete gw bookinfo-gateway -n istio

kubectl delete envoyfilter access-log -n istio-system



应用规则前：

kubectl port-forward --address 0.0.0.0 -n istio-system istio-ingressgateway-8657768d87-bd767 15002:15000

![1628837373(1)](images\1628837373(1).jpg)

应用规则后：

kubectl port-forward --address 0.0.0.0 -n istio-system istio-ingressgateway-8657768d87-bd767 15002:15000

![1628837538(1)](images\1628837538(1).jpg)

kubectl port-forward --address 0.0.0.0 -n istio productpage-v1-659776cb44-q8xzp 15001:15000

![1628837666(1)](images\1628837666(1).jpg)

kubectl logs --tail 20 -f -n istio-system istio-ingressgateway-8657768d87-bd767 

请求

kubectl logs --tail 20 -f -n istio productpage-v1-659776cb44-q8xzp 



### 名称空间有效

ef-accesslog-namespeced.yaml

kubectl apply -f ef-accesslog-namespeced.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: access-log
spec:
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      listener:
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
    patch:
      operation: MERGE
      value:
        typed_config:
          "@type": "type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager"
          access_log:
          - name: envoy.access_loggers.file
            typed_config:
              "@type": "type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog"
              path: /dev/stdout
              log_format:
                text_format: "[%START_TIME%] \" %RESPONSE_CODE% \n"
```

virtaulservice/vs-bookinfo-star.yaml

kubectl apply -f vs-bookinfo-star.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: bookinfo
spec:
  exportTo:
  - '*'
  hosts:
  - "*"
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        prefix: /static
    - uri:
        exact: /login
    - uri:
        exact: /logout
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage.istio.svc.cluster.local
        port:
          number: 9080
```



kubectl apply -f gateway-01.yaml -n istio

gateway/gateway-01.yaml

```
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
```

kubectl edit cm istio -n istio-system

去掉

accessLogFile: /dev/stdout



清除：

kubectl delete vs bookinfo -n istio

kubectl delete gw bookinfo-gateway -n istio

kubectl delete envoyfilter access-log -n istio



kubectl port-forward --address 0.0.0.0 -n istio productpage-v1-659776cb44-q8xzp 15001:15000

![1628837908(1)](images\1628837908(1).jpg)

请求

kubectl logs --tail 20 -f -n istio productpage-v1-659776cb44-q8xzp 



## workloadSelector

ef-productpage-accesslog.yaml

kubectl apply -f ef-productpage-accesslog.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: access-log
spec:
  workloadSelector:
    labels:
      app: productpage
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      listener:
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
    patch:
      operation: MERGE
      value:
        typed_config:
          "@type": "type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager"
          access_log:
          - name: envoy.access_loggers.file
            typed_config:
              "@type": "type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog"
              path: /dev/stdout
              log_format:
                text_format: "[%START_TIME%] \" %RESPONSE_CODE% \n"
```

virtaulservice/vs-bookinfo-star.yaml

kubectl apply -f vs-bookinfo-star.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: bookinfo
spec:
  exportTo:
  - '*'
  hosts:
  - "*"
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        prefix: /static
    - uri:
        exact: /login
    - uri:
        exact: /logout
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage.istio.svc.cluster.local
        port:
          number: 9080
```



kubectl apply -f gateway-01.yaml -n istio

gateway/gateway-01.yaml

```
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
```

kubectl edit cm istio -n istio-system

去掉

accessLogFile: /dev/stdout



清除：

kubectl delete vs bookinfo -n istio

kubectl delete gw bookinfo-gateway -n istio

kubectl delete envoyfilter access-log -n istio



kubectl port-forward --address 0.0.0.0 -n istio productpage-v1-659776cb44-q8xzp 15001:15000

![1628838072(1)](images\1628838072(1).jpg)

请求

kubectl logs --tail 20 -f -n istio productpage-v1-659776cb44-q8xzp 



## priority

ef-productpage-remove-fault-priority.yaml

kubectl apply -f ef-productpage-remove-fault-priority.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: apply-to
spec:
  workloadSelector:
    labels:
      app: productpage
  priority: 20
  configPatches:
    - applyTo: HTTP_FILTER
      match:
        context: ANY
        listener:
          filterChain:
            filter:
              name: "envoy.filters.network.http_connection_manager"
              subFilter:
                name: "envoy.filters.http.fault"
      patch:
        operation: MERGE
        value:
            name: envoy.filters.http.fault
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.fault.v3.HTTPFault
              abort:
                http_status: 503
                percentage:
                  numerator: 50
                  denominator: HUNDRED
              delay:
                fixed_delay: 3s
                percentage:
                  numerator: 50
                  denominator: HUNDRED
```

ef-productpage-add-fault-priority.yaml

kubectl apply -f ef-productpage-add-fault-priority.yaml  -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: apply-to-2
spec:
  workloadSelector:
    labels:
      app: productpage
  priority: 10
  configPatches:
    - applyTo: HTTP_FILTER
      match:
        context: ANY
        listener:
          filterChain:
            filter:
              name: "envoy.filters.network.http_connection_manager"
              subFilter:
                name: "envoy.filters.http.fault"
      patch:
        operation: MERGE
        value:
            name: envoy.filters.http.fault
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.fault.v3.HTTPFault
              abort:
                http_status: 503
                percentage:
                  numerator: 100
                  denominator: HUNDRED
              delay:
                fixed_delay: 3s
                percentage:
                  numerator: 100
                  denominator: HUNDRED
```

改变优先级，查看结果。

## configPatches

| Field     | Type                     | Description                                                  | Required |
| --------- | ------------------------ | ------------------------------------------------------------ | -------- |
| `applyTo` | `ApplyTo`                | Specifies where in the Envoy configuration, the patch should be applied. The match is expected to select the appropriate object based on applyTo. For example, an applyTo with `HTTP_FILTER` is expected to have a match condition on the listeners, with a network filter selection on `envoy.filters.network.http_connection_manager` and a sub filter selection on the HTTP filter relative to which the insertion should be performed. Similarly, an applyTo on `CLUSTER` should have a match (if provided) on the cluster and not on a listener. | No       |
| `match`   | `EnvoyConfigObjectMatch` | Match on listener/route configuration/cluster.               | No       |
| `patch`   | `Patch`                  | The patch to apply along with the operation.                 | No       |

### applyTo

`ApplyTo` specifies where in the Envoy configuration, the given patch should be applied.

| Name                  | Description                                                  |
| --------------------- | ------------------------------------------------------------ |
| `INVALID`             |                                                              |
| `LISTENER`            | Applies the patch to the listener.                           |
| `FILTER_CHAIN`        | Applies the patch to the filter chain.                       |
| `NETWORK_FILTER`      | Applies the patch to the network filter chain, to modify an existing filter or add a new filter. |
| `HTTP_FILTER`         | Applies the patch to the HTTP filter chain in the http connection manager, to modify an existing filter or add a new filter. |
| `ROUTE_CONFIGURATION` | Applies the patch to the Route configuration (rds output) inside a HTTP connection manager. This does not apply to the virtual host. Currently, only `MERGE` operation is allowed on the route configuration objects. |
| `VIRTUAL_HOST`        | Applies the patch to a virtual host inside a route configuration. |
| `HTTP_ROUTE`          | Applies the patch to a route object inside the matched virtual host in a route configuration. |
| `CLUSTER`             | Applies the patch to a cluster in a CDS output. Also used to add new clusters. |
| `EXTENSION_CONFIG`    | Applies the patch to or adds an extension config in ECDS output. Note that ECDS is only supported by HTTP filters. |
| `BOOTSTRAP`           | Applies the patch to bootstrap configuration.                |

#### INVALID





#### 13-3LISTENER

ef-ingressgateway-remove-listener.yaml

kubectl apply -f ef-ingressgateway-remove-listener.yaml -n istio-system

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: apply-to
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: LISTENER
    match:
      listener:
        portNumber: 8080
    patch:
      operation: REMOVE
```

kubectl apply -f gateway-01.yaml -n istio

gateway/gateway-01.yaml

```
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
```

virtaulservice/vs-bookinfo-star.yaml

kubectl apply -f vs-bookinfo-star.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: bookinfo
spec:
  exportTo:
  - '*'
  hosts:
  - "*"
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        prefix: /static
    - uri:
        exact: /login
    - uri:
        exact: /logout
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage.istio.svc.cluster.local
        port:
          number: 9080
```



删除8080 listener

kubectl port-forward istio-ingressgateway-d46c4ff9b-zsjgd  -n istio-system --address 0.0.0.0 15001:15000

http://192.168.198.154:15001/config_dump

清理：

kubectl delete envoyfilters.networking.istio.io -n istio-system apply-to 

kubectl delete gw bookinfo-gateway -n istio

kubectl  delete vs  bookinfo -n istio



应用规则前：

![1628915771(1)](images\1628915771(1).jpg)

应用规则后：8080 listener已被删除

![1628915970(1)](images\1628915970(1).jpg)





添加监听器

ef-productpage-add-listener.yaml

kubectl apply -f ef-productpage-add-listener.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: apply-to
  namespace: istio 
spec:
  workloadSelector:
    labels:
      app: productpage
  configPatches:
  - applyTo: LISTENER
    match:
      context: SIDECAR_INBOUND
    patch:
      operation: ADD
      value:
        name: proxy
        address:
          socket_address:
            protocol: TCP
            address: 0.0.0.0
            port_value: 8083
        traffic_direction: "INBOUND"
        filter_chains:
        - filters:
          - name: "envoy.filters.network.http_connection_manager"
            typed_config:
              "@type": "type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager"
              stat_prefix: ingress_proxy
              route_config:
                name: route_a
                virtual_hosts:
                - name: envoy_cyz
                  domains:
                  - "*"
                  routes:
                  - match:
                      prefix: "/"
                    route:
                      cluster: cluster123
              http_filters:
              - name: "envoy.filters.http.router"
                typed_config:
                  "@type": "type.googleapis.com/envoy.extensions.filters.http.router.v3.Router" 
  - applyTo: CLUSTER
    patch:
      operation: ADD
      value: 
        name: "cluster123"
        type: STATIC
        connect_timeout: 0.5s
        lb_policy: ROUND_ROBIN
        load_assignment:
          cluster_name: cluster123
          endpoints:
          - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: 127.0.0.1
                    port_value: 9080
```



添加vs

applyto/vs-bookinfo.yaml

kubectl apply -f vs-bookinfo.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: bookinfo
spec:
  hosts:
  - "*"
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        prefix: /
    route:
    - destination:
        host: productpage.istio.svc.cluster.local
        port:
          number: 8083
```

k8s svc 添加端口

 kubectl edit svc productpage -n istio

```
  - name: http8083
    port: 8083
    protocol: TCP
    targetPort: 8083
```

kubectl apply -f gateway-01.yaml -n istio

gateway/gateway-01.yaml

```
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
```



访问:

http://bookinfo.demo:30986/productpage

清理：

kubectl delete envoyfilter apply-to -n istio

kubectl delete vs bookinfo -n istio

kubectl delete gw bookinfo-gateway -n istio



kubectl port-forward --address 0.0.0.0 -n istio productpage-v1-659776cb44-q8xzp 15000:15000

![1628916318(1)](images\1628916318(1).jpg)



![1628916386(1)](images\1628916386(1).jpg)

![1628916425(1)](images\1628916425(1).jpg)

![1628916453(1)](images\1628916453(1).jpg)





添加listenerFilter

ef-listener-filter.yaml

kubectl  apply -f ef-listener-filter.yaml -n istio-system

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: apply-to
  namespace: istio-system
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: LISTENER
    patch:
      operation: MERGE
      value:
        listener_filters:
        - name: envoy.filters.listener.original_src
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.listener.original_src.v3.OriginalSrc
        - name: envoy.filters.listener.tls_inspector
```

kubectl apply -f gateway-01.yaml -n istio

gateway/gateway-01.yaml

```
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
```

virtaulservice/vs-bookinfo-star.yaml

kubectl apply -f vs-bookinfo-star.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: bookinfo
spec:
  exportTo:
  - '*'
  hosts:
  - "*"
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        prefix: /static
    - uri:
        exact: /login
    - uri:
        exact: /logout
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage.istio.svc.cluster.local
        port:
          number: 9080
```



清理：

kubectl delete envoyfilter apply-to -n istio-system

kubectl delete gw bookinfo-gateway -n istio

kubectl delete vs bookinfo -n istio

![1628916613(1)](images\1628916613(1).jpg)



#### 13-4FILTER_CHAIN

ef-ingressgateway-filter-chain-remove.yaml

kubectl  apply -f ef-ingressgateway-filter-chain-remove.yaml -n istio-system

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: apply-to
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: FILTER_CHAIN
    match:
      listener:
        portNumber: 8080
    patch:
      operation: REMOVE
     

```

kubectl apply -f gateway-01.yaml -n istio

gateway/gateway-01.yaml

```
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
```

virtaulservice/vs-bookinfo-star.yaml

kubectl apply -f vs-bookinfo-star.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: bookinfo
spec:
  exportTo:
  - '*'
  hosts:
  - "*"
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        prefix: /static
    - uri:
        exact: /login
    - uri:
        exact: /logout
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage.istio.svc.cluster.local
        port:
          number: 9080
```



清理：

kubectl delete envoyfilter apply-to -n istio-system

kubectl delete gateway bookinfo-gateway -n istio

kubectl delete vs bookinfo -n istio

listener不能没有filter-chain

![1628916879(1)](images\1628916879(1).jpg)





ef-ingressgateway-filter-chain-merge.yaml

kubectl  apply -f ef-ingressgateway-filter-chain-merge.yaml -n istio-system

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: apply-to
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: FILTER_CHAIN
    match:
      listener:
        portNumber: 8080
    patch:
      operation: MERGE
      value:
        name: test
        filter_chain_match:
          server_names:
          - bookinfo.demo
```

kubectl apply -f gateway-01.yaml -n istio

gateway/gateway-01.yaml

```
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
```

virtaulservice/vs-bookinfo-star.yaml

kubectl apply -f vs-bookinfo-star.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: bookinfo
spec:
  exportTo:
  - '*'
  hosts:
  - "*"
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        prefix: /static
    - uri:
        exact: /login
    - uri:
        exact: /logout
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage.istio.svc.cluster.local
        port:
          number: 9080
```



清理：

kubectl delete envoyfilter apply-to -n istio-system

kubectl delete gw bookinfo-gateway -n istio

kubectl delete vs bookinfo -n istio



![1628917020(1)](images\1628917020(1).jpg)





#### NETWORK_FILTER

ef-ingressgateway-network-filter-merge.yaml

kubectl apply -f ef-ingressgateway-network-filter-merge.yaml -n istio-system

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: apply-to
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      listener:
        portNumber: 8080
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
    patch:
      operation: MERGE
      value:
            name: envoy.filters.network.http_connection_manager
            typed_config:
              "@type": "type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager"
              "stat_prefix": "test"
              
```

kubectl apply -f gateway-01.yaml -n istio

gateway/gateway-01.yaml

```
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
```

virtaulservice/vs-bookinfo-star.yaml

kubectl apply -f vs-bookinfo-star.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: bookinfo
spec:
  exportTo:
  - '*'
  hosts:
  - "*"
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        prefix: /static
    - uri:
        exact: /login
    - uri:
        exact: /logout
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage.istio.svc.cluster.local
        port:
          number: 9080
```



清理：

kubectl delete envoyfilter apply-to -n istio-system

kubectl delete gw bookinfo-gateway -n istio

kubectl delete vs bookinfo -n istio

![1628917364(1)](images\1628917364(1).jpg)





##### 13-5echo

先部署gateway

gateway/gateway-mysql.yaml

kubectl apply -f gateway-mysql.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: mysql
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 3306
      name: mysql
      protocol: MYSQL
    hosts:
    - "*"
```

gateway/protocol/vs-mysql.yaml

kubectl apply -f vs-mysql.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: mysql
spec:
  hosts:
  - "*"
  gateways:
  - mysql
  tcp:
  - match:
    - port: 3306
    route:
    - destination:
        host: mysqldb.istio.svc.cluster.local
        port:
          number: 3306
```

ef-ingressgateway-network-filter-echo-3306.yaml

kubectl apply -f ef-ingressgateway-network-filter-echo-3306.yaml -n istio-system

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: apply-to
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      listener:
        portNumber: 3306
    patch:
      operation: REMOVE
  - applyTo: NETWORK_FILTER
    match:
      listener:
        portNumber: 3306
    patch:
      operation: ADD
      value:
            name: envoy.filters.network.echo
            typed_config:
              "@type": "type.googleapis.com/envoy.extensions.filters.network.echo.v3.Echo"
```

telnet 192.168.198.154 30300

清理：

kubectl delete envoyfilter apply-to -n istio-system

kubectl delete gw mysql -n istio

kubectl delete vs mysql -n istio



![1628919571(1)](images\1628919571(1).jpg)



##### 13-6direct_response

gateway/gateway-mysql.yaml

kubectl apply -f gateway-mysql.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: mysql
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 3306
      name: mysql
      protocol: MYSQL
    hosts:
    - "*"
```

gateway/protocol/vs-mysql.yaml

kubectl apply -f vs-mysql.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: mysql
spec:
  hosts:
  - "*"
  gateways:
  - mysql
  tcp:
  - match:
    - port: 3306
    route:
    - destination:
        host: mysqldb.istio.svc.cluster.local
        port:
          number: 3306
```



ef-ingressgateway-network-filter-direct_response-3306.yaml

kubectl apply -f ef-ingressgateway-network-filter-direct_response-3306.yaml -n istio-system

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: apply-to
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      listener:
        portNumber: 3306
    patch:
      operation: REMOVE
  - applyTo: NETWORK_FILTER
    match:
      listener:
        portNumber: 3306
    patch:
      operation: ADD
      value:
            name: envoy.filters.network.direct_response
            typed_config:
                 "@type": "type.googleapis.com/envoy.extensions.filters.network.direct_response.v3.Config"
                 response:
                   inline_string: "test this is direct response||||||"
```

 telnet 192.168.198.154 30300

清理：

kubectl delete gw mysql -n istio

kubectl delete vs mysql -n istio

kubectl delete envoyfilter apply-to -n istio-system

![1628920044(1)](images\1628920044(1).jpg)





##### 13-7dubbo

applyto/dubbo/dubbo-provider-deploy.yaml

kubectl apply -f dubbo-provider-deploy.yaml 

```
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dubbo-sample-provider-v1
  labels:
    app: dubbo-sample-provider
spec:
  selector:
    matchLabels:
      app: dubbo-sample-provider
  replicas: 1
  template:
    metadata:
      labels:
        app: dubbo-sample-provider
        version: v1
    spec:
      containers:
        - name: dubbo-sample-provider
          image: registry.cn-hangzhou.aliyuncs.com/hxpdocker/dubbo-sample-provider
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 20880
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dubbo-sample-provider-v2
  labels:
    app: dubbo-sample-provider
spec:
  selector:
    matchLabels:
      app: dubbo-sample-provider
  replicas: 1
  template:
    metadata:
      labels:
        app: dubbo-sample-provider
        version: v2
    spec:
      containers:
        - name: dubbo-sample-provider
          image: registry.cn-hangzhou.aliyuncs.com/hxpdocker/dubbo-sample-provider
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 20880

```

applyto/dubbo/dubbo-comsumer-deploy.yaml

kubectl apply -f dubbo-comsumer-deploy.yaml -n istio

```
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dubbo-sample-consumer
  labels:
    app: dubbo-sample-consumer
spec:
  selector:
    matchLabels:
      app: dubbo-sample-consumer
  replicas: 1
  template:
    metadata:
      labels:
        app: dubbo-sample-consumer
    spec:
      containers:
        - name: dubbo-sample-consumer
          image: registry.cn-hangzhou.aliyuncs.com/hxpdocker/dubbo-sample-consumer
          imagePullPolicy: IfNotPresent
          env:
            - name: mode
              value: demo
```

applyto/dubbo/se-dubbo.yaml

kubectl apply -f se-dubbo.yaml 

```
apiVersion: networking.istio.io/v1alpha3
kind: ServiceEntry
metadata:
  name: test-dubbo-service
  annotations:
    interface: org.apache.dubbo.samples.basic.api.DemoService
spec:
  hosts:
  - org.apache.dubbo.samples.basic.api.demoservice
  addresses:
  - 192.168.198.166
  ports:
  - number: 20880
    name: tcp-dubbo
    protocol: TCP
  workloadSelector:
    labels:
      app: dubbo-sample-provider
  resolution: STATIC
```

applyto/dubbo/dr-dubbo.yaml

kubectl apply -f dr-dubbo.yaml 

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: dubbo-sample-provider
spec:
  host: org.apache.dubbo.samples.basic.api.demoservice
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
```



applyto/dubbo/ef-dubbo.yaml

kubectl apply -f ef-dubbo.yaml -n istio-system

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: envoyfilter-dubbo-proxy
spec:
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      listener:
        name: 192.168.198.166_20880
        filterChain:
          filter:
            name: "envoy.filters.network.tcp_proxy"
    patch:
      operation: REPLACE
      value:
        name: envoy.filters.network.dubbo_proxy
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.dubbo_proxy.v3.DubboProxy
          stat_prefix: outbound|20880||org.apache.dubbo.samples.basic.api.demoservice
          protocol_type: Dubbo
          serialization_type: Hessian2
          route_config:
          - name: outbound|20880||org.apache.dubbo.samples.basic.api.demoservice
            interface: org.apache.dubbo.samples.basic.api.DemoService
            routes:
            - match:
                method:
                  name:
                    exact: sayHello
              route:
                cluster: outbound|20880|v2|org.apache.dubbo.samples.basic.api.demoservice
  - applyTo: NETWORK_FILTER
    match:
      listener:
        name: virtualInbound
        filterChain:
          destinationPort: 20880
          filter:
            name: "envoy.filters.network.tcp_proxy"
    patch:
      operation: REPLACE
      value:
        name: envoy.filters.network.dubbo_proxy
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.dubbo_proxy.v3.DubboProxy
          stat_prefix: inbound|20880||
          protocol_type: Dubbo
          serialization_type: Hessian2
          route_config:
          - name: inbound|20880||
            interface: org.apache.dubbo.samples.basic.api.DemoService
            routes:
            - match:
                method:
                  name:
                    exact: sayHello
              route:
                cluster: inbound|20880||
```

查看comsumer日志

kubectl logs -f -n istio dubbo-sample-consumer-5cc788bc6-t5fr9

清理：

kubectl delete -f dubbo-provider-deploy.yaml 

kubectl delete -f dubbo-comsumer-deploy.yaml -n istio

kubectl  delete se test-dubbo-service 

kubectl delete dr dubbo-sample-provider  -n istio

kubectl delete envoyfilter envoyfilter-dubbo-proxy -n istio-system



2)svc

域名写死了，需要解析

 dubbo://org.apache.dubbo.samples.basic.api.demoservice:20880/org.apache.dubbo.samples.basic.api.DemoService?application=demo-consumer&check=true&codec=dubbo&heartbeat=60000&init=false&interface=org.apache.dubbo.samples.basic.api.DemoService&pid=7&register.ip=172.20.2.212&remote.application=&revision=1.0-SNAPSHOT&side=consumer&sticky=false&timeout=3000



kubectl apply -f dubbo-provider-deploy.yaml  -n istio

kubectl apply -f dubbo-comsumer-deploy.yaml -n istio



svc-dubbo.yaml

kubectl apply -f svc-dubbo.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: dubbo-provider
spec:
  selector:
    app: dubbo-sample-provider
  ports:
    - name: tcp-dubbo
      protocol: TCP
      port: 20880
      targetPort: 20880
```

applyto/dubbo/dr-dubbo-2.yaml

kubectl apply -f dr-dubbo-2.yaml  -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: dubbo-sample-provider
spec:
  host: dubbo-provider
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
```

applyto/dubbo/ef-dubbo-2.yaml

kubectl apply -f ef-dubbo-2.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: envoyfilter-dubbo-proxy
spec:
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      listener:
        name: 10.68.144.97_20880
        filterChain:
          filter:
            name: "envoy.filters.network.tcp_proxy"
    patch:
      operation: REPLACE
      value:
        name: envoy.filters.network.dubbo_proxy
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.dubbo_proxy.v3.DubboProxy
          stat_prefix: outbound|20880||org.apache.dubbo.samples.basic.api.demoservice
          protocol_type: Dubbo
          serialization_type: Hessian2
          route_config:
          - name: outbound|20880||org.apache.dubbo.samples.basic.api.demoservice
            interface: org.apache.dubbo.samples.basic.api.DemoService
            routes:
            - match:
                method:
                  name:
                    exact: sayHello
              route:
                cluster: outbound|20880|v2|dubbo-provider.istio.svc.cluster.local
  - applyTo: NETWORK_FILTER
    match:
      listener:
        name: virtualInbound
        filterChain:
          destinationPort: 20880
          filter:
            name: "envoy.filters.network.tcp_proxy"
    patch:
      operation: REPLACE
      value:
        name: envoy.filters.network.dubbo_proxy
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.dubbo_proxy.v3.DubboProxy
          stat_prefix: inbound|20880||
          protocol_type: Dubbo
          serialization_type: Hessian2
          route_config:
          - name: inbound|20880||
            interface: org.apache.dubbo.samples.basic.api.DemoService
            routes:
            - match:
                method:
                  name:
                    exact: sayHello
              route:
                cluster: inbound|20880||
```

清理：

kubectl delete -f dubbo-provider-deploy.yaml  -n istio

kubectl delete -f dubbo-comsumer-deploy.yaml -n istio

kubectl  delete svc dubbo-provider -n istio

kubectl delete dr dubbo-sample-provider  -n istio

kubectl delete envoyfilter envoyfilter-dubbo-proxy -n istio

![1628921508(1)](images\1628921508(1).jpg)

![1628921630(1)](images\1628921630(1).jpg)

![1628921660(1)](images\1628921660(1).jpg)

![1628921704(1)](images\1628921704(1).jpg)





##### 13-8thrift_proxy

1部署应用

applyto/thrift/thrift-deploy.yaml

kubectl apply -f thrift-deploy.yaml -n istio

```
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: thrift-sample-server-v1
  labels:
    app: thrift-sample-server
spec:
  selector:
    matchLabels:
      app: thrift-sample-server
  replicas: 1
  template:
    metadata:
      labels:
        app: thrift-sample-server
        version: v1
    spec:
      containers:
        - name: thrift-sample-server
          image: registry.cn-hangzhou.aliyuncs.com/hxpdocker/thrift-sample-server:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 9090
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: thrift-sample-server-v2
  labels:
    app: thrift-sample-server
spec:
  selector:
    matchLabels:
      app: thrift-sample-server
  replicas: 1
  template:
    metadata:
      labels:
        app: thrift-sample-server
        version: v2
    spec:
      containers:
        - name: thrift-sample-server
          image: registry.cn-hangzhou.aliyuncs.com/hxpdocker/thrift-sample-server:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 9090
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: thrift-sample-client
  labels:
    app: thrift-sample-client
spec:
  selector:
    matchLabels:
      app: thrift-sample-client
  replicas: 1
  template:
    metadata:
      labels:
        app: thrift-sample-client
    spec:
      containers:
        - name: thrift-sample-client
          image: registry.cn-hangzhou.aliyuncs.com/hxpdocker/thrift-sample-client:latest
          imagePullPolicy: IfNotPresent
          env:
            - name: helloServer
              value: "thrift-sample-server"
            - name: mode
              value: "demo"
---
apiVersion: v1
kind: Service
metadata:
  name: thrift-sample-server
spec:
  selector:
    app: thrift-sample-server
  ports:
    - name: tcp-thrift-hello-server
      protocol: TCP
      port: 9090
      targetPort: 9090
---
```

2配置dr

applyto/thrift/dr-thrift.yaml

kubectl apply -f dr-thrift.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: thrift-sample-server
spec:
  host: thrift-sample-server
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
```

3配置envoyfilter

applyto/thrift/envoyfilter-thrift-proxy.yaml

kubectl apply -f envoyfilter-thrift-proxy.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: thrift-sample-server
spec:
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      listener:
        name: ${thrift-sample-server-vip}_9090    # sed -i .bak "s/\${thrift-sample-server-vip}/`kubectl get svc thrift-sample-server -n thrift -o=jsonpath='{.spec.clusterIP}'`/" istio/envoyfilter-thrift-proxy.yaml
        filterChain:
          filter:
            name: "envoy.filters.network.tcp_proxy"
    patch:
      operation: REPLACE
      value:
        name: envoy.filters.network.thrift_proxy
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.thrift_proxy.v3.ThriftProxy
          stat_prefix: "outbound|9090||thrift-sample-server.thrift.svc.cluster.local"
          transport: AUTO_TRANSPORT
          protocol: AUTO_PROTOCOL
          thrift_filters:
          - name: envoy.filters.thrift.router
          route_config:
            routes:
            - match:
                # empty string matches any request method name
                method_name: ""
              route:
                weighted_clusters:
                  clusters:
                    - name: "outbound|9090|v1|thrift-sample-server.istio.svc.cluster.local"
                      weight: 50
                    - name: "outbound|9090|v2|thrift-sample-server.istio.svc.cluster.local"
                      weight: 50
  - applyTo: NETWORK_FILTER
    match:
      listener:
        name: virtualInbound
        filterChain:
          destinationPort: 9090
          filter:
            name: "envoy.filters.network.tcp_proxy"
    patch:
      operation: REPLACE
      value:
        name: envoy.filters.network.thrift_proxy
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.thrift_proxy.v3.ThriftProxy
          stat_prefix: inbound|9090||
          transport: AUTO_TRANSPORT
          protocol: AUTO_PROTOCOL
          thrift_filters:
          - name: envoy.filters.thrift.router
          route_config:
            routes:
            - match:
                # empty string matches any request method name
                method_name: ""
              route:
                cluster: inbound|9090||
```

替换${thrift-sample-server-vip}

4查看日志

 kubectl logs --tail 10 -f thrift-sample-client-85696799d9-5bmn4 -n istio

清理：

kubectl delete -f thrift-deploy.yaml -n istio

kubectl delete dr thrift-sample-server -n istio

kubectl delete envoyfilter thrift-sample-server -n istio



 kubectl port-forward --address 0.0.0.0 -n istio thrift-sample-client-85696799d9-fsrh8 15000:15000

![1629001916(1)](images\1629001916(1).jpg)

![1629001976(1)](images\1629001976(1).jpg)



![1629002010(1)](images\1629002010(1).jpg)



![1629002062(1)](images\1629002062(1).jpg)

![1629002165(1)](images\1629002165(1).jpg)

 kubectl port-forward --address 0.0.0.0 -n istio thrift-sample-server-v1-6dbd6f7499-ckpnc 15001:15000

![1629002364(1)](images\1629002364(1).jpg)

![1629002401(1)](images\1629002401(1).jpg)

![1629002439(1)](images\1629002439(1).jpg)

![1629002487(1)](images\1629002487(1).jpg)

##### 13-9zoonkeeper&kafka

1部署应用

helm repo add bitnami https://charts.bitnami.com/bitnami

helm repo update

helm install my-release --set persistence.enabled=false --set zookeeper.persistence.enabled=false bitnami/kafka -n istio



applyto/kafka-zoonkeeper/kafka-sample.yaml

kubectl apply -f kafka-sample.yaml -n istio

```
kind: Deployment
apiVersion: apps/v1
metadata:
  name: kafka-cat-producer
spec:
  selector:
    matchLabels:
      app: kafka-cat-producer
  template:
    metadata:
      labels:
        app: kafka-cat-producer
    spec:
      containers:
        - name: kafka-cat-producer
          image: confluentinc/cp-kafkacat
          imagePullPolicy: IfNotPresent
          command: ["/bin/sh"]
          args: ["-c", "while true; do  echo -e 'send kafka message '`date`'\r\n'|kafkacat -P  -b my-release-kafka:9092 -t test; echo 'send message to kafka'; sleep $((1 + RANDOM % 11)); done"]
---
kind: Deployment
apiVersion: apps/v1
metadata:
  name: kafka-cat-consumer
spec:
  selector:
    matchLabels:
      app: kafka-cat-consumer
  template:
    metadata:
      labels:
        app: kafka-cat-consumer
    spec:
      containers:
        - name: kafka-cat-consumer
          image: confluentinc/cp-kafkacat
          imagePullPolicy: IfNotPresent
          command: ["/bin/sh"]
          args: ["-c", "kafkacat -C -b my-release-kafka:9092 -t test"]
```

2配置kafka envoyfilter

applyto/kafka-zoonkeeper/envoyfilter-kafka-filter.yaml

kubectl apply -f envoyfilter-kafka-filter.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: kafka-envoy-filter
spec:
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      listener:
        name: ${my-release-kafka}_9092    # sed -i .bak "s/\${my-release-kafka}/`kubectl get svc my-release-kafka -n kafka -o=jsonpath='{.spec.clusterIP}'`/" istio/envoyfilter-kafka-filter.yaml
        filterChain:
          filter:
            name: "envoy.filters.network.tcp_proxy"
    patch:
      operation: INSERT_BEFORE
      value:
        name: envoy.filters.network.kafka_broker
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.kafka_broker.v3.KafkaBroker
          stat_prefix: "outbound|9092||my-release-kafka.istio.svc.cluster.local"
```

替换${my-release-kafka}

3配置zoonkeeper envoyfilter

applyto/kafka-zoonkeeper/envoyfilter-zookeeper-filter.yaml

kubectl apply -f envoyfilter-zookeeper-filter.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: zookeeper-envoy-filter
spec:
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      listener:
        name: ${my-release-zookeeper}_2181    # sed -i .bak "s/\${my-release-zookeeper}/`kubectl get svc my-release-zookeeper -n kafka -o=jsonpath='{.spec.clusterIP}'`/" istio/envoyfilter-zookeeper-filter.yaml
        filterChain:
          filter:
            name: "envoy.filters.network.tcp_proxy"
    patch:
      operation: INSERT_BEFORE
      value:
        name: envoy.filters.network.zookeeper_proxy
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.zookeeper_proxy.v3.ZooKeeperProxy
          stat_prefix: "outbound|2181||my-release-zookeeper.istio.svc.cluster.local"
```

替换${my-release-zookeeper}

4测试

kubectl exec -it kafka-cat-consumer-6865bdcf9b-c55h9 -n istio -- /bin/bash

kafkacat -C -b my-release-kafka:9092 -t test

清理：

helm uninstall my-release -n istio

kubectl delete -f kafka-sample.yaml -n istio

kubectl delete envoyfilter kafka-envoy-filter -n istio

kubectl delete envoyfilter zookeeper-envoy-filter -n istio

 kubectl port-forward --address 0.0.0.0 -n istio my-release-kafka-0 15000:15000

![1629085519(1)](images\1629085519(1).jpg)

kubectl port-forward --address 0.0.0.0 -n istio my-release-zookeeper-0 15001:15000

![1629085640(1)](images\1629085640(1).jpg)



##### 13-10mysql_proxy

applyto/ef-network_filter_mysql.yaml

kubectl apply -f ef-network_filter_mysql.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: apply-to
spec:
  workloadSelector:
    labels:
      app: mysqldb
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      listener:
        portNumber: 3306
        filterChain:
          filter:
            name: "envoy.filters.network.tcp_proxy"
    patch:
      operation: INSERT_BEFORE
      value:
        name: envoy.filters.network.mysql_proxy
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.mysql_proxy.v3.MySQLProxy
          stat_prefix: mysql
  - applyTo: NETWORK_FILTER
    match:
      listener:
        portNumber: 3306
        filterChain:
          filter:
            name: "envoy.filters.network.tcp_proxy"
    patch:
      operation: INSERT_BEFORE
      value:
        name: envoy.filters.network.rbac
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.rbac.v3.RBAC
          stat_prefix: rbac
          rules:
             action: DENY
             policies:
               "product-viewer":
                 permissions:
                 - metadata:
                     filter: envoy.filters.network.mysql_proxy
                     path:
                     - key: t1.test
                     value:
                       list_match:
                         one_of:
                           string_match:
                             prefix: update
                 principals:
                 - any: true
          enforcement_type: CONTINUOUS 
          
```

注意修改listener ip

applyto/bookinfo-mysql.yaml 

kubectl apply -f bookinfo-mysql.yaml  -n istio

```
apiVersion: v1
kind: Secret
metadata:
  name: mysql-credentials
type: Opaque
data:
  rootpasswd: cGFzc3dvcmQ=
---
apiVersion: v1
kind: Service
metadata:
  name: mysqldb
  labels:
    app: mysqldb
    service: mysqldb
spec:
  ports:
  - port: 3306
    name: tcp
  selector:
    app: mysqldb
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysqldb-v1
  labels:
    app: mysqldb
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mysqldb
      version: v1
  template:
    metadata:
      labels:
        app: mysqldb
        version: v1
    spec:
      containers:
      - name: mysqldb
        image: docker.io/istio/examples-bookinfo-mysqldb:1.16.2
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 3306
        env:
          - name: MYSQL_ROOT_PASSWORD
            valueFrom:
              secretKeyRef:
                name: mysql-credentials
                key: rootpasswd
        args: ["--default-authentication-plugin","mysql_native_password"]
        volumeMounts:
        - name: var-lib-mysql
          mountPath: /var/lib/mysql
      volumes:
      - name: var-lib-mysql
        emptyDir: {}
---
```

gateway/gateway-mysql.yaml

kubectl apply -f gateway-mysql.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: mysql
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 3306
      name: mysql
      protocol: MYSQL
    hosts:
    - "*"
```

gateway/protocol/vs-mysql.yaml

kubectl apply -f vs-mysql.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: mysql
spec:
  hosts:
  - "*"
  gateways:
  - mysql
  tcp:
  - match:
    - port: 3306
    route:
    - destination:
        host: mysqldb.istio.svc.cluster.local
        port:
          number: 3306
```

mysql -h 192.168.198.154 --port nodeport -uroot -p

 test数据库创建t1表，插入几条数据，然后更新，会失败

清理：

kubectl delete -f bookinfo-mysql.yaml  -n istio

kubectl  delete envoyfilter apply-to -n istio

kubectl delete gw mysql -n istio

kubectl delete vs mysql -n istio



kubectl port-forward --address 0.0.0.0 -n istio mysqldb-v1-6f68664cbf-mrl22 15000:15000

![1629086642(1)](images\1629086642(1).jpg)







##### 13-11csrf

applyto/csrf/samesite/csrf-deploy.yaml 

kubectl apply -f csrf-deploy.yaml  -n istio

```
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: csrf
  labels:
    app: csrf
spec:
  selector:
    matchLabels:
      app: csrf
  replicas: 1
  template:
    metadata:
      labels:
        app: csrf
        version: v1
    spec:
      containers:
        - name: csrf
          image: registry.cn-hangzhou.aliyuncs.com/hxpdocker/csrf-satesite:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: csrf
spec:
  selector:
    app: csrf
  ports:
    - name: tcp-csrf
      protocol: TCP
      port: 8080
      targetPort: 8080
---
```



applyto/csrf/samesite/envoyfilter-csrf-gateway.yaml 

kubectl apply -f envoyfilter-csrf-gateway.yaml  -n istio-system

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: apply-to
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      listener:
        #name: 0.0.0.0_8080  
        portNumber: 8080
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
    patch:
      operation: MERGE
      value:
        name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": "type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager"
          codec_type: AUTO
          stat_prefix: ingress_http
          route_config:
            name: local_route
            virtual_hosts:
            - name: www
              domains:
              - "*"
              cors:
                allow_origin_string_match:
                - safe_regex:
                    google_re2: {}
                    regex: .*
                filter_enabled:
                  default_value:
                    numerator: 100
                    denominator: HUNDRED
              typed_per_filter_config:
                envoy.filters.http.csrf:
                  "@type": type.googleapis.com/envoy.extensions.filters.http.csrf.v3.CsrfPolicy
                  filter_enabled:
                    default_value:
                      numerator: 100
                      denominator: HUNDRED
                    runtime_key: csrf.www.enabled
                  shadow_enabled:
                    default_value:
                      numerator: 0
                      denominator: HUNDRED
                    runtime_key: csrf.www.shadow_enabled
              routes:
              - match:
                  prefix: "/csrf/disabled"
                route:
                  cluster: generic_service
                typed_per_filter_config:
                  envoy.filters.http.csrf:
                    "@type": type.googleapis.com/envoy.extensions.filters.http.csrf.v3.CsrfPolicy
                    filter_enabled:
                      default_value:
                        numerator: 0
                        denominator: HUNDRED
              - match:
                  prefix: "/csrf/shadow"
                route:
                  cluster: generic_service
                typed_per_filter_config:
                  envoy.filters.http.csrf:
                    "@type": type.googleapis.com/envoy.extensions.filters.http.csrf.v3.CsrfPolicy
                    filter_enabled:
                      default_value:
                        numerator: 0
                        denominator: HUNDRED
                    shadow_enabled:
                      default_value:
                        numerator: 100
                        denominator: HUNDRED
              - match:
                  prefix: "/csrf/additional_origin"
                route:
                  cluster: generic_service
                typed_per_filter_config:
                  envoy.filters.http.csrf:
                    "@type": type.googleapis.com/envoy.extensions.filters.http.csrf.v3.CsrfPolicy
                    filter_enabled:
                      default_value:
                        numerator: 100
                        denominator: HUNDRED
                    additional_origins:
                    - safe_regex:
                        google_re2: {}
                        regex: .*
              - match:
                  prefix: "/"
                route:
                  cluster: generic_service
  - applyTo: HTTP_FILTER
    match:
        listener:
          #name: 0.0.0.0_8080  
          portNumber: 8080
          filterChain:
            filter:
              name: envoy.filters.network.http_connection_manager
              subFilter:
                name: envoy.filters.http.router
    patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.filters.http.cors
          typed_config:                  
            "@type": type.googleapis.com/envoy.extensions.filters.http.cors.v3.Cors
  - applyTo: HTTP_FILTER
    match:
        listener:
          #name: 0.0.0.0_8080  
          portNumber: 8080
          filterChain:
            filter:
              name: envoy.filters.network.http_connection_manager
              subFilter:
                name: envoy.filters.http.router
    patch:
        operation: INSERT_BEFORE
        value:           
          name: envoy.filters.http.csrf
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.http.csrf.v3.CsrfPolicy
            filter_enabled:
              default_value:
                numerator: 100
                denominator: HUNDRED 
  - applyTo: CLUSTER
    match:
      context: ANY
      cluster: {} 
    patch:
      operation: ADD
      value:
        name: generic_service
        connect_timeout: 0.25s
        type: STRICT_DNS
        lb_policy: ROUND_ROBIN
        load_assignment:
          cluster_name: generic_service
          endpoints:
          - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: csrf.istio.svc.cluster.local
                    port_value: 8080
        
```

访问：http://192.168.198.154:31110/

文本框填入ip

192.168.198.199



清理：

kubectl delete -f csrf-deploy.yaml  -n istio

kubectl delete envoyfilter apply-to -n istio-system



 kubectl port-forward --address 0.0.0.0 -n istio-system istio-ingressgateway-8657768d87-bd767 15000:15000

![1629087404(1)](images\1629087404(1).jpg)

![1629087454(1)](images\1629087454(1).jpg)

![1629087493(1)](images\1629087493(1).jpg)



##### 13-12cors

index.html

154启动httpd

systemctl start httpd

```
<html>
<head><title></title></head>
<body>
<script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>  
<script>
$(function(){
        $("#cors").click(
                function(){
                        $.ajax({
                                type:"get",
                                dataType : "html",
                                url:"http://bookinfo.demo:30986/productpage",
                                success:function(data){
                                        alert(data);
                                }
                        })
                });

        $("#cors2").click(
                function(){
                        $.ajax({
                                type:"get",
                                dataType : "json",
                                url:"http://bookinfo.demo:30986/reviews/1",
                                contentType : 'application/json;charset=UTF-8',
                                success:function(data){
                                        var jsonStr = JSON.stringify(data);
                                        alert(jsonStr);
                                }
                        })
                });
          $("#cors3").click(
                function(){
                        $.ajax({
                                type:"delete",
                                contentType : 'application/json;charset=UTF-8',
                                dataType : "json",
                                url:"http://bookinfo.demo:30986/reviews/1",
                                success:function(data){
                                        var jsonStr = JSON.stringify(data);
                                        alert(jsonStr);
                                }
                        })
                });
           $("#cors4").click(
                function(){
                        $.ajax({
                                type:"get",
                                contentType : 'application/json;charset=UTF-8',
                                dataType : "json",
                                headers:{"X-Custom-Header":"value"},
                                url:"http://bookinfo.demo:30986/reviews/1",
                                success:function(data){
                                        var jsonStr = JSON.stringify(data);
                                        alert(jsonStr);
                                }
                        })
                });
         
});

</script>
<input type="button" id="cors" value="简单请求"/>
<input type="button" id="cors2" value="非简单请求"/>
<input type="button" id="cors3" value="非简单请求delete"/>
<input type="button" id="cors4" value="非简单请求headers"/>
</body>
</html>
```



applyto/cors/ef-cors.yaml

kubectl apply -f ef-cors.yaml -n istio-system

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: apply-to
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      listener:
        name: 0.0.0.0_8080  
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
    patch:
      operation: MERGE
      value:
        name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": "type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager"
          codec_type: AUTO
          stat_prefix: ingress_http
          route_config:
            name: local_route
            virtual_hosts:
            - name: local_route
              domains:
              - "*"
              cors:
                allow_methods: "GET,POST,OPTIONS,DELETE"
                allow_headers: "content-type,x-custom-header"
                max_age: "60"
                allow_origin_string_match:
                - exact: "http://mytest.com:8081"
                filter_enabled:
                  default_value:
                    numerator: 100
                    denominator: HUNDRED
              routes:
              - match:
                  path: "/productpage"
                route:
                  cluster: outbound|9080||productpage.istio.svc.cluster.local
              - match:
                  prefix: "/reviews"
                route:
                  cluster: outbound|9080||reviews.istio.svc.cluster.local
  
           
```

访问：

http://mytest.com:8081/

清理：

kubectl delete envoyfilter apply-to -n istio-system



 kubectl port-forward --address 0.0.0.0 -n istio-system istio-ingressgateway-8657768d87-bd767 15000:15000

![1629087792(1)](images\1629087792(1).jpg)





##### 13-13ext_authz



applyto/ext_authz/auth_deploy.yaml

kubectl apply -f auth_deploy.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: auth
  labels:
    app: auth
spec:
  ports:
  - name: http
    port: 9002
    targetPort: 9002
  selector:
    app: auth
---
kind: Deployment
apiVersion: apps/v1
metadata:
  name: auth
  labels:
    app: auth
spec:
  replicas: 1
  selector:
    matchLabels:
      app: auth
  template:
    metadata:
      labels:
        app: auth
    spec:
      containers:
        - name: auth
          imagePullPolicy: Always
          image: registry.cn-hangzhou.aliyuncs.com/hxpdocker/ext_authz_grpc:latest 
          ports:
          - containerPort: 9002
```

applyto/ext_authz/ef-ext_auth.yaml

kubectl apply -f ef-ext_auth.yaml -n istio-system

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: apply-to
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      listener:
        name: 0.0.0.0_8080  
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
    patch:
      operation: MERGE
      value:
        name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": "type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager"
          codec_type: AUTO
          stat_prefix: ingress_http
          route_config:
            name: local_route
            virtual_hosts:
            - name: upstream
              domains:
              - "*"
              routes:
              - match:
                  prefix: "/"
                route:
                  cluster: outbound|9080||productpage.istio.svc.cluster.local
  - applyTo: HTTP_FILTER
    match:
        listener:
          name: 0.0.0.0_8080  
          filterChain:
            filter:
              name: envoy.filters.network.http_connection_manager
              subFilter:
                name: envoy.filters.http.router
    patch:
        operation: INSERT_BEFORE
        value: 
            name: envoy.filters.http.ext_authz
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthz
              transport_api_version: V3
              http_service:
                server_uri:
                  uri: ext_authz
                  cluster: ext_authz-http-service
                  timeout:  0.250s
                authorization_response:
                  allowed_upstream_headers:
                    patterns:
                    - exact: x-current-user
  - applyTo: CLUSTER
    match:
      context: ANY
      cluster: {} 
    patch:
      operation: ADD
      value:
        name: ext_authz-http-service
        connect_timeout: 0.25s
        type: STRICT_DNS
        lb_policy: ROUND_ROBIN
        load_assignment:
          cluster_name: grpc-authservice
          endpoints:
          - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: auth.istio.svc.cluster.local
                    port_value: 9002
```

测试

curl  http://bookinfo.demo:30986/productpage  -H "Authorization: Bearer token1"

curl  http://bookinfo.demo:30986/productpage  -H "Authorization: Bearer token10"

清理：

kubectl delete -f auth_deploy.yaml -n istio

kubectl delete envoyfilter apply-to -n istio-system



 kubectl port-forward --address 0.0.0.0 -n istio-system istio-ingressgateway-8657768d87-bd767 15000:15000

![1629088087(1)](images\1629088087(1).jpg)

![1629088127(1)](images\1629088127(1).jpg)

![1629088185(1)](images\1629088185(1).jpg)



#### 13-14HTTP_FILTER

virtaulservice/vs-bookinfo-star.yaml

kubectl apply -f vs-bookinfo-star.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: bookinfo
spec:
  exportTo:
  - '*'
  hosts:
  - "*"
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        prefix: /static
    - uri:
        exact: /login
    - uri:
        exact: /logout
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage.istio.svc.cluster.local
        port:
          number: 9080
```



kubectl apply -f gateway-01.yaml -n istio

gateway/gateway-01.yaml

```
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
```



ef-ingressgateway-http-filter-remove.yaml

kubectl apply -f ef-ingressgateway-http-filter-remove.yaml -n istio-system

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: apply-to
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      listener:
        portNumber: 8080
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
            subFilter:
              name: "envoy.filters.http.fault"
    patch:
      operation: REMOVE
```

清理：

kubectl delete envoyfilter apply-to -n istio-system

kubectl delete vs bookinfo -n istio

kubectl delete gw bookinfo-gateway -n istio



![1629091154(1)](images\1629091154(1).jpg)



virtaulservice/vs-bookinfo-star.yaml

kubectl apply -f vs-bookinfo-star.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: bookinfo
spec:
  exportTo:
  - '*'
  hosts:
  - "*"
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        prefix: /static
    - uri:
        exact: /login
    - uri:
        exact: /logout
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage.istio.svc.cluster.local
        port:
          number: 9080
```



kubectl apply -f gateway-01.yaml -n istio

gateway/gateway-01.yaml

```
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
```



ef-ingressgateway-http-filter-compression.yaml 

kubectl apply -f ef-ingressgateway-http-filter-compression.yaml  -n istio-system

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  namespace: istio-system
  name: apply-to
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
    - applyTo: HTTP_FILTER
      match:
        context: GATEWAY
        listener:
          filterChain:
            filter:
              name: envoy.filters.network.http_connection_manager
              subFilter:
                name: envoy.filters.http.router
      patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.filters.http.compressor
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.http.compressor.v3.Compressor
            response_direction_config:
              common_config:
                min_content_length: 100
                content_type:
                - 'text/html'
            compressor_library:
              name: text_optimized
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.compression.gzip.compressor.v3.Gzip
                memory_level: 3
                window_bits: 10
                compression_level: BEST_COMPRESSION
                compression_strategy: DEFAULT_STRATEGY
```

访问,查看响应头

![1629091325(1)](images\1629091325(1).jpg)

ef-ingressgateway-http-filter-compression-insert-after.yaml 

kubectl apply -f ef-ingressgateway-http-filter-compression-insert-after.yaml  -n istio-system

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  namespace: istio-system
  name: apply-to
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
    - applyTo: HTTP_FILTER
      match:
        context: GATEWAY
        listener:
          filterChain:
            filter:
              name: envoy.filters.network.http_connection_manager
              subFilter:
                name: istio.metadata_exchange
      patch:
        operation: INSERT_AFTER
        value:
          name: envoy.filters.http.compressor
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.http.compressor.v3.Compressor
            response_direction_config:
              common_config:
                min_content_length: 100
                content_type:
                - 'text/html'
            compressor_library:
              name: text_optimized
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.compression.gzip.compressor.v3.Gzip
                memory_level: 3
                window_bits: 10
                compression_level: BEST_COMPRESSION
                compression_strategy: DEFAULT_STRATEGY
```

访问

清理：

kubectl delete envoyfilter apply-to -n istio-system

kubectl delete vs bookinfo -n istio

kubectl delete gw bookinfo-gateway -n istio

![1629091424(1)](images\1629091424(1).jpg)







##### 13-15本地限流

envoyfilter/ratelimit/envoyfilter-local-rate-limit.yaml

kubectl apply -f envoyfilter-local-rate-limit.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: filter-local-ratelimit-svc
spec:
  workloadSelector:
    labels:
      app: productpage
  configPatches:
    - applyTo: HTTP_FILTER
      match:
        listener:
          filterChain:
            filter:
              name: "envoy.filters.network.http_connection_manager"
      patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.filters.http.local_ratelimit
          typed_config:
            "@type": type.googleapis.com/udpa.type.v1.TypedStruct
            type_url: type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
            value:
              stat_prefix: http_local_rate_limiter
              token_bucket:
                max_tokens: 10
                tokens_per_fill: 10
                fill_interval: 60s
              filter_enabled:
                runtime_key: local_rate_limit_enabled
                default_value:
                  numerator: 100
                  denominator: HUNDRED
              filter_enforced:
                runtime_key: local_rate_limit_enforced
                default_value:
                  numerator: 100
                  denominator: HUNDRED
              response_headers_to_add:
                - append: false
                  header:
                    key: x-local-rate-limit
                    value: 'true'
```

virtaulservice/vs-bookinfo-star.yaml

kubectl apply -f vs-bookinfo-star.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: bookinfo
spec:
  exportTo:
  - '*'
  hosts:
  - "*"
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        prefix: /static
    - uri:
        exact: /login
    - uri:
        exact: /logout
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage.istio.svc.cluster.local
        port:
          number: 9080
```



kubectl apply -f gateway-01.yaml -n istio

gateway/gateway-01.yaml

```
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
```

访问：



清理：

kubectl delete envoyfilter filter-local-ratelimit-svc -n istio

kubectl delete vs bookinfo -n istio

kubectl delete gw bookinfo-gateway -n istio



kubectl port-forward --address 0.0.0.0 -n istio productpage-v1-659776cb44-q8xzp 15001:15000

![1629091941(1)](images\1629091941(1).jpg)





##### 13-16lua filter

ef-http-filter-lua.yaml

kubectl apply -f ef-http-filter-lua.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: apply-to
spec:
  workloadSelector:
    labels:
      app: productpage
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_INBOUND
      listener:
        portNumber: 9080
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
            subFilter:
              name: "envoy.filters.http.router"
    patch:
      operation: INSERT_BEFORE
      value: 
       name: envoy.filters.http.lua
       typed_config:
          "@type": "type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua"
          inlineCode: |
            function envoy_on_response(response_handle)
                response_handle:logInfo(" ========= XXXXX ========== ")
                response_handle:headers():add("X-User-Header", "worked")
            end
```

virtaulservice/vs-bookinfo-star.yaml

kubectl apply -f vs-bookinfo-star.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: bookinfo
spec:
  exportTo:
  - '*'
  hosts:
  - "*"
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        prefix: /static
    - uri:
        exact: /login
    - uri:
        exact: /logout
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage.istio.svc.cluster.local
        port:
          number: 9080
```



kubectl apply -f gateway-01.yaml -n istio

gateway/gateway-01.yaml

```
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
```

访问

![1619333771(1)](images\1619333771(1).jpg)

清理：

kubectl delete envoyfilter apply-to -n istio

kubectl delete vs bookinfo -n istio

kubectl delete gw bookinfo-gateway -n istio

kubectl port-forward --address 0.0.0.0 -n istio productpage-v1-659776cb44-q8xzp 15001:15000

![1629092277(1)](images\1629092277(1).jpg)





##### 13-17grpc_web

deploy

applyto/web-grpc/web-grpc-deploy.yaml

kubectl apply -f web-grpc-deploy.yaml -n istio

```
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: web-grpc
  labels:
    app: web-grpc
spec:
  selector:
    matchLabels:
      app: web-grpc
  replicas: 1
  template:
    metadata:
      labels:
        app: web-grpc
        version: v1
    spec:
      containers:
        - name: csrf
          image: registry.cn-hangzhou.aliyuncs.com/hxpdocker/server:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 50051
---
apiVersion: v1
kind: Service
metadata:
  name: web-grpc
spec:
  selector:
    app: web-grpc
  ports:
    - name: grpc-web-grpc
      protocol: TCP
      port: 50051
      targetPort: 50051
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: web-grpc-client
  labels:
    app: web-grpc-client
spec:
  selector:
    matchLabels:
      app: web-grpc-client
  replicas: 1
  template:
    metadata:
      labels:
        app: web-grpc-client
        version: v1
    spec:
      containers:
        - name: csrf
          image: registry.cn-hangzhou.aliyuncs.com/hxpdocker/client:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: web-grpc-client
spec:
  selector:
    app: web-grpc-client
  ports:
    - name: http-web-grpc-client
      protocol: TCP
      port: 8080
      targetPort: 8080
```

注意svc的port的名字grpc-web-grpc，表名用的是grpc协议

vs

applyto/web-grpc/vs-web-grpc.yaml

kubectl apply -f vs-web-grpc.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: web-grpc
spec:
  hosts:
  - "*"
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        prefix: /s12.example
    corsPolicy:
      allowOrigins:
      - exact: http://192.168.198.154:30986
      - exact: http://192.168.198.154:8081
      allowMethods:
      - GET
      - OPTIONS
      - POST
      - PUT
      - DELETE
      maxAge: "1m"
      allowHeaders:
      - keep-alive
      - user-agent
      - cache-control
      - content-type
      - content-transfer-encoding
      - custom-header-1
      - x-accept-content-transfer-encoding
      - x-accept-response-streaming
      - x-user-agent
      - x-grpc-web
      - grpc-timeout
      exposeHeaders: 
      - custom-header-1
      - grpc-status
      - grpc-message
    route:
    - destination:
        host: web-grpc.istio.svc.cluster.local
        port:
          number: 50051
```

applyto/web-grpc/vs-web-grpc-client.yaml

kubectl apply -f vs-web-grpc-client.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: bookinfo
spec:
  hosts:
  - "*"
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        prefix: /
    route:
    - destination:
        host: web-grpc-client.istio.svc.cluster.local
        port:
          number: 8080
```

applyto/web-grpc/ef-web-grpc.yaml

kubectl apply -f ef-web-grpc.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: apply-to
spec:
  workloadSelector:
    labels:
      app: web-grpc
  configPatches:
  - applyTo: HTTP_FILTER
    match:
        listener:
          filterChain:
            destinationPort: 50051
            transportProtocol: "tls"
            filter:
              name: envoy.filters.network.http_connection_manager
              subFilter:
                name: istio.metadata_exchange
    patch:
        operation: INSERT_BEFORE
        value:           
          name: envoy.filters.http.grpc_web
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.http.grpc_web.v3.GrpcWeb
```

访问：

http://192.168.198.154:30986/

清理：

kubectl delete envoyfilter apply-to -n istio

kubectl delete vs bookinfo -n istio

kubectl delete vs web-grpc -n istio

kubectl delete -f web-grpc-deploy.yaml -n istio

kubectl port-forward --address 0.0.0.0 -n istio-system istio-ingressgateway-8657768d87-bd767 15000:15000

![1629093409(1)](images\1629093409(1).jpg)

![1629093481(1)](images\1629093481(1).jpg)

kubectl port-forward --address 0.0.0.0 -n istio web-grpc-7b69f98988-kccgj 15002:15000

![1629093671(1)](images\1629093671(1).jpg)



##### 13-18fault

applyto/fault/ef-fault.yaml

kubectl  apply -f ef-fault.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: apply-to
spec:
  workloadSelector:
    labels:
      app: productpage
  configPatches:
    - applyTo: HTTP_FILTER
      match:
        context: ANY
        listener:
          filterChain:
            filter:
              name: "envoy.filters.network.http_connection_manager"
              subFilter:
                name: "envoy.filters.http.router"
      patch:
        operation: INSERT_BEFORE
        value:
            name: envoy.filters.http.fault
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.fault.v3.HTTPFault
              abort:
                http_status: 503
                percentage:
                  numerator: 100
                  denominator: HUNDRED
              delay:
                fixed_delay: 3s
                percentage:
                  numerator: 100
                  denominator: HUNDRED
```

virtaulservice/vs-bookinfo-star.yaml

kubectl apply -f vs-bookinfo-star.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: bookinfo
spec:
  exportTo:
  - '*'
  hosts:
  - "*"
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        prefix: /static
    - uri:
        exact: /login
    - uri:
        exact: /logout
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage.istio.svc.cluster.local
        port:
          number: 9080
```



kubectl apply -f gateway-01.yaml -n istio

gateway/gateway-01.yaml

```
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
```

访问

清理：

kubectl  delete vs bookinfo  -n istio

kubectl delete gw bookinfo-gateway -n istio

kubectl delete envoyfilter apply-to -n istio



 kubectl port-forward --address 0.0.0.0 -n istio productpage-v1-659776cb44-q8xzp 15001:15000

![1629094033(1)](images\1629094033(1).jpg)



#### 13-19ROUTE_CONFIGURATION

ef-ingressgateway-route-configuration.yaml  

kubectl apply -f ef-ingressgateway-route-configuration.yaml     -n istio  

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: apply-to
spec:
  workloadSelector:
    labels:
      app: productpage
  configPatches:
  - applyTo: ROUTE_CONFIGURATION
    match:
      context: SIDECAR_INBOUND
      routeConfiguration:
        portNumber: 9080
    patch:
      operation: MERGE
      value:
          name: "inbound|9080||"
          virtual_hosts:
          - name: “inbound|http|9080”
            domains:
            - "productpage.istio.svc.cluster.local"
            - "productpage.istio.svc.cluster.local:9080"
            - "productpage"
            - "productpage:9080"
            - "productpage.istio.svc.cluster"
            - "productpage.istio.svc.cluster:9080"
            - "productpage.istio.svc"
            - "productpage.istio.svc:9080"
            - "productpage.istio"
            - "productpage.istio:9080"
            routes:
            - match:
                prefix: "/"
              direct_response:
                status: 200
                body:
                  inline_string: "example body\n"
```

kubectl apply -f gateway-01.yaml -n istio

gateway/gateway-01.yaml

```
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
```

访问

清理：

kubectl delete gw bookinfo-gateway -n istio

kubectl delete envoyfilter apply-to -n istio

kubectl delete vs bookinfo -n istio

kubectl port-forward --address 0.0.0.0 -n istio productpage-v1-659776cb44-q8xzp 15000:15000

![1629172763(1)](images\1629172763(1).jpg)





#### 13-20VIRTUAL_HOST

##### 全局限流

部署ratelimit

1创建cm

ratelimit/ratelimit-config.yaml

kubectl apply -f ratelimit-config.yaml -n istio

```
apiVersion: v1
kind: ConfigMap
metadata:
  name: ratelimit-config
data:
  config.yaml: |
    domain: productpage-ratelimit
    descriptors:
      - key: PATH
        value: "/productpage"
        rate_limit:
          unit: minute
          requests_per_unit: 1
      - key: PATH
        rate_limit:
          unit: minute
          requests_per_unit: 100
```

2创建deployment

ratelimit/ratelimit-deploy.yaml

kubectl apply -f ratelimit-deploy.yaml -n istio

```
apiVersion: v1
kind: Service
metadata:
  name: redis
  labels:
    app: redis
spec:
  ports:
  - name: redis
    port: 6379
  selector:
    app: redis
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis
spec:
  replicas: 1
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
    spec:
      containers:
      - image: redis:alpine
        imagePullPolicy: Always
        name: redis
        ports:
        - name: redis
          containerPort: 6379
      restartPolicy: Always
      serviceAccountName: ""
---
apiVersion: v1
kind: Service
metadata:
  name: ratelimit
  labels:
    app: ratelimit
spec:
  ports:
  - name: http-port
    port: 8080
    targetPort: 8080
    protocol: TCP
  - name: grpc-port
    port: 8081
    targetPort: 8081
    protocol: TCP
  - name: http-debug
    port: 6070
    targetPort: 6070
    protocol: TCP
  selector:
    app: ratelimit
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ratelimit
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ratelimit
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: ratelimit
    spec:
      containers:
      - image: envoyproxy/ratelimit:6f5de117 # 2021/01/08
        imagePullPolicy: Always
        name: ratelimit
        command: ["/bin/ratelimit"]
        env:
        - name: LOG_LEVEL
          value: debug
        - name: REDIS_SOCKET_TYPE
          value: tcp
        - name: REDIS_URL
          value: redis:6379
        - name: USE_STATSD
          value: "false"
        - name: RUNTIME_ROOT
          value: /data
        - name: RUNTIME_SUBDIRECTORY
          value: ratelimit
        ports:
        - containerPort: 8080
        - containerPort: 8081
        - containerPort: 6070
        volumeMounts:
        - name: config-volume
          mountPath: /data/ratelimit/config/config.yaml
          subPath: config.yaml
      volumes:
      - name: config-volume
        configMap:
          name: ratelimit-config
```

3创建envoy-filter

ratelimit/envoyfilter-filter.yaml

kubectl apply -f envoyfilter-filter.yaml -n istio-system

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: filter-ratelimit
  namespace: istio-system
spec:
  workloadSelector:
    # select by label in the same namespace
    labels:
      istio: ingressgateway
  configPatches:
    # The Envoy config you want to modify
    - applyTo: HTTP_FILTER
      match:
        context: GATEWAY
        listener:
          filterChain:
            filter:
              name: "envoy.filters.network.http_connection_manager"
              subFilter:
                name: "envoy.filters.http.router"
      patch:
        operation: INSERT_BEFORE
        # Adds the Envoy Rate Limit Filter in HTTP filter chain.
        value:
          name: envoy.filters.http.ratelimit
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.http.ratelimit.v3.RateLimit
            # domain can be anything! Match it to the ratelimter service config
            domain: productpage-ratelimit
            failure_mode_deny: true
            rate_limit_service:
              grpc_service:
                envoy_grpc:
                  cluster_name: rate_limit_cluster
                timeout: 10s
              transport_api_version: V3
    - applyTo: CLUSTER
      match:
        cluster:
          service: ratelimit.istio.svc.cluster.local
      patch:
        operation: ADD
        # Adds the rate limit service cluster for rate limit service defined in step 1.
        value:
          name: rate_limit_cluster
          type: STRICT_DNS
          connect_timeout: 10s
          lb_policy: ROUND_ROBIN
          http2_protocol_options: {}
          load_assignment:
            cluster_name: rate_limit_cluster
            endpoints:
            - lb_endpoints:
              - endpoint:
                  address:
                     socket_address:
                      address: ratelimit.istio.svc.cluster.local
                      port_value: 8081
```

4创建action envoyfilter

ratelimit/envoyfilter-action.yaml 

kubectl apply -f envoyfilter-action.yaml  -n istio-system

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: filter-ratelimit-svc
  namespace: istio-system
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
    - applyTo: VIRTUAL_HOST
      match:
        context: GATEWAY
        routeConfiguration:
          vhost:
            name: "*:80"
            route:
              action: ANY
      patch:
        operation: MERGE
        # Applies the rate limit rules.
        value:
          rate_limits:
            - actions: # any actions in here
              - request_headers:
                  header_name: ":path"
                  descriptor_key: "PATH"
```

virtaulservice/vs-bookinfo-star.yaml

kubectl apply -f vs-bookinfo-star.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: bookinfo
spec:
  exportTo:
  - '*'
  hosts:
  - "*"
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        prefix: /static
    - uri:
        exact: /login
    - uri:
        exact: /logout
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage.istio.svc.cluster.local
        port:
          number: 9080
```



kubectl apply -f gateway-01.yaml -n istio

gateway/gateway-01.yaml

```
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
```



5访问

http://bookinfo.demo:30986/productpage

返回429，太多请求错误

清理：

kubectl delete envoyfilter filter-ratelimit-svc -n istio-system

kubectl delete envoyfilter filter-ratelimit -n istio-system

kubectl delete -f ratelimit-deploy.yaml -n istio

kubectl delete cm ratelimit-config -n istio

kubectl delete vs bookinfo -n istio

kubectl delete gw bookinfo-gateway -n istio



![1629173499(1)](images\1629173499(1).jpg)

![1629173545(1)](images\1629173545(1).jpg)

![1629173616(1)](images\1629173616(1).jpg)



##### 基于sentinel的限流

envoyfilters/ratelimit/sentinel/config.yaml 

kubectl apply -f config.yaml  -n istio

```
apiVersion: v1
kind: ConfigMap
metadata:
  name: ratelimit-config
data:
  config.yaml: |
    domain: productpage-ratelimit
    descriptors:
      - key: PATH
        value: "/productpage"
        rate_limit:
          unit: minute
          requests_per_unit: 1
      - key: PATH
        rate_limit:
          unit: minute
          requests_per_unit: 100
```

envoyfilters/ratelimit/sentinel/sentinel-deploy.yaml

kubectl apply -f sentinel-deploy.yaml -n istio

```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sentinel-rls-server
  labels:
    app: sentinel
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sentinel
  template:
    metadata:
      labels:
        app: sentinel
    spec:
      containers:
        - name: sentinelserver
          image: "registry.cn-hangzhou.aliyuncs.com/hxpdocker/sentinel-envoy-rls-server:latest"
          imagePullPolicy: Always
          ports:
            - containerPort: 10245
            - containerPort: 8719
          volumeMounts:
            - name: sentinel-rule-config
              mountPath: /tmp/sentinel
          env:
            - name: SENTINEL_RLS_RULE_FILE_PATH
              value: "/tmp/sentinel/rule.yaml"
      volumes:
        - name: sentinel-rule-config
          configMap:
            name: ratelimit-config
            items:
              - key: config.yaml
                path: rule.yaml
---
apiVersion: v1
kind: Service
metadata:
  name: sentinel-rls-service
  labels:
    name: sentinel-rls-service
spec:
  type: ClusterIP
  ports:
    - port: 8719
      targetPort: 8719
      name: sentinel-command
    - port: 10245
      targetPort: 10245
      name: sentinel-grpc
  selector:
    app: sentinel
```

envoyfilters/ratelimit/sentinel/ef-sentinel-filter.yaml

kubectl apply -f ef-sentinel-filter.yaml -n istio-system

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: filter-ratelimit
  namespace: istio-system
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
    - applyTo: HTTP_FILTER
      match:
        context: GATEWAY
        listener:
          filterChain:
            filter:
              name: "envoy.filters.network.http_connection_manager"
              subFilter:
                name: "envoy.filters.http.router"
      patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.filters.http.ratelimit
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.http.ratelimit.v3.RateLimit
            domain: productpage-ratelimit
            failure_mode_deny: true
            stage: 0
            rate_limit_service:
              grpc_service:
                envoy_grpc:
                  cluster_name: outbound|10245||sentinel-rls-service.istio.svc.cluster.local
                timeout: 10s
              transport_api_version: V3
```

ef-sentinel-filter-action.yaml

kubectl apply -f ef-sentinel-filter-action.yaml -n istio-system

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: filter-ratelimit-svc
  namespace: istio-system
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
    - applyTo: VIRTUAL_HOST
      match:
        context: GATEWAY
        routeConfiguration:
          vhost:
            name: "*:80"
            route:
              action: ANY
      patch:
        operation: MERGE
        value:
          rate_limits:
          - actions: 
              - request_headers:
                  header_name: ":path"
                  descriptor_key: "PATH"
```

清理：

kubectl delete envoyfilter filter-ratelimit-svc -n istio-system

kubectl delete envoyfilter filter-ratelimit -n istio-system

kubectl delete -f sentinel-deploy.yaml -n istio

kubectl delete cm ratelimit-config -n istio

kubectl delete vs bookinfo -n istio

kubectl delete gw bookinfo-gateway -n istio







#### 13-21cache

还在开发中

 applyto/cache/cache-deploy.yaml

```
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cache
  labels:
    app: cache
spec:
  selector:
    matchLabels:
      app: cache
  replicas: 1
  template:
    metadata:
      labels:
        app: cache
        version: v1
    spec:
      containers:
        - name: cache
          image: registry.cn-hangzhou.aliyuncs.com/hxpdocker/cache:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 8083
---
apiVersion: v1
kind: Service
metadata:
  name: cache
spec:
  selector:
    app: cache
  ports:
    - name: tcp-cache
      protocol: TCP
      port: 8083
      targetPort: 8083
```

applyto/cache/vs-cache.yaml

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: cache
spec:
  hosts:
  - "*"
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        prefix: /service
    route:
    - destination:
        host: cache.istio.svc.cluster.local
        port:
          number: 8083
```

applyto/cache/ef-cache.yaml

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: apply-to
spec:
  workloadSelector:
    labels:
      app: cache
  configPatches:
    - applyTo: HTTP_FILTER
      match:
        context: GATEWAY
        listener:
          filterChain:
            filter:
              name: "envoy.filters.network.http_connection_manager"
              subFilter:
                name: "envoy.filters.http.router"
      patch:
        operation: INSERT_FIRST
        value:
            name: "envoy.filters.http.cache.simple_http_cache"
            typed_config:
              "@type": "type.googleapis.com/envoy.extensions.filters.http.cache.v3alpha.CacheConfig"
              typed_config:
                "@type": "type.googleapis.com/envoy.extensions.cache.simple_http_cache.v3alpha.SimpleHttpCacheConfig"

```

记得修改时区

http://bookinfo.demo:30986/service/1/valid-for-minute

http://bookinfo.demo:30986/service/1/private

http://bookinfo.demo:30986/service/1/no-cache

#### 13-22HTTP_ROUTE

ef-ingressgateway-http-route.yaml

kubectl  apply -f ef-ingressgateway-http-route.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: apply-to
spec:
  workloadSelector:
    labels:
      app: productpage
  configPatches:
    - applyTo: HTTP_ROUTE
      match:
        context: SIDECAR_INBOUND
        routeConfiguration:
          portNumber: 9080
      patch:
        operation: MERGE
        value:
          match:
            #headers:
            #  - name: some-header
            #    present_match: true
            prefix: /
          direct_response:
                status: 200
                body:
                  inline_string: "example body\n"
```

virtaulservice/vs-bookinfo-star.yaml

kubectl apply -f vs-bookinfo-star.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: bookinfo
spec:
  exportTo:
  - '*'
  hosts:
  - "*"
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        prefix: /static
    - uri:
        exact: /login
    - uri:
        exact: /logout
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage.istio.svc.cluster.local
        port:
          number: 9080
```



kubectl apply -f gateway-01.yaml -n istio

gateway/gateway-01.yaml

```
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
```

访问

清理：

kubectl delete vs bookinfo -n istio

kubectl delete gw bookinfo-gateway -n istio

kubectl delete envoyfilter apply-to -n istio



kubectl port-forward --address 0.0.0.0 -n istio productpage-v1-659776cb44-q8xzp 15000:15000

![1629173911(1)](images\1629173911(1).jpg)



#### 13-23CLUSTER

ef-productpage-cluster.yaml

kubectl apply -f ef-productpage-cluster.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: apply-to
  namespace: istio 
spec:
  workloadSelector:
    labels:
      app: productpage
  configPatches:
  - applyTo: HTTP_ROUTE
    match:
      context: SIDECAR_INBOUND
      routeConfiguration:
        portNumber: 9080
    patch:
        operation: MERGE
        value:
          match:
            prefix: /
          route:
            cluster: "cluster123"
            timeout: "111s"
  - applyTo: CLUSTER
    patch:
      operation: ADD
      value: 
        name: "cluster123"
        type: STATIC
        connect_timeout: 0.5s
        lb_policy: ROUND_ROBIN
        load_assignment:
          cluster_name: cluster123
          endpoints:
          - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: 127.0.0.1
                    port_value: 9080
```

virtaulservice/vs-bookinfo-star.yaml

kubectl apply -f vs-bookinfo-star.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: bookinfo
spec:
  exportTo:
  - '*'
  hosts:
  - "*"
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        prefix: /static
    - uri:
        exact: /login
    - uri:
        exact: /logout
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage.istio.svc.cluster.local
        port:
          number: 9080
```



kubectl apply -f gateway-01.yaml -n istio

gateway/gateway-01.yaml

```
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
```

访问

清理：

kubectl delete vs bookinfo -n istio

kubectl delete gw bookinfo-gateway -n istio

kubectl delete envoyfilter apply-to -n istio

kubectl port-forward --address 0.0.0.0 -n istio productpage-v1-659776cb44-q8xzp 15000:15000

![1629174089(1)](images\1629174089(1).jpg)

![1629174130(1)](images\1629174130(1).jpg)

![1629174169(1)](images\1629174169(1).jpg)





redis_proxy

1部署redis

applyto/redis/redis-cluster-deploy.yaml

kubectl apply -f redis-cluster-deploy.yaml -n istio

```
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: redis-cluster
data:
  update-node.sh: |
    #!/bin/sh
    REDIS_NODES="/data/nodes.conf"
    sed -i -e "/myself/ s/[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}/${POD_IP}/" ${REDIS_NODES}
    exec "$@"
  redis.conf: |+
    cluster-enabled yes
    cluster-require-full-coverage no
    cluster-node-timeout 15000
    cluster-config-file /data/nodes.conf
    cluster-migration-barrier 1
    appendonly yes
    protected-mode no
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: redis-cluster
spec:
  serviceName: redis-cluster
  replicas: 6
  selector:
    matchLabels:
      app: redis-cluster
  template:
    metadata:
      labels:
        app: redis-cluster
    spec:
      containers:
      - name: redis
        image: redis:6.0.8-alpine
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 6379
          name: tcp-client
        - containerPort: 16379
          name: tcp-gossip
        command: ["/conf/update-node.sh", "redis-server", "/conf/redis.conf", "--cluster-announce-ip $(POD_IP)"]
        env:
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: conf
          mountPath: /conf
          readOnly: false
      volumes:
      - name: conf
        configMap:
          name: redis-cluster
          defaultMode: 0755

---
apiVersion: v1
kind: Service
metadata:
  name: redis-cluster
spec:
  type: ClusterIP
  clusterIP: None
  ports:
  - port: 6379
    targetPort: 6379
    name: tcp-client
  - port: 16379
    targetPort: 16379
    name: tcp-gossip
  selector:
    app: redis-cluster
    
---
apiVersion: v1
kind: Service
metadata:
  name: redis-cluster-op
spec:
  type: ClusterIP
  ports:
  - port: 6379
    targetPort: 6379
    name: tcp-client
  - port: 16379
    targetPort: 16379
    name: tcp-gossip
  selector:
    app: redis-cluster
```

applyto/redis/redis-client-deploy.yaml

kubectl apply -f redis-client-deploy.yaml -n istio

```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis-client
  labels:
    app: redis-client
spec:
  selector:
    matchLabels:
      app: redis-client
  replicas: 1
  template:
    metadata:
      labels:
        app: redis-client
    spec:
      containers:
      - name: redis-client
        image: redis
        imagePullPolicy: IfNotPresent
```

applyto/redis/redis-mirror-deploy.yaml

kubectl apply -f redis-mirror-deploy.yaml -n istio

```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis-mirror
  labels:
    app: redis-mirror
spec:
  selector:
    matchLabels:
      app: redis-mirror
  replicas: 1
  template:
    metadata:
      labels:
        app: redis-mirror
    spec:
      containers:
      - name: redis-mirror
        image: redis
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 6379

---
apiVersion: v1
kind: Service
metadata:
  name: redis-mirror
spec:
  selector:
    app: redis-mirror
  ports:
  - name: tcp  # istio will treat it as a normal tcp service since the prefix is tcp
    port: 6379
    protocol: TCP
    targetPort: 6379
```

2设置 envoyfilter cluster

applyto/redis/envoyfilter-cluster.yaml

kubectl apply -f envoyfilter-cluster.yaml -n istio-system

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: custom-redis-cluster
  namespace: istio-system
spec:
  configPatches:
  - applyTo: CLUSTER
    patch:
      operation: INSERT_FIRST
      value:
        name: "custom-redis-cluster"
        type: STRICT_DNS
        connect_timeout: 0.5s
        #lb_policy: CLUSTER_PROVIDED
        lb_policy: MAGLEV
        load_assignment:
          cluster_name: custom-redis-cluster
          endpoints:
          - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: redis-cluster-0.redis-cluster.istio.svc.cluster.local
                    port_value: 6379
            - endpoint:
                address:
                  socket_address:
                    address: redis-cluster-1.redis-cluster.istio.svc.cluster.local
                    port_value: 6379
            - endpoint:
                address:
                  socket_address:
                    address: redis-cluster-2.redis-cluster.istio.svc.cluster.local
                    port_value: 6379
            - endpoint:
                address:
                  socket_address:
                    address: redis-cluster-3.redis-cluster.istio.svc.cluster.local
                    port_value: 6379
            - endpoint:
                address:
                  socket_address:
                    address: redis-cluster-4.redis-cluster.istio.svc.cluster.local
                    port_value: 6379
            - endpoint:
                address:
                  socket_address:
                    address: redis-cluster-5.redis-cluster.istio.svc.cluster.local
                    port_value: 6379
        cluster_type:
          name: envoy.clusters.redis
          typed_config:
            "@type": type.googleapis.com/google.protobuf.Struct
            value:
              cluster_refresh_rate: 5s
              cluster_refresh_timeout: 3s
              redirect_refresh_interval: 5s
              redirect_refresh_threshold: 5
```

3设置redis_proxy

applyto/redis/envoyfilter-redis-proxy.yaml

kubectl apply -f envoyfilter-redis-proxy.yaml -n istio-system

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: add-redis-proxy
  namespace: istio-system
spec:
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      listener:
        name: ${REDIS_VIP}_6379               # Replace REDIS_VIP with the cluster IP of "redis-cluster service
        filterChain:
          filter:
            name: "envoy.filters.network.tcp_proxy"
    patch:
      operation: REPLACE
      value:
        name: envoy.filters.network.redis_proxy
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.redis_proxy.v3.RedisProxy
          stat_prefix: redis_stats
          prefix_routes:
            catch_all_route:
              cluster: custom-redis-cluster
          settings:
            op_timeout: 5s
            enable_redirection: true
            enable_command_stats: true
            read_policy: REPLICA
```

替换REDIS_VIP

4构建redis集群

获取pod ip

 kubectl get pods -l app=redis-cluster -o jsonpath='{range.items[*]}{.status.podIP}:6379 ' -n istio

构建集群

kubectl exec -it  redis-cluster-0 -n istio  -- redis-cli --cluster create --cluster-replicas 1 172.20.0.227:6379 172.20.1.238:6379 172.20.2.209:6379 172.20.0.228:6379 172.20.1.239:6379 172.20.2.210:6379

验证集群是否成功

kubectl exec -it redis-cluster-0 -c redis -n istio -- redis-cli cluster info 

进入客户端

 kubectl exec -it redis-client-6c4b6c4fb5-7hbv9  -n istio -- /bin/bash

连接集群

 redis-cli -h redis-cluster-op  -p 6379 -c

设置数据

set  a a等

验证数据

kubectl exec redis-cluster-0 -c redis -n istio -- redis-cli --scan

5设置redis _proxy with mirror

applyto/redis/envoyfilter-redis-proxy-with-mirror.yaml

kubectl apply -f envoyfilter-redis-proxy-with-mirror.yaml  -n istio-system 

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: add-redis-proxy
  namespace: istio-system
spec:
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      listener:
        name: ${REDIS_VIP}_6379             # Replace REDIS_VIP with the cluster IP of "redis-cluster service
        filterChain:
          filter:
            name: "envoy.filters.network.tcp_proxy"
    patch:
      operation: REPLACE
      value:
        name: envoy.filters.network.redis_proxy
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.redis_proxy.v3.RedisProxy
          stat_prefix: redis_stats
          prefix_routes:
            catch_all_route:
              request_mirror_policy:
              - cluster: outbound|6379||redis-mirror.istio.svc.cluster.local
                exclude_read_commands: True     # Mirror write commands only:
              cluster: custom-redis-cluster
          settings:
            op_timeout: 5s
            enable_redirection: true
            enable_command_stats: true
            read_policy: REPLICA
```

替换REDIS_VIP

6进入客户端，连接集群，设置数据

7进入客户端，连接mirror，验证数据



清理：

kubectl delete -f redis-cluster-deploy.yaml -n istio

kubectl delete -f redis-client-deploy.yaml -n istio

kubectl delete -f redis-mirror-deploy.yaml -n istio

kubectl delete envoyfilter custom-redis-cluster -n istio-system

kubectl delete envoyfilter add-redis-proxy -n istio-system



kubectl port-forward --address 0.0.0.0 -n istio redis-cluster-0 15002:15000

![1629175094(1)](images\1629175094(1).jpg)

![1629175178(1)](images\1629175178(1).jpg)



设置了mirror之后

![1629175291(1)](images\1629175291(1).jpg)





#### 13-24EXTENSION_CONFIG



ef-extension-config-attributegen.yaml

kubectl apply -f ef-extension-config-attributegen.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: apply-to
spec:
  workloadSelector:
    labels:
      app: productpage
  configPatches:
    - applyTo: HTTP_FILTER
      match:
        context: SIDECAR_INBOUND
        listener:
          filterChain:
            filter:
              name: "envoy.filters.network.http_connection_manager"
              subFilter:
                name: "envoy.filters.http.router"
      patch:
        operation: INSERT_BEFORE
        value:
          name: istio.attributegen
          config_discovery:
            config_source:
              ads: {}
              initial_fetch_timeout: 0s 
            type_urls: [ "type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm"]       
    - applyTo: EXTENSION_CONFIG
      match:
        context: SIDECAR_INBOUND
      patch:
        operation: ADD
        value:
          name: istio.attributegen
          typed_config:
            "@type": type.googleapis.com/udpa.type.v1.TypedStruct
            type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
            value:
              config:
                configuration:
                  "@type": "type.googleapis.com/google.protobuf.StringValue"
                  value: |
                    {
                      "attributes": [
                      {
                        "output_attribute": "istio_responseClass",
                        "match": [
                         {
                             "value": "2xx",
                             "condition": "response.code >= 200 && response.code <= 299"
                         }]
                      },
                      {
                        "output_attribute": "istio_operationId",
                        "match": [
                        {
                            "value": "getoperation",
                            "condition": "request.method == 'GET'"
                        }]
                      },
                      {
                        "output_attribute": "istio_grpcResponseStatus",
                        "match": [
                        {
                            "value": "OK",
                            "condition": "response.grpc_status == 0"
                        }]
                      }]
                    }
                vm_config:
                  runtime: envoy.wasm.runtime.null
                  code:
                    local:
                      inline_string: envoy.wasm.attributegen
```

清理

kubectl  delete envoyfilter apply-to -n istio



![1629175603(1)](images\1629175603(1).jpg)



#### 13-25BOOTSTRAP

启用修改bootstrap

```
  meshConfig:
      proxyMetadata:
        # Enable dynamic bootstrap generation
        # https://github.com/istio/istio/pull/33456
        BOOTSTRAP_XDS_AGENT: "true"
```

ef-bootstrap-overload_manager.yaml

kubectl apply -f ef-bootstrap-overload_manager.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: ef-bootstrap
spec:
  workloadSelector:
    labels:
      app: productpage
  configPatches:
  - applyTo: BOOTSTRAP
    patch:
      operation: MERGE
      value:
        admin:
          access_log_path: "/dev/null"
          address: 
            socket_address: 
              address: "127.0.0.1"
              port_value: 15000
        overload_manager:
          actions:
          - name: envoy.overload_actions.shrink_heap
            triggers:
            - name: envoy.resource_monitors.fixed_heap
              threshold:
                value: 0.9
          - name: envoy.overload_actions.stop_accepting_requests
            triggers:
            - name: envoy.resource_monitors.fixed_heap
              threshold:
                value: 0.95
          refresh_interval: 0.25s
          resource_monitors:
          - name: envoy.resource_monitors.fixed_heap
            typed_config:
              '@type': type.googleapis.com/envoy.config.resource_monitor.fixed_heap.v3.FixedHeapConfig
              max_heap_size_bytes: 1073741824.0
```

ef-bootstrap-admin.yaml

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: ef-bootstrap
spec:
  workloadSelector:
    labels:
      app: productpage
  configPatches:
  - applyTo: BOOTSTRAP
    patch:
      operation: MERGE
      value:
          admin: 
            access_log:
            - name: file
              filter:
                status_code_filter:
                  comparison:
                    op: EQ
                    value:
                      default_value: 200 
                      runtime_key: file.log
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
                path: /dev/null
                log_format: 
                  text_format: "%LOCAL_REPLY_BODY%:%RESPONSE_CODE%:path=%REQ(:path)%\n"
            profile_path: "/var/lib/istio/data/envoy.prof"
            ignore_global_conn_limit: true
            address:
              socket_address: 
                address: "127.0.0.1"
                port_value: 15000
            
```



#### 13-26添加metricx

1.10版

name，dimensions

envoyfilters/applyto/stats-filter-1.10.yaml

kubectl apply -f stats-filter-1.10.yaml -n istio-system

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  labels:
    install.operator.istio.io/owning-resource-namespace: istio-system
    istio.io/rev: default
    operator.istio.io/component: Pilot
    operator.istio.io/managed: Reconcile
    operator.istio.io/version: 1.13.3
  name: stats-filter-1.13
  namespace: istio-system
spec:
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.router
      proxy:
        proxyVersion: ^1\.13.*
    patch:
      operation: INSERT_BEFORE
      value:
        name: istio.stats
        typed_config:
          '@type': type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              configuration:
                '@type': type.googleapis.com/google.protobuf.StringValue
                value: |
                  {
                    "debug": "false",
                    "stat_prefix": "istio",
                     "metrics": [
                      {
                       "name": "requests_total",
                       "dimensions": {
                          "request_operation": "istio_operationId"
                       }
                    }]
                  }
              root_id: stats_outbound
              vm_config:
                code:
                  local:
                    inline_string: envoy.wasm.stats
                runtime: envoy.wasm.runtime.null
                vm_id: stats_outbound
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_INBOUND
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.router
      proxy:
        proxyVersion: ^1\.13.*
    patch:
      operation: INSERT_BEFORE
      value:
        name: istio.stats
        typed_config:
          '@type': type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              configuration:
                '@type': type.googleapis.com/google.protobuf.StringValue
                value: |
                  {
                    "debug": "false",
                    "stat_prefix": "istio",
                    "metrics": [
                      {
                        "dimensions": {
                          "destination_cluster": "node.metadata['CLUSTER_ID']",
                          "source_cluster": "downstream_peer.cluster_id"
                        }
                      },
                      {
                       "name": "requests_total",
                       "dimensions": {
                          "request_operation": "istio_operationId"
                        }
                      }
                    ]
                  }
              root_id: stats_inbound
              vm_config:
                code:
                  local:
                    inline_string: envoy.wasm.stats
                runtime: envoy.wasm.runtime.null
                vm_id: stats_inbound
  - applyTo: HTTP_FILTER
    match:
      context: GATEWAY
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.router
      proxy:
        proxyVersion: ^1\.13.*
    patch:
      operation: INSERT_BEFORE
      value:
        name: istio.stats
        typed_config:
          '@type': type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
          value:
            config:
              configuration:
                '@type': type.googleapis.com/google.protobuf.StringValue
                value: |
                  {
                    "debug": "false",
                    "stat_prefix": "istio",
                    "disable_host_header_fallback": true,
                     "metrics": [
                      {
                       "name": "requests_total",
                       "dimensions": {
                          "request_operation": "istio_operationId"
                       }
                    }]
                  }
              root_id: stats_outbound
              vm_config:
                code:
                  local:
                    inline_string: envoy.wasm.stats
                runtime: envoy.wasm.runtime.null
                vm_id: stats_outbound
```

ef-extension-config-attributegen-2.yaml

kubectl apply -f ef-extension-config-attributegen-2.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: apply-to
spec:
  configPatches:
    - applyTo: HTTP_FILTER
      match:
        context: ANY
        listener:
          filterChain:
            filter:
              name: "envoy.filters.network.http_connection_manager"
              subFilter:
                name: "istio.stats"
      patch:
        operation: INSERT_BEFORE
        value:
          name: istio.attributegen
          config_discovery:
            config_source:
              ads: {}
              initial_fetch_timeout: 0s 
            type_urls: [ "type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm"]       
    - applyTo: EXTENSION_CONFIG
      match:
        context: SIDECAR_INBOUND
      patch:
        operation: ADD
        value:
          name: istio.attributegen
          typed_config:
            "@type": type.googleapis.com/udpa.type.v1.TypedStruct
            type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
            value:
              config:
                configuration:
                  "@type": "type.googleapis.com/google.protobuf.StringValue"
                  value: |
                    {
                      "attributes": [
                      {
                        "output_attribute": "istio_responseClass",
                        "match": [
                         {
                             "value": "2xx",
                             "condition": "response.code >= 200 && response.code <= 299"
                         }]
                      },
                      {
                        "output_attribute": "istio_operationId",
                        "match": [
                        {
                            "value": "getoperation",
                            "condition": "request.method == 'GET'"
                        },
                        {
                            "value": "getoperation2",
                            "condition": "request.method != 'GET'"
                        }
                       ]
                      },
                      {
                        "output_attribute": "istio_grpcResponseStatus",
                        "match": [
                        {
                            "value": "OK",
                            "condition": "response.grpc_status == 0"
                        }]
                      }]
                    }
                vm_config:
                  runtime: envoy.wasm.runtime.null
                  code:
                    local:
                      inline_string: envoy.wasm.attributegen
```

```
meshConfig:
  defaultConfig:
    extraStatTags:
    - request_operation
```

virtaulservice/vs-bookinfo-star.yaml

kubectl apply -f vs-bookinfo-star.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: bookinfo
spec:
  exportTo:
  - '*'
  hosts:
  - "*"
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        prefix: /static
    - uri:
        exact: /login
    - uri:
        exact: /logout
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage.istio.svc.cluster.local
        port:
          number: 9080
```



kubectl apply -f gateway-01.yaml -n istio

gateway/gateway-01.yaml

```
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
```



刷新页面

查看metrics

http://192.168.198.154:15000/stats/prometheus

清理：

kubectl delete envoyfilter apply-to -n istio

kubectl delete vs bookinfo -n istio

kubectl delete gw bookinfo-gateway -n istio



更多：https://istio.io/latest/docs/reference/config/proxy_extensions/stats/#MetricConfig

![1629179509(1)](images\1629179509(1).jpg)













### match

One or more match conditions to be met before a patch is applied to the generated configuration for a given proxy.

| Field                | Type                              | Description                                                  | Required |
| -------------------- | --------------------------------- | ------------------------------------------------------------ | -------- |
| `context`            | `PatchContext`                    | The specific config generation context to match on. Istio Pilot generates envoy configuration in the context of a gateway, inbound traffic to sidecar and outbound traffic from sidecar. | No       |
| `proxy`              | `ProxyMatch`                      | Match on properties associated with a proxy.                 | No       |
| `listener`           | `ListenerMatch (oneof)`           | Match on envoy listener attributes.                          | No       |
| `routeConfiguration` | `RouteConfigurationMatch (oneof)` | Match on envoy HTTP route configuration attributes.          | No       |
| `cluster`            | `ClusterMatch (oneof)`            | Match on envoy cluster attributes.                           | No       |

#### context

| Name               | Description                                                  |
| ------------------ | ------------------------------------------------------------ |
| `ANY`              | All listeners/routes/clusters in both sidecars and gateways. |
| `SIDECAR_INBOUND`  | Inbound listener/route/cluster in sidecar.                   |
| `SIDECAR_OUTBOUND` | Outbound listener/route/cluster in sidecar.                  |
| `GATEWAY`          | Gateway listener/route/cluster.                              |

##### ANY

applyto/fault/ef-fault.yaml

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: apply-to
spec:
  workloadSelector:
    labels:
      app: productpage
  configPatches:
    - applyTo: HTTP_FILTER
      match:
        context: ANY
        listener:
          filterChain:
            filter:
              name: "envoy.filters.network.http_connection_manager"
              subFilter:
                name: "envoy.filters.http.router"
      patch:
        operation: INSERT_BEFORE
        value:
            name: envoy.filters.http.fault
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.fault.v3.HTTPFault
              abort:
                http_status: 503
                percentage:
                  numerator: 100
                  denominator: HUNDRED
              delay:
                fixed_delay: 3s
                percentage:
                  numerator: 100
                  denominator: HUNDRED
```



##### SIDECAR_INBOUND

applyto/ef-extension-config-attributegen.yaml

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: apply-to
spec:
  workloadSelector:
    labels:
      app: productpage
  configPatches:
    - applyTo: HTTP_FILTER
      match:
        context: SIDECAR_INBOUND
        listener:
          filterChain:
            filter:
              name: "envoy.filters.network.http_connection_manager"
              subFilter:
                name: "envoy.filters.http.router"
      patch:
        operation: INSERT_BEFORE
        value:
          name: istio.attributegen
          config_discovery:
            config_source:
              ads: {}
              initial_fetch_timeout: 0s 
            type_urls: [ "type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm"]       
    - applyTo: EXTENSION_CONFIG
      match:
        context: SIDECAR_INBOUND
      patch:
        operation: ADD
        value:
          name: istio.attributegen
          typed_config:
            "@type": type.googleapis.com/udpa.type.v1.TypedStruct
            type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
            value:
              config:
                configuration:
                  "@type": "type.googleapis.com/google.protobuf.StringValue"
                  value: |
                    {
                      "attributes": [
                      {
                        "output_attribute": "istio_responseClass",
                        "match": [
                         {
                             "value": "2xx",
                             "condition": "response.code >= 200 && response.code <= 299"
                         }]
                      },
                      {
                        "output_attribute": "istio_operationId",
                        "match": [
                        {
                            "value": "getoperation",
                            "condition": "request.method == 'GET'"
                        }]
                      },
                      {
                        "output_attribute": "istio_grpcResponseStatus",
                        "match": [
                        {
                            "value": "OK",
                            "condition": "response.grpc_status == 0"
                        }]
                      }]
                    }
                vm_config:
                  runtime: envoy.wasm.runtime.null
                  code:
                    local:
                      inline_string: envoy.wasm.attributegen
```



##### SIDECAR_OUTBOUND

applyto/fault/ef-fault-outbound.yaml 

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: apply-to
spec:
  workloadSelector:
    labels:
      app: productpage
  configPatches:
    - applyTo: HTTP_FILTER
      match:
        context: SIDECAR_OUTBOUND
        listener:
          filterChain:
            filter:
              name: "envoy.filters.network.http_connection_manager"
              subFilter:
                name: "envoy.filters.http.router"
      patch:
        operation: INSERT_BEFORE
        value:
            name: envoy.filters.http.fault
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.fault.v3.HTTPFault
              abort:
                http_status: 503
                percentage:
                  numerator: 100
                  denominator: HUNDRED
              delay:
                fixed_delay: 3s
                percentage:
                  numerator: 100
                  denominator: HUNDRED
```



##### GATEWAY

applyto/ef-ingressgateway-http-filter-compression-insert-after.yaml 

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  namespace: istio-system
  name: apply-to
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
    - applyTo: HTTP_FILTER
      match:
        context: GATEWAY
        listener:
          filterChain:
            filter:
              name: envoy.filters.network.http_connection_manager
              subFilter:
                name: istio.metadata_exchange
      patch:
        operation: INSERT_AFTER
        value:
          name: envoy.filters.http.compressor
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.http.compressor.v3.Compressor
            response_direction_config:
              common_config:
                min_content_length: 100
                content_type:
                 - 'text/html'
            compressor_library:
              name: text_optimized
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.compression.gzip.compressor.v3.Gzip
                memory_level: 3
                window_bits: 10
                compression_level: BEST_COMPRESSION
                compression_strategy: DEFAULT_STRATEGY
```



#### proxy

| Field          | Type     | Description                                                  | Required |
| -------------- | -------- | ------------------------------------------------------------ | -------- |
| `proxyVersion` | `string` | A regular expression in golang regex format (RE2) that can be used to select proxies using a specific version of istio proxy. The Istio version for a given proxy is obtained from the node metadata field `ISTIO_VERSION` supplied by the proxy when connecting to Pilot. This value is embedded as an environment variable (`ISTIO_META_ISTIO_VERSION`) in the Istio proxy docker image. Custom proxy implementations should provide this metadata variable to take advantage of the Istio version check option. | No       |
| `metadata`     | `map`    | Match on the node metadata supplied by a proxy when connecting to Istio Pilot. Note that while Envoy’s node metadata is of type Struct, only string key-value pairs are processed by Pilot. All keys specified in the metadata must match with exact values. The match will fail if any of the specified keys are absent or the values fail to match. | No       |



match/ef-match-proxy.yaml

kubectl apply -f ef-match-proxy.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
spec:
  workloadSelector:
    labels:
      app: productpage
  configPatches:
    - applyTo: HTTP_FILTER
      match:
        context: SIDECAR_OUTBOUND
        proxy:
          proxyVersion: 1.10.0
        listener:
          filterChain:
            filter:
              name: "envoy.filters.network.http_connection_manager"
              subFilter:
                name: "envoy.filters.http.router"
      patch:
        operation: INSERT_BEFORE
        value:
            name: envoy.filters.http.fault
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.fault.v3.HTTPFault
              abort:
                http_status: 503
                percentage:
                  numerator: 100
                  denominator: HUNDRED
              delay:
                fixed_delay: 3s
                percentage:
                  numerator: 100
                  denominator: HUNDRED
```

virtaulservice/vs-bookinfo-star.yaml

kubectl apply -f vs-bookinfo-star.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: bookinfo
spec:
  exportTo:
  - '*'
  hosts:
  - "*"
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        prefix: /static
    - uri:
        exact: /login
    - uri:
        exact: /logout
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage.istio.svc.cluster.local
        port:
          number: 9080
```



kubectl apply -f gateway-01.yaml -n istio

gateway/gateway-01.yaml

```
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
```

访问:

清理：

kubectl delete vs bookinfo -n istio

kubectl delete gw bookinfo-gateway -n istio

kubectl delete envoyfilter match -n istio

 kubectl port-forward --address 0.0.0.0 -n istio productpage-v1-659776cb44-z6txl 15000:15000

![1629259655(1)](images\1629259655(1).jpg)





#### listener

| Field         | Type               | Description                                                  | Required |
| ------------- | ------------------ | ------------------------------------------------------------ | -------- |
| `portNumber`  | `uint32`           | The service port/gateway port to which traffic is being sent/received. If not specified, matches all listeners. Even though inbound listeners are generated for the instance/pod ports, only service ports should be used to match listeners. | No       |
| `filterChain` | `FilterChainMatch` | Match a specific filter chain in a listener. If specified, the patch will be applied to the filter chain (and a specific filter if specified) and not to other filter chains in the listener. | No       |
| `name`        | `string`           | Match a specific listener by its name. The listeners generated by Pilot are typically named as IP:Port. | No       |

##### portNumber

ef-match-listener-portnumber.yaml

kubectl apply -f ef-match-listener-portnumber.yaml -n istio-system

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
  namespace: istio-system
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: LISTENER
    match:
      listener:
        portNumber: 8080
    patch:
      operation: MERGE
      value:
        listener_filters:
        - name: envoy.filters.listener.original_src
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.listener.original_src.v3.OriginalSrc
        - name: envoy.filters.listener.tls_inspector
```

virtaulservice/vs-bookinfo-star.yaml

kubectl apply -f vs-bookinfo-star.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: bookinfo
spec:
  exportTo:
  - '*'
  hosts:
  - "*"
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        prefix: /static
    - uri:
        exact: /login
    - uri:
        exact: /logout
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage.istio.svc.cluster.local
        port:
          number: 9080
```



kubectl apply -f gateway-01.yaml -n istio

gateway/gateway-01.yaml

```
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
```

访问:

清理：

kubectl delete vs bookinfo -n istio

kubectl delete gw bookinfo-gateway -n istio

kubectl delete envoyfilter match -n istio-system



kubectl port-forward --address 0.0.0.0 -n istio-system istio-ingressgateway-8657768d87-bd767 15001:15000

![1629259917(1)](images\1629259917(1).jpg)



##### filterChain

| Field                  | Type          | Description                                                  | Required |
| ---------------------- | ------------- | ------------------------------------------------------------ | -------- |
| `name`                 | `string`      | The name assigned to the filter chain.                       | No       |
| `sni`                  | `string`      | The SNI value used by a filter chain’s match condition. This condition will evaluate to false if the filter chain has no sni match. | No       |
| `transportProtocol`    | `string`      | Applies only to `SIDECAR_INBOUND` context. If non-empty, a transport protocol to consider when determining a filter chain match. This value will be compared against the transport protocol of a new connection, when it’s detected by the `tls_inspector` listener filter.Accepted values include:`raw_buffer` - default, used when no transport protocol is detected.`tls` - set when TLS protocol is detected by the TLS inspector. | No       |
| `applicationProtocols` | `string`      | Applies only to sidecars. If non-empty, a comma separated set of application protocols to consider when determining a filter chain match. This value will be compared against the application protocols of a new connection, when it’s detected by one of the listener filters such as the `http_inspector`.Accepted values include: h2, http/1.1, http/1.0 | No       |
| `filter`               | `FilterMatch` | The name of a specific filter to apply the patch to. Set this to `envoy.filters.network.http_connection_manager` to add a filter or apply a patch to the HTTP connection manager. | No       |
| `destinationPort`      | `uint32`      | The destination*port value used by a filter chain’s match condition. This condition will evaluate to false if the filter chain has no destination*port match. | No       |

###### name

先添加名字

applyto/ef-ingressgateway-filter-chain-merge.yaml

kubectl apply -f ef-ingressgateway-filter-chain-merge.yaml -n istio-system

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: apply-to
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: FILTER_CHAIN
    match:
      listener:
        portNumber: 8080
    patch:
      operation: MERGE
      value:
        name: test
        filter_chain_match:
          server_names:
          - bookinfo.demo
```

ef-match-filterchain-name.yaml

kubectl apply -f ef-match-filterchain-name.yaml -n istio-system

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      listener:
        portNumber: 8080
        filterChain:
          name: test
    patch:
      operation: MERGE
      value:
            name: envoy.filters.network.http_connection_manager
            typed_config:
              "@type": "type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager"
              "stat_prefix": "test"
```

virtaulservice/vs-bookinfo-star.yaml

kubectl apply -f vs-bookinfo-star.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: bookinfo
spec:
  exportTo:
  - '*'
  hosts:
  - "*"
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        prefix: /static
    - uri:
        exact: /login
    - uri:
        exact: /logout
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage.istio.svc.cluster.local
        port:
          number: 9080
```



kubectl apply -f gateway-01.yaml -n istio

gateway/gateway-01.yaml

```
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
```

访问:

清理：

kubectl delete vs bookinfo -n istio

kubectl delete gw bookinfo-gateway -n istio

kubectl delete envoyfilter match -n istio-system

kubectl delete envoyfilter apply-to -n istio-system

kubectl port-forward --address 0.0.0.0 -n istio-system istio-ingressgateway-8657768d87-bd767 15001:15000

![1629260216(1)](images\1629260216(1).jpg)





###### sni

先添加server_names

applyto/ef-ingressgateway-filter-chain-merge.yaml

kubectl apply -f ef-ingressgateway-filter-chain-merge.yaml -n istio-system

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: apply-to
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: FILTER_CHAIN
    match:
      listener:
        portNumber: 8080
    patch:
      operation: MERGE
      value:
        name: test
        filter_chain_match:
          server_names:
          - bookinfo.demo
```

ef-match-filterchain-sni.yaml

kubectl apply -f ef-match-filterchain-sni.yaml -n istio-system

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
  namespace: istio-system
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      context: GATEWAY
      listener:
        filterChain:
          sni: bookinfo.demo
          filter:
            name: "envoy.filters.network.http_connection_manager"
    patch:
      operation: MERGE
      value:
        typed_config:
          "@type": "type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager"
          xff_num_trusted_hops: 5
          common_http_protocol_options:
            idle_timeout: 30s
```

virtaulservice/vs-bookinfo-star.yaml

kubectl apply -f vs-bookinfo-star.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: bookinfo
spec:
  exportTo:
  - '*'
  hosts:
  - "*"
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        prefix: /static
    - uri:
        exact: /login
    - uri:
        exact: /logout
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage.istio.svc.cluster.local
        port:
          number: 9080
```



kubectl apply -f gateway-01.yaml -n istio

gateway/gateway-01.yaml

```
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
```

访问:

清理：

kubectl delete vs bookinfo -n istio

kubectl delete gw bookinfo-gateway -n istio

kubectl delete envoyfilter match -n istio-system

kubectl delete envoyfilter apply-to -n istio-system

kubectl port-forward --address 0.0.0.0 -n istio-system istio-ingressgateway-8657768d87-bd767 15001:15000

![1629260781(1)](images\1629260781(1).jpg)









###### transportProtocol

ef-match-filterchain-transportProtocol.yaml

kubectl apply -f ef-match-filterchain-transportProtocol.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
spec:
  workloadSelector:
    labels:
      app: productpage
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_INBOUND
      listener:
        portNumber: 9080
        filterChain:
          transportProtocol: raw_buffer
          filter:
            name: "envoy.filters.network.http_connection_manager"
            subFilter:
              name: "envoy.filters.http.router"
    patch:
      operation: INSERT_BEFORE
      value: 
       name: envoy.filters.http.lua
       typed_config:
          "@type": "type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua"
          inlineCode: |
            function envoy_on_response(response_handle)
                response_handle:logInfo(" ========= XXXXX ========== ")
                response_handle:headers():add("X-User-Header", "worked")
            end
```

virtaulservice/vs-bookinfo-star.yaml

kubectl apply -f vs-bookinfo-star.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: bookinfo
spec:
  exportTo:
  - '*'
  hosts:
  - "*"
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        prefix: /static
    - uri:
        exact: /login
    - uri:
        exact: /logout
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage.istio.svc.cluster.local
        port:
          number: 9080
```



kubectl apply -f gateway-01.yaml -n istio

gateway/gateway-01.yaml

```
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
```

访问:

清理：

kubectl delete vs bookinfo -n istio

kubectl delete gw bookinfo-gateway -n istio

kubectl delete envoyfilter match -n istio

kubectl port-forward --address 0.0.0.0 -n istio productpage-v1-659776cb44-z6txl 15000:15000

![1629261042(1)](images\1629261042(1).jpg)



###### applicationProtocols

ef-match-filterchain-applicationProtocols.yaml

kubectl apply -f ef-match-filterchain-applicationProtocols.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
spec:
  workloadSelector:
    labels:
      app: productpage
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_INBOUND
      listener:
        portNumber: 9080
        filterChain:
          applicationProtocols: http/1.1
          filter:
            name: "envoy.filters.network.http_connection_manager"
            subFilter:
              name: "envoy.filters.http.router"
    patch:
      operation: INSERT_BEFORE
      value: 
       name: envoy.filters.http.lua
       typed_config:
          "@type": "type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua"
          inlineCode: |
            function envoy_on_response(response_handle)
                response_handle:logInfo(" ========= XXXXX ========== ")
                response_handle:headers():add("X-User-Header", "worked")
            end
```

virtaulservice/vs-bookinfo-star.yaml

kubectl apply -f vs-bookinfo-star.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: bookinfo
spec:
  exportTo:
  - '*'
  hosts:
  - "*"
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        prefix: /static
    - uri:
        exact: /login
    - uri:
        exact: /logout
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage.istio.svc.cluster.local
        port:
          number: 9080
```



kubectl apply -f gateway-01.yaml -n istio

gateway/gateway-01.yaml

```
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
```

访问:

清理：

kubectl delete vs bookinfo -n istio

kubectl delete gw bookinfo-gateway -n istio

kubectl delete envoyfilter match -n istio

kubectl port-forward --address 0.0.0.0 -n istio productpage-v1-659776cb44-z6txl 15000:15000

![1629261173(1)](images\1629261173(1).jpg)







###### destinationPort

ef-match-filterchain-destinationPort.yaml

kubectl apply -f ef-match-filterchain-destinationPort.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
spec:
  workloadSelector:
    labels:
      app: productpage
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_INBOUND
      listener:
        portNumber: 9080
        filterChain:
          destinationPort: 9080
          filter:
            name: "envoy.filters.network.http_connection_manager"
            subFilter:
              name: "envoy.filters.http.router"
    patch:
      operation: INSERT_BEFORE
      value: 
       name: envoy.filters.http.lua
       typed_config:
          "@type": "type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua"
          inlineCode: |
            function envoy_on_response(response_handle)
                response_handle:logInfo(" ========= XXXXX ========== ")
                response_handle:headers():add("X-User-Header", "worked")
            end
```

virtaulservice/vs-bookinfo-star.yaml

kubectl apply -f vs-bookinfo-star.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: bookinfo
spec:
  exportTo:
  - '*'
  hosts:
  - "*"
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        prefix: /static
    - uri:
        exact: /login
    - uri:
        exact: /logout
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage.istio.svc.cluster.local
        port:
          number: 9080
```



kubectl apply -f gateway-01.yaml -n istio

gateway/gateway-01.yaml

```
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
```

访问:

清理：

kubectl delete vs bookinfo -n istio

kubectl delete gw bookinfo-gateway -n istio

kubectl delete envoyfilter match -n istio

kubectl port-forward --address 0.0.0.0 -n istio productpage-v1-659776cb44-z6txl 15000:15000

![1629261281(1)](images\1629261281(1).jpg)





###### filter

| Field       | Type             | Description                                                  | Required |
| ----------- | ---------------- | ------------------------------------------------------------ | -------- |
| `name`      | `string`         | The filter name to match on. For standard Envoy filters, [canonical filter](https://www.envoyproxy.io/docs/envoy/latest/version_history/v1.14.0#deprecated) names should be used. | No       |
| `subFilter` | `SubFilterMatch` | The next level filter within this filter to match upon. Typically used for HTTP Connection Manager filters and Thrift filters. | No       |

ef-match-filterchain-filter.yaml

kubectl apply -f ef-match-filterchain-filter.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
spec:
  workloadSelector:
    labels:
      app: productpage
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_INBOUND
      listener:
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
            subFilter:
              name: "envoy.filters.http.router"
    patch:
      operation: INSERT_BEFORE
      value: 
       name: envoy.filters.http.lua
       typed_config:
          "@type": "type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua"
          inlineCode: |
            function envoy_on_response(response_handle)
                response_handle:logInfo(" ========= XXXXX ========== ")
                response_handle:headers():add("X-User-Header", "worked")
            end
```

virtaulservice/vs-bookinfo-star.yaml

kubectl apply -f vs-bookinfo-star.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: bookinfo
spec:
  exportTo:
  - '*'
  hosts:
  - "*"
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        prefix: /static
    - uri:
        exact: /login
    - uri:
        exact: /logout
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage.istio.svc.cluster.local
        port:
          number: 9080
```



kubectl apply -f gateway-01.yaml -n istio

gateway/gateway-01.yaml

```
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
```

访问:

清理：

kubectl delete vs bookinfo -n istio

kubectl delete gw bookinfo-gateway -n istio

kubectl delete envoyfilter match -n istio

kubectl port-forward --address 0.0.0.0 -n istio productpage-v1-659776cb44-z6txl 15000:15000

![1629261430(1)](images\1629261430(1).jpg)







##### name

ef-match-listener-name.yaml

kubectl apply -f ef-match-listener-name.yaml -n istio-system

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
  namespace: istio-system
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: LISTENER
    match:
      listener:
        name: 0.0.0.0_8080
    patch:
      operation: MERGE
      value:
        listener_filters:
        - name: envoy.filters.listener.original_src
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.listener.original_src.v3.OriginalSrc
        - name: envoy.filters.listener.tls_inspector
```

virtaulservice/vs-bookinfo-star.yaml

kubectl apply -f vs-bookinfo-star.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: bookinfo
spec:
  exportTo:
  - '*'
  hosts:
  - "*"
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        prefix: /static
    - uri:
        exact: /login
    - uri:
        exact: /logout
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage.istio.svc.cluster.local
        port:
          number: 9080
```



kubectl apply -f gateway-01.yaml -n istio

gateway/gateway-01.yaml

```
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
```

访问:

清理：

kubectl delete vs bookinfo -n istio

kubectl delete gw bookinfo-gateway -n istio

kubectl delete envoyfilter match -n istio-system

kubectl port-forward --address 0.0.0.0 -n istio-system istio-ingressgateway-8657768d87-bd767 15001:15000

![1629261561(1)](images\1629261561(1).jpg)







#### routeConfiguration

| Field        | Type               | Description                                                  | Required |
| ------------ | ------------------ | ------------------------------------------------------------ | -------- |
| `portNumber` | `uint32`           | The service port number or gateway server port number for which this route configuration was generated. If omitted, applies to route configurations for all ports. | No       |
| `portName`   | `string`           | Applicable only for GATEWAY context. The gateway server port name for which this route configuration was generated. | No       |
| `gateway`    | `string`           | The Istio gateway config’s namespace/name for which this route configuration was generated. Applies only if the context is GATEWAY. Should be in the namespace/name format. Use this field in conjunction with the `portNumber` and `portName` to accurately select the Envoy route configuration for a specific HTTPS server within a gateway config object. | No       |
| `vhost`      | `VirtualHostMatch` | Match a specific virtual host in a route configuration and apply the patch to the virtual host. | No       |
| `name`       | `string`           | Route configuration name to match on. Can be used to match a specific route configuration by name, such as the internally generated `http_proxy` route configuration for all sidecars. | No       |

##### portNumber

ef-match-routeConfiguration-portNumber.yaml

kubectl apply -f ef-match-routeConfiguration-portNumber.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
spec:
  workloadSelector:
    labels:
      app: productpage
  configPatches:
  - applyTo: VIRTUAL_HOST
    match:
      context: SIDECAR_INBOUND
      routeConfiguration:
        portNumber: 9080
        vhost:
          name: inbound|http|9080
    patch:
      operation: REMOVE
  - applyTo: VIRTUAL_HOST
    match:
      context: SIDECAR_INBOUND
      routeConfiguration:
        portNumber: 9080
    patch:
      operation: ADD
      value:
            name: inbound|http|9080
            domains:
            - "*"
            routes:
            - match:
                prefix: "/"
              direct_response:
                status: 200
                body:
                  inline_string: "example body\n"
```

virtaulservice/vs-bookinfo-star.yaml

kubectl apply -f vs-bookinfo-star.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: bookinfo
spec:
  exportTo:
  - '*'
  hosts:
  - "*"
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        prefix: /static
    - uri:
        exact: /login
    - uri:
        exact: /logout
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage.istio.svc.cluster.local
        port:
          number: 9080
```



kubectl apply -f gateway-01.yaml -n istio

gateway/gateway-01.yaml

```
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
```

访问:

清理：

kubectl delete vs bookinfo -n istio

kubectl delete gw bookinfo-gateway -n istio

kubectl delete envoyfilter match -n istio

kubectl port-forward --address 0.0.0.0 -n istio productpage-v1-659776cb44-z6txl 15000:15000

![1629265101(1)](images\1629265101(1).jpg)





##### portName

只对https有效，gateway必须在istio-system中

测试失败

 ef-match-routeConfiguration-portName-https.yaml

kubectl apply -f ef-match-routeConfiguration-portName-https.yaml -n istio-system

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: VIRTUAL_HOST
    match:
      context: GATEWAY
      routeConfiguration:
        portName: https
    #    gateway: istio/bookinfo-gateway
    patch:
      operation: MERGE
      value:
            name: "mytest:443"
            domains:
            - "mytest.com"
            routes:
            - match:
                prefix: "/"
              direct_response:
                status: 200
                body:
                  inline_string: "example body\n"
```

gateway/gateway-https.yaml

kubectl apply -f gateway-https.yaml -n istio-system

```
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 443
      name: https
      protocol: HTTPS
    hosts:
    - "bookinfo.demo"
    - "ratings.demo"
    - "nginx.example.com"
    tls:
      mode: SIMPLE
      serverCertificate: /etc/istio/ingressgateway-certs/tls.crt
      privateKey: /etc/istio/ingressgateway-certs/tls.key
```

virtaulservice/vs-bookinfo-star.yaml

kubectl apply -f vs-bookinfo-star.yaml -n istio-system

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: bookinfo
spec:
  exportTo:
  - '*'
  hosts:
  - "*"
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        prefix: /static
    - uri:
        exact: /login
    - uri:
        exact: /logout
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage.istio.svc.cluster.local
        port:
          number: 9080
```



##### gateway





##### vhost

| Field   | Type         | Description                                                  | Required |
| ------- | ------------ | ------------------------------------------------------------ | -------- |
| `name`  | `string`     | The VirtualHosts objects generated by Istio are named as host:port, where the host typically corresponds to the VirtualService’s host field or the hostname of a service in the registry. | No       |
| `route` | `RouteMatch` | Match a specific route within the virtual host.              | No       |

| Field    | Type     | Description                                                  | Required |
| -------- | -------- | ------------------------------------------------------------ | -------- |
| `name`   | `string` | The Route objects generated by default are named as default. Route objects generated using a virtual service will carry the name used in the virtual service’s HTTP routes. | No       |
| `action` | `Action` | Match a route with specific action type.                     | No       |

| Name              | Description                                          |
| ----------------- | ---------------------------------------------------- |
| `ANY`             | All three route actions                              |
| `ROUTE`           | Route traffic to a cluster / weighted clusters.      |
| `REDIRECT`        | Redirect request.                                    |
| `DIRECT_RESPONSE` | directly respond to a request with specific payload. |

###### name

ef-match-routeConfiguration-vhost-name.yaml

kubectl apply -f ef-match-routeConfiguration-vhost-name.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
spec:
  workloadSelector:
    labels:
      app: productpage
  configPatches:
    - applyTo: HTTP_ROUTE
      match:
        context: SIDECAR_INBOUND
        routeConfiguration:
          portNumber: 9080
          vhost:
            name: inbound|http|9080
      patch:
        operation: MERGE
        value:
          match:
            prefix: /
          direct_response:
                status: 200
                body:
                  inline_string: "example body\n"
```

virtaulservice/vs-bookinfo-star.yaml

kubectl apply -f vs-bookinfo-star.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: bookinfo
spec:
  exportTo:
  - '*'
  hosts:
  - "*"
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        prefix: /static
    - uri:
        exact: /login
    - uri:
        exact: /logout
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage.istio.svc.cluster.local
        port:
          number: 9080
```



kubectl apply -f gateway-01.yaml -n istio

gateway/gateway-01.yaml

```
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
```

访问:

清理：

kubectl delete vs bookinfo -n istio

kubectl delete gw bookinfo-gateway -n istio

kubectl delete envoyfilter match -n istio

kubectl port-forward --address 0.0.0.0 -n istio productpage-v1-659776cb44-z6txl 15000:15000

![1629265758(1)](images\1629265758(1).jpg)







###### action

ANY

ef-match-routeConfiguration-vhost-route-action-ANY.yaml

kubectl apply -f ef-match-routeConfiguration-vhost-route-action-ANY.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
spec:
  workloadSelector:
    labels:
      app: productpage
  configPatches:
    - applyTo: HTTP_ROUTE
      match:
        context: SIDECAR_INBOUND
        routeConfiguration:
          portNumber: 9080
          vhost:
            name: inbound|http|9080
            route:
              action: ANY
      patch:
        operation: MERGE
        value:
          match:
            prefix: /
          direct_response:
                status: 200
                body:
                  inline_string: "example body3\n"
```

virtaulservice/vs-bookinfo-star.yaml

kubectl apply -f vs-bookinfo-star.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: bookinfo
spec:
  exportTo:
  - '*'
  hosts:
  - "*"
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        prefix: /static
    - uri:
        exact: /login
    - uri:
        exact: /logout
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage.istio.svc.cluster.local
        port:
          number: 9080
```



kubectl apply -f gateway-01.yaml -n istio

gateway/gateway-01.yaml

```
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
```

访问:

清理：

kubectl delete vs bookinfo -n istio

kubectl delete gw bookinfo-gateway -n istio

kubectl delete envoyfilter match -n istio

kubectl port-forward --address 0.0.0.0 -n istio productpage-v1-659776cb44-z6txl 15000:15000

![1629265922(1)](images\1629265922(1).jpg)







ROUTE

ef-match-routeConfiguration-vhost-route-action-ROUTE.yaml

kubectl apply -f ef-match-routeConfiguration-vhost-route-action-ROUTE.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
spec:
  workloadSelector:
    labels:
      app: productpage
  configPatches:
    - applyTo: HTTP_ROUTE
      match:
        context: SIDECAR_INBOUND
        routeConfiguration:
          portNumber: 9080
          vhost:
            name: inbound|http|9080
            route:
              action: ROUTE
      patch:
        operation: MERGE
        value:
          match:
            prefix: /
          direct_response:
                status: 200
                body:
                  inline_string: "example body33\n"
```

virtaulservice/vs-bookinfo-star.yaml

kubectl apply -f vs-bookinfo-star.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: bookinfo
spec:
  exportTo:
  - '*'
  hosts:
  - "*"
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        prefix: /static
    - uri:
        exact: /login
    - uri:
        exact: /logout
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage.istio.svc.cluster.local
        port:
          number: 9080
```



kubectl apply -f gateway-01.yaml -n istio

gateway/gateway-01.yaml

```
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
```

访问:

清理：

kubectl delete vs bookinfo -n istio

kubectl delete gw bookinfo-gateway -n istio

kubectl delete envoyfilter match -n istio

kubectl port-forward --address 0.0.0.0 -n istio productpage-v1-659776cb44-z6txl 15000:15000

![1629265980](images\1629265980.jpg)







REDIRECT

ef-match-routeConfiguration-vhost-route-action-REDIRECT.yaml

kubectl apply -f ef-match-routeConfiguration-vhost-route-action-REDIRECT.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
spec:
  workloadSelector:
    labels:
      app: productpage
  configPatches:
    - applyTo: HTTP_ROUTE
      match:
        context: SIDECAR_INBOUND
        routeConfiguration:
          portNumber: 9080
          vhost:
            name: inbound|http|9080
            route:
              action: ANY
      patch:
        operation: MERGE
        value:
          match:
            prefix: /mypage
          redirect:
             host_redirect: "127.0.0.1:9080"
             path_redirect: "/productpage"
             response_code: "PERMANENT_REDIRECT"
```

ef-match-routeConfiguration-vhost-route-action-REDIRECT-2.yaml

kubectl apply -f ef-match-routeConfiguration-vhost-route-action-REDIRECT-2.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match-2
spec:
  workloadSelector:
    labels:
      app: productpage
  configPatches:
    - applyTo: HTTP_ROUTE
      match:
        context: SIDECAR_INBOUND
        routeConfiguration:
          portNumber: 9080
          vhost:
            name: inbound|http|9080
            route:
              action: REDIRECT
      patch:
        operation: MERGE
        value:
          match:
            prefix: /
          direct_response:
                status: 200
                body:
                  inline_string: "example body11\n"
```

kubectl apply -f gateway-01.yaml -n istio

gateway/gateway-01.yaml

```
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
```

访问:

清理：

kubectl delete gw bookinfo-gateway -n istio

kubectl delete envoyfilter match -n istio

kubectl delete envoyfilter match-2 -n istio

kubectl port-forward --address 0.0.0.0 -n istio productpage-v1-659776cb44-z6txl 15000:15000

![1629266265(1)](images\1629266265(1).jpg)



DIRECT_RESPONSE

ef-match-routeConfiguration-vhost-name.yaml

kubectl apply -f ef-match-routeConfiguration-vhost-name.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
spec:
  workloadSelector:
    labels:
      app: productpage
  configPatches:
    - applyTo: HTTP_ROUTE
      match:
        context: SIDECAR_INBOUND
        routeConfiguration:
          portNumber: 9080
          vhost:
            name: inbound|http|9080
      patch:
        operation: MERGE
        value:
          match:
            prefix: /
          direct_response:
                status: 200
                body:
                  inline_string: "example body\n"
```

ef-match-routeConfiguration-vhost-route-action-DIRECT_RESPONSE.yaml

kubectl apply -f ef-match-routeConfiguration-vhost-route-action-DIRECT_RESPONSE.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match-2
spec:
  workloadSelector:
    labels:
      app: productpage
  configPatches:
    - applyTo: HTTP_ROUTE
      match:
        context: SIDECAR_INBOUND
        routeConfiguration:
          portNumber: 9080
          vhost:
            name: inbound|http|9080
            route:
              action: DIRECT_RESPONSE
      patch:
        operation: MERGE
        value:
          match:
            prefix: /
          direct_response:
                status: 200
                body:
                  inline_string: "example body2\n"
```

kubectl apply -f gateway-01.yaml -n istio

gateway/gateway-01.yaml

```
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
```

访问:

清理：

kubectl delete gw bookinfo-gateway -n istio

kubectl delete envoyfilter match -n istio

kubectl delete envoyfilter match-2 -n istio

kubectl port-forward --address 0.0.0.0 -n istio productpage-v1-659776cb44-z6txl 15000:15000

![1629266470(1)](images\1629266470(1).jpg)







##### name

ef-match-routeConfiguration-name.yaml

kubectl apply -f ef-match-routeConfiguration-name.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
spec:
  workloadSelector:
    labels:
      app: productpage
  configPatches:
    - applyTo: HTTP_ROUTE
      match:
        context: SIDECAR_INBOUND
        routeConfiguration:
          name: inbound|9080||
      patch:
        operation: MERGE
        value:
          match:
            prefix: /
          direct_response:
                status: 200
                body:
                  inline_string: "example body44n"
```

virtaulservice/vs-bookinfo-star.yaml

kubectl apply -f vs-bookinfo-star.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: bookinfo
spec:
  exportTo:
  - '*'
  hosts:
  - "*"
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        prefix: /static
    - uri:
        exact: /login
    - uri:
        exact: /logout
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage.istio.svc.cluster.local
        port:
          number: 9080
```



kubectl apply -f gateway-01.yaml -n istio

gateway/gateway-01.yaml

```
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
```

访问:

清理：

kubectl delete vs bookinfo -n istio

kubectl delete gw bookinfo-gateway -n istio

kubectl delete envoyfilter match -n istio

 kubectl port-forward --address 0.0.0.0 -n istio productpage-v1-659776cb44-z6txl 15000:15000

![1629266595(1)](images\1629266595(1).jpg)







#### cluster

| Field        | Type     | Description                                                  | Required |
| ------------ | -------- | ------------------------------------------------------------ | -------- |
| `portNumber` | `uint32` | The service port for which this cluster was generated. If omitted, applies to clusters for any port. | No       |
| `service`    | `string` | The fully qualified service name for this cluster. If omitted, applies to clusters for any service. For services defined through service entries, the service name is same as the hosts defined in the service entry. | No       |
| `subset`     | `string` | The subset associated with the service. If omitted, applies to clusters for any subset of a service. | No       |
| `name`       | `string` | The exact name of the cluster to match. To match a specific cluster by name, such as the internally generated `Passthrough` cluster, leave all fields in clusterMatch empty, except the name. | No       |

##### portNumber

ef-match-cluster-portNumber.yaml

kubectl apply -f ef-match-cluster-portNumber.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
spec:
  workloadSelector:
    labels:
      app: productpage
  configPatches:  
  - applyTo: CLUSTER
    match:
      cluster:
        portNumber: 9080
        name: outbound|9080||productpage.istio.svc.cluster.local
    patch:
      operation: MERGE
      value: 
        connect_timeout: 112s
```

清理：

kubectl delete envoyfilter match -n istio



kubectl port-forward --address 0.0.0.0 -n istio productpage-v1-659776cb44-z6txl 15000:15000

![1629345153(1)](images\1629345153(1).jpg)



##### service

ef-match-cluster-service.yaml

kubectl apply -f ef-match-cluster-service.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
spec:
  workloadSelector:
    labels:
      app: productpage
  configPatches:  
  - applyTo: CLUSTER
    match:
      cluster:
        portNumber: 9080
        service: productpage.istio.svc.cluster.local
        name: outbound|9080||productpage.istio.svc.cluster.local
    patch:
      operation: MERGE
      value: 
        connect_timeout: 113s
```

清理：

kubectl delete envoyfilter match -n istio



kubectl port-forward --address 0.0.0.0 -n istio productpage-v1-659776cb44-z6txl 15000:15000

![1629345296(1)](images\1629345296(1).jpg)





##### subset

ef-match-cluster-subset.yaml

kubectl apply -f ef-match-cluster-subset.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
spec:
  workloadSelector:
    labels:
      app: productpage
  configPatches:  
  - applyTo: CLUSTER
    match:
      cluster:
        portNumber: 9080
        service: productpage.istio.svc.cluster.local
        subset: v1
    patch:
      operation: MERGE
      value: 
        connect_timeout: 115s
```

match/dr-productpage.yaml

kubectl apply -f dr-productpage.yaml -n istio

```
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: productpage
spec:
  exportTo:
  - '*'
  host: productpage
  subsets:
  - name: v1
    labels:
      version: v1
```

清理：

kubectl delete envoyfilter match -n istio

kubectl delete dr productpage -n istio



kubectl port-forward --address 0.0.0.0 -n istio productpage-v1-659776cb44-z6txl 15000:15000

![1629345574(1)](images\1629345574(1).jpg)







##### name

ef-match-cluster-name.yaml

kubectl apply -f ef-match-cluster-name.yaml -n istio

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: match
spec:
  workloadSelector:
    labels:
      app: productpage
  configPatches:  
  - applyTo: CLUSTER
    match:
      cluster:
        name: outbound|9080||productpage.istio.svc.cluster.local
    patch:
      operation: MERGE
      value: 
        connect_timeout: 116s
```

清理：

kubectl delete envoyfilter match -n istio



kubectl port-forward --address 0.0.0.0 -n istio productpage-v1-659776cb44-z6txl 15000:15000

![1629345669(1)](images\1629345669(1).jpg)







### patch

Patch specifies how the selected object should be modified.

| Field         | Type          | Description                                                  | Required |
| ------------- | ------------- | ------------------------------------------------------------ | -------- |
| `operation`   | `Operation`   | Determines how the patch should be applied.                  | No       |
| `value`       | `Struct`      | The JSON config of the object being patched. This will be merged using proto merge semantics with the existing proto in the path. | No       |
| `filterClass` | `FilterClass` | Determines the filter insertion order.                       | No       |

#### operation

| Name            | Description                                                  |
| --------------- | ------------------------------------------------------------ |
| `INVALID`       |                                                              |
| `MERGE`         | Merge the provided config with the generated config using proto merge semantics. If you are specifying config in its entirety, use `REPLACE` instead. |
| `ADD`           | Add the provided config to an existing list (of listeners, clusters, virtual hosts, network filters, or http filters). This operation will be ignored when `applyTo` is set to `ROUTE_CONFIGURATION`, or `HTTP_ROUTE`. |
| `REMOVE`        | Remove the selected object from the list (of listeners, clusters, virtual hosts, network filters, routes, or http filters). Does not require a value to be specified. This operation will be ignored when `applyTo` is set to `ROUTE_CONFIGURATION`, or `HTTP_ROUTE`. |
| `INSERT_BEFORE` | Insert operation on an array of named objects. This operation is typically useful only in the context of filters or routes, where the order of elements matter. Routes should be ordered based on most to least specific matching criteria since the first matching element is selected. For clusters and virtual hosts, order of the element in the array does not matter. Insert before the selected filter or sub filter. If no filter is selected, the specified filter will be inserted at the front of the list. |
| `INSERT_AFTER`  | Insert operation on an array of named objects. This operation is typically useful only in the context of filters or routes, where the order of elements matter. Routes should be ordered based on most to least specific matching criteria since the first matching element is selected. For clusters and virtual hosts, order of the element in the array does not matter. Insert after the selected filter or sub filter. If no filter is selected, the specified filter will be inserted at the end of the list. |
| `INSERT_FIRST`  | Insert operation on an array of named objects. This operation is typically useful only in the context of filters or routes, where the order of elements matter. Routes should be ordered based on most to least specific matching criteria since the first matching element is selected. For clusters and virtual hosts, order of the element in the array does not matter. Insert first in the list based on the presence of selected filter or not. This is specifically useful when you want your filter first in the list based on a match condition specified in Match clause. |
| `REPLACE`       | Replace contents of a named filter with new contents. `REPLACE` operation is only valid for `HTTP_FILTER` and `NETWORK_FILTER`. If the named filter is not found, this operation has no effect. |

##### INVALID



##### MERGE

applyto/ef-listener-filter.yaml

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: apply-to
  namespace: istio-system
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: LISTENER
    patch:
      operation: MERGE
      value:
        listener_filters:
        - name: envoy.filters.listener.original_src
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.listener.original_src.v3.OriginalSrc
        - name: envoy.filters.listener.tls_inspector
```



##### ADD

applyto/ef-productpage-add-listener.yaml

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: apply-to
  namespace: istio 
spec:
  workloadSelector:
    labels:
      app: productpage
  configPatches:
  - applyTo: LISTENER
    match:
      context: SIDECAR_INBOUND
    patch:
      operation: ADD
      value:
        name: proxy
        address:
          socket_address:
            protocol: TCP
            address: 0.0.0.0
            port_value: 8083
        filter_chains:
        - filters:
          - name: "envoy.filters.network.http_connection_manager"
            typed_config:
              "@type": "type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager"
              stat_prefix: ingress_proxy
              route_config:
                name: route_a
                virtual_hosts:
                - name: envoy_cyz
                  domains:
                  - "*"
                  routes:
                  - match:
                      prefix: "/"
                    route:
                      cluster: cluster123
              http_filters:
              - name: "envoy.filters.http.router
                typed_config:
                  "@type": "type.googleapis.com/envoy.extensions.filters.http.router.v3.Router" 
  - applyTo: CLUSTER
    patch:
      operation: ADD
      value: 
        name: "cluster123"
        type: STATIC
        connect_timeout: 0.5s
        lb_policy: ROUND_ROBIN
        load_assignment:
          cluster_name: cluster123
          endpoints:
          - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: 127.0.0.1
                    port_value: 9080
```



##### REMOVE

applyto/ef-ingressgateway-http-filter-remove.yaml

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: apply-to
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      listener:
        portNumber: 8080
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
            subFilter:
              name: "envoy.filters.http.fault"
    patch:
      operation: REMOVE
```



##### INSERT_BEFORE

applyto/ef-extension-config.yaml

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: apply-to
spec:
  workloadSelector:
    labels:
      app: productpage
  configPatches:
    - applyTo: HTTP_FILTER
      match:
        context: SIDECAR_INBOUND
        listener:
          filterChain:
            filter:
              name: "envoy.filters.network.http_connection_manager"
              subFilter:
                name: "envoy.filters.http.router"
      patch:
        operation: INSERT_BEFORE
        value:
          name: istio.attributegen
          config_discovery:
            config_source:
              ads: {}
              initial_fetch_timeout: 0s 
            type_urls: [ "type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm"]       
    - applyTo: EXTENSION_CONFIG
      match:
        context: SIDECAR_INBOUND
      patch:
        operation: ADD
        value:
          name: istio.attributegen
          typed_config:
            "@type": type.googleapis.com/udpa.type.v1.TypedStruct
            type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
            value:
              config:
                configuration:
                  "@type": "type.googleapis.com/google.protobuf.StringValue"
                  value: |
                    {
                      "attributes": [
                      {
                        "output_attribute": "istio_responseClass",
                        "match": [
                         {
                             "value": "2xx",
                             "condition": "response.code >= 200 && response.code <= 299"
                         }]
                      },
                      {
                        "output_attribute": "istio_operationId",
                        "match": [
                        {
                            "value": "getoperation",
                            "condition": "request.method == 'GET'"
                        }]
                      },
                      {
                        "output_attribute": "istio_grpcResponseStatus",
                        "match": [
                        {
                            "value": "OK",
                            "condition": "response.grpc_status == 0"
                        }]
                      }]
                    }
                vm_config:
                  runtime: envoy.wasm.runtime.null
                  code:
                    local:
                      inline_string: envoy.wasm.attributegen
```



##### INSERT_AFTER

applyto/ef-ingressgateway-http-filter-compression-insert-after.yaml 

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  namespace: istio-system
  name: apply-to
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
    - applyTo: HTTP_FILTER
      match:
        context: GATEWAY
        listener:
          filterChain:
            filter:
              name: envoy.filters.network.http_connection_manager
              subFilter:
                name: istio.metadata_exchange
      patch:
        operation: INSERT_AFTER
        value:
          name: envoy.filters.http.compressor
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.http.compressor.v3.Compressor
            response_direction_config:
              common_config:
                min_content_length: 100
                content_type:
                - 'text/html'
            compressor_library:
              name: text_optimized
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.compression.gzip.compressor.v3.Gzip
                memory_level: 3
                window_bits: 10
                compression_level: BEST_COMPRESSION
                compression_strategy: DEFAULT_STRATEGY
```



##### INSERT_FIRST

applyto/web-grpc/ef-web-grpc.yaml

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: apply-to
spec:
  workloadSelector:
    labels:
      app: web-grpc
  configPatches:
  - applyTo: HTTP_FILTER
    match:
        listener:
          destination_port: 50051
          transport_protocol: "tls"
          filterChain:
            filter:
              name: envoy.filters.network.http_connection_manager
    patch:
        operation: INSERT_FIRST
        value:           
          name: envoy.filters.http.grpc_web
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.http.grpc_web.v3.GrpcWeb 
```



##### REPLACE

applyto/thrift/envoyfilter-thrift-proxy.yaml

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: thrift-sample-server
spec:
  configPatches:
  - applyTo: NETWORK_FILTER
    match:
      listener:
        name: ${thrift-sample-server-vip}_9090    # sed -i .bak "s/\${thrift-sample-server-vip}/`kubectl get svc thrift-sample-server -n thrift -o=jsonpath='{.spec.clusterIP}'`/" istio/envoyfilter-thrift-proxy.yaml
        filterChain:
          filter:
            name: "envoy.filters.network.tcp_proxy"
    patch:
      operation: REPLACE
      value:
        name: envoy.filters.network.thrift_proxy
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.thrift_proxy.v3.ThriftProxy
          stat_prefix: "outbound|9090||thrift-sample-server.thrift.svc.cluster.local"
          transport: AUTO_TRANSPORT
          protocol: AUTO_PROTOCOL
          thrift_filters:
          - name: envoy.filters.thrift.router
          route_config:
            routes:
            - match:
                # empty string matches any request method name
                method_name: ""
              route:
                weighted_clusters:
                  clusters:
                    - name: "outbound|9090|v1|thrift-sample-server.istio.svc.cluster.local"
                      weight: 50
                    - name: "outbound|9090|v2|thrift-sample-server.istio.svc.cluster.local"
                      weight: 50
  - applyTo: NETWORK_FILTER
    match:
      listener:
        name: virtualInbound
        filterChain:
          destination_port: 9090
          filter:
            name: "envoy.filters.network.tcp_proxy"
    patch:
      operation: REPLACE
      value:
        name: envoy.filters.network.thrift_proxy
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.thrift_proxy.v3.ThriftProxy
          stat_prefix: inbound|9090||
          transport: AUTO_TRANSPORT
          protocol: AUTO_PROTOCOL
          thrift_filters:
          - name: envoy.filters.thrift.router
          route_config:
            routes:
            - match:
                # empty string matches any request method name
                method_name: ""
              route:
                cluster: inbound|9090||
```



#### filterClass

未实现

| Name          | Description                                                  |
| ------------- | ------------------------------------------------------------ |
| `UNSPECIFIED` | Control plane decides where to insert the filter. Do not specify `FilterClass` if the filter is independent of others. |
| `AUTHN`       | Insert filter after Istio authentication filters.            |
| `AUTHZ`       | Insert filter after Istio authorization filters.             |
| `STATS`       | Insert filter before Istio stats filters.                    |

##### UNSPECIFIED

ef-patch-filterclass-UNSPECIFIED.yaml

 Control plane decides where to insert the filter. Do not specify `FilterClass` if the filter is independent of others. 

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  namespace: istio-system
  name: patch
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
    - applyTo: HTTP_FILTER
      match:
        context: GATEWAY
        listener:
          filterChain:
            filter:
              name: envoy.filters.network.http_connection_manager
      patch:
        operation: ADD
        filterClass: UNSPECIFIED
        value:
          name: envoy.filters.http.compressor
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.http.compressor.v3.Compressor
            response_direction_config:
              common_config:
                min_content_length: 100
                content_type:
                - 'text/html'
            compressor_library:
              name: text_optimized
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.compression.gzip.compressor.v3.Gzip
                memory_level: 3
                window_bits: 10
                compression_level: BEST_COMPRESSION
                compression_strategy: DEFAULT_STRATEGY
```

添加到了route后面

```
Error: terminal filter named envoy.filters.http.router of type envoy.filters.http.router must be the last filter in a http filter chain.
```

##### AUTHN

ef-patch-filterclass-AUTHN.yaml

 Insert filter after Istio authentication filters. 

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  namespace: istio-system
  name: patch
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
    - applyTo: HTTP_FILTER
      match:
        context: GATEWAY
        listener:
          filterChain:
            filter:
              name: envoy.filters.network.http_connection_manager
      patch:
        operation: ADD
        filterClass: AUTHN
        value:
          name: envoy.filters.http.compressor
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.http.compressor.v3.Compressor
            response_direction_config:
              common_config:
                min_content_length: 100
                content_type:
                - 'text/html'
            compressor_library:
              name: text_optimized
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.compression.gzip.compressor.v3.Gzip
                memory_level: 3
                window_bits: 10
                compression_level: BEST_COMPRESSION
                compression_strategy: DEFAULT_STRATEGY
```



##### AUTHZ

ef-patch-filterclass-AUTHZ.yaml

 Insert filter after Istio authorization filters. 

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  namespace: istio-system
  name: patch
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
    - applyTo: HTTP_FILTER
      match:
        context: GATEWAY
        listener:
          filterChain:
            filter:
              name: envoy.filters.network.http_connection_manager
      patch:
        operation: ADD
        filterClass: AUTHZ
        value:
          name: envoy.filters.http.compressor
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.http.compressor.v3.Compressor
            response_direction_config:
              common_config:
                min_content_length: 100
                content_type:
                - 'text/html'
            compressor_library:
              name: text_optimized
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.compression.gzip.compressor.v3.Gzip
                memory_level: 3
                window_bits: 10
                compression_level: BEST_COMPRESSION
                compression_strategy: DEFAULT_STRATEGY
```



##### STATS

ef-patch-filterclass-STATS.yaml

 Insert filter before Istio stats filters. 

```
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  namespace: istio-system
  name: patch
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
    - applyTo: HTTP_FILTER
      match:
        context: GATEWAY
        listener:
          filterChain:
            filter:
              name: envoy.filters.network.http_connection_manager
      patch:
        operation: ADD
        filterClass: STATS
        value:
          name: envoy.filters.http.compressor
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.http.compressor.v3.Compressor
            response_direction_config:
              common_config:
                min_content_length: 100
                content_type:
                - 'text/html'
            compressor_library:
              name: text_optimized
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.compression.gzip.compressor.v3.Gzip
                memory_level: 3
                window_bits: 10
                compression_level: BEST_COMPRESSION
                compression_strategy: DEFAULT_STRATEGY
```







